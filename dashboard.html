<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Tracker Nutrizionale</title>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f7f9; color: #333; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 800px; background-color: #ffffff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1, h2, h3 { color: #0d47a1; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-top: 0; }
        h2 { font-size: 1.4em; margin-top: 30px; }
        h3 { font-size: 1.1em; color: #333; border-bottom: 1px solid #eee; margin-top: 20px; }
        h4 { font-size: 1em; color: #1565c0; margin-top: 20px; margin-bottom: 10px; font-weight: 600; }
        #titolo-giornata { text-align: center; color: #d84315; font-weight: 600; margin-bottom: 20px; padding: 10px; background-color: #fff3e0; border-radius: 8px; border: 1px solid #ffe0b2;}
        .sezione { margin-bottom: 25px; padding: 20px; background-color: #fafafa; border: 1px solid #e0e0e0; border-radius: 8px; border-left-width: 5px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        input[type="text"], input[type="number"], input[type="date"], select, input[type="email"], input[type="password"], textarea {
            width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 1em;
        }
        button { background-color: #1976d2; color: white; padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 1em; font-weight: 600; transition: background-color 0.3s; }
        button:hover { background-color: #1565c0; }
        .nav-links { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .nav-links a { flex-grow: 1; text-align: center; padding: 12px 10px; background-color: #607d8b; color: white; text-decoration: none; border-radius: 6px; font-weight: 600; min-width: 120px; }
        .nav-links a.active { background-color: #1976d2; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        #riepilogo p { font-size: 1.1em; margin: 8px 0; }
        progress { width: 100%; height: 15px; border-radius: 6px; margin-top: 2px; cursor: pointer; }
        progress.macro-progress { height: 25px; }
        .nutrients-warning { color: #d32f2f !important; }
        #calorie-balance-text { display: block; text-align: center; font-weight: bold; font-size: 1.2em; margin-top: 15px; margin-bottom: 10px; padding: 8px 0; border-radius: 5px; }
        .balance-deficit { background-color: #ffebee; color: #d32f2f; }
        .balance-surplus { background-color: #e8f5e9; color: #2e7d32; }
        .balance-even { background-color: #e3f2fd; color: #1976d2; }
        .collapsible-header { cursor: pointer; padding: 10px 0; border-bottom: 1px solid #e0e0e0; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; color: #0d47a1; font-size: 1.4em; }
        .collapsible-header:hover { color: #1976d2; }
        .collapsible-header .arrow { font-size: 0.8em; transition: transform 0.3s ease; }
        .collapsible-content { display: none; overflow: hidden; transition: max-height 0.3s ease-out; max-height: 0; }
        .collapsible-content.expanded { display: block; max-height: 2000px; }
        .collapsible-header.expanded .arrow { transform: rotate(90deg); }
        #calorie-adjuster { display: flex; align-items: center; justify-content: center; margin-top: 10px; margin-bottom: 20px; gap: 10px; }
        #calorie-adjuster button { padding: 5px 12px; font-size: 1.2em; border-radius: 5px; background-color: #4CAF50; color: white; border: none; cursor: pointer; }
        #calorie-adjuster button.minus { background-color: #f44336; }
        #calorie-adjuster input[type="number"] { width: 80px; text-align: center; font-size: 1.1em; padding: 8px; border: 1px solid #ccc; border-radius: 5px; }
        #calorie-adjuster label { margin-bottom: 0; font-weight: normal; color: #333; }
        .cloud-sync-section { display: flex; gap: 10px; margin-top: 20px; padding: 15px; background-color: #e0f2f7; border: 1px solid #b2ebf2; border-radius: 8px; flex-wrap: wrap; }
        .cloud-sync-section button { flex: 1 1 auto; min-width: 150px; margin-bottom: 5px; }
        .cloud-sync-status { width: 100%; text-align: center; font-size: 0.9em; color: #555; margin-top: 10px; }
        .cloud-sync-status.connected { color: #2e7d32; font-weight: bold; }
        .cloud-sync-status.disconnected { color: #c62828; font-weight: bold; }
        #auth-section { margin-bottom: 25px; padding: 20px; background-color: #fafafa; border: 1px solid #e0e0e0; border-radius: 8px; border-left-width: 5px; border-left-color: #673ab7; }
        #auth-section h2 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        #auth-section .auth-buttons { display: flex; gap: 10px; }
        #auth-section .auth-buttons button { width: 50%; background-color: #1976d2; }
        #auth-section #btn-sign-out { background-color: #607d8b; display: none; margin-top: 15px; }
        #auth-status { text-align: center; font-weight: 600; margin-top: 15px; }
        #welcome-message { text-align: center; font-weight: bold; font-size: 1.2em; color: #0d47a1; margin-bottom: 10px; display: none; }
        #main-tracker-content { display: none; }
        #main-tracker-content.authenticated { display: block; }
        #auth-section.logged-in { padding: 10px 20px; background-color: #e3f2fd; border: 1px solid #90caf9; box-shadow: none; text-align: center; display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 10px; }
        #auth-section.logged-in #auth-header, #auth-section.logged-in #auth-form-fields, #auth-section.logged-in #auth-status { display: none !important; }
        #auth-section.logged-in #welcome-message { margin: 0; font-size: 1em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #auth-section.logged-in #btn-sign-out { width: auto; padding: 5px 10px; font-size: 0.8em; margin: 0; flex-shrink: 0; }
        .summary-header-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-bottom: 25px; }
        .fats-group { padding-left: 15px; border-left: 3px solid #eee; margin-top: 15px; }
        .fats-sub-bars-container { display: flex; gap: 20px; margin-top: 10px; }
        .fats-sub-bars-container > div { flex-grow: 1; flex-basis: 0; }
        .vitamin-group { padding: 10px; margin-top: 10px; background-color: #f9f9f9; border: 1px solid #eee; border-radius: 6px; }
        #vit-content { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); animation-name: fadeIn; animation-duration: 0.4s; }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 25px; border: 1px solid #888; width: 90%; max-width: 700px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); animation-name: slideIn; animation-duration: 0.4s; }
        .modal-close { color: #aaa; float: right; font-size: 28px; font-weight: bold; line-height: 1; cursor: pointer; }
        .vitamin-weekly-summary { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        .vitamin-weekly-summary:last-child { border-bottom: none; }
        .vitamin-weekly-summary h4 { margin-top: 0; margin-bottom: 8px; color: #1565c0; border: none; }
        .vitamin-weekly-summary p { margin: 4px 0; font-size: 0.95em; }
        .diff-value { font-weight: bold; }
        .diff-surplus { color: #2e7d32; }
        .diff-deficit { color: #d32f2f; }
        @keyframes slideIn { from {margin-top: 5%; opacity: 0} to {margin-top: 10%; opacity: 1} }
        @keyframes fadeIn { from {opacity: 0} to {opacity: 1} }
        #nutrient-detail-modal-list li { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        #nutrient-detail-modal-list li:last-child { border-bottom: none; }
        #nutrient-detail-modal-list li span { font-weight: 600; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Tracker Nutrizionale Marco</h1>
        
        <div id="auth-section" class="sezione">
            <h2 id="auth-header">Accedi / Registrati</h2>
            <p id="welcome-message"></p>
            <div id="auth-form-fields">
                <div><label for="user-email">Email</label><input type="email" id="user-email"></div>
                <div><label for="user-password">Password</label><input type="password" id="user-password"></div>
                <div class="auth-buttons">
                    <button id="btn-register">Registrati</button>
                    <button id="btn-login">Accedi</button>
                </div>
            </div>
            <button id="btn-sign-out">Esci</button>
            <p id="auth-status"></p>
        </div>
        
        <div id="main-tracker-content">
            <div class="nav-links">
                <a href="dashboard.html" class="active">üìä Dashboard</a>
                <a href="aggiungi.html">‚ûï Aggiungi</a>
                <a href="diario.html">üìñ Diario</a>
                <a href="storico.html">üìà Storico</a>
            </div>

            <h2 id="titolo-giornata"></h2>

            <div id="riepilogo" class="sezione">
                <div class="summary-header-row">
                    <h2>Riepilogo di Oggi</h2>
                </div>
                
                <span id="calorie-balance-text"></span>

                <div id="calorie-adjuster">
                    <label for="calorie-adjustment-input">Correzione Obiettivo:</label>
                    <button id="btn-calorie-minus" class="minus">-</button>
                    <input type="number" id="calorie-adjustment-input" value="0"> <button id="btn-calorie-plus">+</button>
                    <span>kcal</span>
                </div>

                <p style="display: flex; align-items: center; gap: 10px;">
                    <span>Proteine: <span id="totale-proteine">0</span> / <span id="obiettivo-proteine"></span> g</span>
                    <i id="info-proteine-giornata" class="fas fa-info-circle" style="cursor: pointer; color: #1976d2; font-size: 1.2em;"></i>
                </p>
                <progress id="progress-proteine" class="macro-progress" value="0"></progress>
                <p>Calorie: <span id="totale-calorie">0</span> / <span id="obiettivo-calorie"></span> kcal</p>
                <progress id="progress-calorie" class="macro-progress" value="0"></progress>
                <p>Workout: <span id="workout-calories-totali">0</span> kcal</p>
                <hr>

                <h3 class="collapsible-header" id="carbs-header">
                    Carboidrati e Zuccheri <span class="arrow">‚ñ∂</span>
                </h3>
                <div class="collapsible-content" id="carbs-content">
                    <p>Carboidrati: <span id="totale-carboidrati">0</span> / <span id="obiettivo-carboidrati"></span> g</p>
                    <progress id="progress-carboidrati" class="macro-progress" value="0"></progress>
                    <p>di cui Zuccheri: <span id="totale-zuccheri">0</span> / <span id="obiettivo-zuccheri"></span> g</p>
                    <progress id="progress-zuccheri" class="macro-progress" value="0"></progress>
                </div>
                <hr>
                
                <h3 class="collapsible-header" id="fibre-header">
                    Fibre <span class="arrow">‚ñ∂</span>
                </h3>
                <div class="collapsible-content" id="fibre-content">
                    <p>Fibre Totali: <span id="totale-fibre-totali">0</span> / <span id="obiettivo-fibre-totali"></span> g</p>
                    <progress id="progress-fibre-totali" class="macro-progress" value="0"></progress>
                    <div class="fats-group">
                        <p>Solubili: <span id="totale-fibre-solubili">0</span> / <span id="obiettivo-fibre-solubili"></span> g</p>
                        <progress id="progress-fibre-solubili" value="0"></progress>
                        <p>Insolubili: <span id="totale-fibre-insolubili">0</span> / <span id="obiettivo-fibre-insolubili"></span> g</p>
                        <progress id="progress-fibre-insolubili" value="0"></progress>
                    </div>
                </div>
                <hr>
                
                <h3 class="collapsible-header" id="fats-header">
                    <span style="display: flex; align-items: center; gap: 8px;">
                        Grassi
                        <i id="info-fats-settimanali" class="fas fa-info-circle" style="cursor: pointer; color: #1976d2;"></i>
                    </span>
                    <span class="arrow">‚ñ∂</span>
                </h3>
                <div class="collapsible-content" id="fats-content">
                    <p>Grassi Totali: <span id="totale-fats-total">0</span> / <span id="obiettivo-fats-total"></span> g</p>
                    <progress id="progress-fats-total" class="macro-progress" value="0"></progress>
                    
                    <div class="fats-group">
                         <div class="fats-sub-bars-container">
                            <div>
                                <p>Saturi: <span id="totale-fat-sat">0</span> / <span id="obiettivo-fat-sat"></span> g</p>
                                <progress id="progress-fat-sat" class="progress-fat-sat" value="0"></progress>
                            </div>
                            <div>
                                <p>Trans: <span id="totale-fat-trans">0</span> / <span id="obiettivo-fat-trans"></span> g</p>
                                <progress id="progress-fat-trans" value="0"></progress>
                            </div>
                        </div>
                    </div>

                    <div class="fats-group">
                        <h4>Grassi Insaturi: <span id="totale-fat-unsat">0</span> / <span id="obiettivo-fat-unsat"></span> g</h4>
                        <progress id="progress-fat-unsat" value="0"></progress>
                        <div style="padding-left: 15px;">
                            <p>Monoinsaturi: <span id="totale-fat-mono">0</span> / <span id="obiettivo-fat-mono"></span> g</p>
                            <progress id="progress-fat-mono" value="0"></progress>
                            <p>Polinsaturi: <span id="totale-fat-poly">0</span> / <span id="obiettivo-fat-poly"></span> g</p>
                            <progress id="progress-fat-poly" value="0"></progress>
                            <div class="fats-group" style="border: none; padding-left: 10px; margin-top: 10px;">
                                 <div class="fats-sub-bars-container">
                                    <div>
                                        <p>Omega 3: <span id="totale-omega3">0</span> / <span id="obiettivo-omega3"></span> g</p>
                                        <progress id="progress-omega3" value="0"></progress>
                                    </div>
                                    <div>
                                        <p>Omega 6: <span id="totale-omega6">0</span> / <span id="obiettivo-omega6"></span> g</p>
                                        <progress id="progress-omega6" value="0"></progress>
                                    </div>
                                 </div>
                                 <p style="text-align: center; font-weight: bold; margin-top: 10px; font-size: 1.1em;">
                                    Rapporto O6:O3: <span id="omega-ratio-value"></span>
                                 </p>
                            </div>
                        </div>
                    </div>
                </div>
                <hr>
                
                <h3 class="collapsible-header" id="micro-header">
                    Micronutrienti <span class="arrow">‚ñ∂</span>
                </h3>
                <div class="collapsible-content" id="micro-content">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                        <div>
                            <p>Magnesio: <span id="totale-mg">0</span> / 420 mg</p><progress id="progress-mg" value="0"></progress>
                            <p>Potassio: <span id="totale-k">0</span> / 3400 mg</p><progress id="progress-k" value="0"></progress>
                        </div>
                        <div>
                            <p>Ferro: <span id="totale-fe">0</span> / 18 mg</p><progress id="progress-fe" value="0"></progress>
                            <p>Zinco: <span id="totale-zn">0</span> / 11 mg</p><progress id="progress-zn" value="0"></progress>
                        </div>
                        <div>
                            <p>Calcio: <span id="totale-ca">0</span> / 1000 mg</p><progress id="progress-ca" value="0"></progress>
                            <p>Rame: <span id="totale-cu">0</span> / 0.9 mg</p><progress id="progress-cu" value="0" max="0.9"></progress>
                        </div>
                    </div>
                     <div style="margin-top: 15px;">
                        <p>Fosforo: <span id="totale-p">0</span> / 700 mg</p><progress id="progress-p" value="0" max="700"></progress>
                    </div>
                </div>
                <hr>

                <h3 class="collapsible-header" id="vit-header">
                    Vitamine <span class="arrow">‚ñ∂</span>
                </h3>
                <div class="collapsible-content" id="vit-content">
                    <div class="vitamin-group">
                        <h4 style="display: flex; align-items: center; gap: 8px;">
                            Accumulabili (Liposolubili) 
                            <i id="info-vit-settimanali" class="fas fa-info-circle" style="cursor: pointer; color: #1976d2;"></i>
                        </h4>
                        <p>Vitamina A: <span id="totale-vit-a">0</span> / 900 ¬µg</p><progress id="progress-vit-a" value="0" max="900"></progress>
                        <p>Vitamina D: <span id="totale-vit-d">0</span> / 15 ¬µg</p><progress id="progress-vit-d" value="0" max="15"></progress>
                        <p>Vitamina E: <span id="totale-vit-e">0</span> / 15 mg</p><progress id="progress-vit-e" value="0" max="15"></progress>
                        <p>Vitamina K: <span id="totale-vit-k">0</span> / 120 ¬µg</p><progress id="progress-vit-k" value="0" max="120"></progress>
                        <p>Vitamina B12: <span id="totale-vit-b12">0</span> / 2.4 ¬µg</p><progress id="progress-vit-b12" value="0" max="2.4"></progress>
                    </div>
                     <div class="vitamin-group">
                        <h4>Giornaliere (Idrosolubili)</h4>
                        <p>Vitamina C: <span id="totale-vitc">0</span> / 90 mg</p><progress id="progress-vitc" value="0" max="90"></progress>
                        <p>Vitamina B2: <span id="totale-b2">0</span> / 1.3 mg</p><progress id="progress-b2" value="0" max="1.3"></progress>
                        <p>Vitamina B6: <span id="totale-b6">0</span> / 1.3 mg</p><progress id="progress-b6" value="0" max="1.3"></progress>
                        <p>Folati (B9): <span id="totale-b9">0</span> / 400 ¬µg</p><progress id="progress-b9" value="0" max="400"></progress>
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <label for="daily-notes">Note del Giorno</label>
                    <textarea id="daily-notes" rows="3" placeholder="Aggiungi note per la giornata..."></textarea>
                </div>
            </div>

            <div class="sezione">
                <h2>Sincronizzazione Cloud</h2>
                <div class="cloud-sync-section">
                    <button id="btn-download-manual" disabled>‚¨áÔ∏è Scarica Dati</button>
                    <span id="cloud-sync-status" class="cloud-sync-status disconnected">Disconnesso</span>
                </div>
            </div>
        </div>
    </div>
    
    <div id="weekly-vitamin-modal" class="modal"><div class="modal-content"><span class="modal-close" data-modal="weekly-vitamin-modal">&times;</span><h2>Riepilogo Settimanale Vitamine</h2><div id="weekly-vitamin-content"></div></div></div>
    <div id="weekly-fats-modal" class="modal"><div class="modal-content"><span class="modal-close" data-modal="weekly-fats-modal">&times;</span><h2>Riepilogo Settimanale Grassi</h2><div id="weekly-fats-content"></div></div></div>
    <div id="nutrient-detail-modal" class="modal"><div class="modal-content"><span class="modal-close" data-modal="nutrient-detail-modal">&times;</span><h2 id="nutrient-detail-modal-title"></h2><ul id="nutrient-detail-modal-list"></ul></div></div>
    <div id="amino-acid-modal" class="modal"><div class="modal-content"><span class="modal-close" data-modal="amino-acid-modal">&times;</span><h2 id="modal-amino-title"></h2><div id="modal-amino-summary"></div><div id="modal-amino-content"></div></div></div>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js" type="module"></script> 
    <script type="module">
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";

        const firebaseConfig = {
          apiKey: "AIzaSyA5pSzpfq1aGZ1wjNV5-eXnIqWL6brl424",
          authDomain: "mio-tracker.firebaseapp.com",
          databaseURL: "https://mio-tracker-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "mio-tracker",
          storageBucket: "mio-tracker.firebasestorage.app",
          messagingSenderId: "382993217593",
          appId: "1:382993217593:web:f0780aa061c23f9503f5e8"
        };

        let giornoVisualizzato = getTodayString('ymd');
        let datiGiornalieri = {};
        let foodDatabase = {};
        let pastoInCostruzione = [];
        
        let db; 
        let auth; 
        let firebaseApp; 
        let currentUserUID = null; 

        const PIANO_SETTIMANALE = {
            0: { tipo: 'üíß Riposo (Deficit)', cal_base: 2300, prot: 140, carb: 300, zuccheri: 25 },
            1: { tipo: 'üî• Forza (Surplus)', cal_base: 2300, prot: 140, carb: 300, zuccheri: 25 },
            2: { tipo: 'üí™ Forza (Surplus)', cal_base: 2300, prot: 140, carb: 300, zuccheri: 25 },
            3: { tipo: 'üèÉ Cardio (Deficit)', cal_base: 2300, prot: 140, carb: 300, zuccheri: 25 },
            4: { tipo: 'üèãÔ∏è Forza (Surplus)', cal_base: 2300, prot: 140, carb: 300, zuccheri: 25 },
            5: { tipo: 'üèÉ Cardio (Surplus)', cal_base: 2300, prot: 140, carb: 300, zuccheri: 25 },
            6: { tipo: 'ü•ó Mantenimento (Deficit)', cal_base: 2300, prot: 140, carb: 300, zuccheri: 25 }
        };

        const DEFICIT_PREIMPOSTATO_SETTIMANALE = { 0: -250, 1: +300, 2: +300, 3: -250, 4: +300, 5: +300, 6: -250 };

        const OBIETTIVI_MICRO = { mg: 420, k: 3400, vitc: 90, ca: 1000, fe: 18, zn: 11, cu: 0.9, p: 700 };
        const OBIETTIVI_FAT = { 
            fatTotal: 85, fatSat: 20, fatTrans: 2, 
            fatUnsat: 65, fatMono: 45, fatPoly: 20, 
            omega3: 2, omega6: 10 
        };
        const OBIETTIVI_FIBRE = { fibreTotali: 30, fibreSolubili: 10, fibreInsolubili: 20 };
        const OBIETTIVI_VIT = { vitA: 900, vitB12: 2.4, vitD: 15, vitE: 15, vitK: 120, b9: 400, b2: 1.3, b6: 1.3 };
        
        const OBIETTIVI_AMINO = {
            leu: 2900, iso: 1500, val: 1900, 
            lys: 2200, met: 1100, phe: 1800, 
            thr: 1100, trp: 300,  his: 750 
        };

        const PROFILO_AMINOACIDICO_RIFERIMENTO = {
            leu: 59, iso: 30, val: 39,
            lys: 45, met: 22, phe: 38,
            thr: 23, trp: 6.0, his: 15
        };

        const OBIETTIVI_MACRO_PASTO_BASE_FORZA = {
            merenda1: { prot: 30, cal_perc: 0.20 },
            pranzo: { prot: 40, cal_perc: 0.35 },
            merenda2: { prot: 30, cal_perc: 0.15 },
            cena: { prot: 40, cal_perc: 0.30 }
        };
        const totalProtForza = Object.values(OBIETTIVI_MACRO_PASTO_BASE_FORZA).reduce((sum, p) => sum + p.prot, 0);
        for (const mealType in OBIETTIVI_MACRO_PASTO_BASE_FORZA) {
            OBIETTIVI_MACRO_PASTO_BASE_FORZA[mealType].prot_perc = OBIETTIVI_MACRO_PASTO_BASE_FORZA[mealType].prot / totalProtForza;
        }

        const MEAL_TYPE_SEQUENCE = ['merenda1', 'pranzo', 'merenda2', 'cena'];
        const LOCAL_STORAGE_SYNC_KEYS = ['trackerFoodDatabase', 'trackerPesate', 'trackerMealType', 'trackerPastoInCostruzione'];
        const LOCAL_LAST_UPDATE_KEY = 'lastLocalUpdateTimestamp';
        const CLOUD_LAST_UPDATE_PATH = 'lastCloudUpdateTimestamp';

        const API_KEY_AI = "AIzaSyCZUoiawXYzrqDLh1m0O0Wnt5ZhR3wP9Ac";
        const GEMINI_ENDPOINT = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY_AI}`;
        const GEMINI_PROMPT_FORMAT = `{"prot":g,"kcal":kcal,"carb":g,"zuccheri":g,"fatSat":g,"fatTrans":g,"fatMono":g,"fatPoly":g,"omega3":g,"omega6":g,"fibreTotali":g,"fibreSolubili":g,"fibreInsolubili":g,"mg":mg,"k":mg,"vitc":mg,"ca":mg,"vitA":¬µg,"vitB12":¬µg,"vitD":¬µg,"vitE":mg,"vitK":¬µg,"b9":¬µg,"b2":mg,"b6":mg,"fe":mg,"zn":mg,"cu":mg,"p":mg,"leu":mg,"iso":mg,"val":mg,"lys":mg,"met":mg,"phe":mg,"thr":mg,"trp":mg,"his":mg}`;
        const AI_INSTRUCTION = "Agisci come un esperto nutrizionista. Basa le tue risposte su database nutrizionali affidabili (come IEO, USDA, CREA). Se un valore non √® disponibile, fornisci una stima scientificamente plausibile basata sulla composizione dell'alimento. Per gli amminoacidi, fornisci un profilo specifico per la fonte proteica dell'alimento, non un profilo generico. Assicurati che le unit√† di misura siano corrette come specificato nel formato JSON richiesto.";

        const authSection = document.getElementById('auth-section');
        const userEmailInput = document.getElementById('user-email');
        const userPasswordInput = document.getElementById('user-password');
        const btnRegister = document.getElementById('btn-register');
        const btnLogin = document.getElementById('btn-login');
        const btnSignOut = document.getElementById('btn-sign-out');
        const authStatusP = document.getElementById('auth-status');
        const welcomeMessage = document.getElementById('welcome-message');
        const authFormFields = document.getElementById('auth-form-fields');
        const mainTrackerContent = document.getElementById('main-tracker-content');
        const titoloGiornataEl = document.getElementById('titolo-giornata');
        const logBody = document.getElementById('log-body');
        const suggestionsContainer = document.getElementById('custom-suggestions');
        const btnAggiungiSingolo = document.getElementById('btn-aggiungi-singolo');
        const btnCostruisciPasto = document.getElementById('btn-costruisci-pasto');
        const mealBuilderSezione = document.getElementById('meal-builder-sezione');
        const logPastoBuilderBody = document.getElementById('log-pasto-builder-body');
        const btnSalvaPasto = document.getElementById('btn-salva-pasto');
        const mealTypeSelector = document.getElementById('meal-type-selector');
        const dataCaricamentoInput = document.getElementById('data-caricamento');
        const calorieBalanceText = document.getElementById('calorie-balance-text');
        const calorieAdjustmentInput = document.getElementById('calorie-adjustment-input');
        const btnCalorieMinus = document.getElementById('btn-calorie-minus');
        const btnCaloriePlus = document.getElementById('btn-calorie-plus');
        const btnDownloadManual = document.getElementById('btn-download-manual');
        const cloudSyncStatusSpan = document.getElementById('cloud-sync-status');
        const cloudSyncSection = document.querySelector('.cloud-sync-section');
        const btnCopyPrompt = document.getElementById('btn-copy-prompt');
        const manualJsonInput = document.getElementById('manual-json-input');
        const btnConfirmJson = document.getElementById('btn-confirm-json');
        const btnClearNutrients = document.getElementById('btn-clear-nutrients');
        const weeklyVitaminModal = document.getElementById('weekly-vitamin-modal');
        const infoVitSettimanaliBtn = document.getElementById('info-vit-settimanali');
        const weeklyFatsModal = document.getElementById('weekly-fats-modal');
        const infoFatsSettimanaliBtn = document.getElementById('info-fats-settimanali');
        const nutrientDetailModal = document.getElementById('nutrient-detail-modal');
        const nutrientDetailTitle = document.getElementById('nutrient-detail-modal-title');
        const nutrientDetailList = document.getElementById('nutrient-detail-modal-list');
        const builderDesc = document.getElementById('builder-desc'), builderQta = document.getElementById('builder-qta');
        const builderProt = document.getElementById('builder-prot'), builderKcal = document.getElementById('builder-kcal');
        const builderCarb = document.getElementById('builder-carb'), builderZuccheri = document.getElementById('builder-zuccheri');
        const builderFatTotal = document.getElementById('builder-fat-total');
        const builderFibreTotali = document.getElementById('builder-fibre-totali');
        const builderFibreSolubili = document.getElementById('builder-fibre-solubili');
        const builderFibreInsolubili = document.getElementById('builder-fibre-insolubili');
        const builderFatSat = document.getElementById('builder-fat-sat'), builderFatTrans = document.getElementById('builder-fat-trans'), builderFatMono = document.getElementById('builder-fat-mono'), builderFatPoly = document.getElementById('builder-fat-poly'), builderOmega3 = document.getElementById('builder-omega3'), builderOmega6 = document.getElementById('builder-omega6');
        const builderMg = document.getElementById('builder-mg'), builderK = document.getElementById('builder-k'), builderVitC = document.getElementById('builder-vitc'), builderCa = document.getElementById('builder-ca');
        const builderVitA = document.getElementById('builder-vit-a'), builderVitB12 = document.getElementById('builder-vit-b12'), builderVitD = document.getElementById('builder-vit-d');
        const builderVitE = document.getElementById('builder-vit-e'), builderVitK = document.getElementById('builder-vit-k'), builderB9 = document.getElementById('builder-b9');
        const builderB2 = document.getElementById('builder-b2'), builderB6 = document.getElementById('builder-b6');
        const builderFe = document.getElementById('builder-fe'), builderZn = document.getElementById('builder-zn'), builderCu = document.getElementById('builder-cu'), builderP = document.getElementById('builder-p');
        const builderLeu = document.getElementById('builder-leu'), builderIso = document.getElementById('builder-iso'), builderVal = document.getElementById('builder-val');
        const builderLys = document.getElementById('builder-lys'), builderMet = document.getElementById('builder-met'), builderPhe = document.getElementById('builder-phe');
        const builderThr = document.getElementById('builder-thr'), builderTrp = document.getElementById('builder-trp'), builderHis = document.getElementById('builder-his');
        const dailyNotesTextarea = document.getElementById('daily-notes');
        const btnEditIngredients = document.getElementById('btn-edit-ingredients');
        const btnEditName = document.getElementById('btn-edit-name');
        const ingredientModal = document.getElementById('ingredient-modal');
        const ingredientModalTitle = document.getElementById('ingredient-modal-title');
        const ingredientModalTextarea = document.getElementById('ingredient-modal-textarea');
        const ingredientModalActions = document.getElementById('ingredient-modal-actions');
        const btnGenerateIngredientsAi = document.getElementById('btn-generate-ingredients-ai');
        const btnCopyIngredientsPrompt = document.getElementById('btn-copy-ingredients-prompt');
        const btnSaveIngredients = document.getElementById('btn-save-ingredients');
        const btnClearIngredients = document.getElementById('btn-clear-ingredients');
        const btnPhotoIngredients = document.getElementById('btn-photo-ingredients');
        const ingredientPhotoInput = document.getElementById('ingredient-photo-input');
        const ocrStatusIngredients = document.getElementById('ocr-status-ingredients');
        const btnPhotoNutrients = document.getElementById('btn-photo-nutrients');
        const nutrientPhotoInput = document.getElementById('nutrient-photo-input');
        const nutrientConfirmModal = document.getElementById('nutrient-confirm-modal');
        const nutrientConfirmList = document.getElementById('nutrient-confirm-list');
        const btnConfirmNutrients = document.getElementById('btn-confirm-nutrients');
        const btnCancelNutrients = document.getElementById('btn-cancel-nutrients');
        const ocrStatusNutrients = document.getElementById('ocr-status-nutrients');
        const photoOcrStatus = document.getElementById('photo-ocr-status');
        const btnScanBarcode = document.getElementById('btn-scan-barcode');
        const barcodeScannerModal = document.getElementById('barcode-scanner-modal');
        const barcodeScannerVideo = document.getElementById('barcode-scanner-video');
        const barcodeScannerStatus = document.getElementById('barcode-scanner-status');
        const diffModal = document.getElementById('diff-modal');
        let videoStream = null;

        const inputFields = {
            prot: { el: builderProt, label: 'Proteine/100g' },
            kcal: { el: builderKcal, label: 'Kcal/100g' },
            carb: { el: builderCarb, label: 'Carboidrati/100g' },
            zuccheri: { el: builderZuccheri, label: 'Zuccheri/100g' },
            fatTotal: { el: builderFatTotal, label: 'Grassi Totali/100g' },
            fatSat: { el: builderFatSat, label: 'Gr. Saturi/100g' },
            fatTrans: { el: builderFatTrans, label: 'Gr. Trans/100g' },
            fatMono: { el: builderFatMono, label: 'Gr. Monoinsaturi/100g' },
            fatPoly: { el: builderFatPoly, label: 'Gr. Polinsaturi/100g' },
            omega3: { el: builderOmega3, label: 'Omega 3/100g' },
            omega6: { el: builderOmega6, label: 'Omega 6/100g' },
            fibreTotali: { el: builderFibreTotali, label: 'Fibre Totali/100g' },
            fibreSolubili: { el: builderFibreSolubili, label: 'Fibre Solubili/100g' },
            fibreInsolubili: { el: builderFibreInsolubili, label: 'Fibre Insolubili/100g' },
            mg: { el: builderMg, label: 'Magnesio (mg)/100g' },
            k: { el: builderK, label: 'Potassio (mg)/100g' },
            vitc: { el: builderVitC, label: 'Vitamina C (mg)/100g' },
            ca: { el: builderCa, label: 'Calcio (mg)/100g' },
            fe: { el: builderFe, label: 'Ferro (mg)/100g' },
            zn: { el: builderZn, label: 'Zinco (mg)/100g' },
            cu: { el: builderCu, label: 'Rame (mg)/100g' },
            p: { el: builderP, label: 'Fosforo (mg)/100g' },
            vitA: { el: builderVitA, label: 'Vit. A (Œºg)/100g' },
            vitB12: { el: builderVitB12, label: 'Vit. B12 (Œºg)/100g' },
            vitD: { el: builderVitD, label: 'Vit. D (Œºg)/100g' },
            vitE: { el: builderVitE, label: 'Vit. E (mg)/100g' },
            vitK: { el: builderVitK, label: 'Vit. K (Œºg)/100g' },
            b9: { el: builderB9, label: 'Folati B9 (Œºg)/100g' },
            b2: { el: builderB2, label: 'Vit. B2 (mg)/100g' },
            b6: { el: builderB6, label: 'Vit. B6 (mg)/100g' },
            leu: { el: builderLeu, label: 'Leucina (mg)/100g' },
            iso: { el: builderIso, label: 'Isoleucina (mg)/100g' },
            val: { el: builderVal, label: 'Valina (mg)/100g' },
            lys: { el: builderLys, label: 'Lisina (mg)/100g' },
            met: { el: builderMet, label: 'Metionina (mg)/100g' },
            phe: { el: builderPhe, label: 'Fenilalanina (mg)/100g' },
            thr: { el: builderThr, label: 'Treonina (mg)/100g' },
            trp: { el: builderTrp, label: 'Triptofano (mg)/100g' },
            his: { el: builderHis, label: 'Istidina (mg)/100g' }
        };

        const spanTotaleProteine = document.getElementById('totale-proteine'), spanObiettivoProteine = document.getElementById('obiettivo-proteine'), progressProteine = document.getElementById('progress-proteine');
        const spanTotaleCalorie = document.getElementById('totale-calorie'), spanObiettivoCalorie = document.getElementById('obiettivo-calorie'), progressCalorie = document.getElementById('progress-calorie');
        const spanTotaleCarboidrati = document.getElementById('totale-carboidrati'), spanObiettivoCarboidrati = document.getElementById('obiettivo-carboidrati'), progressCarboidrati = document.getElementById('progress-carboidrati');
        const spanTotaleZuccheri = document.getElementById('totale-zuccheri'), spanObiettivoZuccheri = document.getElementById('obiettivo-zuccheri'), progressZuccheri = document.getElementById('progress-zuccheri');
        const spanWorkoutCalories = document.getElementById('workout-calories-totali');
        const spanTotaleFibreTotali = document.getElementById('totale-fibre-totali'), spanObiettivoFibreTotali = document.getElementById('obiettivo-fibre-totali'), progressFibreTotali = document.getElementById('progress-fibre-totali');
        const spanTotaleFibreSolubili = document.getElementById('totale-fibre-solubili'), spanObiettivoFibreSolubili = document.getElementById('obiettivo-fibre-solubili'), progressFibreSolubili = document.getElementById('progress-fibre-solubili');
        const spanTotaleFibreInsolubili = document.getElementById('totale-fibre-insolubili'), spanObiettivoFibreInsolubili = document.getElementById('obiettivo-fibre-insolubili'), progressFibreInsolubili = document.getElementById('progress-fibre-insolubili');
        const spanTotaleFatsTotal = document.getElementById('totale-fats-total'), spanObiettivoFatsTotal = document.getElementById('obiettivo-fats-total'), progressFatsTotal = document.getElementById('progress-fats-total');
        const spanTotaleFatSat = document.getElementById('totale-fat-sat'), spanObiettivoFatSat = document.getElementById('obiettivo-fat-sat'), progressFatSat = document.getElementById('progress-fat-sat');
        const spanTotaleFatTrans = document.getElementById('totale-fat-trans'), spanObiettivoFatTrans = document.getElementById('obiettivo-fat-trans'), progressFatTrans = document.getElementById('progress-fat-trans');
        const spanTotaleFatUnsat = document.getElementById('totale-fat-unsat'), spanObiettivoFatUnsat = document.getElementById('obiettivo-fat-unsat'), progressFatUnsat = document.getElementById('progress-fat-unsat');
        const spanTotaleFatMono = document.getElementById('totale-fat-mono'), spanObiettivoFatMono = document.getElementById('obiettivo-fat-mono'), progressFatMono = document.getElementById('progress-fat-mono');
        const spanTotaleFatPoly = document.getElementById('totale-fat-poly'), spanObiettivoFatPoly = document.getElementById('obiettivo-fat-poly'), progressFatPoly = document.getElementById('progress-fat-poly');
        const spanTotaleOmega3 = document.getElementById('totale-omega3'), spanObiettivoOmega3 = document.getElementById('obiettivo-omega3'), progressOmega3 = document.getElementById('progress-omega3');
        const spanTotaleOmega6 = document.getElementById('totale-omega6'), spanObiettivoOmega6 = document.getElementById('obiettivo-omega6'), progressOmega6 = document.getElementById('progress-omega6');
        const omegaRatioValueEl = document.getElementById('omega-ratio-value');
        const spanTotaleMg = document.getElementById('totale-mg'), progressMg = document.getElementById('progress-mg');
        const spanTotaleK = document.getElementById('totale-k'), progressK = document.getElementById('progress-k');
        const spanTotaleCa = document.getElementById('totale-ca'), progressCa = document.getElementById('progress-ca');
        const spanTotaleFe = document.getElementById('totale-fe'), progressFe = document.getElementById('progress-fe');
        const spanTotaleZn = document.getElementById('totale-zn'), progressZn = document.getElementById('progress-zn');
        const spanTotaleCu = document.getElementById('totale-cu'), progressCu = document.getElementById('progress-cu');
        const spanTotaleP = document.getElementById('totale-p'), progressP = document.getElementById('progress-p');
        const spanTotaleVitC = document.getElementById('totale-vitc'), progressVitC = document.getElementById('progress-vitc');
        const spanTotaleVitA = document.getElementById('totale-vit-a'), progressVitA = document.getElementById('progress-vit-a');
        const spanTotaleVitB12 = document.getElementById('totale-vit-b12'), progressVitB12 = document.getElementById('progress-vit-b12');
        const spanTotaleVitD = document.getElementById('totale-vit-d'), progressVitD = document.getElementById('progress-vit-d');
        const spanTotaleVitE = document.getElementById('totale-vit-e'), progressVitE = document.getElementById('progress-vit-e');
        const spanTotaleVitK = document.getElementById('totale-vit-k'), progressVitK = document.getElementById('progress-vit-k');
        const spanTotaleB9 = document.getElementById('totale-b9'), progressB9 = document.getElementById('progress-b9');
        const spanTotaleB2 = document.getElementById('totale-b2'), progressB2 = document.getElementById('progress-b2');
        const spanTotaleB6 = document.getElementById('totale-b6'), progressB6 = document.getElementById('progress-b6');
        const currentMealTypeDisplay = document.getElementById('current-meal-type-display');
        const mealProtCurrent = document.getElementById('meal-prot-current'), mealProtTarget = document.getElementById('meal-prot-target'), mealProtRemaining = document.getElementById('meal-prot-remaining');
        const mealCalCurrent = document.getElementById('meal-cal-current'), mealCalTarget = document.getElementById('meal-cal-target'), mealCalRemaining = document.getElementById('meal-cal-remaining');
        const mealProgressProt = document.getElementById('meal-progress-prot'), mealProgressCal = document.getElementById('meal-progress-cal');
        const workoutDescInput = document.getElementById('workout-desc');
        const workoutCaloriesInput = document.getElementById('workout-calories');
        const btnAddWorkout = document.getElementById('btn-add-workout');
        
        function getTodayString(format = 'ymd') { return new Date().toISOString().split('T')[0]; }

        function sanitizeFirebaseKey(str) {
            if (!str) return '';
            return str.replace(/[.#$/\[\]]/g, '_');
        }
        
        async function saveSingleItemToCloud(path, data) {
            const dataRef = (db && currentUserUID) ? ref(db, `users/${currentUserUID}/tracker_data/${path}`) : null;
            if (!dataRef) return;
            try {
                await set(dataRef, data);
                await set(ref(db, `users/${currentUserUID}/${CLOUD_LAST_UPDATE_PATH}`), Date.now());
                console.log(`Dato salvato su cloud in: ${path}`);
            } catch (err) {
                console.error(`Errore salvataggio su cloud per ${path}:`, err);
            }
        }
        
        function salvaFoodDatabase() { 
            localStorage.setItem('trackerFoodDatabase', JSON.stringify(foodDatabase)); 
            localStorage.setItem(LOCAL_LAST_UPDATE_KEY, Date.now()); 
            
            const sanitizedDb = {};
            for (const key in foodDatabase) {
                sanitizedDb[sanitizeFirebaseKey(key)] = foodDatabase[key];
            }
            saveSingleItemToCloud('trackerFoodDatabase', sanitizedDb);
        }
        
        function salvaPastoInCostruzione() { 
            localStorage.setItem('trackerPastoInCostruzione', JSON.stringify(pastoInCostruzione)); 
            localStorage.setItem(LOCAL_LAST_UPDATE_KEY, Date.now()); 
            saveSingleItemToCloud('trackerPastoInCostruzione', pastoInCostruzione);
        }
        
        function salvaGiorno(dataDaSalvare, datiDaSalvare) {
            if (!datiDaSalvare) datiDaSalvare = datiGiornalieri;
            if (dailyNotesTextarea) datiDaSalvare.note = dailyNotesTextarea.value;
            datiDaSalvare.data = dataDaSalvare;
            const key = `trackerStorico_${dataDaSalvare}`;
            localStorage.setItem(key, JSON.stringify(datiDaSalvare));
            localStorage.setItem(LOCAL_LAST_UPDATE_KEY, Date.now());
            console.log(`Dati salvati LOCALMENTE per il giorno: ${dataDaSalvare}`);
            saveSingleItemToCloud(key, datiDaSalvare);
        }
        
        function caricaGiorno(data) {
            giornoVisualizzato = data;
            if(dataCaricamentoInput) dataCaricamentoInput.value = data;

            let datiTrovati = null;
            let rawDataFromLocalStorage = localStorage.getItem(`trackerStorico_${data}`);
            try {
                datiTrovati = JSON.parse(rawDataFromLocalStorage);
                 if (datiTrovati && datiTrovati.log) {
                    datiTrovati.log.forEach(entry => {
                        const items = entry.type === 'meal' ? entry.items : [entry];
                        items.forEach(item => {
                            if (item && item.cal && !item.kcal) {
                                item.kcal = item.cal;
                                delete item.cal;
                            }
                        });
                    });
                }
            } catch (e) {
                console.error(`Errore nel parsing di trackerStorico_${data}:`, e, "Raw data:", rawDataFromLocalStorage);
            }
            
            datiGiornalieri = datiTrovati || { log: [], workoutCalorie: 0, note: '' };
            if(dailyNotesTextarea) dailyNotesTextarea.value = datiGiornalieri.note || '';
            if (!datiGiornalieri.log) datiGiornalieri.log = [];
            if (typeof datiGiornalieri.workoutCalorie === 'undefined') datiGiornalieri.workoutCalorie = 0;

            const dataCorrente = new Date(data);
            const giornoSettimana = dataCorrente.getDay(); 
            const valorePreimpostatoPerGiorno = DEFICIT_PREIMPOSTATO_SETTIMANALE[giornoSettimana] || 0;

            if (typeof datiGiornalieri.calorieAdjustment === 'undefined' || datiGiornalieri.calorieAdjustment === 0) {
                datiGiornalieri.calorieAdjustment = valorePreimpostatoPerGiorno;
            }
            
            aggiornaUI();
            console.log(`Caricato il giorno: ${giornoVisualizzato} da localStorage`); 
        }

        function calcolaObiettiviPasto(mealType, giornoCorrenteString) {
            const dataVisualizzata = new Date(giornoCorrenteString);
            const giornoSettimana = dataVisualizzata.getDay();
            const pianoDelGiorno = PIANO_SETTIMANALE[giornoSettimana] || PIANO_SETTIMANALE[1];

            const obiettivoCalTotaleGiornaliero = pianoDelGiorno.cal_base + (datiGiornalieri.workoutCalorie || 0) + (datiGiornalieri.calorieAdjustment || 0);
            const obiettivoProtTotaleGiornaliero = pianoDelGiorno.prot;

            let obiettivoPastoProt = 0, obiettivoPastoCal = 0;
            const calRatio = OBIETTIVI_MACRO_PASTO_BASE_FORZA[mealType]?.cal_perc ?? 0;
            const protRatio = OBIETTIVI_MACRO_PASTO_BASE_FORZA[mealType]?.prot_perc ?? 0;

            if (mealType === 'cena') {
                let consumatoProtAltriPasti = 0, consumatoCalAltriPasti = 0;
                (datiGiornalieri.log || []).forEach(entry => {
                    if (entry.mealId && entry.mealId !== 'cena') {
                        const items = entry.type === 'meal' ? entry.items : [entry];
                        items.forEach(item => {
                           consumatoProtAltriPasti += item.prot || 0;
                           consumatoCalAltriPasti += (item.kcal || item.cal) || 0;
                        });
                    }
                });
                obiettivoPastoProt = Math.max(0, Math.round(obiettivoProtTotaleGiornaliero - consumatoProtAltriPasti));
                obiettivoPastoCal = Math.max(0, Math.round(obiettivoCalTotaleGiornaliero - consumatoCalAltriPasti));
            } else {
                obiettivoPastoProt = Math.round(obiettivoProtTotaleGiornaliero * protRatio);
                obiettivoPastoCal = Math.round(obiettivoCalTotaleGiornaliero * calRatio);
            }
            
            const totaliPastoInCostruzione = pastoInCostruzione.reduce((acc, item) => {
                acc.prot += item.prot || 0; acc.kcal += (item.kcal || item.cal) || 0; return acc;
            }, { prot: 0, kcal: 0 });

            return {
                currentProt: totaliPastoInCostruzione.prot, targetProt: obiettivoPastoProt, remainingProt: obiettivoPastoProt - totaliPastoInCostruzione.prot,
                currentCal: totaliPastoInCostruzione.kcal, targetCal: obiettivoPastoCal, remainingCal: obiettivoPastoCal - totaliPastoInCostruzione.kcal
            };
        }

        function initAppUI() {
            foodDatabase = JSON.parse(localStorage.getItem('trackerFoodDatabase')) || {};
            pastoInCostruzione = JSON.parse(localStorage.getItem('trackerPastoInCostruzione')) || [];
            pastoInCostruzione.forEach(item => {
                if (item.cal && !item.kcal) {
                    item.kcal = item.cal;
                    delete item.cal;
                }
            });
            if(mealBuilderSezione) renderMealBuilder();
            caricaGiorno(getTodayString());
            
            if (mealTypeSelector) { 
                const lastMealTypeSelected = localStorage.getItem('lastMealTypeSelected_' + getTodayString());
                mealTypeSelector.value = (lastMealTypeSelected && MEAL_TYPE_SEQUENCE.includes(lastMealTypeSelected)) ? lastMealTypeSelected : MEAL_TYPE_SEQUENCE[0];
            }
            console.log("Interfaccia app avviata con successo con dati locali.");
        }

        function aggiornaUI() {
            if(!document.getElementById('riepilogo') && !document.getElementById('log-body')) return;

            const dataVisualizzata = new Date(giornoVisualizzato);
            const pianoDelGiorno = PIANO_SETTIMANALE[dataVisualizzata.getDay()] || PIANO_SETTIMANALE[1];
            
            const obiettivoCalorieTotale = pianoDelGiorno.cal_base + (datiGiornalieri.workoutCalorie || 0) + (datiGiornalieri.calorieAdjustment || 0);
            const OBIETTIVI = { 
                prot: pianoDelGiorno.prot, kcal: obiettivoCalorieTotale, carb: pianoDelGiorno.carb, zuccheri: pianoDelGiorno.zuccheri, 
                ...OBIETTIVI_MICRO, ...OBIETTIVI_FAT, ...OBIETTIVI_VIT, ...OBIETTIVI_AMINO, ...OBIETTIVI_FIBRE
            };
            
            if(titoloGiornataEl) titoloGiornataEl.textContent = `${pianoDelGiorno.tipo} - ${dataVisualizzata.toLocaleDateString('it-IT', {day: 'numeric', month: 'long', year: 'numeric'})}`;
            
            let totali = { 
                prot: 0, kcal: 0, carb: 0, zuccheri: 0, fatTotal: 0, fatSat: 0, fatTrans: 0, fatMono: 0, fatPoly: 0, omega3: 0, omega6: 0, 
                mg: 0, k: 0, vitc: 0, ca: 0, fe: 0, zn: 0, cu: 0, p: 0, vitA: 0, vitB12: 0, vitD: 0, vitE: 0, vitK: 0, b9: 0, b2: 0, b6: 0,
                leu: 0, iso: 0, val: 0, lys: 0, met: 0, phe: 0, thr: 0, trp: 0, his: 0,
                fibreTotali: 0, fibreSolubili: 0, fibreInsolubili: 0
            };
            
            (datiGiornalieri.log || []).forEach(entry => {
                if (entry.type !== 'workout') {
                    const items = entry.type === 'meal' ? entry.items : [entry];
                    items.forEach(item => {
                        for(const key in totali){
                            totali[key] += item[key] || 0;
                        }
                        if(item.cal && !item.kcal) totali.kcal += item.cal;
                    });
                }
            });

            totali.fatUnsat = totali.fatMono + totali.fatPoly;
            
            if(document.getElementById('riepilogo')){
                spanObiettivoProteine.textContent = OBIETTIVI.prot; spanTotaleProteine.textContent = totali.prot.toFixed(1); progressProteine.max = OBIETTIVI.prot; progressProteine.value = totali.prot;
                spanObiettivoCalorie.textContent = OBIETTIVI.kcal; spanTotaleCalorie.textContent = totali.kcal.toFixed(0); progressCalorie.max = OBIETTIVI.kcal; progressCalorie.value = totali.kcal;
                spanObiettivoCarboidrati.textContent = OBIETTIVI.carb; spanTotaleCarboidrati.textContent = totali.carb.toFixed(1); progressCarboidrati.max = OBIETTIVI.carb; progressCarboidrati.value = totali.carb;
                spanObiettivoZuccheri.textContent = OBIETTIVI.zuccheri; spanTotaleZuccheri.textContent = totali.zuccheri.toFixed(1); progressZuccheri.max = OBIETTIVI.zuccheri; progressZuccheri.value = totali.zuccheri;
                spanWorkoutCalories.textContent = datiGiornalieri.workoutCalorie ? datiGiornalieri.workoutCalorie.toFixed(0) : 0; 
                spanObiettivoFibreTotali.textContent = OBIETTIVI_FIBRE.fibreTotali; spanTotaleFibreTotali.textContent = totali.fibreTotali.toFixed(1); progressFibreTotali.max = OBIETTIVI_FIBRE.fibreTotali; progressFibreTotali.value = totali.fibreTotali;
                spanObiettivoFibreSolubili.textContent = OBIETTIVI_FIBRE.fibreSolubili; spanTotaleFibreSolubili.textContent = totali.fibreSolubili.toFixed(1); progressFibreSolubili.max = OBIETTIVI_FIBRE.fibreSolubili; progressFibreSolubili.value = totali.fibreSolubili;
                spanObiettivoFibreInsolubili.textContent = OBIETTIVI_FIBRE.fibreInsolubili; spanTotaleFibreInsolubili.textContent = totali.fibreInsolubili.toFixed(1); progressFibreInsolubili.max = OBIETTIVI_FIBRE.fibreInsolubili; progressFibreInsolubili.value = totali.fibreInsolubili;
                spanObiettivoFatsTotal.textContent = OBIETTIVI_FAT.fatTotal; spanTotaleFatsTotal.textContent = totali.fatTotal.toFixed(1); progressFatsTotal.max = OBIETTIVI_FAT.fatTotal; progressFatsTotal.value = totali.fatTotal;
                spanObiettivoFatSat.textContent = OBIETTIVI_FAT.fatSat; spanTotaleFatSat.textContent = totali.fatSat.toFixed(1); progressFatSat.max = OBIETTIVI_FAT.fatSat; progressFatSat.value = totali.fatSat;
                spanObiettivoFatTrans.textContent = OBIETTIVI_FAT.fatTrans; spanTotaleFatTrans.textContent = totali.fatTrans.toFixed(1); progressFatTrans.max = OBIETTIVI_FAT.fatTrans; progressFatTrans.value = totali.fatTrans;
                spanObiettivoFatUnsat.textContent = OBIETTIVI_FAT.fatUnsat; spanTotaleFatUnsat.textContent = totali.fatUnsat.toFixed(1); progressFatUnsat.max = OBIETTIVI_FAT.fatUnsat; progressFatUnsat.value = totali.fatUnsat;
                spanObiettivoFatMono.textContent = OBIETTIVI_FAT.fatMono; spanTotaleFatMono.textContent = totali.fatMono.toFixed(1); progressFatMono.max = OBIETTIVI_FAT.fatMono; progressFatMono.value = totali.fatMono;
                spanObiettivoFatPoly.textContent = OBIETTIVI_FAT.fatPoly; spanTotaleFatPoly.textContent = totali.fatPoly.toFixed(1); progressFatPoly.max = OBIETTIVI_FAT.fatPoly; progressFatPoly.value = totali.fatPoly;
                spanObiettivoOmega3.textContent = OBIETTIVI_FAT.omega3; spanTotaleOmega3.textContent = totali.omega3.toFixed(1); progressOmega3.max = OBIETTIVI_FAT.omega3; progressOmega3.value = totali.omega3;
                spanObiettivoOmega6.textContent = OBIETTIVI_FAT.omega6; spanTotaleOmega6.textContent = totali.omega6.toFixed(1); progressOmega6.max = OBIETTIVI_FAT.omega6; progressOmega6.value = totali.omega6;
                spanTotaleMg.textContent = totali.mg.toFixed(1); progressMg.max = OBIETTIVI.mg; progressMg.value = totali.mg;
                spanTotaleK.textContent = totali.k.toFixed(0); progressK.max = OBIETTIVI.k; progressK.value = totali.k;
                spanTotaleCa.textContent = totali.ca.toFixed(1); progressCa.max = OBIETTIVI.ca; progressCa.value = totali.ca;
                spanTotaleFe.textContent = totali.fe.toFixed(1); progressFe.max = OBIETTIVI.fe; progressFe.value = totali.fe;
                spanTotaleZn.textContent = totali.zn.toFixed(1); progressZn.max = OBIETTIVI.zn; progressZn.value = totali.zn;
                spanTotaleCu.textContent = totali.cu.toFixed(2); progressCu.max = OBIETTIVI.cu; progressCu.value = totali.cu;
                spanTotaleP.textContent = totali.p.toFixed(0); progressP.max = OBIETTIVI.p; progressP.value = totali.p;
                spanTotaleVitC.textContent = totali.vitc.toFixed(1); progressVitC.max = OBIETTIVI.vitc; progressVitC.value = totali.vitc;
                spanTotaleVitA.textContent = totali.vitA.toFixed(1); progressVitA.max = OBIETTIVI.vitA; progressVitA.value = totali.vitA;
                spanTotaleVitB12.textContent = totali.vitB12.toFixed(1); progressVitB12.max = OBIETTIVI.vitB12; progressVitB12.value = totali.vitB12;
                spanTotaleVitD.textContent = totali.vitD.toFixed(1); progressVitD.max = OBIETTIVI.vitD; progressVitD.value = totali.vitD;
                spanTotaleVitE.textContent = totali.vitE.toFixed(1); progressVitE.max = OBIETTIVI.vitE; progressVitE.value = totali.vitE;
                spanTotaleVitK.textContent = totali.vitK.toFixed(1); progressVitK.max = OBIETTIVI.vitK; progressVitK.value = totali.vitK;
                spanTotaleB9.textContent = totali.b9.toFixed(1); progressB9.max = OBIETTIVI.b9; progressB9.value = totali.b9;
                spanTotaleB2.textContent = totali.b2.toFixed(2); progressB2.max = OBIETTIVI.b2; progressB2.value = totali.b2;
                spanTotaleB6.textContent = totali.b6.toFixed(2); progressB6.max = OBIETTIVI.b6; progressB6.value = totali.b6;
                
                let ratioText = 'N/D';
                if (totali.omega3 > 0 && totali.omega6 > 0) {
                    const ratio = totali.omega6 / totali.omega3;
                    ratioText = `${ratio.toFixed(1)}:1`;
                    if (ratio >= 3 && ratio <= 6) { omegaRatioValueEl.style.color = '#2e7d32'; } else { omegaRatioValueEl.style.color = '#d32f2f'; }
                } else { omegaRatioValueEl.style.color = '#333'; }
                omegaRatioValueEl.textContent = ratioText;

                const targetCaloriesForBalanceText = pianoDelGiorno.cal_base + (datiGiornalieri.workoutCalorie || 0);
                const calorieDifference = totali.kcal - targetCaloriesForBalanceText;
                calorieBalanceText.className = '';
                const tolerance = 50;
                if (calorieDifference < -tolerance) { calorieBalanceText.textContent = `Deficit: ${Math.abs(calorieDifference).toFixed(0)} kcal`; calorieBalanceText.classList.add('balance-deficit');
                } else if (calorieDifference > tolerance) { calorieBalanceText.textContent = `Surplus: ${calorieDifference.toFixed(0)} kcal`; calorieBalanceText.classList.add('balance-surplus');
                } else { calorieBalanceText.textContent = `In Pari`; calorieBalanceText.classList.add('balance-even'); }
                calorieAdjustmentInput.value = datiGiornalieri.calorieAdjustment || 0;
            }
            
            if(logBody) {
                logBody.innerHTML = ''; 
                const nutrientKeys = ['kcal', 'fibreTotali', 'fibreSolubili', 'fibreInsolubili', ...Object.keys(OBIETTIVI_AMINO), 'fatSat', 'fatTrans', 'fatMono', 'fatPoly', 'omega3', 'omega6', 'mg', 'k', 'vitc', 'ca', 'fe', 'zn', 'cu', 'vitA', 'vitB12', 'vitD', 'vitE', 'vitK', 'b9', 'b2', 'b6', 'p'];
                const formatNumber = (key, value) => {
                    const val = value || 0;
                    if (Object.keys(OBIETTIVI_AMINO).includes(key)) return val.toFixed(0);
                    return ['cu', 'b2', 'b6'].includes(key) ? val.toFixed(2) : (['kcal', 'k', 'p'].includes(key) ? val.toFixed(0) : val.toFixed(1));
                };
                
                const createDescriptionCellHTML = (item) => {
                    let html = '';
                    if (item.ingredienti && item.ingredienti.trim() !== '') {
                        html += `<span class="ingredient-icon" title="Visualizza ingredienti" data-food-name="${item.desc}">üìú</span>`;
                    }
                    html += (item.desc || '');
                    return html;
                };

                (datiGiornalieri.log || []).forEach((entry, index) => {
                    if (entry.type === 'meal') {
                        const rigaPasto = logBody.insertRow();
                        rigaPasto.classList.add('meal-group-row');
                        const totaliPasto = entry.items.reduce((acc, item) => {
                            for (const key in item) if(typeof item[key] === 'number' && key !== 'qta') acc[key] = (acc[key] || 0) + item[key];
                            return acc;
                        }, {});
                        
                        const qualitaPasto = calcolaQualitaProteine(totaliPasto);
                        const scoreClass = qualitaPasto.score < 70 ? 'low' : qualitaPasto.score < 90 ? 'medium' : 'high';
                        const qualitaCellHtml = `<div class="protein-score ${scoreClass}" title="Limitante: ${qualitaPasto.limiting}">${qualitaPasto.score}%</div>`;
                        
                        rigaPasto.innerHTML = `
                            <td><span class="expand-arrow" data-index="${index}">${entry.isExpanded ? '‚ñº' : '‚ñ∂'}</span> ${entry.desc}</td>
                            <td>${entry.items.reduce((sum, item) => sum + item.qta, 0).toFixed(0)}</td>
                            <td>${(totaliPasto.prot || 0).toFixed(1)}</td>
                            <td>${qualitaCellHtml}</td>
                            ${nutrientKeys.map(k => `<td>${formatNumber(k, totaliPasto[k])}</td>`).join('')}
                            <td class="action-buttons"><button class="edit-btn" data-index="${index}">‚úèÔ∏è</button><button class="delete-btn" data-index="${index}">&times;</button></td>`;

                        if (entry.isExpanded) {
                            entry.items.forEach(subItem => {
                                const rigaSubItem = logBody.insertRow();
                                rigaSubItem.classList.add('sub-item-row');
                                 const qualitaSubItem = calcolaQualitaProteine(subItem);
                                 const subScoreClass = qualitaSubItem.score < 70 ? 'low' : qualitaSubItem.score < 90 ? 'medium' : 'high';
                                 const subQualitaCellHtml = `<div class="protein-score ${subScoreClass}" title="Limitante: ${qualitaSubItem.limiting}">${qualitaSubItem.score}%</div>`;
                                rigaSubItem.innerHTML = `
                                    <td>${createDescriptionCellHTML(subItem)}</td><td>${(subItem.qta || 0).toFixed(0)}</td>
                                    <td>${(subItem.prot || 0).toFixed(1)}</td>
                                    <td>${subQualitaCellHtml}</td>
                                    ${nutrientKeys.map(k => `<td>${formatNumber(k, subItem[k])}</td>`).join('')}
                                    <td></td>`;
                            });
                        }
                    } else if (entry.type === 'workout') {
                        const riga = logBody.insertRow();
                        riga.innerHTML = `<td>${entry.desc}</td><td></td><td></td><td></td><td>${(entry.kcal || 0).toFixed(0)}</td><td colspan="${nutrientKeys.length -1}"></td><td class="action-buttons"><button class="delete-btn" data-index="${index}">&times;</button></td>`;
                    } else { 
                        const riga = logBody.insertRow();
                        const qualitaSingola = calcolaQualitaProteine(entry);
                        const scoreClass = qualitaSingola.score < 70 ? 'low' : qualitaSingola.score < 90 ? 'medium' : 'high';
                        const qualitaCellHtml = `<div class="protein-score ${scoreClass}" title="Limitante: ${qualitaSingola.limiting}">${qualitaSingola.score}%</div>`;
                        riga.innerHTML = `
                            <td>${createDescriptionCellHTML(entry)}</td><td>${(entry.qta || 0).toFixed(0)}</td>
                            <td>${(entry.prot || 0).toFixed(1)}</td>
                            <td>${qualitaCellHtml}</td>
                            ${nutrientKeys.map(k => `<td>${formatNumber(k, entry[k])}</td>`).join('')}
                            <td class="action-buttons"><button class="edit-btn" data-index="${index}">‚úèÔ∏è</button><button class="delete-btn" data-index="${index}">&times;</button></td>`;
                    }
                });
            }
        }

        function renderMealBuilder() {
            if(!mealBuilderSezione) return;
            mealBuilderSezione.style.display = pastoInCostruzione.length > 0 ? 'block' : 'none';
            logPastoBuilderBody.innerHTML = ''; 
            const selectedMealType = mealTypeSelector ? mealTypeSelector.value : MEAL_TYPE_SEQUENCE[0]; 
            const selectedMealTypeText = mealTypeSelector?.options[mealTypeSelector.selectedIndex]?.text ?? '';
            const obiettiviPasto = calcolaObiettiviPasto(selectedMealType, giornoVisualizzato);
            const totaliPastoCorrenteSelezionati = pastoInCostruzione.filter(item => item.selezionato !== false).reduce((acc, item) => {
                acc.prot += item.prot || 0; acc.kcal += (item.kcal || item.cal) || 0; return acc;
            }, { prot: 0, kcal: 0 });
            currentMealTypeDisplay.textContent = selectedMealTypeText;
            mealProtCurrent.textContent = totaliPastoCorrenteSelezionati.prot.toFixed(1);
            mealProtTarget.textContent = obiettiviPasto.targetProt.toFixed(0);
            mealProtRemaining.textContent = `${(obiettiviPasto.targetProt - totaliPastoCorrenteSelezionati.prot).toFixed(1)} g`;
            mealProgressProt.max = obiettiviPasto.targetProt;
            mealProgressProt.value = totaliPastoCorrenteSelezionati.prot;
            mealCalCurrent.textContent = totaliPastoCorrenteSelezionati.kcal.toFixed(0);
            mealCalTarget.textContent = obiettiviPasto.targetCal.toFixed(0);
            mealCalRemaining.textContent = `${(obiettiviPasto.targetCal - totaliPastoCorrenteSelezionati.kcal).toFixed(0)} kcal`;
            mealProgressCal.max = obiettiviPasto.targetCal;
            mealProgressCal.value = totaliPastoCorrenteSelezionati.kcal;
            
            const createBuilderDescriptionCellHTML = (item) => {
                let html = '';
                if (item.ingredienti && item.ingredienti.trim() !== '') {
                    html += `<span class="ingredient-icon" title="Visualizza ingredienti" data-food-name="${item.desc}">üìú</span>`;
                }
                html += item.desc;
                return html;
            };

            pastoInCostruzione.forEach((item, index) => { 
                const riga = logPastoBuilderBody.insertRow(); 
                riga.innerHTML = `<td><input type="checkbox" class="meal-item-checkbox" data-index="${index}" ${item.selezionato !== false ? 'checked' : ''}></td>
                                <td>${createBuilderDescriptionCellHTML(item)}</td>
                                <td>${item.qta}</td>
                                <td>${(item.prot || 0).toFixed(1)}</td>
                                <td>${((item.kcal || item.cal) || 0).toFixed(0)}</td>
                                <td class="action-buttons"><button class="delete-btn" data-type="builder" data-index="${index}">&times;</button></td>`; 
            });
        }

        function renderSuggestions() {
            if(!suggestionsContainer) return;
            const value = builderDesc.value.toLowerCase();
            suggestionsContainer.innerHTML = '';
            
            let keysToShow = Object.keys(foodDatabase);

            if (value.length > 0) {
                keysToShow = keysToShow.filter(key => 
                    foodDatabase[key] && foodDatabase[key].desc && foodDatabase[key].desc.toLowerCase().includes(value)
                );
            }

            const matches = keysToShow.sort((a, b) => {
                const descA = foodDatabase[a]?.desc || '';
                const descB = foodDatabase[b]?.desc || '';
                return descA.localeCompare(descB);
            });


            if (matches.length > 0) {
                matches.forEach(sanitizedKey => {
                    const originalDesc = foodDatabase[sanitizedKey].desc;
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'suggestion-item';
                    itemDiv.innerHTML = `
                        <span>${originalDesc}</span>
                        <button class="suggestion-delete-btn" data-food-key="${sanitizedKey}" title="Cancella ${originalDesc} dal database">&times;</button>
                    `;
                    suggestionsContainer.appendChild(itemDiv);
                });
                suggestionsContainer.style.display = 'block';
            } else {
                suggestionsContainer.style.display = 'none';
            }
        }
        
        function calcolaQualitaProteine(item) {
            if (!item || !item.prot || item.prot <= 0) {
                return { score: 0, limiting: 'N/D' };
            }
            let minRatio = Infinity;
            let limitingAmino = 'Nessuno';
            for (const amino in PROFILO_AMINOACIDICO_RIFERIMENTO) {
                const referenceValueMgPerG = PROFILO_AMINOACIDICO_RIFERIMENTO[amino];
                const actualValueMg = item[amino] || 0;
                const actualValueMgPerG = (actualValueMg / item.prot);
                const ratio = Math.min(1, actualValueMgPerG / referenceValueMgPerG);
                if (ratio < minRatio) {
                    minRatio = ratio;
                    limitingAmino = amino.charAt(0).toUpperCase() + amino.slice(1);
                }
            }
            return {
                score: Math.round(minRatio * 100),
                limiting: limitingAmino
            };
        }

        // ... E TUTTE LE ALTRE FUNZIONI FINO ALLA FINE DEL BLOCCO SCRIPT ...
        
        document.addEventListener('DOMContentLoaded', () => {
            // Qui inizia la logica che viene eseguita al caricamento della pagina
            initAppUI(); 
            
            // Aggiunta degli event listener specifici per la pagina corrente
            if(document.getElementById('riepilogo')) {
                // Listener per la dashboard
                dailyNotesTextarea.addEventListener('input', () => {
                    datiGiornalieri.note = dailyNotesTextarea.value;
                    salvaGiorno(giornoVisualizzato, datiGiornalieri);
                });

                calorieAdjustmentInput.addEventListener('input', () => {
                    let value = parseFloat(calorieAdjustmentInput.value);
                    if (isNaN(value)) {
                        const dataCorrente = new Date(giornoVisualizzato);
                        value = DEFICIT_PREIMPOSTATO_SETTIMANALE[dataCorrente.getDay()] || 0;
                    }
                    datiGiornalieri.calorieAdjustment = Math.max(-500, Math.min(500, value));
                    aggiornaUI();
                    salvaGiorno(giornoVisualizzato, datiGiornalieri);
                });
                btnCalorieMinus.addEventListener('click', () => {
                    datiGiornalieri.calorieAdjustment = (datiGiornalieri.calorieAdjustment || 0) - 10;
                    aggiornaUI();
                    salvaGiorno(giornoVisualizzato, datiGiornalieri);
                });
                btnCaloriePlus.addEventListener('click', () => {
                    datiGiornalieri.calorieAdjustment = (datiGiornalieri.calorieAdjustment || 0) + 10;
                    aggiornaUI();
                    salvaGiorno(giornoVisualizzato, datiGiornalieri);
                });
                
                infoVitSettimanaliBtn.addEventListener('click', openWeeklyVitaminsModal);
                infoFatsSettimanaliBtn.addEventListener('click', openWeeklyFatsModal);
            }

            if(document.getElementById('food-adder')) {
                // Listener per la pagina aggiungi
                btnAddWorkout.addEventListener('click', () => {
                    const desc = workoutDescInput.value.trim(), calories = parseFloat(workoutCaloriesInput.value);
                    if (!desc || isNaN(calories) || calories <= 0) { alert('Dati allenamento non validi.'); return; }
                    if (!datiGiornalieri.log) datiGiornalieri.log = [];
                    datiGiornalieri.log.push({ type: 'workout', desc: desc, kcal: calories });
                    datiGiornalieri.workoutCalorie = (datiGiornalieri.workoutCalorie || 0) + calories;
                    salvaGiorno(giornoVisualizzato, datiGiornalieri); 
                    workoutDescInput.value = ''; workoutCaloriesInput.value = '';
                    alert('Allenamento aggiunto!');
                });
                
                btnAggiungiSingolo.addEventListener('click', () => handleAlimentoAddition(false));
                btnCostruisciPasto.addEventListener('click', () => handleAlimentoAddition(true));
            }
            
            if(document.getElementById('log-pasti')) {
                // Listener per la pagina diario
                document.getElementById('btn-vai-a-oggi').addEventListener('click', () => {
                    caricaGiorno(getTodayString());
                });
                dataCaricamentoInput.addEventListener('change', (e) => {
                    if (e.target.value) caricaGiorno(e.target.value);
                });
            }

            // Listener comuni a tutte le pagine
            try {
                if (!getApps().some(app => app.name === "globalTrackerApp")) { firebaseApp = initializeApp(firebaseConfig, "globalTrackerApp"); } else { firebaseApp = getApp("globalTrackerApp"); }
                db = getDatabase(firebaseApp);
                auth = getAuth(firebaseApp);
                console.log("Firebase inizializzato.");

                onAuthStateChanged(auth, async (user) => {
                    const isLoggedIn = !!user;
                    currentUserUID = user?.uid;
                    authFormFields.style.display = isLoggedIn ? 'none' : 'block';
                    document.getElementById('auth-header').style.display = isLoggedIn ? 'none' : 'block';
                    welcomeMessage.style.display = isLoggedIn ? 'block' : 'none';
                    welcomeMessage.textContent = isLoggedIn ? `Benvenuto, ${user.email}!` : '';
                    btnSignOut.style.display = isLoggedIn ? 'block' : 'none';
                    authStatusP.textContent = isLoggedIn ? '' : "Non autenticato";
                    authSection.classList.toggle('logged-in', isLoggedIn);
                    mainTrackerContent.classList.toggle('authenticated', isLoggedIn);
                    if(cloudSyncStatusSpan) {
                       cloudSyncStatusSpan.textContent = `Cloud: ${isLoggedIn ? 'Connesso' : 'Disconnesso'}`;
                       cloudSyncStatusSpan.className = `cloud-sync-status ${isLoggedIn ? 'connected' : 'disconnected'}`;
                       cloudSyncSection.querySelectorAll('button').forEach(button => button.disabled = !isLoggedIn);
                    }
                    
                    if (isLoggedIn) {
                        const lastLocalUpdate = parseInt(localStorage.getItem(LOCAL_LAST_UPDATE_KEY) || 0);
                        const cloudTimestampSnapshot = await get(ref(db, `users/${currentUserUID}/${CLOUD_LAST_UPDATE_PATH}`));
                        const lastCloudUpdate = cloudTimestampSnapshot.exists() ? cloudTimestampSnapshot.val() : 0;
                        
                        if (lastCloudUpdate > lastLocalUpdate && confirm("I dati sul cloud sono pi√π recenti. Vuoi scaricarli ora?")) {
                            await loadAllTrackerDataFromCloud(true);
                        }
                    }
                });
            } catch (error) { console.error("Errore Firebase:", error); authStatusP.textContent = `Errore Firebase: ${error.message}`; }

            const authHandlers = {
                register: () => createUserWithEmailAndPassword(auth, userEmailInput.value, userPasswordInput.value),
                login: () => signInWithEmailAndPassword(auth, userEmailInput.value, userPasswordInput.value),
                signOut: () => signOut(auth)
            };
            btnRegister.addEventListener('click', async () => { try { await authHandlers.register(); alert("Registrazione completata!"); } catch (e) { alert(e.message); } });
            btnLogin.addEventListener('click', async () => { try { await authHandlers.login(); alert("Accesso effettuato!"); } catch (e) { alert(e.message); } });
            btnSignOut.addEventListener('click', async () => { try { await authHandlers.signOut(); alert("Disconnessione avvenuta."); } catch (e) { alert(e.message); } });

            // E cos√¨ via per tutti gli altri listener fino alla fine...
        });

    </script>
</body>
</html>
