<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Alimenti</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f7f9; color: #333; margin: 0; padding: 20px; }
        .container { width: 95%; max-width: 1600px; margin: 0 auto; background-color: #ffffff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1 { color: #0d47a1; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-top: 0; }
        button, .button-like { background-color: #1976d2; color: white; padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9em; font-weight: 600; transition: background-color 0.3s; text-decoration: none; display: inline-block; }
        button:hover, .button-like:hover { background-color: #1565c0; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9em; table-layout: fixed; }
        th, td { padding: 10px 8px; text-align: left; border: 1px solid #ddd; white-space: nowrap; }
        th { background-color: #e3f2fd; color: #0d47a1; position: sticky; top: 0; z-index: 10; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        .table-container { max-height: 80vh; overflow: auto; border: 1px solid #ccc; border-radius: 8px; }
        .action-buttons button { background: none; border: none; padding: 5px; font-size: 1.2em; cursor: pointer; color: #555; }
        .action-buttons button:hover { color: #0d47a1; }
        .delete-btn:hover { color: #d32f2f; }
        .action-cell, .name-cell { position: sticky; background-color: inherit; z-index: 5; }
        .action-cell { left: 0; width: 140px; text-align: center; }
        .name-cell { left: 140px; width: 200px; }
        th.action-cell, th.name-cell { z-index: 15; }
        td input[type="text"], td input[type="number"] { width: 100%; padding: 4px; box-sizing: border-box; border: 1px solid #90caf9; border-radius: 4px; font-size: 1em; }
        input[type="file"] { display: none; }
        .header-actions { display: flex; gap: 10px; margin: 15px 0; flex-wrap: wrap; align-items: center; }
        #back-link { background-color: #607d8b; }
        #btn-download-all { background-color: #2e7d32; }
        #btn-upload-all { background-color: #d84315; }
    </style>
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-book"></i> Database Alimenti</h1>
        <div class="header-actions">
            <a href="index.html" id="back-link" class="button-like">‚¨ÖÔ∏è Torna al Tracker</a>
            <button id="btn-download-all">üì• Scarica Tutto (JSON)</button>
            <button id="btn-upload-all">üì§ Carica e Sostituisci Tutto (JSON)</button>
            <input type="file" id="upload-all-input" accept=".json">
        </div>
        <div class="table-container">
            <table id="db-table">
                <thead>
                    <tr>
                        <th class="action-cell">Azioni</th>
                        <th class="name-cell">Alimento</th>
                        <th>Kcal</th><th>Prot</th><th>Carb</th><th>Zuccheri</th><th>Gr. Tot</th><th>Gr. Sat</th><th>Fibre Tot</th>
                        <th>Fibre Sol</th><th>Fibre Ins</th><th>Gr. Trans</th><th>Gr. Mono</th><th>Gr. Poly</th><th>Omega 3</th><th>Omega 6</th>
                        <th>Vit. A</th><th>Vit. B2</th><th>Vit. B6</th><th>Vit. B12</th><th>Vit. D</th><th>Vit. E</th><th>Vit. K</th><th>Folati B9</th>
                        <th>Mg</th><th>K</th><th>Vit. C</th><th>Ca</th><th>Fe</th><th>Zn</th><th>Cu</th><th>P</th>
                        <th>Leu</th><th>Iso</th><th>Val</th><th>Lys</th><th>Met</th><th>Phe</th><th>Thr</th><th>Trp</th><th>His</th>
                    </tr>
                </thead>
                <tbody id="db-table-body">
                </tbody>
            </table>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const dbTableBody = document.getElementById('db-table-body');
    const btnDownloadAll = document.getElementById('btn-download-all');
    const btnUploadAll = document.getElementById('btn-upload-all');
    const uploadAllInput = document.getElementById('upload-all-input');

    let foodDatabase = {};

    const NUTRIENT_KEYS = [
        'kcal', 'prot', 'carb', 'zuccheri', 'fatTotal', 'fatSat', 'fibreTotali',
        'fibreSolubili', 'fibreInsolubili', 'fatTrans', 'fatMono', 'fatPoly', 'omega3', 'omega6',
        'vitA', 'b2', 'b6', 'vitB12', 'vitD', 'vitE', 'vitK', 'b9',
        'mg', 'k', 'vitc', 'ca', 'fe', 'zn', 'cu', 'p',
        'leu', 'iso', 'val', 'lys', 'met', 'phe', 'thr', 'trp', 'his'
    ];
    
    function sanitizeFirebaseKey(str) {
        if (!str) return '';
        return str.replace(/[.#$/\[\]]/g, '_');
    }

    function loadDatabase() {
        foodDatabase = JSON.parse(localStorage.getItem('trackerFoodDatabase')) || {};
        renderTable();
    }

    function saveDatabase() {
        localStorage.setItem('trackerFoodDatabase', JSON.stringify(foodDatabase));
    }

    function renderTable() {
        dbTableBody.innerHTML = '';
        const sortedKeys = Object.keys(foodDatabase).sort((a, b) => foodDatabase[a].desc.localeCompare(foodDatabase[b].desc));
        
        sortedKeys.forEach(key => {
            const food = foodDatabase[key];
            const row = dbTableBody.insertRow();
            row.dataset.key = key;

            // Azioni
            row.insertCell().innerHTML = `
                <div class="action-buttons">
                    <button class="edit-btn" title="Modifica">‚úèÔ∏è</button>
                    <button class="save-btn" title="Salva" style="display:none;">üíæ</button>
                    <button class="delete-btn" title="Elimina">üóëÔ∏è</button>
                    <button class="download-btn" title="Scarica JSON">üì•</button>
                    <button class="upload-btn" title="Carica JSON">üì§</button>
                    <input type="file" class="upload-single-input" accept=".json">
                </div>
            `;
            row.cells[0].classList.add('action-cell');

            // Nome
            const nameCell = row.insertCell();
            nameCell.textContent = food.desc;
            nameCell.classList.add('name-cell');
            
            // Nutrienti
            NUTRIENT_KEYS.forEach(nutrientKey => {
                row.insertCell().textContent = food[nutrientKey] || '';
            });
        });
    }

    function toggleEditMode(row, isEditing) {
        const key = row.dataset.key;
        const food = foodDatabase[key];

        // Toggle Buttons
        row.querySelector('.edit-btn').style.display = isEditing ? 'none' : 'inline-block';
        row.querySelector('.save-btn').style.display = isEditing ? 'inline-block' : 'none';

        // Toggle Name Cell
        const nameCell = row.cells[1];
        if (isEditing) {
            const currentName = nameCell.textContent;
            nameCell.innerHTML = `<input type="text" value="${currentName}">`;
        } else {
            const newName = nameCell.querySelector('input').value;
            nameCell.innerHTML = newName;
            food.desc = newName;
        }
        
        // Toggle Nutrient Cells
        NUTRIENT_KEYS.forEach((nutrientKey, index) => {
            const cell = row.cells[index + 2]; // +2 because of Actions and Name
            if (isEditing) {
                const currentValue = cell.textContent;
                cell.innerHTML = `<input type="number" step="0.1" value="${currentValue}">`;
            } else {
                const newValue = cell.querySelector('input').value;
                cell.innerHTML = newValue;
                food[nutrientKey] = newValue ? parseFloat(newValue) : null;
            }
        });
    }

    dbTableBody.addEventListener('click', e => {
        const button = e.target.closest('button');
        if (!button) return;

        const row = button.closest('tr');
        const key = row.dataset.key;

        if (button.classList.contains('edit-btn')) {
            toggleEditMode(row, true);
        } else if (button.classList.contains('save-btn')) {
            toggleEditMode(row, false);
            // Check if food description (and thus key) has changed
            const newName = foodDatabase[key].desc;
            const newKey = sanitizeFirebaseKey(newName.toLowerCase());
            if (newKey !== key) {
                const oldData = foodDatabase[key];
                delete foodDatabase[key];
                foodDatabase[newKey] = oldData;
            }
            saveDatabase();
            // Re-render to sort correctly
            renderTable();
        } else if (button.classList.contains('delete-btn')) {
            if (confirm(`Sei sicuro di voler eliminare "${foodDatabase[key].desc}"?`)) {
                delete foodDatabase[key];
                saveDatabase();
                row.remove();
            }
        } else if (button.classList.contains('download-btn')) {
            const data = JSON.stringify(foodDatabase[key], null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${key}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        } else if (button.classList.contains('upload-btn')) {
            row.querySelector('.upload-single-input').click();
        }
    });

    dbTableBody.addEventListener('change', e => {
        if (e.target.classList.contains('upload-single-input')) {
            const file = e.target.files[0];
            if (!file) return;

            const row = e.target.closest('tr');
            const key = row.dataset.key;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const newData = JSON.parse(event.target.result);
                    // Basic validation
                    if (typeof newData.desc !== 'string') throw new Error("JSON non valido: manca 'desc'.");
                    
                    foodDatabase[key] = newData;
                    saveDatabase();
                    renderTable(); // Re-render to show new data
                    alert(`Dati per "${newData.desc}" aggiornati con successo.`);
                } catch (err) {
                    alert(`Errore nel caricamento del file JSON: ${err.message}`);
                }
            };
            reader.readAsText(file);
        }
    });
    
    // Global Actions
    btnDownloadAll.addEventListener('click', () => {
        if (Object.keys(foodDatabase).length === 0) {
            alert("Il database √® vuoto.");
            return;
        }
        const data = JSON.stringify(foodDatabase, null, 2);
        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'foodDatabase_backup.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    });

    btnUploadAll.addEventListener('click', () => {
        uploadAllInput.click();
    });

    uploadAllInput.addEventListener('change', e => {
        const file = e.target.files[0];
        if (!file) return;

        if (!confirm("ATTENZIONE: questo sostituir√† l'intero database di alimenti. Sei sicuro di voler continuare?")) {
            e.target.value = ''; // Reset input
            return;
        }
        
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const newData = JSON.parse(event.target.result);
                // Basic validation
                if (typeof newData !== 'object' || newData === null || Array.isArray(newData)) {
                     throw new Error("Il file JSON deve contenere un oggetto.");
                }
                foodDatabase = newData;
                saveDatabase();
                loadDatabase(); // Reload and re-render
                alert("Database importato con successo!");
            } catch (err) {
                alert(`Errore nell'importazione del database: ${err.message}`);
            } finally {
                e.target.value = ''; // Reset input
            }
        };
        reader.readAsText(file);
    });

    // Initial Load
    loadDatabase();
});
</script>

</body>
</html>