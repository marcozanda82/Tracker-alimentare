<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tracker Nutrizionale v8 (Offline First)</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0d47a1">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-functions-compat.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f7f9; color: #333; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 800px; background-color: #ffffff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1, h2, h3 { color: #0d47a1; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-top: 0; }
        h2 { font-size: 1.4em; margin-top: 30px; }
        
        /* Debug Bar */
        #error-bar { display: none; background-color: #d32f2f; color: white; padding: 10px; border-radius: 6px; margin-bottom: 20px; text-align: center; }

        /* Header e Navigazione */
        #titolo-giornata { text-align: center; color: #d84315; font-weight: 600; margin-bottom: 20px; padding: 10px; background-color: #fff3e0; border-radius: 8px; border: 1px solid #ffe0b2;}
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .nav-links a, #btn-toggle-auth { padding: 8px 15px; background-color: #607d8b; color: white; text-decoration: none; border-radius: 6px; font-weight: 600; font-size: 0.9em; border: none; cursor: pointer;}
        #btn-export-json-ai { background-color: #673ab7; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: bold;}

        /* Sezioni Generiche */
        .sezione { margin-bottom: 25px; padding: 20px; background-color: #fafafa; border: 1px solid #e0e0e0; border-radius: 8px; border-left-width: 5px; border-left-color: #1976d2;}
        label { display: block; margin-bottom: 5px; font-weight: 600; color: #555; font-size: 0.9em; }
        input[type="text"], input[type="number"], input[type="date"], select, textarea {
            width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 1em;
        }
        button { background-color: #1976d2; color: white; padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 1em; font-weight: 600; transition: background-color 0.3s; }
        button:hover { background-color: #1565c0; }
        
        /* Auth Nascosta */
        #auth-panel { display: none; margin-bottom: 20px; background-color: #e3f2fd; padding: 15px; border-radius: 8px; border: 1px solid #90caf9; }
        #auth-panel.visible { display: block; }
        #user-status { font-size: 0.9em; margin-right: 10px; color: #555; }

        /* Progress Bars */
        progress { width: 100%; height: 20px; border-radius: 6px; margin-top: 2px; cursor: pointer; }
        .progress-container { display: flex; gap: 10px; align-items: center; }
        
        /* Tabelle */
        table { border-collapse: collapse; margin-top: 15px; font-size: 0.9em; width: 100%; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; vertical-align: middle; }
        th { background-color: #f2f2f2; font-weight: 600; }
        
        /* Builder & Grids */
        .builder-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 10px; }
        .button-group { display: flex; gap: 10px; margin-top: 15px; }
        #btn-costruisci-pasto { background-color: #ff8f00; }
        #btn-aggiungi-singolo { background-color: #5c6bc0; }
        #meal-builder-sezione { border-left-color: #ff8f00; display: none; }
        #meal-builder-sezione.visible { display: block; }
        
        /* Suggerimenti */
        #custom-suggestions, #workout-suggestions { display: none; position: absolute; background-color: #fff; border: 1px solid #ccc; width: 100%; z-index: 100; max-height: 200px; overflow-y: auto; box-shadow: 0 4px 8px rgba(0,0,0,0.1); border-radius: 0 0 6px 6px; top: 100%; left: 0; }
        .suggestion-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
        .suggestion-item:hover { background-color: #e3f2fd; }

        /* Bilancia Sodio/Potassio */
        .balance-container { display: flex; position: relative; height: 30px; border-radius: 15px; overflow: hidden; border: 1px solid #ccc; margin-top: 5px; }
        .balance-bar-left { width: 50%; background: linear-gradient(to right, #ef5350, #ffcc80); }
        .balance-bar-right { width: 50%; background: linear-gradient(to right, #a5d6a7, #66bb6a); }
        .balance-marker { position: absolute; top: 0; bottom: 0; width: 4px; background: #333; left: 50%; transition: left 0.5s ease; z-index: 2; transform: translateX(-50%); }
        .balance-labels { display: flex; justify-content: space-between; font-size: 0.85em; font-weight: bold; color: #555; margin-top: 2px; }

        /* Collapsible */
        .collapsible-header { cursor: pointer; display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; }
        .collapsible-content { display: none; }
        .collapsible-content.expanded { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Azioni Tabella */
        .delete-btn { background: none; color: #d32f2f; border: none; font-size: 1.2em; cursor: pointer; }
        .edit-btn { background: none; color: #1976d2; border: none; font-size: 1.2em; cursor: pointer; margin-right: 5px; }
        
        /* Modali */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fff; margin: 10% auto; padding: 20px; border-radius: 8px; width: 90%; max-width: 600px; position: relative; }
        .modal-close { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #aaa; }
        .diary-table-wrapper { overflow-x: auto; }
        
        /* Stili Nutrienti mancanti */
        .nutrients-warning h3 { color: #d32f2f; }
    </style>
</head>
<body>
    <div class="container">
        <div id="error-bar"></div>

        <div class="top-bar">
            <div class="nav-links">
                <a href="storico.html">üìä Storico</a>
                <button id="btn-toggle-auth">‚òÅÔ∏è Cloud</button>
            </div>
            <button id="btn-export-json-ai">üß† Analisi AI</button>
        </div>

        <div id="auth-panel">
            <h3>Sincronizzazione Cloud (Opzionale)</h3>
            <p id="user-status">Stato: Offline (Salvataggio locale attivo)</p>
            <div id="auth-inputs">
                <input type="email" id="auth-email" placeholder="Email" style="margin-bottom: 10px;">
                <input type="password" id="auth-pass" placeholder="Password">
                <div class="button-group">
                    <button id="btn-login">Accedi</button>
                    <button id="btn-register">Registrati</button>
                </div>
            </div>
            <button id="btn-logout" style="display:none; background-color: #757575;">Disconnetti</button>
            <div style="margin-top:10px;">
                <button id="btn-force-download" style="background-color: #e64a19;" disabled>‚¨áÔ∏è Scarica da Cloud</button>
                <button id="btn-force-upload" style="background-color: #388e3c;" disabled>‚¨ÜÔ∏è Carica su Cloud</button>
            </div>
        </div>

        <h2 id="titolo-giornata">Caricamento...</h2>

        <div id="calorie-adjuster" style="text-align: center; margin-bottom: 20px; padding: 10px; background: #fff3e0; border-radius: 8px;">
            <label style="display:inline;">Bilancio/Deficit Target:</label>
            <button id="cal-minus" style="padding: 5px 10px;">-</button>
            <span id="cal-adj-display" style="font-weight: bold; margin: 0 10px;">0</span>
            <button id="cal-plus" style="padding: 5px 10px;">+</button> kcal
        </div>

        <div id="riepilogo" class="sezione">
            <h2>Riepilogo Oggi</h2>
            <p>Proteine: <span id="val-prot">0</span> / <span id="target-prot">0</span> g</p>
            <progress id="prog-prot" value="0" max="100"></progress>
            
            <p>Calorie: <span id="val-cal">0</span> / <span id="target-cal">0</span> kcal</p>
            <progress id="prog-cal" value="0" max="100"></progress>
            
            <p style="font-size: 0.9em; color: #666; margin-top: 5px;">
                Workout: <span id="val-workout">0</span> kcal | Sodio: <span id="val-sodio-num" style="color:#d32f2f">0</span> mg
            </p>

            <div style="margin-top: 15px; padding: 10px; background: #f1f8e9; border-radius: 8px;">
                <div class="balance-labels">
                    <span style="color:#d32f2f">SODIO (Na)</span>
                    <span style="color:#388e3c">POTASSIO (K)</span>
                </div>
                <div class="balance-container">
                    <div class="balance-bar-left"></div>
                    <div class="balance-bar-right"></div>
                    <div id="balance-marker" class="balance-marker"></div>
                </div>
                <p style="text-align: center; font-size: 0.8em; color: #555; margin-top: 5px;">Cursore a destra = Drenante</p>
            </div>
        </div>

        <div class="sezione">
            <h3 class="collapsible-header" onclick="toggleSection('workout-content')">
                Registra Allenamento <span class="arrow">‚ñ∂</span>
            </h3>
            <div id="workout-content" class="collapsible-content">
                <div style="position: relative;">
                    <label>Tipo Attivit√†</label>
                    <input type="text" id="work-desc" placeholder="Es. Corsa, Pesi..." autocomplete="off">
                    <div id="workout-suggestions"></div>
                </div>
                <label>Calorie Bruciate</label>
                <input type="number" id="work-cal" placeholder="0">
                <div class="button-group">
                    <button id="btn-add-workout">Aggiungi</button>
                    <button id="btn-clear-workouts" style="background:#757575; font-size: 0.8em;">‚öôÔ∏è Reset Memoria</button>
                </div>
            </div>
        </div>

        <div class="sezione">
            <h3>Aggiungi Alimento</h3>
            <div class="builder-grid">
                <div style="position: relative; grid-column: span 2;">
                    <label>Nome Alimento</label>
                    <input type="text" id="food-desc" placeholder="Cerca o inserisci..." autocomplete="off">
                    <div id="custom-suggestions"></div>
                </div>
                <div><label>Grammi</label><input type="number" id="food-qta" placeholder="100"></div>
                
                <div><label>Prot (g)</label><input type="number" class="nut-input" id="n-prot"></div>
                <div><label>Kcal</label><input type="number" class="nut-input" id="n-kcal"></div>
                <div><label>Carbo (g)</label><input type="number" class="nut-input" id="n-carb"></div>
                <div><label>Zuccheri</label><input type="number" class="nut-input" id="n-zuccheri"></div>
                <div><label>Grassi (g)</label><input type="number" class="nut-input" id="n-fat"></div>
                <div><label>Saturi</label><input type="number" class="nut-input" id="n-fatsat"></div>
                
                <div><label style="color:#d32f2f">Sodio (mg)</label><input type="number" class="nut-input" id="n-na"></div>
                <div><label>Fibre (g)</label><input type="number" class="nut-input" id="n-fibre"></div>
                <div><label>Potassio</label><input type="number" class="nut-input" id="n-k"></div>
            </div>

            <div id="extra-nutrients" style="display:none; margin-top: 15px; padding-top:10px; border-top:1px dashed #ccc;">
                <div class="builder-grid">
                    <input type="number" class="nut-input" id="n-mg" placeholder="Magnesio">
                    <input type="number" class="nut-input" id="n-ca" placeholder="Calcio">
                    <input type="number" class="nut-input" id="n-fe" placeholder="Ferro">
                    <input type="number" class="nut-input" id="n-vitc" placeholder="Vit C">
                    <input type="number" class="nut-input" id="n-omega3" placeholder="Omega 3">
                </div>
            </div>
            <button onclick="document.getElementById('extra-nutrients').style.display = 'block'" style="background:none; color:#1976d2; border:none; cursor:pointer; width:100%; margin-bottom:10px;">Mostra altri nutrienti...</button>

            <div class="button-group">
                <button id="btn-add-meal-item" style="background-color: #ff8f00;">Aggiungi al Pasto</button>
                <button id="btn-add-log-item" style="background-color: #5c6bc0;">Aggiungi Diretto</button>
                <button id="btn-ai-fill" style="background-color: #673ab7;">‚ú® Compila AI</button>
            </div>
        </div>

        <div id="meal-builder-sezione" class="sezione">
            <h3>Costruttore Pasto</h3>
            <div style="background: #e3f2fd; padding: 10px; border-radius: 6px; margin-bottom: 10px;">
                <label>Pasto:</label>
                <select id="meal-select">
                    <option value="merenda1">Merenda Mattina</option>
                    <option value="pranzo" selected>Pranzo</option>
                    <option value="merenda2">Merenda Pomeriggio</option>
                    <option value="cena">Cena</option>
                </select>
                <p>Totale Provvisorio: <b id="mb-prot">0</b> g Prot | <b id="mb-kcal">0</b> Kcal</p>
            </div>
            <table id="mb-table">
                <thead><tr><th>Cibo</th><th>g</th><th>Prot</th><th>Kcal</th><th>X</th></tr></thead>
                <tbody id="mb-body"></tbody>
            </table>
            <button id="btn-save-meal" style="width:100%; margin-top:10px; background-color:#2e7d32">Registra Pasto Completo</button>
        </div>

        <div class="sezione">
            <h3>Diario Giornaliero</h3>
            <div class="diary-table-wrapper">
                <table id="log-table">
                    <thead><tr><th>Descrizione</th><th>g</th><th>Prot</th><th>Kcal</th><th>Sodio</th><th>Azioni</th></tr></thead>
                    <tbody id="log-table-body"></tbody>
                </table>
            </div>
            <textarea id="daily-notes" placeholder="Note giornaliere..." style="margin-top:15px; height: 60px;"></textarea>
        </div>

    </div>

    <script>
        // --- 1. CONFIGURAZIONE & VARIABILI GLOBALI ---
        const CONFIG = {
            firebase: {
                apiKey: "AIzaSyA5pSzpfq1aGZ1wjNV5-eXnIqWL6brl424",
                authDomain: "mio-tracker.firebaseapp.com",
                databaseURL: "https://mio-tracker-default-rtdb.europe-west1.firebasedatabase.app",
                projectId: "mio-tracker",
                appId: "1:382993217593:web:f0780aa061c23f9503f5e8"
            },
            piano: {
                0: { tipo: 'Domenica', cal: 2300, prot: 140 },
                1: { tipo: 'Luned√¨', cal: 2300, prot: 140 },
                2: { tipo: 'Marted√¨', cal: 2300, prot: 140 },
                3: { tipo: 'Mercoled√¨', cal: 2300, prot: 140 },
                4: { tipo: 'Gioved√¨', cal: 2300, prot: 140 },
                5: { tipo: 'Venerd√¨', cal: 2300, prot: 140 },
                6: { tipo: 'Sabato', cal: 2300, prot: 140 }
            }
        };

        let state = {
            date: new Date().toISOString().split('T')[0],
            data: { log: [], workoutKcal: 0, calorieAdj: 0, notes: '' },
            foodDb: {},
            workoutDb: {},
            mealBuilder: [],
            user: null
        };

        // --- 2. INIZIALIZZAZIONE ---
        window.onerror = function(msg, url, line) {
            document.getElementById('error-bar').style.display = 'block';
            document.getElementById('error-bar').textContent = `Errore: ${msg} (Riga ${line})`;
        };

        function init() {
            try {
                // Carica DB locali
                state.foodDb = JSON.parse(localStorage.getItem('db_food') || '{}');
                state.workoutDb = JSON.parse(localStorage.getItem('db_workout') || '{}');
                state.mealBuilder = JSON.parse(localStorage.getItem('temp_meal') || '[]');
                
                // Carica Giorno Corrente
                loadDay(state.date);

                // Init Firebase (Silenzioso)
                if (window.firebase) {
                    firebase.initializeApp(CONFIG.firebase);
                    firebase.auth().onAuthStateChanged(u => {
                        state.user = u;
                        updateAuthUI();
                    });
                }
                
                renderAll();
            } catch (e) {
                alert("Errore critico avvio: " + e.message);
            }
        }

        // --- 3. LOGICA CORE (CRUD) ---
        function loadDay(dateStr) {
            state.date = dateStr;
            const saved = localStorage.getItem(`log_${dateStr}`);
            if (saved) {
                state.data = JSON.parse(saved);
                // Fix legacy data
                if (!state.data.log) state.data.log = [];
            } else {
                // Preset deficit
                const dayIdx = new Date(dateStr).getDay();
                const presets = {0:-250, 1:300, 2:300, 3:-250, 4:300, 5:300, 6:-250};
                state.data = { log: [], workoutKcal: 0, calorieAdj: presets[dayIdx] || 0, notes: '' };
            }
            renderAll();
        }

        function saveData() {
            localStorage.setItem(`log_${state.date}`, JSON.stringify(state.data));
            localStorage.setItem('db_food', JSON.stringify(state.foodDb));
            localStorage.setItem('db_workout', JSON.stringify(state.workoutDb));
            localStorage.setItem('temp_meal', JSON.stringify(state.mealBuilder));
            // Sync Cloud se loggato
            if (state.user) syncToCloud();
        }

        function addLogItem(item) {
            state.data.log.push(item);
            if (item.type === 'workout') state.data.workoutKcal += item.kcal;
            saveData();
            renderAll();
        }

        function removeLogItem(idx) {
            const item = state.data.log[idx];
            if (item.type === 'workout') state.data.workoutKcal -= item.kcal;
            state.data.log.splice(idx, 1);
            saveData();
            renderAll();
        }

        // --- 4. RENDER UI ---
        function renderAll() {
            renderHeader();
            renderSummary();
            renderLog();
            renderBuilder();
            updateCalorieAdj();
        }

        function renderHeader() {
            const dateObj = new Date(state.date);
            const dayIdx = dateObj.getDay();
            const baseTitle = CONFIG.piano[dayIdx].tipo;
            
            // Titolo Dinamico
            const workouts = state.data.log.filter(i => i.type === 'workout').map(i => i.desc).join(", ");
            const finalTitle = workouts ? `${baseTitle} - ${workouts}` : baseTitle;
            
            document.getElementById('titolo-giornata').textContent = `${finalTitle} (${dateObj.toLocaleDateString('it-IT')})`;
            document.getElementById('daily-notes').value = state.data.notes || '';
        }

        function renderSummary() {
            const dayIdx = new Date(state.date).getDay();
            const targetProt = CONFIG.piano[dayIdx].prot;
            const targetCal = CONFIG.piano[dayIdx].cal + state.data.workoutKcal + (state.data.calorieAdj || 0);

            let tot = { prot: 0, kcal: 0, na: 0, k: 0 };
            
            state.data.log.forEach(item => {
                if (item.type === 'food') {
                    tot.prot += item.prot || 0;
                    tot.kcal += item.kcal || 0;
                    tot.na += item.na || 0;
                    tot.k += item.k || 0;
                }
            });

            document.getElementById('val-prot').textContent = tot.prot.toFixed(1);
            document.getElementById('target-prot').textContent = targetProt;
            document.getElementById('prog-prot').value = (tot.prot / targetProt) * 100;

            document.getElementById('val-cal').textContent = tot.kcal.toFixed(0);
            document.getElementById('target-cal').textContent = targetCal;
            document.getElementById('prog-cal').value = (tot.kcal / targetCal) * 100;

            document.getElementById('val-workout').textContent = state.data.workoutKcal;
            document.getElementById('val-sodio-num').textContent = tot.na.toFixed(0);

            // Bilancia Idrica
            const na = tot.na;
            const k = tot.k;
            let percent = 50;
            if (na + k > 0) percent = (k / (na + k)) * 100;
            percent = Math.max(5, Math.min(95, percent));
            document.getElementById('balance-marker').style.left = percent + '%';
        }

        function renderLog() {
            const tbody = document.getElementById('log-table-body');
            tbody.innerHTML = '';
            state.data.log.forEach((item, idx) => {
                const tr = document.createElement('tr');
                if (item.type === 'workout') {
                    tr.style.background = '#e8f5e9';
                    tr.innerHTML = `<td>üèÉ ${item.desc}</td><td>-</td><td>-</td><td>${item.kcal}</td><td>-</td><td><button class="delete-btn" onclick="removeLogItem(${idx})">&times;</button></td>`;
                } else {
                    tr.innerHTML = `<td>${item.desc}</td><td>${item.qta}</td><td>${item.prot}</td><td>${item.kcal}</td><td>${item.na || 0}</td><td><button class="delete-btn" onclick="removeLogItem(${idx})">&times;</button></td>`;
                }
                tbody.appendChild(tr);
            });
        }

        function renderBuilder() {
            const div = document.getElementById('meal-builder-sezione');
            const tbody = document.getElementById('mb-body');
            
            if (state.mealBuilder.length > 0) {
                div.classList.add('visible');
                tbody.innerHTML = '';
                let totP = 0, totK = 0;
                state.mealBuilder.forEach((item, idx) => {
                    totP += item.prot; totK += item.kcal;
                    tbody.innerHTML += `<tr><td>${item.desc}</td><td>${item.qta}</td><td>${item.prot}</td><td>${item.kcal}</td><td><button class="delete-btn" onclick="removeFromBuilder(${idx})">&times;</button></td></tr>`;
                });
                document.getElementById('mb-prot').textContent = totP.toFixed(1);
                document.getElementById('mb-kcal').textContent = totK.toFixed(0);
            } else {
                div.classList.remove('visible');
            }
        }

        function updateCalorieAdj() {
            document.getElementById('cal-adj-display').textContent = state.data.calorieAdj;
        }

        // --- 5. GESTIONE INPUT & SUGGERIMENTI ---
        
        // Suggerimenti Cibo
        const foodInp = document.getElementById('food-desc');
        const foodSugg = document.getElementById('custom-suggestions');
        
        foodInp.addEventListener('input', () => {
            const txt = foodInp.value.toLowerCase();
            foodSugg.innerHTML = '';
            if (txt.length < 2) { foodSugg.style.display = 'none'; return; }
            
            const matches = Object.keys(state.foodDb).filter(k => k.includes(txt)).sort();
            if (matches.length) {
                foodSugg.style.display = 'block';
                matches.forEach(key => {
                    const food = state.foodDb[key];
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    div.textContent = food.desc;
                    div.onclick = () => loadFoodToForm(food);
                    foodSugg.appendChild(div);
                });
            } else { foodSugg.style.display = 'none'; }
        });

        function loadFoodToForm(food) {
            foodInp.value = food.desc;
            document.getElementById('food-qta').value = food.lastQta || 100;
            // Popola i campi nutrienti salvati
            const map = {prot:'n-prot', kcal:'n-kcal', carb:'n-carb', zuccheri:'n-zuccheri', fat:'n-fat', fatsat:'n-fatsat', na:'n-na', k:'n-k'};
            for (let k in map) {
                if (food[k]) document.getElementById(map[k]).value = food[k];
            }
            foodSugg.style.display = 'none';
        }

        // Suggerimenti Workout
        const workInp = document.getElementById('work-desc');
        const workSugg = document.getElementById('workout-suggestions');
        
        workInp.addEventListener('input', () => {
            const txt = workInp.value.toLowerCase();
            workSugg.innerHTML = '';
            if (txt.length < 2) { workSugg.style.display = 'none'; return; }
            
            const matches = Object.keys(state.workoutDb).filter(k => k.includes(txt));
            if (matches.length) {
                workSugg.style.display = 'block';
                matches.forEach(key => {
                    const w = state.workoutDb[key];
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    div.innerHTML = `${w.desc} <small>(${w.kcal} kcal)</small>`;
                    div.onclick = () => {
                        workInp.value = w.desc;
                        document.getElementById('work-cal').value = w.kcal;
                        workSugg.style.display = 'none';
                    };
                    workSugg.appendChild(div);
                });
            } else { workSugg.style.display = 'none'; }
        });

        // --- 6. AZIONI PULSANTI ---

        // Aggiungi Cibo
        function getFoodFromForm() {
            const desc = document.getElementById('food-desc').value.trim();
            const qta = parseFloat(document.getElementById('food-qta').value);
            if (!desc || isNaN(qta)) return null;

            const factor = qta / 100;
            const getVal = (id) => parseFloat(document.getElementById(id).value) || 0;

            // Salva nel DB (valori su 100g)
            const dbEntry = {
                desc: desc,
                lastQta: qta,
                prot: getVal('n-prot'), kcal: getVal('n-kcal'), carb: getVal('n-carb'),
                zuccheri: getVal('n-zuccheri'), fat: getVal('n-fat'), fatsat: getVal('n-fatsat'),
                na: getVal('n-na'), k: getVal('n-k')
            };
            state.foodDb[desc.toLowerCase()] = dbEntry;

            // Crea oggetto log (valori calcolati)
            return {
                type: 'food', desc: desc, qta: qta,
                prot: Number((dbEntry.prot * factor).toFixed(1)),
                kcal: Number((dbEntry.kcal * factor).toFixed(0)),
                na: Number((dbEntry.na * factor).toFixed(0)),
                k: Number((dbEntry.k * factor).toFixed(0))
            };
        }

        document.getElementById('btn-add-log-item').onclick = () => {
            const item = getFoodFromForm();
            if (item) { addLogItem(item); clearForm(); }
        };

        document.getElementById('btn-add-meal-item').onclick = () => {
            const item = getFoodFromForm();
            if (item) { 
                state.mealBuilder.push(item);
                saveData();
                renderAll();
                clearForm();
            }
        };

        function clearForm() {
            document.getElementById('food-desc').value = '';
            document.getElementById('food-qta').value = '';
            document.querySelectorAll('.nut-input').forEach(i => i.value = '');
        }

        // Gestione Builder
        window.removeFromBuilder = (idx) => {
            state.mealBuilder.splice(idx, 1);
            saveData();
            renderAll();
        };

        document.getElementById('btn-save-meal').onclick = () => {
            const nomePasto = document.getElementById('meal-select').options[document.getElementById('meal-select').selectedIndex].text;
            let totP = 0, totK = 0, totNa = 0;
            state.mealBuilder.forEach(i => { totP += i.prot; totK += i.kcal; totNa += i.na || 0; });
            
            // Aggiungi come blocco unico o espanso? Per ora singoli items per semplicit√† di logica
            state.mealBuilder.forEach(item => {
                item.desc = `[${nomePasto}] ${item.desc}`;
                state.data.log.push(item);
            });
            state.mealBuilder = [];
            saveData();
            renderAll();
        };

        // Aggiungi Workout
        document.getElementById('btn-add-workout').onclick = () => {
            const desc = document.getElementById('work-desc').value.trim();
            const kcal = parseFloat(document.getElementById('work-cal').value);
            if (!desc || isNaN(kcal)) return;

            // Salva in DB intelligente
            state.workoutDb[desc.toLowerCase()] = { desc, kcal };
            
            addLogItem({ type: 'workout', desc, kcal });
            document.getElementById('work-desc').value = '';
            document.getElementById('work-cal').value = '';
        };

        document.getElementById('btn-clear-workouts').onclick = () => {
            if(confirm("Cancellare memoria allenamenti?")) {
                state.workoutDb = {};
                saveData();
            }
        };

        // Note e Calorie Adjust
        document.getElementById('daily-notes').addEventListener('change', (e) => {
            state.data.notes = e.target.value;
            saveData();
        });
        document.getElementById('cal-plus').onclick = () => { state.data.calorieAdj += 50; saveData(); renderAll(); };
        document.getElementById('cal-minus').onclick = () => { state.data.calorieAdj -= 50; saveData(); renderAll(); };

        // --- 7. AI COMPILATION (Simulata/Firebase) ---
        document.getElementById('btn-ai-fill').onclick = async () => {
            const name = document.getElementById('food-desc').value;
            if (!name) return alert("Inserisci un nome");
            
            const btn = document.getElementById('btn-ai-fill');
            btn.textContent = "‚è≥...";
            btn.disabled = true;

            const prompt = `Dammi valori nutrizionali per 100g di "${name}" in JSON puro: {"prot":number,"kcal":number,"carb":number,"zuccheri":number,"fat":number,"fatsat":number,"na":number,"k":number}. Stima il sodio (na) in mg.`;

            try {
                const callAi = firebase.functions().httpsCallable('callOpenAI');
                const res = await callAi({ prompt });
                const json = JSON.parse(res.data.candidates[0].content.parts[0].text.replace(/```json|```/g, ''));
                
                document.getElementById('n-prot').value = json.prot;
                document.getElementById('n-kcal').value = json.kcal;
                document.getElementById('n-carb').value = json.carb;
                document.getElementById('n-zuccheri').value = json.zuccheri;
                document.getElementById('n-fat').value = json.fat;
                document.getElementById('n-fatsat').value = json.fatsat;
                document.getElementById('n-na').value = json.na; // Sodio!
                document.getElementById('n-k').value = json.k; // Potassio!
                
            } catch (e) {
                console.error(e);
                alert("Errore AI o Configurazione Firebase mancante.");
            } finally {
                btn.textContent = "‚ú® Compila AI";
                btn.disabled = false;
            }
        };

        // --- 8. EXPORT PER AI ANALISI ---
        document.getElementById('btn-export-json-ai').onclick = () => {
            const exportData = {
                data: state.date,
                totali: {
                    prot: document.getElementById('val-prot').textContent,
                    kcal: document.getElementById('val-cal').textContent,
                    sodio: document.getElementById('val-sodio-num').textContent
                },
                log: state.data.log
            };
            navigator.clipboard.writeText(JSON.stringify(exportData, null, 2));
            alert("Dati copiati! Incolla su ChatGPT per l'analisi.");
        };

        // --- 9. UI HELPERS ---
        window.toggleSection = (id) => {
            document.getElementById(id).classList.toggle('expanded');
        };

        document.getElementById('btn-toggle-auth').onclick = () => {
            const p = document.getElementById('auth-panel');
            p.classList.toggle('visible');
        };

        // Auth Logic Semplificata
        function updateAuthUI() {
            const btnDown = document.getElementById('btn-force-download');
            const btnUp = document.getElementById('btn-force-upload');
            const btnLog = document.getElementById('btn-login');
            const btnOut = document.getElementById('btn-logout');
            
            if (state.user) {
                document.getElementById('user-status').textContent = `Online: ${state.user.email}`;
                btnDown.disabled = false;
                btnUp.disabled = false;
                btnLog.style.display = 'none';
                btnOut.style.display = 'inline-block';
            } else {
                document.getElementById('user-status').textContent = "Offline";
                btnDown.disabled = true;
                btnUp.disabled = true;
                btnLog.style.display = 'inline-block';
                btnOut.style.display = 'none';
            }
        }

        // Firebase Auth Handlers
        document.getElementById('btn-login').onclick = () => {
            const e = document.getElementById('auth-email').value;
            const p = document.getElementById('auth-pass').value;
            firebase.auth().signInWithEmailAndPassword(e, p).catch(err => alert(err.message));
        };
        document.getElementById('btn-register').onclick = () => {
            const e = document.getElementById('auth-email').value;
            const p = document.getElementById('auth-pass').value;
            firebase.auth().createUserWithEmailAndPassword(e, p).catch(err => alert(err.message));
        };
        document.getElementById('btn-logout').onclick = () => firebase.auth().signOut();

        // Cloud Sync Manuale
        async function syncToCloud() {
            if (!state.user) return;
            const ref = firebase.database().ref(`users/${state.user.uid}/full_backup`);
            await ref.set({
                foodDb: state.foodDb,
                workoutDb: state.workoutDb,
                currentLog: state.data
            });
            alert("Salvataggio Cloud OK");
        }
        
        document.getElementById('btn-force-upload').onclick = syncToCloud;
        
        document.getElementById('btn-force-download').onclick = async () => {
            if (!state.user) return;
            const snap = await firebase.database().ref(`users/${state.user.uid}/full_backup`).once('value');
            if (snap.exists()) {
                const val = snap.val();
                state.foodDb = val.foodDb || {};
                state.workoutDb = val.workoutDb || {};
                // Merge intelligente o sovrascrittura? Per sicurezza sovrascrittura log odierno
                if (val.currentLog) state.data = val.currentLog;
                saveData();
                renderAll();
                alert("Dati scaricati.");
            }
        };

        // AVVIO
        init();
    </script>
</body>
</html>
