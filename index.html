<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tracker Nutrizionale Definitivo v6</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0d47a1">
    <link rel="apple-touch-icon" href="icon-192.png">
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f7f9; color: #333; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 800px; background-color: #ffffff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1, h2, h3 { color: #0d47a1; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-top: 0; }
        h2 { font-size: 1.4em; margin-top: 30px; }
        h3 { font-size: 1.1em; color: #333; border-bottom: 1px solid #eee; margin-top: 20px; }
        h4 { font-size: 1em; color: #1565c0; margin-top: 20px; margin-bottom: 10px; font-weight: 600; }
        #titolo-giornata { text-align: center; color: #d84315; font-weight: 600; margin-bottom: 20px; padding: 10px; background-color: #fff3e0; border-radius: 8px; border: 1px solid #ffe0b2;}
        .sezione { margin-bottom: 25px; padding: 20px; background-color: #fafafa; border: 1px solid #e0e0e0; border-radius: 8px; border-left-width: 5px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        input[type="text"], input[type="number"], input[type="date"], select, input[type="email"], input[type="password"], textarea {
            width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 1em;
        }
        button { background-color: #1976d2; color: white; padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 1em; font-weight: 600; transition: background-color 0.3s; }
        button:hover { background-color: #1565c0; }
        #form-allenamento button { background-color: #2e7d32; }
        .nav-links { display: flex; gap: 10px; margin-bottom: 20px; }
        .nav-links a { flex-grow: 1; text-align: center; padding: 10px; background-color: #607d8b; color: white; text-decoration: none; border-radius: 6px; font-weight: 600; }
        .sync-button-container { text-align: center; margin-top: 20px; }
        .sync-button { display: inline-block; background-color: #ff8f00; color: white; padding: 10px 15px; text-decoration: none; border-radius: 6px; font-weight: 600; font-size: 0.9em; }
        #riepilogo p { font-size: 1.1em; margin: 8px 0; }
        progress { width: 100%; height: 15px; border-radius: 6px; margin-top: 2px; cursor: pointer; }
        progress.macro-progress { height: 25px; }
        table { border-collapse: collapse; margin-top: 15px; font-size: 0.9em; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; vertical-align: middle; }
        th { background-color: #f2f2f2; font-weight: 600; }
        .builder-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; }
        .button-group { display: flex; gap: 10px; margin-top: 15px; }
        #btn-costruisci-pasto { background-color: #ff8f00; }
        #btn-aggiungi-singolo { background-color: #5c6bc0; }
        #meal-builder-sezione[data-visible="false"] { display: none; }
        #meal-builder-sezione[data-visible="true"] { display: block; }
        #meal-builder-sezione { border-left-color: #ff8f00; }
        #btn-salva-pasto { background-color: #2e7d32; width: 100%; margin-top: 15px; }
        #caricamento-manuale { margin-top: 25px; padding-top: 20px; border-top: 1px solid #eee; border-left-color: #673ab7;}
        #caricamento-manuale div { display: flex; gap: 10px; align-items: center; }
        #caricamento-manuale input { flex-grow: 1; margin-bottom: 0; }
        #caricamento-manuale button { flex-grow: 0; width: auto; margin-bottom: 0; }
        .action-buttons { display: flex; justify-content: center; align-items: center; gap: 8px; }
        .action-buttons button { background: none; border: none; padding: 4px; font-size: 1.3em; line-height: 1; cursor: pointer; }
        .edit-btn { color: #1976d2; }
        .delete-btn { color: #d32f2f; }
        .meal-group-row { background-color: #f0f4f8; font-weight: bold; }
        .expand-arrow { cursor: pointer; display: inline-block; width: 20px; text-align: center; }
        .sub-item-row td { padding-left: 25px !important; background-color: #fff; font-style: italic; color: #555; border-bottom: 1px dotted #ccc; }
        .sub-item-row td:last-child { visibility: hidden; }
        .nutrients-warning { color: #d32f2f !important; }
        #meal-builder-summary { margin-bottom: 20px; padding: 15px; background-color: #e3f2fd; border: 1px solid #90caf9; border-radius: 8px; }
        #meal-builder-summary p { margin: 5px 0; font-weight: 600; color: #1e88e5; }
        #meal-builder-summary .progress-container { display: flex; gap: 20px; margin-top: 10px; }
        #meal-builder-summary .progress-item { flex: 1; }
        #meal-builder-summary .progress-item p { font-size: 0.9em; margin-bottom: 5px; color: #3f51b5; }
        #meal-builder-summary .progress-item progress { height: 18px; border-radius: 4px; }
        #calorie-balance-text { display: block; text-align: center; font-weight: bold; font-size: 1.2em; margin-top: 15px; margin-bottom: 10px; padding: 8px 0; border-radius: 5px; }
        .balance-deficit { background-color: #ffebee; color: #d32f2f; }
        .balance-surplus { background-color: #e8f5e9; color: #2e7d32; }
        .balance-even { background-color: #e3f2fd; color: #1976d2; }
        .collapsible-header { cursor: pointer; padding: 10px 0; border-bottom: 1px solid #e0e0e0; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; color: #0d47a1; font-size: 1.4em; }
        .collapsible-header:hover { color: #1976d2; }
        .collapsible-header .arrow { font-size: 0.8em; transition: transform 0.3s ease; }
        .collapsible-content { display: none; overflow: hidden; transition: max-height 0.3s ease-out; max-height: 0; }
        .collapsible-content.expanded { display: block; max-height: 2000px; }
        .collapsible-header.expanded .arrow { transform: rotate(90deg); }
        #calorie-adjuster { display: flex; align-items: center; justify-content: center; margin-top: 10px; margin-bottom: 20px; gap: 10px; }
        #calorie-adjuster button { padding: 5px 12px; font-size: 1.2em; border-radius: 5px; background-color: #4CAF50; color: white; border: none; cursor: pointer; }
        #calorie-adjuster button.minus { background-color: #f44336; }
        #calorie-adjuster input[type="number"] { width: 80px; text-align: center; font-size: 1.1em; padding: 8px; border: 1px solid #ccc; border-radius: 5px; }
        #calorie-adjuster label { margin-bottom: 0; font-weight: normal; color: #333; }
        .cloud-sync-section { display: flex; gap: 10px; margin-top: 20px; padding: 15px; background-color: #e0f2f7; border: 1px solid #b2ebf2; border-radius: 8px; flex-wrap: wrap; }
        .cloud-sync-section button { flex: 1 1 auto; min-width: 150px; margin-bottom: 5px; }
        .cloud-sync-section #btn-download-manual { background-color: #e64a19; }
        .cloud-sync-status { width: 100%; text-align: center; font-size: 0.9em; color: #555; margin-top: 10px; }
        .cloud-sync-status.connected { color: #2e7d32; font-weight: bold; }
        .cloud-sync-status.disconnected { color: #c62828; font-weight: bold; }
        #auth-section { margin-bottom: 25px; padding: 20px; background-color: #fafafa; border: 1px solid #e0e0e0; border-radius: 8px; border-left-width: 5px; border-left-color: #673ab7; }
        #auth-section h2 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        #auth-section .auth-buttons { display: flex; gap: 10px; }
        #auth-section .auth-buttons button { width: 50%; background-color: #1976d2; }
        #auth-section #btn-sign-out { background-color: #607d8b; display: none; margin-top: 15px; }
        #auth-status { text-align: center; font-weight: 600; margin-top: 15px; }
        #welcome-message { text-align: center; font-weight: bold; font-size: 1.2em; color: #0d47a1; margin-bottom: 10px; display: none; }
        #main-tracker-content { display: none; }
        #main-tracker-content.authenticated { display: block; }
        #auth-section.logged-in { padding: 10px 20px; background-color: #e3f2fd; border: 1px solid #90caf9; box-shadow: none; text-align: center; display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 10px; }
        #auth-section.logged-in #auth-header, #auth-section.logged-in #auth-form-fields, #auth-section.logged-in #auth-status { display: none !important; }
        #auth-section.logged-in #welcome-message { margin: 0; font-size: 1em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #auth-section.logged-in #btn-sign-out { width: auto; padding: 5px 10px; font-size: 0.8em; margin: 0; flex-shrink: 0; }
        .summary-header-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-bottom: 25px; }
        #manual-fill-section { margin-top: 15px; padding-top: 15px; border-top: 1px solid #ccc; }
        #manual-fill-section textarea { width: 100%; height: 100px; margin-top: 10px; resize: vertical; }
        #manual-fill-section .button-group { justify-content: space-between; }
        .fats-bar-container { margin-top: 15px; }
        .fats-group { padding-left: 15px; border-left: 3px solid #eee; margin-top: 15px; }
        .fats-sub-bars-container { display: flex; gap: 20px; margin-top: 10px; }
        .fats-sub-bars-container > div { flex-grow: 1; flex-basis: 0; }
        .progress-fat-sat.green::-webkit-progress-value { background-color: #4CAF50; }
        .progress-fat-sat.green::-moz-progress-bar { background-color: #4CAF50; }
        .progress-fat-sat.orange::-webkit-progress-value { background-color: #ff9800; }
        .progress-fat-sat.orange::-moz-progress-bar { background-color: #ff9800; }
        .progress-fat-sat.red::-webkit-progress-value { background-color: #f44336; }
        .progress-fat-sat.red::-moz-progress-bar { background-color: #f44336; }
        .food-adder-header { display: flex; justify-content: space-between; align-items: center; }
        .food-adder-header button { background: none; border: none; font-size: 1.5em; cursor: pointer; color: #555; padding: 5px 10px; }
        .food-adder-header button:hover { color: #0d47a1; }
        #btn-clear-nutrients { color: #d32f2f; }
        #btn-clear-nutrients:hover { color: #ff1744; }
        .vitamin-group { padding: 10px; margin-top: 10px; background-color: #f9f9f9; border: 1px solid #eee; border-radius: 6px; }
        #vit-content { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .diary-table-container { 
            overflow-x: auto; 
            -webkit-box-shadow: inset -8px 0px 8px -8px rgba(0,0,0,0.1);
            box-shadow: inset -8px 0px 8px -8px rgba(0,0,0,0.1);
        }
        #log-pasti th, #log-pasti td {
            min-width: 60px;
            text-align: right;
            padding: 8px 10px;
            white-space: nowrap;
        }
        #log-pasti th:nth-child(1), #log-pasti td:nth-child(1) {
            min-width: 150px;
            text-align: left;
            position: -webkit-sticky;
            position: sticky;
            left: 0;
            z-index: 2;
            border-right: 2px solid #e0e0e0;
        }
        #log-pasti th:nth-child(2), #log-pasti td:nth-child(2) {
            min-width: 50px;
            text-align: left;
        }
        #log-pasti th:last-child, #log-pasti td:last-child {
            min-width: 80px;
            text-align: center;
        }
        #log-pasti th:first-child { background-color: #f8f9fa; }
        #log-pasti td:first-child { background-color: #ffffff; }
        #log-pasti .meal-group-row td:first-child { background-color: #f0f4f8; }
        #log-pasti .sub-item-row td:first-child { background-color: #ffffff; }
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto; 
            background-color: rgba(0,0,0,0.6); 
            -webkit-animation-name: fadeIn;
            -webkit-animation-duration: 0.4s;
            animation-name: fadeIn;
            animation-duration: 0.4s;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 25px;
            border: 1px solid #888;
            width: 90%;
            max-width: 700px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            -webkit-animation-name: slideIn;
            -webkit-animation-duration: 0.4s;
            animation-name: slideIn;
            animation-duration: 0.4s;
        }
        .modal-close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            line-height: 1;
        }
        .modal-close:hover,
        .modal-close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .modal-content video {
            background-color: #000;
        }
        .vitamin-weekly-summary {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        .vitamin-weekly-summary:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        .vitamin-weekly-summary h4 {
            margin-top: 0;
            margin-bottom: 8px;
            color: #1565c0;
            border: none;
        }
        .vitamin-weekly-summary p {
            margin: 4px 0;
            font-size: 0.95em;
        }
        .vitamin-weekly-summary i {
            color: #555;
            font-size: 0.9em;
        }
        .vitamin-weekly-summary progress {
            width: 100%;
            height: 20px;
        }
        .diff-value { font-weight: bold; }
        .diff-surplus { color: #2e7d32; }
        .diff-deficit { color: #d32f2f; }
        @-webkit-keyframes slideIn { from {top: -300px; opacity: 0} to {top: 0; opacity: 1} }
        @keyframes slideIn { from {margin-top: 5%; opacity: 0} to {margin-top: 10%; opacity: 1} }
        @-webkit-keyframes fadeIn { from {opacity: 0} to {opacity: 1} }
        @keyframes fadeIn { from {opacity: 0} to {opacity: 1} }
        #nutrient-detail-modal-list li {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #nutrient-detail-modal-list li:last-child {
            border-bottom: none;
        }
        #nutrient-detail-modal-list li span {
            font-weight: 600;
        }
        .protein-score {
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 4px;
            color: white;
            font-size: 0.85em;
            text-align: center;
        }
        .protein-score.low { background-color: #d32f2f; }
        .protein-score.medium { background-color: #ff8f00; }
        .protein-score.high { background-color: #2e7d32; }

        .food-label-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        .food-label-container label {
            margin-bottom: 0;
            flex-shrink: 0;
        }
        #btn-edit-ingredients, #btn-edit-name {
            background: none;
            border: none;
            font-size: 1.1em;
            color: #607d8b;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        #btn-edit-ingredients:hover, #btn-edit-name:hover {
            color: #1976d2;
        }
        .ingredient-icon {
            cursor: pointer;
            color: #607d8b;
            margin-right: 8px;
            font-size: 1.1em;
        }
        .ingredient-icon:hover {
            color: #1976d2;
        }
        #ingredient-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        #ingredient-modal-title {
            margin: 0;
            font-size: 1.5em;
            color: #0d47a1;
        }
        #ingredient-modal-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        #ingredient-modal-actions button {
            background: none;
            border: none;
            font-size: 1.6em;
            cursor: pointer;
            padding: 5px;
            color: #555;
        }
        #ingredient-modal-actions button:hover {
            color: #0d47a1;
        }
        #btn-clear-ingredients:hover {
            color: #d32f2f;
        }
        #ingredient-modal-textarea {
            width: 100%;
            height: 200px;
            resize: vertical;
            font-family: monospace;
            font-size: 1em;
        }
        
        #nutrient-confirm-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            max-height: 40vh;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #eee;
            min-height: 50px;
        }
        .nutrient-confirm-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .nutrient-confirm-item label {
            flex-basis: 60%;
            margin-bottom: 0;
            font-size: 0.9em;
        }
        .nutrient-confirm-item input {
            flex-grow: 1;
            margin-bottom: 0;
            padding: 8px;
            font-size: 0.9em;
        }
        .nutrient-confirm-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        #custom-suggestions {
            display: none;
            position: absolute;
            background-color: #ffffff;
            border: 1px solid #ccc;
            border-radius: 0 0 6px 6px;
            width: 100%;
            max-height: 250px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            box-sizing: border-box;
        }
        .suggestion-item {
            padding: 10px 12px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
            font-size: 0.95em;
        }
        .suggestion-item:last-child {
            border-bottom: none;
        }
        .suggestion-item:hover {
            background-color: #e3f2fd;
        }
        .suggestion-delete-btn {
            color: #d32f2f;
            background: none;
            border: none;
            font-size: 1.3em;
            cursor: pointer;
            padding: 2px 8px;
            line-height: 1;
        }
        .suggestion-delete-btn:hover {
            background-color: #ffebee;
            border-radius: 50%;
        }
        #btn-clear-dettagli {
            background: none;
            border: none;
            color: #d32f2f;
            font-size: 1em;
            cursor: pointer;
            padding: 0 10px;
            opacity: 0.7;
        }
        #btn-clear-dettagli:hover {
            opacity: 1;
        }
        .diff-item { 
            padding: 12px 8px; 
            border-bottom: 1px solid #f0f0f0; 
            display: grid; 
            grid-template-columns: 150px 1fr; 
            gap: 15px; 
            align-items: center; 
            font-size: 0.9em;
        }
        .diff-item:last-child { border-bottom: none; }
        .diff-item-label { font-weight: bold; }
        .diff-item-choices { display: flex; flex-direction: column; gap: 8px; }
        .diff-item-choices label { font-weight: normal; display: flex; align-items: center; gap: 8px; margin: 0; cursor: pointer;}
        .diff-item-choices input[type="radio"] { margin: 0; }
        .diff-item-choices .current-value { color: #1976d2; }
        .diff-item-choices .new-value { color: #2e7d32; }
        
        /* BILANCIA IDRICA STYLES */
        .balance-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            position: relative;
            background: #eee;
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            border: 1px solid #ccc;
        }
        .balance-bar-left {
            height: 100%;
            background: linear-gradient(to right, #ff5252, #ffcc80);
            width: 50%;
            transition: width 0.5s ease;
        }
        .balance-bar-right {
            height: 100%;
            background: linear-gradient(to right, #a5d6a7, #4caf50);
            width: 50%;
            transition: width 0.5s ease;
        }
        .balance-marker {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 4px;
            background-color: #333;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2;
            transition: left 0.5s ease;
        }
        .balance-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            margin-top: 5px;
            color: #555;
        }
        .balance-value { font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Tracker Nutrizionale Definitivo v6</h1>
        
        <div id="auth-section" class="sezione">
            <h2 id="auth-header">Accedi / Registrati</h2>
            <p id="welcome-message"></p>
            <div id="auth-form-fields">
                <div><label for="user-email">Email</label><input type="email" id="user-email"></div>
                <div><label for="user-password">Password</label><input type="password" id="user-password"></div>
                <div class="auth-buttons">
                    <button id="btn-register">Registrati</button>
                    <button id="btn-login">Accedi</button>
                </div>
            </div>
            <button id="btn-sign-out">Esci</button>
            <p id="auth-status"></p>
        </div>
        <div id="main-tracker-content">
            <h2 id="titolo-giornata"></h2>
<div class="nav-links">
    <a href="storico.html">üìä Storico</a>
    
    <button id="btn-export-json-ai" style="flex-grow: 1; text-align: center; padding: 10px; background-color: #673ab7; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 1em;">
        üß† Dati Completi AI
    </button>
</div>
                
                <span id="calorie-balance-text"></span>

                <div id="calorie-adjuster">
                    <label for="calorie-adjustment-input">Correzione Obiettivo:</label>
                    <button id="btn-calorie-minus" class="minus">-</button>
                    <input type="number" id="calorie-adjustment-input" value="0"> <button id="btn-calorie-plus">+</button>
                    <span>kcal</span>
                </div>

                <p style="display: flex; align-items: center; gap: 10px;">
                    <span>Proteine: <span id="totale-proteine">0</span> / <span id="obiettivo-proteine"></span> g</span>
                    <i id="info-proteine-giornata" class="fas fa-info-circle" style="cursor: pointer; color: #1976d2; font-size: 1.2em;"></i>
                </p>
                <progress id="progress-proteine" class="macro-progress" value="0"></progress>
                <p>Calorie: <span id="totale-calorie">0</span> / <span id="obiettivo-calorie"></span> kcal</p>
                <progress id="progress-calorie" class="macro-progress" value="0"></progress>
                <p>Workout: <span id="workout-calories-totali">0</span> kcal</p>
                <hr>

                <h3 class="collapsible-header" id="carbs-header">
                    Carboidrati e Zuccheri <span class="arrow">‚ñ∂</span>
                </h3>
                <div class="collapsible-content" id="carbs-content">
                    <p>Carboidrati: <span id="totale-carboidrati">0</span> / <span id="obiettivo-carboidrati"></span> g</p>
                    <progress id="progress-carboidrati" class="macro-progress" value="0"></progress>
                    <p>di cui Zuccheri: <span id="totale-zuccheri">0</span> / <span id="obiettivo-zuccheri"></span> g</p>
                    <progress id="progress-zuccheri" class="macro-progress" value="0"></progress>
                </div>
                <hr>
                
                <h3 class="collapsible-header" id="fibre-header">
                    Fibre <span class="arrow">‚ñ∂</span>
                </h3>
                <div class="collapsible-content" id="fibre-content">
                    <p>Fibre Totali: <span id="totale-fibre-totali">0</span> / <span id="obiettivo-fibre-totali"></span> g</p>
                    <progress id="progress-fibre-totali" class="macro-progress" value="0"></progress>
                    <div class="fats-group" style="padding-left: 15px; border-left: 3px solid #eee; margin-top: 15px;">
                        <p>Solubili: <span id="totale-fibre-solubili">0</span> / <span id="obiettivo-fibre-solubili"></span> g</p>
                        <progress id="progress-fibre-solubili" value="0"></progress>
                        <p>Insolubili: <span id="totale-fibre-insolubili">0</span> / <span id="obiettivo-fibre-insolubili"></span> g</p>
                        <progress id="progress-fibre-insolubili" value="0"></progress>
                    </div>
                </div>
                <hr>
                
                <h3 class="collapsible-header" id="fats-header">
                    <span style="display: flex; align-items: center; gap: 8px;">
                        Grassi
                        <i id="info-fats-settimanali" class="fas fa-info-circle" style="cursor: pointer; color: #1976d2;"></i>
                    </span>
                    <span class="arrow">‚ñ∂</span>
                </h3>
                <div class="collapsible-content" id="fats-content">
                    <p>Grassi Totali: <span id="totale-fats-total">0</span> / <span id="obiettivo-fats-total"></span> g</p>
                    <progress id="progress-fats-total" class="macro-progress" value="0"></progress>
                    
                    <div class="fats-group">
                         <div class="fats-sub-bars-container">
                            <div>
                                <p>Saturi: <span id="totale-fat-sat">0</span> / <span id="obiettivo-fat-sat"></span> g</p>
                                <progress id="progress-fat-sat" class="progress-fat-sat" value="0"></progress>
                            </div>
                            <div>
                                <p>Trans: <span id="totale-fat-trans">0</span> / <span id="obiettivo-fat-trans"></span> g</p>
                                <progress id="progress-fat-trans" value="0"></progress>
                            </div>
                        </div>
                    </div>

                    <div class="fats-group">
                        <h4>Grassi Insaturi: <span id="totale-fat-unsat">0</span> / <span id="obiettivo-fat-unsat"></span> g</h4>
                        <progress id="progress-fat-unsat" value="0"></progress>
                        <div style="padding-left: 15px;">
                            <p>Monoinsaturi: <span id="totale-fat-mono">0</span> / <span id="obiettivo-fat-mono"></span> g</p>
                            <progress id="progress-fat-mono" value="0"></progress>
                            <p>Polinsaturi: <span id="totale-fat-poly">0</span> / <span id="obiettivo-fat-poly"></span> g</p>
                            <progress id="progress-fat-poly" value="0"></progress>
                            <div class="fats-group" style="border: none; padding-left: 10px; margin-top: 10px;">
                                 <div class="fats-sub-bars-container">
                                    <div>
                                        <p>Omega 3: <span id="totale-omega3">0</span> / <span id="obiettivo-omega3"></span> g</p>
                                        <progress id="progress-omega3" value="0"></progress>
                                    </div>
                                    <div>
                                        <p>Omega 6: <span id="totale-omega6">0</span> / <span id="obiettivo-omega6"></span> g</p>
                                        <progress id="progress-omega6" value="0"></progress>
                                    </div>
                                 </div>
                                 <p style="text-align: center; font-weight: bold; margin-top: 10px; font-size: 1.1em;">
                                    Rapporto O6:O3: <span id="omega-ratio-value"></span>
                                 </p>
                            </div>
                        </div>
                    </div>
                </div>
                <hr>
                
                <h3 class="collapsible-header" id="micro-header">
                    Micronutrienti <span class="arrow">‚ñ∂</span>
                </h3>
                <div class="collapsible-content" id="micro-content">
                    
                    <div style="margin-bottom: 20px; padding: 10px; background-color: #f1f8e9; border: 1px solid #c8e6c9; border-radius: 8px;">
                        <h4 style="margin-top:0; text-align: center; color: #2e7d32;">Bilancia Idrica (Anti-Cortisolo)</h4>
                        <div class="balance-labels">
                            <span style="color: #d32f2f;">SODIO (Na)</span>
                            <span style="color: #388e3c;">POTASSIO (K)</span>
                        </div>
                        <div class="balance-container">
                            <div class="balance-bar-left"></div>
                            <div class="balance-bar-right"></div>
                            <div id="balance-marker" class="balance-marker"></div>
                        </div>
                        <div class="balance-labels">
                            <span class="balance-value" id="valore-sodio">0 mg</span>
                            <span class="balance-value" id="valore-potassio">0 mg</span>
                        </div>
                        <p style="text-align: center; font-size: 0.85em; margin: 5px 0 0 0; color: #555;">Obiettivo: Cursore a destra (Zona Verde)</p>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                        <div>
                            <p>Magnesio: <span id="totale-mg">0</span> / 420 mg</p><progress id="progress-mg" value="0"></progress>
                            <p>Potassio: <span id="totale-k">0</span> / 3400 mg</p><progress id="progress-k" value="0"></progress>
                        </div>
                        <div>
                            <p>Ferro: <span id="totale-fe">0</span> / 18 mg</p><progress id="progress-fe" value="0"></progress>
                            <p>Zinco: <span id="totale-zn">0</span> / 11 mg</p><progress id="progress-zn" value="0"></progress>
                        </div>
                        <div>
                            <p>Calcio: <span id="totale-ca">0</span> / 1000 mg</p><progress id="progress-ca" value="0"></progress>
                            <p>Rame: <span id="totale-cu">0</span> / 0.9 mg</p><progress id="progress-cu" value="0" max="0.9"></progress>
                        </div>
                    </div>
                     <div style="margin-top: 15px;">
                        <p>Fosforo: <span id="totale-p">0</span> / 700 mg</p><progress id="progress-p" value="0" max="700"></progress>
                    </div>
                </div>
                <hr>

                <h3 class="collapsible-header" id="vit-header">
                    Vitamine <span class="arrow">‚ñ∂</span>
                </h3>
                <div class="collapsible-content" id="vit-content">
                    <div class="vitamin-group">
                        <h4 style="display: flex; align-items: center; gap: 8px;">
                            Accumulabili (Liposolubili / Fegato) 
                            <i id="info-vit-settimanali" class="fas fa-info-circle" style="cursor: pointer; color: #1976d2;"></i>
                        </h4>
                        <p>Vitamina A: <span id="totale-vit-a">0</span> / 900 ¬µg</p><progress id="progress-vit-a" value="0" max="900"></progress>
                        <p>Vitamina D: <span id="totale-vit-d">0</span> / 15 ¬µg</p><progress id="progress-vit-d" value="0" max="15"></progress>
                        <p>Vitamina E: <span id="totale-vit-e">0</span> / 15 mg</p><progress id="progress-vit-e" value="0" max="15"></progress>
                        <p>Vitamina K: <span id="totale-vit-k">0</span> / 120 ¬µg</p><progress id="progress-vit-k" value="0" max="120"></progress>
                        <p>Vitamina B12: <span id="totale-vit-b12">0</span> / 2.4 ¬µg</p><progress id="progress-vit-b12" value="0" max="2.4"></progress>
                    </div>
                     <div class="vitamin-group">
                        <h4>Giornaliere (Idrosolubili)</h4>
                        <p>Vitamina C: <span id="totale-vitc">0</span> / 90 mg</p><progress id="progress-vitc" value="0" max="90"></progress>
                        <p>Vitamina B2: <span id="totale-b2">0</span> / 1.3 mg</p><progress id="progress-b2" value="0" max="1.3"></progress>
                        <p>Vitamina B6: <span id="totale-b6">0</span> / 1.3 mg</p><progress id="progress-b6" value="0" max="1.3"></progress>
                        <p>Folati (B9): <span id="totale-b9">0</span> / 400 ¬µg</p><progress id="progress-b9" value="0" max="400"></progress>
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <label for="daily-notes">Note del Giorno</label>
                    <textarea id="daily-notes" rows="3" placeholder="Aggiungi note per la giornata..."></textarea>
                </div>
                </div>

            <div id="form-allenamento" class="sezione">
                <h2 class="collapsible-header" id="workout-header">Registra Allenamento <span class="arrow">‚ñ∂</span></h2>
                <div class="collapsible-content" id="workout-content">
                    <label for="workout-desc">Descrizione Allenamento</label>
                    <input type="text" id="workout-desc" placeholder="es. Corsa 30 min, Pesistica">
                    <label for="workout-calories">Calorie Bruciate (kcal)</label>
                    <input type="number" id="workout-calories" min="0">
                    <button id="btn-add-workout">Aggiungi Allenamento</button>
                </div>
            </div>
            <div id="food-adder" class="sezione">
                <div class="food-adder-header">
                    <h2>Aggiungi Alimento</h2>
                    <div id="photo-ocr-controls" style="display: flex; align-items: center; gap: 5px;">
                         <span id="photo-ocr-status" style="display:none; color: #555; font-style: italic; font-size: 0.9em;"></span>
                         <button id="btn-photo-nutrients" title="Acquisisci Nutrienti da Foto"><i class="fas fa-camera"></i></button>
                         <button id="btn-scan-barcode" title="Scansiona Codice a Barre"><i class="fas fa-barcode"></i></button>
                         <button id="btn-clear-nutrients" title="Cancella campi nutrienti"><i class="fas fa-trash-alt"></i></button>
                    </div>
                </div>
                <div class="builder-grid">
                    <div style="position: relative;">
                        <div class="food-label-container">
                            <label for="builder-desc">Alimento</label>
                            <button id="btn-edit-name" title="Modifica solo il nome senza ricaricare i dati" style="display: none;">‚úèÔ∏è</button>
                            <button id="btn-edit-ingredients" title="Modifica Lista Ingredienti">üìú</button>
                        </div>
                        <input type="text" id="builder-desc" autocomplete="off">
                        <div id="custom-suggestions"></div>
                    </div>
                    <div><label>Quantit√† (g)</label><input type="text" id="builder-qta"></div>
                    <div><label>Proteine/100g</label><input type="number" id="builder-prot" step="0.1"></div>
                    <div><label>Kcal/100g</label><input type="number" id="builder-kcal" min="0"></div>
                    <div><label>Carboidrati/100g</label><input type="number" id="builder-carb" step="0.1"></div>
                    <div><label>Zuccheri/100g</label><input type="number" id="builder-zuccheri" step="0.1"></div>
                    <div><label>Grassi Totali/100g</label><input type="number" id="builder-fat-total" step="0.1"></div>
                    <div><label>Gr. Saturi/100g</label><input type="number" id="builder-fat-sat" min="0" step="0.1"></div>
                    <div><label>Fibre Totali/100g</label><input type="number" id="builder-fibre-totali" step="0.1"></div>
                </div>
                <h2 class="collapsible-header" id="nutrients-header">
                    <span>Dettagli Nutrizionali</span>
                    <div style="display: flex; align-items: center;">
                        <button id="btn-clear-dettagli" title="Pulisci Dettagli Nutrizionali"><i class="fas fa-eraser"></i></button>
                        <span class="arrow">‚ñ∂</span>
                    </div>
                </h2>
                <div class="collapsible-content" id="nutrients-content">
                    <div class="builder-grid">
                        <div><label style="color:#d32f2f;">Sodio (mg)/100g</label><input type="number" id="builder-na" min="0" step="1"></div>
                        
                        <div><label>Fibre Solubili/100g</label><input type="number" id="builder-fibre-solubili" step="0.1"></div>
                        <div><label>Fibre Insolubili/100g</label><input type="number" id="builder-fibre-insolubili" step="0.1"></div>
                        <div><label>Gr. Trans/100g</label><input type="number" id="builder-fat-trans" min="0" step="0.1"></div>
                        <div><label>Gr. Monoinsaturi/100g</label><input type="number" id="builder-fat-mono" min="0" step="0.1"></div>
                        <div><label>Gr. Polinsaturi/100g</label><input type="number" id="builder-fat-poly" min="0" step="0.1"></div>
                        <div><label>Omega 3/100g</label><input type="number" id="builder-omega3" min="0" step="0.1"></div>
                        <div><label>Omega 6/100g</label><input type="number" id="builder-omega6" min="0" step="0.1"></div>
                        <div><label>Vit. A (Œºg)/100g</label><input type="number" id="builder-vit-a" min="0"></div>
                        <div><label>Vit. B2 (mg)/100g</label><input type="number" id="builder-b2" min="0" step="0.01"></div>
                        <div><label>Vit. B6 (mg)/100g</label><input type="number" id="builder-b6" min="0" step="0.01"></div>
                        <div><label>Vit. B12 (Œºg)/100g</label><input type="number" id="builder-vit-b12" min="0" step="0.01"></div>
                        <div><label>Vit. D (Œºg)/100g</label><input type="number" id="builder-vit-d" min="0" step="0.01"></div>
                        <div><label>Vit. E (mg)/100g</label><input type="number" id="builder-vit-e" min="0" step="0.1"></div>
                        <div><label>Vit. K (Œºg)/100g</label><input type="number" id="builder-vit-k" min="0"></div>
                        <div><label>Folati B9 (Œºg)/100g</label><input type="number" id="builder-b9" min="0"></div>
                        <div><label>Magnesio (mg)/100g</label><input type="number" id="builder-mg" min="0"></div>
                        <div><label>Potassio (mg)/100g</label><input type="number" id="builder-k" min="0"></div>
                        <div><label>Vitamina C (mg)/100g</label><input type="number" id="builder-vitc" min="0"></div>
                        <div><label>Calcio (mg)/100g</label><input type="number" id="builder-ca" min="0"></div>
                        <div><label>Ferro (mg)/100g</label><input type="number" id="builder-fe" min="0" step="0.1"></div>
                        <div><label>Zinco (mg)/100g</label><input type="number" id="builder-zn" min="0" step="0.1"></div>
                        <div><label>Rame (mg)/100g</label><input type="number" id="builder-cu" min="0" step="0.01"></div>
                        <div><label>Fosforo (mg)/100g</label><input type="number" id="builder-p" min="0"></div>
                        <div><label>Leucina (mg)/100g</label><input type="number" id="builder-leu" min="0"></div>
                        <div><label>Isoleucina (mg)/100g</label><input type="number" id="builder-iso" min="0"></div>
                        <div><label>Valina (mg)/100g</label><input type="number" id="builder-val" min="0"></div>
                        <div><label>Lisina (mg)/100g</label><input type="number" id="builder-lys" min="0"></div>
                        <div><label>Metionina (mg)/100g</label><input type="number" id="builder-met" min="0"></div>
                        <div><label>Fenilalanina (mg)/100g</label><input type="number" id="builder-phe" min="0"></div>
                        <div><label>Treonina (mg)/100g</label><input type="number" id="builder-thr" min="0"></div>
                        <div><label>Triptofano (mg)/100g</label><input type="number" id="builder-trp" min="0"></div>
                        <div><label>Istidina (mg)/100g</label><input type="number" id="builder-his" min="0"></div>
                    </div>
                    <div id="manual-fill-section">
                        <div class="button-group">
                            <button id="btn-copy-prompt">Copia Richiesta AI</button>
                            <button id="btn-confirm-json" style="background-color: #2e7d32;">Conferma Dati da JSON</button>
                        </div>
                        <textarea id="manual-json-input" placeholder="Incolla qui l'oggetto JSON con i valori nutrizionali, come da richiesta."></textarea>
                    </div>
                </div>
                <div class="button-group">
                    <button id="btn-costruisci-pasto">Aggiungi a Pasto</button>
                    <button id="btn-aggiungi-singolo">Aggiungi al Diario</button>
                    <button id="btn-compila-ai" style="background-color: #0d47a1;">Compila AI</button>
                </div>
            </div>
            <div id="meal-builder-sezione" class="sezione" data-visible="false">
                <h2>Costruttore Pasto</h2>
                <div id="meal-builder-summary">
                    <p>Pasto Selezionato: <span id="current-meal-type-display"></span></p>
                    <div class="progress-container">
                        <div class="progress-item">
                            <p style="display: flex; align-items: center; gap: 10px;">
                                <span>Proteine: <span id="meal-prot-current">0</span> / <span id="meal-prot-target"></span> g (<span id="meal-prot-remaining"></span>)</span>
                                <i id="info-proteine-pasto" class="fas fa-info-circle" style="cursor: pointer; color: #1976d2; font-size: 1.2em;"></i>
                            </p>
                            <progress id="meal-progress-prot" value="0"></progress>
                        </div>
                        <div class="progress-item">
                            <p>Calorie: <span id="meal-cal-current">0</span> / <span id="meal-cal-target"></span> kcal (<span id="meal-cal-remaining"></span>)</p>
                            <progress id="meal-progress-cal" value="0"></progress>
                        </div>
                    </div>
                </div>
                <select id="meal-type-selector">
                    <option value="merenda1">Merenda AM</option>
                    <option value="pranzo">Pranzo</option>
                    <option value="merenda2">Merenda PM</option>
                    <option value="cena">Cena</option>
                </select>
                <table id="log-pasto-builder">
                    <thead><tr><th>Sel.</th><th>Descrizione</th><th>(g)</th><th>Prot</th><th>Kcal</th><th>Azione</th></tr></thead>
                    <tbody id="log-pasto-builder-body"></tbody>
                </table>
                <button id="btn-salva-pasto">Salva Pasto nel Diario</button>
            </div>
            <div class="sezione">
                <h2>Diario Giornaliero</h2>
                <div class="diary-table-container">
                <table id="log-pasti">
                    <thead>
                        <tr>
                            <th>Descrizione</th>
                            <th>(g)</th>
                            <th>Prot</th>
                            <th>Qualit√†</th>
                            <th>Kcal</th>
                            <th>Sodio</th> <th>Fibre Tot</th>
                            <th>Fibre Sol</th>
                            <th>Fibre Ins</th>
                            <th>Leu</th>
                            <th>Iso</th>
                            <th>Val</th>
                            <th>Lys</th>
                            <th>Met</th>
                            <th>Phe</th>
                            <th>Thr</th>
                            <th>Trp</th>
                            <th>His</th>
                            <th>Gr. Sat</th>
                            <th>Gr. Trans</th>
                            <th>Gr. Mono</th>
                            <th>Gr. Poly</th>
                            <th>Omega 3</th>
                            <th>Omega 6</th>
                            <th>Mg</th>
                            <th>K</th>
                            <th>Vit.C</th>
                            <th>Ca</th>
                            <th>Fe</th>
                            <th>Zn</th>
                            <th>Cu</th>
                            <th>Vit. A</th>
                            <th>Vit. B12</th>
                            <th>Vit. D</th>
                            <th>Vit. E</th>
                            <th>Vit. K</th>
                            <th>B9</th>
                            <th>B2</th>
                            <th>B6</th>
                            <th>Azione</th>
                        </tr>
                    </thead>
                    <tbody id="log-body"></tbody>
                </table>
                </div>
                <div id="caricamento-manuale" class="sezione" style="padding:15px; margin-top:20px; border-width:1px;">
                    <h3 style="margin:0 0 10px 0; font-size:1em;">Visualizza un Altro Giorno</h3>
                    <div>
                        <input type="date" id="data-caricamento">
                        <button id="btn-vai-a-oggi">Oggi</button>
                    </div>
                </div>
            </div>

            <div class="sezione">
                <h2>Sincronizzazione Cloud Manuale</h2>
                <div class="cloud-sync-section">
                    <button id="btn-download-manual">‚¨áÔ∏è Scarica Dati dal Cloud</button>
                    <span id="cloud-sync-status" class="cloud-sync-status disconnected">Connessione Cloud: Disconnesso</span>
                </div>
                <p style="font-size: 0.85em; color: #777; margin-top: 10px;">
                    Una volta autenticato, puoi sincronizzare i dati. Lo scaricamento manuale sovrascrive i dati locali.
                </p>
            </div>
        </div>
    </div>
    
    <div id="weekly-vitamin-modal" class="modal"><div class="modal-content"><span class="modal-close" data-modal="weekly-vitamin-modal">&times;</span><h2>Riepilogo Settimanale Vitamine Accumulabili</h2><p style="font-size: 0.9em; color: #555;">Dati calcolati sugli ultimi 7 giorni, incluso oggi.</p><div class="vitamin-weekly-summary"><h4>Vitamina A</h4><p>Totale: <span id="weekly-vit-a-total">0</span> / <span id="weekly-vit-a-goal">6300</span> ¬µg</p><progress id="weekly-progress-vit-a" value="0" max="6300"></progress><p><i>Media giornaliera: <span id="weekly-vit-a-avg">0.0</span> ¬µg (Obiettivo: 900 ¬µg | <span id="weekly-vit-a-diff" class="diff-value"></span>)</i></p></div><div class="vitamin-weekly-summary"><h4>Vitamina D</h4><p>Totale: <span id="weekly-vit-d-total">0</span> / <span id="weekly-vit-d-goal">105</span> ¬µg</p><progress id="weekly-progress-vit-d" value="0" max="105"></progress><p><i>Media giornaliera: <span id="weekly-vit-d-avg">0.0</span> ¬µg (Obiettivo: 15 ¬µg | <span id="weekly-vit-d-diff" class="diff-value"></span>)</i></p></div><div class="vitamin-weekly-summary"><h4>Vitamina E</h4><p>Totale: <span id="weekly-vit-e-total">0</span> / <span id="weekly-vit-e-goal">105</span> mg</p><progress id="weekly-progress-vit-e" value="0" max="105"></progress><p><i>Media giornaliera: <span id="weekly-vit-e-avg">0.0</span> mg (Obiettivo: 15 mg | <span id="weekly-vit-e-diff" class="diff-value"></span>)</i></p></div><div class="vitamin-weekly-summary"><h4>Vitamina K</h4><p>Totale: <span id="weekly-vit-k-total">0</span> / <span id="weekly-vit-k-goal">840</span> ¬µg</p><progress id="weekly-progress-vit-k" value="0" max="840"></progress><p><i>Media giornaliera: <span id="weekly-vit-k-avg">0.0</span> ¬µg (Obiettivo: 120 ¬µg | <span id="weekly-vit-k-diff" class="diff-value"></span>)</i></p></div><div class="vitamin-weekly-summary"><h4>Vitamina B12</h4><p>Totale: <span id="weekly-vit-b12-total">0</span> / <span id="weekly-vit-b12-goal">16.8</span> ¬µg</p><progress id="weekly-progress-vit-b12" value="0" max="16.8"></progress><p><i>Media giornaliera: <span id="weekly-vit-b12-avg">0.0</span> ¬µg (Obiettivo: 2.4 ¬µg | <span id="weekly-vit-b12-diff" class="diff-value"></span>)</i></p></div></div></div>
    <div id="weekly-fats-modal" class="modal"><div class="modal-content"><span class="modal-close" data-modal="weekly-fats-modal">&times;</span><h2>Riepilogo Settimanale Grassi</h2><p style="font-size: 0.9em; color: #555;">Dati calcolati sugli ultimi 7 giorni, incluso oggi.</p><div class="vitamin-weekly-summary"><h4>Grassi Totali</h4><p>Totale: <span id="weekly-fat-total-total">0</span> / <span id="weekly-fat-total-goal"></span> g</p><progress id="weekly-progress-fat-total" value="0"></progress><p><i>Media giornaliera: <span id="weekly-fat-total-avg">0.0</span> g (Obiettivo: <span id="daily-fat-total-goal"></span> g | <span id="weekly-fat-total-diff" class="diff-value"></span>)</i></p></div><div class="vitamin-weekly-summary"><h4>Grassi Saturi</h4><p>Totale: <span id="weekly-fat-sat-total">0</span> / <span id="weekly-fat-sat-goal"></span> g</p><progress id="weekly-progress-fat-sat" value="0"></progress><p><i>Media giornaliera: <span id="weekly-fat-sat-avg">0.0</span> g (Obiettivo: <span id="daily-fat-sat-goal"></span> g | <span id="weekly-fat-sat-diff" class="diff-value"></span>)</i></p></div><div class="vitamin-weekly-summary"><h4>Grassi Trans</h4><p>Totale: <span id="weekly-fat-trans-total">0</span> / <span id="weekly-fat-trans-goal"></span> g</p><progress id="weekly-progress-fat-trans" value="0"></progress><p><i>Media giornaliera: <span id="weekly-fat-trans-avg">0.0</span> g (Obiettivo: <span id="daily-fat-trans-goal"></span> g | <span id="weekly-fat-trans-diff" class="diff-value"></span>)</i></p></div><div class="vitamin-weekly-summary"><h4>Grassi Monoinsaturi</h4><p>Totale: <span id="weekly-fat-mono-total">0</span> / <span id="weekly-fat-mono-goal"></span> g</p><progress id="weekly-progress-fat-mono" value="0"></progress><p><i>Media giornaliera: <span id="weekly-fat-mono-avg">0.0</span> g (Obiettivo: <span id="daily-fat-mono-goal"></span> g | <span id="weekly-fat-mono-diff" class="diff-value"></span>)</i></p></div><div class="vitamin-weekly-summary"><h4>Grassi Polinsaturi</h4><p>Totale: <span id="weekly-fat-poly-total">0</span> / <span id="weekly-fat-poly-goal"></span> g</p><progress id="weekly-progress-fat-poly" value="0"></progress><p><i>Media giornaliera: <span id="weekly-fat-poly-avg">0.0</span> g (Obiettivo: <span id="daily-fat-poly-goal"></span> g | <span id="weekly-fat-poly-diff" class="diff-value"></span>)</i></p></div><div class="vitamin-weekly-summary"><h4>Omega 3</h4><p>Totale: <span id="weekly-fat-omega3-total">0</span> / <span id="weekly-fat-omega3-goal"></span> g</p><progress id="weekly-progress-fat-omega3" value="0"></progress><p><i>Media giornaliera: <span id="weekly-fat-omega3-avg">0.0</span> g (Obiettivo: <span id="daily-fat-omega3-goal"></span> g | <span id="weekly-fat-omega3-diff" class="diff-value"></span>)</i></p></div><div class="vitamin-weekly-summary"><h4>Omega 6</h4><p>Totale: <span id="weekly-fat-omega6-total">0</span> / <span id="weekly-fat-omega6-goal"></span> g</p><progress id="weekly-progress-fat-omega6" value="0"></progress><p><i>Media giornaliera: <span id="weekly-fat-omega6-avg">0.0</span> g (Obiettivo: <span id="daily-fat-omega6-goal"></span> g | <span id="weekly-fat-omega6-diff" class="diff-value"></span>)</i></p></div><p style="text-align: center; font-weight: bold; margin-top: 15px; font-size: 1.2em; border-top: 1px solid #eee; padding-top: 15px;">Rapporto O6:O3 Settimanale: <span id="weekly-omega-ratio-value">N/D</span></p></div></div>
    <div id="nutrient-detail-modal" class="modal"><div class="modal-content"><span class="modal-close" data-modal="nutrient-detail-modal">&times;</span><h2 id="nutrient-detail-modal-title"></h2><ul id="nutrient-detail-modal-list"></ul></div></div>
    <div id="amino-acid-modal" class="modal"><div class="modal-content"><span class="modal-close" data-modal="amino-acid-modal">&times;</span><h2 id="modal-amino-title">Dettaglio Amminoacidi</h2><div id="modal-amino-summary" style="text-align: center; margin-bottom: 20px;"></div><div id="modal-amino-content" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;"><div><p>Leucina: <span id="modal-amino-leu-total">0</span> / <span id="modal-amino-leu-goal"></span> mg</p><progress id="modal-amino-leu-progress" value="0" style="width:100%"></progress><p>Isoleucina: <span id="modal-amino-iso-total">0</span> / <span id="modal-amino-iso-goal"></span> mg</p><progress id="modal-amino-iso-progress" value="0" style="width:100%"></progress><p>Valina: <span id="modal-amino-val-total">0</span> / <span id="modal-amino-val-goal"></span> mg</p><progress id="modal-amino-val-progress" value="0" style="width:100%"></progress><p>Lisina: <span id="modal-amino-lys-total">0</span> / <span id="modal-amino-lys-goal"></span> mg</p><progress id="modal-amino-lys-progress" value="0" style="width:100%"></progress></div><div><p>Metionina: <span id="modal-amino-met-total">0</span> / <span id="modal-amino-met-goal"></span> mg</p><progress id="modal-amino-met-progress" value="0" style="width:100%"></progress><p>Fenilalanina: <span id="modal-amino-phe-total">0</span> / <span id="modal-amino-phe-goal"></span> mg</p><progress id="modal-amino-phe-progress" value="0" style="width:100%"></progress><p>Treonina: <span id="modal-amino-thr-total">0</span> / <span id="modal-amino-thr-goal"></span> mg</p><progress id="modal-amino-thr-progress" value="0" style="width:100%"></progress><p>Triptofano: <span id="modal-amino-trp-total">0</span> / <span id="modal-amino-trp-goal"></span> mg</p><progress id="modal-amino-trp-progress" value="0" style="width:100%"></progress></div></div><div style="margin-top: 15px;"><p>Istidina: <span id="modal-amino-his-total">0</span> / <span id="modal-amino-his-goal"></span> mg</p><progress id="modal-amino-his-progress" value="0" style="width:100%"></progress></div></div></div>
    <div id="ingredient-modal" class="modal"><div class="modal-content"><span class="modal-close" data-modal="ingredient-modal">&times;</span><div id="ingredient-modal-header"><h2 id="ingredient-modal-title"></h2><div id="ingredient-modal-actions"><button id="btn-clear-ingredients" title="Cancella tutto"><i class="fas fa-eraser"></i></button><button id="btn-photo-ingredients" title="Acquisisci da foto"><i class="fas fa-camera"></i></button><button id="btn-generate-ingredients-ai" title="Genera o Pulisci con AI">ü™Ñ</button><button id="btn-copy-ingredients-prompt" title="Copia prompt per AI">üìã</button></div></div><input type="file" id="ingredient-photo-input" accept="image/*" style="display: none;"><p id="ocr-status-ingredients" style="text-align: center; color: #888; display: none;"></p><textarea id="ingredient-modal-textarea" placeholder="Inserisci o fotografa la lista ingredienti qui..."></textarea><button id="btn-save-ingredients" style="width: 100%; margin-top: 15px; background-color: #2e7d32;">Salva Ingredienti</button></div></div>
    <div id="nutrient-confirm-modal" class="modal"><div class="modal-content"><span class="modal-close" data-modal="nutrient-confirm-modal">&times;</span><h2>Conferma Dati Nutrizionali</h2><p>Controlla e correggi i valori estratti dalla foto prima di confermare.</p><div id="nutrient-confirm-list"><p id="ocr-status-nutrients" style="text-align: center; color: #888; display: block;">In attesa di una foto...</p></div><div class="nutrient-confirm-buttons"><button id="btn-cancel-nutrients" style="background-color: #607d8b;">Annulla</button><button id="btn-confirm-nutrients" style="background-color: #2e7d32;">Conferma e Compila</button></div></div></div><input type="file" id="nutrient-photo-input" accept="image/*" style="display: none;">
    <div id="barcode-scanner-modal" class="modal"><div class="modal-content"><span class="modal-close" data-modal="barcode-scanner-modal">&times;</span><h2>Scansiona Codice a Barre</h2><p style="text-align: center;">Inquadra il codice a barre del prodotto.</p><div id="scanner-container" style="position: relative; width: 100%; padding-top: 75%;"><video id="barcode-scanner-video" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 1px solid #ccc; border-radius: 8px;"></video><div id="scanner-overlay" style="position: absolute; top: 50%; left: 50%; width: 80%; height: 2px; background-color: red; transform: translate(-50%, -50%); box-shadow: 0 0 10px red;"></div></div><p id="barcode-scanner-status" style="text-align: center; margin-top: 15px; font-weight: bold; min-height: 20px;"></p></div></div>
    <div id="diff-modal" class="modal"><div class="modal-content"><span class="modal-close" data-modal="diff-modal">&times;</span><h2 id="diff-modal-title">Confronta Valori Nutrizionali</h2><p>Sono state trovate differenze significative. Scegli quali valori mantenere per ogni nutriente.</p><div id="diff-modal-list" style="max-height: 50vh; overflow-y: auto; padding: 10px; border: 1px solid #eee; border-radius: 8px; margin-top: 15px;"></div><div class="nutrient-confirm-buttons" style="margin-top: 20px;"><button id="btn-cancel-diff" style="background-color: #607d8b;">Annulla</button><button id="btn-apply-diff" style="background-color: #2e7d32;">Applica Modifiche</button></div></div></div>

   <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js" type="module"></script> 
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-functions.js" type="module"></script> 
    <script type="module">
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-functions.js"
        window.httpsCallable = httpsCallable; // Esporta per la chat AI;
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
        
        let functions;
        const firebaseConfig = {
          apiKey: "AIzaSyA5pSzpfq1aGZ1wjNV5-eXnIqWL6brl424",
          authDomain: "mio-tracker.firebaseapp.com",
          databaseURL: "https://mio-tracker-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "mio-tracker",
          storageBucket: "mio-tracker.firebasestorage.app",
          messagingSenderId: "382993217593",
          appId: "1:382993217593:web:f0780aa061c23f9503f5e8"
        };

        let giornoVisualizzato = getTodayString('ymd');
        let datiGiornalieri = {};
        let foodDatabase = {};
        let pastoInCostruzione = [];
        
        let db; 
        let auth; 
        let firebaseApp; 
        let currentUserUID = null; 

        const PIANO_SETTIMANALE = {
            0: { tipo: 'üíß Riposo (Deficit)', cal_base: 2300, prot: 140, carb: 300, zuccheri: 25 },
            1: { tipo: 'üî• Bicipiti', cal_base: 2300, prot: 140, carb: 300, zuccheri: 25 },
            2: { tipo: 'üí™ Gambe', cal_base: 2300, prot: 140, carb: 300, zuccheri: 25 },
            3: { tipo: 'üèÉ Spalle', cal_base: 2300, prot: 140, carb: 300, zuccheri: 25 },
            4: { tipo: 'üèãÔ∏è Addominali', cal_base: 2300, prot: 140, carb: 300, zuccheri: 25 },
            5: { tipo: 'üèÉ Schiena', cal_base: 2300, prot: 140, carb: 300, zuccheri: 25 },
            6: { tipo: 'ü•ó Total body leggero o cardio', cal_base: 2300, prot: 140, carb: 300, zuccheri: 25 }
        };

        const DEFICIT_PREIMPOSTATO_SETTIMANALE = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0 };

        const OBIETTIVI_MICRO = { mg: 420, k: 3400, vitc: 90, ca: 1000, fe: 18, zn: 11, cu: 0.9, p: 700, na: 2000 };
        const OBIETTIVI_FAT = { 
            fatTotal: 85, fatSat: 20, fatTrans: 2, 
            fatUnsat: 65, fatMono: 45, fatPoly: 20, 
            omega3: 2, omega6: 10 
        };
        const OBIETTIVI_FIBRE = { fibreTotali: 30, fibreSolubili: 10, fibreInsolubili: 20 };
        const OBIETTIVI_VIT = { vitA: 900, vitB12: 2.4, vitD: 15, vitE: 15, vitK: 120, b9: 400, b2: 1.3, b6: 1.3 };
        
        const OBIETTIVI_AMINO = {
            leu: 2900, iso: 1500, val: 1900, 
            lys: 2200, met: 1100, phe: 1800, 
            thr: 1100, trp: 300,  his: 750 
        };

        const PROFILO_AMINOACIDICO_RIFERIMENTO = {
            leu: 59, iso: 30, val: 39,
            lys: 45, met: 22, phe: 38,
            thr: 23, trp: 6.0, his: 15
        };

        const OBIETTIVI_MACRO_PASTO_BASE_FORZA = {
            merenda1: { prot: 30, cal_perc: 0.20 },
            pranzo: { prot: 40, cal_perc: 0.35 },
            merenda2: { prot: 30, cal_perc: 0.15 },
            cena: { prot: 40, cal_perc: 0.30 }
        };
        const totalProtForza = Object.values(OBIETTIVI_MACRO_PASTO_BASE_FORZA).reduce((sum, p) => sum + p.prot, 0);
        for (const mealType in OBIETTIVI_MACRO_PASTO_BASE_FORZA) {
            OBIETTIVI_MACRO_PASTO_BASE_FORZA[mealType].prot_perc = OBIETTIVI_MACRO_PASTO_BASE_FORZA[mealType].prot / totalProtForza;
        }

        const MEAL_TYPE_SEQUENCE = ['merenda1', 'pranzo', 'merenda2', 'cena'];
        const LOCAL_STORAGE_SYNC_KEYS = ['trackerFoodDatabase', 'trackerPesate', 'trackerMealType', 'trackerPastoInCostruzione'];
        const LOCAL_LAST_UPDATE_KEY = 'lastLocalUpdateTimestamp';
        const CLOUD_LAST_UPDATE_PATH = 'lastCloudUpdateTimestamp';

        // AGGIORNATO: Aggiunto "na" (sodio) al prompt
        const GEMINI_PROMPT_FORMAT = `{"prot":g,"kcal":kcal,"carb":g,"zuccheri":g,"fatSat":g,"fatTrans":g,"fatMono":g,"fatPoly":g,"omega3":g,"omega6":g,"fibreTotali":g,"fibreSolubili":g,"fibreInsolubili":g,"na":mg,"mg":mg,"k":mg,"vitc":mg,"ca":mg,"vitA":¬µg,"vitB12":¬µg,"vitD":¬µg,"vitE":mg,"vitK":¬µg,"b9":¬µg,"b2":mg,"b6":mg,"fe":mg,"zn":mg,"cu":mg,"p":mg,"leu":mg,"iso":mg,"val":mg,"lys":mg,"met":mg,"phe":mg,"thr":mg,"trp":mg,"his":mg}`;
        const AI_INSTRUCTION = "Agisci come un esperto nutrizionista. Basa le tue risposte su database nutrizionali affidabili (come IEO, USDA, CREA). Se un valore non √® disponibile, fornisci una stima scientificamente plausibile. Devi rispondere OBBLIGATORIAMENTE in formato JSON valido, perch√© la richiesta √® impostata con 'response_format: json_object'. Per gli amminoacidi, fornisci un profilo specifico per la fonte proteica dell'alimento. Assicurati che le unit√† di misura siano corrette come specificato nel formato JSON richiesto. Se trovi sale o sodio, usa la chiave 'na' in mg.";

        const authSection = document.getElementById('auth-section');
        const userEmailInput = document.getElementById('user-email');
        const userPasswordInput = document.getElementById('user-password');
        const btnRegister = document.getElementById('btn-register');
        const btnLogin = document.getElementById('btn-login');
        const btnSignOut = document.getElementById('btn-sign-out');
        const authStatusP = document.getElementById('auth-status');
        const welcomeMessage = document.getElementById('welcome-message');
        const authFormFields = document.getElementById('auth-form-fields');
        const mainTrackerContent = document.getElementById('main-tracker-content');
        const titoloGiornataEl = document.getElementById('titolo-giornata');
        const logBody = document.getElementById('log-body');
        const suggestionsContainer = document.getElementById('custom-suggestions');
        const btnAggiungiSingolo = document.getElementById('btn-aggiungi-singolo');
        const btnCostruisciPasto = document.getElementById('btn-costruisci-pasto');
        const mealBuilderSezione = document.getElementById('meal-builder-sezione');
        const logPastoBuilderBody = document.getElementById('log-pasto-builder-body');
        const btnSalvaPasto = document.getElementById('btn-salva-pasto');
        const mealTypeSelector = document.getElementById('meal-type-selector');
        const dataCaricamentoInput = document.getElementById('data-caricamento');
        const calorieBalanceText = document.getElementById('calorie-balance-text');
        const calorieAdjustmentInput = document.getElementById('calorie-adjustment-input');
        const btnCalorieMinus = document.getElementById('btn-calorie-minus');
        const btnCaloriePlus = document.getElementById('btn-calorie-plus');
        const btnDownloadManual = document.getElementById('btn-download-manual');
        const cloudSyncStatusSpan = document.getElementById('cloud-sync-status');
        const cloudSyncSection = document.querySelector('.cloud-sync-section');
        const btnCopyPrompt = document.getElementById('btn-copy-prompt');
        const manualJsonInput = document.getElementById('manual-json-input');
        const btnConfirmJson = document.getElementById('btn-confirm-json');
        const btnClearNutrients = document.getElementById('btn-clear-nutrients');
        const weeklyVitaminModal = document.getElementById('weekly-vitamin-modal');
        const infoVitSettimanaliBtn = document.getElementById('info-vit-settimanali');
        const weeklyFatsModal = document.getElementById('weekly-fats-modal');
        const infoFatsSettimanaliBtn = document.getElementById('info-fats-settimanali');
        const nutrientDetailModal = document.getElementById('nutrient-detail-modal');
        const nutrientDetailTitle = document.getElementById('nutrient-detail-modal-title');
        const nutrientDetailList = document.getElementById('nutrient-detail-modal-list');
        const builderDesc = document.getElementById('builder-desc'), builderQta = document.getElementById('builder-qta');
        const builderProt = document.getElementById('builder-prot'), builderKcal = document.getElementById('builder-kcal');
        const builderCarb = document.getElementById('builder-carb'), builderZuccheri = document.getElementById('builder-zuccheri');
        const builderFatTotal = document.getElementById('builder-fat-total');
        const builderFibreTotali = document.getElementById('builder-fibre-totali');
        const builderFibreSolubili = document.getElementById('builder-fibre-solubili');
        const builderFibreInsolubili = document.getElementById('builder-fibre-insolubili');
        const builderFatSat = document.getElementById('builder-fat-sat'), builderFatTrans = document.getElementById('builder-fat-trans'), builderFatMono = document.getElementById('builder-fat-mono'), builderFatPoly = document.getElementById('builder-fat-poly'), builderOmega3 = document.getElementById('builder-omega3'), builderOmega6 = document.getElementById('builder-omega6');
        const builderNa = document.getElementById('builder-na'), builderMg = document.getElementById('builder-mg'), builderK = document.getElementById('builder-k'), builderVitC = document.getElementById('builder-vitc'), builderCa = document.getElementById('builder-ca');
        const builderVitA = document.getElementById('builder-vit-a'), builderVitB12 = document.getElementById('builder-vit-b12'), builderVitD = document.getElementById('builder-vit-d');
        const builderVitE = document.getElementById('builder-vit-e'), builderVitK = document.getElementById('builder-vit-k'), builderB9 = document.getElementById('builder-b9');
        const builderB2 = document.getElementById('builder-b2'), builderB6 = document.getElementById('builder-b6');
        const builderFe = document.getElementById('builder-fe'), builderZn = document.getElementById('builder-zn'), builderCu = document.getElementById('builder-cu'), builderP = document.getElementById('builder-p');
        const builderLeu = document.getElementById('builder-leu'), builderIso = document.getElementById('builder-iso'), builderVal = document.getElementById('builder-val');
        const builderLys = document.getElementById('builder-lys'), builderMet = document.getElementById('builder-met'), builderPhe = document.getElementById('builder-phe');
        const builderThr = document.getElementById('builder-thr'), builderTrp = document.getElementById('builder-trp'), builderHis = document.getElementById('builder-his');
        const dailyNotesTextarea = document.getElementById('daily-notes');
        const btnEditIngredients = document.getElementById('btn-edit-ingredients');
        const btnEditName = document.getElementById('btn-edit-name');
        const ingredientModal = document.getElementById('ingredient-modal');
        const ingredientModalTitle = document.getElementById('ingredient-modal-title');
        const ingredientModalTextarea = document.getElementById('ingredient-modal-textarea');
        const ingredientModalActions = document.getElementById('ingredient-modal-actions');
        const btnGenerateIngredientsAi = document.getElementById('btn-generate-ingredients-ai');
        const btnCopyIngredientsPrompt = document.getElementById('btn-copy-ingredients-prompt');
        const btnSaveIngredients = document.getElementById('btn-save-ingredients');
        const btnClearIngredients = document.getElementById('btn-clear-ingredients');
        const btnPhotoIngredients = document.getElementById('btn-photo-ingredients');
        const ingredientPhotoInput = document.getElementById('ingredient-photo-input');
        const ocrStatusIngredients = document.getElementById('ocr-status-ingredients');
        const btnPhotoNutrients = document.getElementById('btn-photo-nutrients');
        const nutrientPhotoInput = document.getElementById('nutrient-photo-input');
        const nutrientConfirmModal = document.getElementById('nutrient-confirm-modal');
        const nutrientConfirmList = document.getElementById('nutrient-confirm-list');
        const btnConfirmNutrients = document.getElementById('btn-confirm-nutrients');
        const btnCancelNutrients = document.getElementById('btn-cancel-nutrients');
        const ocrStatusNutrients = document.getElementById('ocr-status-nutrients');
        const photoOcrStatus = document.getElementById('photo-ocr-status');
        const btnScanBarcode = document.getElementById('btn-scan-barcode');
        const barcodeScannerModal = document.getElementById('barcode-scanner-modal');
        const barcodeScannerVideo = document.getElementById('barcode-scanner-video');
        const barcodeScannerStatus = document.getElementById('barcode-scanner-status');
        const diffModal = document.getElementById('diff-modal');
        let videoStream = null;

        const inputFields = {
            prot: { el: builderProt, label: 'Proteine/100g' },
            kcal: { el: builderKcal, label: 'Kcal/100g' },
            carb: { el: builderCarb, label: 'Carboidrati/100g' },
            zuccheri: { el: builderZuccheri, label: 'Zuccheri/100g' },
            fatTotal: { el: builderFatTotal, label: 'Grassi Totali/100g' },
            fatSat: { el: builderFatSat, label: 'Gr. Saturi/100g' },
            fatTrans: { el: builderFatTrans, label: 'Gr. Trans/100g' },
            fatMono: { el: builderFatMono, label: 'Gr. Monoinsaturi/100g' },
            fatPoly: { el: builderFatPoly, label: 'Gr. Polinsaturi/100g' },
            omega3: { el: builderOmega3, label: 'Omega 3/100g' },
            omega6: { el: builderOmega6, label: 'Omega 6/100g' },
            fibreTotali: { el: builderFibreTotali, label: 'Fibre Totali/100g' },
            fibreSolubili: { el: builderFibreSolubili, label: 'Fibre Solubili/100g' },
            fibreInsolubili: { el: builderFibreInsolubili, label: 'Fibre Insolubili/100g' },
            na: { el: builderNa, label: 'Sodio (mg)/100g' }, 
            mg: { el: builderMg, label: 'Magnesio (mg)/100g' },
            k: { el: builderK, label: 'Potassio (mg)/100g' },
            vitc: { el: builderVitC, label: 'Vitamina C (mg)/100g' },
            ca: { el: builderCa, label: 'Calcio (mg)/100g' },
            fe: { el: builderFe, label: 'Ferro (mg)/100g' },
            zn: { el: builderZn, label: 'Zinco (mg)/100g' },
            cu: { el: builderCu, label: 'Rame (mg)/100g' },
            p: { el: builderP, label: 'Fosforo (mg)/100g' },
            vitA: { el: builderVitA, label: 'Vit. A (Œºg)/100g' },
            vitB12: { el: builderVitB12, label: 'Vit. B12 (Œºg)/100g' },
            vitD: { el: builderVitD, label: 'Vit. D (Œºg)/100g' },
            vitE: { el: builderVitE, label: 'Vit. E (mg)/100g' },
            vitK: { el: builderVitK, label: 'Vit. K (Œºg)/100g' },
            b9: { el: builderB9, label: 'Folati B9 (Œºg)/100g' },
            b2: { el: builderB2, label: 'Vit. B2 (mg)/100g' },
            b6: { el: builderB6, label: 'Vit. B6 (mg)/100g' },
            leu: { el: builderLeu, label: 'Leucina (mg)/100g' },
            iso: { el: builderIso, label: 'Isoleucina (mg)/100g' },
            val: { el: builderVal, label: 'Valina (mg)/100g' },
            lys: { el: builderLys, label: 'Lisina (mg)/100g' },
            met: { el: builderMet, label: 'Metionina (mg)/100g' },
            phe: { el: builderPhe, label: 'Fenilalanina (mg)/100g' },
            thr: { el: builderThr, label: 'Treonina (mg)/100g' },
            trp: { el: builderTrp, label: 'Triptofano (mg)/100g' },
            his: { el: builderHis, label: 'Istidina (mg)/100g' }
        };

        const spanTotaleProteine = document.getElementById('totale-proteine'), spanObiettivoProteine = document.getElementById('obiettivo-proteine'), progressProteine = document.getElementById('progress-proteine');
        const spanTotaleCalorie = document.getElementById('totale-calorie'), spanObiettivoCalorie = document.getElementById('obiettivo-calorie'), progressCalorie = document.getElementById('progress-calorie');
        const spanTotaleCarboidrati = document.getElementById('totale-carboidrati'), spanObiettivoCarboidrati = document.getElementById('obiettivo-carboidrati'), progressCarboidrati = document.getElementById('progress-carboidrati');
        const spanTotaleZuccheri = document.getElementById('totale-zuccheri'), spanObiettivoZuccheri = document.getElementById('obiettivo-zuccheri'), progressZuccheri = document.getElementById('progress-zuccheri');
        const spanWorkoutCalories = document.getElementById('workout-calories-totali');
        const spanTotaleFibreTotali = document.getElementById('totale-fibre-totali'), spanObiettivoFibreTotali = document.getElementById('obiettivo-fibre-totali'), progressFibreTotali = document.getElementById('progress-fibre-totali');
        const spanTotaleFibreSolubili = document.getElementById('totale-fibre-solubili'), spanObiettivoFibreSolubili = document.getElementById('obiettivo-fibre-solubili'), progressFibreSolubili = document.getElementById('progress-fibre-solubili');
        const spanTotaleFibreInsolubili = document.getElementById('totale-fibre-insolubili'), spanObiettivoFibreInsolubili = document.getElementById('obiettivo-fibre-insolubili'), progressFibreInsolubili = document.getElementById('progress-fibre-insolubili');
        const spanTotaleFatsTotal = document.getElementById('totale-fats-total'), spanObiettivoFatsTotal = document.getElementById('obiettivo-fats-total'), progressFatsTotal = document.getElementById('progress-fats-total');
        const spanTotaleFatSat = document.getElementById('totale-fat-sat'), spanObiettivoFatSat = document.getElementById('obiettivo-fat-sat'), progressFatSat = document.getElementById('progress-fat-sat');
        const spanTotaleFatTrans = document.getElementById('totale-fat-trans'), spanObiettivoFatTrans = document.getElementById('obiettivo-fat-trans'), progressFatTrans = document.getElementById('progress-fat-trans');
        const spanTotaleFatUnsat = document.getElementById('totale-fat-unsat'), spanObiettivoFatUnsat = document.getElementById('obiettivo-fat-unsat'), progressFatUnsat = document.getElementById('progress-fat-unsat');
        const spanTotaleFatMono = document.getElementById('totale-fat-mono'), spanObiettivoFatMono = document.getElementById('obiettivo-fat-mono'), progressFatMono = document.getElementById('progress-fat-mono');
        const spanTotaleFatPoly = document.getElementById('totale-fat-poly'), spanObiettivoFatPoly = document.getElementById('obiettivo-fat-poly'), progressFatPoly = document.getElementById('progress-fat-poly');
        const spanTotaleOmega3 = document.getElementById('totale-omega3'), spanObiettivoOmega3 = document.getElementById('obiettivo-omega3'), progressOmega3 = document.getElementById('progress-omega3');
        const spanTotaleOmega6 = document.getElementById('totale-omega6'), spanObiettivoOmega6 = document.getElementById('obiettivo-omega6'), progressOmega6 = document.getElementById('progress-omega6');
        const omegaRatioValueEl = document.getElementById('omega-ratio-value');
        const spanTotaleMg = document.getElementById('totale-mg'), progressMg = document.getElementById('progress-mg');
        const spanTotaleK = document.getElementById('totale-k'), progressK = document.getElementById('progress-k');
        const spanTotaleCa = document.getElementById('totale-ca'), progressCa = document.getElementById('progress-ca');
        const spanTotaleFe = document.getElementById('totale-fe'), progressFe = document.getElementById('progress-fe');
        const spanTotaleZn = document.getElementById('totale-zn'), progressZn = document.getElementById('progress-zn');
        const spanTotaleCu = document.getElementById('totale-cu'), progressCu = document.getElementById('progress-cu');
        const spanTotaleP = document.getElementById('totale-p'), progressP = document.getElementById('progress-p');
        const spanTotaleVitC = document.getElementById('totale-vitc'), progressVitC = document.getElementById('progress-vitc');
        const spanTotaleVitA = document.getElementById('totale-vit-a'), progressVitA = document.getElementById('progress-vit-a');
        const spanTotaleVitB12 = document.getElementById('totale-vit-b12'), progressVitB12 = document.getElementById('progress-vit-b12');
        const spanTotaleVitD = document.getElementById('totale-vit-d'), progressVitD = document.getElementById('progress-vit-d');
        const spanTotaleVitE = document.getElementById('totale-vit-e'), progressVitE = document.getElementById('progress-vit-e');
        const spanTotaleVitK = document.getElementById('totale-vit-k'), progressVitK = document.getElementById('progress-vit-k');
        const spanTotaleB9 = document.getElementById('totale-b9'), progressB9 = document.getElementById('progress-b9');
        const spanTotaleB2 = document.getElementById('totale-b2'), progressB2 = document.getElementById('progress-b2');
        const spanTotaleB6 = document.getElementById('totale-b6'), progressB6 = document.getElementById('progress-b6');
        const currentMealTypeDisplay = document.getElementById('current-meal-type-display');
        const mealProtCurrent = document.getElementById('meal-prot-current'), mealProtTarget = document.getElementById('meal-prot-target'), mealProtRemaining = document.getElementById('meal-prot-remaining');
        const mealCalCurrent = document.getElementById('meal-cal-current'), mealCalTarget = document.getElementById('meal-cal-target'), mealCalRemaining = document.getElementById('meal-cal-remaining');
        const mealProgressProt = document.getElementById('meal-progress-prot'), mealProgressCal = document.getElementById('meal-progress-cal');
        const workoutDescInput = document.getElementById('workout-desc');
        const workoutCaloriesInput = document.getElementById('workout-calories');
        const btnAddWorkout = document.getElementById('btn-add-workout');
        
        function getTodayString(format = 'ymd') { return new Date().toISOString().split('T')[0]; }

        function sanitizeFirebaseKey(str) {
            if (!str) return '';
            return str.replace(/[.#$/\[\]]/g, '_');
        }
        
        async function saveSingleItemToCloud(path, data) {
            const dataRef = (db && currentUserUID) ? ref(db, `users/${currentUserUID}/tracker_data/${path}`) : null;
            if (!dataRef) return;
            try {
                await set(dataRef, data);
                await set(ref(db, `users/${currentUserUID}/${CLOUD_LAST_UPDATE_PATH}`), Date.now());
                console.log(`Dato salvato su cloud in: ${path}`);
            } catch (err) {
                console.error(`Errore salvataggio su cloud per ${path}:`, err);
            }
        }
        
        function salvaFoodDatabase() { 
            localStorage.setItem('trackerFoodDatabase', JSON.stringify(foodDatabase)); 
            localStorage.setItem(LOCAL_LAST_UPDATE_KEY, Date.now()); 
            
            const sanitizedDb = {};
            for (const key in foodDatabase) {
                sanitizedDb[sanitizeFirebaseKey(key)] = foodDatabase[key];
            }
            saveSingleItemToCloud('trackerFoodDatabase', sanitizedDb);
        }
        
        function salvaPastoInCostruzione() { 
            localStorage.setItem('trackerPastoInCostruzione', JSON.stringify(pastoInCostruzione)); 
            localStorage.setItem(LOCAL_LAST_UPDATE_KEY, Date.now()); 
            saveSingleItemToCloud('trackerPastoInCostruzione', pastoInCostruzione);
        }
        
        function salvaGiorno(dataDaSalvare, datiDaSalvare) {
            if (!datiDaSalvare) datiDaSalvare = datiGiornalieri;
            datiDaSalvare.note = dailyNotesTextarea.value;
            datiDaSalvare.data = dataDaSalvare;
            const key = `trackerStorico_${dataDaSalvare}`;
            localStorage.setItem(key, JSON.stringify(datiDaSalvare));
            localStorage.setItem(LOCAL_LAST_UPDATE_KEY, Date.now());
            console.log(`Dati salvati LOCALMENTE per il giorno: ${dataDaSalvare}`);
            saveSingleItemToCloud(key, datiDaSalvare);
        }
        
        function caricaGiorno(data) {
            giornoVisualizzato = data;
            dataCaricamentoInput.value = data;

            let datiTrovati = null;
            let rawDataFromLocalStorage = localStorage.getItem(`trackerStorico_${data}`);
            try {
                datiTrovati = JSON.parse(rawDataFromLocalStorage);
                 if (datiTrovati && datiTrovati.log) {
                    datiTrovati.log.forEach(entry => {
                        const items = entry.type === 'meal' ? entry.items : [entry];
                        items.forEach(item => {
                            if (item && item.cal && !item.kcal) {
                                item.kcal = item.cal;
                                delete item.cal;
                            }
                        });
                    });
                }
            } catch (e) {
                console.error(`Errore nel parsing di trackerStorico_${data}:`, e, "Raw data:", rawDataFromLocalStorage);
            }
            
            datiGiornalieri = datiTrovati || { log: [], workoutCalorie: 0, note: '' };
            dailyNotesTextarea.value = datiGiornalieri.note || '';
            if (!datiGiornalieri.log) datiGiornalieri.log = [];
            if (typeof datiGiornalieri.workoutCalorie === 'undefined') datiGiornalieri.workoutCalorie = 0;

            const dataCorrente = new Date(data);
            const giornoSettimana = dataCorrente.getDay(); 
            const valorePreimpostatoPerGiorno = DEFICIT_PREIMPOSTATO_SETTIMANALE[giornoSettimana] || 0;

            if (typeof datiGiornalieri.calorieAdjustment === 'undefined' || datiGiornalieri.calorieAdjustment === 0) {
                datiGiornalieri.calorieAdjustment = valorePreimpostatoPerGiorno;
            }
            
            aggiornaUI();
            console.log(`Caricato il giorno: ${giornoVisualizzato} da localStorage`); 
        }

        function calcolaObiettiviPasto(mealType, giornoCorrenteString) {
            const dataVisualizzata = new Date(giornoCorrenteString);
            const giornoSettimana = dataVisualizzata.getDay();
            const pianoDelGiorno = PIANO_SETTIMANALE[giornoSettimana] || PIANO_SETTIMANALE[1];

            const obiettivoCalTotaleGiornaliero = pianoDelGiorno.cal_base + (datiGiornalieri.workoutCalorie || 0) + (datiGiornalieri.calorieAdjustment || 0);
            const obiettivoProtTotaleGiornaliero = pianoDelGiorno.prot;

            let obiettivoPastoProt = 0, obiettivoPastoCal = 0;
            const calRatio = OBIETTIVI_MACRO_PASTO_BASE_FORZA[mealType]?.cal_perc ?? 0;
            const protRatio = OBIETTIVI_MACRO_PASTO_BASE_FORZA[mealType]?.prot_perc ?? 0;

            if (mealType === 'cena') {
                let consumatoProtAltriPasti = 0, consumatoCalAltriPasti = 0;
                (datiGiornalieri.log || []).forEach(entry => {
                    if (entry.mealId && entry.mealId !== 'cena') {
                        const items = entry.type === 'meal' ? entry.items : [entry];
                        items.forEach(item => {
                           consumatoProtAltriPasti += item.prot || 0;
                           consumatoCalAltriPasti += (item.kcal || item.cal) || 0;
                        });
                    }
                });
                obiettivoPastoProt = Math.max(0, Math.round(obiettivoProtTotaleGiornaliero - consumatoProtAltriPasti));
                obiettivoPastoCal = Math.max(0, Math.round(obiettivoCalTotaleGiornaliero - consumatoCalAltriPasti));
            } else {
                obiettivoPastoProt = Math.round(obiettivoProtTotaleGiornaliero * protRatio);
                obiettivoPastoCal = Math.round(obiettivoCalTotaleGiornaliero * calRatio);
            }
            
            const totaliPastoInCostruzione = pastoInCostruzione.reduce((acc, item) => {
                acc.prot += item.prot || 0; acc.kcal += (item.kcal || item.cal) || 0; return acc;
            }, { prot: 0, kcal: 0 });

            return {
                currentProt: totaliPastoInCostruzione.prot, targetProt: obiettivoPastoProt, remainingProt: obiettivoPastoProt - totaliPastoInCostruzione.prot,
                currentCal: totaliPastoInCostruzione.kcal, targetCal: obiettivoPastoCal, remainingCal: obiettivoPastoCal - totaliPastoInCostruzione.kcal
            };
        }

        function initAppUI() {
            foodDatabase = JSON.parse(localStorage.getItem('trackerFoodDatabase')) || {};
            pastoInCostruzione = JSON.parse(localStorage.getItem('trackerPastoInCostruzione')) || [];
            pastoInCostruzione.forEach(item => {
                if (item.cal && !item.kcal) {
                    item.kcal = item.cal;
                    delete item.cal;
                }
            });
            renderMealBuilder();
            caricaGiorno(getTodayString());
            
            if (mealTypeSelector) { 
                const lastMealTypeSelected = localStorage.getItem('lastMealTypeSelected_' + getTodayString());
                mealTypeSelector.value = (lastMealTypeSelected && MEAL_TYPE_SEQUENCE.includes(lastMealTypeSelected)) ? lastMealTypeSelected : MEAL_TYPE_SEQUENCE[0];
            }
            console.log("Interfaccia app avviata con successo con dati locali.");
        }

        function aggiornaUI() {
            const dataVisualizzata = new Date(giornoVisualizzato);
            const pianoDelGiorno = PIANO_SETTIMANALE[dataVisualizzata.getDay()] || PIANO_SETTIMANALE[1];
            
            const obiettivoCalorieTotale = pianoDelGiorno.cal_base + (datiGiornalieri.workoutCalorie || 0) + (datiGiornalieri.calorieAdjustment || 0);
            const OBIETTIVI = { 
                prot: pianoDelGiorno.prot, kcal: obiettivoCalorieTotale, carb: pianoDelGiorno.carb, zuccheri: pianoDelGiorno.zuccheri, 
                ...OBIETTIVI_MICRO, ...OBIETTIVI_FAT, ...OBIETTIVI_VIT, ...OBIETTIVI_AMINO, ...OBIETTIVI_FIBRE
            };
            
            titoloGiornataEl.textContent = `${pianoDelGiorno.tipo} - ${dataVisualizzata.toLocaleDateString('it-IT', {day: 'numeric', month: 'long', year: 'numeric'})}`;
            
            let totali = { 
                prot: 0, kcal: 0, carb: 0, zuccheri: 0, fatTotal: 0, fatSat: 0, fatTrans: 0, fatMono: 0, fatPoly: 0, omega3: 0, omega6: 0, 
                na: 0, mg: 0, k: 0, vitc: 0, ca: 0, fe: 0, zn: 0, cu: 0, p: 0, vitA: 0, vitB12: 0, vitD: 0, vitE: 0, vitK: 0, b9: 0, b2: 0, b6: 0,
                leu: 0, iso: 0, val: 0, lys: 0, met: 0, phe: 0, thr: 0, trp: 0, his: 0,
                fibreTotali: 0, fibreSolubili: 0, fibreInsolubili: 0
            };
            
            (datiGiornalieri.log || []).forEach(entry => {
                if (entry.type !== 'workout') {
                    const items = entry.type === 'meal' ? entry.items : [entry];
                    items.forEach(item => {
                        for(const key in totali){
                            totali[key] += item[key] || 0;
                        }
                        if(item.cal && !item.kcal) totali.kcal += item.cal;
                    });
                }
            });

            totali.fatUnsat = totali.fatMono + totali.fatPoly;

            // UPDATE BALANCE BAR
            const sodiumVal = totali.na || 0;
            const potassiumVal = totali.k || 0;
            
            document.getElementById('valore-sodio').textContent = `${sodiumVal.toFixed(0)} mg`;
            document.getElementById('valore-potassio').textContent = `${potassiumVal.toFixed(0)} mg`;

            const balanceMarker = document.getElementById('balance-marker');
            let balancePercentage = 50; 

            if (sodiumVal + potassiumVal > 0) {
                const kRatio = potassiumVal / (sodiumVal + potassiumVal);
                balancePercentage = kRatio * 100;
            }
            
            balancePercentage = Math.max(5, Math.min(95, balancePercentage));
            balanceMarker.style.left = `${balancePercentage}%`;


            spanObiettivoProteine.textContent = OBIETTIVI.prot; spanTotaleProteine.textContent = totali.prot.toFixed(1); progressProteine.max = OBIETTIVI.prot; progressProteine.value = totali.prot;
            spanObiettivoCalorie.textContent = OBIETTIVI.kcal; spanTotaleCalorie.textContent = totali.kcal.toFixed(0); progressCalorie.max = OBIETTIVI.kcal; progressCalorie.value = totali.kcal;
            spanObiettivoCarboidrati.textContent = OBIETTIVI.carb; spanTotaleCarboidrati.textContent = totali.carb.toFixed(1); progressCarboidrati.max = OBIETTIVI.carb; progressCarboidrati.value = totali.carb;
            spanObiettivoZuccheri.textContent = OBIETTIVI.zuccheri; spanTotaleZuccheri.textContent = totali.zuccheri.toFixed(1); progressZuccheri.max = OBIETTIVI.zuccheri; progressZuccheri.value = totali.zuccheri;
            spanWorkoutCalories.textContent = datiGiornalieri.workoutCalorie ? datiGiornalieri.workoutCalorie.toFixed(0) : 0; 
            spanObiettivoFibreTotali.textContent = OBIETTIVI_FIBRE.fibreTotali; spanTotaleFibreTotali.textContent = totali.fibreTotali.toFixed(1); progressFibreTotali.max = OBIETTIVI_FIBRE.fibreTotali; progressFibreTotali.value = totali.fibreTotali;
            spanObiettivoFibreSolubili.textContent = OBIETTIVI_FIBRE.fibreSolubili; spanTotaleFibreSolubili.textContent = totali.fibreSolubili.toFixed(1); progressFibreSolubili.max = OBIETTIVI_FIBRE.fibreSolubili; progressFibreSolubili.value = totali.fibreSolubili;
            spanObiettivoFibreInsolubili.textContent = OBIETTIVI_FIBRE.fibreInsolubili; spanTotaleFibreInsolubili.textContent = totali.fibreInsolubili.toFixed(1); progressFibreInsolubili.max = OBIETTIVI_FIBRE.fibreInsolubili; progressFibreInsolubili.value = totali.fibreInsolubili;
            spanObiettivoFatsTotal.textContent = OBIETTIVI_FAT.fatTotal; spanTotaleFatsTotal.textContent = totali.fatTotal.toFixed(1); progressFatsTotal.max = OBIETTIVI_FAT.fatTotal; progressFatsTotal.value = totali.fatTotal;
            spanObiettivoFatSat.textContent = OBIETTIVI_FAT.fatSat; spanTotaleFatSat.textContent = totali.fatSat.toFixed(1); progressFatSat.max = OBIETTIVI_FAT.fatSat; progressFatSat.value = totali.fatSat;
            spanObiettivoFatTrans.textContent = OBIETTIVI_FAT.fatTrans; spanTotaleFatTrans.textContent = totali.fatTrans.toFixed(1); progressFatTrans.max = OBIETTIVI_FAT.fatTrans; progressFatTrans.value = totali.fatTrans;
            spanObiettivoFatUnsat.textContent = OBIETTIVI_FAT.fatUnsat; spanTotaleFatUnsat.textContent = totali.fatUnsat.toFixed(1); progressFatUnsat.max = OBIETTIVI_FAT.fatUnsat; progressFatUnsat.value = totali.fatUnsat;
            spanObiettivoFatMono.textContent = OBIETTIVI_FAT.fatMono; spanTotaleFatMono.textContent = totali.fatMono.toFixed(1); progressFatMono.max = OBIETTIVI_FAT.fatMono; progressFatMono.value = totali.fatMono;
            spanObiettivoFatPoly.textContent = OBIETTIVI_FAT.fatPoly; spanTotaleFatPoly.textContent = totali.fatPoly.toFixed(1); progressFatPoly.max = OBIETTIVI_FAT.fatPoly; progressFatPoly.value = totali.fatPoly;
            spanObiettivoOmega3.textContent = OBIETTIVI_FAT.omega3; spanTotaleOmega3.textContent = totali.omega3.toFixed(1); progressOmega3.max = OBIETTIVI_FAT.omega3; progressOmega3.value = totali.omega3;
            spanObiettivoOmega6.textContent = OBIETTIVI_FAT.omega6; spanTotaleOmega6.textContent = totali.omega6.toFixed(1); progressOmega6.max = OBIETTIVI_FAT.omega6; progressOmega6.value = totali.omega6;
            spanTotaleMg.textContent = totali.mg.toFixed(1); progressMg.max = OBIETTIVI.mg; progressMg.value = totali.mg;
            spanTotaleK.textContent = totali.k.toFixed(0); progressK.max = OBIETTIVI.k; progressK.value = totali.k;
            spanTotaleCa.textContent = totali.ca.toFixed(1); progressCa.max = OBIETTIVI.ca; progressCa.value = totali.ca;
            spanTotaleFe.textContent = totali.fe.toFixed(1); progressFe.max = OBIETTIVI.fe; progressFe.value = totali.fe;
            spanTotaleZn.textContent = totali.zn.toFixed(1); progressZn.max = OBIETTIVI.zn; progressZn.value = totali.zn;
            spanTotaleCu.textContent = totali.cu.toFixed(2); progressCu.max = OBIETTIVI.cu; progressCu.value = totali.cu;
            spanTotaleP.textContent = totali.p.toFixed(0); progressP.max = OBIETTIVI.p; progressP.value = totali.p;
            spanTotaleVitC.textContent = totali.vitc.toFixed(1); progressVitC.max = OBIETTIVI.vitc; progressVitC.value = totali.vitc;
            spanTotaleVitA.textContent = totali.vitA.toFixed(1); progressVitA.max = OBIETTIVI.vitA; progressVitA.value = totali.vitA;
            spanTotaleVitB12.textContent = totali.vitB12.toFixed(1); progressVitB12.max = OBIETTIVI.vitB12; progressVitB12.value = totali.vitB12;
            spanTotaleVitD.textContent = totali.vitD.toFixed(1); progressVitD.max = OBIETTIVI.vitD; progressVitD.value = totali.vitD;
            spanTotaleVitE.textContent = totali.vitE.toFixed(1); progressVitE.max = OBIETTIVI.vitE; progressVitE.value = totali.vitE;
            spanTotaleVitK.textContent = totali.vitK.toFixed(1); progressVitK.max = OBIETTIVI.vitK; progressVitK.value = totali.vitK;
            spanTotaleB9.textContent = totali.b9.toFixed(1); progressB9.max = OBIETTIVI.b9; progressB9.value = totali.b9;
            spanTotaleB2.textContent = totali.b2.toFixed(2); progressB2.max = OBIETTIVI.b2; progressB2.value = totali.b2;
            spanTotaleB6.textContent = totali.b6.toFixed(2); progressB6.max = OBIETTIVI.b6; progressB6.value = totali.b6;
            
            let ratioText = 'N/D';
            if (totali.omega3 > 0 && totali.omega6 > 0) {
                const ratio = totali.omega6 / totali.omega3;
                ratioText = `${ratio.toFixed(1)}:1`;
                if (ratio >= 3 && ratio <= 6) {
                    omegaRatioValueEl.style.color = '#2e7d32'; 
                } else {
                    omegaRatioValueEl.style.color = '#d32f2f';
                }
            } else {
                omegaRatioValueEl.style.color = '#333';
            }
            omegaRatioValueEl.textContent = ratioText;

            const targetCaloriesForBalanceText = pianoDelGiorno.cal_base + (datiGiornalieri.workoutCalorie || 0);
            const calorieDifference = totali.kcal - targetCaloriesForBalanceText;
            calorieBalanceText.className = '';
            const tolerance = 50;
            if (calorieDifference < -tolerance) { calorieBalanceText.textContent = `Deficit: ${Math.abs(calorieDifference).toFixed(0)} kcal`; calorieBalanceText.classList.add('balance-deficit');
            } else if (calorieDifference > tolerance) { calorieBalanceText.textContent = `Surplus: ${calorieDifference.toFixed(0)} kcal`; calorieBalanceText.classList.add('balance-surplus');
            } else { calorieBalanceText.textContent = `In Pari`; calorieBalanceText.classList.add('balance-even'); }
            calorieAdjustmentInput.value = datiGiornalieri.calorieAdjustment || 0;
            
            document.getElementById('fats-header').classList.toggle('nutrients-warning', totali.fatSat > OBIETTIVI_FAT.fatSat || totali.fatTrans > OBIETTIVI_FAT.fatTrans || totali.fatTotal > OBIETTIVI_FAT.fatTotal);
            document.getElementById('fibre-header').classList.toggle('nutrients-warning', totali.fibreTotali < OBIETTIVI_FIBRE.fibreTotali * 0.8);
            document.getElementById('micro-header').classList.toggle('nutrients-warning', Object.keys(OBIETTIVI_MICRO).some(k => totali[k] < OBIETTIVI_MICRO[k] * 0.5));
            document.getElementById('vit-header').classList.toggle('nutrients-warning', Object.keys(OBIETTIVI_VIT).some(k => totali[k] < OBIETTIVI_VIT[k] * 0.5));
            
            logBody.innerHTML = ''; 
            const nutrientKeys = ['kcal', 'na', 'fibreTotali', 'fibreSolubili', 'fibreInsolubili', ...Object.keys(OBIETTIVI_AMINO), 'fatSat', 'fatTrans', 'fatMono', 'fatPoly', 'omega3', 'omega6', 'mg', 'k', 'vitc', 'ca', 'fe', 'zn', 'cu', 'vitA', 'vitB12', 'vitD', 'vitE', 'vitK', 'b9', 'b2', 'b6', 'p'];
            const formatNumber = (key, value) => {
                const val = value || 0;
                if (Object.keys(OBIETTIVI_AMINO).includes(key) || key === 'na') return val.toFixed(0);
                return ['cu', 'b2', 'b6'].includes(key) ? val.toFixed(2) : (['kcal', 'k', 'p'].includes(key) ? val.toFixed(0) : val.toFixed(1));
            };
            
            const createDescriptionCellHTML = (item) => {
                let html = '';
                if (item.ingredienti && item.ingredienti.trim() !== '') {
                    html += `<span class="ingredient-icon" title="Visualizza ingredienti" data-food-name="${item.desc}">üìú</span>`;
                }
                html += (item.desc || '');
                return html;
            };

            (datiGiornalieri.log || []).forEach((entry, index) => {
                if (entry.type === 'meal') {
                    const rigaPasto = logBody.insertRow();
                    rigaPasto.classList.add('meal-group-row');
                    const totaliPasto = entry.items.reduce((acc, item) => {
                        for (const key in item) if(typeof item[key] === 'number' && key !== 'qta') acc[key] = (acc[key] || 0) + item[key];
                        return acc;
                    }, {});
                    
                    const qualitaPasto = calcolaQualitaProteine(totaliPasto);
                    const scoreClass = qualitaPasto.score < 70 ? 'low' : qualitaPasto.score < 90 ? 'medium' : 'high';
                    const qualitaCellHtml = `<div class="protein-score ${scoreClass}" title="Limitante: ${qualitaPasto.limiting}">${qualitaPasto.score}%</div>`;
                    
                    rigaPasto.innerHTML = `
                        <td><span class="expand-arrow" data-index="${index}">${entry.isExpanded ? '‚ñº' : '‚ñ∂'}</span> ${entry.desc}</td>
                        <td>${entry.items.reduce((sum, item) => sum + item.qta, 0).toFixed(0)}</td>
                        <td>${(totaliPasto.prot || 0).toFixed(1)}</td>
                        <td>${qualitaCellHtml}</td>
                        ${nutrientKeys.map(k => `<td>${formatNumber(k, totaliPasto[k])}</td>`).join('')}
                        <td class="action-buttons"><button class="edit-btn" data-index="${index}">‚úèÔ∏è</button><button class="delete-btn" data-index="${index}">&times;</button></td>`;

                    if (entry.isExpanded) {
                        entry.items.forEach(subItem => {
                            const rigaSubItem = logBody.insertRow();
                            rigaSubItem.classList.add('sub-item-row');
                             const qualitaSubItem = calcolaQualitaProteine(subItem);
                             const subScoreClass = qualitaSubItem.score < 70 ? 'low' : qualitaSubItem.score < 90 ? 'medium' : 'high';
                             const subQualitaCellHtml = `<div class="protein-score ${subScoreClass}" title="Limitante: ${qualitaSubItem.limiting}">${qualitaSubItem.score}%</div>`;
                            rigaSubItem.innerHTML = `
                                <td>${createDescriptionCellHTML(subItem)}</td><td>${(subItem.qta || 0).toFixed(0)}</td>
                                <td>${(subItem.prot || 0).toFixed(1)}</td>
                                <td>${subQualitaCellHtml}</td>
                                ${nutrientKeys.map(k => `<td>${formatNumber(k, subItem[k])}</td>`).join('')}
                                <td></td>`;
                        });
                    }
                } else if (entry.type === 'workout') {
                    const riga = logBody.insertRow();
                    riga.innerHTML = `<td>${entry.desc}</td><td></td><td></td><td></td><td>${(entry.kcal || 0).toFixed(0)}</td><td colspan="${nutrientKeys.length -1}"></td><td class="action-buttons"><button class="delete-btn" data-index="${index}">&times;</button></td>`;
                } else { 
                    const riga = logBody.insertRow();
                    const qualitaSingola = calcolaQualitaProteine(entry);
                    const scoreClass = qualitaSingola.score < 70 ? 'low' : qualitaSingola.score < 90 ? 'medium' : 'high';
                    const qualitaCellHtml = `<div class="protein-score ${scoreClass}" title="Limitante: ${qualitaSingola.limiting}">${qualitaSingola.score}%</div>`;
                    riga.innerHTML = `
                        <td>${createDescriptionCellHTML(entry)}</td><td>${(entry.qta || 0).toFixed(0)}</td>
                        <td>${(entry.prot || 0).toFixed(1)}</td>
                        <td>${qualitaCellHtml}</td>
                        ${nutrientKeys.map(k => `<td>${formatNumber(k, entry[k])}</td>`).join('')}
                        <td class="action-buttons"><button class="edit-btn" data-index="${index}">‚úèÔ∏è</button><button class="delete-btn" data-index="${index}">&times;</button></td>`;
                }
            });
        }

        function renderMealBuilder() {
            mealBuilderSezione.dataset.visible = pastoInCostruzione.length > 0;
            logPastoBuilderBody.innerHTML = ''; 
            const selectedMealType = mealTypeSelector ? mealTypeSelector.value : MEAL_TYPE_SEQUENCE[0]; 
            const selectedMealTypeText = mealTypeSelector?.options[mealTypeSelector.selectedIndex]?.text ?? '';
            const obiettiviPasto = calcolaObiettiviPasto(selectedMealType, giornoVisualizzato);
            const totaliPastoCorrenteSelezionati = pastoInCostruzione.filter(item => item.selezionato !== false).reduce((acc, item) => {
                acc.prot += item.prot || 0; acc.kcal += (item.kcal || item.cal) || 0; return acc;
            }, { prot: 0, kcal: 0 });
            currentMealTypeDisplay.textContent = selectedMealTypeText;
            mealProtCurrent.textContent = totaliPastoCorrenteSelezionati.prot.toFixed(1);
            mealProtTarget.textContent = obiettiviPasto.targetProt.toFixed(0);
            mealProtRemaining.textContent = `${(obiettiviPasto.targetProt - totaliPastoCorrenteSelezionati.prot).toFixed(1)} g`;
            mealProgressProt.max = obiettiviPasto.targetProt;
            mealProgressProt.value = totaliPastoCorrenteSelezionati.prot;
            mealCalCurrent.textContent = totaliPastoCorrenteSelezionati.kcal.toFixed(0);
            mealCalTarget.textContent = obiettiviPasto.targetCal.toFixed(0);
            mealCalRemaining.textContent = `${(obiettiviPasto.targetCal - totaliPastoCorrenteSelezionati.kcal).toFixed(0)} kcal`;
            mealProgressCal.max = obiettiviPasto.targetCal;
            mealProgressCal.value = totaliPastoCorrenteSelezionati.kcal;
            
            const createBuilderDescriptionCellHTML = (item) => {
                let html = '';
                if (item.ingredienti && item.ingredienti.trim() !== '') {
                    html += `<span class="ingredient-icon" title="Visualizza ingredienti" data-food-name="${item.desc}">üìú</span>`;
                }
                html += item.desc;
                return html;
            };

            pastoInCostruzione.forEach((item, index) => { 
                const riga = logPastoBuilderBody.insertRow(); 
                riga.innerHTML = `<td><input type="checkbox" class="meal-item-checkbox" data-index="${index}" ${item.selezionato !== false ? 'checked' : ''}></td>
                                <td>${createBuilderDescriptionCellHTML(item)}</td>
                                <td>${item.qta}</td>
                                <td>${(item.prot || 0).toFixed(1)}</td>
                                <td>${((item.kcal || item.cal) || 0).toFixed(0)}</td>
                                <td class="action-buttons"><button class="delete-btn" data-type="builder" data-index="${index}">&times;</button></td>`; 
            });
        }

        function renderSuggestions() {
            const value = builderDesc.value.toLowerCase();
            suggestionsContainer.innerHTML = '';
            
            let keysToShow = Object.keys(foodDatabase);

            if (value.length > 0) {
                keysToShow = keysToShow.filter(key => 
                    foodDatabase[key] && foodDatabase[key].desc && foodDatabase[key].desc.toLowerCase().includes(value)
                );
            }

            const matches = keysToShow.sort((a, b) => {
                const descA = foodDatabase[a]?.desc || '';
                const descB = foodDatabase[b]?.desc || '';
                return descA.localeCompare(descB);
            });


            if (matches.length > 0) {
                matches.forEach(sanitizedKey => {
                    const originalDesc = foodDatabase[sanitizedKey].desc;
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'suggestion-item';
                    itemDiv.innerHTML = `
                        <span>${originalDesc}</span>
                        <button class="suggestion-delete-btn" data-food-key="${sanitizedKey}" title="Cancella ${originalDesc} dal database">&times;</button>
                    `;
                    suggestionsContainer.appendChild(itemDiv);
                });
                suggestionsContainer.style.display = 'block';
            } else {
                suggestionsContainer.style.display = 'none';
            }
        }
        
        function calcolaQualitaProteine(item) {
            if (!item || !item.prot || item.prot <= 0) {
                return { score: 0, limiting: 'N/D' };
            }
            let minRatio = Infinity;
            let limitingAmino = 'Nessuno';
            for (const amino in PROFILO_AMINOACIDICO_RIFERIMENTO) {
                const referenceValueMgPerG = PROFILO_AMINOACIDICO_RIFERIMENTO[amino];
                const actualValueMg = item[amino] || 0;
                const actualValueMgPerG = (actualValueMg / item.prot);
                const ratio = Math.min(1, actualValueMgPerG / referenceValueMgPerG);
                if (ratio < minRatio) {
                    minRatio = ratio;
                    limitingAmino = amino.charAt(0).toUpperCase() + amino.slice(1);
                }
            }
            return {
                score: Math.round(minRatio * 100),
                limiting: limitingAmino
            };
        }

        function apriModalAminoacidi(totali, titolo) {
            const modal = document.getElementById('amino-acid-modal');
            if (!modal) return;
            document.getElementById('modal-amino-title').textContent = titolo;
            const qualita = calcolaQualitaProteine(totali);
            const scoreClass = qualita.score < 70 ? 'low' : qualita.score < 90 ? 'medium' : 'high';
            const summaryDiv = document.getElementById('modal-amino-summary');
            summaryDiv.innerHTML = `
                <div class="protein-score ${scoreClass}" style="display: inline-block; padding: 5px 15px; font-size: 1.1em;" title="Limitante: ${qualita.limiting}">
                    Qualit√† Proteica: ${qualita.score}%
                </div>
            `;
            for (const amino in OBIETTIVI_AMINO) {
                const obiettivo = OBIETTIVI_AMINO[amino];
                const valore = totali[amino] || 0;
                document.getElementById(`modal-amino-${amino}-total`).textContent = valore.toFixed(0);
                document.getElementById(`modal-amino-${amino}-goal`).textContent = obiettivo;
                const progress = document.getElementById(`modal-amino-${amino}-progress`);
                progress.max = obiettivo;
                progress.value = valore;
            }
            modal.style.display = 'block';
        }

        function evaluateQuantity(input) {
            try {
                let value = input.trim().replace(',', '.');
                if (/^[0-9+\-*/.\s()]+$/.test(value)) {
                    const result = new Function(`return ${value}`)();
                    if (typeof result === 'number' && !isNaN(result)) {
                        return result;
                    }
                }
            } catch (e) { console.error("Errore valutazione quantit√†:", e); }
            return parseFloat(input.replace(',', '.'));
        }

        function creaAlimentoDaInput(isSingle = false) {
            const desc = builderDesc.value.trim();
            const qta = evaluateQuantity(builderQta.value);
            if (!desc || isNaN(qta) || qta <= 0) {
                alert('Inserisci nome e quantit√† valide.');
                return null;
            }

            const sanitizedKey = sanitizeFirebaseKey(desc.toLowerCase());
            const foodData = foodDatabase[sanitizedKey] || {};
            
            foodData.lastQta = qta;
            foodData.desc = desc; 
            
            const foodItem = { 
                desc: desc.charAt(0).toUpperCase() + desc.slice(1), 
                qta, 
                ingredienti: foodData.ingredienti || null 
            };
            
            for (const key in inputFields) {
                inputFields[key].el.value = inputFields[key].el.value.replace(',', '.');
                foodData[key] = inputFields[key].el.value === '' ? null : parseFloat(inputFields[key].el.value);
            }
            
            if (foodData.fibreSolubili !== null && foodData.fibreInsolubili !== null && foodData.fibreTotali === null) {
                const totalFibre = (foodData.fibreSolubili || 0) + (foodData.fibreInsolubili || 0);
                foodData.fibreTotali = totalFibre;
                inputFields.fibreTotali.el.value = totalFibre.toFixed(1);
            }

            const protValue100g = foodData.prot || 0;
            const isAnyAminoFilled = Object.keys(OBIETTIVI_AMINO).some(key => foodData[key] !== null && foodData[key] > 0);

            if (protValue100g > 0 && !isAnyAminoFilled) {
                for (const amino in PROFILO_AMINOACIDICO_RIFERIMENTO) {
                    const referenceMgPerG = PROFILO_AMINOACIDICO_RIFERIMENTO[amino];
                    const calculatedAminoMg = protValue100g * referenceMgPerG;
                    foodData[amino] = calculatedAminoMg;
                    if(inputFields[amino]) {
                        inputFields[amino].el.value = calculatedAminoMg.toFixed(0);
                    }
                }
            } 
            
            for (const key in foodData) {
                if (key !== 'lastQta' && key !== 'desc' && key !== 'ingredienti') {
                    foodItem[key] = ((foodData[key] ?? 0) / 100) * qta;
                }
            }
            
            if (foodData.fatTotal === null && (foodData.fatSat !== null || foodData.fatTrans !== null || foodData.fatMono !== null || foodData.fatPoly !== null)) {
                const total = (foodData.fatSat || 0) + (foodData.fatTrans || 0) + (foodData.fatMono || 0) + (foodData.fatPoly || 0);
                foodData.fatTotal = total;
                foodItem.fatTotal = (total / 100) * qta;
                inputFields.fatTotal.el.value = total.toFixed(1); 
            }
            
            foodDatabase[sanitizedKey] = foodData;
            salvaFoodDatabase();
            
            if (isSingle) {
                foodItem.type = 'single';
            } else {
                foodItem.selezionato = true;
            }
            return foodItem;
        }
        
        async function handleAlimentoAddition(isForMealBuilder) {
            const desc = builderDesc.value.trim();
            const invalidFirebaseChars = /[.#$[\]/]/; 
            if (invalidFirebaseChars.test(desc)) {
                alert("Il nome dell'alimento contiene caratteri non validi per il salvataggio (es. . # $ [ ] / ).\n\nPer favore, rimuovili e riprova.");
                return; 
            }
            
            const qta = evaluateQuantity(builderQta.value);
            if (!desc || isNaN(qta) || qta <= 0) { alert('Inserisci nome e quantit√† valide.'); return; }

            const emptyFields = Object.keys(inputFields)
                .filter(key => key !== 'fatTotal' && !Object.keys(OBIETTIVI_AMINO).includes(key) && key !== 'fatTotal')
                .filter(key => inputFields[key].el.value === '');
                
            if (emptyFields.length > 5) {
                const confirmMsg = `Ci sono molti campi nutrienti vuoti. Vuoi usare l'AI per compilare i dati mancanti prima di aggiungere?`;
                if (confirm(confirmMsg)) {
                    await document.getElementById('btn-compila-ai').click();
                    setTimeout(() => handleAlimentoAddition(isForMealBuilder), 500);
                    return; 
                }
            }
            
            const item = creaAlimentoDaInput(!isForMealBuilder);
            if (item) {
                if (isForMealBuilder) {
                    pastoInCostruzione.push(item);
                    salvaPastoInCostruzione();
                    renderMealBuilder();
                    mealBuilderSezione.scrollIntoView({ behavior: 'smooth' });
                } else {
                    if (!datiGiornalieri.log) datiGiornalieri.log = [];
                    datiGiornalieri.log.push(item);
                    salvaGiorno(giornoVisualizzato, datiGiornalieri);
                }
                aggiornaUI();
                resetInputAlimento();
                aggiornaColoreNutrienti();
            }
        }

        function resetInputAlimento() { 
            builderDesc.value = '';
            builderQta.value = '';
            Object.values(inputFields).forEach(field => field.el.value = ''); 
            
            builderDesc.readOnly = false; // Rende il campo sempre editabile al reset
            btnEditName.style.display = 'none'; // Nasconde la matita
            
            builderDesc.focus(); 
        }

        function clearDettagliNutrizionali() {
            const mainFields = new Set(['prot', 'kcal', 'carb', 'zuccheri', 'fatTotal', 'fatSat', 'fibreTotali']);
            for (const key in inputFields) {
                if (!mainFields.has(key)) {
                    inputFields[key].el.value = '';
                }
            }
            Object.keys(OBIETTIVI_AMINO).forEach(key => {
                if (inputFields[key]) {
                    inputFields[key].el.disabled = false;
                    inputFields[key].el.style.backgroundColor = '#ffffff';
                }
            });
            aggiornaColoreNutrienti();
            alert("I campi dei dettagli nutrizionali sono stati puliti.");
        }

        function aggiornaColoreNutrienti() {
            const hasEmptyFields = Object.keys(inputFields)
                .filter(key => !Object.keys(OBIETTIVI_AMINO).includes(key))
                .some(key => inputFields[key].el.value === '');
            document.getElementById('nutrients-header').classList.toggle('nutrients-warning', hasEmptyFields);
        }
        
        function calculateWeeklyVitaminStats() {
            const vitaminsToTrack = {
                'vitA': { total: 0, goal: OBIETTIVI_VIT.vitA * 7, id: 'a' },
                'vitD': { total: 0, goal: OBIETTIVI_VIT.vitD * 7, id: 'd' },
                'vitE': { total: 0, goal: OBIETTIVI_VIT.vitE * 7, id: 'e' },
                'vitK': { total: 0, goal: OBIETTIVI_VIT.vitK * 7, id: 'k' },
                'vitB12': { total: 0, goal: OBIETTIVI_VIT.vitB12 * 7, id: 'b12' }
            };
            const today = new Date();
            for (let i = 0; i < 7; i++) {
                const dateToCheck = new Date(today);
                dateToCheck.setDate(today.getDate() - i);
                const dateString = dateToCheck.toISOString().split('T')[0];
                const dailyDataRaw = localStorage.getItem(`trackerStorico_${dateString}`);
                if (dailyDataRaw) {
                    try {
                        const dailyData = JSON.parse(dailyDataRaw);
                        if (dailyData && dailyData.log) {
                            dailyData.log.forEach(entry => {
                                const items = entry.type === 'meal' ? entry.items : [entry];
                                items.forEach(item => {
                                    for (const key in vitaminsToTrack) {
                                        if (item[key]) vitaminsToTrack[key].total += item[key];
                                    }
                                });
                            });
                        }
                    } catch (e) { console.error(`Errore parsing dati per ${dateString}:`, e); }
                }
            }
            return vitaminsToTrack;
        }
        
        function calculateWeeklyFatStats() {
            const fatsToTrack = {
                'fatTotal': { total: 0, goal: OBIETTIVI_FAT.fatTotal * 7, id: 'total' }, 'fatSat':   { total: 0, goal: OBIETTIVI_FAT.fatSat * 7,   id: 'sat' },
                'fatTrans': { total: 0, goal: OBIETTIVI_FAT.fatTrans * 7, id: 'trans' }, 'fatMono':  { total: 0, goal: OBIETTIVI_FAT.fatMono * 7,  id: 'mono' },
                'fatPoly':  { total: 0, goal: OBIETTIVI_FAT.fatPoly * 7,  id: 'poly' }, 'omega3':   { total: 0, goal: OBIETTIVI_FAT.omega3 * 7,   id: 'omega3' },
                'omega6':   { total: 0, goal: OBIETTIVI_FAT.omega6 * 7,   id: 'omega6' }
            };
            const today = new Date();
            for (let i = 0; i < 7; i++) {
                const dateToCheck = new Date(today);
                dateToCheck.setDate(today.getDate() - i);
                const dateString = dateToCheck.toISOString().split('T')[0];
                const dailyDataRaw = localStorage.getItem(`trackerStorico_${dateString}`);
                if (dailyDataRaw) {
                    try {
                        const dailyData = JSON.parse(dailyDataRaw);
                        if (dailyData && dailyData.log) {
                            dailyData.log.forEach(entry => {
                                const items = entry.type === 'meal' ? entry.items : [entry];
                                items.forEach(item => {
                                    for (const key in fatsToTrack) {
                                        let value = item[key] || 0;
                                        if (key === 'fatTotal' && !item.fatTotal) {
                                            value = (item.fatSat || 0) + (item.fatTrans || 0) + (item.fatMono || 0) + (item.fatPoly || 0);
                                        }
                                        fatsToTrack[key].total += value;
                                    }
                                });
                            });
                        }
                    } catch (e) { console.error(`Errore nel parsing dei dati per il giorno ${dateString}:`, e); }
                }
            }
            return fatsToTrack;
        }

        function openWeeklyVitaminsModal() {
            const weeklyStats = calculateWeeklyVitaminStats();
            for (const key in weeklyStats) {
                const stat = weeklyStats[key];
                const { id, total, goal } = stat;
                const avg = total / 7;
                const dailyGoal = OBIETTIVI_VIT[key]; 
                const percentageDiff = (avg - dailyGoal) / dailyGoal * 100;
                document.getElementById(`weekly-vit-${id}-total`).textContent = total.toFixed(1);
                document.getElementById(`weekly-vit-${id}-goal`).textContent = goal.toFixed(1);
                document.getElementById(`weekly-progress-vit-${id}`).value = total;
                document.getElementById(`weekly-progress-vit-${id}`).max = goal;
                document.getElementById(`weekly-vit-${id}-avg`).textContent = avg.toFixed(1);
                const diffSpan = document.getElementById(`weekly-vit-${id}-diff`);
                diffSpan.classList.remove('diff-surplus', 'diff-deficit');
                if (percentageDiff >= 0) {
                    diffSpan.classList.add('diff-surplus');
                    diffSpan.textContent = `+${percentageDiff.toFixed(0)}%`;
                } else {
                    diffSpan.classList.add('diff-deficit');
                    diffSpan.textContent = `${percentageDiff.toFixed(0)}%`;
                }
            }
            weeklyVitaminModal.style.display = 'block';
        }
        
        function openWeeklyFatsModal() {
            const weeklyStats = calculateWeeklyFatStats();
            for (const key in weeklyStats) {
                const stat = weeklyStats[key];
                const { id, total, goal } = stat;
                const avg = total / 7;
                const dailyGoal = OBIETTIVI_FAT[key];
                const percentageDiff = dailyGoal > 0 ? (avg - dailyGoal) / dailyGoal * 100 : 0;
                document.getElementById(`weekly-fat-${id}-total`).textContent = total.toFixed(1);
                document.getElementById(`weekly-fat-${id}-goal`).textContent = goal.toFixed(1);
                document.getElementById(`daily-fat-${id}-goal`).textContent = dailyGoal.toFixed(1);
                document.getElementById(`weekly-progress-fat-${id}`).value = total;
                document.getElementById(`weekly-progress-fat-${id}`).max = goal;
                document.getElementById(`weekly-fat-${id}-avg`).textContent = avg.toFixed(1);
                const diffSpan = document.getElementById(`weekly-fat-${id}-diff`);
                diffSpan.classList.remove('diff-surplus', 'diff-deficit');
                if (avg > dailyGoal) {
                    diffSpan.classList.add('diff-deficit');
                    diffSpan.textContent = `+${percentageDiff.toFixed(0)}%`;
                } else {
                    diffSpan.classList.add('diff-surplus');
                    diffSpan.textContent = `${percentageDiff.toFixed(0)}%`;
                }
            }
            const totalWeeklyOmega3 = weeklyStats['omega3'].total;
            const totalWeeklyOmega6 = weeklyStats['omega6'].total;
            const weeklyOmegaRatioEl = document.getElementById('weekly-omega-ratio-value');
            let weeklyRatioText = 'N/D';
            weeklyOmegaRatioEl.style.color = '#333';
            if (totalWeeklyOmega3 > 0 && totalWeeklyOmega6 > 0) {
                const ratio = totalWeeklyOmega6 / totalWeeklyOmega3;
                weeklyRatioText = `${ratio.toFixed(1)}:1`;
                if (ratio >= 3 && ratio <= 6) { weeklyOmegaRatioEl.style.color = '#2e7d32';
                } else { weeklyOmegaRatioEl.style.color = '#d32f2f'; }
            }
            weeklyOmegaRatioEl.textContent = weeklyRatioText;
            weeklyFatsModal.style.display = 'block';
        }

        function toggleCollapsible(headerId, contentId) {
            const header = document.getElementById(headerId);
            const content = document.getElementById(contentId);
            header.classList.toggle('expanded');
            content.classList.toggle('expanded');
            header.querySelector('.arrow').textContent = header.classList.contains('expanded') ? '‚ñº' : '‚ñ∂';
        }

        function getNutrientData() {
            const allItems = [];
            (datiGiornalieri.log || []).forEach(entry => {
                if (entry.type === 'meal') {
                    entry.items.forEach(item => allItems.push(item));
                } else if (entry.type === 'single') {
                    allItems.push(entry);
                }
            });
            return allItems;
        }

        function showNutrientDetailsModal(nutrientKey, title, unit) {
            const allItems = getNutrientData();
            let totalNutrient = 0;
            const itemContributions = [];
            allItems.forEach(item => {
                const value = item[nutrientKey] || 0;
                totalNutrient += value;
                if (value > 0) { itemContributions.push({ name: item.desc, value: value, unit: unit }); }
            });
            itemContributions.sort((a, b) => b.value - a.value);
            nutrientDetailTitle.textContent = `Dettaglio Fonti ${title}`;
            nutrientDetailList.innerHTML = '';
            if (itemContributions.length === 0) {
                nutrientDetailList.innerHTML = '<li>Nessun dato disponibile.</li>';
            } else {
                itemContributions.forEach(item => {
                    const percentage = totalNutrient > 0 ? (item.value / totalNutrient) * 100 : 0;
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `<span>${item.name}</span><span>${item.value.toFixed(1)} ${item.unit} (${percentage.toFixed(0)}%)</span>`;
                    nutrientDetailList.appendChild(listItem);
                });
            }
            nutrientDetailModal.style.display = 'block';
        }

        function showWeeklyNutrientDetailsModal(nutrientKey, title, unit) {
            const contributions = {};
            const today = new Date();
            for (let i = 0; i < 7; i++) {
                const dateToCheck = new Date(today);
                dateToCheck.setDate(today.getDate() - i);
                const dateString = dateToCheck.toISOString().split('T')[0];
                const dailyDataRaw = localStorage.getItem(`trackerStorico_${dateString}`);
                if (!dailyDataRaw) continue;
                try {
                    const dailyData = JSON.parse(dailyDataRaw);
                    if (dailyData && dailyData.log) {
                        dailyData.log.forEach(entry => {
                            const items = entry.type === 'meal' ? entry.items : [entry];
                            items.forEach(item => {
                                const value = item[nutrientKey] || 0;
                                if (value > 0) {
                                    const name = item.desc;
                                    contributions[name] = (contributions[name] || 0) + value;
                                }
                            });
                        });
                    }
                } catch (e) { console.error(`Errore nel parsing dei dati settimanali per ${dateString}:`, e); }
            }
            const itemContributions = Object.entries(contributions)
                                          .map(([name, value]) => ({ name, value, unit }))
                                          .sort((a, b) => b.value - a.value);
            const totalNutrient = itemContributions.reduce((sum, item) => sum + item.value, 0);
            nutrientDetailTitle.textContent = `Dettaglio Fonti ${title}`;
            nutrientDetailList.innerHTML = '';
            if (itemContributions.length === 0) {
                nutrientDetailList.innerHTML = '<li>Nessun dato disponibile per questa settimana.</li>';
            } else {
                itemContributions.forEach(item => {
                    const percentage = totalNutrient > 0 ? (item.value / totalNutrient) * 100 : 0;
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `<span>${item.name}</span><span>${item.value.toFixed(1)} ${item.unit} (${percentage.toFixed(0)}%)</span>`;
                    nutrientDetailList.appendChild(listItem);
                });
            }
            nutrientDetailModal.style.display = 'block';
        }
        
        function openIngredientModal(foodName, isReadOnly = false) {
            if (!foodName) {
                alert("Inserisci prima il nome dell'alimento.");
                return;
            }
            const sanitizedKey = sanitizeFirebaseKey(foodName.toLowerCase());
            const foodData = foodDatabase[sanitizedKey];

            ingredientModalTitle.textContent = foodName;
            ingredientModalTextarea.value = foodData?.ingredienti || '';
            ingredientModalTextarea.readOnly = isReadOnly;
            
            ingredientModalActions.style.display = isReadOnly ? 'none' : 'flex';
            btnSaveIngredients.style.display = isReadOnly ? 'none' : 'block';

            ingredientModal.style.display = 'block';
        }

        function normalizeNutrientKey(key) {
            const k = key.toLowerCase().replace(/[\s\(\)]/g, '');
            if (k.includes('energi') || k.includes('kcal') || k.includes('calorie')) return 'kcal';
            if (k.includes('protein')) return 'prot';
            if (k.includes('carboidrat')) {
                if(k.includes('cuizuccheri')) return 'zuccheri';
                return 'carb';
            }
            if (k.includes('zuccher')) return 'zuccheri';
            if (k.includes('grassi') || k.includes('fat')) {
                if(k.includes('satur')) return 'fatSat';
                if(k.includes('trans')) return 'fatTrans';
                if(k.includes('monoinsatur')) return 'fatMono';
                if(k.includes('polinsatur')) return 'fatPoly';
                return 'fatTotal';
            }
            if (k.includes('fibr')) return 'fibreTotali';
            if (k.includes('sale') || k.includes('sodio') || k.includes('sodium') || k.includes('na')) return 'na';
            return null;
        }
        
        async function processOCRImage(file) {
            photoOcrStatus.textContent = 'Elaborazione...';
            photoOcrStatus.style.display = 'inline';
            btnPhotoNutrients.disabled = true;

            try {
                photoOcrStatus.textContent = 'Fase 1/2: Lettura testo...';
                const { data: { text: ocrText } } = await Tesseract.recognize(file, 'ita', {
                    logger: m => {
                        if (m.status === 'recognizing text') {
                           photoOcrStatus.textContent = `Fase 1/2: Riconoscimento (${(m.progress * 100).toFixed(0)}%)`;
                        }
                    }
                });
                
                photoOcrStatus.textContent = 'Fase 2/2: Analisi AI...';
                const prompt = `Analizza il seguente testo estratto da una tabella nutrizionale: "${ocrText}". Estrai i valori per 100g (o 100ml), ignorando le colonne "per porzione". Restituisci ESCLUSIVAMENTE un oggetto JSON. Le chiavi devono essere i nomi dei nutrienti in italiano (es. "Energia", "Grassi", "di cui acidi grassi saturi"). Se un valore non √® presente, omettilo.`;
                
                const callGemini = httpsCallable(window.functions, 'callOpenAI');
                const result = await callGemini({ prompt: prompt });
                const data = result.data;
                const rawJson = data.candidates?.[0]?.content?.parts?.[0]?.text || '{}';
                const nutrientDataFromAI = JSON.parse(rawJson.replace(/```json|```/g, '').trim());
                
                nutrientConfirmList.innerHTML = '';
                if(Object.keys(nutrientDataFromAI).length === 0) {
                     nutrientConfirmList.innerHTML = `<p style="color:red; text-align:center; grid-column: 1 / -1;">L'AI non ha estratto alcun dato. L'immagine potrebbe non essere chiara. Riprova.</p>`;
                } else {
                     for (const aiKey in nutrientDataFromAI) {
                        const internalKey = normalizeNutrientKey(aiKey);
                        if (internalKey && inputFields[internalKey]) {
                            const itemDiv = document.createElement('div');
                            itemDiv.className = 'nutrient-confirm-item';
                            const value = String(nutrientDataFromAI[aiKey]).replace(/[^0-9.,]/g, '').replace(',', '.') || '0';
                            itemDiv.innerHTML = `<label for="confirm-${internalKey}">${inputFields[internalKey].label}</label>
                                                 <input type="text" id="confirm-${internalKey}" data-nutrient-key="${internalKey}" value="${value}">`;
                            nutrientConfirmList.appendChild(itemDiv);
                        }
                    }
                }
                nutrientConfirmModal.style.display = 'block';

            } catch(error) {
                console.error("Errore nel processo OCR-AI: ", error);
                alert("Si √® verificato un errore durante l'elaborazione dell'immagine. Assicurati che sia chiara e che la connessione sia stabile, poi riprova.");
            } finally {
                photoOcrStatus.style.display = 'none';
                btnPhotoNutrients.disabled = false;
                nutrientPhotoInput.value = '';
            }
        }

        let isScanning = false;

        async function startBarcodeScanner() {
            if (!('BarcodeDetector' in window)) {
                alert('Il tuo browser non supporta la scansione dei codici a barre. Prova con Chrome su Android o un altro browser moderno.');
                return;
            }
            
            barcodeScannerStatus.textContent = 'Avvio fotocamera...';
            barcodeScannerModal.style.display = 'block';

            try {
                const barcodeDetector = new BarcodeDetector({ formats: ['ean_13', 'ean_8', 'upc_a', 'upc_e'] });
                
                videoStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                
                barcodeScannerVideo.srcObject = videoStream;
                await barcodeScannerVideo.play();
                isScanning = true;
                barcodeScannerStatus.textContent = 'Pronto per la scansione.';
                
                const scanInterval = setInterval(async () => {
                    if (!isScanning) {
                        clearInterval(scanInterval);
                        return;
                    }
                    try {
                        const barcodes = await barcodeDetector.detect(barcodeScannerVideo);
                        if (barcodes.length > 0) {
                            const barcode = barcodes[0].rawValue;
                            barcodeScannerStatus.textContent = `Codice trovato: ${barcode}`;
                            isScanning = false;
                            clearInterval(scanInterval);
                            stopBarcodeScanner();
                            await fetchProductData(barcode);
                        }
                    } catch (error) {
                        console.error('Errore durante la scansione:', error);
                    }
                }, 200);

            } catch (error) {
                console.error('Errore accesso alla fotocamera:', error);
                barcodeScannerStatus.textContent = 'Errore fotocamera. Assicurati di aver dato i permessi.';
                isScanning = false;
                stopBarcodeScanner();
            }
        }

        function stopBarcodeScanner() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            isScanning = false;
            barcodeScannerModal.style.display = 'none';
        }

        async function fetchProductData(barcode) {
            barcodeScannerStatus.textContent = `Ricerca del prodotto con codice ${barcode}...`;
            photoOcrStatus.textContent = 'Ricerca dati...';
            photoOcrStatus.style.display = 'inline';

            try {
                const response = await fetch(`https://world.openfoodfacts.org/api/v2/product/${barcode}.json?fields=product_name,ingredients_text_it,ingredients_text,nutriments`);
                if (!response.ok) {
                    throw new Error(`Risposta non valida dal server: ${response.statusText}`);
                }
                const data = await response.json();

                if (data.status === 0 || !data.product) {
                    alert(`Prodotto con codice a barre ${barcode} non trovato nel database di Open Food Facts.`);
                    return;
                }

                populateFormWithData(data.product);

            } catch (error) {
                console.error('Errore nel recupero dati prodotto:', error);
                alert(`Si √® verificato un errore durante la ricerca del prodotto. Controlla la connessione e riprova.`);
            } finally {
                photoOcrStatus.style.display = 'none';
            }
        }

        function populateFormWithData(product) {
            resetInputAlimento();
            
            const nutrientMap = {
                'energy-kcal_100g': inputFields.kcal.el, 'proteins_100g': inputFields.prot.el,
                'carbohydrates_100g': inputFields.carb.el, 'sugars_100g': inputFields.zuccheri.el,
                'fat_100g': inputFields.fatTotal.el, 'saturated-fat_100g': inputFields.fatSat.el,
                'trans-fat_100g': inputFields.fatTrans.el, 'monounsaturated-fat_100g': inputFields.fatMono.el,
                'polyunsaturated-fat_100g': inputFields.fatPoly.el, 'omega-3-fat_100g': inputFields.omega3.el,
                'omega-6-fat_100g': inputFields.omega6.el, 'fiber_100g': inputFields.fibreTotali.el,
                'salt_100g': inputFields.na.el,
                'sodium_100g': inputFields.na.el,
                'calcium_100g': inputFields.ca.el, 'iron_100g': inputFields.fe.el,
                'magnesium_100g': inputFields.mg.el, 'potassium_100g': inputFields.k.el,
                'zinc_100g': inputFields.zn.el, 'phosphorus_100g': inputFields.p.el,
                'vitamin-a_100g': inputFields.vitA.el, 'vitamin-d_100g': inputFields.vitD.el,
                'vitamin-e_100g': inputFields.vitE.el, 'vitamin-k_100g': inputFields.vitK.el,
                'vitamin-c_100g': inputFields.vitc.el, 'vitamin-b2_100g': inputFields.b2.el,
                'vitamin-b6_100g': inputFields.b6.el, 'vitamin-b9_100g': inputFields.b9.el,
                'vitamin-b12_100g': inputFields.vitB12.el
            };

            builderDesc.value = product.product_name || 'Prodotto Sconosciuto';

            const nutriments = product.nutriments || {};
            for (const key in nutrientMap) {
                if (nutriments[key] !== undefined && nutriments[key] !== null) {
                    let value = parseFloat(nutriments[key]);
                    
                    if (['calcium_100g', 'iron_100g', 'magnesium_100g', 'potassium_100g', 'zinc_100g', 'phosphorus_100g', 'vitamin-e_100g', 'vitamin-c_100g', 'vitamin-b2_100g', 'vitamin-b6_100g'].includes(key)) {
                        value *= 1000;
                    } else if (['vitamin-a_100g', 'vitamin-d_100g', 'vitamin-k_100g', 'vitamin-b9_100g', 'vitamin-b12_100g'].includes(key)) {
                        value *= 1000000;
                    } else if (key === 'salt_100g') {
                        value = (value / 2.5) * 1000;
                    } else if (key === 'sodium_100g') {
                         value *= 1000;
                    }
                    
                    nutrientMap[key].value = value.toFixed(2).replace(/\.00$/, '');
                }
            }
            
            const ingredients = product.ingredients_text_it || product.ingredients_text || '';
            if (ingredients) {
                const sanitizedKey = sanitizeFirebaseKey(builderDesc.value.toLowerCase());
                if (!foodDatabase[sanitizedKey]) {
                    foodDatabase[sanitizedKey] = { desc: builderDesc.value };
                }
                foodDatabase[sanitizedKey].ingredienti = ingredients;
                salvaFoodDatabase();
            }

            alert(`Dati per "${builderDesc.value}" compilati con successo!`);
            aggiornaColoreNutrienti();
            builderProt.dispatchEvent(new Event('input'));

            builderDesc.readOnly = true;
            btnEditName.style.display = 'inline-block';
        }

        document.addEventListener('DOMContentLoaded', () => {
            eseguiMigrazioneStorico(); 
            initAppUI(); 
            
            btnScanBarcode.addEventListener('click', startBarcodeScanner);
            const barcodeModalCloseBtn = barcodeScannerModal.querySelector('.modal-close');
            barcodeModalCloseBtn.addEventListener('click', stopBarcodeScanner);

            dailyNotesTextarea.addEventListener('input', () => {
                datiGiornalieri.note = dailyNotesTextarea.value;
                salvaGiorno(giornoVisualizzato, datiGiornalieri);
            });
            
            btnEditName.addEventListener('click', () => {
                builderDesc.readOnly = false;
                builderDesc.focus();
                btnEditName.style.display = 'none';
            });

            const btnVaiAOggi = document.getElementById('btn-vai-a-oggi');
            btnVaiAOggi.addEventListener('click', () => {
                caricaGiorno(getTodayString());
            });

            dataCaricamentoInput.addEventListener('change', (e) => {
                const dataSelezionata = e.target.value;
                if (dataSelezionata) {
                    console.log(`Data selezionata, carico il giorno: ${dataSelezionata}`);
                    caricaGiorno(dataSelezionata);
                }
            });

            ['progress-proteine', 'progress-calorie', 'progress-carboidrati', 'progress-zuccheri', 
             'progress-fibre-totali', 'progress-fibre-solubili', 'progress-fibre-insolubili',
             'progress-fats-total', 'progress-fat-sat', 
             'progress-fat-trans', 'progress-fat-unsat', 'progress-fat-mono', 'progress-fat-poly', 'progress-omega3', 'progress-omega6', 
             'progress-mg', 'progress-k', 'progress-fe', 'progress-zn', 'progress-ca', 'progress-cu', 'progress-p', 'progress-vitc', 
             'progress-vit-a', 'progress-vit-d', 'progress-vit-e', 'progress-vit-k', 'progress-vit-b12', 'progress-b2', 'progress-b6', 'progress-b9']
            .forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    const nutrientMap = {
                        'progress-proteine': { key: 'prot', title: 'Proteine', unit: 'g' },
                        'progress-calorie': { key: 'kcal', title: 'Calorie', unit: 'kcal' },
                        'progress-carboidrati': { key: 'carb', title: 'Carboidrati', unit: 'g' },
                        'progress-zuccheri': { key: 'zuccheri', title: 'Zuccheri', unit: 'g' },
                        'progress-fibre-totali': { key: 'fibreTotali', title: 'Fibre Totali', unit: 'g' },
                        'progress-fibre-solubili': { key: 'fibreSolubili', title: 'Fibre Solubili', unit: 'g' },
                        'progress-fibre-insolubili': { key: 'fibreInsolubili', title: 'Fibre Insolubili', unit: 'g' },
                        'progress-fats-total': { key: 'fatTotal', title: 'Grassi Totali', unit: 'g'},
                        'progress-fat-sat': { key: 'fatSat', title: 'Grassi Saturi', unit: 'g' },
                        'progress-fat-trans': { key: 'fatTrans', title: 'Grassi Trans', unit: 'g' },
                        'progress-fat-mono': { key: 'fatMono', title: 'Grassi Monoinsaturi', unit: 'g' },
                        'progress-fat-poly': { key: 'fatPoly', title: 'Grassi Polinsaturi', unit: 'g' },
                        'progress-omega3': { key: 'omega3', title: 'Omega 3', unit: 'g' },
                        'progress-omega6': { key: 'omega6', title: 'Omega 6', unit: 'g' },
                        'progress-mg': { key: 'mg', title: 'Magnesio', unit: 'mg' },
                        'progress-k': { key: 'k', title: 'Potassio', unit: 'mg' },
                        'progress-fe': { key: 'fe', title: 'Ferro', unit: 'mg' },
                        'progress-zn': { key: 'zn', title: 'Zinco', unit: 'mg' },
                        'progress-ca': { key: 'ca', title: 'Calcio', unit: 'mg' },
                        'progress-cu': { key: 'cu', title: 'Rame', unit: 'mg' },
                        'progress-p': { key: 'p', title: 'Fosforo', unit: 'mg' },
                        'progress-vitc': { key: 'vitc', title: 'Vitamina C', unit: 'mg' },
                        'progress-vit-a': { key: 'vitA', title: 'Vitamina A', unit: '¬µg' },
                        'progress-vit-d': { key: 'vitD', title: 'Vitamina D', unit: '¬µg' },
                        'progress-vit-e': { key: 'vitE', title: 'Vitamina E', unit: 'mg' },
                        'progress-vit-k': { key: 'vitK', title: 'Vitamina K', unit: '¬µg' },
                        'progress-vit-b12': { key: 'vitB12', title: 'Vitamina B12', unit: '¬µg' },
                        'progress-b2': { key: 'b2', title: 'Vitamina B2', unit: 'mg' },
                        'progress-b6': { key: 'b6', title: 'Vitamina B6', unit: 'mg' },
                        'progress-b9': { key: 'b9', title: 'Folati (B9)', unit: '¬µg' }
                    };
                    const info = nutrientMap[id];
                    if (info) el.addEventListener('click', () => showNutrientDetailsModal(info.key, info.title, info.unit));
                }
            });

            ['weekly-progress-vit-a', 'weekly-progress-vit-d', 'weekly-progress-vit-e', 'weekly-progress-vit-k', 'weekly-progress-vit-b12',
             'weekly-progress-fat-total', 'weekly-progress-fat-sat', 'weekly-progress-fat-trans', 'weekly-progress-fat-mono', 'weekly-progress-fat-poly',
             'weekly-progress-fat-omega3', 'weekly-progress-fat-omega6'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                     const nutrientMap = {
                        'weekly-progress-vit-a': { key: 'vitA', title: 'Vitamina A (Sett.)', unit: '¬µg' },
                        'weekly-progress-vit-d': { key: 'vitD', title: 'Vitamina D (Sett.)', unit: '¬µg' },
                        'weekly-progress-vit-e': { key: 'vitE', title: 'Vitamina E (Sett.)', unit: 'mg' },
                        'weekly-progress-vit-k': { key: 'vitK', title: 'Vitamina K (Sett.)', unit: '¬µg' },
                        'weekly-progress-vit-b12': { key: 'vitB12', title: 'Vitamina B12 (Sett.)', unit: '¬µg' },
                        'weekly-progress-fat-total': { key: 'fatTotal', title: 'Grassi Totali (Sett.)', unit: 'g' },
                        'weekly-progress-fat-sat': { key: 'fatSat', title: 'Grassi Saturi (Sett.)', unit: 'g' },
                        'weekly-progress-fat-trans': { key: 'fatTrans', title: 'Grassi Trans (Sett.)', unit: 'g' },
                        'weekly-progress-fat-mono': { key: 'fatMono', 'title': 'Grassi Monoinsaturi (Sett.)', unit: 'g' },
                        'weekly-progress-fat-poly': { key: 'fatPoly', title: 'Grassi Polinsaturi (Sett.)', unit: 'g' },
                        'weekly-progress-fat-omega3': { key: 'omega3', title: 'Omega 3 (Sett.)', unit: 'g' },
                        'weekly-progress-fat-omega6': { key: 'omega6', title: 'Omega 6 (Sett.)', unit: 'g' }
                     };
                     const info = nutrientMap[id];
                     if(info) el.addEventListener('click', () => showWeeklyNutrientDetailsModal(info.key, info.title, info.unit));
                }
            });

            infoVitSettimanaliBtn.addEventListener('click', openWeeklyVitaminsModal);
            infoFatsSettimanaliBtn.addEventListener('click', openWeeklyFatsModal);

            document.querySelectorAll('.modal-close').forEach(button => {
                button.addEventListener('click', () => {
                    button.closest('.modal').style.display = 'none';
                });
            });

            window.addEventListener('click', (event) => {
                if (event.target.classList.contains('modal')) {
                    event.target.style.display = 'none';
                }
            });

            document.getElementById('info-proteine-giornata').addEventListener('click', () => {
                const log = datiGiornalieri.log || [];
                const totaliGiornata = log.reduce((acc, entry) => {
                    const items = entry.type === 'meal' ? entry.items : (entry.type === 'workout' ? [] : [entry]);
                    items.forEach(item => {
                        for (const key in item) {
                            if (typeof item[key] === 'number') acc[key] = (acc[key] || 0) + item[key];
                        }
                    });
                    return acc;
                }, {});
                apriModalAminoacidi(totaliGiornata, "Dettaglio Proteine del Giorno");
            });

            document.getElementById('info-proteine-pasto').addEventListener('click', () => {
                const totaliPasto = pastoInCostruzione.reduce((acc, item) => {
                    for (const key in item) {
                        if (typeof item[key] === 'number') acc[key] = (acc[key] || 0) + item[key];
                    }
                    return acc;
                }, {});
                apriModalAminoacidi(totaliPasto, "Dettaglio Proteine del Pasto");
            });

            const aminoModal = document.getElementById('amino-acid-modal');
            if(aminoModal) {
              aminoModal.querySelector('.modal-close').addEventListener('click', () => {
                  aminoModal.style.display = 'none';
              });
            }
        
            ['carbs-header', 'fats-header', 'micro-header', 'vit-header', 'workout-header', 'nutrients-header', 'fibre-header'].forEach(id => {
                const header = document.getElementById(id);
                if(header) {
                    header.addEventListener('click', (e) => {
                        if(e.target.closest('button')) return;
                        toggleCollapsible(id, id.replace('header', 'content'));
                    });
                }
            });
            
            btnClearNutrients.addEventListener('click', () => { 
                if(!confirm("Sei sicuro di voler cancellare tutti i campi (nome, quantit√† e nutrienti)?")) return;
                resetInputAlimento(); 
                Object.keys(OBIETTIVI_AMINO).forEach(key => {
                    if(inputFields[key]) {
                        inputFields[key].el.disabled = false;
                        inputFields[key].el.style.backgroundColor = '#ffffff';
                    }
                });
                aggiornaColoreNutrienti(); 
            });

            document.getElementById('btn-clear-dettagli').addEventListener('click', (e) => {
                e.stopPropagation();
                if(confirm("Sei sicuro di voler cancellare solo i valori nei Dettagli Nutrizionali?")) {
                    clearDettagliNutrizionali();
                }
            });

            builderProt.addEventListener('input', () => {
                const protValue = parseFloat(builderProt.value.replace(',', '.'));
                const aminoInputs = Object.keys(OBIETTIVI_AMINO).map(key => inputFields[key].el);

                if (!isNaN(protValue) && protValue > 0) {
                    aminoInputs.forEach(input => {
                        if(!input) return;
                        const aminoKey = Object.keys(inputFields).find(key => inputFields[key].el === input);
                        const referenceValue = PROFILO_AMINOACIDICO_RIFERIMENTO[aminoKey];
                        input.value = (protValue * referenceValue).toFixed(0);
                        input.disabled = true;
                        input.style.backgroundColor = '#f2f2f2';
                    });
                } else {
                    aminoInputs.forEach(input => {
                        if(!input) return;
                        input.disabled = false;
                        input.style.backgroundColor = '#ffffff';
                    });
                }
            });

            btnAddWorkout.addEventListener('click', () => {
                const desc = workoutDescInput.value.trim(), calories = parseFloat(workoutCaloriesInput.value);
                if (!desc || isNaN(calories) || calories <= 0) { alert('Dati allenamento non validi.'); return; }
                if (!datiGiornalieri.log) datiGiornalieri.log = [];
                datiGiornalieri.log.push({ type: 'workout', desc: desc, kcal: calories });
                datiGiornalieri.workoutCalorie = (datiGiornalieri.workoutCalorie || 0) + calories;
                aggiornaUI();
                salvaGiorno(giornoVisualizzato, datiGiornalieri); 
                workoutDescInput.value = ''; workoutCaloriesInput.value = '';
                renderMealBuilder(); 
            });

           btnAggiungiSingolo.addEventListener('click', () => handleAlimentoAddition(false));
           btnCostruisciPasto.addEventListener('click', () => handleAlimentoAddition(true));

            mealBuilderSezione.addEventListener('change', (e) => {
                if (e.target.classList.contains('meal-item-checkbox')) { 
                    const index = parseInt(e.target.dataset.index, 10);
                    if (pastoInCostruzione[index]) {
                        pastoInCostruzione[index].selezionato = e.target.checked;
                        salvaPastoInCostruzione(); 
                        renderMealBuilder(); 
                    }
                } else if (e.target.id === 'meal-type-selector') {
                    const value = e.target.value;
                    localStorage.setItem('lastMealTypeSelected_' + getTodayString(), value);
                    saveSingleItemToCloud('lastMealTypeSelected_' + getTodayString(), value);
                    renderMealBuilder();
                }
            });

            btnSalvaPasto.addEventListener('click', () => {
                const alimentiSelezionati = pastoInCostruzione.filter(item => item.selezionato !== false);
                if (alimentiSelezionati.length === 0) { alert("Nessun alimento selezionato."); return; }
                
                const mealName = mealTypeSelector.options[mealTypeSelector.selectedIndex].text, mealId = mealTypeSelector.value;
                const newMeal = { type: 'meal', desc: mealName, mealId: mealId, isExpanded: false, items: alimentiSelezionati };
                if (!datiGiornalieri.log) datiGiornalieri.log = [];
                datiGiornalieri.log.push(newMeal);
                
                pastoInCostruzione = []; 
                salvaPastoInCostruzione(); 
                aggiornaUI(); 
                salvaGiorno(giornoVisualizzato, datiGiornalieri); 
                renderMealBuilder(); 

                const currentIndex = MEAL_TYPE_SEQUENCE.indexOf(mealId);
                const nextMeal = (currentIndex !== -1 && currentIndex < MEAL_TYPE_SEQUENCE.length - 1) ? MEAL_TYPE_SEQUENCE[currentIndex + 1] : MEAL_TYPE_SEQUENCE[0];
                mealTypeSelector.value = nextMeal;
                localStorage.setItem('lastMealTypeSelected_' + getTodayString(), nextMeal);
                saveSingleItemToCloud('lastMealTypeSelected_' + getTodayString(), nextMeal);
            });

            document.body.addEventListener('click', (e) => {
                const icon = e.target.closest('.ingredient-icon');
                if (icon) {
                    const foodName = icon.dataset.foodName;
                    openIngredientModal(foodName, true);
                    return;
                }
                
                const target = e.target.closest('button, .expand-arrow');
                if (!target) return;

                const button = target.closest('.edit-btn, .delete-btn');
                const index = parseInt(target.dataset.index, 10);
                
                if (button && button.classList.contains('edit-btn')) {
                    const itemToEdit = datiGiornalieri.log[index];
                    if (!itemToEdit || !confirm("Vuoi modificare questa voce? Verr√† spostata nel 'Costruttore Pasto'.")) return;
                    pastoInCostruzione = (itemToEdit.type === 'meal' ? itemToEdit.items : [itemToEdit]).map(item => ({...item, selezionato: true}));
                    datiGiornalieri.log.splice(index, 1); 
                    salvaPastoInCostruzione(); 
                    aggiornaUI(); 
                    salvaGiorno(giornoVisualizzato, datiGiornalieri); 
                    renderMealBuilder();
                    mealBuilderSezione.scrollIntoView({ behavior: 'smooth' });
                    if (itemToEdit.mealId) {
                        mealTypeSelector.value = itemToEdit.mealId;
                        localStorage.setItem('lastMealTypeSelected_' + getTodayString(), mealTypeSelector.value);
                    }
                } else if (button && button.classList.contains('delete-btn')) {
                    if (!confirm('Cancellare la voce?')) return;
                    if (button.dataset.type === 'builder') { 
                        pastoInCostruzione.splice(index, 1);
                        salvaPastoInCostruzione(); 
                        renderMealBuilder();
                    } else { 
                        const itemToDelete = datiGiornalieri.log[index];
                        if (itemToDelete.type === 'workout') {
                            datiGiornalieri.workoutCalorie = Math.max(0, (datiGiornalieri.workoutCalorie || 0) - ((itemToDelete.kcal || itemToDelete.cal) || 0));
                        }
                        datiGiornalieri.log.splice(index, 1);
                        aggiornaUI(); 
                        salvaGiorno(giornoVisualizzato, datiGiornalieri); 
                    }
                } else if (target.classList.contains('expand-arrow')) {
                    if (datiGiornalieri.log[index] && datiGiornalieri.log[index].type === 'meal') {
                        datiGiornalieri.log[index].isExpanded = !datiGiornalieri.log[index].isExpanded;
                        aggiornaUI(); 
                        salvaGiorno(giornoVisualizzato, datiGiornalieri); 
                    }
                }
            });
            
            builderDesc.addEventListener('input', (e) => {
                renderSuggestions();
                const sanitizedKey = sanitizeFirebaseKey(e.target.value.trim().toLowerCase());
                const foodData = foodDatabase[sanitizedKey]; 
                if (foodData) {
                    builderQta.value = foodData.lastQta ?? '';
                    for(const key in inputFields) {
                        if (inputFields[key]) {
                            inputFields[key].el.value = foodData[key] ?? '';
                        }
                    }
                }
                aggiornaColoreNutrienti();
            });

            builderDesc.addEventListener('focus', renderSuggestions);

            builderDesc.addEventListener('blur', () => {
                setTimeout(() => {
                    suggestionsContainer.style.display = 'none';
                }, 200);
            });

            suggestionsContainer.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.suggestion-delete-btn');
                if (deleteBtn) {
                    e.stopPropagation();
                    const foodKey = deleteBtn.dataset.foodKey;
                    if (foodKey && foodDatabase[foodKey]) {
                        if (confirm(`Sei sicuro di voler cancellare "${foodDatabase[foodKey].desc}" dal database?`)) {
                            delete foodDatabase[foodKey];
                            salvaFoodDatabase();
                            renderSuggestions(); // Refresh the list
                        }
                    }
                    return;
                }

                const suggestionItem = e.target.closest('.suggestion-item');
                if (suggestionItem) {
                    const foodName = suggestionItem.querySelector('span').textContent;
                    builderDesc.value = foodName;
                    builderDesc.dispatchEvent(new Event('input', { bubbles:true }));
                    suggestionsContainer.style.display = 'none';
                    
                    const foodData = foodDatabase[sanitizeFirebaseKey(foodName.toLowerCase())];
                    if (foodData) {
                        builderDesc.readOnly = true;
                        btnEditName.style.display = 'inline-block';
                    }
                }
            });
            
            Object.values(inputFields).forEach(field => { if (field.el) field.el.addEventListener('input', aggiornaColoreNutrienti) });
            
            document.getElementById('btn-compila-ai').addEventListener('click', async (e) => {
                const nome = builderDesc.value.trim();
                if (!nome) { alert('Scrivi prima il nome dell\'alimento.'); return; }
                const button = e.target;
                button.disabled = true; button.textContent = 'Caricamento‚Ä¶';

                try {
                    const sanitizedKey = sanitizeFirebaseKey(nome.toLowerCase());
                    const foodData = foodDatabase[sanitizedKey];
                    let ingredientiInfo = '';
                    if (foodData && foodData.ingredienti) {
                        ingredientiInfo = `Considerando questa lista ingredienti: "${foodData.ingredienti}".`;
                    }
                    let promptText = `Fornisci ESATTAMENTE questo oggetto JSON (senza altro testo) con i valori nutrizionali medi per 100 g di "${nome}". ${ingredientiInfo} ${AI_INSTRUCTION}. ${GEMINI_PROMPT_FORMAT}`;
                    
                    const callGemini = httpsCallable(window.functions, 'callOpenAI');
                    const result = await callGemini({ prompt: promptText });
                    const data = result.data;
                    const raw = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
                    const newData = JSON.parse(raw.replace(/```json|```/g, '').trim());

                    const oldData = {};
                    let isAnyFieldPopulated = false;
                    for (const key in inputFields) {
                        const val = inputFields[key].el.value;
                        if(val) isAnyFieldPopulated = true;
                        oldData[key] = val || null;
                    }
                    
                    // FIX: Mapping manuale se AI usa chiavi italiane per il sodio
                    if(newData.sale) newData.na = newData.sale * 1000 / 2.5; 
                    if(newData.sodio) newData.na = newData.sodio;
                    
                    if (!isAnyFieldPopulated) {
                        for (const key in newData) {
                            const normalizedKey = normalizeNutrientKey(key) || key;
                            if (inputFields[normalizedKey] && inputFields[normalizedKey].el.value === '') {
                                inputFields[normalizedKey].el.value = newData[key];
                            }
                        }
                        alert("Campi vuoti compilati con successo dall'AI.");
                    } else {
                        handleNutrientUpdate(nome, oldData, newData);
                    }
                    aggiornaColoreNutrienti();

                } catch (err) { 
                    alert('Errore compilazione AI: ' + err.message);
                    console.error(err);
                } finally { 
                    button.disabled = false; 
                    button.textContent = 'Compila AI'; 
                }
            });
            
            dataCaricamentoInput.value = getTodayString('ymd');

            const handleCalorieAdjustment = (increment) => {
                let value = (datiGiornalieri.calorieAdjustment || 0) + increment;
                datiGiornalieri.calorieAdjustment = Math.max(-500, Math.min(500, value));
                aggiornaUI();
                salvaGiorno(giornoVisualizzato, datiGiornalieri);
                renderMealBuilder(); 
            };
            calorieAdjustmentInput.addEventListener('input', () => {
                 let value = parseFloat(calorieAdjustmentInput.value);
                 if (isNaN(value)) {
                     const dataCorrente = new Date(giornoVisualizzato);
                     value = DEFICIT_PREIMPOSTATO_SETTIMANALE[dataCorrente.getDay()] || 0;
                 }
                 datiGiornalieri.calorieAdjustment = Math.max(-500, Math.min(500, value));
                 aggiornaUI();
                 salvaGiorno(giornoVisualizzato, datiGiornalieri);
                 renderMealBuilder();
            });
            btnCalorieMinus.addEventListener('click', () => handleCalorieAdjustment(-10));
            btnCaloriePlus.addEventListener('click', () => handleCalorieAdjustment(10));

            try {
                if (!getApps().some(app => app.name === "globalTrackerApp")) { firebaseApp = initializeApp(firebaseConfig, "globalTrackerApp"); } else { firebaseApp = getApp("globalTrackerApp"); }
                db = getDatabase(firebaseApp);
                auth = getAuth(firebaseApp);
                functions = getFunctions(firebaseApp, 'europe-west1');
                window.functions = functions; // Esporta per la chat AI
                console.log("Firebase inizializzato.");

                onAuthStateChanged(auth, async (user) => {
                    const isLoggedIn = !!user;
                    currentUserUID = user?.uid;
                    authFormFields.style.display = isLoggedIn ? 'none' : 'block';
                    document.getElementById('auth-header').style.display = isLoggedIn ? 'none' : 'block';
                    welcomeMessage.style.display = isLoggedIn ? 'block' : 'none';
                    welcomeMessage.textContent = isLoggedIn ? `Benvenuto, ${user.email}!` : '';
                    btnSignOut.style.display = isLoggedIn ? 'block' : 'none';
                    authStatusP.textContent = isLoggedIn ? '' : "Non autenticato";
                    authSection.classList.toggle('logged-in', isLoggedIn);
                    mainTrackerContent.classList.toggle('authenticated', isLoggedIn);
                    cloudSyncStatusSpan.textContent = `Connessione Cloud: ${isLoggedIn ? user.email : 'Disconnesso'}`;
                    cloudSyncStatusSpan.className = `cloud-sync-status ${isLoggedIn ? 'connected' : 'disconnected'}`;
                    cloudSyncSection.querySelectorAll('button').forEach(button => button.disabled = !isLoggedIn);
                    
                    if (isLoggedIn) {
                        const lastLocalUpdate = parseInt(localStorage.getItem(LOCAL_LAST_UPDATE_KEY) || 0);
                        const cloudTimestampSnapshot = await get(ref(db, `users/${currentUserUID}/${CLOUD_LAST_UPDATE_PATH}`));
                        const lastCloudUpdate = cloudTimestampSnapshot.exists() ? cloudTimestampSnapshot.val() : 0;
                        
                        setTimeout(async () => {
                            if (lastCloudUpdate > lastLocalUpdate) {
                               if (confirm("I dati sul cloud sono pi√π recenti. Vuoi scaricarli ora e sovrascrivere i dati locali?")) {
                                    await loadAllTrackerDataFromCloud(true);
                               }
                            }
                        }, 500);
                    }
                });
            } catch (error) { console.error("Errore Firebase:", error); authStatusP.textContent = `Errore Firebase: ${error.message}`; }

            const authHandlers = {
                register: () => createUserWithEmailAndPassword(auth, userEmailInput.value, userPasswordInput.value),
                login: () => signInWithEmailAndPassword(auth, userEmailInput.value, userPasswordInput.value),
                signOut: () => signOut(auth)
            };
            btnRegister.addEventListener('click', async () => { try { await authHandlers.register(); alert("Registrazione completata!"); } catch (e) { alert(e.message); } });
            btnLogin.addEventListener('click', async () => { try { await authHandlers.login(); alert("Accesso effettuato!"); } catch (e) { alert(e.message); } });
            btnSignOut.addEventListener('click', async () => { try { await authHandlers.signOut(); alert("Disconnessione avvenuta."); } catch (e) { alert(e.message); } });
            
            async function loadAllTrackerDataFromCloud(skipConfirm = false) {
                const dataRef = (db && currentUserUID) ? ref(db, `users/${currentUserUID}/tracker_data/`) : null;
                if (!dataRef) { alert("Devi essere autenticato."); return; }
                if (!skipConfirm && !confirm("ATTENZIONE: i dati locali verranno SOVRASCRITTI. Continuare?")) return;

                try {
                    const snapshot = await get(dataRef);
                    if (snapshot.exists()) {
                        const cloudData = snapshot.val();
                        const keysToRemove = [];
                        for (let i = 0; i < localStorage.length; i++) {
                            const key = localStorage.key(i);
                            if (key.startsWith('trackerStorico_') || LOCAL_STORAGE_SYNC_KEYS.includes(key) || key.startsWith('lastMealTypeSelected_')) {
                                keysToRemove.push(key);
                            }
                        }
                        keysToRemove.forEach(key => localStorage.removeItem(key));
                        
                        for (const key in cloudData) {
                            localStorage.setItem(key, typeof cloudData[key] === 'object' ? JSON.stringify(cloudData[key]) : cloudData[key]);
                        }
                        
                        const cloudTimestampSnapshot = await get(ref(db, `users/${currentUserUID}/${CLOUD_LAST_UPDATE_PATH}`));
                        localStorage.setItem(LOCAL_LAST_UPDATE_KEY, cloudTimestampSnapshot.exists() ? cloudTimestampSnapshot.val() : Date.now());
                        
                        alert("Dati scaricati con successo! La pagina verr√† ricaricata.");
                        location.reload();
                    } else { if (!skipConfirm) alert("Nessun dato trovato sul cloud."); }
                } catch (error) { alert(`Errore download: ${error.message}`); }
            }
            
            btnDownloadManual.addEventListener('click', () => loadAllTrackerDataFromCloud(false));

            function eseguiMigrazioneStorico() {
                const vecchioStoricoRaw = localStorage.getItem('trackerStorico');
                if (!vecchioStoricoRaw) return;
                try {
                    const vecchioStorico = JSON.parse(vecchioStoricoRaw);
                    if (Array.isArray(vecchioStorico)) {
                        vecchioStorico.forEach(giorno => { if (giorno.data && giorno.log) localStorage.setItem(`trackerStorico_${giorno.data}`, JSON.stringify(giorno)); });
                        localStorage.removeItem('trackerStorico'); 
                        alert("Storico aggiornato al nuovo formato! Ricarica la pagina.");
                    }
                } catch (e) { console.error("Errore migrazione storico.", e); }
            }

            btnCopyPrompt.addEventListener('click', async () => {
                const nome = builderDesc.value.trim(); if (!nome) { alert('Scrivi prima il nome dell\'alimento.'); return; }

                const sanitizedKey = sanitizeFirebaseKey(nome.toLowerCase());
                const foodData = foodDatabase[sanitizedKey];
                let ingredientiInfo = '';
                if (foodData && foodData.ingredienti) {
                    ingredientiInfo = `Considerando questa lista ingredienti: "${foodData.ingredienti}".`;
                }

                const promptText = `Fornisci ESATTAMENTE questo oggetto JSON (senza altro testo) con i valori nutrizionali medi per 100 g di "${nome}". ${ingredientiInfo} ${AI_INSTRUCTION}. ${GEMINI_PROMPT_FORMAT}`;
                try { await navigator.clipboard.writeText(promptText); alert('Richiesta AI copiata!'); } catch (err) { alert('Impossibile copiare.'); }
            });

            btnConfirmJson.addEventListener('click', () => {
                const jsonText = manualJsonInput.value.trim();
                const foodName = builderDesc.value.trim();

                if (!jsonText) { alert('Incolla prima il testo JSON.'); return; }
                if (!foodName) { alert("Inserisci il nome dell'alimento prima di confermare i dati JSON."); return; }
                
                try {
                    const newData = JSON.parse(jsonText);
                    const sanitizedKey = sanitizeFirebaseKey(foodName.toLowerCase());
                    const oldData = foodDatabase[sanitizedKey];
                    const isAnyFieldPopulated = oldData && Object.keys(oldData).length > 3;

                    if (!isAnyFieldPopulated) { 
                        for (const key in newData) {
                            if (inputFields[key]) inputFields[key].el.value = newData[key];
                        }
                        manualJsonInput.value = '';
                        aggiornaColoreNutrienti();
                        alert("Dati JSON compilati con successo.");
                        return;
                    }
                    
                    handleNutrientUpdate(foodName, oldData, newData);

                } catch (err) { alert('Errore nel formato JSON: ' + err.message); }
            });

            function handleNutrientUpdate(foodName, oldData, newData) {
                const SIGNIFICANT_DIFF_THRESHOLD = 0.10; // 10%
                const MINOR_DIFF_THRESHOLD = 0.02;     // 2%

                const differencesForModal = [];
                const autoAveragedValues = {};
                let averagedCount = 0;

                for (const key in newData) {
                    if (!inputFields[key]) continue;

                    const oldVal = parseFloat(oldData[key]);
                    const newVal = parseFloat(newData[key]);
                    
                    if (isNaN(newVal)) continue;
                    if (isNaN(oldVal)) {
                        autoAveragedValues[key] = newVal;
                        continue;
                    }

                    if (oldVal === 0 && newVal === 0) continue;
                    
                    const diffPercent = (oldVal === 0) ? Infinity : Math.abs((newVal - oldVal) / oldVal);

                    if (diffPercent > SIGNIFICANT_DIFF_THRESHOLD) {
                        differencesForModal.push({ 
                            key, 
                            label: inputFields[key].label, 
                            oldVal: oldData[key] ?? 0, 
                            newVal: newData[key] ?? 0
                        });
                    } else if (diffPercent > MINOR_DIFF_THRESHOLD) {
                        autoAveragedValues[key] = (oldVal + newVal) / 2;
                        averagedCount++;
                    }
                }
                
                const finalData = { ...oldData, ...autoAveragedValues };

                if (differencesForModal.length > 0) {
                    populateAndShowDiffModal(foodName, differencesForModal, finalData);
                } else {
                    const sanitizedKey = sanitizeFirebaseKey(foodName.toLowerCase());
                    foodDatabase[sanitizedKey] = finalData;
                    salvaFoodDatabase();
                    
                    for (const key in finalData) {
                        if (inputFields[key]) {
                            inputFields[key].el.value = finalData[key] ?? '';
                        }
                    }
                    manualJsonInput.value = '';
                    let alertMessage = "Nessuna differenza rilevante trovata. ";
                    if(averagedCount > 0) {
                        alertMessage += `${averagedCount} valori simili sono stati aggiornati automaticamente con la loro media.`
                    }
                    alert(alertMessage);
                }
            }

            function populateAndShowDiffModal(foodName, differences, initialData) {
                const diffList = document.getElementById('diff-modal-list');
                document.getElementById('diff-modal-title').textContent = `Confronta Valori per "${foodName}"`;
                diffList.innerHTML = '';
                diffList.dataset.initialData = JSON.stringify(initialData);

                differences.forEach(({key, label, oldVal, newVal}) => {
                    const item = document.createElement('div');
                    item.className = 'diff-item';
                    item.dataset.key = key;
                    item.dataset.oldVal = oldVal;
                    item.dataset.newVal = newVal;
                    item.innerHTML = `
                        <span class="diff-item-label">${label.replace('/100g', '')}</span>
                        <div class="diff-item-choices">
                            <label><input type="radio" name="diff-${key}" value="current" checked> <span class="current-value">Corrente: ${oldVal}</span></label>
                            <label><input type="radio" name="diff-${key}" value="new"> <span class="new-value">Nuovo: ${newVal}</span></label>
                        </div>
                    `;
                    diffList.appendChild(item);
                });
                diffModal.style.display = 'block';
            }
            
            document.getElementById('btn-apply-diff').addEventListener('click', () => {
                const foodName = builderDesc.value.trim();
                const sanitizedKey = sanitizeFirebaseKey(foodName.toLowerCase());
                const diffList = document.getElementById('diff-modal-list');
                const updatedData = JSON.parse(diffList.dataset.initialData);

                document.querySelectorAll('#diff-modal-list .diff-item').forEach(item => {
                    const key = item.dataset.key;
                    const choice = item.querySelector('input[type="radio"]:checked').value;
                    const valueToKeep = (choice === 'new') ? item.dataset.newVal : item.dataset.oldVal;
                    updatedData[key] = parseFloat(valueToKeep);
                });
                
                foodDatabase[sanitizedKey] = updatedData;
                salvaFoodDatabase();

                for (const key in updatedData) {
                    if (inputFields[key]) {
                        inputFields[key].el.value = updatedData[key] ?? '';
                    }
                }
                
                diffModal.style.display = 'none';
                manualJsonInput.value = '';
                alert(`Valori per "${foodName}" aggiornati con successo.`);
            });

            document.getElementById('btn-cancel-diff').addEventListener('click', () => {
                diffModal.style.display = 'none';
            });
            
            btnEditIngredients.addEventListener('click', () => {
                const foodName = builderDesc.value.trim();
                openIngredientModal(foodName, false);
            });

            btnSaveIngredients.addEventListener('click', () => {
                const foodName = ingredientModalTitle.textContent;
                const sanitizedKey = sanitizeFirebaseKey(foodName.toLowerCase());
                
                if (!foodDatabase[sanitizedKey]) {
                    foodDatabase[sanitizedKey] = { desc: foodName };
                }
                
                foodDatabase[sanitizedKey].ingredienti = ingredientModalTextarea.value.trim();
                salvaFoodDatabase();
                alert(`Ingredienti per "${foodName}" salvati.`);
                ingredientModal.style.display = 'none';
            });

            btnGenerateIngredientsAi.addEventListener('click', async (e) => {
                const foodName = ingredientModalTitle.textContent;
                const existingText = ingredientModalTextarea.value.trim();
                
                if (!foodName && !existingText) {
                    alert("Inserisci un nome per l'alimento o del testo da riformattare.");
                    return;
                }
                
                const button = e.target.closest('button');
                button.disabled = true;
                const originalText = ingredientModalTextarea.value;
                ingredientModalTextarea.value = "Elaborazione AI in corso...";
                ingredientModalTextarea.disabled = true;

                try {
                    let prompt;
                    
                    if (existingText) {
                        prompt = `Agisci come un esperto di etichette alimentari. Riformatta il seguente testo per creare una lista di ingredienti pulita e ben formattata, in ordine decrescente di quantit√† e con percentuali stimate ove possibile. Rimuovi qualsiasi informazione che non sia un ingrediente (come istruzioni, note o frasi superflue). Rispondi ESCLUSIVAMENTE con la lista pulita, senza frasi introduttive o conclusive. Testo da pulire: "${existingText}"`;
                    } else {
                        prompt = `Agisci come un esperto di etichette alimentari. Genera una lista di ingredienti per il prodotto commerciale "${foodName}". Rispondi ESCLUSIVAMENTE con la lista, senza frasi introduttive o conclusive. Il formato deve essere un elenco puntato, un ingrediente per riga. √à FONDAMENTALE che la lista rifletta il contenuto di un PRODOTTO CONFEZIONATO (es. un sacchetto di minestrone surgelato), NON una ricetta per prepararlo. Pertanto, NON includere ingredienti come acqua aggiunta in cottura, olio, sale o pasta, a meno che non siano specificati come pre-inseriti nel prodotto. Se non conosci l'etichetta esatta, basati su prodotti concorrenti simili dei supermercati.`;
                    }

                    const callGemini = httpsCallable(window.functions, 'callOpenAI');
                    const result = await callGemini({ prompt: prompt });
                    const data = result.data;
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || 'Nessuna risposta dall\'AI.';

                    ingredientModalTextarea.value = text.replace(/[\*]/g, '-').trim();

                } catch (err) {
                    alert('Errore generazione ingredienti: ' + err.message);
                    ingredientModalTextarea.value = originalText;
                } finally {
                    button.disabled = false;
                    ingredientModalTextarea.disabled = false;
                }
            });

            btnCopyIngredientsPrompt.addEventListener('click', async () => {
                const foodName = ingredientModalTitle.textContent;
                const prompt = `Agisci come un esperto di etichette alimentari. Genera una lista di ingredienti per il prodotto commerciale "${foodName}". Rispondi ESCLUSIVAMENTE con la lista, senza frasi introduttive o conclusive. Il formato deve essere un elenco puntato, un ingrediente per riga. √à FONDAMENTALE che la lista rifletta il contenuto di un PRODOTTO CONFEZIONATO (es. un sacchetto di minestrone surgelato), NON una ricetta per prepararlo. Pertanto, NON includere ingredienti come acqua aggiunta in cottura, olio, sale o pasta, a meno che non siano specificati come pre-inseriti nel prodotto. Se non conosci l'etichetta esatta, basati su prodotti concorrenti simili dei supermercati.`;
                try {
                    await navigator.clipboard.writeText(prompt);
                    alert('Prompt per ingredienti copiato!');
                } catch (err) {
                    alert('Impossibile copiare il prompt.');
                }
            });

            btnClearIngredients.addEventListener('click', () => {
                ingredientModalTextarea.value = '';
                ingredientModalTextarea.focus();
            });
            
            btnPhotoIngredients.addEventListener('click', () => {
                ingredientPhotoInput.click();
            });

            ingredientPhotoInput.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                ocrStatusIngredients.textContent = 'Elaborazione immagine...';
                ocrStatusIngredients.style.display = 'block';
                ingredientModalTextarea.disabled = true;

                try {
                    const { data: { text } } = await Tesseract.recognize(file, 'ita');
                    ingredientModalTextarea.value += (ingredientModalTextarea.value ? '\n' : '') + text;
                } catch (error) {
                    console.error(error);
                    ocrStatusIngredients.textContent = "Errore nel riconoscimento.";
                    setTimeout(() => { ocrStatusIngredients.style.display = 'none'; }, 3000);
                } finally {
                    ocrStatusIngredients.style.display = 'none';
                    ingredientModalTextarea.disabled = false;
                    ingredientPhotoInput.value = '';
                }
            });
            
            btnPhotoNutrients.addEventListener('click', () => {
                nutrientPhotoInput.click();
            });

            nutrientPhotoInput.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (file) {
                    processOCRImage(file);
                }
            });
            
            btnConfirmNutrients.addEventListener('click', () => {
                const inputs = nutrientConfirmList.querySelectorAll('input');
                inputs.forEach(input => {
                    const key = input.dataset.nutrientKey;
                    const value = input.value;
                    if(inputFields[key]) {
                        inputFields[key].el.value = value;
                    }
                });
                nutrientConfirmModal.style.display = 'none';
                aggiornaColoreNutrienti();
            });

            btnCancelNutrients.addEventListener('click', () => {
                nutrientConfirmModal.style.display = 'none';
            });
            
            const btnExportAi = document.getElementById('btn-export-json-ai');
            if (btnExportAi) {
                btnExportAi.addEventListener('click', async () => {
                    const dataRef = new Date(giornoVisualizzato);
                    const piano = PIANO_SETTIMANALE[dataRef.getDay()] || PIANO_SETTIMANALE[1];
                    const targetKcal = piano.cal_base + (datiGiornalieri.workoutCalorie || 0) + (datiGiornalieri.calorieAdjustment || 0);
                    
                    const allNutrientKeys = [
                        'prot', 'kcal', 'carb', 'zuccheri', 'fatTotal', 'fatSat', 'fatTrans', 
                        'fatMono', 'fatPoly', 'omega3', 'omega6', 'fibreTotali', 'fibreSolubili', 'fibreInsolubili',
                        'na', 'mg', 'k', 'vitc', 'ca', 'fe', 'zn', 'cu', 'p', 
                        'vitA', 'vitB12', 'vitD', 'vitE', 'vitK', 'b9', 'b2', 'b6',
                        'leu', 'iso', 'val', 'lys', 'met', 'phe', 'thr', 'trp', 'his'
                    ];

                    let dailyTotals = {};
                    allNutrientKeys.forEach(k => dailyTotals[k] = 0);

                    const logDettagliato = [];

                    (datiGiornalieri.log || []).forEach(entry => {
                        if (entry.type === 'workout') return;

                        const items = entry.type === 'meal' ? entry.items : [entry];
                        const itemsExport = items.map(item => {
                            const cleanItem = {
                                alimento: item.desc,
                                qta_g: item.qta
                            };
                            
                            allNutrientKeys.forEach(key => {
                                const val = item[key];
                                if (val !== undefined && val !== null && (val > 0 || key === 'kcal' || key === 'prot')) {
                                    cleanItem[key] = Number(val.toFixed(2));
                                    dailyTotals[key] += val;
                                }
                            });
                            
                            if (!item.kcal && !item.cal) cleanItem._WARNING = "Kcal a 0 o mancanti";
                            
                            return cleanItem;
                        });

                        logDettagliato.push({
                            tipo: entry.type === 'meal' ? `Pasto: ${entry.desc}` : 'Alimento Singolo',
                            dettagli: itemsExport
                        });
                    });

                    const fullExportData = {
                        meta: {
                            data: giornoVisualizzato,
                            giorno_tipo: piano.tipo,
                            note_utente: datiGiornalieri.note || "Nessuna nota"
                        },
                        cruscotto_totali: {
                            MACROS: {
                                Kcal: { consumate: dailyTotals.kcal.toFixed(0), target: targetKcal },
                                Proteine: { consumate: dailyTotals.prot.toFixed(1), target: piano.prot },
                                Carboidrati: { consumate: dailyTotals.carb.toFixed(1), target: piano.carb },
                                Grassi: { consumate: dailyTotals.fatTotal.toFixed(1), target: OBIETTIVI_FAT.fatTotal }
                            },
                            MICROS_CRITICI: {
                                Fibre: dailyTotals.fibreTotali.toFixed(1),
                                Zuccheri: dailyTotals.zuccheri.toFixed(1),
                                Grassi_Saturi: dailyTotals.fatSat.toFixed(1),
                                Sodio: dailyTotals.na.toFixed(0),
                                Potassio: dailyTotals.k.toFixed(0)
                            },
                            OMEGA_RATIO: (dailyTotals.omega3 > 0) ? `1:${(dailyTotals.omega6/dailyTotals.omega3).toFixed(1)}` : "N/D"
                        },
                        allenamento: {
                            descrizione: (datiGiornalieri.log || []).filter(e => e.type === 'workout').map(e => e.desc).join(", ") || "Riposo",
                            kcal_bruciate: datiGiornalieri.workoutCalorie || 0
                        },
                        diario_alimentare_completo: logDettagliato
                    };

                    try {
                        const jsonString = JSON.stringify(fullExportData, null, 2);
                        await navigator.clipboard.writeText(jsonString);
                        alert("‚úÖ Dati COMPLETI copiati (Nutrienti, Micros, Log)!\n\nIncolla su ChatGPT/Gemini e chiedi:\n'Analizza questo JSON. Cerca anomalie nei dati (es. cibi con calorie a zero) e dammi un parere nutrizionale.'");
                    } catch (err) {
                        console.error("Errore copia:", err);
                        alert("Errore nella copia automatica. Controlla la console.");
                    }
                });
            }
        
        // ESPORTA VARIABILI PER LA CHAT AI
        window.giornoVisualizzato = giornoVisualizzato;
        window.datiGiornalieri = datiGiornalieri;
        window.PIANO_SETTIMANALE = PIANO_SETTIMANALE;
        window.OBIETTIVI_FAT = OBIETTIVI_FAT;
        window.OBIETTIVI_MICRO = OBIETTIVI_MICRO;
        window.OBIETTIVI_VIT = OBIETTIVI_VIT;
        window.OBIETTIVI_AMINO = OBIETTIVI_AMINO;
        window.OBIETTIVI_FIBRE = OBIETTIVI_FIBRE;
        window.PROFILO_AMINOACIDICO_RIFERIMENTO = PROFILO_AMINOACIDICO_RIFERIMENTO;
        window.salvaGiorno = salvaGiorno;
        window.aggiornaUI = aggiornaUI;
        window.foodDatabase = foodDatabase;
        window.salvaFoodDatabase = salvaFoodDatabase;
        window.sanitizeFirebaseKey = sanitizeFirebaseKey;

});
    </script>

    <!-- CHAT AI INTEGRATA -->
    <div id="ai-chat-widget" class="ai-chat-widget minimized">
        <div class="ai-chat-header" id="ai-chat-toggle">
            <span>ü§ñ Assistente AI Nutrizionale</span>
            <span class="ai-chat-toggle-icon">‚ñ≤</span>
        </div>
        <div class="ai-chat-body" id="ai-chat-body">
    <div class="ai-chat-settings" id="ai-chat-settings" style="display: none;">
        <h4>üîë Gestione API Key</h4>
        <input type="password" id="ai-api-key-input" placeholder="Incolla qui la chiave di Gemini...">
        <div class="ai-chat-settings-buttons">
            <button id="ai-save-api-key">üíæ Salva</button>
            <button id="ai-close-settings">‚ùå Chiudi</button>
        </div>
    </div>

    <div class="ai-chat-messages" id="ai-chat-messages">
        <button id="ai-open-settings" title="Configura API" style="position: sticky; top: 0; float: right; background: none; border: none; cursor: pointer; color: #667eea; font-size: 1.2em; z-index: 10;">‚öôÔ∏è</button>
        
        <div class="ai-message ai-welcome">
            <strong>Ciao! Sono il tuo assistente nutrizionale.</strong><br><br>
            La chat √® ora integrata con il tuo database alimenti e il costruttore pasti.
        </div>
    </div>
    
    <div class="ai-chat-input-area">
        <input type="file" id="ai-chat-sleep-input" accept="image/*" style="display: none;">
        <button id="ai-chat-sleep-btn" class="ai-chat-sleep-btn" title="Screenshot sonno">üò¥</button>
        <textarea id="ai-chat-input" placeholder="Chiedimi consigli..." rows="2"></textarea>
        <button id="ai-chat-send" class="ai-chat-send-btn">‚û§</button>
    </div>
</div>
            <div class="ai-chat-input-area">
                <input type="file" id="ai-chat-sleep-input" accept="image/*" style="display: none;">
                <button id="ai-chat-sleep-btn" class="ai-chat-sleep-btn" title="Carica screenshot sonno">üò¥</button>
                <textarea id="ai-chat-input" placeholder="Chiedimi consigli nutrizionali..." rows="2"></textarea>
                <button id="ai-chat-send" class="ai-chat-send-btn">‚û§</button>
            </div>

            <div class="ai-chat-actions">
                <button id="ai-chat-export-data" class="ai-chat-action-btn">üìä Esporta Dati</button>
                <button id="ai-chat-clear" class="ai-chat-action-btn">üóëÔ∏è Pulisci Chat</button>
            </div>
        </div>
    </div>

    <!-- MODAL PER CONFERMA ALIMENTO DALLA CHAT -->
    <div id="ai-chat-food-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" data-modal="ai-chat-food-modal">&times;</span>
            <h2>Conferma Alimento Riconosciuto</h2>
            <p>L'AI ha riconosciuto questo alimento. Vuoi aggiungerlo al diario?</p>
            <div id="ai-chat-food-details" style="margin: 15px 0; padding: 15px; background: #f5f5f5; border-radius: 8px;"></div>
            <div class="button-group">
                <button id="ai-chat-food-cancel" style="background-color: #607d8b;">Annulla</button>
                <button id="ai-chat-food-confirm" style="background-color: #2e7d32;">Aggiungi al Diario</button>
            </div>
        </div>
    </div>

    <style>
        /* CHAT AI STYLES */
.ai-chat-widget {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 380px;
    max-width: calc(100vw - 40px);
    background: white;
    border-radius: 16px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.2);
    z-index: 9999;
    overflow: hidden;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    transition: all 0.3s ease-in-out; /* Transizione fluida per altezza e trasformazione */
    max-height: 600px; /* Altezza massima da aperta */
}

.ai-chat-widget.minimized {
    transform: translateY(calc(100% - 50px)); /* Sposta quasi tutto fuori dallo schermo */
    max-height: 50px; /* Forza l'altezza della sola barra viola */
}

        .ai-chat-widget.minimized {
            transform: translateY(calc(100% - 50px));
        }

        .ai-chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            font-size: 1.1em;
        }

        .ai-chat-toggle-icon {
            transition: transform 0.3s ease;
        }

        .ai-chat-widget.minimized .ai-chat-toggle-icon {
            transform: rotate(180deg);
        }

        .ai-chat-body {
            max-height: 500px;
            display: flex;
            flex-direction: column;
        }

        .ai-chat-messages {
            flex: 1;
            max-height: 350px;
            overflow-y: auto;
            padding: 15px;
            background: #f8f9fa;
        }

        .ai-message {
            margin-bottom: 12px;
            padding: 12px 15px;
            border-radius: 12px;
            max-width: 85%;
            word-wrap: break-word;
            font-size: 0.95em;
            line-height: 1.5;
            animation: fadeInMessage 0.3s ease;
        }

        @keyframes fadeInMessage {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .ai-message.user {
            background: #667eea;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }

        .ai-message.assistant {
            background: white;
            color: #333;
            margin-right: auto;
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .ai-message.assistant strong {
            color: #667eea;
        }

        .ai-message.ai-welcome {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            color: #333;
            max-width: 100%;
            border: 1px solid #e0e0e0;
        }

        .ai-message.loading {
            background: white;
            color: #888;
            font-style: italic;
        }

        .ai-message img {
            max-width: 100%;
            border-radius: 8px;
            margin-top: 8px;
        }

        .ai-chat-input-area {
            display: flex;
            padding: 12px 15px;
            background: white;
            border-top: 1px solid #e0e0e0;
            gap: 8px;
        }

        .ai-chat-input-area textarea {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 20px;
            padding: 10px 15px;
            resize: none;
            font-family: inherit;
            font-size: 0.95em;
            outline: none;
            transition: border-color 0.3s;
        }

        .ai-chat-input-area textarea:focus {
            border-color: #667eea;
        }

        .ai-chat-send-btn, .ai-chat-sleep-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 1.2em;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ai-chat-send-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .ai-chat-send-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .ai-chat-sleep-btn {
            background: #e3f2fd;
            font-size: 1.4em;
        }

        .ai-chat-sleep-btn:hover {
            background: #bbdefb;
            transform: scale(1.05);
        }

        .ai-chat-actions {
            display: flex;
            gap: 8px;
            padding: 0 15px 12px;
            background: white;
        }

        .ai-chat-action-btn {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #f5f5f5;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.3s;
        }

        .ai-chat-action-btn:hover {
            background: #e0e0e0;
        }

        .ai-chat-food-preview {
            background: #e8f5e9;
            border: 1px solid #4caf50;
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
        }

        .ai-chat-food-preview h4 {
            margin: 0 0 8px 0;
            color: #2e7d32;
        }

        .ai-chat-settings {
            padding: 15px;
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-bottom: 2px solid #4caf50;
        }

        .ai-chat-settings h4 {
            margin: 0 0 10px 0;
            color: #2e7d32;
        }

        .ai-chat-settings p {
            margin: 0 0 10px 0;
            font-size: 0.9em;
            color: #555;
        }

        .ai-chat-settings a {
            color: #1976d2;
            text-decoration: none;
        }

        .ai-chat-settings a:hover {
            text-decoration: underline;
        }

        .ai-chat-settings input {
            width: 100%;
            padding: 10px;
            border: 1px solid #4caf50;
            border-radius: 8px;
            margin-bottom: 10px;
            font-family: inherit;
        }

        .ai-chat-settings-buttons {
            display: flex;
            gap: 10px;
        }

        .ai-chat-settings-buttons button {
            flex: 1;
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .ai-chat-settings-buttons button:first-child {
            background: #4caf50;
            color: white;
        }

        .ai-chat-settings-buttons button:first-child:hover {
            background: #388e3c;
        }

        .ai-chat-settings-buttons button:last-child {
            background: #e0e0e0;
            color: #333;
        }

        .ai-chat-settings-buttons button:last-child:hover {
            background: #bdbdbd;
        }

        .ai-api-status {
            margin: 10px 0 0 0;
            font-size: 0.85em;
            font-weight: 600;
        }

        .ai-api-status.success {
            color: #2e7d32;
        }

        .ai-api-status.error {
            color: #d32f2f;
        }

        @media (max-width: 480px) {
            .ai-chat-widget {
                width: calc(100vw - 20px);
                right: 10px;
                bottom: 10px;
            }
        }

        .ai-chat-meal-buttons {
            margin-top: 10px;
        }

        .ai-chat-meal-buttons p {
            margin-bottom: 10px;
            color: #667eea;
        }

        .ai-chat-meal-buttons button {
            margin: 5px;
            padding: 8px 15px;
            border: 1px solid #667eea;
            border-radius: 20px;
            background: white;
            color: #667eea;
            cursor: pointer;
            transition: all 0.3s;
        }

        .ai-chat-meal-buttons button:hover {
            background: #667eea;
            color: white;
        }
    </style>

    <script>
        // CHAT AI INTEGRATA - GESTIONE
        (function() {
                        const chatWidget = document.getElementById('ai-chat-widget');
            const chatToggle = document.getElementById('ai-chat-toggle');
            const chatMessages = document.getElementById('ai-chat-messages');
            const chatInput = document.getElementById('ai-chat-input');
            const chatSend = document.getElementById('ai-chat-send');
            const chatSleepBtn = document.getElementById('ai-chat-sleep-btn');
            const chatSleepInput = document.getElementById('ai-chat-sleep-input');
            const chatExportBtn = document.getElementById('ai-chat-export-data');
            const chatClearBtn = document.getElementById('ai-chat-clear');
            const foodModal = document.getElementById('ai-chat-food-modal');
            const foodDetails = document.getElementById('ai-chat-food-details');
            const foodConfirm = document.getElementById('ai-chat-food-confirm');
            const foodCancel = document.getElementById('ai-chat-food-cancel');

// GESTIONE API KEY GEMINI
            const API_KEY_STORAGE = 'gemini_api_key';
            let geminiApiKey = localStorage.getItem(API_KEY_STORAGE) || '';

            // Elementi UI
            const apiKeyInput = document.getElementById('ai-api-key-input');
            const saveApiKeyBtn = document.getElementById('ai-save-api-key');
            const toggleApiKeyBtn = document.getElementById('ai-toggle-api-key');
            const apiStatus = document.getElementById('ai-api-status');
            const settingsPanel = document.getElementById('ai-chat-settings');

            // Carica API key salvata
            if (geminiApiKey) {
                apiKeyInput.value = geminiApiKey;
                showApiStatus('‚úÖ API key caricata!', 'success');
                updateWelcomeMessage();
            }

            // Salva API key
            saveApiKeyBtn.addEventListener('click', function() {
                const key = apiKeyInput.value.trim();
                if (key) {
                    geminiApiKey = key;
                    localStorage.setItem(API_KEY_STORAGE, key);
                    showApiStatus('‚úÖ API key salvata!', 'success');
                    updateWelcomeMessage();
                    // Nascondi impostazioni dopo 1 secondo
                    setTimeout(() => {
                        settingsPanel.style.display = 'none';
                    }, 1000);
                } else {
                    showApiStatus('‚ùå Inserisci una API key valida', 'error');
                }
            });

            // Mostra/nascondi API key
            toggleApiKeyBtn.addEventListener('click', function() {
                if (apiKeyInput.type === 'password') {
                    apiKeyInput.type = 'text';
                    toggleApiKeyBtn.textContent = 'üôà Nascondi';
                } else {
                    apiKeyInput.type = 'password';
                    toggleApiKeyBtn.textContent = 'üëÅÔ∏è Mostra';
                }
            });

            function showApiStatus(message, type) {
                apiStatus.textContent = message;
                apiStatus.className = 'ai-api-status ' + type;
            }

            function updateWelcomeMessage() {
                const welcomeMsg = chatMessages.querySelector('.ai-welcome');
                if (welcomeMsg && geminiApiKey) {
                    welcomeMsg.innerHTML = `
                        <strong>Ciao! Sono il tuo assistente nutrizionale.</strong><br><br>
                        Posso aiutarti a:<br>
                        ‚Ä¢ Analizzare i tuoi dati giornalieri<br>
                        ‚Ä¢ Consigliarti cosa mangiare<br>
                        ‚Ä¢ Analizzare screenshot del sonno<br>
                        ‚Ä¢ Compilare automaticamente gli alimenti<br><br>
                        <em>‚úÖ Pronto! Scrivi un messaggio o carica uno screenshot del sonno!</em>
                    `;
                }
            }

            // Chiama Gemini API direttamente
            async function callGeminiAPI(prompt) {
                if (!geminiApiKey) {
                    throw new Error('API key non configurata. Inseriscila nelle impostazioni.');
                }

                // La versione corretta con Gemini 2.0 Flash
var url = 'https://generativelanguage.googleapis.com/v1/models/gemini-2.0-flash:generateContent?key=' + geminiApiKey;

                var requestBody = {
                    contents: [
                        {
                            parts: [
                                { text: prompt }
                            ]
                        }
                    ],
                    generationConfig: {
                        temperature: 0.7,
                        maxOutputTokens: 2048
                    }
                };

                var fetchOptions = {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                };

                var response = await fetch(url, fetchOptions);

                if (!response.ok) {
                    var errorData = await response.json();
                    var errorMessage = 'Errore API Gemini';
                    if (errorData.error && errorData.error.message) {
                        errorMessage = errorData.error.message;
                    }
                    throw new Error(errorMessage);
                }

                var responseData = await response.json();
                var text = 'Nessuna risposta';
                if (responseData.candidates && responseData.candidates[0] && 
                    responseData.candidates[0].content && responseData.candidates[0].content.parts &&
                    responseData.candidates[0].content.parts[0]) {
                    text = responseData.candidates[0].content.parts[0].text;
                }
                return text;
            }


            let pendingFoodData = null;
            let chatHistory = JSON.parse(localStorage.getItem('aiChatHistory') || '[]');

            // Ripristina storico chat
            function loadChatHistory() {
                if (chatHistory.length > 0) {
                    chatMessages.innerHTML = '';
                    chatHistory.forEach(msg => {
                        addMessage(msg.content, msg.role, false);
                    });
                }
            }

            // Salva storico chat
            function saveChatHistory() {
                const messages = [];
                chatMessages.querySelectorAll('.ai-message').forEach(el => {
                    if (!el.classList.contains('ai-welcome') && !el.classList.contains('loading')) {
                        messages.push({
                            role: el.classList.contains('user') ? 'user' : 'assistant',
                            content: el.innerHTML
                        });
                    }
                });
                localStorage.setItem('aiChatHistory', JSON.stringify(messages.slice(-50)));
            }

            // Toggle chat
            chatToggle.addEventListener('click', () => {
                chatWidget.classList.toggle('minimized');
            });

            // Aggiungi messaggio alla chat
            function addMessage(content, role, save = true) {
                const msgDiv = document.createElement('div');
                msgDiv.className = 'ai-message ' + role;
                msgDiv.innerHTML = content;
                chatMessages.appendChild(msgDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                if (save) saveChatHistory();
            }

            // Mostra loading
            function showLoading() {
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'ai-message loading';
                loadingDiv.id = 'ai-chat-loading';
                loadingDiv.innerHTML = 'ü§î Sto pensando...';
                chatMessages.appendChild(loadingDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            // Nascondi loading
            function hideLoading() {
                const loading = document.getElementById('ai-chat-loading');
                if (loading) loading.remove();
            }

            // Preleva dati JSON completi del giorno
            function getDailyDataJSON() {
                const dataRef = new Date(window.giornoVisualizzato);
                const piano = window.PIANO_SETTIMANALE[dataRef.getDay()] || window.PIANO_SETTIMANALE[1];
                const targetKcal = piano.cal_base + (window.datiGiornalieri.workoutCalorie || 0) + (window.datiGiornalieri.calorieAdjustment || 0);

                const allNutrientKeys = [
                    'prot', 'kcal', 'carb', 'zuccheri', 'fatTotal', 'fatSat', 'fatTrans', 
                    'fatMono', 'fatPoly', 'omega3', 'omega6', 'fibreTotali', 'fibreSolubili', 'fibreInsolubili',
                    'na', 'mg', 'k', 'vitc', 'ca', 'fe', 'zn', 'cu', 'p', 
                    'vitA', 'vitB12', 'vitD', 'vitE', 'vitK', 'b9', 'b2', 'b6',
                    'leu', 'iso', 'val', 'lys', 'met', 'phe', 'thr', 'trp', 'his'
                ];

                let dailyTotals = {};
                allNutrientKeys.forEach(function(k) { dailyTotals[k] = 0; });

                const logDettagliato = [];

                (window.datiGiornalieri.log || []).forEach(function(entry) {
                    if (entry.type === 'workout') return;

                    const items = entry.type === 'meal' ? entry.items : [entry];
                    const itemsExport = items.map(function(item) {
                        const cleanItem = {
                            alimento: item.desc,
                            qta_g: item.qta
                        };

                        allNutrientKeys.forEach(function(key) {
                            const val = item[key];
                            if (val !== undefined && val !== null && (val > 0 || key === 'kcal' || key === 'prot')) {
                                cleanItem[key] = Number(val.toFixed(2));
                                dailyTotals[key] += val;
                            }
                        });

                        return cleanItem;
                    });

                    logDettagliato.push({
                        tipo: entry.type === 'meal' ? 'Pasto: ' + entry.desc : 'Alimento Singolo',
                        dettagli: itemsExport
                    });
                });

                return {
                    meta: {
                        data: window.giornoVisualizzato,
                        giorno_tipo: piano.tipo,
                        ora_corrente: new Date().toLocaleTimeString('it-IT'),
                        note_utente: window.datiGiornalieri.note || "Nessuna nota"
                    },
                    obiettivi: {
                        kcal: targetKcal,
                        proteine: piano.prot,
                        carboidrati: piano.carb,
                        grassi: window.OBIETTIVI_FAT.fatTotal
                    },
                    progresso_attuale: {
                        kcal: dailyTotals.kcal.toFixed(0),
                        proteine: dailyTotals.prot.toFixed(1),
                        carboidrati: dailyTotals.carb.toFixed(1),
                        grassi: dailyTotals.fatTotal.toFixed(1),
                        fibre: dailyTotals.fibreTotali.toFixed(1),
                        omega3: dailyTotals.omega3.toFixed(1),
                        omega6: dailyTotals.omega6.toFixed(1)
                    },
                    diario_alimentare: logDettagliato,
                    allenamento: {
                        descrizione: (window.datiGiornalieri.log || []).filter(function(e) { return e.type === 'workout'; }).map(function(e) { return e.desc; }).join(", ") || "Riposo",
                        kcal_bruciate: window.datiGiornalieri.workoutCalorie || 0
                    }
                };
            }

            // Chiama l'AI
            async function callAI(prompt, includeData) {
                try {
                    // Verifica che la API key sia configurata
                    if (!geminiApiKey) {
                        settingsPanel.style.display = 'block';
                        throw new Error('Inserisci la tua API key di Gemini nelle impostazioni qui sopra!');
                    }

                    // Prepara il prompt completo
                    let fullPrompt = prompt;
                    if (includeData) {
                        const dailyData = getDailyDataJSON();
                        fullPrompt = `Contesto: Oggi √® ${dailyData.meta.data}, giorno di ${dailyData.meta.giorno_tipo}.

I miei dati nutrizionali attuali sono:
- Calorie: ${dailyData.progresso_attuale.kcal}/${dailyData.obiettivi.kcal} kcal
- Proteine: ${dailyData.progresso_attuale.proteine}/${dailyData.obiettivi.proteine}g
- Carboidrati: ${dailyData.progresso_attuale.carboidrati}/${dailyData.obiettivi.carboidrati}g
- Grassi: ${dailyData.progresso_attuale.grassi}/${dailyData.obiettivi.grassi}g

Domanda dell utente: ${prompt}

ISTRUZIONI IMPORTANTI:
1. Rispondi SEMPRE in italiano in modo naturale e conversazionale
2. NON usare JSON nella risposta visibile all'utente
3. Se l'utente dice di aver mangiato qualcosa SENZA specificare la quantit√†, chiedi gentilmente "Quanti grammi hai mangiato?"
4. Se l'utente dice di aver mangiato qualcosa SENZA specificare il pasto, chiedi "Era per quale pasto? (merenda AM, pranzo, merenda PM, cena)"
5. Se l'utente ha gi√† mangiato quell'alimento in passato, puoi suggerire la stessa quantit√†
6. Alla fine della risposta, se ci sono alimenti da aggiungere, includi questa riga esatta: [AGGIUNGI: nome_alimento | quantit√†_g | pasto]`;
                    }

                    // Chiama Gemini API direttamente
                    const response = await callGeminiAPI(fullPrompt);
                    return response;

                } catch (err) {
                    console.error('Errore AI:', err);
                    return '‚ùå ' + err.message;
                }
            }

            // Gestisci invio messaggio
            async function sendMessage() {
                const message = chatInput.value.trim();
                if (!message) return;

                addMessage(message, 'user');
                chatInput.value = '';
                showLoading();

                const response = await callAI(message, true);
                hideLoading();

                // Formatta la risposta
                let formattedResponse = response
                    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\n/g, '<br>');

                addMessage(formattedResponse, 'assistant');

                // Parsa la risposta per cercare alimenti o allenamenti da aggiungere
                parseAIResponseForActions(response, message);
            }



            // Parsa la risposta dell'AI per trovare alimenti/allenamenti da aggiungere
            function parseAIResponseForActions(response, originalMessage) {
                // Cerca pattern [AGGIUNGI: nome | quantit√† | pasto] nella risposta
                const addPattern = /\[AGGIUNGI:\s*([^|]+)\s*\|\s*(\d+)\s*g?\s*\|\s*([^\]]+)\]/gi;
                let match;
                const foodsToAdd = [];

                while ((match = addPattern.exec(response)) !== null) {
                    foodsToAdd.push({
                        nome: match[1].trim(),
                        qta: parseInt(match[2]),
                        pasto: match[3].trim()
                    });
                }

                if (foodsToAdd.length > 0) {
                    // Chiedi conferma all'utente
                    setTimeout(() => {
                        const foodList = foodsToAdd.map(f => `${f.nome} (${f.qta}g) per ${f.pasto}`).join(', ');
                        if (confirm(`Vuoi aggiungere al diario: ${foodList}?`)) {
                            foodsToAdd.forEach(f => addFoodDirectly(f.nome, f.qta, f.pasto));
                        }
                    }, 500);
                    return;
                }

                // Se la risposta contiene domande su quantit√†/pasto, non fare nulla
                // (l'utente risponder√† nella prossima interazione)
                if (response.includes('Quanti grammi') || response.includes('quale pasto')) {
                    return;
                }

                // Cerca nel messaggio originale pattern di alimenti
                const foodPatterns = [
                    /ho\s+mangiat[oa]\s+([\w\s]+?)(?:\s+(\d+)\s*g)?/i,
                    /mangio\s+([\w\s]+?)(?:\s+(\d+)\s*g)?/i,
                    /([\w\s]+?)\s+(\d+)\s*g/i
                ];

                for (const pattern of foodPatterns) {
                    const match = originalMessage.match(pattern);
                    if (match) {
                        const nome = match[1].trim();
                        const qta = match[2] ? parseInt(match[2]) : null;

                        if (nome.length > 2) {
                            // Cerca nel database se abbiamo gi√† questo alimento
                            const lastQty = findLastQuantityForFood(nome);

                            if (!qta && lastQty) {
                                // Suggerisci la quantit√† precedente
                                setTimeout(() => {
                                    if (confirm(`Hai gi√† mangiato ${nome} in passato (${lastQty}g). Vuoi aggiungerlo con la stessa quantit√†?`)) {
                                        askForMealType(nome, lastQty);
                                    }
                                }, 500);
                            } else if (!qta) {
                                // Chiedi la quantit√†
                                // La AI dovrebbe gi√† averlo chiesto, ma come fallback:
                                addMessage(`Quanti grammi di ${nome} hai mangiato?`, 'assistant');
                            } else {
                                // Abbiamo quantit√†, chiedi il pasto
                                askForMealType(nome, qta);
                            }
                            return;
                        }
                    }
                }

                // Cerca pattern di allenamento
                const workoutPatterns = [
                    /allenamento\s+(?:di\s+)?([\w\s]+?)(?:\s+(\d+)\s*kcal)?/i,
                    /(?:corsa|pesistica|workout)\s+(?:di\s+)?([\w\s]*?)(?:\s+(\d+)\s*kcal)?/i
                ];

                for (const pattern of workoutPatterns) {
                    const match = originalMessage.match(pattern);
                    if (match) {
                        const desc = match[1].trim() || 'Allenamento';
                        const kcal = match[2] ? parseInt(match[2]) : null;

                        if (kcal && kcal > 0) {
                            setTimeout(() => {
                                if (confirm(`Vuoi registrare l'allenamento "${desc} (${kcal} kcal)"?`)) {
                                    addWorkoutDirectly(desc, kcal);
                                }
                            }, 500);
                            return;
                        }
                    }
                }
            }

            // Trova l'ultima quantit√† usata per un alimento
            function findLastQuantityForFood(nome) {
                const sanitizedKey = window.sanitizeFirebaseKey(nome.toLowerCase());
                const foodData = window.foodDatabase[sanitizedKey];
                if (foodData && foodData.lastQta) {
                    return foodData.lastQta;
                }

                // Cerca nel diario degli ultimi 7 giorni
                const today = new Date();
                for (let i = 0; i < 7; i++) {
                    const dateToCheck = new Date(today);
                    dateToCheck.setDate(today.getDate() - i);
                    const dateString = dateToCheck.toISOString().split('T')[0];
                    const dailyDataRaw = localStorage.getItem(`trackerStorico_${dateString}`);

                    if (dailyDataRaw) {
                        try {
                            const dailyData = JSON.parse(dailyDataRaw);
                            if (dailyData && dailyData.log) {
                                for (const entry of dailyData.log) {
                                    if (entry.type === 'workout') continue;
                                    const items = entry.type === 'meal' ? entry.items : [entry];
                                    for (const item of items) {
                                        if (item.desc && item.desc.toLowerCase().includes(nome.toLowerCase())) {
                                            return item.qta;
                                        }
                                    }
                                }
                            }
                        } catch (e) {}
                    }
                }
                return null;
            }

            // Chiedi il tipo di pasto
            function askForMealType(nome, qta) {
                // Crea i bottoni per selezionare il pasto
                const mealButtons = document.createElement('div');
                mealButtons.className = 'ai-chat-meal-buttons';
                mealButtons.innerHTML = `
                    <p><strong>${nome} (${qta}g)</strong> - Per quale pasto?</p>
                    <button data-meal="merenda1">Merenda AM</button>
                    <button data-meal="pranzo">Pranzo</button>
                    <button data-meal="merenda2">Merenda PM</button>
                    <button data-meal="cena">Cena</button>
                `;

                const msgDiv = document.createElement('div');
                msgDiv.className = 'ai-message assistant';
                msgDiv.appendChild(mealButtons);
                document.getElementById('ai-chat-messages').appendChild(msgDiv);
                document.getElementById('ai-chat-messages').scrollTop = document.getElementById('ai-chat-messages').scrollHeight;

                // Aggiungi event listeners
                mealButtons.querySelectorAll('button').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const pasto = btn.dataset.meal;
                        addFoodDirectly(nome, qta, pasto);
                        msgDiv.remove();
                    });
                });
            }

            // Aggiungi alimento direttamente al diario (con dati AI)
// Funzione aggiornata per consultare il database e usare il Costruttore Pasti
async function addFoodDirectly(nome, qta, pasto) {
    try {
        const sanitizedInput = nome.toLowerCase().trim();
        const keys = Object.keys(window.foodDatabase);
        
        // 1. CERCA NEL DATABASE LOCALE (Il pezzo forte)
        const matches = keys.filter(k => k.includes(window.sanitizeFirebaseKey(sanitizedInput)));
        
        // Caso A: Pi√π corrispondenze trovate -> Mostra tasti di scelta
        if (matches.length > 1) {
            const choiceButtons = document.createElement('div');
            choiceButtons.className = 'ai-chat-meal-buttons';
            choiceButtons.innerHTML = `<p>Ho trovato pi√π corrispondenze per "<strong>${nome}</strong>". Quale intendi?</p>`;
            
            matches.forEach(m => {
                const btn = document.createElement('button');
                btn.textContent = window.foodDatabase[m].desc;
                btn.onclick = () => {
                    choiceButtons.parentElement.parentElement.remove(); // Rimuove il messaggio dei tasti
                    addFoodDirectly(window.foodDatabase[m].desc, qta, pasto);
                };
                choiceButtons.appendChild(btn);
            });
            
            const msgDiv = document.createElement('div');
            msgDiv.className = 'ai-message assistant';
            msgDiv.appendChild(choiceButtons);
            document.getElementById('ai-chat-messages').appendChild(msgDiv);
            document.getElementById('ai-chat-messages').scrollTop = document.getElementById('ai-chat-messages').scrollHeight;
            return;
        }

        let foodItem;
        const exactKey = window.sanitizeFirebaseKey(sanitizedInput);

        // Caso B: Corrispondenza trovata (esatta o singola parziale)
        if (matches.length === 1 || window.foodDatabase[exactKey]) {
            const dbKey = matches[0] || exactKey;
            const dbData = window.foodDatabase[dbKey];
            
            foodItem = {
                desc: dbData.desc,
                qta: qta,
                selezionato: true,
                ingredienti: dbData.ingredienti || null
            };

            // Calcola i nutrienti in base alla quantit√† richiesta
            for (const key in dbData) {
                if (key !== 'lastQta' && key !== 'desc' && key !== 'ingredienti') {
                    foodItem[key] = ((dbData[key] ?? 0) / 100) * qta;
                }
            }
            addMessage(`‚úÖ Uso i dati dal tuo database per: <strong>${dbData.desc}</strong>.`, 'assistant');
        } 
        // Caso C: Alimento nuovo -> Chiedi se salvarlo nel DB
        else {
            const saveConfirmDiv = document.createElement('div');
            saveConfirmDiv.className = 'ai-chat-meal-buttons';
            saveConfirmDiv.innerHTML = `<p>"<strong>${nome}</strong>" non √® nel tuo database. Vuoi che lo cerchi online e lo <strong>salvi nel database</strong> per il futuro?</p>
                <button id="btn-save-yes">S√¨, salva nel DB</button>
                <button id="btn-save-no">No, solo per stavolta</button>`;
            
            const msgDiv = document.createElement('div');
            msgDiv.className = 'ai-message assistant';
            msgDiv.appendChild(saveConfirmDiv);
            document.getElementById('ai-chat-messages').appendChild(msgDiv);

            return new Promise((resolve) => {
                msgDiv.querySelector('#btn-save-yes').onclick = async () => {
                    msgDiv.remove();
                    const data = await fetchAndBuildFood(nome, qta, true);
                    resolve(finishFoodAddition(data, pasto));
                };
                msgDiv.querySelector('#btn-save-no').onclick = async () => {
                    msgDiv.remove();
                    const data = await fetchAndBuildFood(nome, qta, false);
                    resolve(finishFoodAddition(data, pasto));
                };
            });
        }

        finishFoodAddition(foodItem, pasto);

    } catch (err) {
        console.error('Errore:', err);
        addMessage(`‚ùå Si √® verificato un errore nel caricamento.`, 'assistant');
    }
}

// Funzione di supporto per ottenere dati AI
async function fetchAndBuildFood(nome, qta, shouldSaveToDB) {
    addMessage(`üîç Cerco i valori per ${nome}...`, 'assistant');
    const callGemini = window.httpsCallable(window.functions, 'callOpenAI');
    const prompt = `Fornisci ESATTAMENTE questo oggetto JSON (senza altro testo) con i valori nutrizionali medi per 100g di "${nome}". Agisci come un esperto nutrizionista. {"prot":g,"kcal":kcal,"carb":g,"zuccheri":g,"fatSat":g,"fatTrans":g,"fatMono":g,"fatPoly":g,"omega3":g,"omega6":g,"fibreTotali":g,"fibreSolubili":g,"fibreInsolubili":g,"na":mg,"mg":mg,"k":mg,"vitc":mg,"ca":mg,"vitA":ug,"vitB12":ug,"vitD":ug,"vitE":mg,"vitK":ug,"b9":ug,"b2":mg,"b6":mg,"fe":mg,"zn":mg,"cu":mg,"p":mg}`;
    
    const result = await callGemini({ prompt: prompt });
    const rawJson = result.data.candidates?.[0]?.content?.parts?.[0]?.text || '{}';
    const nutrients100g = JSON.parse(rawJson.replace(/```json|```/g, '').trim());

    if (shouldSaveToDB) {
        const dbKey = window.sanitizeFirebaseKey(nome.toLowerCase());
        window.foodDatabase[dbKey] = {
            desc: nome.charAt(0).toUpperCase() + nome.slice(1),
            lastQta: qta,
            ...nutrients100g
        };
        window.salvaFoodDatabase();
        addMessage(`üíæ <strong>${nome}</strong> √® stato salvato nel tuo database!`, 'assistant');
    }

    const foodItem = {
        desc: nome.charAt(0).toUpperCase() + nome.slice(1),
        qta: qta,
        selezionato: true
    };
    
    for (const key in nutrients100g) {
        foodItem[key] = (nutrients100g[key] / 100) * qta;
    }
    return foodItem;
}

// Funzione finale per spostare l'alimento nel costruttore
function finishFoodAddition(foodItem, pasto) {
    if (!window.pastoInCostruzione) window.pastoInCostruzione = [];
    window.pastoInCostruzione.push(foodItem);
    localStorage.setItem('trackerPastoInCostruzione', JSON.stringify(window.pastoInCostruzione));
    
    if (pasto) {
        const selector = document.getElementById('meal-type-selector');
        if (selector) selector.value = pasto;
    }

    const builderSection = document.getElementById('meal-builder-sezione');
    builderSection.dataset.visible = "true";
    builderSection.style.display = "block";
    
    // Aggiorna la UI del costruttore (usando la funzione globale esistente)
    if (typeof window.renderMealBuilder === 'function') {
        window.renderMealBuilder();
    }
    
    builderSection.scrollIntoView({ behavior: 'smooth' });
    addMessage(`üéØ <strong>${foodItem.desc}</strong> aggiunto al <strong>Costruttore Pasti</strong>.`, 'assistant');
}

            // Analizza screenshot sonno
            async function analyzeSleepImage(file) {
                showLoading();
                addMessage('üì∏ Ho caricato uno screenshot del sonno. Sto analizzando...', 'user');

                try {
                    // OCR sull'immagine
                    const { data: { text } } = await Tesseract.recognize(file, 'ita');

                    // Invia all'AI per analisi
                    const prompt = 'Analizza questi dati di sonno estratti da uno screenshot dell app Mi Fitness. Estrai: ore totali di sonno, qualit√† del sonno, fasi del sonno (leggero, profondo, REM), eventuali sveglie. Poi dammi consigli nutrizionali basati sulla qualit√† del sonno (es. se sonno scarso, suggerisci alimenti ricchi di magnesio e triptofano).\n\nTesto estratto:\n' + text;

                    const callGemini = window.httpsCallable(window.functions, 'callOpenAI');
                    const result = await callGemini({ prompt: prompt });
                    const data = result.data;
                    const response = data.candidates?.[0]?.content?.parts?.[0]?.text || 'Non sono riuscito ad analizzare i dati del sonno.';

                    hideLoading();
                    addMessage(response.replace(/\n/g, '<br>'), 'assistant');

                } catch (error) {
                    hideLoading();
                    addMessage('‚ùå Errore nell analisi dello screenshot. Assicurati che l immagine sia chiara.', 'assistant');
                    console.error(error);
                }
            }

            // Esporta dati per AI
            chatExportBtn.addEventListener('click', async function() {
                const data = getDailyDataJSON();
                const jsonString = JSON.stringify(data, null, 2);

                try {
                    await navigator.clipboard.writeText(jsonString);
                    addMessage('‚úÖ Dati JSON copiati negli appunti! Puoi incollarli dove preferisci.', 'assistant');
                } catch (err) {
                    addMessage('‚ùå Errore nella copia. Riprova.', 'assistant');
                }
            });

            // Pulisci chat
            chatClearBtn.addEventListener('click', function() {
                if (confirm('Vuoi cancellare la cronologia della chat?')) {
                    chatMessages.innerHTML = '<div class="ai-message ai-welcome"><strong>Chat pulita!</strong><br><br>Come posso aiutarti oggi?</div>';
                    localStorage.removeItem('aiChatHistory');
                }
            });

            // Event listeners
            chatSend.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });



            chatSleepBtn.addEventListener('click', function() {
                chatSleepInput.click();
            });

            chatSleepInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    analyzeSleepImage(file);
                }
                chatSleepInput.value = '';
            });

            // Chiudi modal alimento
            foodCancel.addEventListener('click', function() {
                foodModal.style.display = 'none';
                pendingFoodData = null;
            });

            foodConfirm.addEventListener('click', function() {
                if (pendingFoodData) {
                    // Aggiungi al diario
                    if (!window.datiGiornalieri.log) window.datiGiornalieri.log = [];
                    window.datiGiornalieri.log.push({
                        type: 'single',
                        desc: pendingFoodData.desc,
                        qta: pendingFoodData.qta,
                        prot: pendingFoodData.prot || 0,
                        kcal: pendingFoodData.kcal || 0
                    });
                    window.salvaGiorno(window.giornoVisualizzato, window.datiGiornalieri);
                    window.aggiornaUI();

                    addMessage('‚úÖ Aggiunto: ' + pendingFoodData.desc + ' (' + pendingFoodData.qta + 'g)', 'assistant');
                    foodModal.style.display = 'none';
                    pendingFoodData = null;
                }
            });

            // Inizializza
            loadChatHistory();

        })();
    </script>

</body>
</html>










