<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Tracker Nutrizionale Unificato</title>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        /* --- IMPOSTAZIONI GLOBALI E LAYOUT PRINCIPALE --- */
        :root {
            --header-height: 100px;
        }
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f7f9;
            color: #333;
        }
        .app-container {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        /* --- INTESTAZIONE FISSA CON NAVIGAZIONE --- */
        .app-header {
            padding: 15px;
            background-color: #ffffff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 100;
            height: var(--header-height);
            box-sizing: border-box;
            text-align: center;
            flex-shrink: 0;
        }
        .app-header h1 {
            margin: 0 0 10px 0;
            font-size: 1.5em;
            color: #0d47a1;
            border: none;
        }
        .page-navigation {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }
        .page-indicator {
            padding: 5px;
            cursor: pointer;
            color: #a0a0a0;
            font-weight: 600;
            font-size: 0.9em;
            transition: all 0.3s ease;
            border-bottom: 2px solid transparent;
        }
        .page-indicator.active {
            color: #1976d2;
            transform: scale(1.1);
            border-bottom-color: #1976d2;
        }
        .page-indicator.adjacent {
            color: #777;
            font-size: 0.8em;
        }

        /* --- CONTENITORE SWIPE --- */
        .swiper-container {
            flex-grow: 1;
            overflow: hidden;
        }
        .swiper-wrapper {
            display: flex;
            height: 100%;
            width: 400%; /* 4 pagine */
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .page {
            width: 100%;
            height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch; /* Scrolling fluido su iOS */
            padding: 20px;
            box-sizing: border-box;
            flex-shrink: 0;
        }
        
        /* --- STILI DEI COMPONENTI DA INDEX.HTML --- */
        .container { width: 100%; max-width: 800px; margin: 0 auto; }
        h1, h2, h3 { color: #0d47a1; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-top: 0; }
        h2 { font-size: 1.4em; margin-top: 30px; }
        h3 { font-size: 1.1em; color: #333; border-bottom: 1px solid #eee; margin-top: 20px; }
        h4 { font-size: 1em; color: #1565c0; margin-top: 20px; margin-bottom: 10px; font-weight: 600; }
        #titolo-giornata { text-align: center; color: #d84315; font-weight: 600; margin-bottom: 20px; padding: 10px; background-color: #fff3e0; border-radius: 8px; border: 1px solid #ffe0b2;}
        .sezione { margin-bottom: 25px; padding: 20px; background-color: #ffffff; border: 1px solid #e0e0e0; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        input[type="text"], input[type="number"], input[type="date"], select, input[type="email"], input[type="password"], textarea {
            width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 1em;
        }
        button { background-color: #1976d2; color: white; padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 1em; font-weight: 600; transition: background-color 0.3s; }
        button:hover { background-color: #1565c0; }
        #form-allenamento button { background-color: #2e7d32; }
        .nav-links { display: flex; gap: 10px; margin-bottom: 20px; }
        .nav-links a { flex-grow: 1; text-align: center; padding: 10px; background-color: #607d8b; color: white; text-decoration: none; border-radius: 6px; font-weight: 600; }
        #riepilogo p { font-size: 1.1em; margin: 8px 0; }
        progress { width: 100%; height: 15px; border-radius: 6px; margin-top: 2px; cursor: pointer; }
        progress.macro-progress { height: 25px; }
        table { border-collapse: collapse; margin-top: 15px; font-size: 0.9em; width: 100%; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; vertical-align: middle; }
        th { background-color: #f2f2f2; font-weight: 600; }
        .builder-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; }
        .button-group { display: flex; gap: 10px; margin-top: 15px; }
        #btn-costruisci-pasto { background-color: #ff8f00; }
        #btn-aggiungi-singolo { background-color: #5c6bc0; }
        #meal-builder-sezione[data-visible="false"] { display: none; }
        #meal-builder-sezione[data-visible="true"] { display: block; }
        #meal-builder-sezione { border-left-width: 5px; border-left-color: #ff8f00; }
        #btn-salva-pasto { background-color: #2e7d32; width: 100%; margin-top: 15px; }
        #caricamento-manuale { margin-top: 25px; padding-top: 20px; border-top: 1px solid #eee; border-left-color: #673ab7;}
        #caricamento-manuale div { display: flex; gap: 10px; align-items: center; }
        #caricamento-manuale input { flex-grow: 1; margin-bottom: 0; }
        #caricamento-manuale button { flex-grow: 0; width: auto; margin-bottom: 0; }
        .action-buttons { display: flex; justify-content: center; align-items: center; gap: 8px; }
        .action-buttons button { background: none; border: none; padding: 4px; font-size: 1.3em; line-height: 1; cursor: pointer; }
        .edit-btn { color: #1976d2; }
        .delete-btn { color: #d32f2f; }
        .meal-group-row { background-color: #f0f4f8; font-weight: bold; }
        .expand-arrow { cursor: pointer; display: inline-block; width: 20px; text-align: center; }
        .sub-item-row td { padding-left: 25px !important; background-color: #fff; font-style: italic; color: #555; border-bottom: 1px dotted #ccc; }
        .sub-item-row td:last-child { visibility: hidden; }
        .nutrients-warning { color: #d32f2f !important; }
        #meal-builder-summary { margin-bottom: 20px; padding: 15px; background-color: #e3f2fd; border: 1px solid #90caf9; border-radius: 8px; }
        #meal-builder-summary p { margin: 5px 0; font-weight: 600; color: #1e88e5; }
        #meal-builder-summary .progress-container { display: flex; gap: 20px; margin-top: 10px; }
        #meal-builder-summary .progress-item { flex: 1; }
        #meal-builder-summary .progress-item p { font-size: 0.9em; margin-bottom: 5px; color: #3f51b5; }
        #meal-builder-summary .progress-item progress { height: 18px; border-radius: 4px; }
        #calorie-balance-text { display: block; text-align: center; font-weight: bold; font-size: 1.2em; margin-top: 15px; margin-bottom: 10px; padding: 8px 0; border-radius: 5px; }
        .balance-deficit { background-color: #ffebee; color: #d32f2f; }
        .balance-surplus { background-color: #e8f5e9; color: #2e7d32; }
        .balance-even { background-color: #e3f2fd; color: #1976d2; }
        .collapsible-header { cursor: pointer; padding: 10px 0; border-bottom: 1px solid #e0e0e0; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; color: #0d47a1; font-size: 1.4em; }
        .collapsible-header:hover { color: #1976d2; }
        .collapsible-header .arrow { font-size: 0.8em; transition: transform 0.3s ease; }
        .collapsible-content { display: none; overflow: hidden; transition: max-height 0.3s ease-out; max-height: 0; }
        .collapsible-content.expanded { display: block; max-height: 2000px; }
        .collapsible-header.expanded .arrow { transform: rotate(90deg); }
        #calorie-adjuster { display: flex; align-items: center; justify-content: center; margin-top: 10px; margin-bottom: 20px; gap: 10px; }
        #calorie-adjuster button { padding: 5px 12px; font-size: 1.2em; border-radius: 5px; background-color: #4CAF50; color: white; border: none; cursor: pointer; }
        #calorie-adjuster button.minus { background-color: #f44336; }
        #calorie-adjuster input[type="number"] { width: 80px; text-align: center; font-size: 1.1em; padding: 8px; border: 1px solid #ccc; border-radius: 5px; }
        #calorie-adjuster label { margin-bottom: 0; font-weight: normal; color: #333; }
        .cloud-sync-section { display: flex; gap: 10px; margin-top: 20px; padding: 15px; background-color: #e0f2f7; border: 1px solid #b2ebf2; border-radius: 8px; flex-wrap: wrap; }
        .cloud-sync-section button { flex: 1 1 auto; min-width: 150px; margin-bottom: 5px; }
        .cloud-sync-section #btn-download-manual { background-color: #e64a19; }
        .cloud-sync-status { width: 100%; text-align: center; font-size: 0.9em; color: #555; margin-top: 10px; }
        .cloud-sync-status.connected { color: #2e7d32; font-weight: bold; }
        .cloud-sync-status.disconnected { color: #c62828; font-weight: bold; }
        #auth-section { border-left-width: 5px; border-left-color: #673ab7; }
        #auth-section h2 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        #auth-section .auth-buttons { display: flex; gap: 10px; }
        #auth-section .auth-buttons button { width: 50%; }
        #auth-section #btn-sign-out { background-color: #607d8b; display: none; margin-top: 15px; }
        #auth-status { text-align: center; font-weight: 600; margin-top: 15px; }
        #welcome-message { text-align: center; font-weight: bold; font-size: 1.2em; color: #0d47a1; margin-bottom: 10px; display: none; }
        #main-tracker-content { display: none; }
        #main-tracker-content.authenticated { display: block; }
        #auth-section.logged-in { padding: 10px 20px; background-color: #e3f2fd; border: 1px solid #90caf9; box-shadow: none; text-align: center; display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 10px; }
        #auth-section.logged-in #auth-header, #auth-section.logged-in #auth-form-fields, #auth-section.logged-in #auth-status { display: none !important; }
        #auth-section.logged-in #welcome-message { margin: 0; font-size: 1em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #auth-section.logged-in #btn-sign-out { width: auto; padding: 5px 10px; font-size: 0.8em; margin: 0; flex-shrink: 0; }
        .summary-header-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-bottom: 25px; }
        #manual-fill-section { margin-top: 15px; padding-top: 15px; border-top: 1px solid #ccc; }
        #manual-fill-section textarea { width: 100%; height: 100px; margin-top: 10px; resize: vertical; }
        #manual-fill-section .button-group { justify-content: space-between; }
        .fats-bar-container { margin-top: 15px; }
        .fats-group { padding-left: 15px; border-left: 3px solid #eee; margin-top: 15px; }
        .fats-sub-bars-container { display: flex; gap: 20px; margin-top: 10px; }
        .fats-sub-bars-container > div { flex-grow: 1; flex-basis: 0; }
        .progress-fat-sat.green::-webkit-progress-value { background-color: #4CAF50; }
        .progress-fat-sat.green::-moz-progress-bar { background-color: #4CAF50; }
        .progress-fat-sat.orange::-webkit-progress-value { background-color: #ff9800; }
        .progress-fat-sat.orange::-moz-progress-bar { background-color: #ff9800; }
        .progress-fat-sat.red::-webkit-progress-value { background-color: #f44336; }
        .progress-fat-sat.red::-moz-progress-bar { background-color: #f44336; }
        .food-adder-header { display: flex; justify-content: space-between; align-items: center; }
        .food-adder-header button { background: none; border: none; font-size: 1.5em; cursor: pointer; color: #555; padding: 5px 10px; }
        .food-adder-header button:hover { color: #0d47a1; }
        #btn-clear-nutrients { color: #d32f2f; }
        #btn-clear-nutrients:hover { color: #ff1744; }
        .vitamin-group { padding: 10px; margin-top: 10px; background-color: #f9f9f9; border: 1px solid #eee; border-radius: 6px; }
        #vit-content { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .diary-table-container { 
            overflow-x: auto; 
            -webkit-box-shadow: inset -8px 0px 8px -8px rgba(0,0,0,0.1);
            box-shadow: inset -8px 0px 8px -8px rgba(0,0,0,0.1);
        }
        #log-pasti th, #log-pasti td {
            min-width: 60px;
            text-align: right;
            padding: 8px 10px;
            white-space: nowrap;
        }
        #log-pasti th:nth-child(1), #log-pasti td:nth-child(1) {
            min-width: 150px;
            text-align: left;
            position: -webkit-sticky;
            position: sticky;
            left: 0;
            z-index: 2;
            border-right: 2px solid #e0e0e0;
        }
        #log-pasti th:nth-child(2), #log-pasti td:nth-child(2) {
            min-width: 50px;
            text-align: left;
        }
        #log-pasti th:last-child, #log-pasti td:last-child {
            min-width: 80px;
            text-align: center;
        }
        #log-pasti th:first-child { background-color: #f8f9fa; }
        #log-pasti td:first-child { background-color: #ffffff; }
        #log-pasti .meal-group-row td:first-child { background-color: #f0f4f8; }
        #log-pasti .sub-item-row td:first-child { background-color: #ffffff; }
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto; 
            background-color: rgba(0,0,0,0.6); 
            -webkit-animation-name: fadeIn;
            -webkit-animation-duration: 0.4s;
            animation-name: fadeIn;
            animation-duration: 0.4s;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 25px;
            border: 1px solid #888;
            width: 90%;
            max-width: 700px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            -webkit-animation-name: slideIn;
            -webkit-animation-duration: 0.4s;
            animation-name: slideIn;
            animation-duration: 0.4s;
        }
        .modal-close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            line-height: 1;
        }
        .modal-close:hover,
        .modal-close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .modal-content video {
            background-color: #000;
        }
        .vitamin-weekly-summary {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        .vitamin-weekly-summary:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        .vitamin-weekly-summary h4 {
            margin-top: 0;
            margin-bottom: 8px;
            color: #1565c0;
            border: none;
        }
        .vitamin-weekly-summary p {
            margin: 4px 0;
            font-size: 0.95em;
        }
        .vitamin-weekly-summary i {
            color: #555;
            font-size: 0.9em;
        }
        .vitamin-weekly-summary progress {
            width: 100%;
            height: 20px;
        }
        .diff-value { font-weight: bold; }
        .diff-surplus { color: #2e7d32; }
        .diff-deficit { color: #d32f2f; }
        @-webkit-keyframes slideIn { from {top: -300px; opacity: 0} to {top: 0; opacity: 1} }
        @keyframes slideIn { from {margin-top: 5%; opacity: 0} to {margin-top: 10%; opacity: 1} }
        @-webkit-keyframes fadeIn { from {opacity: 0} to {opacity: 1} }
        @keyframes fadeIn { from {opacity: 0} to {opacity: 1} }
        #nutrient-detail-modal-list li {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #nutrient-detail-modal-list li:last-child {
            border-bottom: none;
        }
        #nutrient-detail-modal-list li span {
            font-weight: 600;
        }
        .protein-score {
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 4px;
            color: white;
            font-size: 0.85em;
            text-align: center;
        }
        .protein-score.low { background-color: #d32f2f; }
        .protein-score.medium { background-color: #ff8f00; }
        .protein-score.high { background-color: #2e7d32; }

        .food-label-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        .food-label-container label {
            margin-bottom: 0;
            flex-shrink: 0;
        }
        #btn-edit-ingredients, #btn-edit-name {
            background: none;
            border: none;
            font-size: 1.1em;
            color: #607d8b;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        #btn-edit-ingredients:hover, #btn-edit-name:hover {
            color: #1976d2;
        }
        .ingredient-icon {
            cursor: pointer;
            color: #607d8b;
            margin-right: 8px;
            font-size: 1.1em;
        }
        .ingredient-icon:hover {
            color: #1976d2;
        }
        #ingredient-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        #ingredient-modal-title {
            margin: 0;
            font-size: 1.5em;
            color: #0d47a1;
        }
        #ingredient-modal-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        #ingredient-modal-actions button {
            background: none;
            border: none;
            font-size: 1.6em;
            cursor: pointer;
            padding: 5px;
            color: #555;
        }
        #ingredient-modal-actions button:hover {
            color: #0d47a1;
        }
        #btn-clear-ingredients:hover {
            color: #d32f2f;
        }
        #ingredient-modal-textarea {
            width: 100%;
            height: 200px;
            resize: vertical;
            font-family: monospace;
            font-size: 1em;
        }
        
        #nutrient-confirm-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            max-height: 40vh;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #eee;
            min-height: 50px;
        }
        .nutrient-confirm-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .nutrient-confirm-item label {
            flex-basis: 60%;
            margin-bottom: 0;
            font-size: 0.9em;
        }
        .nutrient-confirm-item input {
            flex-grow: 1;
            margin-bottom: 0;
            padding: 8px;
            font-size: 0.9em;
        }
        .nutrient-confirm-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        #custom-suggestions {
            display: none;
            position: absolute;
            background-color: #ffffff;
            border: 1px solid #ccc;
            border-radius: 0 0 6px 6px;
            width: 100%;
            max-height: 250px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            box-sizing: border-box;
        }
        .suggestion-item {
            padding: 10px 12px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
            font-size: 0.95em;
        }
        .suggestion-item:last-child {
            border-bottom: none;
        }
        .suggestion-item:hover {
            background-color: #e3f2fd;
        }
        .suggestion-delete-btn {
            color: #d32f2f;
            background: none;
            border: none;
            font-size: 1.3em;
            cursor: pointer;
            padding: 2px 8px;
            line-height: 1;
        }
        .suggestion-delete-btn:hover {
            background-color: #ffebee;
            border-radius: 50%;
        }
        #btn-clear-dettagli {
            background: none;
            border: none;
            color: #d32f2f;
            font-size: 1em;
            cursor: pointer;
            padding: 0 10px;
            opacity: 0.7;
        }
        #btn-clear-dettagli:hover {
            opacity: 1;
        }
        .diff-item { 
            padding: 12px 8px; 
            border-bottom: 1px solid #f0f0f0; 
            display: grid; 
            grid-template-columns: 150px 1fr; 
            gap: 15px; 
            align-items: center; 
            font-size: 0.9em;
        }
        .diff-item:last-child { border-bottom: none; }
        .diff-item-label { font-weight: bold; }
        .diff-item-choices { display: flex; flex-direction: column; gap: 8px; }
        .diff-item-choices label { font-weight: normal; display: flex; align-items: center; gap: 8px; margin: 0; cursor: pointer;}
        .diff-item-choices input[type="radio"] { margin: 0; }
        .diff-item-choices .current-value { color: #1976d2; }
        .diff-item-choices .new-value { color: #2e7d32; }
    </style>
</head>
<body>
    
    <div class="app-container">
        <header class="app-header">
            <h1>Tracker Nutrizionale</h1>
            <nav class="page-navigation">
                <span class="page-indicator" data-page="0">Dashboard</span>
                <span class="page-indicator" data-page="1">Aggiungi</span>
                <span class="page-indicator" data-page="2">Diario</span>
                <span class="page-indicator" data-page="3">Altro</span>
            </nav>
        </header>

        <main class="swiper-container">
            <div class="swiper-wrapper">

                <section id="page-dashboard" class="page">
                    <div class="container">
                        <div id="auth-section" class="sezione">
                            <h2 id="auth-header">Accedi / Registrati</h2>
                            <p id="welcome-message"></p>
                            <div id="auth-form-fields">
                                <div><label for="user-email">Email</label><input type="email" id="user-email" autocomplete="email"></div>
                                <div><label for="user-password">Password</label><input type="password" id="user-password" autocomplete="current-password"></div>
                                <div class="auth-buttons">
                                    <button id="btn-register">Registrati</button>
                                    <button id="btn-login">Accedi</button>
                                </div>
                            </div>
                            <button id="btn-sign-out">Esci</button>
                            <p id="auth-status"></p>
                        </div>

                        <div id="main-tracker-content">
                            <h2 id="titolo-giornata"></h2>
                            
                            <div id="riepilogo" class="sezione">
                                <div class="summary-header-row"><h2>Riepilogo di Oggi</h2></div>
                                <span id="calorie-balance-text"></span>
                                <div id="calorie-adjuster">
                                    <label for="calorie-adjustment-input">Correzione Obiettivo:</label>
                                    <button id="btn-calorie-minus" class="minus">-</button>
                                    <input type="number" id="calorie-adjustment-input" value="0">
                                    <button id="btn-calorie-plus">+</button>
                                    <span>kcal</span>
                                </div>
                                <p style="display: flex; align-items: center; gap: 10px;">
                                    <span>Proteine: <span id="totale-proteine">0</span> / <span id="obiettivo-proteine"></span> g</span>
                                    <i id="info-proteine-giornata" class="fas fa-info-circle" style="cursor: pointer; color: #1976d2; font-size: 1.2em;"></i>
                                </p>
                                <progress id="progress-proteine" class="macro-progress" value="0"></progress>
                                <p>Calorie: <span id="totale-calorie">0</span> / <span id="obiettivo-calorie"></span> kcal</p>
                                <progress id="progress-calorie" class="macro-progress" value="0"></progress>
                                <p>Workout: <span id="workout-calories-totali">0</span> kcal</p>
                                <hr>
                                
                                <h3 class="collapsible-header" id="carbs-header">Carboidrati e Zuccheri <span class="arrow">▶</span></h3>
                                <div class="collapsible-content" id="carbs-content">
                                    <p>Carboidrati: <span id="totale-carboidrati">0</span> / <span id="obiettivo-carboidrati"></span> g</p>
                                    <progress id="progress-carboidrati" class="macro-progress" value="0"></progress>
                                    <p>di cui Zuccheri: <span id="totale-zuccheri">0</span> / <span id="obiettivo-zuccheri"></span> g</p>
                                    <progress id="progress-zuccheri" class="macro-progress" value="0"></progress>
                                </div>
                                <hr>
                                
                                <h3 class="collapsible-header" id="fibre-header">Fibre <span class="arrow">▶</span></h3>
                                <div class="collapsible-content" id="fibre-content">
                                    <p>Fibre Totali: <span id="totale-fibre-totali">0</span> / <span id="obiettivo-fibre-totali"></span> g</p>
                                    <progress id="progress-fibre-totali" class="macro-progress" value="0"></progress>
                                    <div class="fats-group" style="padding-left: 15px; border-left: 3px solid #eee; margin-top: 15px;">
                                        <p>Solubili: <span id="totale-fibre-solubili">0</span> / <span id="obiettivo-fibre-solubili"></span> g</p>
                                        <progress id="progress-fibre-solubili" value="0"></progress>
                                        <p>Insolubili: <span id="totale-fibre-insolubili">0</span> / <span id="obiettivo-fibre-insolubili"></span> g</p>
                                        <progress id="progress-fibre-insolubili" value="0"></progress>
                                    </div>
                                </div>
                                <hr>
                                
                                <h3 class="collapsible-header" id="fats-header">
                                    <span style="display: flex; align-items: center; gap: 8px;">
                                        Grassi <i id="info-fats-settimanali" class="fas fa-info-circle" style="cursor: pointer; color: #1976d2;"></i>
                                    </span>
                                    <span class="arrow">▶</span>
                                </h3>
                                <div class="collapsible-content" id="fats-content">
                                    <p>Grassi Totali: <span id="totale-fats-total">0</span> / <span id="obiettivo-fats-total"></span> g</p>
                                    <progress id="progress-fats-total" class="macro-progress" value="0"></progress>
                                    <div class="fats-group">
                                         <div class="fats-sub-bars-container">
                                            <div>
                                                <p>Saturi: <span id="totale-fat-sat">0</span> / <span id="obiettivo-fat-sat"></span> g</p>
                                                <progress id="progress-fat-sat" class="progress-fat-sat" value="0"></progress>
                                            </div>
                                            <div>
                                                <p>Trans: <span id="totale-fat-trans">0</span> / <span id="obiettivo-fat-trans"></span> g</p>
                                                <progress id="progress-fat-trans" value="0"></progress>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="fats-group">
                                        <h4>Grassi Insaturi: <span id="totale-fat-unsat">0</span> / <span id="obiettivo-fat-unsat"></span> g</h4>
                                        <progress id="progress-fat-unsat" value="0"></progress>
                                        <div style="padding-left: 15px;">
                                            <p>Monoinsaturi: <span id="totale-fat-mono">0</span> / <span id="obiettivo-fat-mono"></span> g</p>
                                            <progress id="progress-fat-mono" value="0"></progress>
                                            <p>Polinsaturi: <span id="totale-fat-poly">0</span> / <span id="obiettivo-fat-poly"></span> g</p>
                                            <progress id="progress-fat-poly" value="0"></progress>
                                            <div class="fats-group" style="border: none; padding-left: 10px; margin-top: 10px;">
                                                 <div class="fats-sub-bars-container">
                                                    <div>
                                                        <p>Omega 3: <span id="totale-omega3">0</span> / <span id="obiettivo-omega3"></span> g</p>
                                                        <progress id="progress-omega3" value="0"></progress>
                                                    </div>
                                                    <div>
                                                        <p>Omega 6: <span id="totale-omega6">0</span> / <span id="obiettivo-omega6"></span> g</p>
                                                        <progress id="progress-omega6" value="0"></progress>
                                                    </div>
                                                 </div>
                                                 <p style="text-align: center; font-weight: bold; margin-top: 10px; font-size: 1.1em;">
                                                    Rapporto O6:O3: <span id="omega-ratio-value"></span>
                                                 </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <hr>
                                
                                <h3 class="collapsible-header" id="micro-header">Micronutrienti <span class="arrow">▶</span></h3>
                                <div class="collapsible-content" id="micro-content">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                                        <div>
                                            <p>Magnesio: <span id="totale-mg">0</span> / 420 mg</p><progress id="progress-mg" value="0"></progress>
                                            <p>Potassio: <span id="totale-k">0</span> / 3400 mg</p><progress id="progress-k" value="0"></progress>
                                        </div>
                                        <div>
                                            <p>Ferro: <span id="totale-fe">0</span> / 18 mg</p><progress id="progress-fe" value="0"></progress>
                                            <p>Zinco: <span id="totale-zn">0</span> / 11 mg</p><progress id="progress-zn" value="0"></progress>
                                        </div>
                                        <div>
                                            <p>Calcio: <span id="totale-ca">0</span> / 1000 mg</p><progress id="progress-ca" value="0"></progress>
                                            <p>Rame: <span id="totale-cu">0</span> / 0.9 mg</p><progress id="progress-cu" value="0" max="0.9"></progress>
                                        </div>
                                    </div>
                                     <div style="margin-top: 15px;">
                                        <p>Fosforo: <span id="totale-p">0</span> / 700 mg</p><progress id="progress-p" value="0" max="700"></progress>
                                    </div>
                                </div>
                                <hr>
                
                                <h3 class="collapsible-header" id="vit-header">Vitamine <span class="arrow">▶</span></h3>
                                <div class="collapsible-content" id="vit-content">
                                    <div class="vitamin-group">
                                        <h4 style="display: flex; align-items: center; gap: 8px;">
                                            Accumulabili (Liposolubili / Fegato) 
                                            <i id="info-vit-settimanali" class="fas fa-info-circle" style="cursor: pointer; color: #1976d2;"></i>
                                        </h4>
                                        <p>Vitamina A: <span id="totale-vit-a">0</span> / 900 µg</p><progress id="progress-vit-a" value="0" max="900"></progress>
                                        <p>Vitamina D: <span id="totale-vit-d">0</span> / 15 µg</p><progress id="progress-vit-d" value="0" max="15"></progress>
                                        <p>Vitamina E: <span id="totale-vit-e">0</span> / 15 mg</p><progress id="progress-vit-e" value="0" max="15"></progress>
                                        <p>Vitamina K: <span id="totale-vit-k">0</span> / 120 µg</p><progress id="progress-vit-k" value="0" max="120"></progress>
                                        <p>Vitamina B12: <span id="totale-vit-b12">0</span> / 2.4 µg</p><progress id="progress-vit-b12" value="0" max="2.4"></progress>
                                    </div>
                                     <div class="vitamin-group">
                                        <h4>Giornaliere (Idrosolubili)</h4>
                                        <p>Vitamina C: <span id="totale-vitc">0</span> / 90 mg</p><progress id="progress-vitc" value="0" max="90"></progress>
                                        <p>Vitamina B2: <span id="totale-b2">0</span> / 1.3 mg</p><progress id="progress-b2" value="0" max="1.3"></progress>
                                        <p>Vitamina B6: <span id="totale-b6">0</span> / 1.3 mg</p><progress id="progress-b6" value="0" max="1.3"></progress>
                                        <p>Folati (B9): <span id="totale-b9">0</span> / 400 µg</p><progress id="progress-b9" value="0" max="400"></progress>
                                    </div>
                                </div>
                                <div style="margin-top: 20px;">
                                    <label for="daily-notes">Note del Giorno</label>
                                    <textarea id="daily-notes" rows="3" placeholder="Aggiungi note per la giornata..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="page-input" class="page">
                    <div class="container">
                        <div id="form-allenamento" class="sezione">
                             <h2 class="collapsible-header" id="workout-header">Registra Allenamento <span class="arrow">▶</span></h2>
                            <div class="collapsible-content" id="workout-content">
                                <label for="workout-desc">Descrizione Allenamento</label>
                                <input type="text" id="workout-desc" placeholder="es. Corsa 30 min, Pesistica">
                                <label for="workout-calories">Calorie Bruciate (kcal)</label>
                                <input type="number" id="workout-calories" min="0">
                                <button id="btn-add-workout">Aggiungi Allenamento</button>
                            </div>
                        </div>

                        <div id="food-adder" class="sezione">
                             <div class="food-adder-header">
                                <h2>Aggiungi Alimento</h2>
                                <div id="photo-ocr-controls" style="display: flex; align-items: center; gap: 5px;">
                                     <span id="photo-ocr-status" style="display:none; color: #555; font-style: italic; font-size: 0.9em;"></span>
                                     <button id="btn-photo-nutrients" title="Acquisisci Nutrienti da Foto"><i class="fas fa-camera"></i></button>
                                     <button id="btn-scan-barcode" title="Scansiona Codice a Barre"><i class="fas fa-barcode"></i></button>
                                     <button id="btn-clear-nutrients" title="Cancella campi nutrienti"><i class="fas fa-trash-alt"></i></button>
                                </div>
                            </div>
                            <div class="builder-grid">
                                <div style="position: relative;">
                                    <div class="food-label-container">
                                        <label for="builder-desc">Alimento</label>
                                        <button id="btn-edit-name" title="Modifica solo il nome senza ricaricare i dati" style="display: none;">✏️</button>
                                        <button id="btn-edit-ingredients" title="Modifica Lista Ingredienti">📜</button>
                                    </div>
                                    <input type="text" id="builder-desc" autocomplete="off">
                                    <div id="custom-suggestions"></div>
                                </div>
                                <div><label>Quantità (g)</label><input type="text" id="builder-qta"></div>
                                <div><label>Proteine/100g</label><input type="number" id="builder-prot" step="0.1"></div>
                                <div><label>Kcal/100g</label><input type="number" id="builder-kcal" min="0"></div>
                                <div><label>Carboidrati/100g</label><input type="number" id="builder-carb" step="0.1"></div>
                                <div><label>Zuccheri/100g</label><input type="number" id="builder-zuccheri" step="0.1"></div>
                                <div><label>Grassi Totali/100g</label><input type="number" id="builder-fat-total" step="0.1"></div>
                                <div><label>Gr. Saturi/100g</label><input type="number" id="builder-fat-sat" min="0" step="0.1"></div>
                                <div><label>Fibre Totali/100g</label><input type="number" id="builder-fibre-totali" step="0.1"></div>
                            </div>
                            <h2 class="collapsible-header" id="nutrients-header">
                                <span>Dettagli Nutrizionali</span>
                                <div style="display: flex; align-items: center;">
                                    <button id="btn-clear-dettagli" title="Pulisci Dettagli Nutrizionali"><i class="fas fa-eraser"></i></button>
                                    <span class="arrow">▶</span>
                                </div>
                            </h2>
                            <div class="collapsible-content" id="nutrients-content">
                                <div class="builder-grid">
                                    <div><label>Fibre Solubili/100g</label><input type="number" id="builder-fibre-solubili" step="0.1"></div>
                                    <div><label>Fibre Insolubili/100g</label><input type="number" id="builder-fibre-insolubili" step="0.1"></div>
                                    <div><label>Gr. Trans/100g</label><input type="number" id="builder-fat-trans" min="0" step="0.1"></div>
                                    <div><label>Gr. Monoinsaturi/100g</label><input type="number" id="builder-fat-mono" min="0" step="0.1"></div>
                                    <div><label>Gr. Polinsaturi/100g</label><input type="number" id="builder-fat-poly" min="0" step="0.1"></div>
                                    <div><label>Omega 3/100g</label><input type="number" id="builder-omega3" min="0" step="0.1"></div>
                                    <div><label>Omega 6/100g</label><input type="number" id="builder-omega6" min="0" step="0.1"></div>
                                    <div><label>Vit. A (μg)/100g</label><input type="number" id="builder-vit-a" min="0"></div>
                                    <div><label>Vit. B2 (mg)/100g</label><input type="number" id="builder-b2" min="0" step="0.01"></div>
                                    <div><label>Vit. B6 (mg)/100g</label><input type="number" id="builder-b6" min="0" step="0.01"></div>
                                    <div><label>Vit. B12 (μg)/100g</label><input type="number" id="builder-vit-b12" min="0" step="0.01"></div>
                                    <div><label>Vit. D (μg)/100g</label><input type="number" id="builder-vit-d" min="0" step="0.01"></div>
                                    <div><label>Vit. E (mg)/100g</label><input type="number" id="builder-vit-e" min="0" step="0.1"></div>
                                    <div><label>Vit. K (μg)/100g</label><input type="number" id="builder-vit-k" min="0"></div>
                                    <div><label>Folati B9 (μg)/100g</label><input type="number" id="builder-b9" min="0"></div>
                                    <div><label>Magnesio (mg)/100g</label><input type="number" id="builder-mg" min="0"></div>
                                    <div><label>Potassio (mg)/100g</label><input type="number" id="builder-k" min="0"></div>
                                    <div><label>Vitamina C (mg)/100g</label><input type="number" id="builder-vitc" min="0"></div>
                                    <div><label>Calcio (mg)/100g</label><input type="number" id="builder-ca" min="0"></div>
                                    <div><label>Ferro (mg)/100g</label><input type="number" id="builder-fe" min="0" step="0.1"></div>
                                    <div><label>Zinco (mg)/100g</label><input type="number" id="builder-zn" min="0" step="0.1"></div>
                                    <div><label>Rame (mg)/100g</label><input type="number" id="builder-cu" min="0" step="0.01"></div>
                                    <div><label>Fosforo (mg)/100g</label><input type="number" id="builder-p" min="0"></div>
                                    <div><label>Leucina (mg)/100g</label><input type="number" id="builder-leu" min="0"></div>
                                    <div><label>Isoleucina (mg)/100g</label><input type="number" id="builder-iso" min="0"></div>
                                    <div><label>Valina (mg)/100g</label><input type="number" id="builder-val" min="0"></div>
                                    <div><label>Lisina (mg)/100g</label><input type="number" id="builder-lys" min="0"></div>
                                    <div><label>Metionina (mg)/100g</label><input type="number" id="builder-met" min="0"></div>
                                    <div><label>Fenilalanina (mg)/100g</label><input type="number" id="builder-phe" min="0"></div>
                                    <div><label>Treonina (mg)/100g</label><input type="number" id="builder-thr" min="0"></div>
                                    <div><label>Triptofano (mg)/100g</label><input type="number" id="builder-trp" min="0"></div>
                                    <div><label>Istidina (mg)/100g</label><input type="number" id="builder-his" min="0"></div>
                                </div>
                                <div id="manual-fill-section">
                                    <div class="button-group">
                                        <button id="btn-copy-prompt">Copia Richiesta AI</button>
                                        <button id="btn-confirm-json" style="background-color: #2e7d32;">Conferma Dati da JSON</button>
                                    </div>
                                    <textarea id="manual-json-input" placeholder="Incolla qui l'oggetto JSON con i valori nutrizionali, come da richiesta."></textarea>
                                </div>
                            </div>
                            <div class="button-group">
                                <button id="btn-costruisci-pasto">Aggiungi a Pasto</button>
                                <button id="btn-aggiungi-singolo">Aggiungi al Diario</button>
                                <button id="btn-compila-ai" style="background-color: #0d47a1;">Compila AI</button>
                            </div>
                        </div>

                        <div id="meal-builder-sezione" class="sezione" data-visible="false">
                            <h2>Costruttore Pasto</h2>
                            <div id="meal-builder-summary">
                                <p>Pasto Selezionato: <span id="current-meal-type-display"></span></p>
                                <div class="progress-container">
                                    <div class="progress-item">
                                        <p style="display: flex; align-items: center; gap: 10px;">
                                            <span>Proteine: <span id="meal-prot-current">0</span> / <span id="meal-prot-target"></span> g (<span id="meal-prot-remaining"></span>)</span>
                                            <i id="info-proteine-pasto" class="fas fa-info-circle" style="cursor: pointer; color: #1976d2; font-size: 1.2em;"></i>
                                        </p>
                                        <progress id="meal-progress-prot" value="0"></progress>
                                    </div>
                                    <div class="progress-item">
                                        <p>Calorie: <span id="meal-cal-current">0</span> / <span id="meal-cal-target"></span> kcal (<span id="meal-cal-remaining"></span>)</p>
                                        <progress id="meal-progress-cal" value="0"></progress>
                                    </div>
                                </div>
                            </div>
                            <select id="meal-type-selector">
                                <option value="merenda1">Merenda AM</option>
                                <option value="pranzo">Pranzo</option>
                                <option value="merenda2">Merenda PM</option>
                                <option value="cena">Cena</option>
                            </select>
                            <table id="log-pasto-builder">
                                <thead><tr><th>Sel.</th><th>Descrizione</th><th>(g)</th><th>Prot</th><th>Kcal</th><th>Azione</th></tr></thead>
                                <tbody id="log-pasto-builder-body"></tbody>
                            </table>
                            <button id="btn-salva-pasto">Salva Pasto nel Diario</button>
                        </div>
                    </div>
                </section>

                <section id="page-diary" class="page">
                    <div class="container">
                        <div class="sezione">
                            <h2>Diario Giornaliero</h2>
                            <div class="diary-table-container">
                                <table id="log-pasti">
                                     <thead>
                                        <tr>
                                            <th>Descrizione</th>
                                            <th>(g)</th>
                                            <th>Prot</th>
                                            <th>Qualità</th>
                                            <th>Kcal</th>
                                            <th>Fibre Tot</th>
                                            <th>Fibre Sol</th>
                                            <th>Fibre Ins</th>
                                            <th>Leu</th>
                                            <th>Iso</th>
                                            <th>Val</th>
                                            <th>Lys</th>
                                            <th>Met</th>
                                            <th>Phe</th>
                                            <th>Thr</th>
                                            <th>Trp</th>
                                            <th>His</th>
                                            <th>Gr. Sat</th>
                                            <th>Gr. Trans</th>
                                            <th>Gr. Mono</th>
                                            <th>Gr. Poly</th>
                                            <th>Omega 3</th>
                                            <th>Omega 6</th>
                                            <th>Mg</th>
                                            <th>K</th>
                                            <th>Vit.C</th>
                                            <th>Ca</th>
                                            <th>Fe</th>
                                            <th>Zn</th>
                                            <th>Cu</th>
                                            <th>Vit. A</th>
                                            <th>Vit. B12</th>
                                            <th>Vit. D</th>
                                            <th>Vit. E</th>
                                            <th>Vit. K</th>
                                            <th>B9</th>
                                            <th>B2</th>
                                            <th>B6</th>
                                            <th>Azione</th>
                                        </tr>
                                    </thead>
                                    <tbody id="log-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="page-history" class="page">
                    <div class="container">
                        <div class="sezione">
                             <h2>Sincronizzazione Cloud</h2>
                            <div class="cloud-sync-section">
                                <button id="btn-download-manual">⬇️ Scarica Dati dal Cloud</button>
                                <span id="cloud-sync-status" class="cloud-sync-status disconnected">Connessione Cloud: Disconnesso</span>
                            </div>
                            <p style="font-size: 0.85em; color: #777; margin-top: 10px;">
                                Una volta autenticato, puoi sincronizzare i dati. Lo scaricamento manuale sovrascrive i dati locali.
                            </p>
                        </div>
                        <div id="caricamento-manuale" class="sezione">
                                <h3 style="margin:0 0 10px 0; font-size:1em;">Visualizza un Altro Giorno</h3>
                                <div>
                                    <input type="date" id="data-caricamento">
                                    <button id="btn-vai-a-oggi">Oggi</button>
                                </div>
                        </div>
                        <div class="nav-links" style="margin-top: 20px;">
                            <a href="storico.html">📊 Storico & Grafici</a>
                            <a href="stima_grassi.html">🫙 Stima Grassi</a>
                        </div>
                    </div>
                </section>

            </div>
        </main>
    </div>

    <div id="weekly-vitamin-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" data-modal="weekly-vitamin-modal">&times;</span>
            <h2>Riepilogo Settimanale Vitamine Accumulabili</h2>
            <p style="font-size: 0.9em; color: #555;">Dati calcolati sugli ultimi 7 giorni, incluso oggi.</p>
            <div class="vitamin-weekly-summary">
                <h4>Vitamina A</h4>
                <p>Totale: <span id="weekly-vit-a-total">0</span> / <span id="weekly-vit-a-goal">6300</span> µg</p>
                <progress id="weekly-progress-vit-a" value="0" max="6300"></progress>
                <p><i>Media giornaliera: <span id="weekly-vit-a-avg">0.0</span> µg (Obiettivo: 900 µg | <span id="weekly-vit-a-diff" class="diff-value"></span>)</i></p>
            </div>
            <div class="vitamin-weekly-summary">
                <h4>Vitamina D</h4>
                <p>Totale: <span id="weekly-vit-d-total">0</span> / <span id="weekly-vit-d-goal">105</span> µg</p>
                <progress id="weekly-progress-vit-d" value="0" max="105"></progress>
                <p><i>Media giornaliera: <span id="weekly-vit-d-avg">0.0</span> µg (Obiettivo: 15 µg | <span id="weekly-vit-d-diff" class="diff-value"></span>)</i></p>
            </div>
            <div class="vitamin-weekly-summary">
                <h4>Vitamina E</h4>
                <p>Totale: <span id="weekly-vit-e-total">0</span> / <span id="weekly-vit-e-goal">105</span> mg</p>
                <progress id="weekly-progress-vit-e" value="0" max="105"></progress>
                <p><i>Media giornaliera: <span id="weekly-vit-e-avg">0.0</span> mg (Obiettivo: 15 mg | <span id="weekly-vit-e-diff" class="diff-value"></span>)</i></p>
            </div>
            <div class="vitamin-weekly-summary">
                <h4>Vitamina K</h4>
                <p>Totale: <span id="weekly-vit-k-total">0</span> / <span id="weekly-vit-k-goal">840</span> µg</p>
                <progress id="weekly-progress-vit-k" value="0" max="840"></progress>
                <p><i>Media giornaliera: <span id="weekly-vit-k-avg">0.0</span> µg (Obiettivo: 120 µg | <span id="weekly-vit-k-diff" class="diff-value"></span>)</i></p>
            </div>
            <div class="vitamin-weekly-summary">
                <h4>Vitamina B12</h4>
                <p>Totale: <span id="weekly-vit-b12-total">0</span> / <span id="weekly-vit-b12-goal">16.8</span> µg</p>
                <progress id="weekly-progress-vit-b12" value="0" max="16.8"></progress>
                <p><i>Media giornaliera: <span id="weekly-vit-b12-avg">0.0</span> µg (Obiettivo: 2.4 µg | <span id="weekly-vit-b12-diff" class="diff-value"></span>)</i></p>
            </div>
        </div>
    </div>
    <div id="weekly-fats-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" data-modal="weekly-fats-modal">&times;</span>
            <h2>Riepilogo Settimanale Grassi</h2>
            <p style="font-size: 0.9em; color: #555;">Dati calcolati sugli ultimi 7 giorni, incluso oggi.</p>
            <div class="vitamin-weekly-summary">
                <h4>Grassi Totali</h4>
                <p>Totale: <span id="weekly-fat-total-total">0</span> / <span id="weekly-fat-total-goal"></span> g</p>
                <progress id="weekly-progress-fat-total" value="0"></progress>
                <p><i>Media giornaliera: <span id="weekly-fat-total-avg">0.0</span> g (Obiettivo: <span id="daily-fat-total-goal"></span> g | <span id="weekly-fat-total-diff" class="diff-value"></span>)</i></p>
            </div>
            <div class="vitamin-weekly-summary">
                <h4>Grassi Saturi</h4>
                <p>Totale: <span id="weekly-fat-sat-total">0</span> / <span id="weekly-fat-sat-goal"></span> g</p>
                <progress id="weekly-progress-fat-sat" value="0"></progress>
                <p><i>Media giornaliera: <span id="weekly-fat-sat-avg">0.0</span> g (Obiettivo: <span id="daily-fat-sat-goal"></span> g | <span id="weekly-fat-sat-diff" class="diff-value"></span>)</i></p>
            </div>
            <div class="vitamin-weekly-summary">
                <h4>Grassi Trans</h4>
                <p>Totale: <span id="weekly-fat-trans-total">0</span> / <span id="weekly-fat-trans-goal"></span> g</p>
                <progress id="weekly-progress-fat-trans" value="0"></progress>
                <p><i>Media giornaliera: <span id="weekly-fat-trans-avg">0.0</span> g (Obiettivo: <span id="daily-fat-trans-goal"></span> g | <span id="weekly-fat-trans-diff" class="diff-value"></span>)</i></p>
            </div>
            <div class="vitamin-weekly-summary">
                <h4>Grassi Monoinsaturi</h4>
                <p>Totale: <span id="weekly-fat-mono-total">0</span> / <span id="weekly-fat-mono-goal"></span> g</p>
                <progress id="weekly-progress-fat-mono" value="0"></progress>
                <p><i>Media giornaliera: <span id="weekly-fat-mono-avg">0.0</span> g (Obiettivo: <span id="daily-fat-mono-goal"></span> g | <span id="weekly-fat-mono-diff" class="diff-value"></span>)</i></p>
            </div>
            <div class="vitamin-weekly-summary">
                <h4>Grassi Polinsaturi</h4>
                <p>Totale: <span id="weekly-fat-poly-total">0</span> / <span id="weekly-fat-poly-goal"></span> g</p>
                <progress id="weekly-progress-fat-poly" value="0"></progress>
                <p><i>Media giornaliera: <span id="weekly-fat-poly-avg">0.0</span> g (Obiettivo: <span id="daily-fat-poly-goal"></span> g | <span id="weekly-fat-poly-diff" class="diff-value"></span>)</i></p>
            </div>
             <div class="vitamin-weekly-summary">
                <h4>Omega 3</h4>
                <p>Totale: <span id="weekly-fat-omega3-total">0</span> / <span id="weekly-fat-omega3-goal"></span> g</p>
                <progress id="weekly-progress-fat-omega3" value="0"></progress>
                <p><i>Media giornaliera: <span id="weekly-fat-omega3-avg">0.0</span> g (Obiettivo: <span id="daily-fat-omega3-goal"></span> g | <span id="weekly-fat-omega3-diff" class="diff-value"></span>)</i></p>
            </div>
             <div class="vitamin-weekly-summary">
                <h4>Omega 6</h4>
                <p>Totale: <span id="weekly-fat-omega6-total">0</span> / <span id="weekly-fat-omega6-goal"></span> g</p>
                <progress id="weekly-progress-fat-omega6" value="0"></progress>
                <p><i>Media giornaliera: <span id="weekly-fat-omega6-avg">0.0</span> g (Obiettivo: <span id="daily-fat-omega6-goal"></span> g | <span id="weekly-fat-omega6-diff" class="diff-value"></span>)</i></p>
            </div>
            <p style="text-align: center; font-weight: bold; margin-top: 15px; font-size: 1.2em; border-top: 1px solid #eee; padding-top: 15px;">
                Rapporto O6:O3 Settimanale: <span id="weekly-omega-ratio-value">N/D</span>
            </p>
        </div>
    </div>
    <div id="nutrient-detail-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" data-modal="nutrient-detail-modal">&times;</span>
            <h2 id="nutrient-detail-modal-title"></h2>
            <ul id="nutrient-detail-modal-list"></ul>
        </div>
    </div>
    <div id="amino-acid-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" data-modal="amino-acid-modal">&times;</span>
            <h2 id="modal-amino-title">Dettaglio Amminoacidi</h2>
            <div id="modal-amino-summary" style="text-align: center; margin-bottom: 20px;"></div>
            <div id="modal-amino-content" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <p>Leucina: <span id="modal-amino-leu-total">0</span> / <span id="modal-amino-leu-goal"></span> mg</p>
                    <progress id="modal-amino-leu-progress" value="0" style="width:100%"></progress>
                    <p>Isoleucina: <span id="modal-amino-iso-total">0</span> / <span id="modal-amino-iso-goal"></span> mg</p>
                    <progress id="modal-amino-iso-progress" value="0" style="width:100%"></progress>
                    <p>Valina: <span id="modal-amino-val-total">0</span> / <span id="modal-amino-val-goal"></span> mg</p>
                    <progress id="modal-amino-val-progress" value="0" style="width:100%"></progress>
                    <p>Lisina: <span id="modal-amino-lys-total">0</span> / <span id="modal-amino-lys-goal"></span> mg</p>
                    <progress id="modal-amino-lys-progress" value="0" style="width:100%"></progress>
                </div>
                <div>
                    <p>Metionina: <span id="modal-amino-met-total">0</span> / <span id="modal-amino-met-goal"></span> mg</p>
                    <progress id="modal-amino-met-progress" value="0" style="width:100%"></progress>
                    <p>Fenilalanina: <span id="modal-amino-phe-total">0</span> / <span id="modal-amino-phe-goal"></span> mg</p>
                    <progress id="modal-amino-phe-progress" value="0" style="width:100%"></progress>
                    <p>Treonina: <span id="modal-amino-thr-total">0</span> / <span id="modal-amino-thr-goal"></span> mg</p>
                    <progress id="modal-amino-thr-progress" value="0" style="width:100%"></progress>
                    <p>Triptofano: <span id="modal-amino-trp-total">0</span> / <span id="modal-amino-trp-goal"></span> mg</p>
                    <progress id="modal-amino-trp-progress" value="0" style="width:100%"></progress>
                </div>
            </div>
            <div style="margin-top: 15px;">
                 <p>Istidina: <span id="modal-amino-his-total">0</span> / <span id="modal-amino-his-goal"></span> mg</p>
                 <progress id="modal-amino-his-progress" value="0" style="width:100%"></progress>
            </div>
        </div>
    </div>
    <div id="ingredient-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" data-modal="ingredient-modal">&times;</span>
            <div id="ingredient-modal-header">
                <h2 id="ingredient-modal-title"></h2>
                <div id="ingredient-modal-actions">
                    <button id="btn-clear-ingredients" title="Cancella tutto"><i class="fas fa-eraser"></i></button>
                    <button id="btn-photo-ingredients" title="Acquisisci da foto"><i class="fas fa-camera"></i></button>
                    <button id="btn-generate-ingredients-ai" title="Genera o Pulisci con AI">🪄</button>
                    <button id="btn-copy-ingredients-prompt" title="Copia prompt per AI">📋</button>
                </div>
            </div>
            <p id="ocr-status-ingredients" style="text-align: center; color: #888; display: none;"></p>
            <textarea id="ingredient-modal-textarea" placeholder="Inserisci o fotografa la lista ingredienti qui..."></textarea>
            <button id="btn-save-ingredients" style="width: 100%; margin-top: 15px; background-color: #2e7d32;">Salva Ingredienti</button>
        </div>
    </div>
    <div id="nutrient-confirm-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" data-modal="nutrient-confirm-modal">&times;</span>
            <h2>Conferma Dati Nutrizionali</h2>
            <p>Controlla e correggi i valori estratti prima di confermare.</p>
            <div id="nutrient-confirm-list">
                 <p id="ocr-status-nutrients" style="text-align: center; color: #888; display: block;">In attesa di dati...</p>
            </div>
            <div class="nutrient-confirm-buttons">
                <button id="btn-cancel-nutrients" style="background-color: #607d8b;">Annulla</button>
                <button id="btn-confirm-nutrients" style="background-color: #2e7d32;">Conferma e Compila</button>
            </div>
        </div>
    </div>
    <div id="barcode-scanner-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" data-modal="barcode-scanner-modal">&times;</span>
            <h2>Scansiona Codice a Barre</h2>
            <p style="text-align: center;">Inquadra il codice a barre del prodotto.</p>
            <div id="scanner-container" style="position: relative; width: 100%; padding-top: 75%;">
                <video id="barcode-scanner-video" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 1px solid #ccc; border-radius: 8px;"></video>
                <div id="scanner-overlay" style="position: absolute; top: 50%; left: 50%; width: 80%; height: 2px; background-color: red; transform: translate(-50%, -50%); box-shadow: 0 0 10px red;"></div>
            </div>
            <p id="barcode-scanner-status" style="text-align: center; margin-top: 15px; font-weight: bold; min-height: 20px;"></p>
        </div>
    </div>
    <div id="diff-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" data-modal="diff-modal">&times;</span>
            <h2 id="diff-modal-title">Confronta Valori Nutrizionali</h2>
            <p>Sono state trovate differenze. Scegli quali valori mantenere.</p>
            <div id="diff-modal-list" style="max-height: 50vh; overflow-y: auto; padding: 10px; border: 1px solid #eee; border-radius: 8px; margin-top: 15px;"></div>
            <div class="nutrient-confirm-buttons" style="margin-top: 20px;">
                <button id="btn-cancel-diff" style="background-color: #607d8b;">Annulla</button>
                <button id="btn-apply-diff" style="background-color: #2e7d32;">Applica Modifiche</button>
            </div>
        </div>
    </div>
    <input type="file" id="ingredient-photo-input" accept="image/*" style="display: none;">
    <input type="file" id="nutrient-photo-input" accept="image/*" style="display: none;">

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js" type="module"></script> 
    
    <script type="module">
        // ########## IMPORTS E CONFIGURAZIONE INIZIALE ##########
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";

        const firebaseConfig = {
          apiKey: "AIzaSyA5pSzpfq1aGZ1wjNV5-eXnIqWL6brl424",
          authDomain: "mio-tracker.firebaseapp.com",
          databaseURL: "https://mio-tracker-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "mio-tracker",
          storageBucket: "mio-tracker.firebasestorage.app",
          messagingSenderId: "382993217593",
          appId: "1:382993217593:web:f0780aa061c23f9503f5e8"
        };

        // ########## LOGICA DI NAVIGAZIONE E SWIPE ##########
        const swiperWrapper = document.querySelector('.swiper-wrapper');
        const swiperContainer = document.querySelector('.swiper-container');
        const pageIndicators = document.querySelectorAll('.page-indicator');
        const numPages = pageIndicators.length;
        let currentPageIndex = 0;
        let touchStartX = 0;
        let touchEndX = 0;

        function goToPage(pageIndex) {
            if (pageIndex < 0) pageIndex = 0;
            if (pageIndex >= numPages) pageIndex = numPages - 1;
            currentPageIndex = pageIndex;
            swiperWrapper.style.transform = `translateX(-${currentPageIndex * (100 / numPages)}%)`;
            updateIndicators();
        }
        function updateIndicators() {
            pageIndicators.forEach((indicator, index) => {
                indicator.classList.remove('active', 'adjacent');
                if (index === currentPageIndex) {
                    indicator.classList.add('active');
                } else if (Math.abs(index - currentPageIndex) === 1) {
                    indicator.classList.add('adjacent');
                }
            });
        }
        pageIndicators.forEach(indicator => indicator.addEventListener('click', () => goToPage(parseInt(indicator.dataset.page))));
        swiperContainer.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; }, { passive: true });
        swiperContainer.addEventListener('touchend', e => {
            touchEndX = e.changedTouches[0].screenX;
            const swipeThreshold = 50; 
            if (touchEndX < touchStartX - swipeThreshold) goToPage(currentPageIndex + 1);
            else if (touchEndX > touchStartX + swipeThreshold) goToPage(currentPageIndex - 1);
        });

        // ########## INIZIO LOGICA TRACKER NUTRIZIONALE ##########
        
        // --- VARIABILI GLOBALI E STATO DELL'APPLICAZIONE ---
        let giornoVisualizzato = getTodayString('ymd');
        let datiGiornalieri = {};
        let foodDatabase = {};
        let pastoInCostruzione = [];
        let db, auth, firebaseApp, currentUserUID = null;
        let videoStream = null;
        let isScanning = false;

        // --- COSTANTI E CONFIGURAZIONI ---
        const PIANO_SETTIMANALE = {
            0: { tipo: '💧 Riposo (Deficit)', cal_base: 2300, prot: 140, carb: 300, zuccheri: 25 },
            1: { tipo: '🔥 Forza (Surplus)', cal_base: 2300, prot: 140, carb: 300, zuccheri: 25 },
            2: { tipo: '💪 Forza (Surplus)', cal_base: 2300, prot: 140, carb: 300, zuccheri: 25 },
            3: { tipo: '🏃 Cardio (Deficit)', cal_base: 2300, prot: 140, carb: 300, zuccheri: 25 },
            4: { tipo: '🏋️ Forza (Surplus)', cal_base: 2300, prot: 140, carb: 300, zuccheri: 25 },
            5: { tipo: '🏃 Cardio (Surplus)', cal_base: 2300, prot: 140, carb: 300, zuccheri: 25 },
            6: { tipo: '🥗 Mantenimento (Deficit)', cal_base: 2300, prot: 140, carb: 300, zuccheri: 25 }
        };
        const DEFICIT_PREIMPOSTATO_SETTIMANALE = { 0: -250, 1: +300, 2: +300, 3: -250, 4: +300, 5: +300, 6: -250 };
        const OBIETTIVI_MICRO = { mg: 420, k: 3400, vitc: 90, ca: 1000, fe: 18, zn: 11, cu: 0.9, p: 700 };
        const OBIETTIVI_FAT = { fatTotal: 85, fatSat: 20, fatTrans: 2, fatUnsat: 65, fatMono: 45, fatPoly: 20, omega3: 2, omega6: 10 };
        const OBIETTIVI_FIBRE = { fibreTotali: 30, fibreSolubili: 10, fibreInsolubili: 20 };
        const OBIETTIVI_VIT = { vitA: 900, vitB12: 2.4, vitD: 15, vitE: 15, vitK: 120, b9: 400, b2: 1.3, b6: 1.3 };
        const OBIETTIVI_AMINO = { leu: 2900, iso: 1500, val: 1900, lys: 2200, met: 1100, phe: 1800, thr: 1100, trp: 300,  his: 750 };
        const PROFILO_AMINOACIDICO_RIFERIMENTO = { leu: 59, iso: 30, val: 39, lys: 45, met: 22, phe: 38, thr: 23, trp: 6.0, his: 15 };
        const OBIETTIVI_MACRO_PASTO_BASE_FORZA = {
            merenda1: { prot: 30, cal_perc: 0.20 },
            pranzo: { prot: 40, cal_perc: 0.35 },
            merenda2: { prot: 30, cal_perc: 0.15 },
            cena: { prot: 40, cal_perc: 0.30 }
        };
        const totalProtForza = Object.values(OBIETTIVI_MACRO_PASTO_BASE_FORZA).reduce((sum, p) => sum + p.prot, 0);
        for (const mealType in OBIETTIVI_MACRO_PASTO_BASE_FORZA) { OBIETTIVI_MACRO_PASTO_BASE_FORZA[mealType].prot_perc = OBIETTIVI_MACRO_PASTO_BASE_FORZA[mealType].prot / totalProtForza; }
        const MEAL_TYPE_SEQUENCE = ['merenda1', 'pranzo', 'merenda2', 'cena'];
        const LOCAL_STORAGE_SYNC_KEYS = ['trackerFoodDatabase', 'trackerPesate', 'trackerMealType', 'trackerPastoInCostruzione'];
        const LOCAL_LAST_UPDATE_KEY = 'lastLocalUpdateTimestamp';
        const CLOUD_LAST_UPDATE_PATH = 'lastCloudUpdateTimestamp';
        const API_KEY_AI = "AIzaSyCZUoiawXYzrqDLh1m0O0Wnt5ZhR3wP9Ac";
        const GEMINI_ENDPOINT = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY_AI}`;
        const GEMINI_PROMPT_FORMAT = `{"prot":g,"kcal":kcal,"carb":g,"zuccheri":g,"fatSat":g,"fatTrans":g,"fatMono":g,"fatPoly":g,"omega3":g,"omega6":g,"fibreTotali":g,"fibreSolubili":g,"fibreInsolubili":g,"mg":mg,"k":mg,"vitc":mg,"ca":mg,"vitA":µg,"vitB12":µg,"vitD":µg,"vitE":mg,"vitK":µg,"b9":µg,"b2":mg,"b6":mg,"fe":mg,"zn":mg,"cu":mg,"p":mg,"leu":mg,"iso":mg,"val":mg,"lys":mg,"met":mg,"phe":mg,"thr":mg,"trp":mg,"his":mg}`;
        const AI_INSTRUCTION = "Agisci come un esperto nutrizionista. Basa le tue risposte su database nutrizionali affidabili (come IEO, USDA, CREA). Se un valore non è disponibile, fornisci una stima scientificamente plausibile basata sulla composizione dell'alimento. Per gli amminoacidi, fornisci un profilo specifico per la fonte proteica dell'alimento, non un profilo generico. Assicurati che le unità di misura siano corrette come specificato nel formato JSON richiesto.";

        // --- RIFERIMENTI AGLI ELEMENTI DEL DOM ---
        const authSection = document.getElementById('auth-section');
        const userEmailInput = document.getElementById('user-email');
        const userPasswordInput = document.getElementById('user-password');
        const btnRegister = document.getElementById('btn-register');
        const btnLogin = document.getElementById('btn-login');
        const btnSignOut = document.getElementById('btn-sign-out');
        const authStatusP = document.getElementById('auth-status');
        const welcomeMessage = document.getElementById('welcome-message');
        const authFormFields = document.getElementById('auth-form-fields');
        const mainTrackerContent = document.getElementById('main-tracker-content');
        const titoloGiornataEl = document.getElementById('titolo-giornata');
        const logBody = document.getElementById('log-body');
        const suggestionsContainer = document.getElementById('custom-suggestions');
        const btnAggiungiSingolo = document.getElementById('btn-aggiungi-singolo');
        const btnCostruisciPasto = document.getElementById('btn-costruisci-pasto');
        const mealBuilderSezione = document.getElementById('meal-builder-sezione');
        const logPastoBuilderBody = document.getElementById('log-pasto-builder-body');
        const btnSalvaPasto = document.getElementById('btn-salva-pasto');
        const mealTypeSelector = document.getElementById('meal-type-selector');
        const dataCaricamentoInput = document.getElementById('data-caricamento');
        const calorieBalanceText = document.getElementById('calorie-balance-text');
        const calorieAdjustmentInput = document.getElementById('calorie-adjustment-input');
        const btnCalorieMinus = document.getElementById('btn-calorie-minus');
        const btnCaloriePlus = document.getElementById('btn-calorie-plus');
        const btnDownloadManual = document.getElementById('btn-download-manual');
        const cloudSyncStatusSpan = document.getElementById('cloud-sync-status');
        const btnCopyPrompt = document.getElementById('btn-copy-prompt');
        const manualJsonInput = document.getElementById('manual-json-input');
        const btnConfirmJson = document.getElementById('btn-confirm-json');
        const btnClearNutrients = document.getElementById('btn-clear-nutrients');
        const weeklyVitaminModal = document.getElementById('weekly-vitamin-modal');
        const infoVitSettimanaliBtn = document.getElementById('info-vit-settimanali');
        const weeklyFatsModal = document.getElementById('weekly-fats-modal');
        const infoFatsSettimanaliBtn = document.getElementById('info-fats-settimanali');
        const nutrientDetailModal = document.getElementById('nutrient-detail-modal');
        const nutrientDetailTitle = document.getElementById('nutrient-detail-modal-title');
        const nutrientDetailList = document.getElementById('nutrient-detail-modal-list');
        const builderDesc = document.getElementById('builder-desc'), builderQta = document.getElementById('builder-qta');
        const dailyNotesTextarea = document.getElementById('daily-notes');
        const btnEditIngredients = document.getElementById('btn-edit-ingredients');
        const btnEditName = document.getElementById('btn-edit-name');
        const ingredientModal = document.getElementById('ingredient-modal');
        const ingredientModalTitle = document.getElementById('ingredient-modal-title');
        const ingredientModalTextarea = document.getElementById('ingredient-modal-textarea');
        const ingredientModalActions = document.getElementById('ingredient-modal-actions');
        const btnGenerateIngredientsAi = document.getElementById('btn-generate-ingredients-ai');
        const btnCopyIngredientsPrompt = document.getElementById('btn-copy-ingredients-prompt');
        const btnSaveIngredients = document.getElementById('btn-save-ingredients');
        const btnClearIngredients = document.getElementById('btn-clear-ingredients');
        const btnPhotoIngredients = document.getElementById('btn-photo-ingredients');
        const ingredientPhotoInput = document.getElementById('ingredient-photo-input');
        const ocrStatusIngredients = document.getElementById('ocr-status-ingredients');
        const btnPhotoNutrients = document.getElementById('btn-photo-nutrients');
        const nutrientPhotoInput = document.getElementById('nutrient-photo-input');
        const nutrientConfirmModal = document.getElementById('nutrient-confirm-modal');
        const nutrientConfirmList = document.getElementById('nutrient-confirm-list');
        const btnConfirmNutrients = document.getElementById('btn-confirm-nutrients');
        const btnCancelNutrients = document.getElementById('btn-cancel-nutrients');
        const ocrStatusNutrients = document.getElementById('ocr-status-nutrients');
        const photoOcrStatus = document.getElementById('photo-ocr-status');
        const btnScanBarcode = document.getElementById('btn-scan-barcode');
        const barcodeScannerModal = document.getElementById('barcode-scanner-modal');
        const barcodeScannerVideo = document.getElementById('barcode-scanner-video');
        const barcodeScannerStatus = document.getElementById('barcode-scanner-status');
        const diffModal = document.getElementById('diff-modal');
        const workoutDescInput = document.getElementById('workout-desc'), workoutCaloriesInput = document.getElementById('workout-calories'), btnAddWorkout = document.getElementById('btn-add-workout');
        const currentMealTypeDisplay = document.getElementById('current-meal-type-display');
        const mealProtCurrent = document.getElementById('meal-prot-current'), mealProtTarget = document.getElementById('meal-prot-target'), mealProtRemaining = document.getElementById('meal-prot-remaining');
        const mealCalCurrent = document.getElementById('meal-cal-current'), mealCalTarget = document.getElementById('meal-cal-target'), mealCalRemaining = document.getElementById('meal-cal-remaining');
        const mealProgressProt = document.getElementById('meal-progress-prot'), mealProgressCal = document.getElementById('meal-progress-cal');
        
        const inputFields = {
            prot: { el: document.getElementById('builder-prot'), label: 'Proteine/100g' }, kcal: { el: document.getElementById('builder-kcal'), label: 'Kcal/100g' },
            carb: { el: document.getElementById('builder-carb'), label: 'Carboidrati/100g' }, zuccheri: { el: document.getElementById('builder-zuccheri'), label: 'Zuccheri/100g' },
            fatTotal: { el: document.getElementById('builder-fat-total'), label: 'Grassi Totali/100g' }, fatSat: { el: document.getElementById('builder-fat-sat'), label: 'Gr. Saturi/100g' },
            fatTrans: { el: document.getElementById('builder-fat-trans'), label: 'Gr. Trans/100g' }, fatMono: { el: document.getElementById('builder-fat-mono'), label: 'Gr. Monoinsaturi/100g' },
            fatPoly: { el: document.getElementById('builder-fat-poly'), label: 'Gr. Polinsaturi/100g' }, omega3: { el: document.getElementById('builder-omega3'), label: 'Omega 3/100g' },
            omega6: { el: document.getElementById('builder-omega6'), label: 'Omega 6/100g' }, fibreTotali: { el: document.getElementById('builder-fibre-totali'), label: 'Fibre Totali/100g' },
            fibreSolubili: { el: document.getElementById('builder-fibre-solubili'), label: 'Fibre Solubili/100g' }, fibreInsolubili: { el: document.getElementById('builder-fibre-insolubili'), label: 'Fibre Insolubili/100g' },
            mg: { el: document.getElementById('builder-mg'), label: 'Magnesio (mg)/100g' }, k: { el: document.getElementById('builder-k'), label: 'Potassio (mg)/100g' },
            vitc: { el: document.getElementById('builder-vitc'), label: 'Vitamina C (mg)/100g' }, ca: { el: document.getElementById('builder-ca'), label: 'Calcio (mg)/100g' },
            fe: { el: document.getElementById('builder-fe'), label: 'Ferro (mg)/100g' }, zn: { el: document.getElementById('builder-zn'), label: 'Zinco (mg)/100g' },
            cu: { el: document.getElementById('builder-cu'), label: 'Rame (mg)/100g' }, p: { el: document.getElementById('builder-p'), label: 'Fosforo (mg)/100g' },
            vitA: { el: document.getElementById('builder-vit-a'), label: 'Vit. A (μg)/100g' }, vitB12: { el: document.getElementById('builder-vit-b12'), label: 'Vit. B12 (μg)/100g' },
            vitD: { el: document.getElementById('builder-vit-d'), label: 'Vit. D (μg)/100g' }, vitE: { el: document.getElementById('builder-vit-e'), label: 'Vit. E (mg)/100g' },
            vitK: { el: document.getElementById('builder-vit-k'), label: 'Vit. K (μg)/100g' }, b9: { el: document.getElementById('builder-b9'), label: 'Folati B9 (μg)/100g' },
            b2: { el: document.getElementById('builder-b2'), label: 'Vit. B2 (mg)/100g' }, b6: { el: document.getElementById('builder-b6'), label: 'Vit. B6 (mg)/100g' },
            leu: { el: document.getElementById('builder-leu'), label: 'Leucina (mg)/100g' }, iso: { el: document.getElementById('builder-iso'), label: 'Isoleucina (mg)/100g' },
            val: { el: document.getElementById('builder-val'), label: 'Valina (mg)/100g' }, lys: { el: document.getElementById('builder-lys'), label: 'Lisina (mg)/100g' },
            met: { el: document.getElementById('builder-met'), label: 'Metionina (mg)/100g' }, phe: { el: document.getElementById('builder-phe'), label: 'Fenilalanina (mg)/100g' },
            thr: { el: document.getElementById('builder-thr'), label: 'Treonina (mg)/100g' }, trp: { el: document.getElementById('builder-trp'), label: 'Triptofano (mg)/100g' },
            his: { el: document.getElementById('builder-his'), label: 'Istidina (mg)/100g' }
        };
        const spanElements = {
            totaleProteine: document.getElementById('totale-proteine'), obiettivoProteine: document.getElementById('obiettivo-proteine'), totaleCalorie: document.getElementById('totale-calorie'),
            obiettivoCalorie: document.getElementById('obiettivo-calorie'), totaleCarboidrati: document.getElementById('totale-carboidrati'), obiettivoCarboidrati: document.getElementById('obiettivo-carboidrati'),
            totaleZuccheri: document.getElementById('totale-zuccheri'), obiettivoZuccheri: document.getElementById('obiettivo-zuccheri'), workoutCalories: document.getElementById('workout-calories-totali'),
            totaleFibreTotali: document.getElementById('totale-fibre-totali'), obiettivoFibreTotali: document.getElementById('obiettivo-fibre-totali'), totaleFibreSolubili: document.getElementById('totale-fibre-solubili'),
            obiettivoFibreSolubili: document.getElementById('obiettivo-fibre-solubili'), totaleFibreInsolubili: document.getElementById('totale-fibre-insolubili'), obiettivoFibreInsolubili: document.getElementById('obiettivo-fibre-insolubili'),
            totaleFatsTotal: document.getElementById('totale-fats-total'), obiettivoFatsTotal: document.getElementById('obiettivo-fats-total'), totaleFatSat: document.getElementById('totale-fat-sat'),
            obiettivoFatSat: document.getElementById('obiettivo-fat-sat'), totaleFatTrans: document.getElementById('totale-fat-trans'), obiettivoFatTrans: document.getElementById('obiettivo-fat-trans'),
            totaleFatUnsat: document.getElementById('totale-fat-unsat'), obiettivoFatUnsat: document.getElementById('obiettivo-fat-unsat'), totaleFatMono: document.getElementById('totale-fat-mono'),
            obiettivoFatMono: document.getElementById('obiettivo-fat-mono'), totaleFatPoly: document.getElementById('totale-fat-poly'), obiettivoFatPoly: document.getElementById('obiettivo-fat-poly'),
            totaleOmega3: document.getElementById('totale-omega3'), obiettivoOmega3: document.getElementById('obiettivo-omega3'), totaleOmega6: document.getElementById('totale-omega6'),
            obiettivoOmega6: document.getElementById('obiettivo-omega6'), omegaRatioValue: document.getElementById('omega-ratio-value'), totaleMg: document.getElementById('totale-mg'),
            totaleK: document.getElementById('totale-k'), totaleCa: document.getElementById('totale-ca'), totaleFe: document.getElementById('totale-fe'), totaleZn: document.getElementById('totale-zn'),
            totaleCu: document.getElementById('totale-cu'), totaleP: document.getElementById('totale-p'), totaleVitC: document.getElementById('totale-vitc'), totaleVitA: document.getElementById('totale-vit-a'),
            totaleVitB12: document.getElementById('totale-vit-b12'), totaleVitD: document.getElementById('totale-vit-d'), totaleVitE: document.getElementById('totale-vit-e'),
            totaleVitK: document.getElementById('totale-vit-k'), totaleB9: document.getElementById('totale-b9'), totaleB2: document.getElementById('totale-b2'), totaleB6: document.getElementById('totale-b6'),
        };
        const progressElements = {
            proteine: document.getElementById('progress-proteine'), calorie: document.getElementById('progress-calorie'), carboidrati: document.getElementById('progress-carboidrati'),
            zuccheri: document.getElementById('progress-zuccheri'), fibreTotali: document.getElementById('progress-fibre-totali'), fibreSolubili: document.getElementById('progress-fibre-solubili'),
            fibreInsolubili: document.getElementById('progress-fibre-insolubili'), fatsTotal: document.getElementById('progress-fats-total'), fatSat: document.getElementById('progress-fat-sat'),
            fatTrans: document.getElementById('progress-fat-trans'), fatUnsat: document.getElementById('progress-fat-unsat'), fatMono: document.getElementById('progress-fat-mono'),
            fatPoly: document.getElementById('progress-fat-poly'), omega3: document.getElementById('progress-omega3'), omega6: document.getElementById('progress-omega6'),
            mg: document.getElementById('progress-mg'), k: document.getElementById('progress-k'), ca: document.getElementById('progress-ca'), fe: document.getElementById('progress-fe'),
            zn: document.getElementById('progress-zn'), cu: document.getElementById('progress-cu'), p: document.getElementById('progress-p'), vitc: document.getElementById('progress-vitc'),
            vitA: document.getElementById('progress-vit-a'), vitB12: document.getElementById('progress-vit-b12'), vitD: document.getElementById('progress-vit-d'),
            vitE: document.getElementById('progress-vit-e'), vitK: document.getElementById('progress-vit-k'), b9: document.getElementById('progress-b9'),
            b2: document.getElementById('progress-b2'), b6: document.getElementById('progress-b6')
        };
        
        // --- FUNZIONI HELPER E DI UTILITÀ ---
        function getTodayString(format = 'ymd') { return new Date().toISOString().split('T')[0]; }
        function sanitizeFirebaseKey(str) { return str ? str.replace(/[.#$/\[\]]/g, '_') : ''; }
        function evaluateQuantity(input) {
            try {
                let value = input.trim().replace(',', '.');
                if (/^[0-9+\-*/.\s()]+$/.test(value)) {
                    const result = new Function(`return ${value}`)();
                    if (typeof result === 'number' && !isNaN(result)) return result;
                }
            } catch (e) { console.error("Errore valutazione quantità:", e); }
            return parseFloat(input.replace(',', '.'));
        }

        // --- GESTIONE DATI (LOCALSTORAGE E FIREBASE) ---
        async function saveSingleItemToCloud(path, data) {
            if (!db || !currentUserUID) return;
            try {
                const dataRef = ref(db, `users/${currentUserUID}/tracker_data/${path}`);
                await set(dataRef, data);
                await set(ref(db, `users/${currentUserUID}/${CLOUD_LAST_UPDATE_PATH}`), Date.now());
            } catch (err) { console.error(`Errore salvataggio su cloud per ${path}:`, err); }
        }
        function salvaFoodDatabase() { 
            localStorage.setItem('trackerFoodDatabase', JSON.stringify(foodDatabase)); 
            localStorage.setItem(LOCAL_LAST_UPDATE_KEY, Date.now()); 
            const sanitizedDb = Object.keys(foodDatabase).reduce((acc, key) => { acc[sanitizeFirebaseKey(key)] = foodDatabase[key]; return acc; }, {});
            saveSingleItemToCloud('trackerFoodDatabase', sanitizedDb);
        }
        function salvaPastoInCostruzione() { 
            localStorage.setItem('trackerPastoInCostruzione', JSON.stringify(pastoInCostruzione)); 
            localStorage.setItem(LOCAL_LAST_UPDATE_KEY, Date.now()); 
            saveSingleItemToCloud('trackerPastoInCostruzione', pastoInCostruzione);
        }
        function salvaGiorno(dataDaSalvare, datiDaSalvare = datiGiornalieri) {
            datiDaSalvare.note = dailyNotesTextarea.value;
            datiDaSalvare.data = dataDaSalvare;
            const key = `trackerStorico_${dataDaSalvare}`;
            localStorage.setItem(key, JSON.stringify(datiDaSalvare));
            localStorage.setItem(LOCAL_LAST_UPDATE_KEY, Date.now());
            saveSingleItemToCloud(key, datiDaSalvare);
        }
        function caricaGiorno(data) {
            giornoVisualizzato = data;
            dataCaricamentoInput.value = data;
            const rawData = localStorage.getItem(`trackerStorico_${data}`);
            let datiTrovati = null;
            try {
                datiTrovati = JSON.parse(rawData);
                 if (datiTrovati?.log) {
                    datiTrovati.log.forEach(entry => (entry.type === 'meal' ? entry.items : [entry]).forEach(item => { if (item?.cal && !item.kcal) { item.kcal = item.cal; delete item.cal; }}));
                }
            } catch (e) { console.error(`Errore parsing trackerStorico_${data}:`, e); }
            datiGiornalieri = datiTrovati || { log: [], workoutCalorie: 0, note: '' };
            dailyNotesTextarea.value = datiGiornalieri.note || '';
            datiGiornalieri.log = datiGiornalieri.log || [];
            datiGiornalieri.workoutCalorie = datiGiornalieri.workoutCalorie || 0;
            const giornoSettimana = new Date(data).getDay();
            if (typeof datiGiornalieri.calorieAdjustment === 'undefined' || datiGiornalieri.calorieAdjustment === 0) {
                datiGiornalieri.calorieAdjustment = DEFICIT_PREIMPOSTATO_SETTIMANALE[giornoSettimana] || 0;
            }
            aggiornaUI();
        }
        async function loadAllTrackerDataFromCloud(skipConfirm = false) {
            if (!db || !currentUserUID) { alert("Devi essere autenticato."); return; }
            if (!skipConfirm && !confirm("ATTENZIONE: i dati locali verranno SOVRASCRITTI. Continuare?")) return;
            try {
                const snapshot = await get(ref(db, `users/${currentUserUID}/tracker_data/`));
                if (snapshot.exists()) {
                    const cloudData = snapshot.val();
                    const keysToRemove = Array.from({ length: localStorage.length }, (_, i) => localStorage.key(i)).filter(key => key.startsWith('trackerStorico_') || LOCAL_STORAGE_SYNC_KEYS.includes(key) || key.startsWith('lastMealTypeSelected_'));
                    keysToRemove.forEach(key => localStorage.removeItem(key));
                    for (const key in cloudData) { localStorage.setItem(key, typeof cloudData[key] === 'object' ? JSON.stringify(cloudData[key]) : cloudData[key]); }
                    const cloudTimestampSnapshot = await get(ref(db, `users/${currentUserUID}/${CLOUD_LAST_UPDATE_PATH}`));
                    localStorage.setItem(LOCAL_LAST_UPDATE_KEY, cloudTimestampSnapshot.exists() ? cloudTimestampSnapshot.val() : Date.now());
                    alert("Dati scaricati! La pagina verrà ricaricata.");
                    location.reload();
                } else if (!skipConfirm) { alert("Nessun dato trovato sul cloud."); }
            } catch (error) { alert(`Errore download: ${error.message}`); }
        }

        // --- FUNZIONI DI CALCOLO E LOGICA ---
        function calcolaObiettiviPasto(mealType, giornoCorrenteString) {
            const dataVisualizzata = new Date(giornoCorrenteString);
            const pianoDelGiorno = PIANO_SETTIMANALE[dataVisualizzata.getDay()] || PIANO_SETTIMANALE[1];
            const obiettivoCalTotaleGiornaliero = pianoDelGiorno.cal_base + (datiGiornalieri.workoutCalorie || 0) + (datiGiornalieri.calorieAdjustment || 0);
            const obiettivoProtTotaleGiornaliero = pianoDelGiorno.prot;
            let obiettivoPastoProt = 0, obiettivoPastoCal = 0;
            if (mealType === 'cena') {
                const consumato = (datiGiornalieri.log || []).reduce((acc, entry) => {
                    if (entry.mealId && entry.mealId !== 'cena') (entry.type === 'meal' ? entry.items : [entry]).forEach(item => { acc.prot += item.prot || 0; acc.kcal += item.kcal || 0; });
                    return acc;
                }, {prot: 0, kcal: 0});
                obiettivoPastoProt = Math.max(0, Math.round(obiettivoProtTotaleGiornaliero - consumato.prot));
                obiettivoPastoCal = Math.max(0, Math.round(obiettivoCalTotaleGiornaliero - consumato.kcal));
            } else {
                obiettivoPastoProt = Math.round(obiettivoProtTotaleGiornaliero * (OBIETTIVI_MACRO_PASTO_BASE_FORZA[mealType]?.prot_perc ?? 0));
                obiettivoPastoCal = Math.round(obiettivoCalTotaleGiornaliero * (OBIETTIVI_MACRO_PASTO_BASE_FORZA[mealType]?.cal_perc ?? 0));
            }
            const totaliPasto = pastoInCostruzione.reduce((acc, item) => { acc.prot += item.prot || 0; acc.kcal += item.kcal || 0; return acc; }, { prot: 0, kcal: 0 });
            return {
                currentProt: totaliPasto.prot, targetProt: obiettivoPastoProt, remainingProt: obiettivoPastoProt - totaliPasto.prot,
                currentCal: totaliPasto.kcal, targetCal: obiettivoPastoCal, remainingCal: obiettivoPastoCal - totaliPasto.kcal
            };
        }
        function calcolaQualitaProteine(item) {
            if (!item?.prot) return { score: 0, limiting: 'N/D' };
            let minRatio = Infinity, limitingAmino = 'Nessuno';
            for (const amino in PROFILO_AMINOACIDICO_RIFERIMENTO) {
                const ratio = Math.min(1, ((item[amino] || 0) / item.prot) / PROFILO_AMINOACIDICO_RIFERIMENTO[amino]);
                if (ratio < minRatio) { minRatio = ratio; limitingAmino = amino.charAt(0).toUpperCase() + amino.slice(1); }
            }
            return { score: Math.round(minRatio * 100), limiting: limitingAmino };
        }

        // --- FUNZIONI DI AGGIORNAMENTO E RENDER DELL'INTERFACCIA ---
        function aggiornaUI() {
            const dataVisualizzata = new Date(giornoVisualizzato);
            const pianoDelGiorno = PIANO_SETTIMANALE[dataVisualizzata.getDay()] || PIANO_SETTIMANALE[1];
            const obiettivoCalorieTotale = pianoDelGiorno.cal_base + (datiGiornalieri.workoutCalorie || 0) + (datiGiornalieri.calorieAdjustment || 0);
            const OBIETTIVI = { prot: pianoDelGiorno.prot, kcal: obiettivoCalorieTotale, carb: pianoDelGiorno.carb, zuccheri: pianoDelGiorno.zuccheri, ...OBIETTIVI_MICRO, ...OBIETTIVI_FAT, ...OBIETTIVI_VIT, ...OBIETTIVI_AMINO, ...OBIETTIVI_FIBRE };
            titoloGiornataEl.textContent = `${pianoDelGiorno.tipo} - ${dataVisualizzata.toLocaleDateString('it-IT', {day: 'numeric', month: 'long', year: 'numeric'})}`;
            
            let totali = Object.keys(OBIETTIVI).reduce((acc, key) => ({...acc, [key]: 0}), {});
            (datiGiornalieri.log || []).forEach(entry => {
                if (entry.type !== 'workout') (entry.type === 'meal' ? entry.items : [entry]).forEach(item => { for(const key in totali) totali[key] += item[key] || 0; });
            });
            totali.fatUnsat = totali.fatMono + totali.fatPoly;

            // Aggiorna tutti i testi e le progress bar
            for (const key in spanElements) { if(spanElements[key]) spanElements[key].textContent = totali[key.replace('totale','').toLowerCase()]?.toFixed(1) ?? OBIETTIVI[key.replace('obiettivo','').toLowerCase()] ?? '0' }
            for (const key in progressElements) { if(progressElements[key]) { progressElements[key].max = OBIETTIVI[key]; progressElements[key].value = totali[key]; }}
            spanElements.workoutCalories.textContent = datiGiornalieri.workoutCalorie?.toFixed(0) || 0;
            
            // Calcolo e stile del rapporto omega
            const ratio = totali.omega3 > 0 ? totali.omega6 / totali.omega3 : Infinity;
            spanElements.omegaRatioValue.textContent = isFinite(ratio) ? `${ratio.toFixed(1)}:1` : 'N/D';
            spanElements.omegaRatioValue.style.color = (ratio >= 3 && ratio <= 6) ? '#2e7d32' : '#d32f2f';

            // Calcolo e stile del bilancio calorico
            const calorieDifference = totali.kcal - (pianoDelGiorno.cal_base + (datiGiornalieri.workoutCalorie || 0));
            calorieBalanceText.className = '';
            if (calorieDifference < -50) { calorieBalanceText.textContent = `Deficit: ${Math.abs(calorieDifference).toFixed(0)} kcal`; calorieBalanceText.classList.add('balance-deficit'); }
            else if (calorieDifference > 50) { calorieBalanceText.textContent = `Surplus: ${calorieDifference.toFixed(0)} kcal`; calorieBalanceText.classList.add('balance-surplus'); }
            else { calorieBalanceText.textContent = `In Pari`; calorieBalanceText.classList.add('balance-even'); }
            calorieAdjustmentInput.value = datiGiornalieri.calorieAdjustment || 0;

            // Render del diario
            logBody.innerHTML = '';
            const nutrientKeys = ['kcal', 'fibreTotali', 'fibreSolubili', 'fibreInsolubili', ...Object.keys(OBIETTIVI_AMINO), 'fatSat', 'fatTrans', 'fatMono', 'fatPoly', 'omega3', 'omega6', 'mg', 'k', 'vitc', 'ca', 'fe', 'zn', 'cu', 'vitA', 'vitB12', 'vitD', 'vitE', 'vitK', 'b9', 'b2', 'b6', 'p'];
            const formatNumber = (k, v) => (v||0).toFixed(['cu', 'b2', 'b6'].includes(k) ? 2 : (['kcal', 'k', 'p', ...Object.keys(OBIETTIVI_AMINO)].includes(k) ? 0 : 1));
            
            (datiGiornalieri.log || []).forEach((entry, index) => {
                const row = logBody.insertRow();
                const createQualitaCell = (item) => { const q = calcolaQualitaProteine(item); return `<div class="protein-score ${q.score<70 ? 'low' : q.score<90 ? 'medium' : 'high'}" title="Limitante: ${q.limiting}">${q.score}%</div>`; };
                if (entry.type === 'meal') {
                    row.className = 'meal-group-row';
                    const totaliPasto = entry.items.reduce((acc, item) => { for (const key in item) if(typeof item[key] === 'number' && key !== 'qta') acc[key] = (acc[key] || 0) + item[key]; return acc; }, {});
                    row.innerHTML = `<td><span class="expand-arrow" data-index="${index}">${entry.isExpanded ? '▼' : '▶'}</span> ${entry.desc}</td><td>${entry.items.reduce((s, i) => s + i.qta, 0).toFixed(0)}</td><td>${(totaliPasto.prot||0).toFixed(1)}</td><td>${createQualitaCell(totaliPasto)}</td>${nutrientKeys.map(k => `<td>${formatNumber(k, totaliPasto[k])}</td>`).join('')}<td class="action-buttons"><button class="edit-btn" data-index="${index}">✏️</button><button class="delete-btn" data-index="${index}">&times;</button></td>`;
                    if (entry.isExpanded) entry.items.forEach(subItem => {
                        const subRow = logBody.insertRow();
                        subRow.className = 'sub-item-row';
                        subRow.innerHTML = `<td>${subItem.desc}</td><td>${(subItem.qta||0).toFixed(0)}</td><td>${(subItem.prot||0).toFixed(1)}</td><td>${createQualitaCell(subItem)}</td>${nutrientKeys.map(k => `<td>${formatNumber(k, subItem[k])}</td>`).join('')}<td></td>`;
                    });
                } else if (entry.type === 'workout') {
                    row.innerHTML = `<td>${entry.desc}</td><td></td><td></td><td></td><td>${(entry.kcal||0).toFixed(0)}</td><td colspan="${nutrientKeys.length-1}"></td><td class="action-buttons"><button class="delete-btn" data-index="${index}">&times;</button></td>`;
                } else {
                    row.innerHTML = `<td>${entry.desc}</td><td>${(entry.qta||0).toFixed(0)}</td><td>${(entry.prot||0).toFixed(1)}</td><td>${createQualitaCell(entry)}</td>${nutrientKeys.map(k => `<td>${formatNumber(k, entry[k])}</td>`).join('')}<td class="action-buttons"><button class="edit-btn" data-index="${index}">✏️</button><button class="delete-btn" data-index="${index}">&times;</button></td>`;
                }
            });
        }
        function renderMealBuilder() {
            mealBuilderSezione.dataset.visible = pastoInCostruzione.length > 0;
            logPastoBuilderBody.innerHTML = ''; 
            const mealType = mealTypeSelector.value;
            const obiettivi = calcolaObiettiviPasto(mealType, giornoVisualizzato);
            currentMealTypeDisplay.textContent = mealTypeSelector.options[mealTypeSelector.selectedIndex].text;
            mealProtCurrent.textContent = obiettivi.currentProt.toFixed(1); mealProtTarget.textContent = obiettivi.targetProt.toFixed(0); mealProtRemaining.textContent = `${obiettivi.remainingProt.toFixed(1)} g`;
            mealCalCurrent.textContent = obiettivi.currentCal.toFixed(0); mealCalTarget.textContent = obiettivi.targetCal.toFixed(0); mealCalRemaining.textContent = `${obiettivi.remainingCal.toFixed(0)} kcal`;
            mealProgressProt.max = obiettivi.targetProt; mealProgressProt.value = obiettivi.currentProt;
            mealProgressCal.max = obiettivi.targetCal; mealProgressCal.value = obiettivi.currentCal;
            pastoInCostruzione.forEach((item, index) => { 
                const row = logPastoBuilderBody.insertRow(); 
                row.innerHTML = `<td><input type="checkbox" class="meal-item-checkbox" data-index="${index}" ${item.selezionato !== false ? 'checked' : ''}></td><td>${item.desc}</td><td>${item.qta}</td><td>${(item.prot||0).toFixed(1)}</td><td>${(item.kcal||0).toFixed(0)}</td><td class="action-buttons"><button class="delete-btn" data-type="builder" data-index="${index}">&times;</button></td>`; 
            });
        }
        function renderSuggestions() {
            const value = builderDesc.value.toLowerCase();
            suggestionsContainer.innerHTML = '';
            let keysToShow = Object.keys(foodDatabase);
            if (value.length > 0) keysToShow = keysToShow.filter(key => foodDatabase[key]?.desc?.toLowerCase().includes(value));
            const matches = keysToShow.sort((a,b) => (foodDatabase[a]?.desc || '').localeCompare(foodDatabase[b]?.desc || ''));
            if (matches.length > 0) {
                matches.forEach(sanitizedKey => {
                    const originalDesc = foodDatabase[sanitizedKey].desc;
                    suggestionsContainer.innerHTML += `<div class="suggestion-item"><span>${originalDesc}</span><button class="suggestion-delete-btn" data-food-key="${sanitizedKey}" title="Cancella">&times;</button></div>`;
                });
                suggestionsContainer.style.display = 'block';
            } else {
                suggestionsContainer.style.display = 'none';
            }
        }
        
        // --- FUNZIONI DI GESTIONE MODALI ---
        function openModal(modalId) { document.getElementById(modalId).style.display = 'block'; }
        function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
        // ... (qui andrebbero le funzioni specifiche per popolare ogni modale, come openWeeklyVitaminsModal, etc.)

        // --- GESTIONE DEGLI EVENTI ---
        document.addEventListener('DOMContentLoaded', () => {
            goToPage(0); // Inizializza la navigazione alla prima pagina
            initAppUI();
        });
        function initAppUI() {
            // Connessione Firebase
            try {
                firebaseApp = getApps().length === 0 ? initializeApp(firebaseConfig) : getApp();
                db = getDatabase(firebaseApp); auth = getAuth(firebaseApp);
                onAuthStateChanged(auth, user => {
                    currentUserUID = user?.uid;
                    const isLoggedIn = !!user;
                    authSection.classList.toggle('logged-in', isLoggedIn);
                    mainTrackerContent.classList.toggle('authenticated', isLoggedIn);
                    welcomeMessage.textContent = isLoggedIn ? `Benvenuto, ${user.email}!` : '';
                    if (!isLoggedIn) mainTrackerContent.style.display = 'none';
                    else {
                        mainTrackerContent.style.display = 'block';
                        loadInitialData(); // Carica i dati solo dopo il login
                    }
                });
            } catch (e) { console.error("Firebase init error", e); }
            
            // Carica dati da localStorage
            function loadInitialData() {
                foodDatabase = JSON.parse(localStorage.getItem('trackerFoodDatabase')) || {};
                pastoInCostruzione = JSON.parse(localStorage.getItem('trackerPastoInCostruzione')) || [];
                renderMealBuilder();
                caricaGiorno(getTodayString());
            }

            // Event listener globali
            document.body.addEventListener('click', e => {
                // Gestione chiusura modali
                if(e.target.classList.contains('modal')) e.target.style.display = 'none';
                if(e.target.closest('.modal-close')) e.target.closest('.modal').style.display = 'none';
                
                const deleteBtn = e.target.closest('.delete-btn');
                if (deleteBtn) {
                    if (!confirm('Cancellare la voce?')) return;
                    const index = parseInt(deleteBtn.dataset.index, 10);
                    if (deleteBtn.dataset.type === 'builder') {
                        pastoInCostruzione.splice(index, 1);
                        salvaPastoInCostruzione();
                        renderMealBuilder();
                    } else {
                        const item = datiGiornalieri.log[index];
                        if (item.type === 'workout') datiGiornalieri.workoutCalorie = Math.max(0, datiGiornalieri.workoutCalorie - (item.kcal || 0));
                        datiGiornalieri.log.splice(index, 1);
                        salvaGiorno(giornoVisualizzato);
                        aggiornaUI();
                    }
                }
            });

            // Auth
            btnRegister.addEventListener('click', () => createUserWithEmailAndPassword(auth, userEmailInput.value, userPasswordInput.value).catch(e => alert(e.message)));
            btnLogin.addEventListener('click', () => signInWithEmailAndPassword(auth, userEmailInput.value, userPasswordInput.value).catch(e => alert(e.message)));
            btnSignOut.addEventListener('click', () => signOut(auth));

            // Aggiunta alimenti/pasti
            btnAggiungiSingolo.addEventListener('click', () => handleAlimentoAddition(false));
            btnCostruisciPasto.addEventListener('click', () => handleAlimentoAddition(true));
            btnSalvaPasto.addEventListener('click', () => {
                const alimentiSelezionati = pastoInCostruzione.filter(item => item.selezionato !== false);
                if (alimentiSelezionati.length === 0) return alert("Nessun alimento selezionato.");
                const mealId = mealTypeSelector.value;
                datiGiornalieri.log.push({ type: 'meal', desc: mealTypeSelector.options[mealTypeSelector.selectedIndex].text, mealId, isExpanded: false, items: alimentiSelezionati });
                pastoInCostruzione = [];
                salvaPastoInCostruzione();
                salvaGiorno(giornoVisualizzato);
                aggiornaUI();
                renderMealBuilder();
                const nextIndex = (MEAL_TYPE_SEQUENCE.indexOf(mealId) + 1) % MEAL_TYPE_SEQUENCE.length;
                mealTypeSelector.value = MEAL_TYPE_SEQUENCE[nextIndex];
            });

            // Altri listener...
            dataCaricamentoInput.addEventListener('change', e => caricaGiorno(e.target.value));
            document.getElementById('btn-vai-a-oggi').addEventListener('click', () => caricaGiorno(getTodayString()));
            btnCalorieMinus.addEventListener('click', () => handleCalorieAdjustment(-10));
            btnCaloriePlus.addEventListener('click', () => handleCalorieAdjustment(10));
            
            // ...e tutti gli altri event listener da index.html
        }
        
        function handleCalorieAdjustment(increment) {
            datiGiornalieri.calorieAdjustment = (datiGiornalieri.calorieAdjustment || 0) + increment;
            salvaGiorno(giornoVisualizzato);
            aggiornaUI();
            renderMealBuilder();
        }

        async function handleAlimentoAddition(isForMealBuilder) {
            const desc = builderDesc.value.trim();
            const qta = evaluateQuantity(builderQta.value);
            if (!desc || isNaN(qta) || qta <= 0) return alert('Inserisci nome e quantità valide.');
            
            // Logica per creare l'oggetto 'item' da creaAlimentoDaInput()
            const sanitizedKey = sanitizeFirebaseKey(desc.toLowerCase());
            const foodData = foodDatabase[sanitizedKey] || {};
            foodData.lastQta = qta;
            foodData.desc = desc;
            const item = { desc: desc.charAt(0).toUpperCase() + desc.slice(1), qta, ingredienti: foodData.ingredienti || null };
            for(const key in inputFields) {
                const val = inputFields[key].el.value.replace(',', '.');
                foodData[key] = val === '' ? null : parseFloat(val);
                if(foodData[key] !== null) item[key] = (foodData[key]/100) * qta;
            }
            foodDatabase[sanitizedKey] = foodData;
            salvaFoodDatabase();

            if (isForMealBuilder) {
                item.selezionato = true;
                pastoInCostruzione.push(item);
                salvaPastoInCostruzione();
                renderMealBuilder();
                mealBuilderSezione.scrollIntoView({ behavior: 'smooth' });
            } else {
                item.type = 'single';
                datiGiornalieri.log.push(item);
                salvaGiorno(giornoVisualizzato);
                aggiornaUI();
            }
        }
    </script>
</body>
</html>

