<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Tracker Nutrizionale</title>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        /* --- IMPOSTAZIONI GLOBALI E LAYOUT PRINCIPALE --- */
        :root {
            --header-height: 100px; /* Altezza dell'intestazione fissa */
        }
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Impedisce lo scroll dell'intera pagina */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f7f9;
        }
        .app-container {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        /* --- INTESTAZIONE FISSA CON NAVIGAZIONE --- */
        .app-header {
            padding: 15px;
            background-color: #ffffff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 100;
            height: var(--header-height);
            box-sizing: border-box;
            text-align: center;
        }
        .app-header h1 {
            margin: 0 0 10px 0;
            font-size: 1.5em;
            color: #0d47a1;
            border: none;
            padding: 0;
        }
        .page-navigation {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }
        .page-indicator {
            padding: 5px;
            cursor: pointer;
            color: #a0a0a0;
            font-weight: 600;
            font-size: 0.9em;
            transition: all 0.3s ease;
            border-bottom: 2px solid transparent;
        }
        .page-indicator.active {
            color: #1976d2;
            transform: scale(1.1);
            border-bottom-color: #1976d2;
        }
        .page-indicator.adjacent {
            color: #777;
            font-size: 0.8em;
        }

        /* --- LOGICA PER LO SCORRIMENTO LATERALE (SWIPE) --- */
        .swiper-container {
            flex-grow: 1;
            overflow: hidden;
        }
        .swiper-wrapper {
            display: flex;
            height: 100%;
            width: 400%; /* 100% per 4 pagine */
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .page {
            width: 100%;
            height: 100%;
            overflow-y: auto; /* Abilita lo scroll verticale per ogni pagina */
            padding: 20px;
            box-sizing: border-box;
            flex-shrink: 0;
        }
        
        /* --- STILI GENERALI DEI COMPONENTI --- */
        .container { width: 100%; max-width: 800px; margin: 0 auto; }
        h1, h2, h3 { color: #0d47a1; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-top: 0; }
        .page h2:first-child, .sezione h2:first-child { margin-top: 0; }
        h2 { font-size: 1.4em; }
        h3 { font-size: 1.1em; color: #333; border-bottom: 1px solid #eee; margin-top: 20px; }
        h4 { font-size: 1em; color: #1565c0; margin-top: 20px; margin-bottom: 10px; font-weight: 600; }
        #titolo-giornata { text-align: center; color: #d84315; font-weight: 600; margin-bottom: 20px; padding: 10px; background-color: #fff3e0; border-radius: 8px; border: 1px solid #ffe0b2;}
        .sezione { margin-bottom: 25px; padding: 20px; background-color: #ffffff; border: 1px solid #e0e0e0; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        input[type="text"], input[type="number"], input[type="date"], select, input[type="email"], input[type="password"], textarea {
            width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 1em;
        }
        button { background-color: #1976d2; color: white; padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 1em; font-weight: 600; transition: background-color 0.3s; }
        button:hover { background-color: #1565c0; }
        #form-allenamento button { background-color: #2e7d32; }
        .nav-links { display: flex; gap: 10px; margin-bottom: 20px; }
        .nav-links a { flex-grow: 1; text-align: center; padding: 10px; background-color: #607d8b; color: white; text-decoration: none; border-radius: 6px; font-weight: 600; }
        #riepilogo p { font-size: 1.1em; margin: 8px 0; }
        progress { width: 100%; height: 15px; border-radius: 6px; margin-top: 2px; cursor: pointer; }
        progress.macro-progress { height: 25px; }
        table { border-collapse: collapse; margin-top: 15px; font-size: 0.9em; width:100%; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; vertical-align: middle; }
        th { background-color: #f2f2f2; font-weight: 600; }
        .builder-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; }
        .button-group { display: flex; gap: 10px; margin-top: 15px; }
        #btn-costruisci-pasto { background-color: #ff8f00; }
        #btn-aggiungi-singolo { background-color: #5c6bc0; }
        #meal-builder-sezione[data-visible="false"] { display: none; }
        #meal-builder-sezione[data-visible="true"] { display: block; }
        #meal-builder-sezione { border-left: 5px solid #ff8f00; }
        #btn-salva-pasto { background-color: #2e7d32; width: 100%; margin-top: 15px; }
        #caricamento-manuale { margin-top: 25px; padding-top: 20px; border-top: 1px solid #eee;}
        #caricamento-manuale div { display: flex; gap: 10px; align-items: center; }
        #caricamento-manuale input { flex-grow: 1; margin-bottom: 0; }
        #caricamento-manuale button { flex-grow: 0; width: auto; margin-bottom: 0; }
        .action-buttons { display: flex; justify-content: center; align-items: center; gap: 8px; }
        .action-buttons button { background: none; border: none; padding: 4px; font-size: 1.3em; line-height: 1; cursor: pointer; }
        .edit-btn { color: #1976d2; }
        .delete-btn { color: #d32f2f; }
        .meal-group-row { background-color: #f0f4f8; font-weight: bold; }
        .expand-arrow { cursor: pointer; display: inline-block; width: 20px; text-align: center; }
        .sub-item-row td { padding-left: 25px !important; background-color: #fff; font-style: italic; color: #555; border-bottom: 1px dotted #ccc; }
        .sub-item-row td:last-child { visibility: hidden; }
        .nutrients-warning { color: #d32f2f !important; }
        #meal-builder-summary { margin-bottom: 20px; padding: 15px; background-color: #e3f2fd; border: 1px solid #90caf9; border-radius: 8px; }
        #meal-builder-summary p { margin: 5px 0; font-weight: 600; color: #1e88e5; }
        #meal-builder-summary .progress-container { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }
        @media (min-width: 600px) {
            #meal-builder-summary .progress-container { flex-direction: row; gap: 20px; }
        }
        #meal-builder-summary .progress-item { flex: 1; }
        #meal-builder-summary .progress-item p { font-size: 0.9em; margin-bottom: 5px; color: #3f51b5; }
        #meal-builder-summary .progress-item progress { height: 18px; border-radius: 4px; }
        #calorie-balance-text { display: block; text-align: center; font-weight: bold; font-size: 1.2em; margin-top: 15px; margin-bottom: 10px; padding: 8px 0; border-radius: 5px; }
        .balance-deficit { background-color: #ffebee; color: #d32f2f; }
        .balance-surplus { background-color: #e8f5e9; color: #2e7d32; }
        .balance-even { background-color: #e3f2fd; color: #1976d2; }
        .collapsible-header { cursor: pointer; padding: 10px 0; border-bottom: 1px solid #e0e0e0; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; color: #0d47a1; font-size: 1.4em; }
        .collapsible-header:hover { color: #1976d2; }
        .collapsible-header .arrow { font-size: 0.8em; transition: transform 0.3s ease; }
        .collapsible-content { display: none; overflow: hidden; transition: max-height 0.3s ease-out; max-height: 0; }
        .collapsible-content.expanded { display: block; max-height: 2000px; }
        .collapsible-header.expanded .arrow { transform: rotate(90deg); }
        #calorie-adjuster { display: flex; align-items: center; justify-content: center; margin-top: 10px; margin-bottom: 20px; gap: 10px; }
        #calorie-adjuster button { padding: 5px 12px; font-size: 1.2em; border-radius: 5px; background-color: #4CAF50; color: white; border: none; cursor: pointer; }
        .food-label-container { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .food-label-container label { margin-bottom: 0; flex-shrink: 0; }
        #btn-edit-ingredients, #btn-edit-name { background: none; border: none; font-size: 1.1em; color: #607d8b; cursor: pointer; padding: 0; line-height: 1; }
        #btn-edit-ingredients:hover, #btn-edit-name:hover { color: #1976d2; }
        .diary-table-container { 
            overflow-x: auto; 
            -webkit-box-shadow: inset -8px 0px 8px -8px rgba(0,0,0,0.1);
            box-shadow: inset -8px 0px 8px -8px rgba(0,0,0,0.1);
        }
        #log-pasti th, #log-pasti td { min-width: 60px; text-align: right; padding: 8px 10px; white-space: nowrap; }
        #log-pasti th:nth-child(1), #log-pasti td:nth-child(1) { min-width: 150px; text-align: left; position: -webkit-sticky; position: sticky; left: 0; z-index: 2; border-right: 2px solid #e0e0e0; }
        #log-pasti th:nth-child(2), #log-pasti td:nth-child(2) { min-width: 50px; text-align: left; }
        #log-pasti th:last-child, #log-pasti td:last-child { min-width: 80px; text-align: center; }
        #log-pasti th:first-child { background-color: #f8f9fa; }
        #log-pasti td:first-child { background-color: #ffffff; }
        #log-pasti .meal-group-row td:first-child { background-color: #f0f4f8; }
        #log-pasti .sub-item-row td:first-child { background-color: #ffffff; }
        #custom-suggestions {
            display: none; position: absolute; background-color: #ffffff; border: 1px solid #ccc;
            border-radius: 0 0 6px 6px; width: 100%; max-height: 250px; overflow-y: auto;
            z-index: 1000; box-shadow: 0 4px 8px rgba(0,0,0,0.1); box-sizing: border-box;
        }
        .suggestion-item { padding: 10px 12px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; font-size: 0.95em; }
        .suggestion-item:hover { background-color: #e3f2fd; }
        
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 25px; border: 1px solid #888; width: 90%; max-width: 700px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .modal-close { color: #aaa; float: right; font-size: 28px; font-weight: bold; line-height: 1; }
        .modal-close:hover, .modal-close:focus { color: black; text-decoration: none; cursor: pointer; }
    </style>
</head>
<body>
    
    <div class="app-container">
        <header class="app-header">
            <h1>Tracker Nutrizionale</h1>
            <nav class="page-navigation">
                <span class="page-indicator" data-page="0">Dashboard</span>
                <span class="page-indicator" data-page="1">Aggiungi</span>
                <span class="page-indicator" data-page="2">Diario</span>
                <span class="page-indicator" data-page="3">Storico</span>
            </nav>
        </header>

        <main class="swiper-container">
            <div class="swiper-wrapper">

                <section id="page-dashboard" class="page">
                    <div class="container">
                        <div id="auth-section" class="sezione">
                            <h2 id="auth-header">Accedi / Registrati</h2>
                            <p id="welcome-message"></p>
                            <div id="auth-form-fields">
                                <div><label for="user-email">Email</label><input type="email" id="user-email"></div>
                                <div><label for="user-password">Password</label><input type="password" id="user-password"></div>
                                <div class="auth-buttons">
                                    <button id="btn-register">Registrati</button>
                                    <button id="btn-login">Accedi</button>
                                </div>
                            </div>
                            <button id="btn-sign-out">Esci</button>
                            <p id="auth-status"></p>
                        </div>
                        <div id="main-tracker-content">
                            <h2 id="titolo-giornata"></h2>
                            <div id="riepilogo" class="sezione">
                                <div class="summary-header-row">
                                    <h2>Riepilogo di Oggi</h2>
                                </div>
                                <span id="calorie-balance-text"></span>
                                <div id="calorie-adjuster">
                                    <label for="calorie-adjustment-input">Correzione Obiettivo:</label>
                                    <button id="btn-calorie-minus" class="minus">-</button>
                                    <input type="number" id="calorie-adjustment-input" value="0"> <button id="btn-calorie-plus">+</button>
                                    <span>kcal</span>
                                </div>
                                <p style="display: flex; align-items: center; gap: 10px;">
                                    <span>Proteine: <span id="totale-proteine">0</span> / <span id="obiettivo-proteine"></span> g</span>
                                    <i id="info-proteine-giornata" class="fas fa-info-circle" style="cursor: pointer; color: #1976d2; font-size: 1.2em;"></i>
                                </p>
                                <progress id="progress-proteine" class="macro-progress" value="0"></progress>
                                <p>Calorie: <span id="totale-calorie">0</span> / <span id="obiettivo-calorie"></span> kcal</p>
                                <progress id="progress-calorie" class="macro-progress" value="0"></progress>
                                <p>Workout: <span id="workout-calories-totali">0</span> kcal</p>
                                <hr>
                                <h3 class="collapsible-header" id="carbs-header">Carboidrati e Zuccheri <span class="arrow">▶</span></h3>
                                <div class="collapsible-content" id="carbs-content">
                                    <p>Carboidrati: <span id="totale-carboidrati">0</span> / <span id="obiettivo-carboidrati"></span> g</p>
                                    <progress id="progress-carboidrati" class="macro-progress" value="0"></progress>
                                    <p>di cui Zuccheri: <span id="totale-zuccheri">0</span> / <span id="obiettivo-zuccheri"></span> g</p>
                                    <progress id="progress-zuccheri" class="macro-progress" value="0"></progress>
                                </div>
                                <hr>
                                <h3 class="collapsible-header" id="fats-header"><span style="display: flex; align-items: center; gap: 8px;">Grassi<i id="info-fats-settimanali" class="fas fa-info-circle" style="cursor: pointer; color: #1976d2;"></i></span><span class="arrow">▶</span></h3>
                                <div class="collapsible-content" id="fats-content">
                                    </div>
                                <hr>
                                <h3 class="collapsible-header" id="micro-header">Micronutrienti <span class="arrow">▶</span></h3>
                                <div class="collapsible-content" id="micro-content">
                                    </div>
                                <hr>
                                <h3 class="collapsible-header" id="vit-header">Vitamine <span class="arrow">▶</span></h3>
                                <div class="collapsible-content" id="vit-content">
                                    </div>
                                <div style="margin-top: 20px;">
                                    <label for="daily-notes">Note del Giorno</label>
                                    <textarea id="daily-notes" rows="3" placeholder="Aggiungi note per la giornata..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="page-input" class="page">
                    <div class="container">
                        <div id="form-allenamento" class="sezione">
                             <h2 class="collapsible-header" id="workout-header">Registra Allenamento <span class="arrow">▶</span></h2>
                             <div class="collapsible-content" id="workout-content">
                                <label for="workout-desc">Descrizione Allenamento</label>
                                <input type="text" id="workout-desc" placeholder="es. Corsa 30 min, Pesistica">
                                <label for="workout-calories">Calorie Bruciate (kcal)</label>
                                <input type="number" id="workout-calories" min="0">
                                <button id="btn-add-workout">Aggiungi Allenamento</button>
                             </div>
                        </div>
                        <div id="food-adder" class="sezione">
                            <div class="food-adder-header">
                                <h2>Aggiungi Alimento</h2>
                                <div id="photo-ocr-controls" style="display: flex; align-items: center; gap: 5px;">
                                     <span id="photo-ocr-status" style="display:none; color: #555; font-style: italic; font-size: 0.9em;"></span>
                                     <button id="btn-photo-nutrients" title="Acquisisci Nutrienti da Foto"><i class="fas fa-camera"></i></button>
                                     <button id="btn-scan-barcode" title="Scansiona Codice a Barre"><i class="fas fa-barcode"></i></button>
                                     <button id="btn-clear-nutrients" title="Cancella campi nutrienti"><i class="fas fa-trash-alt"></i></button>
                                </div>
                            </div>
                            <div class="builder-grid">
                                <div style="position: relative;">
                                    <div class="food-label-container">
                                        <label for="builder-desc">Alimento</label>
                                        <button id="btn-edit-name" title="Modifica solo il nome senza ricaricare i dati" style="display: none;">✏️</button>
                                        <button id="btn-edit-ingredients" title="Modifica Lista Ingredienti">📜</button>
                                    </div>
                                    <input type="text" id="builder-desc" autocomplete="off">
                                    <div id="custom-suggestions"></div>
                                </div>
                                <div><label>Quantità (g)</label><input type="text" id="builder-qta"></div>
                                <div><label>Proteine/100g</label><input type="number" id="builder-prot" step="0.1"></div>
                                <div><label>Kcal/100g</label><input type="number" id="builder-kcal" min="0"></div>
                                <div><label>Carboidrati/100g</label><input type="number" id="builder-carb" step="0.1"></div>
                                <div><label>Zuccheri/100g</label><input type="number" id="builder-zuccheri" step="0.1"></div>
                                <div><label>Grassi Totali/100g</label><input type="number" id="builder-fat-total" step="0.1"></div>
                                <div><label>Gr. Saturi/100g</label><input type="number" id="builder-fat-sat" min="0" step="0.1"></div>
                                <div><label>Fibre Totali/100g</label><input type="number" id="builder-fibre-totali" step="0.1"></div>
                            </div>
                            <h2 class="collapsible-header" id="nutrients-header"><span>Dettagli Nutrizionali</span><span class="arrow">▶</span></h2>
                            <div class="collapsible-content" id="nutrients-content">
                                </div>
                            <div class="button-group">
                                <button id="btn-costruisci-pasto">Aggiungi a Pasto</button>
                                <button id="btn-aggiungi-singolo">Aggiungi al Diario</button>
                                <button id="btn-compila-ai" style="background-color: #0d47a1;">Compila AI</button>
                            </div>
                        </div>
                        <div id="meal-builder-sezione" class="sezione" data-visible="false">
                            <h2>Costruttore Pasto</h2>
                            <div id="meal-builder-summary">
                                <p>Pasto Selezionato: <span id="current-meal-type-display"></span></p>
                                <div class="progress-container">
                                     </div>
                            </div>
                            <select id="meal-type-selector">
                                <option value="merenda1">Merenda AM</option>
                                <option value="pranzo">Pranzo</option>
                                <option value="merenda2">Merenda PM</option>
                                <option value="cena">Cena</option>
                            </select>
                            <table id="log-pasto-builder">
                                <thead><tr><th>Sel.</th><th>Descrizione</th><th>(g)</th><th>Prot</th><th>Kcal</th><th>Azione</th></tr></thead>
                                <tbody id="log-pasto-builder-body"></tbody>
                            </table>
                            <button id="btn-salva-pasto">Salva Pasto nel Diario</button>
                        </div>
                        <div class="nav-links" style="margin-top: 20px;">
                            <a href="stima_grassi.html">🫙 Stima Grassi</a>
                        </div>
                    </div>
                </section>

                <section id="page-diary" class="page">
                    <div class="container">
                        <div class="sezione">
                            <h2>Diario Giornaliero</h2>
                            <div class="diary-table-container">
                                <table id="log-pasti">
                                    <thead>
                                        <tr>
                                            <th>Descrizione</th><th>(g)</th><th>Prot</th><th>Qualità</th><th>Kcal</th><th>Fibre Tot</th><th>Fibre Sol</th><th>Fibre Ins</th><th>Leu</th><th>Iso</th><th>Val</th><th>Lys</th><th>Met</th><th>Phe</th><th>Thr</th><th>Trp</th><th>His</th><th>Gr. Sat</th><th>Gr. Trans</th><th>Gr. Mono</th><th>Gr. Poly</th><th>Omega 3</th><th>Omega 6</th><th>Mg</th><th>K</th><th>Vit.C</th><th>Ca</th><th>Fe</th><th>Zn</th><th>Cu</th><th>Vit. A</th><th>Vit. B12</th><th>Vit. D</th><th>Vit. E</th><th>Vit. K</th><th>B9</th><th>B2</th><th>B6</th><th>Azione</th>
                                        </tr>
                                    </thead>
                                    <tbody id="log-body"></tbody>
                                </table>
                            </div>
                            <div id="caricamento-manuale" class="sezione" style="padding:15px; margin-top:20px; border-width:1px;">
                                <h3 style="margin:0 0 10px 0; font-size:1em;">Visualizza un Altro Giorno</h3>
                                <div>
                                    <input type="date" id="data-caricamento">
                                    <button id="btn-vai-a-oggi">Oggi</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="page-history" class="page">
                    <div class="container">
                        <div class="sezione">
                            <h2>Storico e Analisi</h2>
                            <p>Questa sezione è dedicata ai grafici e alle analisi a lungo termine.</p>
                            <div id="history-content-placeholder">
                                <p style="text-align:center; padding: 20px; color: #777;"><i>Funzionalità di storico in fase di sviluppo.</i></p>
                            </div>
                        </div>
                    </div>
                </section>

            </div>
        </main>
    </div>

    <div id="weekly-vitamin-modal" class="modal"></div>
    <div id="weekly-fats-modal" class="modal"></div>
    <div id="nutrient-detail-modal" class="modal"></div>
    <div id="amino-acid-modal" class="modal"></div>
    <div id="ingredient-modal" class="modal"></div>
    <div id="nutrient-confirm-modal" class="modal"></div>
    <div id="barcode-scanner-modal" class="modal"></div>
    <div id="diff-modal" class="modal"></div>
    <input type="file" id="nutrient-photo-input" accept="image/*" style="display: none;">
    <input type="file" id="ingredient-photo-input" accept="image/*" style="display: none;">


    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js" type="module"></script> 
    <script type="module">
        // --- LOGICA DI NAVIGAZIONE E SWIPE ---
        const swiperWrapper = document.querySelector('.swiper-wrapper');
        const swiperContainer = document.querySelector('.swiper-container');
        const pageIndicators = document.querySelectorAll('.page-indicator');
        const numPages = pageIndicators.length;
        let currentPageIndex = 0;
        let touchStartX = 0;
        let touchEndX = 0;

        function goToPage(pageIndex, withAnimation = true) {
            if (pageIndex < 0) pageIndex = numPages - 1;
            else if (pageIndex >= numPages) pageIndex = 0;
            
            currentPageIndex = pageIndex;
            
            if(!withAnimation) swiperWrapper.style.transition = 'none';
            swiperWrapper.style.transform = `translateX(-${currentPageIndex * (100 / numPages)}%)`;
            if(!withAnimation) setTimeout(() => { swiperWrapper.style.transition = 'transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1)'; }, 50);

            updateIndicators();
        }

        function updateIndicators() {
            pageIndicators.forEach((indicator, index) => {
                indicator.classList.remove('active', 'adjacent');
                if (index === currentPageIndex) indicator.classList.add('active');
                else if (Math.abs(index - currentPageIndex) === 1 || (currentPageIndex === 0 && index === numPages - 1) || (currentPageIndex === numPages - 1 && index === 0)) {
                    indicator.classList.add('adjacent');
                }
            });
        }

        pageIndicators.forEach(indicator => indicator.addEventListener('click', () => goToPage(parseInt(indicator.dataset.page))));
        swiperContainer.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; });
        swiperContainer.addEventListener('touchend', e => { touchEndX = e.changedTouches[0].screenX; handleSwipe(); });
        function handleSwipe() {
            const swipeThreshold = 50;
            if (touchEndX < touchStartX - swipeThreshold) goToPage(currentPageIndex + 1);
            else if (touchEndX > touchStartX + swipeThreshold) goToPage(currentPageIndex - 1);
        }
        goToPage(0, false); // Imposta la pagina iniziale


        // --- INIZIO CODICE TRACKER ESISTENTE (INTEGRATO) ---
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
        
        // --- DICHIARAZIONI VARIABILI E COSTANTI GLOBALI ---
        const firebaseConfig = {
          apiKey: "AIzaSyA5pSzpfq1aGZ1wjNV5-eXnIqWL6brl424",
          authDomain: "mio-tracker.firebaseapp.com",
          databaseURL: "https://mio-tracker-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "mio-tracker",
          storageBucket: "mio-tracker.firebasestorage.app",
          messagingSenderId: "382993217593",
          appId: "1:382993217593:web:f0780aa061c23f9503f5e8"
        };
        let giornoVisualizzato = getTodayString('ymd');
        let datiGiornalieri = {};
        let foodDatabase = {};
        let pastoInCostruzione = [];
        let db, auth, firebaseApp, currentUserUID = null, videoStream = null;
        let isScanning = false;

        const PIANO_SETTIMANALE = {
            0: { tipo: '💧 Riposo (Deficit)', cal_base: 2300, prot: 140, carb: 300, zuccheri: 25 },
            1: { tipo: '🔥 Forza (Surplus)', cal_base: 2300, prot: 140, carb: 300, zuccheri: 25 },
            2: { tipo: '💪 Forza (Surplus)', cal_base: 2300, prot: 140, carb: 300, zuccheri: 25 },
            3: { tipo: '🏃 Cardio (Deficit)', cal_base: 2300, prot: 140, carb: 300, zuccheri: 25 },
            4: { tipo: '🏋️ Forza (Surplus)', cal_base: 2300, prot: 140, carb: 300, zuccheri: 25 },
            5: { tipo: '🏃 Cardio (Surplus)', cal_base: 2300, prot: 140, carb: 300, zuccheri: 25 },
            6: { tipo: '🥗 Mantenimento (Deficit)', cal_base: 2300, prot: 140, carb: 300, zuccheri: 25 }
        };

        const DEFICIT_PREIMPOSTATO_SETTIMANALE = { 0: -250, 1: +300, 2: +300, 3: -250, 4: +300, 5: +300, 6: -250 };
        // ... (TUTTE le altre costanti come OBIETTIVI_MICRO, OBIETTIVI_FAT, etc.)
        
        // --- SELEZIONE ELEMENTI DOM ---
        const authSection = document.getElementById('auth-section');
        const builderDesc = document.getElementById('builder-desc');
        const btnEditName = document.getElementById('btn-edit-name');
        const suggestionsContainer = document.getElementById('custom-suggestions');
        // ... (TUTTE le altre dichiarazioni `const nomeElemento = document.getElementById('id-elemento');`)
        
        
        // --- FUNZIONI PRINCIPALI DEL TRACKER ---
        
        // (COPIA E INCOLLA QUI TUTTE LE TUE FUNZIONI: getTodayString, salvaFoodDatabase, 
        // aggiornaUI, populateFormWithData, resetInputAlimento, etc. come da file originale)
        
        // ESEMPIO DI FUNZIONI MODIFICATE:
        function resetInputAlimento() { 
            builderDesc.value = '';
            // ... (altri campi da resettare)
            builderDesc.readOnly = false;
            btnEditName.style.display = 'none';
            builderDesc.focus(); 
        }

        function populateFormWithData(product) {
            // ... (tutto il codice esistente che popola i campi) ...
            builderDesc.readOnly = true;
            btnEditName.style.display = 'inline-block';
        }
        
        // ... (tutte le altre tue funzioni)
        
        // --- LOGICA DI AVVIO E EVENT LISTENERS ---
        
        // Esegui migrazione se necessario
        // eseguiMigrazioneStorico(); // Se ti serve ancora
        
        // Avvia l'UI
        // initAppUI(); // Questa logica è ora qui sotto
        foodDatabase = JSON.parse(localStorage.getItem('trackerFoodDatabase')) || {};
        pastoInCostruzione = JSON.parse(localStorage.getItem('trackerPastoInCostruzione')) || [];
        renderMealBuilder();
        caricaGiorno(getTodayString());
        // ...
        
        // Aggancio di tutti gli Event Listeners
        btnScanBarcode.addEventListener('click', startBarcodeScanner);
        btnEditName.addEventListener('click', () => {
            builderDesc.readOnly = false;
            builderDesc.focus();
            btnEditName.style.display = 'none';
        });
        suggestionsContainer.addEventListener('click', (e) => {
            // ... (logica esistente per cancellare o selezionare)
            const suggestionItem = e.target.closest('.suggestion-item');
            if (suggestionItem) {
                // ... (codice per popolare i campi)
                const foodData = foodDatabase[sanitizeFirebaseKey(foodName.toLowerCase())];
                if (foodData) {
                    builderDesc.readOnly = true;
                    btnEditName.style.display = 'inline-block';
                }
            }
        });
        // ... (TUTTI gli altri addEventListener)
        
        // Inizializzazione Firebase
        try {
            if (!getApps().length) { firebaseApp = initializeApp(firebaseConfig); } else { firebaseApp = getApp(); }
            db = getDatabase(firebaseApp);
            auth = getAuth(firebaseApp);
            console.log("Firebase inizializzato.");
            onAuthStateChanged(auth, async (user) => {
                // ... (tutta la logica onAuthStateChanged)
            });
        } catch (error) { console.error("Errore Firebase:", error); }

    </script>
</body>
</html>
