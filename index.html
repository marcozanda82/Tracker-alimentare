<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tracker Nutrizionale Definitivo v6</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0d47a1">
    <link rel="apple-touch-icon" href="icon-192.png">
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f7f9; color: #333; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 800px; background-color: #ffffff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1, h2, h3 { color: #0d47a1; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-top: 0; }
        h2 { font-size: 1.4em; margin-top: 30px; }
        h3 { font-size: 1.1em; color: #333; border-bottom: 1px solid #eee; margin-top: 20px; }
        h4 { font-size: 1em; color: #1565c0; margin-top: 20px; margin-bottom: 10px; font-weight: 600; }
        /* Lavagna coach ‚Äì header giornaliero con data e tabella di marcia */
        #titolo-giornata-panel { margin-bottom: 28px; padding: 24px 20px 28px; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; text-align: left; }
        #titolo-giornata-panel .lavagna-date { margin: 0 0 6px 0; font-size: 0.95em; font-weight: 400; color: #6b7280; letter-spacing: 0.02em; line-height: 1.4; }
        #titolo-giornata-panel .lavagna-title { margin: 0 0 16px 0; font-size: 1.15em; font-weight: 600; color: #374151; line-height: 1.35; }
        #titolo-giornata-panel .lavagna-list { list-style: none; padding: 0; margin: 0 0 12px 0; }
        #titolo-giornata-panel .lavagna-item { padding: 6px 0; font-size: 0.95em; line-height: 1.45; color: #374151; border-bottom: 1px solid rgba(0,0,0,0.06); }
        #titolo-giornata-panel .lavagna-item:last-child { border-bottom: none; }
        #titolo-giornata-panel .lavagna-item.completed { text-decoration: line-through; color: #9ca3af; opacity: 0.6; }
        #titolo-giornata-panel .lavagna-item.current { font-weight: 700; color: #1e293b; opacity: 1; }
        #titolo-giornata-panel .lavagna-item.future { color: #9ca3af; font-weight: 400; }
        #titolo-giornata-panel .lavagna-all-done { margin-top: 14px; padding-top: 12px; border-top: 1px solid rgba(0,0,0,0.06); font-size: 0.95em; font-weight: 600; color: #059669; }
        #titolo-giornata-panel .lavagna-no-strategy { margin-top: 8px; font-size: 0.95em; color: #6b7280; }
        #titolo-giornata-panel .lavagna-no-strategy .btn-strategia { margin-top: 12px; display: inline-block; padding: 8px 16px; font-size: 0.9em; background: #7b1fa2; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; }
        #titolo-giornata-panel .lavagna-no-strategy .btn-strategia:hover { background: #6a1b9a; }
        .meal-builder-time-wrap { position: relative; }
        .meal-builder-time-desktop { display: none; }
        .meal-builder-time-wrap .meal-builder-time-native { display: block; }
        @media (min-width: 768px) {
            .meal-builder-time-wrap .meal-builder-time-native { display: none; }
            .meal-builder-time-desktop { display: flex; align-items: center; gap: 4px; }
            .meal-builder-time-desktop select { min-width: 4em; padding: 6px 8px; border: 1px solid #ccc; border-radius: 6px; font-size: 1em; }
            .meal-builder-time-desktop .time-sep { font-weight: 600; color: #333; }
        }
        /* Lavagna sempre visibile su desktop e mobile (no collapse) */
        #titolo-giornata-panel { display: block !important; overflow: visible; min-height: 0; }
        #titolo-giornata-panel .lavagna-list { overflow: visible; max-height: none; }
        @media (min-width: 768px) {
            #titolo-giornata-panel { display: block !important; }
        }
        .sezione { margin-bottom: 25px; padding: 20px; background-color: #fafafa; border: 1px solid #e0e0e0; border-radius: 8px; border-left-width: 5px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        input[type="text"], input[type="number"], input[type="date"], select, input[type="email"], input[type="password"], textarea {
            width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 1em;
        }
        button { background-color: #1976d2; color: white; padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 1em; font-weight: 600; transition: background-color 0.3s; }
        button:hover { background-color: #1565c0; }
        #form-allenamento button { background-color: #2e7d32; }
        .nav-links { display: flex; gap: 10px; margin-bottom: 20px; }
        .nav-links a { flex-grow: 1; text-align: center; padding: 10px; background-color: #607d8b; color: white; text-decoration: none; border-radius: 6px; font-weight: 600; }
        .sync-button-container { text-align: center; margin-top: 20px; }
        .sync-button { display: inline-block; background-color: #ff8f00; color: white; padding: 10px 15px; text-decoration: none; border-radius: 6px; font-weight: 600; font-size: 0.9em; }
        #riepilogo p { font-size: 1.1em; margin: 8px 0; }
        progress { width: 100%; height: 15px; border-radius: 6px; margin-top: 2px; cursor: pointer; }
        progress.macro-progress { height: 25px; }
        table { border-collapse: collapse; margin-top: 15px; font-size: 0.9em; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; vertical-align: middle; }
        th { background-color: #f2f2f2; font-weight: 600; }
        .builder-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; }
        .button-group { display: flex; gap: 10px; margin-top: 15px; }
        #btn-costruisci-pasto { background-color: #ff8f00; }
        #btn-aggiungi-singolo { background-color: #5c6bc0; }
        #meal-builder-sezione[data-visible="false"] { display: none; }
        #meal-builder-sezione[data-visible="true"] { display: block; }
        #meal-builder-sezione { border-left-color: #ff8f00; }
        #btn-salva-pasto { background-color: #2e7d32; width: 100%; margin-top: 15px; }
        #caricamento-manuale { margin-top: 25px; padding-top: 20px; border-top: 1px solid #eee; border-left-color: #673ab7;}
        #caricamento-manuale div { display: flex; gap: 10px; align-items: center; }
        #caricamento-manuale input { flex-grow: 1; margin-bottom: 0; }
        #caricamento-manuale button { flex-grow: 0; width: auto; margin-bottom: 0; }
        .action-buttons { display: flex; justify-content: center; align-items: center; gap: 8px; }
        .action-buttons button { background: none; border: none; padding: 4px; font-size: 1.3em; line-height: 1; cursor: pointer; }
        .edit-btn { color: #1976d2; }
        .delete-btn { color: #d32f2f; }
        .meal-group-row { background-color: #f0f4f8; font-weight: bold; }
        .expand-arrow { cursor: pointer; display: inline-block; width: 20px; text-align: center; }
        .sub-item-row td { padding-left: 25px !important; background-color: #fff; font-style: italic; color: #555; border-bottom: 1px dotted #ccc; }
        .sub-item-row td:last-child { visibility: hidden; }
        .nutrients-warning { color: #d32f2f !important; }
        .param-state-optimal { color: #2e7d32 !important; }
        .param-state-attention { color: #f9a825 !important; }
        .param-state-out { color: #c62828 !important; }
        .control-mode-section { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; padding: 10px; background: #f5f5f5; border-radius: 8px; flex-wrap: wrap; }
        .control-mode-section label { margin: 0; font-weight: 600; }
        .control-mode-section select { width: auto; margin: 0; padding: 6px 10px; }
        .global-body-state { padding: 10px 14px; border-radius: 8px; font-weight: 700; text-align: center; margin-bottom: 12px; }
        .global-body-state.state-ok { background: #e8f5e9; color: #1b5e20; border: 1px solid #81c784; }
        .global-body-state.state-attention { background: #fff8e1; color: #e65100; border: 1px solid #ffb74d; }
        .global-body-state.state-critical { background: #ffebee; color: #b71c1c; border: 1px solid #e57373; }
        .global-body-state-compact { font-size: 0.9em; padding: 6px 10px; }
        .control-mode-section-secondary { margin-top: 8px; }
        .guida-giornata { margin-bottom: 16px; padding: 16px; border-radius: 10px; background: #f8f9fa; border: 1px solid #e9ecef; }
        .guida-giornata-title { margin: 0 0 10px 0; font-size: 1em; font-weight: 600; color: #495057; text-transform: uppercase; letter-spacing: 0.02em; }
        .guida-main-message { margin: 0 0 10px 0; font-size: 1.15em; font-weight: 700; line-height: 1.3; }
        .guida-main-message.guida-ok { color: #1b5e20; }
        .guida-main-message.guida-recuperabile { color: #e65100; }
        .guida-main-message.guida-correggere { color: #b71c1c; }
        .prossimo-obiettivo-panel { margin-bottom: 16px; padding: 18px 20px; border-radius: 12px; background: #f0f4ff; border: 1px solid #c5cae9; }
        .prossimo-obiettivo-panel .panel-title { margin: 0 0 12px 0; font-size: 1.1em; font-weight: 700; color: #3949ab; }
        .prossimo-obiettivo-panel .panel-goal { font-size: 1.2em; font-weight: 600; color: #1a237e; line-height: 1.4; margin: 0 0 8px 0; }
        .prossimo-obiettivo-panel .panel-goal.all-done { color: #2e7d32; }
        .prossimo-obiettivo-panel .panel-workout { margin-top: 12px; padding-top: 12px; border-top: 1px solid #c5cae9; font-size: 1em; color: #5c6bc0; }
        .strategia-feedback-modal .feedback-success { background: #e8f5e9; border: 1px solid #81c784; color: #1b5e20; }
        .strategia-feedback-modal .feedback-error { background: #ffebee; border: 1px solid #e57373; color: #b71c1c; }
        .guida-explanation { margin: 0 0 12px 0; font-size: 0.95em; color: #555; line-height: 1.45; }
        .guida-suggestions { margin: 0; padding-left: 20px; font-size: 0.9em; color: #333; line-height: 1.5; }
        .guida-suggestions li { margin-bottom: 4px; }
        .temporal-analysis-dashboard { margin-top: 12px; padding: 12px; background: #e3f2fd; border: 1px solid #90caf9; border-radius: 8px; font-size: 0.9em; }
        .temporal-grid { display: flex; flex-direction: column; gap: 6px; }
        .temporal-row { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
        .temporal-indicator { font-weight: 700; padding: 2px 8px; border-radius: 4px; }
        .temporal-indicator.temporal-in-linea { background: #e8f5e9; color: #1b5e20; }
        .temporal-indicator.temporal-in-ritardo { background: #ffebee; color: #b71c1c; }
        .temporal-indicator.temporal-in-anticipo { background: #e8eaf6; color: #283593; }
        .temporal-msg { color: #b71c1c; }
        .indicators-dashboard { margin-top: 12px; padding: 12px; background: #fafafa; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 0.9em; }
        .indicators-dashboard table { width: 100%; margin: 0; }
        .indicators-dashboard td, .indicators-dashboard th { padding: 6px 8px; border: none; text-align: left; }
        .indicators-dashboard th { background: transparent; font-weight: 600; }
        .indicator-dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 6px; }
        .indicator-dot.optimal { background: #4caf50; }
        .indicator-dot.attention { background: #ff9800; }
        .indicator-dot.out { background: #f44336; }
        progress.progress-state-optimal::-webkit-progress-value { background: #4caf50; }
        progress.progress-state-optimal::-moz-progress-bar { background: #4caf50; }
        progress.progress-state-attention::-webkit-progress-value { background: #ff9800; }
        progress.progress-state-attention::-moz-progress-bar { background: #ff9800; }
        progress.progress-state-out::-webkit-progress-value { background: #f44336; }
        progress.progress-state-out::-moz-progress-bar { background: #f44336; }
        .macro-row-alert { padding: 8px 12px; margin: 6px 0; border-radius: 8px; border-left: 4px solid transparent; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .macro-row-alert.alert-ok { border-left-color: #4caf50; background: rgba(76, 175, 80, 0.08); }
        .macro-row-alert.alert-attention { border-left-color: #ff9800; background: rgba(255, 152, 0, 0.08); }
        .macro-row-alert.alert-out { border-left-color: #f44336; background: rgba(244, 67, 54, 0.08); }
        .macro-row-alert .alert-icon { font-size: 1.2em; width: 24px; text-align: center; }
        .macro-row-alert.alert-ok .alert-icon { color: #4caf50; }
        .macro-row-alert.alert-attention .alert-icon { color: #ff9800; }
        .macro-row-alert.alert-out .alert-icon { color: #f44336; }
        .macro-row-alert .alert-content { flex: 1; min-width: 0; }
        #meal-builder-summary { margin-bottom: 20px; padding: 15px; background-color: #e3f2fd; border: 1px solid #90caf9; border-radius: 8px; }
        #meal-builder-summary p { margin: 5px 0; font-weight: 600; color: #1e88e5; }
        #meal-builder-summary .progress-container { display: flex; gap: 20px; margin-top: 10px; }
        #meal-builder-summary .progress-item { flex: 1; }
        #meal-builder-summary .progress-item p { font-size: 0.9em; margin-bottom: 5px; color: #3f51b5; }
        #meal-builder-summary .progress-item progress { height: 18px; border-radius: 4px; }
        #calorie-balance-text { display: block; text-align: center; font-weight: bold; font-size: 1.2em; margin-top: 15px; margin-bottom: 10px; padding: 8px 0; border-radius: 5px; }
        .balance-deficit { background-color: #ffebee; color: #d32f2f; }
        .balance-surplus { background-color: #e8f5e9; color: #2e7d32; }
        .balance-even { background-color: #e3f2fd; color: #1976d2; }
        .collapsible-header { cursor: pointer; padding: 10px 0; border-bottom: 1px solid #e0e0e0; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; color: #0d47a1; font-size: 1.4em; }
        .collapsible-header:hover { color: #1976d2; }
        .collapsible-header .arrow { font-size: 0.8em; transition: transform 0.3s ease; }
        .collapsible-content { display: none; overflow: hidden; transition: max-height 0.3s ease-out; max-height: 0; }
        .collapsible-content.expanded { display: block; max-height: 2000px; }
        .collapsible-header.expanded .arrow { transform: rotate(90deg); }
        #calorie-adjuster { display: flex; align-items: center; justify-content: center; margin-top: 10px; margin-bottom: 20px; gap: 10px; }
        #calorie-adjuster button { padding: 5px 12px; font-size: 1.2em; border-radius: 5px; background-color: #4CAF50; color: white; border: none; cursor: pointer; }
        #calorie-adjuster button.minus { background-color: #f44336; }
        #calorie-adjuster input[type="number"] { width: 80px; text-align: center; font-size: 1.1em; padding: 8px; border: 1px solid #ccc; border-radius: 5px; }
        #calorie-adjuster label { margin-bottom: 0; font-weight: normal; color: #333; }
        .cloud-sync-section { display: flex; gap: 10px; margin-top: 20px; padding: 15px; background-color: #e0f2f7; border: 1px solid #b2ebf2; border-radius: 8px; flex-wrap: wrap; }
        .cloud-sync-section button { flex: 1 1 auto; min-width: 150px; margin-bottom: 5px; }
        .cloud-sync-section #btn-download-manual { background-color: #e64a19; }
        .cloud-sync-status { width: 100%; text-align: center; font-size: 0.9em; color: #555; margin-top: 10px; }
        .cloud-sync-status.connected { color: #2e7d32; font-weight: bold; }
        .cloud-sync-status.disconnected { color: #c62828; font-weight: bold; }
        /* PROFILO UTENTE */
        #user-profile-section { border-left-color: #009688; }
        #user-profile-section h2 { margin-top: 0; }
        .profile-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px 20px; }
        .profile-grid .field-group { display: flex; flex-direction: column; }
        .profile-grid .field-group label { margin-bottom: 4px; }
        .profile-days { display: flex; flex-wrap: wrap; gap: 6px; }
        .profile-days label { font-weight: normal; font-size: 0.9em; background:#f5f5f5; padding:4px 8px; border-radius:12px; border:1px solid #ddd; cursor:pointer; }
        .profile-days input[type="checkbox"] { margin-right: 4px; }
        .profile-mealtimes { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-top: 10px; }
        .profile-summary { margin-top: 15px; padding: 10px; background:#e3f2fd; border-radius:8px; border:1px solid #90caf9; font-size:0.9em; }
        .profile-summary p { margin: 4px 0; }
        .profile-actions { margin-top: 12px; display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap; }
        .profile-actions button { flex:0 0 auto; }
        #auth-section { margin-bottom: 25px; padding: 20px; background-color: #fafafa; border: 1px solid #e0e0e0; border-radius: 8px; border-left-width: 5px; border-left-color: #673ab7; }
        #auth-section h2 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        #auth-section .auth-buttons { display: flex; gap: 10px; }
        #auth-section .auth-buttons button { width: 50%; background-color: #1976d2; }
        #auth-section #btn-sign-out { background-color: #607d8b; display: none; margin-top: 15px; }
        #auth-status { text-align: center; font-weight: 600; margin-top: 15px; }
        #welcome-message { text-align: center; font-weight: bold; font-size: 1.2em; color: #0d47a1; margin-bottom: 10px; display: none; }
        #main-tracker-content { display: none; }
        #main-tracker-content.authenticated { display: block; }
        .app-mode-toggle { display: flex; margin-bottom: 12px; border-radius: 8px; overflow: hidden; border: 1px solid #ccc; background: #f5f5f5; }
        .app-mode-toggle .mode-btn { flex: 1; padding: 10px 16px; border: none; background: transparent; font-weight: 600; font-size: 0.95em; cursor: pointer; color: #666; transition: background 0.2s, color 0.2s; }
        .app-mode-toggle .mode-btn.active { background: #1976d2; color: white; }
        .app-mode-toggle .mode-btn:not(.active):hover { background: #e0e0e0; }
        #toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); background: #323232; color: #fff; padding: 12px 24px; border-radius: 8px; font-size: 0.9em; z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: none; }
        #toast.show { display: block; animation: toastIn 0.2s ease; }
        @keyframes toastIn { from { opacity: 0; transform: translateX(-50%) translateY(10px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
        #auth-section.logged-in { padding: 10px 20px; background-color: #e3f2fd; border: 1px solid #90caf9; box-shadow: none; text-align: center; display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 10px; }
        #auth-section.logged-in #auth-header, #auth-section.logged-in #auth-form-fields, #auth-section.logged-in #auth-status { display: none !important; }
        #auth-section.logged-in #welcome-message { margin: 0; font-size: 1em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #auth-section.logged-in #btn-sign-out { width: auto; padding: 5px 10px; font-size: 0.8em; margin: 0; flex-shrink: 0; }
        .summary-header-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-bottom: 25px; }
        #manual-fill-section { margin-top: 15px; padding-top: 15px; border-top: 1px solid #ccc; }
        #manual-fill-section textarea { width: 100%; height: 100px; margin-top: 10px; resize: vertical; }
        #manual-fill-section .button-group { justify-content: space-between; }
        .fats-bar-container { margin-top: 15px; }
        .fats-group { padding-left: 15px; border-left: 3px solid #eee; margin-top: 15px; }
        .fats-sub-bars-container { display: flex; gap: 20px; margin-top: 10px; }
        .fats-sub-bars-container > div { flex-grow: 1; flex-basis: 0; }
        .progress-fat-sat.green::-webkit-progress-value { background-color: #4CAF50; }
        .progress-fat-sat.green::-moz-progress-bar { background-color: #4CAF50; }
        .progress-fat-sat.orange::-webkit-progress-value { background-color: #ff9800; }
        .progress-fat-sat.orange::-moz-progress-bar { background-color: #ff9800; }
        .progress-fat-sat.red::-webkit-progress-value { background-color: #f44336; }
        .progress-fat-sat.red::-moz-progress-bar { background-color: #f44336; }
        .food-adder-header { display: flex; justify-content: space-between; align-items: center; }
        .food-adder-header button { background: none; border: none; font-size: 1.5em; cursor: pointer; color: #555; padding: 5px 10px; }
        .food-adder-header button:hover { color: #0d47a1; }
        #btn-clear-nutrients { color: #d32f2f; }
        #btn-clear-nutrients:hover { color: #ff1744; }
        .vitamin-group { padding: 10px; margin-top: 10px; background-color: #f9f9f9; border: 1px solid #eee; border-radius: 6px; }
        #vit-content { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .diary-table-container { 
            overflow-x: auto; 
            -webkit-box-shadow: inset -8px 0px 8px -8px rgba(0,0,0,0.1);
            box-shadow: inset -8px 0px 8px -8px rgba(0,0,0,0.1);
        }
        #log-pasti th, #log-pasti td {
            min-width: 60px;
            text-align: right;
            padding: 8px 10px;
            white-space: nowrap;
        }
        #log-pasti th:nth-child(1), #log-pasti td:nth-child(1) {
            min-width: 150px;
            text-align: left;
            position: -webkit-sticky;
            position: sticky;
            left: 0;
            z-index: 2;
            border-right: 2px solid #e0e0e0;
        }
        #log-pasti th:nth-child(2), #log-pasti td:nth-child(2) {
            min-width: 50px;
            text-align: left;
        }
        #log-pasti th:last-child, #log-pasti td:last-child {
            min-width: 80px;
            text-align: center;
        }
        #log-pasti th:first-child { background-color: #f8f9fa; }
        #log-pasti td:first-child { background-color: #ffffff; }
        #log-pasti .meal-group-row td:first-child { background-color: #f0f4f8; }
        #log-pasti .sub-item-row td:first-child { background-color: #ffffff; }
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto; 
            background-color: rgba(0,0,0,0.6); 
            -webkit-animation-name: fadeIn;
            -webkit-animation-duration: 0.4s;
            animation-name: fadeIn;
            animation-duration: 0.4s;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 25px;
            border: 1px solid #888;
            width: 90%;
            max-width: 700px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            -webkit-animation-name: slideIn;
            -webkit-animation-duration: 0.4s;
            animation-name: slideIn;
            animation-duration: 0.4s;
        }
        .modal-close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            line-height: 1;
        }
        .modal-close:hover,
        .modal-close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .macro-row-alert { cursor: default; }
        .macro-row-alert .alert-icon { cursor: pointer; }
        .macro-row-alert .nutrient-info-icon { cursor: pointer; color: #1976d2; }
        .nutrient-explanation-content { max-width: 520px; }
        .nutrient-explanation-title { margin: 0 0 16px 0; font-size: 1.25em; color: #1a237e; border-bottom: 1px solid #e8eaf6; padding-bottom: 8px; }
        .nutrient-explanation-body p { margin: 0 0 14px 0; line-height: 1.5; font-size: 0.95em; }
        .nutrient-explanation-coach { background: #e8f5e9; border-left: 4px solid #4caf50; padding: 12px; border-radius: 0 8px 8px 0; margin: 0 0 14px 0; line-height: 1.5; font-size: 0.95em; color: #1b5e20; }
        .nutrient-explanation-reason { font-weight: 600; color: #333; }
        .nutrient-explanation-context { color: #555; }
        .nutrient-explanation-missing { color: #1565c0; font-weight: 500; }
        .nutrient-explanation-recovery { background: #f5f5f5; padding: 12px; border-radius: 8px; border-left: 4px solid #4caf50; color: #333; }
        .modal-content video {
            background-color: #000;
        }
        .vitamin-weekly-summary {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        .vitamin-weekly-summary:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        .vitamin-weekly-summary h4 {
            margin-top: 0;
            margin-bottom: 8px;
            color: #1565c0;
            border: none;
        }
        .vitamin-weekly-summary p {
            margin: 4px 0;
            font-size: 0.95em;
        }
        .vitamin-weekly-summary i {
            color: #555;
            font-size: 0.9em;
        }
        .vitamin-weekly-summary progress {
            width: 100%;
            height: 20px;
        }
        .diff-value { font-weight: bold; }
        .diff-surplus { color: #2e7d32; }
        .diff-deficit { color: #d32f2f; }
        @-webkit-keyframes slideIn { from {top: -300px; opacity: 0} to {top: 0; opacity: 1} }
        @keyframes slideIn { from {margin-top: 5%; opacity: 0} to {margin-top: 10%; opacity: 1} }
        @-webkit-keyframes fadeIn { from {opacity: 0} to {opacity: 1} }
        @keyframes fadeIn { from {opacity: 0} to {opacity: 1} }
        #nutrient-detail-modal-list li {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #nutrient-detail-modal-list li:last-child {
            border-bottom: none;
        }
        #nutrient-detail-modal-list li span {
            font-weight: 600;
        }
        .protein-score {
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 4px;
            color: white;
            font-size: 0.85em;
            text-align: center;
        }
        .protein-score.low { background-color: #d32f2f; }
        .protein-score.medium { background-color: #ff8f00; }
        .protein-score.high { background-color: #2e7d32; }

        .food-label-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        .food-label-container label {
            margin-bottom: 0;
            flex-shrink: 0;
        }
        #btn-edit-ingredients, #btn-edit-name {
            background: none;
            border: none;
            font-size: 1.1em;
            color: #607d8b;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        #btn-edit-ingredients:hover, #btn-edit-name:hover {
            color: #1976d2;
        }
        .ingredient-icon {
            cursor: pointer;
            color: #607d8b;
            margin-right: 8px;
            font-size: 1.1em;
        }
        .ingredient-icon:hover {
            color: #1976d2;
        }
        #ingredient-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        #ingredient-modal-title {
            margin: 0;
            font-size: 1.5em;
            color: #0d47a1;
        }
        #ingredient-modal-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        #ingredient-modal-actions button {
            background: none;
            border: none;
            font-size: 1.6em;
            cursor: pointer;
            padding: 5px;
            color: #555;
        }
        #ingredient-modal-actions button:hover {
            color: #0d47a1;
        }
        #btn-clear-ingredients:hover {
            color: #d32f2f;
        }
        #ingredient-modal-textarea {
            width: 100%;
            height: 200px;
            resize: vertical;
            font-family: monospace;
            font-size: 1em;
        }
        
        #nutrient-confirm-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            max-height: 40vh;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #eee;
            min-height: 50px;
        }
        .nutrient-confirm-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .nutrient-confirm-item label {
            flex-basis: 60%;
            margin-bottom: 0;
            font-size: 0.9em;
        }
        .nutrient-confirm-item input {
            flex-grow: 1;
            margin-bottom: 0;
            padding: 8px;
            font-size: 0.9em;
        }
        .nutrient-confirm-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        #custom-suggestions {
            display: none;
            position: absolute;
            background-color: #ffffff;
            border: 1px solid #ccc;
            border-radius: 0 0 6px 6px;
            width: 100%;
            max-height: 250px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            box-sizing: border-box;
        }
        .suggestion-item {
            padding: 10px 12px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
            font-size: 0.95em;
        }
        .suggestion-item:last-child {
            border-bottom: none;
        }
        .suggestion-item:hover {
            background-color: #e3f2fd;
        }
        .suggestion-delete-btn {
            color: #d32f2f;
            background: none;
            border: none;
            font-size: 1.3em;
            cursor: pointer;
            padding: 2px 8px;
            line-height: 1;
        }
        .suggestion-delete-btn:hover {
            background-color: #ffebee;
            border-radius: 50%;
        }
        #btn-clear-dettagli {
            background: none;
            border: none;
            color: #d32f2f;
            font-size: 1em;
            cursor: pointer;
            padding: 0 10px;
            opacity: 0.7;
        }
        #btn-clear-dettagli:hover {
            opacity: 1;
        }
        .diff-item { 
            padding: 12px 8px; 
            border-bottom: 1px solid #f0f0f0; 
            display: grid; 
            grid-template-columns: 150px 1fr; 
            gap: 15px; 
            align-items: center; 
            font-size: 0.9em;
        }
        .diff-item:last-child { border-bottom: none; }
        .diff-item-label { font-weight: bold; }
        .diff-item-choices { display: flex; flex-direction: column; gap: 8px; }
        .diff-item-choices label { font-weight: normal; display: flex; align-items: center; gap: 8px; margin: 0; cursor: pointer;}
        .diff-item-choices input[type="radio"] { margin: 0; }
        .diff-item-choices .current-value { color: #1976d2; }
        .diff-item-choices .new-value { color: #2e7d32; }
        
        /* BILANCIA IDRICA STYLES */
        .balance-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            position: relative;
            background: #eee;
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            border: 1px solid #ccc;
        }
        .balance-bar-left {
            height: 100%;
            background: linear-gradient(to right, #ff5252, #ffcc80);
            width: 50%;
            transition: width 0.5s ease;
        }
        .balance-bar-right {
            height: 100%;
            background: linear-gradient(to right, #a5d6a7, #4caf50);
            width: 50%;
            transition: width 0.5s ease;
        }
        .balance-marker {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 4px;
            background-color: #333;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2;
            transition: left 0.5s ease;
        }
        .balance-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            margin-top: 5px;
            color: #555;
        }
        .balance-value { font-weight: bold; }
        
        /* STILE PER CAMPO SALE PRINCIPALE */
        #builder-sale {
            border-color: #1976d2;
            background-color: #f3f8ff;
        }
        #builder-sale:focus {
            background-color: #fff;
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Tracker Nutrizionale Definitivo v6</h1>
        
        <div id="auth-section" class="sezione">
            <h2 id="auth-header">Accedi / Registrati</h2>
            <p id="welcome-message"></p>
            <div id="auth-form-fields">
                <div><label for="user-email">Email</label><input type="email" id="user-email"></div>
                <div><label for="user-password">Password</label><input type="password" id="user-password"></div>
                <div class="auth-buttons">
                    <button id="btn-register">Registrati</button>
                    <button id="btn-login">Accedi</button>
                </div>
            </div>
            <button id="btn-sign-out">Esci</button>
            <p id="auth-status"></p>
        </div>
        <div id="user-profile-section" class="sezione" style="display:none;">
            <h2>Profilo Utente</h2>
            <div class="profile-grid">
                <div class="field-group">
                    <label for="profile-sex">Sesso</label>
                    <select id="profile-sex">
                        <option value="">Seleziona...</option>
                        <option value="male">Maschio</option>
                        <option value="female">Femmina</option>
                        <option value="other">Altro / Preferisco non dirlo</option>
                    </select>
                </div>
                <div class="field-group">
                    <label for="profile-age">Et√†</label>
                    <input type="number" id="profile-age" min="10" max="90" step="1">
                </div>
                <div class="field-group">
                    <label for="profile-height">Altezza (cm)</label>
                    <input type="number" id="profile-height" min="120" max="230" step="1">
                </div>
                <div class="field-group">
                    <label for="profile-weight">Peso (kg)</label>
                    <input type="number" id="profile-weight" min="40" max="200" step="0.1">
                </div>
                <div class="field-group">
                    <label for="profile-goal">Obiettivo</label>
                    <select id="profile-goal">
                        <option value="">Seleziona...</option>
                        <option value="cut">Cut / Definizione</option>
                        <option value="massa">Massa</option>
                        <option value="mantenimento">Mantenimento</option>
                    </select>
                </div>
                <div class="field-group">
                    <label for="profile-activity">Livello Attivit√†</label>
                    <select id="profile-activity">
                        <option value="">Seleziona...</option>
                        <option value="sedentary">Sedentario</option>
                        <option value="light">Leggero (1-3 allenamenti/sett.)</option>
                        <option value="moderate">Moderato (3-5 allenamenti/sett.)</option>
                        <option value="high">Intenso (6-7 allenamenti/sett.)</option>
                        <option value="athlete">Atleta</option>
                    </select>
                </div>
            </div>
            <h3 style="margin-top:20px;">Giorni di Allenamento</h3>
            <div class="profile-days">
                <label><input type="checkbox" name="profile-training-day" value="1">Lun</label>
                <label><input type="checkbox" name="profile-training-day" value="2">Mar</label>
                <label><input type="checkbox" name="profile-training-day" value="3">Mer</label>
                <label><input type="checkbox" name="profile-training-day" value="4">Gio</label>
                <label><input type="checkbox" name="profile-training-day" value="5">Ven</label>
                <label><input type="checkbox" name="profile-training-day" value="6">Sab</label>
                <label><input type="checkbox" name="profile-training-day" value="0">Dom</label>
            </div>
            <h3 style="margin-top:20px;">Orari Pasti</h3>
            <div class="profile-mealtimes">
                <div class="field-group">
                    <label for="profile-mealtime-merenda1">Merenda AM</label>
                    <input type="time" id="profile-mealtime-merenda1">
                </div>
                <div class="field-group">
                    <label for="profile-mealtime-pranzo">Pranzo</label>
                    <input type="time" id="profile-mealtime-pranzo">
                </div>
                <div class="field-group">
                    <label for="profile-mealtime-merenda2">Merenda PM</label>
                    <input type="time" id="profile-mealtime-merenda2">
                </div>
                <div class="field-group">
                    <label for="profile-mealtime-cena">Cena</label>
                    <input type="time" id="profile-mealtime-cena">
                </div>
            </div>
            <h3 style="margin-top:20px;">Obiettivi nutrizionali</h3>
            <div class="profile-grid" style="margin-bottom:12px;">
                <div class="field-group" style="grid-column:1/-1;">
                    <label style="display:flex;align-items:center;gap:10px;cursor:pointer;">
                        <input type="radio" name="profile-targets-mode" value="auto" id="profile-targets-auto" checked>
                        Usa calcolo automatico
                    </label>
                    <label style="display:flex;align-items:center;gap:10px;cursor:pointer;margin-top:6px;">
                        <input type="radio" name="profile-targets-mode" value="manual" id="profile-targets-manual">
                        Usa target manuali
                    </label>
                </div>
                <div id="profile-manual-targets-wrap" class="profile-grid" style="display:none;">
                    <div class="field-group"><label for="profile-manual-kcal">Calorie (kcal)</label><input type="number" id="profile-manual-kcal" min="1000" max="5000" step="50"></div>
                    <div class="field-group"><label for="profile-manual-prot">Proteine (g)</label><input type="number" id="profile-manual-prot" min="50" max="300" step="5"></div>
                    <div class="field-group"><label for="profile-manual-carb">Carboidrati (g)</label><input type="number" id="profile-manual-carb" min="50" max="600" step="5"></div>
                    <div class="field-group"><label for="profile-manual-fat">Grassi (g)</label><input type="number" id="profile-manual-fat" min="20" max="200" step="5"></div>
                </div>
            </div>
            <div class="profile-summary">
                <p><strong>Fabbisogno calorico stimato:</strong> <span id="profile-target-kcal">-</span> kcal <span id="profile-target-source" style="font-weight:normal;color:#666;"></span></p>
                <p><strong>Proteine target:</strong> <span id="profile-target-prot">-</span> g</p>
                <p><strong>Carboidrati target:</strong> <span id="profile-target-carb">-</span> g</p>
                <p><strong>Grassi target:</strong> <span id="profile-target-fat">-</span> g</p>
            </div>
            <div class="profile-actions">
                <button id="btn-reset-profile" type="button" style="background-color:#607d8b;">Reimposta</button>
                <button id="btn-save-profile" type="button" style="background-color:#009688;">Salva Profilo</button>
            </div>
        </div>
        <div id="main-tracker-content">
            <div class="app-mode-toggle" role="group" aria-label="Modalit√† app">
                <button type="button" id="mode-tracker" class="mode-btn" data-mode="tracker">Tracker</button>
                <button type="button" id="mode-coach" class="mode-btn" data-mode="coach">Coach</button>
            </div>
            <div id="titolo-giornata-panel">
                <p id="lavagna-date" class="lavagna-date"></p>
                <p id="lavagna-title" class="lavagna-title">üìã Tabella di marcia oggi</p>
                <div id="lavagna-no-strategy" class="lavagna-no-strategy" style="display: none;">
                    Nessuna strategia caricata per oggi.
                    <button type="button" class="btn-strategia" id="btn-apri-strategia">Apri strategia</button>
                </div>
                <ul id="lavagna-list" class="lavagna-list" style="display: none;"></ul>
                <p id="lavagna-all-done" class="lavagna-all-done" style="display: none;">‚úî Giornata completata</p>
            </div>
<div class="nav-links">
    <a href="storico.html">üìä Storico</a>
    <button type="button" id="btn-edit-profile" style="flex-grow: 1; text-align: center; padding: 10px; background-color: #009688; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 1em;">Modifica profilo</button>
    <button id="btn-export-json-ai" style="flex-grow: 1; text-align: center; padding: 10px; background-color: #673ab7; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 1em;">
        üß† Dati Completi AI
    </button>
</div>

                <div id="strategia-giornata-sezione" class="sezione strategia-giornata" style="border-left-color: #7b1fa2; margin-top: 12px;">
                    <h3 class="collapsible-header" id="strategia-header" style="margin: 0 0 0 0; font-size: 1.1em;">
                        <span>üìã Strategia del giorno</span>
                        <span class="arrow">‚ñ∂</span>
                    </h3>
                    <div class="collapsible-content" id="strategia-content">
                    <p style="font-size: 0.85em; color: #666; margin: 0 0 12px 0;">Obiettivi concordati per questa data. La dashboard confronta la giornata reale con la strategia (verde / arancio / rosso).</p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div><label for="strategia-kcal">Kcal target</label><input type="number" id="strategia-kcal" min="800" max="6000" step="50" placeholder="es. 2200"></div>
                        <div><label for="strategia-prot">Proteine target (g)</label><input type="number" id="strategia-prot" min="50" max="400" step="5" placeholder="es. 140"></div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 8px;">
                        <div><label for="strategia-tipo">Tipo giornata</label><select id="strategia-tipo"><option value="">‚Äî</option><option value="rest">Rest</option><option value="workout">Workout</option></select></div>
                        <div><label for="strategia-focus">Focus</label><select id="strategia-focus"><option value="">‚Äî</option><option value="ricomposizione">Ricomposizione</option><option value="deficit">Deficit</option><option value="massa">Massa</option></select></div>
                    </div>
                    <div style="margin-top: 8px;"><label for="strategia-note">Note libere</label><textarea id="strategia-note" rows="2" placeholder="Note sulla strategia..."></textarea></div>
                    <div style="margin-top: 8px;"><label for="strategia-timing">Timing indicativo pasti (testo)</label><textarea id="strategia-timing" rows="2" placeholder="es. Colazione 8:00, Pranzo 13:00, Cena 20:00"></textarea></div>
                    <div style="margin-top: 10px;"><label for="strategia-json-paste">Incolla JSON strategia (include <code>meals_timing</code>)</label><textarea id="strategia-json-paste" rows="6" placeholder='{"kcalTarget":2200,"protTarget":140,"meals_timing":{"breakfast":{"time":"09:30","type":"light"},"lunch":{"time":"13:30","type":"high_protein"},"snack":{"time":"17:00","type":"pre_workout"},"dinner":{"time":"20:30","type":"protein_focus"}}}' style="font-size: 0.85em; font-family: monospace;"></textarea><button type="button" id="btn-applica-json-strategia" style="background-color: #5e35b1; margin-top: 6px;">Applica JSON</button></div>
                    <div id="strategia-timing-adherence" style="display: none; margin-top: 12px; padding: 10px; background: #f3e5f5; border-radius: 8px; border-left: 4px solid #7b1fa2; font-size: 0.9em;"></div>
                    <div style="margin-top: 12px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
                        <button type="button" id="btn-genera-prompt-chatgpt" style="background-color: #10a37f;">üß† Genera prompt per ChatGPT</button>
                        <button type="button" id="btn-salva-strategia" style="background-color: #7b1fa2;">Salva strategia</button>
                        <span id="strategia-badge" style="display: none; font-size: 0.85em; color: #7b1fa2; font-weight: 600;">Strategia attiva</span>
                        <button type="button" id="btn-modifica-strategia" style="display: none; background-color: #5e35b1; font-size: 0.9em;">‚úèÔ∏è Modifica strategia</button>
                        <button type="button" id="btn-rimuovi-strategia" style="display: none; background-color: #c62828; font-size: 0.9em;">üóëÔ∏è Rimuovi strategia</button>
                    </div>
                    </div>
                </div>
                
                <span id="calorie-balance-text"></span>

                <div id="guida-giornata" class="guida-giornata" data-coach-only>
                    <div id="prossimo-obiettivo-wrap" style="display: none;">
                        <h3 class="panel-title">üéØ Prossimo obiettivo</h3>
                        <p id="prossimo-obiettivo-text" class="panel-goal">‚Äî</p>
                        <p id="prossimo-obiettivo-workout" class="panel-workout" style="display: none;"></p>
                    </div>
                    <div id="guida-classic-wrap">
                        <h3 class="guida-giornata-title">Guida della giornata</h3>
                        <p id="guida-main-message" class="guida-main-message">‚Äî</p>
                        <p id="guida-explanation" class="guida-explanation"></p>
                        <ul id="guida-suggestions" class="guida-suggestions"></ul>
                    </div>
                </div>

                <div id="control-mode-section-wrapper" class="control-mode-section control-mode-section-secondary" data-coach-only>
                    <label for="control-mode-select">Modalit√† controllo:</label>
                    <select id="control-mode-select">
                        <option value="easy">Base</option>
                        <option value="medium" selected>Avanzato</option>
                        <option value="hard">Atleta</option>
                    </select>
                    <span id="global-body-state" class="global-body-state global-body-state-compact state-ok">Stato corpo: ‚Äî</span>
                </div>
                <div id="temporal-analysis-dashboard" class="temporal-analysis-dashboard" style="display:none;" data-coach-only>
                    <h4 style="margin-top:0;">Analisi temporale (fino a quest'ora)</h4>
                    <div class="temporal-grid">
                        <div class="temporal-row">
                            <span>Proteine:</span>
                            <span id="temporal-prot-value">0</span> / <span id="temporal-prot-ideal">0 g</span>
                            <span id="temporal-prot-label" class="temporal-indicator temporal-in-linea">‚Äî</span>
                        </div>
                        <div class="temporal-row">
                            <span>Calorie:</span>
                            <span id="temporal-kcal-value">0</span> / <span id="temporal-kcal-ideal">0 kcal</span>
                            <span id="temporal-kcal-label" class="temporal-indicator temporal-in-linea">‚Äî</span>
                        </div>
                    </div>
                    <p id="temporal-analysis-msg" class="temporal-msg" style="display:none; margin:8px 0 0 0; font-weight:600;"></p>
                    <p id="temporal-analysis-hint" class="temporal-hint" style="display:none; margin:8px 0 0 0; font-size:0.85em; color:#555;"></p>
                </div>
                <div id="indicators-dashboard" class="indicators-dashboard" style="display:none;" data-coach-only>
                    <h4 style="margin-top:0;">Indicatori e range</h4>
                    <table>
                        <thead><tr><th>Parametro</th><th>Valore</th><th>Range (min ‚Äì ottimale ‚Äì max)</th><th>Stato</th></tr></thead>
                        <tbody>
                            <tr><td>Proteine</td><td id="ind-prot-value">‚Äî</td><td id="ind-prot-range">‚Äî</td><td id="ind-prot-state">‚Äî</td></tr>
                            <tr><td>Calorie</td><td id="ind-kcal-value">‚Äî</td><td id="ind-kcal-range">‚Äî</td><td id="ind-kcal-state">‚Äî</td></tr>
                            <tr><td>Fibre</td><td id="ind-fibre-value">‚Äî</td><td id="ind-fibre-range">‚Äî</td><td id="ind-fibre-state">‚Äî</td></tr>
                            <tr><td>Grassi saturi</td><td id="ind-fatsat-value">‚Äî</td><td id="ind-fatsat-range">‚Äî</td><td id="ind-fatsat-state">‚Äî</td></tr>
                            <tr><td>Rapporto O6:O3</td><td id="ind-omega-value">‚Äî</td><td id="ind-omega-range">‚Äî</td><td id="ind-omega-state">‚Äî</td></tr>
                            <tr><td>Sodio</td><td id="ind-na-value">‚Äî</td><td id="ind-na-range">‚Äî</td><td id="ind-na-state">‚Äî</td></tr>
                            <tr><td>Potassio</td><td id="ind-k-value">‚Äî</td><td id="ind-k-range">‚Äî</td><td id="ind-k-state">‚Äî</td></tr>
                        </tbody>
                    </table>
                </div>

                <div id="calorie-adjuster">
                    <label for="calorie-adjustment-input">Correzione Obiettivo:</label>
                    <button id="btn-calorie-minus" class="minus">-</button>
                    <input type="number" id="calorie-adjustment-input" value="0"> <button id="btn-calorie-plus">+</button>
                    <span>kcal</span>
                </div>

                <div id="row-alert-prot" class="macro-row-alert alert-ok" data-param="prot">
                    <span class="alert-icon" title="Spiegazione stato"><i class="fas fa-check-circle"></i></span>
                    <div class="alert-content">
                        <p style="display: flex; align-items: center; gap: 10px; margin: 0 0 4px 0;">
                            <span>Proteine: <span id="totale-proteine">0</span> / <span id="obiettivo-proteine"></span> g</span>
                            <i id="info-proteine-giornata" class="fas fa-info-circle nutrient-info-icon" data-param="prot" title="Spiegazione" style="color: #1976d2; font-size: 1.2em;"></i>
                        </p>
                        <progress id="progress-proteine" class="macro-progress" value="0" title="Clicca per elenco alimenti"></progress>
                    </div>
                </div>
                <div id="row-alert-kcal" class="macro-row-alert alert-ok" data-param="kcal">
                    <span class="alert-icon" title="Spiegazione stato"><i class="fas fa-check-circle"></i></span>
                    <div class="alert-content">
                        <p style="margin: 0 0 4px 0;">Calorie: <span id="totale-calorie">0</span> / <span id="obiettivo-calorie"></span> kcal <i class="fas fa-info-circle nutrient-info-icon" data-param="kcal" title="Spiegazione"></i></p>
                        <progress id="progress-calorie" class="macro-progress" value="0" title="Clicca per elenco alimenti"></progress>
                    </div>
                </div>
                <p>Workout: <span id="workout-calories-totali">0</span> kcal</p>
                <hr>

                <h3 class="collapsible-header" id="carbs-header">
                    Carboidrati e Zuccheri <span class="arrow">‚ñ∂</span>
                </h3>
                <div class="collapsible-content" id="carbs-content">
                    <p>Carboidrati: <span id="totale-carboidrati">0</span> / <span id="obiettivo-carboidrati"></span> g</p>
                    <progress id="progress-carboidrati" class="macro-progress" value="0"></progress>
                    <p>di cui Zuccheri: <span id="totale-zuccheri">0</span> / <span id="obiettivo-zuccheri"></span> g</p>
                    <progress id="progress-zuccheri" class="macro-progress" value="0"></progress>
                </div>
                <hr>
                
                <h3 class="collapsible-header" id="fibre-header">
                    Fibre <span class="arrow">‚ñ∂</span>
                </h3>
                <div class="collapsible-content" id="fibre-content">
                    <div id="row-alert-fibre" class="macro-row-alert alert-ok" data-param="fibreTotali">
                        <span class="alert-icon" title="Spiegazione stato"><i class="fas fa-check-circle"></i></span>
                        <div class="alert-content">
                            <p style="margin: 0 0 4px 0;">Fibre Totali: <span id="totale-fibre-totali">0</span> / <span id="obiettivo-fibre-totali"></span> g <i class="fas fa-info-circle nutrient-info-icon" data-param="fibreTotali" title="Spiegazione"></i></p>
                            <progress id="progress-fibre-totali" class="macro-progress" value="0" title="Clicca per elenco alimenti"></progress>
                        </div>
                    </div>
                    <div class="fats-group" style="padding-left: 15px; border-left: 3px solid #eee; margin-top: 15px;">
                        <p>Solubili: <span id="totale-fibre-solubili">0</span> / <span id="obiettivo-fibre-solubili"></span> g</p>
                        <progress id="progress-fibre-solubili" value="0"></progress>
                        <p>Insolubili: <span id="totale-fibre-insolubili">0</span> / <span id="obiettivo-fibre-insolubili"></span> g</p>
                        <progress id="progress-fibre-insolubili" value="0"></progress>
                    </div>
                </div>
                <hr>
                
                <h3 class="collapsible-header" id="fats-header">
                    <span style="display: flex; align-items: center; gap: 8px;">
                        Grassi
                        <i id="info-fats-settimanali" class="fas fa-info-circle" style="cursor: pointer; color: #1976d2;"></i>
                    </span>
                    <span class="arrow">‚ñ∂</span>
                </h3>
                <div class="collapsible-content" id="fats-content">
                    <p>Grassi Totali: <span id="totale-fats-total">0</span> / <span id="obiettivo-fats-total"></span> g</p>
                    <progress id="progress-fats-total" class="macro-progress" value="0"></progress>
                    
                    <div class="fats-group">
                         <div id="row-alert-fatsat" class="macro-row-alert alert-ok" data-param="fatSat" style="margin-bottom:10px;">
                            <span class="alert-icon" title="Spiegazione stato"><i class="fas fa-check-circle"></i></span>
                            <div class="alert-content">
                                <p style="margin: 0 0 4px 0;">Saturi: <span id="totale-fat-sat">0</span> / <span id="obiettivo-fat-sat"></span> g</p>
                                <progress id="progress-fat-sat" class="progress-fat-sat" value="0" title="Clicca per elenco alimenti"></progress>
                            </div>
                         </div>
                         <div class="fats-sub-bars-container">
                            <div>
                                <p>Trans: <span id="totale-fat-trans">0</span> / <span id="obiettivo-fat-trans"></span> g</p>
                                <progress id="progress-fat-trans" value="0"></progress>
                            </div>
                        </div>
                    </div>

                    <div class="fats-group">
                        <h4>Grassi Insaturi: <span id="totale-fat-unsat">0</span> / <span id="obiettivo-fat-unsat"></span> g</h4>
                        <progress id="progress-fat-unsat" value="0"></progress>
                        <div style="padding-left: 15px;">
                            <p>Monoinsaturi: <span id="totale-fat-mono">0</span> / <span id="obiettivo-fat-mono"></span> g</p>
                            <progress id="progress-fat-mono" value="0"></progress>
                            <p>Polinsaturi: <span id="totale-fat-poly">0</span> / <span id="obiettivo-fat-poly"></span> g</p>
                            <progress id="progress-fat-poly" value="0"></progress>
                            <div class="fats-group" style="border: none; padding-left: 10px; margin-top: 10px;">
                                 <div class="fats-sub-bars-container">
                                    <div>
                                        <p>Omega 3: <span id="totale-omega3">0</span> / <span id="obiettivo-omega3"></span> g</p>
                                        <progress id="progress-omega3" value="0"></progress>
                                    </div>
                                    <div>
                                        <p>Omega 6: <span id="totale-omega6">0</span> / <span id="obiettivo-omega6"></span> g</p>
                                        <progress id="progress-omega6" value="0"></progress>
                                    </div>
                                 </div>
                                 <div id="row-alert-omega" class="macro-row-alert alert-ok" data-param="omegaRatio" style="margin-top:10px;">
                                    <span class="alert-icon" title="Spiegazione stato"><i class="fas fa-check-circle"></i></span>
                                    <div class="alert-content">
                                        <p style="text-align: center; font-weight: bold; margin: 0; font-size: 1.1em;">
                                            Rapporto O6:O3: <span id="omega-ratio-value"></span>
                                        </p>
                                    </div>
                                 </div>
                            </div>
                        </div>
                    </div>
                </div>
                <hr>
                
                <h3 class="collapsible-header" id="micro-header">
                    Micronutrienti <span class="arrow">‚ñ∂</span>
                </h3>
                <div class="collapsible-content" id="micro-content">
                    
                    <div id="row-alert-na" class="macro-row-alert alert-ok" data-param="na" style="margin-bottom: 20px; padding: 10px; border-radius: 8px;">
                        <span class="alert-icon" title="Spiegazione stato"><i class="fas fa-check-circle"></i></span>
                        <div class="alert-content" style="background-color: #f1f8e9; border: 1px solid #c8e6c9; border-radius: 8px; padding: 10px;">
                            <h4 style="margin-top:0; text-align: center; color: #2e7d32;">Bilancia Idrica (Sodio / Potassio)</h4>
                            <div class="balance-labels">
                                <span style="color: #d32f2f;">SODIO (Na)</span>
                                <span style="color: #388e3c;">POTASSIO (K)</span>
                            </div>
                            <div class="balance-container">
                                <div class="balance-bar-left"></div>
                                <div class="balance-bar-right"></div>
                                <div id="balance-marker" class="balance-marker"></div>
                            </div>
                            <div class="balance-labels">
                                <span class="balance-value" id="valore-sodio">0 mg</span>
                                <span class="balance-value" id="valore-potassio">0 mg</span>
                            </div>
                            <p style="text-align: center; font-size: 0.85em; margin: 5px 0 0 0; color: #555;">Obiettivo: Cursore a destra (Zona Verde)</p>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                        <div>
                            <p>Magnesio: <span id="totale-mg">0</span> / 420 mg</p><progress id="progress-mg" value="0"></progress>
                            <p>Potassio: <span id="totale-k">0</span> / 3400 mg</p><progress id="progress-k" value="0"></progress>
                        </div>
                        <div>
                            <p>Ferro: <span id="totale-fe">0</span> / 18 mg</p><progress id="progress-fe" value="0"></progress>
                            <p>Zinco: <span id="totale-zn">0</span> / 11 mg</p><progress id="progress-zn" value="0"></progress>
                        </div>
                        <div>
                            <p>Calcio: <span id="totale-ca">0</span> / 1000 mg</p><progress id="progress-ca" value="0"></progress>
                            <p>Rame: <span id="totale-cu">0</span> / 0.9 mg</p><progress id="progress-cu" value="0" max="0.9"></progress>
                        </div>
                    </div>
                     <div style="margin-top: 15px;">
                        <p>Fosforo: <span id="totale-p">0</span> / 700 mg</p><progress id="progress-p" value="0" max="700"></progress>
                    </div>
                </div>
                <hr>

                <h3 class="collapsible-header" id="vit-header">
                    Vitamine <span class="arrow">‚ñ∂</span>
                </h3>
                <div class="collapsible-content" id="vit-content">
                    <div class="vitamin-group">
                        <h4 style="display: flex; align-items: center; gap: 8px;">
                            Accumulabili (Liposolubili / Fegato) 
                            <i id="info-vit-settimanali" class="fas fa-info-circle" style="cursor: pointer; color: #1976d2;"></i>
                        </h4>
                        <p>Vitamina A: <span id="totale-vit-a">0</span> / 900 ¬µg</p><progress id="progress-vit-a" value="0" max="900"></progress>
                        <p>Vitamina D: <span id="totale-vit-d">0</span> / 15 ¬µg</p><progress id="progress-vit-d" value="0" max="15"></progress>
                        <p>Vitamina E: <span id="totale-vit-e">0</span> / 15 mg</p><progress id="progress-vit-e" value="0" max="15"></progress>
                        <p>Vitamina K: <span id="totale-vit-k">0</span> / 120 ¬µg</p><progress id="progress-vit-k" value="0" max="120"></progress>
                        <p>Vitamina B12: <span id="totale-vit-b12">0</span> / 2.4 ¬µg</p><progress id="progress-vit-b12" value="0" max="2.4"></progress>
                    </div>
                     <div class="vitamin-group">
                        <h4>Giornaliere (Idrosolubili)</h4>
                        <p>Vitamina C: <span id="totale-vitc">0</span> / 90 mg</p><progress id="progress-vitc" value="0" max="90"></progress>
                        <p>Vitamina B2: <span id="totale-b2">0</span> / 1.3 mg</p><progress id="progress-b2" value="0" max="1.3"></progress>
                        <p>Vitamina B6: <span id="totale-b6">0</span> / 1.3 mg</p><progress id="progress-b6" value="0" max="1.3"></progress>
                        <p>Folati (B9): <span id="totale-b9">0</span> / 400 ¬µg</p><progress id="progress-b9" value="0" max="400"></progress>
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <label for="daily-notes">Note del Giorno</label>
                    <textarea id="daily-notes" rows="3" placeholder="Aggiungi note per la giornata..."></textarea>
                </div>
                </div>

            <div id="form-allenamento" class="sezione">
                <h2 class="collapsible-header" id="workout-header">Registra Allenamento <span class="arrow">‚ñ∂</span></h2>
                <div class="collapsible-content" id="workout-content">
                    <label for="workout-desc">Descrizione Allenamento</label>
                    <input type="text" id="workout-desc" placeholder="es. Corsa 30 min, Pesistica">
                    <label for="workout-calories">Calorie Bruciate (kcal)</label>
                    <input type="number" id="workout-calories" min="0">
                    <button id="btn-add-workout">Aggiungi Allenamento</button>
                </div>
            </div>
            <div id="weight-section" class="sezione">
                <h2>Peso Corporeo</h2>
                <div class="builder-grid">
                    <div>
                        <label for="weight-date">Data</label>
                        <input type="date" id="weight-date">
                    </div>
                    <div>
                        <label for="weight-value">Peso (kg)</label>
                        <input type="number" id="weight-value" min="40" max="200" step="0.1">
                    </div>
                </div>
                <div class="button-group">
                    <button id="btn-save-weight">Salva Peso</button>
                </div>
                <p id="weight-latest-info" style="font-size:0.9em;color:#555;margin-top:8px;"></p>
            </div>
            <div id="food-adder" class="sezione">
                <div class="food-adder-header">
                    <h2>Aggiungi Alimento</h2>
                    <div id="photo-ocr-controls" style="display: flex; align-items: center; gap: 5px;">
                         <span id="photo-ocr-status" style="display:none; color: #555; font-style: italic; font-size: 0.9em;"></span>
                         <button id="btn-photo-nutrients" title="Acquisisci Nutrienti da Foto"><i class="fas fa-camera"></i></button>
                         <button id="btn-scan-barcode" title="Scansiona Codice a Barre"><i class="fas fa-barcode"></i></button>
                         <button id="btn-clear-nutrients" title="Cancella campi nutrienti"><i class="fas fa-trash-alt"></i></button>
                    </div>
                </div>
                <div class="builder-grid">
                    <div style="position: relative;">
                        <div class="food-label-container">
                            <label for="builder-desc">Alimento</label>
                            <button id="btn-edit-name" title="Modifica solo il nome senza ricaricare i dati" style="display: none;">‚úèÔ∏è</button>
                            <button id="btn-edit-ingredients" title="Modifica Lista Ingredienti">üìú</button>
                        </div>
                        <input type="text" id="builder-desc" autocomplete="off">
                        <div id="custom-suggestions"></div>
                    </div>
                    <div><label>Quantit√† (g)</label><input type="text" id="builder-qta"></div>
                    <div><label>Proteine/100g</label><input type="number" id="builder-prot" step="0.1"></div>
                    <div><label>Kcal/100g</label><input type="number" id="builder-kcal" min="0"></div>
                    <div><label>Carboidrati/100g</label><input type="number" id="builder-carb" step="0.1"></div>
                    <div><label>Zuccheri/100g</label><input type="number" id="builder-zuccheri" step="0.1"></div>
                    <div><label>Grassi Totali/100g</label><input type="number" id="builder-fat-total" step="0.1"></div>
                    <div><label>Gr. Saturi/100g</label><input type="number" id="builder-fat-sat" min="0" step="0.1"></div>
                    <div><label>Fibre Totali/100g</label><input type="number" id="builder-fibre-totali" step="0.1"></div>
                    <div><label style="color: #d32f2f; font-weight: bold;">Sale/100g (NaCl)</label><input type="number" id="builder-sale" min="0" step="0.1" title="1g Sale = 390mg Sodio (calcolato automaticamente)"></div>
                </div>
                <h2 class="collapsible-header" id="nutrients-header">
                    <span>Dettagli Nutrizionali</span>
                    <div style="display: flex; align-items: center;">
                        <button id="btn-clear-dettagli" title="Pulisci Dettagli Nutrizionali"><i class="fas fa-eraser"></i></button>
                        <span class="arrow">‚ñ∂</span>
                    </div>
                </h2>
                <div class="collapsible-content" id="nutrients-content">
                    <div class="builder-grid">
                        <div><label style="color:#d32f2f;">Sodio (mg)/100g</label><input type="number" id="builder-na" min="0" step="1" title="Calcolato automaticamente dal Sale: Na = Sale √ó 390"></div>
                        
                        <div><label>Fibre Solubili/100g</label><input type="number" id="builder-fibre-solubili" step="0.1"></div>
                        <div><label>Fibre Insolubili/100g</label><input type="number" id="builder-fibre-insolubili" step="0.1"></div>
                        <div><label>Gr. Trans/100g</label><input type="number" id="builder-fat-trans" min="0" step="0.1"></div>
                        <div><label>Gr. Monoinsaturi/100g</label><input type="number" id="builder-fat-mono" min="0" step="0.1"></div>
                        <div><label>Gr. Polinsaturi/100g</label><input type="number" id="builder-fat-poly" min="0" step="0.1"></div>
                        <div><label>Omega 3/100g</label><input type="number" id="builder-omega3" min="0" step="0.1"></div>
                        <div><label>Omega 6/100g</label><input type="number" id="builder-omega6" min="0" step="0.1"></div>
                        <div><label>Vit. A (Œºg)/100g</label><input type="number" id="builder-vit-a" min="0"></div>
                        <div><label>Vit. B2 (mg)/100g</label><input type="number" id="builder-b2" min="0" step="0.01"></div>
                        <div><label>Vit. B6 (mg)/100g</label><input type="number" id="builder-b6" min="0" step="0.01"></div>
                        <div><label>Vit. B12 (Œºg)/100g</label><input type="number" id="builder-vit-b12" min="0" step="0.01"></div>
                        <div><label>Vit. D (Œºg)/100g</label><input type="number" id="builder-vit-d" min="0" step="0.01"></div>
                        <div><label>Vit. E (mg)/100g</label><input type="number" id="builder-vit-e" min="0" step="0.1"></div>
                        <div><label>Vit. K (Œºg)/100g</label><input type="number" id="builder-vit-k" min="0"></div>
                        <div><label>Folati B9 (Œºg)/100g</label><input type="number" id="builder-b9" min="0"></div>
                        <div><label>Magnesio (mg)/100g</label><input type="number" id="builder-mg" min="0"></div>
                        <div><label>Potassio (mg)/100g</label><input type="number" id="builder-k" min="0"></div>
                        <div><label>Vitamina C (mg)/100g</label><input type="number" id="builder-vitc" min="0"></div>
                        <div><label>Calcio (mg)/100g</label><input type="number" id="builder-ca" min="0"></div>
                        <div><label>Ferro (mg)/100g</label><input type="number" id="builder-fe" min="0" step="0.1"></div>
                        <div><label>Zinco (mg)/100g</label><input type="number" id="builder-zn" min="0" step="0.1"></div>
                        <div><label>Rame (mg)/100g</label><input type="number" id="builder-cu" min="0" step="0.01"></div>
                        <div><label>Fosforo (mg)/100g</label><input type="number" id="builder-p" min="0"></div>
                        <div><label>Leucina (mg)/100g</label><input type="number" id="builder-leu" min="0"></div>
                        <div><label>Isoleucina (mg)/100g</label><input type="number" id="builder-iso" min="0"></div>
                        <div><label>Valina (mg)/100g</label><input type="number" id="builder-val" min="0"></div>
                        <div><label>Lisina (mg)/100g</label><input type="number" id="builder-lys" min="0"></div>
                        <div><label>Metionina (mg)/100g</label><input type="number" id="builder-met" min="0"></div>
                        <div><label>Fenilalanina (mg)/100g</label><input type="number" id="builder-phe" min="0"></div>
                        <div><label>Treonina (mg)/100g</label><input type="number" id="builder-thr" min="0"></div>
                        <div><label>Triptofano (mg)/100g</label><input type="number" id="builder-trp" min="0"></div>
                        <div><label>Istidina (mg)/100g</label><input type="number" id="builder-his" min="0"></div>
                    </div>
                    <div id="manual-fill-section">
                        <div class="button-group">
                            <button id="btn-copy-prompt">Copia Richiesta AI</button>
                            <button id="btn-confirm-json" style="background-color: #2e7d32;">Conferma Dati da JSON</button>
                        </div>
                        <textarea id="manual-json-input" placeholder="Incolla qui l'oggetto JSON con i valori nutrizionali, come da richiesta."></textarea>
                    </div>
                </div>
                <div class="button-group">
                    <button id="btn-costruisci-pasto">Aggiungi a Pasto</button>
                    <button id="btn-aggiungi-singolo">Aggiungi al Diario</button>
                    <button id="btn-compila-ai" style="background-color: #0d47a1;">Compila AI</button>
                </div>
            </div>
            <div id="meal-builder-sezione" class="sezione" data-visible="false">
                <h2>Costruttore Pasto</h2>
                <div id="meal-builder-summary">
                    <p>Pasto Selezionato: <span id="current-meal-type-display"></span></p>
                    <div class="progress-container">
                        <div class="progress-item">
                            <p style="display: flex; align-items: center; gap: 10px;">
                                <span>Proteine: <span id="meal-prot-current">0</span> / <span id="meal-prot-target"></span> g (<span id="meal-prot-remaining"></span>)</span>
                                <i id="info-proteine-pasto" class="fas fa-info-circle" style="cursor: pointer; color: #1976d2; font-size: 1.2em;"></i>
                            </p>
                            <progress id="meal-progress-prot" value="0"></progress>
                        </div>
                        <div class="progress-item">
                            <p>Calorie: <span id="meal-cal-current">0</span> / <span id="meal-cal-target"></span> kcal (<span id="meal-cal-remaining"></span>)</p>
                            <progress id="meal-progress-cal" value="0"></progress>
                        </div>
                    </div>
                </div>
                <select id="meal-type-selector">
                    <option value="merenda1">Merenda AM</option>
                    <option value="pranzo">Pranzo</option>
                    <option value="merenda2">Merenda PM</option>
                    <option value="cena">Cena</option>
                </select>
                <div class="meal-builder-time-wrap" style="margin-top: 8px;">
                    <label for="meal-builder-time">Orario pasto</label>
                    <input type="time" id="meal-builder-time" title="Orario per l'intero pasto" class="meal-builder-time-native">
                    <div class="meal-builder-time-desktop" aria-hidden="true">
                        <select id="meal-builder-time-h" title="Ore (0-23)"><option value="00">00</option></select>
                        <span class="time-sep">:</span>
                        <select id="meal-builder-time-m" title="Minuti (0-59)"><option value="00">00</option></select>
                    </div>
                </div>
                <table id="log-pasto-builder">
                    <thead><tr><th>Sel.</th><th>Descrizione</th><th>(g)</th><th>Prot</th><th>Kcal</th><th>Azione</th></tr></thead>
                    <tbody id="log-pasto-builder-body"></tbody>
                </table>
                <button id="btn-salva-pasto">Salva Pasto nel Diario</button>
            </div>
            <div class="sezione">
                <h2>Diario Giornaliero</h2>
                <div class="diary-table-container">
                <table id="log-pasti">
                    <thead>
                        <tr>
                            <th>Orario</th>
                            <th>Descrizione</th>
                            <th>(g)</th>
                            <th>Prot</th>
                            <th>Qualit√†</th>
                            <th>Kcal</th>
                            <th>Sodio</th> <th>Fibre Tot</th>
                            <th>Fibre Sol</th>
                            <th>Fibre Ins</th>
                            <th>Leu</th>
                            <th>Iso</th>
                            <th>Val</th>
                            <th>Lys</th>
                            <th>Met</th>
                            <th>Phe</th>
                            <th>Thr</th>
                            <th>Trp</th>
                            <th>His</th>
                            <th>Gr. Sat</th>
                            <th>Gr. Trans</th>
                            <th>Gr. Mono</th>
                            <th>Gr. Poly</th>
                            <th>Omega 3</th>
                            <th>Omega 6</th>
                            <th>Mg</th>
                            <th>K</th>
                            <th>Vit.C</th>
                            <th>Ca</th>
                            <th>Fe</th>
                            <th>Zn</th>
                            <th>Cu</th>
                            <th>Vit. A</th>
                            <th>Vit. B12</th>
                            <th>Vit. D</th>
                            <th>Vit. E</th>
                            <th>Vit. K</th>
                            <th>B9</th>
                            <th>B2</th>
                            <th>B6</th>
                            <th>Azione</th>
                        </tr>
                    </thead>
                    <tbody id="log-body"></tbody>
                </table>
                </div>
                <div id="caricamento-manuale" class="sezione" style="padding:15px; margin-top:20px; border-width:1px;">
                    <h3 style="margin:0 0 10px 0; font-size:1em;">Visualizza un Altro Giorno</h3>
                    <div>
                        <input type="date" id="data-caricamento">
                        <button id="btn-vai-a-oggi">Oggi</button>
                    </div>
                </div>
            </div>

            <div class="sezione">
                <h2>Sincronizzazione Cloud Manuale</h2>
                <div class="cloud-sync-section">
                    <button id="btn-download-manual">‚¨áÔ∏è Scarica Dati dal Cloud</button>
                    <span id="cloud-sync-status" class="cloud-sync-status disconnected">Connessione Cloud: Disconnesso</span>
                </div>
                <p style="font-size: 0.85em; color: #777; margin-top: 10px;">
                    Una volta autenticato, puoi sincronizzare i dati. Lo scaricamento manuale sovrascrive i dati locali.
                </p>
            </div>
        </div>
    </div>
    
    <div id="weekly-vitamin-modal" class="modal"><div class="modal-content"><span class="modal-close" data-modal="weekly-vitamin-modal">&times;</span><h2>Riepilogo Settimanale Vitamine Accumulabili</h2><p style="font-size: 0.9em; color: #555;">Dati calcolati sugli ultimi 7 giorni, incluso oggi.</p><div class="vitamin-weekly-summary"><h4>Vitamina A</h4><p>Totale: <span id="weekly-vit-a-total">0</span> / <span id="weekly-vit-a-goal">6300</span> ¬µg</p><progress id="weekly-progress-vit-a" value="0" max="6300"></progress><p><i>Media giornaliera: <span id="weekly-vit-a-avg">0.0</span> ¬µg (Obiettivo: 900 ¬µg | <span id="weekly-vit-a-diff" class="diff-value"></span>)</i></p></div><div class="vitamin-weekly-summary"><h4>Vitamina D</h4><p>Totale: <span id="weekly-vit-d-total">0</span> / <span id="weekly-vit-d-goal">105</span> ¬µg</p><progress id="weekly-progress-vit-d" value="0" max="105"></progress><p><i>Media giornaliera: <span id="weekly-vit-d-avg">0.0</span> ¬µg (Obiettivo: 15 ¬µg | <span id="weekly-vit-d-diff" class="diff-value"></span>)</i></p></div><div class="vitamin-weekly-summary"><h4>Vitamina E</h4><p>Totale: <span id="weekly-vit-e-total">0</span> / <span id="weekly-vit-e-goal">105</span> mg</p><progress id="weekly-progress-vit-e" value="0" max="105"></progress><p><i>Media giornaliera: <span id="weekly-vit-e-avg">0.0</span> mg (Obiettivo: 15 mg | <span id="weekly-vit-e-diff" class="diff-value"></span>)</i></p></div><div class="vitamin-weekly-summary"><h4>Vitamina K</h4><p>Totale: <span id="weekly-vit-k-total">0</span> / <span id="weekly-vit-k-goal">840</span> ¬µg</p><progress id="weekly-progress-vit-k" value="0" max="840"></progress><p><i>Media giornaliera: <span id="weekly-vit-k-avg">0.0</span> ¬µg (Obiettivo: 120 ¬µg | <span id="weekly-vit-k-diff" class="diff-value"></span>)</i></p></div><div class="vitamin-weekly-summary"><h4>Vitamina B12</h4><p>Totale: <span id="weekly-vit-b12-total">0</span> / <span id="weekly-vit-b12-goal">16.8</span> ¬µg</p><progress id="weekly-progress-vit-b12" value="0" max="16.8"></progress><p><i>Media giornaliera: <span id="weekly-vit-b12-avg">0.0</span> ¬µg (Obiettivo: 2.4 ¬µg | <span id="weekly-vit-b12-diff" class="diff-value"></span>)</i></p></div></div></div>
    <div id="weekly-fats-modal" class="modal"><div class="modal-content"><span class="modal-close" data-modal="weekly-fats-modal">&times;</span><h2>Riepilogo Settimanale Grassi</h2><p style="font-size: 0.9em; color: #555;">Dati calcolati sugli ultimi 7 giorni, incluso oggi.</p><div class="vitamin-weekly-summary"><h4>Grassi Totali</h4><p>Totale: <span id="weekly-fat-total-total">0</span> / <span id="weekly-fat-total-goal"></span> g</p><progress id="weekly-progress-fat-total" value="0"></progress><p><i>Media giornaliera: <span id="weekly-fat-total-avg">0.0</span> g (Obiettivo: <span id="daily-fat-total-goal"></span> g | <span id="weekly-fat-total-diff" class="diff-value"></span>)</i></p></div><div class="vitamin-weekly-summary"><h4>Grassi Saturi</h4><p>Totale: <span id="weekly-fat-sat-total">0</span> / <span id="weekly-fat-sat-goal"></span> g</p><progress id="weekly-progress-fat-sat" value="0"></progress><p><i>Media giornaliera: <span id="weekly-fat-sat-avg">0.0</span> g (Obiettivo: <span id="daily-fat-sat-goal"></span> g | <span id="weekly-fat-sat-diff" class="diff-value"></span>)</i></p></div><div class="vitamin-weekly-summary"><h4>Grassi Trans</h4><p>Totale: <span id="weekly-fat-trans-total">0</span> / <span id="weekly-fat-trans-goal"></span> g</p><progress id="weekly-progress-fat-trans" value="0"></progress><p><i>Media giornaliera: <span id="weekly-fat-trans-avg">0.0</span> g (Obiettivo: <span id="daily-fat-trans-goal"></span> g | <span id="weekly-fat-trans-diff" class="diff-value"></span>)</i></p></div><div class="vitamin-weekly-summary"><h4>Grassi Monoinsaturi</h4><p>Totale: <span id="weekly-fat-mono-total">0</span> / <span id="weekly-fat-mono-goal"></span> g</p><progress id="weekly-progress-fat-mono" value="0"></progress><p><i>Media giornaliera: <span id="weekly-fat-mono-avg">0.0</span> g (Obiettivo: <span id="daily-fat-mono-goal"></span> g | <span id="weekly-fat-mono-diff" class="diff-value"></span>)</i></p></div><div class="vitamin-weekly-summary"><h4>Grassi Polinsaturi</h4><p>Totale: <span id="weekly-fat-poly-total">0</span> / <span id="weekly-fat-poly-goal"></span> g</p><progress id="weekly-progress-fat-poly" value="0"></progress><p><i>Media giornaliera: <span id="weekly-fat-poly-avg">0.0</span> g (Obiettivo: <span id="daily-fat-poly-goal"></span> g | <span id="weekly-fat-poly-diff" class="diff-value"></span>)</i></p></div><div class="vitamin-weekly-summary"><h4>Omega 3</h4><p>Totale: <span id="weekly-fat-omega3-total">0</span> / <span id="weekly-fat-omega3-goal"></span> g</p><progress id="weekly-progress-fat-omega3" value="0"></progress><p><i>Media giornaliera: <span id="weekly-fat-omega3-avg">0.0</span> g (Obiettivo: <span id="daily-fat-omega3-goal"></span> g | <span id="weekly-fat-omega3-diff" class="diff-value"></span>)</i></p></div><div class="vitamin-weekly-summary"><h4>Omega 6</h4><p>Totale: <span id="weekly-fat-omega6-total">0</span> / <span id="weekly-fat-omega6-goal"></span> g</p><progress id="weekly-progress-fat-omega6" value="0"></progress><p><i>Media giornaliera: <span id="weekly-fat-omega6-avg">0.0</span> g (Obiettivo: <span id="daily-fat-omega6-goal"></span> g | <span id="weekly-fat-omega6-diff" class="diff-value"></span>)</i></p></div><p style="text-align: center; font-weight: bold; margin-top: 15px; font-size: 1.2em; border-top: 1px solid #eee; padding-top: 15px;">Rapporto O6:O3 Settimanale: <span id="weekly-omega-ratio-value">N/D</span></p></div></div>
    <div id="nutrient-detail-modal" class="modal"><div class="modal-content"><span class="modal-close" data-modal="nutrient-detail-modal">&times;</span><h2 id="nutrient-detail-modal-title"></h2><ul id="nutrient-detail-modal-list"></ul></div></div>
    <div id="amino-acid-modal" class="modal"><div class="modal-content"><span class="modal-close" data-modal="amino-acid-modal">&times;</span><h2 id="modal-amino-title">Dettaglio Amminoacidi</h2><div id="modal-amino-summary" style="text-align: center; margin-bottom: 20px;"></div><div id="modal-amino-content" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;"><div><p>Leucina: <span id="modal-amino-leu-total">0</span> / <span id="modal-amino-leu-goal"></span> mg</p><progress id="modal-amino-leu-progress" value="0" style="width:100%"></progress><p>Isoleucina: <span id="modal-amino-iso-total">0</span> / <span id="modal-amino-iso-goal"></span> mg</p><progress id="modal-amino-iso-progress" value="0" style="width:100%"></progress><p>Valina: <span id="modal-amino-val-total">0</span> / <span id="modal-amino-val-goal"></span> mg</p><progress id="modal-amino-val-progress" value="0" style="width:100%"></progress><p>Lisina: <span id="modal-amino-lys-total">0</span> / <span id="modal-amino-lys-goal"></span> mg</p><progress id="modal-amino-lys-progress" value="0" style="width:100%"></progress></div><div><p>Metionina: <span id="modal-amino-met-total">0</span> / <span id="modal-amino-met-goal"></span> mg</p><progress id="modal-amino-met-progress" value="0" style="width:100%"></progress><p>Fenilalanina: <span id="modal-amino-phe-total">0</span> / <span id="modal-amino-phe-goal"></span> mg</p><progress id="modal-amino-phe-progress" value="0" style="width:100%"></progress><p>Treonina: <span id="modal-amino-thr-total">0</span> / <span id="modal-amino-thr-goal"></span> mg</p><progress id="modal-amino-thr-progress" value="0" style="width:100%"></progress><p>Triptofano: <span id="modal-amino-trp-total">0</span> / <span id="modal-amino-trp-goal"></span> mg</p><progress id="modal-amino-trp-progress" value="0" style="width:100%"></progress></div></div><div style="margin-top: 15px;"><p>Istidina: <span id="modal-amino-his-total">0</span> / <span id="modal-amino-his-goal"></span> mg</p><progress id="modal-amino-his-progress" value="0" style="width:100%"></progress></div></div></div>
    <div id="ingredient-modal" class="modal"><div class="modal-content"><span class="modal-close" data-modal="ingredient-modal">&times;</span><div id="ingredient-modal-header"><h2 id="ingredient-modal-title"></h2><div id="ingredient-modal-actions"><button id="btn-clear-ingredients" title="Cancella tutto"><i class="fas fa-eraser"></i></button><button id="btn-photo-ingredients" title="Acquisisci da foto"><i class="fas fa-camera"></i></button><button id="btn-generate-ingredients-ai" title="Genera o Pulisci con AI">ü™Ñ</button><button id="btn-copy-ingredients-prompt" title="Copia prompt per AI">üìã</button></div></div><input type="file" id="ingredient-photo-input" accept="image/*" style="display: none;"><p id="ocr-status-ingredients" style="text-align: center; color: #888; display: none;"></p><textarea id="ingredient-modal-textarea" placeholder="Inserisci o fotografa la lista ingredienti qui..."></textarea><button id="btn-save-ingredients" style="width: 100%; margin-top: 15px; background-color: #2e7d32;">Salva Ingredienti</button></div></div>
    <div id="nutrient-confirm-modal" class="modal"><div class="modal-content"><span class="modal-close" data-modal="nutrient-confirm-modal">&times;</span><h2>Conferma Dati Nutrizionali</h2><p>Controlla e correggi i valori estratti dalla foto prima di confermare.</p><div id="nutrient-confirm-list"><p id="ocr-status-nutrients" style="text-align: center; color: #888; display: block;">In attesa di una foto...</p></div><div class="nutrient-confirm-buttons"><button id="btn-cancel-nutrients" style="background-color: #607d8b;">Annulla</button><button id="btn-confirm-nutrients" style="background-color: #2e7d32;">Conferma e Compila</button></div></div></div><input type="file" id="nutrient-photo-input" accept="image/*" style="display: none;">
    <div id="barcode-scanner-modal" class="modal"><div class="modal-content"><span class="modal-close" data-modal="barcode-scanner-modal">&times;</span><h2>Scansiona Codice a Barre</h2><p style="text-align: center;">Inquadra il codice a barre del prodotto.</p><div id="scanner-container" style="position: relative; width: 100%; padding-top: 75%;"><video id="barcode-scanner-video" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 1px solid #ccc; border-radius: 8px;"></video><div id="scanner-overlay" style="position: absolute; top: 50%; left: 50%; width: 80%; height: 2px; background-color: red; transform: translate(-50%, -50%); box-shadow: 0 0 10px red;"></div></div><p id="barcode-scanner-status" style="text-align: center; margin-top: 15px; font-weight: bold; min-height: 20px;"></p></div></div>
    <div id="diff-modal" class="modal"><div class="modal-content"><span class="modal-close" data-modal="diff-modal">&times;</span><h2 id="diff-modal-title">Confronta Valori Nutrizionali</h2><p>Sono state trovate differenze significative. Scegli quali valori mantenere per ogni nutriente.</p><div id="diff-modal-list" style="max-height: 50vh; overflow-y: auto; padding: 10px; border: 1px solid #eee; border-radius: 8px; margin-top: 15px;"></div><div class="nutrient-confirm-buttons" style="margin-top: 20px;"><button id="btn-cancel-diff" style="background-color: #607d8b;">Annulla</button><button id="btn-apply-diff" style="background-color: #2e7d32;">Applica Modifiche</button></div></div></div>
    <div id="strategia-feedback-modal" class="modal strategia-feedback-modal" style="display: none;"><div class="modal-content" id="strategia-feedback-content" style="max-width: 400px; text-align: center; padding: 24px;"><p id="strategia-feedback-title" style="margin: 0 0 10px 0; font-size: 1.2em; font-weight: 700;"></p><p id="strategia-feedback-sub" style="margin: 0; font-size: 0.95em; opacity: 0.9;"></p></div></div>
    <div id="nutrient-explanation-modal" class="modal"><div class="modal-content nutrient-explanation-content"><span class="modal-close" data-modal="nutrient-explanation-modal">&times;</span><h2 id="nutrient-explanation-title" class="nutrient-explanation-title"></h2><div class="nutrient-explanation-body"><p id="nutrient-explanation-coach" class="nutrient-explanation-coach"></p><p id="nutrient-explanation-reason" class="nutrient-explanation-reason"></p><p id="nutrient-explanation-context" class="nutrient-explanation-context"></p><p id="nutrient-explanation-missing" class="nutrient-explanation-missing"></p><p id="nutrient-explanation-recovery" class="nutrient-explanation-recovery"></p></div></div></div>

   <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js" type="module"></script> 
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-functions.js" type="module"></script> 
    <script type="module">
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-functions.js";
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
        window.httpsCallable = httpsCallable; // Esporta per la chat AI

        let functions;
        const firebaseConfig = {
          apiKey: "AIzaSyA5pSzpfq1aGZ1wjNV5-eXnIqWL6brl424",
          authDomain: "mio-tracker.firebaseapp.com",
          databaseURL: "https://mio-tracker-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "mio-tracker",
          storageBucket: "mio-tracker.firebasestorage.app",
          messagingSenderId: "382993217593",
          appId: "1:382993217593:web:f0780aa061c23f9503f5e8"
        };

        let giornoVisualizzato = getTodayString('ymd');
        let datiGiornalieri = {};
        let foodDatabase = {};
        // Inizializza pastoInCostruzione leggendo da window (se gi√† creato dalla Chat AI) o da localStorage
        let pastoInCostruzione = JSON.parse(localStorage.getItem('trackerPastoInCostruzione')) || [];
window.pastoInCostruzione = pastoInCostruzione; // Sincronizza sempre all'avvio
        
        let db; 
        let auth; 
        let firebaseApp; 
        let currentUserUID = null; 
        let userProfile = null;

        const PIANO_SETTIMANALE = {
            0: { tipo: 'üíß Riposo (Deficit)', cal_base: 2300, prot: 140, carb: 300, zuccheri: 25 },
            1: { tipo: 'üî• Bicipiti', cal_base: 2300, prot: 140, carb: 300, zuccheri: 25 },
            2: { tipo: 'üí™ Gambe', cal_base: 2300, prot: 140, carb: 300, zuccheri: 25 },
            3: { tipo: 'üèÉ Spalle', cal_base: 2300, prot: 140, carb: 300, zuccheri: 25 },
            4: { tipo: 'üèãÔ∏è Addominali', cal_base: 2300, prot: 140, carb: 300, zuccheri: 25 },
            5: { tipo: 'üèÉ Schiena', cal_base: 2300, prot: 140, carb: 300, zuccheri: 25 },
            6: { tipo: 'ü•ó Total body leggero o cardio', cal_base: 2300, prot: 140, carb: 300, zuccheri: 25 }
        };

        const DEFICIT_PREIMPOSTATO_SETTIMANALE = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0 };

        const OBIETTIVI_MICRO = { mg: 420, k: 3400, vitc: 90, ca: 1000, fe: 18, zn: 11, cu: 0.9, p: 700, na: 2000 };
        const OBIETTIVI_FAT = { 
            fatTotal: 85, fatSat: 20, fatTrans: 2, 
            fatUnsat: 65, fatMono: 45, fatPoly: 20, 
            omega3: 2, omega6: 10 
        };
        const OBIETTIVI_FIBRE = { fibreTotali: 30, fibreSolubili: 10, fibreInsolubili: 20 };
        const OBIETTIVI_VIT = { vitA: 900, vitB12: 2.4, vitD: 15, vitE: 15, vitK: 120, b9: 400, b2: 1.3, b6: 1.3 };
        
        const OBIETTIVI_AMINO = {
            leu: 2900, iso: 1500, val: 1900, 
            lys: 2200, met: 1100, phe: 1800, 
            thr: 1100, trp: 300,  his: 750 
        };

        const PROFILO_AMINOACIDICO_RIFERIMENTO = {
            leu: 59, iso: 30, val: 39,
            lys: 45, met: 22, phe: 38,
            thr: 23, trp: 6.0, his: 15
        };

        const OBIETTIVI_MACRO_PASTO_BASE_FORZA = {
            merenda1: { prot: 30, cal_perc: 0.20 },
            pranzo: { prot: 40, cal_perc: 0.35 },
            merenda2: { prot: 30, cal_perc: 0.15 },
            cena: { prot: 40, cal_perc: 0.30 }
        };
        const totalProtForza = Object.values(OBIETTIVI_MACRO_PASTO_BASE_FORZA).reduce((sum, p) => sum + p.prot, 0);
        for (const mealType in OBIETTIVI_MACRO_PASTO_BASE_FORZA) {
            OBIETTIVI_MACRO_PASTO_BASE_FORZA[mealType].prot_perc = OBIETTIVI_MACRO_PASTO_BASE_FORZA[mealType].prot / totalProtForza;
        }

        const MEAL_TYPE_SEQUENCE = ['merenda1', 'pranzo', 'merenda2', 'cena'];
        const LOCAL_STORAGE_SYNC_KEYS = ['trackerFoodDatabase', 'trackerPesate', 'trackerMealType', 'trackerPastoInCostruzione'];
        const LOCAL_LAST_UPDATE_KEY = 'lastLocalUpdateTimestamp';
        const CLOUD_LAST_UPDATE_PATH = 'lastCloudUpdateTimestamp';
        const USER_PROFILE_LOCAL_KEY = 'trackerUserProfile';
        const USER_PROFILE_CLOUD_PATH = 'user_profile';
        const USER_PROFILE_COMPLETED_LOCAL_KEY = 'trackerUserProfileCompleted';
        const USER_PROFILE_COMPLETED_CLOUD_PATH = 'user_profile_completed';
        const AUTO_ADJUST_HISTORY_LOCAL_KEY = 'trackerAutoAdjustHistory';
        const AUTO_ADJUST_LAST_RUN_KEY = 'trackerAutoAdjustLastRun';
        const AUTO_ADJUST_HISTORY_CLOUD_PATH = 'auto_adjustments';
        const ADHERENCE_SCORES_LOCAL_KEY = 'trackerAdherenceScores';
        const CONTROL_MODE_LOCAL_KEY = 'trackerControlMode';
        const CONTROL_MODE_DEFAULT = 'medium';
        const TRACKER_TEMPORAL_PROFILE_KEY = 'trackerTemporalProfile';
        const TEMPORAL_MIN_KCAL_PER_DAY = 400;
        const TEMPORAL_MIN_PROT_PER_DAY = 15;
        const TEMPORAL_MIN_VALID_DAYS = 1;

        // AGGIORNATO: Aggiunto "sale" al prompt e rimosso "na" (ora calcolato dal sale)
        const GEMINI_PROMPT_FORMAT = `{"prot":g,"kcal":kcal,"carb":g,"zuccheri":g,"fatSat":g,"fatTrans":g,"fatMono":g,"fatPoly":g,"omega3":g,"omega6":g,"fibreTotali":g,"fibreSolubili":g,"fibreInsolubili":g,"sale":g,"mg":mg,"k":mg,"vitc":mg,"ca":mg,"vitA":¬µg,"vitB12":¬µg,"vitD":¬µg,"vitE":mg,"vitK":¬µg,"b9":¬µg,"b2":mg,"b6":mg,"fe":mg,"zn":mg,"cu":mg,"p":mg,"leu":mg,"iso":mg,"val":mg,"lys":mg,"met":mg,"phe":mg,"thr":mg,"trp":mg,"his":mg}`;
        const AI_INSTRUCTION = "Agisci come un esperto nutrizionista. Basa le tue risposte su database nutrizionali affidabili (come IEO, USDA, CREA). Se un valore non √® disponibile, fornisci una stima scientificamente plausibile. Devi rispondere OBBLIGATORIAMENTE in formato JSON valido, perch√© la richiesta √® impostata con 'response_format: json_object'. Per gli amminoacidi, fornisci un profilo specifico per la fonte proteica dell'alimento. Assicurati che le unit√† di misura siano corrette come specificato nel formato JSON richiesto. IMPORTANTE: usa 'sale' in grammi per 100g (NaCl), il sodio verr√† calcolato automaticamente.";

        const authSection = document.getElementById('auth-section');
        const userEmailInput = document.getElementById('user-email');
        const userPasswordInput = document.getElementById('user-password');
        const btnRegister = document.getElementById('btn-register');
        const btnLogin = document.getElementById('btn-login');
        const btnSignOut = document.getElementById('btn-sign-out');
        const authStatusP = document.getElementById('auth-status');
        const welcomeMessage = document.getElementById('welcome-message');
        const authFormFields = document.getElementById('auth-form-fields');
        const userProfileSection = document.getElementById('user-profile-section');
        const mainTrackerContent = document.getElementById('main-tracker-content');
        const titoloGiornataEl = document.getElementById('titolo-giornata');
        const logBody = document.getElementById('log-body');
        const suggestionsContainer = document.getElementById('custom-suggestions');
        const btnAggiungiSingolo = document.getElementById('btn-aggiungi-singolo');
        const btnCostruisciPasto = document.getElementById('btn-costruisci-pasto');
        const mealBuilderSezione = document.getElementById('meal-builder-sezione');
        const logPastoBuilderBody = document.getElementById('log-pasto-builder-body');
        const btnSalvaPasto = document.getElementById('btn-salva-pasto');
        const mealTypeSelector = document.getElementById('meal-type-selector');
        const dataCaricamentoInput = document.getElementById('data-caricamento');
        const calorieBalanceText = document.getElementById('calorie-balance-text');
        const calorieAdjustmentInput = document.getElementById('calorie-adjustment-input');
        const btnCalorieMinus = document.getElementById('btn-calorie-minus');
        const btnCaloriePlus = document.getElementById('btn-calorie-plus');
        const btnDownloadManual = document.getElementById('btn-download-manual');
        const cloudSyncStatusSpan = document.getElementById('cloud-sync-status');
        const cloudSyncSection = document.querySelector('.cloud-sync-section');
        const btnCopyPrompt = document.getElementById('btn-copy-prompt');
        const manualJsonInput = document.getElementById('manual-json-input');
        const btnConfirmJson = document.getElementById('btn-confirm-json');
        const btnClearNutrients = document.getElementById('btn-clear-nutrients');
        const weeklyVitaminModal = document.getElementById('weekly-vitamin-modal');
        const infoVitSettimanaliBtn = document.getElementById('info-vit-settimanali');
        const weeklyFatsModal = document.getElementById('weekly-fats-modal');
        const infoFatsSettimanaliBtn = document.getElementById('info-fats-settimanali');
        const nutrientDetailModal = document.getElementById('nutrient-detail-modal');
        const nutrientDetailTitle = document.getElementById('nutrient-detail-modal-title');
        const nutrientDetailList = document.getElementById('nutrient-detail-modal-list');
        const builderDesc = document.getElementById('builder-desc'), builderQta = document.getElementById('builder-qta');
        const builderProt = document.getElementById('builder-prot'), builderKcal = document.getElementById('builder-kcal');
        const builderCarb = document.getElementById('builder-carb'), builderZuccheri = document.getElementById('builder-zuccheri');
        const builderFatTotal = document.getElementById('builder-fat-total');
        const builderFibreTotali = document.getElementById('builder-fibre-totali');
        const builderFibreSolubili = document.getElementById('builder-fibre-solubili');
        const builderFibreInsolubili = document.getElementById('builder-fibre-insolubili');
        // NUOVO: Campo Sale principale
        const builderSale = document.getElementById('builder-sale');
        const builderFatSat = document.getElementById('builder-fat-sat'), builderFatTrans = document.getElementById('builder-fat-trans'), builderFatMono = document.getElementById('builder-fat-mono'), builderFatPoly = document.getElementById('builder-fat-poly'), builderOmega3 = document.getElementById('builder-omega3'), builderOmega6 = document.getElementById('builder-omega6');
        const builderNa = document.getElementById('builder-na'), builderMg = document.getElementById('builder-mg'), builderK = document.getElementById('builder-k'), builderVitC = document.getElementById('builder-vitc'), builderCa = document.getElementById('builder-ca');
        const builderVitA = document.getElementById('builder-vit-a'), builderVitB12 = document.getElementById('builder-vit-b12'), builderVitD = document.getElementById('builder-vit-d');
        const builderVitE = document.getElementById('builder-vit-e'), builderVitK = document.getElementById('builder-vit-k'), builderB9 = document.getElementById('builder-b9');
        const builderB2 = document.getElementById('builder-b2'), builderB6 = document.getElementById('builder-b6');
        const builderFe = document.getElementById('builder-fe'), builderZn = document.getElementById('builder-zn'), builderCu = document.getElementById('builder-cu'), builderP = document.getElementById('builder-p');
        const builderLeu = document.getElementById('builder-leu'), builderIso = document.getElementById('builder-iso'), builderVal = document.getElementById('builder-val');
        const builderLys = document.getElementById('builder-lys'), builderMet = document.getElementById('builder-met'), builderPhe = document.getElementById('builder-phe');
        const builderThr = document.getElementById('builder-thr'), builderTrp = document.getElementById('builder-trp'), builderHis = document.getElementById('builder-his');
        const dailyNotesTextarea = document.getElementById('daily-notes');
        // Profilo utente
        const profileSexSelect = document.getElementById('profile-sex');
        const profileAgeInput = document.getElementById('profile-age');
        const profileHeightInput = document.getElementById('profile-height');
        const profileWeightInput = document.getElementById('profile-weight');
        const profileGoalSelect = document.getElementById('profile-goal');
        const profileActivitySelect = document.getElementById('profile-activity');
        const profileTrainingDayCheckboxes = document.querySelectorAll('input[name="profile-training-day"]');
        const profileMealtimeInputs = {
            merenda1: document.getElementById('profile-mealtime-merenda1'),
            pranzo: document.getElementById('profile-mealtime-pranzo'),
            merenda2: document.getElementById('profile-mealtime-merenda2'),
            cena: document.getElementById('profile-mealtime-cena')
        };
        const btnSaveProfile = document.getElementById('btn-save-profile');
        const btnResetProfile = document.getElementById('btn-reset-profile');
        const profileTargetKcalSpan = document.getElementById('profile-target-kcal');
        const profileTargetProtSpan = document.getElementById('profile-target-prot');
        const profileTargetCarbSpan = document.getElementById('profile-target-carb');
        const profileTargetFatSpan = document.getElementById('profile-target-fat');
        // Peso e aderenza
        const weightDateInput = document.getElementById('weight-date');
        const weightValueInput = document.getElementById('weight-value');
        const btnSaveWeight = document.getElementById('btn-save-weight');
        const weightLatestInfo = document.getElementById('weight-latest-info');
        const controlModeSelect = document.getElementById('control-mode-select');
        const globalBodyStateEl = document.getElementById('global-body-state');
        const indicatorsDashboardEl = document.getElementById('indicators-dashboard');
        const btnEditIngredients = document.getElementById('btn-edit-ingredients');
        const btnEditName = document.getElementById('btn-edit-name');
        const ingredientModal = document.getElementById('ingredient-modal');
        const ingredientModalTitle = document.getElementById('ingredient-modal-title');
        const ingredientModalTextarea = document.getElementById('ingredient-modal-textarea');
        const ingredientModalActions = document.getElementById('ingredient-modal-actions');
        const btnGenerateIngredientsAi = document.getElementById('btn-generate-ingredients-ai');
        const btnCopyIngredientsPrompt = document.getElementById('btn-copy-ingredients-prompt');
        const btnSaveIngredients = document.getElementById('btn-save-ingredients');
        const btnClearIngredients = document.getElementById('btn-clear-ingredients');
        const btnPhotoIngredients = document.getElementById('btn-photo-ingredients');
        const ingredientPhotoInput = document.getElementById('ingredient-photo-input');
        const ocrStatusIngredients = document.getElementById('ocr-status-ingredients');
        const btnPhotoNutrients = document.getElementById('btn-photo-nutrients');
        const nutrientPhotoInput = document.getElementById('nutrient-photo-input');
        const nutrientConfirmModal = document.getElementById('nutrient-confirm-modal');
        const nutrientConfirmList = document.getElementById('nutrient-confirm-list');
        const btnConfirmNutrients = document.getElementById('btn-confirm-nutrients');
        const btnCancelNutrients = document.getElementById('btn-cancel-nutrients');
        const ocrStatusNutrients = document.getElementById('ocr-status-nutrients');
        const photoOcrStatus = document.getElementById('photo-ocr-status');
        const btnScanBarcode = document.getElementById('btn-scan-barcode');
        const barcodeScannerModal = document.getElementById('barcode-scanner-modal');
        const barcodeScannerVideo = document.getElementById('barcode-scanner-video');
        const barcodeScannerStatus = document.getElementById('barcode-scanner-status');
        const diffModal = document.getElementById('diff-modal');
        let videoStream = null;

        const inputFields = {
            prot: { el: builderProt, label: 'Proteine/100g' },
            kcal: { el: builderKcal, label: 'Kcal/100g' },
            carb: { el: builderCarb, label: 'Carboidrati/100g' },
            zuccheri: { el: builderZuccheri, label: 'Zuccheri/100g' },
            fatTotal: { el: builderFatTotal, label: 'Grassi Totali/100g' },
            fatSat: { el: builderFatSat, label: 'Gr. Saturi/100g' },
            fatTrans: { el: builderFatTrans, label: 'Gr. Trans/100g' },
            fatMono: { el: builderFatMono, label: 'Gr. Monoinsaturi/100g' },
            fatPoly: { el: builderFatPoly, label: 'Gr. Polinsaturi/100g' },
            omega3: { el: builderOmega3, label: 'Omega 3/100g' },
            omega6: { el: builderOmega6, label: 'Omega 6/100g' },
            fibreTotali: { el: builderFibreTotali, label: 'Fibre Totali/100g' },
            fibreSolubili: { el: builderFibreSolubili, label: 'Fibre Solubili/100g' },
            fibreInsolubili: { el: builderFibreInsolubili, label: 'Fibre Insolubili/100g' },
            sale: { el: builderSale, label: 'Sale/100g (NaCl)' }, // NUOVO
            na: { el: builderNa, label: 'Sodio (mg)/100g' }, // Ora calcolato dal sale
            mg: { el: builderMg, label: 'Magnesio (mg)/100g' },
            k: { el: builderK, label: 'Potassio (mg)/100g' },
            vitc: { el: builderVitC, label: 'Vitamina C (mg)/100g' },
            ca: { el: builderCa, label: 'Calcio (mg)/100g' },
            fe: { el: builderFe, label: 'Ferro (mg)/100g' },
            zn: { el: builderZn, label: 'Zinco (mg)/100g' },
            cu: { el: builderCu, label: 'Rame (mg)/100g' },
            p: { el: builderP, label: 'Fosforo (mg)/100g' },
            vitA: { el: builderVitA, label: 'Vit. A (Œºg)/100g' },
            vitB12: { el: builderVitB12, label: 'Vit. B12 (Œºg)/100g' },
            vitD: { el: builderVitD, label: 'Vit. D (Œºg)/100g' },
            vitE: { el: builderVitE, label: 'Vit. E (mg)/100g' },
            vitK: { el: builderVitK, label: 'Vit. K (Œºg)/100g' },
            b9: { el: builderB9, label: 'Folati B9 (Œºg)/100g' },
            b2: { el: builderB2, label: 'Vit. B2 (mg)/100g' },
            b6: { el: builderB6, label: 'Vit. B6 (mg)/100g' },
            leu: { el: builderLeu, label: 'Leucina (mg)/100g' },
            iso: { el: builderIso, label: 'Isoleucina (mg)/100g' },
            val: { el: builderVal, label: 'Valina (mg)/100g' },
            lys: { el: builderLys, label: 'Lisina (mg)/100g' },
            met: { el: builderMet, label: 'Metionina (mg)/100g' },
            phe: { el: builderPhe, label: 'Fenilalanina (mg)/100g' },
            thr: { el: builderThr, label: 'Treonina (mg)/100g' },
            trp: { el: builderTrp, label: 'Triptofano (mg)/100g' },
            his: { el: builderHis, label: 'Istidina (mg)/100g' }
        };

        const spanTotaleProteine = document.getElementById('totale-proteine'), spanObiettivoProteine = document.getElementById('obiettivo-proteine'), progressProteine = document.getElementById('progress-proteine');
        const spanTotaleCalorie = document.getElementById('totale-calorie'), spanObiettivoCalorie = document.getElementById('obiettivo-calorie'), progressCalorie = document.getElementById('progress-calorie');
        const spanTotaleCarboidrati = document.getElementById('totale-carboidrati'), spanObiettivoCarboidrati = document.getElementById('obiettivo-carboidrati'), progressCarboidrati = document.getElementById('progress-carboidrati');
        const spanTotaleZuccheri = document.getElementById('totale-zuccheri'), spanObiettivoZuccheri = document.getElementById('obiettivo-zuccheri'), progressZuccheri = document.getElementById('progress-zuccheri');
        const spanWorkoutCalories = document.getElementById('workout-calories-totali');
        const spanTotaleFibreTotali = document.getElementById('totale-fibre-totali'), spanObiettivoFibreTotali = document.getElementById('obiettivo-fibre-totali'), progressFibreTotali = document.getElementById('progress-fibre-totali');
        const spanTotaleFibreSolubili = document.getElementById('totale-fibre-solubili'), spanObiettivoFibreSolubili = document.getElementById('obiettivo-fibre-solubili'), progressFibreSolubili = document.getElementById('progress-fibre-solubili');
        const spanTotaleFibreInsolubili = document.getElementById('totale-fibre-insolubili'), spanObiettivoFibreInsolubili = document.getElementById('obiettivo-fibre-insolubili'), progressFibreInsolubili = document.getElementById('progress-fibre-insolubili');
        const spanTotaleFatsTotal = document.getElementById('totale-fats-total'), spanObiettivoFatsTotal = document.getElementById('obiettivo-fats-total'), progressFatsTotal = document.getElementById('progress-fats-total');
        const spanTotaleFatSat = document.getElementById('totale-fat-sat'), spanObiettivoFatSat = document.getElementById('obiettivo-fat-sat'), progressFatSat = document.getElementById('progress-fat-sat');
        const spanTotaleFatTrans = document.getElementById('totale-fat-trans'), spanObiettivoFatTrans = document.getElementById('obiettivo-fat-trans'), progressFatTrans = document.getElementById('progress-fat-trans');
        const spanTotaleFatUnsat = document.getElementById('totale-fat-unsat'), spanObiettivoFatUnsat = document.getElementById('obiettivo-fat-unsat'), progressFatUnsat = document.getElementById('progress-fat-unsat');
        const spanTotaleFatMono = document.getElementById('totale-fat-mono'), spanObiettivoFatMono = document.getElementById('obiettivo-fat-mono'), progressFatMono = document.getElementById('progress-fat-mono');
        const spanTotaleFatPoly = document.getElementById('totale-fat-poly'), spanObiettivoFatPoly = document.getElementById('obiettivo-fat-poly'), progressFatPoly = document.getElementById('progress-fat-poly');
        const spanTotaleOmega3 = document.getElementById('totale-omega3'), spanObiettivoOmega3 = document.getElementById('obiettivo-omega3'), progressOmega3 = document.getElementById('progress-omega3');
        const spanTotaleOmega6 = document.getElementById('totale-omega6'), spanObiettivoOmega6 = document.getElementById('obiettivo-omega6'), progressOmega6 = document.getElementById('progress-omega6');
        const omegaRatioValueEl = document.getElementById('omega-ratio-value');
        const spanTotaleMg = document.getElementById('totale-mg'), progressMg = document.getElementById('progress-mg');
        const spanTotaleK = document.getElementById('totale-k'), progressK = document.getElementById('progress-k');
        const spanTotaleCa = document.getElementById('totale-ca'), progressCa = document.getElementById('progress-ca');
        const spanTotaleFe = document.getElementById('totale-fe'), progressFe = document.getElementById('progress-fe');
        const spanTotaleZn = document.getElementById('totale-zn'), progressZn = document.getElementById('progress-zn');
        const spanTotaleCu = document.getElementById('totale-cu'), progressCu = document.getElementById('progress-cu');
        const spanTotaleP = document.getElementById('totale-p'), progressP = document.getElementById('progress-p');
        const spanTotaleVitC = document.getElementById('totale-vitc'), progressVitC = document.getElementById('progress-vitc');
        const spanTotaleVitA = document.getElementById('totale-vit-a'), progressVitA = document.getElementById('progress-vit-a');
        const spanTotaleVitB12 = document.getElementById('totale-vit-b12'), progressVitB12 = document.getElementById('progress-vit-b12');
        const spanTotaleVitD = document.getElementById('totale-vit-d'), progressVitD = document.getElementById('progress-vit-d');
        const spanTotaleVitE = document.getElementById('totale-vit-e'), progressVitE = document.getElementById('progress-vit-e');
        const spanTotaleVitK = document.getElementById('totale-vit-k'), progressVitK = document.getElementById('progress-vit-k');
        const spanTotaleB9 = document.getElementById('totale-b9'), progressB9 = document.getElementById('progress-b9');
        const spanTotaleB2 = document.getElementById('totale-b2'), progressB2 = document.getElementById('progress-b2');
        const spanTotaleB6 = document.getElementById('totale-b6'), progressB6 = document.getElementById('progress-b6');
        const currentMealTypeDisplay = document.getElementById('current-meal-type-display');
        const mealProtCurrent = document.getElementById('meal-prot-current'), mealProtTarget = document.getElementById('meal-prot-target'), mealProtRemaining = document.getElementById('meal-prot-remaining');
        const mealCalCurrent = document.getElementById('meal-cal-current'), mealCalTarget = document.getElementById('meal-cal-target'), mealCalRemaining = document.getElementById('meal-cal-remaining');
        const mealProgressProt = document.getElementById('meal-progress-prot'), mealProgressCal = document.getElementById('meal-progress-cal');
        const workoutDescInput = document.getElementById('workout-desc');
        const workoutCaloriesInput = document.getElementById('workout-calories');
        const btnAddWorkout = document.getElementById('btn-add-workout');
        
        const STRATEGIA_STORAGE_PREFIX = 'trackerStrategia_';
        const APP_MODE_KEY = 'trackerAppMode';
        function getAppMode() { return (localStorage.getItem(APP_MODE_KEY) || 'tracker'); }
        function setAppMode(mode) {
            if (mode !== 'tracker' && mode !== 'coach') return;
            localStorage.setItem(APP_MODE_KEY, mode);
            document.querySelectorAll('.app-mode-toggle .mode-btn').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-mode') === mode);
            });
            if (typeof aggiornaUI === 'function') aggiornaUI();
            updateModeVisibility();
        }
        function updateModeVisibility() {
            const isCoach = getAppMode() === 'coach';
            const show = (el) => { if (el) el.style.display = ''; };
            const hide = (el) => { if (el) el.style.display = 'none'; };
            const strategiaEl = document.getElementById('strategia-giornata-sezione');
            const guidaEl = document.getElementById('guida-giornata');
            const controlModeWrap = document.getElementById('control-mode-section-wrapper');
            const temporalEl = document.getElementById('temporal-analysis-dashboard');
            const indicatorsEl = document.getElementById('indicators-dashboard');
            if (isCoach) {
                show(strategiaEl);
                show(guidaEl);
                show(controlModeWrap);
                if (temporalEl && temporalEl.style.display !== 'none') show(temporalEl);
                if (indicatorsEl && indicatorsEl.style.display !== 'none') show(indicatorsEl);
            } else {
                hide(strategiaEl);
                hide(guidaEl);
                hide(controlModeWrap);
                hide(temporalEl);
                hide(indicatorsEl);
            }
        }
        function showToast(message) {
            const el = document.getElementById('toast');
            if (!el) return;
            el.textContent = message;
            el.classList.add('show');
            clearTimeout(showToast._tid);
            showToast._tid = setTimeout(() => { el.classList.remove('show'); }, 2800);
        }
        function generateChatGPTPrompt() {
            const dataVisualizzata = new Date(giornoVisualizzato);
            const pianoDelGiorno = getPianoDelGiornoForDate(dataVisualizzata);
            const strategy = getDailyStrategy(giornoVisualizzato);
            const kcalTarget = (strategy && strategy.kcalTarget != null) ? strategy.kcalTarget : (pianoDelGiorno.cal_base + (datiGiornalieri.workoutCalorie || 0) + (datiGiornalieri.calorieAdjustment || 0));
            const protTarget = (strategy && strategy.protTarget != null) ? strategy.protTarget : pianoDelGiorno.prot;
            const tipoGiornata = (strategy && strategy.tipoGiornata) ? strategy.tipoGiornata : '';
            const focus = (strategy && strategy.focus) ? strategy.focus : '';
            const times = getMealTimesOrdered(userProfile || {});
            const breakfastTime = (times.find(t => t.mealId === 'merenda1') || {}).time || '10:00';
            const lunchTime = (times.find(t => t.mealId === 'pranzo') || {}).time || '13:00';
            const snackTime = (times.find(t => t.mealId === 'merenda2') || {}).time || '17:00';
            const dinnerTime = (times.find(t => t.mealId === 'cena') || {}).time || '20:00';
            const prompt = `Agisci come nutrizionista sportivo.

Questi sono i miei dati di oggi:
- Target kcal: ${kcalTarget}
- Target proteine: ${protTarget} g
- Tipo giornata: ${tipoGiornata || '‚Äî'}
- Focus: ${focus || '‚Äî'}

Orari pasti abituali:
- Colazione: ${breakfastTime}
- Pranzo: ${lunchTime}
- Spuntino: ${snackTime}
- Cena: ${dinnerTime}

Obiettivo:
Genera un JSON strategia giornaliera per il mio tracker nutrizionale.

Formato richiesto:

{
  "kcalTarget": numero,
  "protTarget": numero,
  "tipoGiornata": "...",
  "focus": "...",
  "meals_timing": {
    "breakfast": {"time":"HH:mm","type":"..."},
    "lunch": {"time":"HH:mm","type":"..."},
    "snack": {"time":"HH:mm","type":"..."},
    "dinner": {"time":"HH:mm","type":"..."}
  },
  "note": "eventuali indicazioni"
}

Restituisci SOLO il JSON.`;
            return prompt;
        }

        function getDailyStrategy(dateString) {
            if (!dateString) return null;
            try {
                const raw = localStorage.getItem(STRATEGIA_STORAGE_PREFIX + dateString);
                if (!raw) return null;
                const o = JSON.parse(raw);
                return o && typeof o === 'object' ? o : null;
            } catch (e) { return null; }
        }
        function setDailyStrategy(dateString, strategy) {
            if (!dateString) return;
            if (!strategy || (typeof strategy === 'object' && Object.keys(strategy).length === 0)) {
                try { localStorage.removeItem(STRATEGIA_STORAGE_PREFIX + dateString); } catch (e) {}
                return;
            }
            localStorage.setItem(STRATEGIA_STORAGE_PREFIX + dateString, JSON.stringify(strategy));
        }
        function clearDailyStrategy(dateString) {
            if (!dateString) return;
            try { localStorage.removeItem(STRATEGIA_STORAGE_PREFIX + dateString); } catch (e) {}
        }

        function getTodayString(format = 'ymd') { return new Date().toISOString().split('T')[0]; }
        function getCurrentTimeString() {
            const d = new Date();
            return String(d.getHours()).padStart(2, '0') + ':' + String(d.getMinutes()).padStart(2, '0');
        }
        function getEntryTime(entry) {
            if (!entry) return '12:00';
            if (entry.type === 'workout') return entry.time || '23:59';
            return entry.time || '12:00';
        }
        const DEFAULT_MEAL_TIMES = { merenda1: '10:00', pranzo: '13:00', merenda2: '17:00', cena: '20:00' };
        function getMealTimesOrdered(profile) {
            const times = {};
            MEAL_TYPE_SEQUENCE.forEach(mealId => {
                times[mealId] = (profile && profile.mealTimes && profile.mealTimes[mealId]) || DEFAULT_MEAL_TIMES[mealId];
            });
            return MEAL_TYPE_SEQUENCE.map(mealId => ({ mealId, time: times[mealId] })).sort((a, b) => a.time.localeCompare(b.time));
        }
        function assignEntryToMeal(entryTimeStr, mealTimesOrdered) {
            if (!mealTimesOrdered || !mealTimesOrdered.length) return MEAL_TYPE_SEQUENCE[0];
            let assigned = mealTimesOrdered[0].mealId;
            mealTimesOrdered.forEach(({ mealId, time }) => {
                if (time <= entryTimeStr) assigned = mealId;
            });
            return assigned;
        }
        function computeDayDistribution(log, mealTimesOrdered) {
            const sums = { merenda1: { prot: 0, kcal: 0 }, pranzo: { prot: 0, kcal: 0 }, merenda2: { prot: 0, kcal: 0 }, cena: { prot: 0, kcal: 0 } };
            (log || []).forEach(entry => {
                if (entry.type === 'workout') return;
                const t = getEntryTime(entry);
                const mealId = assignEntryToMeal(t, mealTimesOrdered);
                const items = entry.type === 'meal' ? entry.items : [entry];
                items.forEach(item => {
                    sums[mealId].prot += item.prot || 0;
                    sums[mealId].kcal += (item.kcal || item.cal) || 0;
                });
            });
            let totalProt = 0, totalKcal = 0;
            MEAL_TYPE_SEQUENCE.forEach(m => { totalProt += sums[m].prot; totalKcal += sums[m].kcal; });
            const dist = {};
            MEAL_TYPE_SEQUENCE.forEach(m => {
                dist[m] = {
                    prot_perc: totalProt > 0 ? sums[m].prot / totalProt : 0,
                    cal_perc: totalKcal > 0 ? sums[m].kcal / totalKcal : 0
                };
            });
            return { dist, totalProt, totalKcal };
        }
        function isDayValidForTemporal(totalProt, totalKcal, logLength) {
            const foodEntries = (logLength || 0);
            return totalKcal >= TEMPORAL_MIN_KCAL_PER_DAY && totalProt >= TEMPORAL_MIN_PROT_PER_DAY && foodEntries >= 1;
        }
        function computePersonalTemporalProfile() {
            if (!userProfile) return null;
            const mealTimesOrdered = getMealTimesOrdered(userProfile);
            const distributions = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const dateStr = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
                const raw = localStorage.getItem(`trackerStorico_${dateStr}`);
                if (!raw) continue;
                try {
                    const data = JSON.parse(raw);
                    if (!data || !data.log || !data.log.length) continue;
                    const result = computeDayDistribution(data.log, mealTimesOrdered);
                    if (!isDayValidForTemporal(result.totalProt, result.totalKcal, data.log.length)) continue;
                    distributions.push(result.dist);
                } catch (e) {}
            }
            if (distributions.length < TEMPORAL_MIN_VALID_DAYS) return null;
            const avg = { merenda1: { prot_perc: 0, cal_perc: 0 }, pranzo: { prot_perc: 0, cal_perc: 0 }, merenda2: { prot_perc: 0, cal_perc: 0 }, cena: { prot_perc: 0, cal_perc: 0 } };
            MEAL_TYPE_SEQUENCE.forEach(m => {
                distributions.forEach(d => {
                    avg[m].prot_perc += (d[m] && d[m].prot_perc) || 0;
                    avg[m].cal_perc += (d[m] && d[m].cal_perc) || 0;
                });
                avg[m].prot_perc /= distributions.length;
                avg[m].cal_perc /= distributions.length;
            });
            return avg;
        }
        function getOrUpdatePersonalTemporalProfile() {
            const computed = computePersonalTemporalProfile();
            if (computed) {
                try {
                    localStorage.setItem(TRACKER_TEMPORAL_PROFILE_KEY, JSON.stringify({ profile: computed, updated: getTodayString() }));
                } catch (e) {}
                return computed;
            }
            return null;
        }
        function getIdealCumulativeUpToTime(mealTimesOrdered, dailyProt, dailyKcal, currentTimeStr, distribution) {
            if (!distribution) return { idealProt: 0, idealKcal: 0 };
            let idealProt = 0, idealKcal = 0;
            mealTimesOrdered.forEach(({ mealId, time }) => {
                if (time <= currentTimeStr) {
                    const c = distribution[mealId];
                    if (c) {
                        idealProt += (c.prot_perc || 0) * dailyProt;
                        idealKcal += (c.cal_perc || 0) * dailyKcal;
                    }
                }
            });
            return { idealProt, idealKcal };
        }
        function getPranzoTime(profile) {
            return (profile && profile.mealTimes && profile.mealTimes.pranzo) || DEFAULT_MEAL_TIMES.pranzo;
        }
        function getCenaTime(profile) {
            return (profile && profile.mealTimes && profile.mealTimes.cena) || DEFAULT_MEAL_TIMES.cena;
        }
        function isBeforeFirstMainMeal(currentTimeStr, profile) {
            return currentTimeStr < getPranzoTime(profile);
        }
        function isAfterCena(currentTimeStr, profile) {
            return currentTimeStr >= getCenaTime(profile);
        }
        function isUserCoerente() {
            const todayStr = getTodayString();
            let daysInRange = 0;
            let daysChecked = 0;
            for (let i = 1; i <= 7; i++) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const dateStr = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
                const raw = localStorage.getItem(`trackerStorico_${dateStr}`);
                if (!raw) continue;
                try {
                    const data = JSON.parse(raw);
                    if (!data || !data.log || !data.log.length) continue;
                    const dataDate = new Date(dateStr + 'T12:00:00');
                    const piano = getPianoDelGiornoForDate(dataDate);
                    const targetKcal = piano.cal_base + (data.workoutCalorie || 0) + (data.calorieAdjustment || 0);
                    const targetProt = piano.prot || 0;
                    let actualKcal = 0, actualProt = 0;
                    (data.log || []).forEach(entry => {
                        if (entry.type === 'workout') return;
                        const items = entry.type === 'meal' ? entry.items : [entry];
                        items.forEach(item => { actualKcal += (item.kcal || item.cal) || 0; actualProt += item.prot || 0; });
                    });
                    daysChecked++;
                    const ratioKcal = targetKcal > 0 ? actualKcal / targetKcal : 1;
                    const ratioProt = targetProt > 0 ? actualProt / targetProt : 1;
                    if (ratioKcal >= 0.85 && ratioKcal <= 1.15 && ratioProt >= 0.85 && ratioProt <= 1.15) daysInRange++;
                } catch (e) {}
            }
            return daysChecked >= 3 && daysInRange >= Math.min(4, daysChecked);
        }
        function pranzoCenaShareKcal(profile) {
            const personalProfile = getOrUpdatePersonalTemporalProfile();
            if (!personalProfile) return 0;
            return (personalProfile.pranzo && personalProfile.pranzo.cal_perc || 0) + (personalProfile.cena && personalProfile.cena.cal_perc || 0);
        }
        function allowRealTrajectoryEvaluation(currentTimeStr, totaliKcal, dailyKcal, profile) {
            if (!profile) return false;
            const afterCena = isAfterCena(currentTimeStr, profile);
            const over80Kcal = dailyKcal > 0 && totaliKcal >= 0.8 * dailyKcal;
            return afterCena || over80Kcal;
        }
        function computeTrajectoryGlobalState(actualProt, actualKcal, idealProt, idealKcal) {
            const ratioProt = idealProt > 0 ? actualProt / idealProt : 1;
            const ratioKcal = idealKcal > 0 ? actualKcal / idealKcal : 1;
            const minRatio = Math.min(ratioProt, ratioKcal);
            const maxRatio = Math.max(ratioProt, ratioKcal);
            if (minRatio >= 0.80 && maxRatio <= 1.20) return { status: 'in_traiettoria', protState: 'optimal', kcalState: 'optimal' };
            if (minRatio >= 0.65 && minRatio < 0.80) return { status: 'recuperabile', protState: ratioProt < 0.80 ? 'attention' : 'optimal', kcalState: ratioKcal < 0.80 ? 'attention' : 'optimal' };
            if (minRatio < 0.65) return { status: 'fuori_traiettoria', protState: ratioProt < 0.65 ? 'out' : (ratioProt < 0.80 ? 'attention' : 'optimal'), kcalState: ratioKcal < 0.65 ? 'out' : (ratioKcal < 0.80 ? 'attention' : 'optimal') };
            if (maxRatio > 1.35) return { status: 'fuori_traiettoria', protState: ratioProt > 1.35 ? 'out' : 'optimal', kcalState: ratioKcal > 1.35 ? 'out' : 'optimal' };
            return { status: 'recuperabile', protState: ratioProt < 0.80 ? 'attention' : 'optimal', kcalState: ratioKcal < 0.80 ? 'attention' : 'optimal' };
        }
        function getActualCumulativeUpToTime(log, currentTimeStr) {
            let actualProt = 0, actualKcal = 0;
            (log || []).forEach(entry => {
                if (entry.type === 'workout') return;
                const t = getEntryTime(entry);
                if (t <= currentTimeStr) {
                    const items = entry.type === 'meal' ? entry.items : [entry];
                    items.forEach(item => {
                        actualProt += item.prot || 0;
                        actualKcal += (item.kcal || item.cal) || 0;
                    });
                }
            });
            return { actualProt, actualKcal };
        }
        function getTemporalIndicator(actual, ideal, tolLow, tolHigh) {
            if (ideal <= 0) return 'in linea';
            const ratio = actual / ideal;
            if (ratio < (tolLow || 0.85)) return 'in ritardo';
            if (ratio > (tolHigh || 1.15)) return 'in anticipo';
            return 'in linea';
        }
        function updateTemporalAnalysisDashboard(OBIETTIVI, log, pianoDelGiorno) {
            const block = document.getElementById('temporal-analysis-dashboard');
            if (!block) return;
            const now = new Date();
            const todayStr = getTodayString();
            const isViewingToday = giornoVisualizzato === todayStr;
            const isDuringDay = now.getHours() < 22;
            const showTemporal = isViewingToday && isDuringDay && userProfile;
            if (!showTemporal) {
                block.style.display = 'none';
                return;
            }
            block.style.display = 'block';
            const currentTimeStr = getCurrentTimeString();
            const mealTimesOrdered = getMealTimesOrdered(userProfile);
            const personalProfile = getOrUpdatePersonalTemporalProfile();
            const actual = getActualCumulativeUpToTime(log, currentTimeStr);
            const protValEl = document.getElementById('temporal-prot-value');
            const protIdealEl = document.getElementById('temporal-prot-ideal');
            const kcalValEl = document.getElementById('temporal-kcal-value');
            const kcalIdealEl = document.getElementById('temporal-kcal-ideal');
            const protLabel = document.getElementById('temporal-prot-label');
            const kcalLabel = document.getElementById('temporal-kcal-label');
            const temporalMsg = document.getElementById('temporal-analysis-msg');
            const temporalHint = document.getElementById('temporal-analysis-hint');
            if (protValEl) protValEl.textContent = actual.actualProt.toFixed(0);
            if (kcalValEl) kcalValEl.textContent = actual.actualKcal.toFixed(0);
            if (!personalProfile) {
                if (protIdealEl) protIdealEl.textContent = '‚Äî';
                if (kcalIdealEl) kcalIdealEl.textContent = '‚Äî';
                if (protLabel) { protLabel.textContent = '‚Äî'; protLabel.className = 'temporal-indicator'; }
                if (kcalLabel) { kcalLabel.textContent = '‚Äî'; kcalLabel.className = 'temporal-indicator'; }
                if (temporalMsg) { temporalMsg.textContent = ''; temporalMsg.style.display = 'none'; }
                if (temporalHint) { temporalHint.textContent = 'Analisi personale: registra pasti completi per almeno 2‚Äì3 giorni per attivare il pattern (media mobile ultimi 7 giorni).'; temporalHint.style.display = 'block'; }
                return;
            }
            const dailyProt = OBIETTIVI.prot || 0;
            const dailyKcal = OBIETTIVI.kcal || 0;
            const ideal = getIdealCumulativeUpToTime(mealTimesOrdered, dailyProt, dailyKcal, currentTimeStr, personalProfile);
            const tolLow = 0.80;
            const tolHigh = 1.20;
            const indProt = getTemporalIndicator(actual.actualProt, ideal.idealProt, tolLow, tolHigh);
            const indKcal = getTemporalIndicator(actual.actualKcal, ideal.idealKcal, tolLow, tolHigh);
            if (protLabel) { protLabel.textContent = indProt === 'in ritardo' ? 'In ritardo' : indProt === 'in anticipo' ? 'In anticipo' : 'In linea'; protLabel.className = 'temporal-indicator temporal-' + indProt.replace(/\s/g, '-'); }
            if (kcalLabel) { kcalLabel.textContent = indKcal === 'in ritardo' ? 'In ritardo' : indKcal === 'in anticipo' ? 'In anticipo' : 'In linea'; kcalLabel.className = 'temporal-indicator temporal-' + indKcal.replace(/\s/g, '-'); }
            const msgParts = [];
            if (indProt === 'in ritardo') msgParts.push('Proteine basse per questo punto della giornata.');
            if (indKcal === 'in ritardo') msgParts.push('Calorie basse per questo punto della giornata.');
            if (temporalMsg) {
                temporalMsg.textContent = msgParts.length ? msgParts.join(' ') : '';
                temporalMsg.style.display = msgParts.length ? 'block' : 'none';
            }
            if (temporalHint) temporalHint.style.display = 'none';
            if (protIdealEl) protIdealEl.textContent = ideal.idealProt.toFixed(0) + ' g';
            if (kcalIdealEl) kcalIdealEl.textContent = ideal.idealKcal.toFixed(0) + ' kcal';
        }
        function normalizeLogTimes(log) {
            if (!log || !log.length) return;
            log.forEach(entry => {
                if (entry.type === 'workout') { if (entry.time === undefined) entry.time = '23:59'; return; }
                if (entry.time === undefined || entry.time === null) entry.time = '12:00';
                if (entry.type === 'meal' && entry.items) entry.items.forEach(item => { if (item.time === undefined) item.time = entry.time; });
            });
        }

        function sanitizeFirebaseKey(str) {
            if (!str) return '';
            return str.replace(/[.#$/\[\]]/g, '_');
        }

        function getControlMode() {
            const m = localStorage.getItem(CONTROL_MODE_LOCAL_KEY) || CONTROL_MODE_DEFAULT;
            return ['easy', 'medium', 'hard'].includes(m) ? m : CONTROL_MODE_DEFAULT;
        }

        function setControlMode(mode) {
            if (!['easy', 'medium', 'hard'].includes(mode)) return;
            localStorage.setItem(CONTROL_MODE_LOCAL_KEY, mode);
            if (controlModeSelect) controlModeSelect.value = mode;
            if (db && currentUserUID) saveSingleItemToCloud(CONTROL_MODE_LOCAL_KEY, mode);
        }

        function getToleranceForMode(mode) {
            const t = {
                easy: { low: 0.75, high: 1.35, bandPct: 0.25 },
                medium: { low: 0.88, high: 1.15, bandPct: 0.15 },
                hard: { low: 0.95, high: 1.05, bandPct: 0.06 }
            };
            return t[mode] || t.medium;
        }

        function getNutrientRanges(obiettivi) {
            const opt = obiettivi || {};
            const protOpt = opt.prot || 140;
            const kcalOpt = opt.kcal || 2300;
            const fibreOpt = opt.fibreTotali ?? OBIETTIVI_FIBRE.fibreTotali;
            const fatSatOpt = OBIETTIVI_FAT.fatSat;
            const naOpt = OBIETTIVI_MICRO.na;
            const kOpt = OBIETTIVI_MICRO.k;
            return {
                prot: { min: Math.round(protOpt * 0.75), optimal: protOpt, max: Math.round(protOpt * 1.35) },
                kcal: { min: Math.round(kcalOpt * 0.8), optimal: kcalOpt, max: Math.round(kcalOpt * 1.2) },
                fibreTotali: { min: Math.round(fibreOpt * 0.6), optimal: fibreOpt, max: 50 },
                fatSat: { min: 0, optimal: fatSatOpt, max: Math.round(fatSatOpt * 1.5) },
                omegaRatio: { min: 2, optimalMin: 3, optimalMax: 6, max: 12 },
                na: { min: 800, optimal: naOpt, max: 2600 },
                k: { min: 2600, optimal: kOpt, max: 4200 }
            };
        }

        function computeParamState(key, value, ranges, mode) {
            const tol = getToleranceForMode(mode);
            if (key === 'omegaRatio') {
                const r = ranges.omegaRatio;
                if (value == null || (value <= 0)) return 'out';
                if (value >= r.optimalMin && value <= r.optimalMax) return 'optimal';
                if (value >= r.min && value <= r.max) return 'attention';
                return 'out';
            }
            const range = ranges[key];
            if (!range || value == null) return 'optimal';
            const { min, optimal, max } = range;
            const lowBound = key === 'fatSat' || key === 'na' ? min : (optimal * tol.low);
            const highBound = key === 'fatSat' || key === 'na' ? optimal : (optimal * tol.high);
            const maxBound = key === 'fatSat' || key === 'na' ? max : (optimal * (1 + tol.bandPct * 2));
            if (key === 'fatSat' || key === 'na') {
                if (value > max) return 'out';
                if (value > optimal) return 'attention';
                if (value >= min) return 'optimal';
                return value < min ? 'attention' : 'optimal';
            }
            if (value < lowBound || value > maxBound) return 'out';
            if (value >= lowBound && value <= highBound) return 'optimal';
            return 'attention';
        }

        function computeGlobalBodyState(states) {
            const arr = Object.values(states || {});
            const out = arr.filter(s => s === 'out').length;
            const att = arr.filter(s => s === 'attention').length;
            if (out >= 2 || out >= 1 && att >= 2) return { status: 'critical', countOut: out, countAttention: att };
            if (out >= 1 || att >= 2) return { status: 'attention', countOut: out, countAttention: att };
            return { status: 'ok', countOut: out, countAttention: att };
        }

        function computeStrategyState(actual, target) {
            if (target == null || target <= 0) return 'optimal';
            const ratio = Math.abs(actual - target) / target;
            if (ratio <= 0.10) return 'optimal';
            if (ratio <= 0.20) return 'attention';
            return 'out';
        }

        function updateControlModeUI(totali, OBIETTIVI, pianoDelGiorno) {
            const mode = getControlMode();
            if (controlModeSelect && controlModeSelect.value !== mode) controlModeSelect.value = mode;
            const OBIETTIVI_MERGED = { ...OBIETTIVI, fibreTotali: OBIETTIVI_FIBRE.fibreTotali };
            const ranges = getNutrientRanges(OBIETTIVI_MERGED);
            const omegaRatio = (totali.omega3 > 0 && totali.omega6 > 0) ? totali.omega6 / totali.omega3 : null;
            let states = {
                prot: computeParamState('prot', totali.prot, ranges, mode),
                kcal: computeParamState('kcal', totali.kcal, ranges, mode),
                fibreTotali: computeParamState('fibreTotali', totali.fibreTotali, ranges, mode),
                fatSat: computeParamState('fatSat', totali.fatSat, ranges, mode),
                omegaRatio: computeParamState('omegaRatio', omegaRatio, ranges, mode),
                na: computeParamState('na', totali.na, ranges, mode),
                k: computeParamState('k', totali.k, ranges, mode)
            };
            if (getAppMode() === 'coach') {
                const dailyStrategy = getDailyStrategy(giornoVisualizzato);
                if (dailyStrategy && (dailyStrategy.kcalTarget != null || dailyStrategy.protTarget != null)) {
                    if (dailyStrategy.protTarget != null) states.prot = computeStrategyState(totali.prot, Number(dailyStrategy.protTarget));
                    if (dailyStrategy.kcalTarget != null) states.kcal = computeStrategyState(totali.kcal, Number(dailyStrategy.kcalTarget));
                }
            }
            let global = computeGlobalBodyState(states);
            const isToday = giornoVisualizzato === getTodayString();
            const currentTimeStr = getCurrentTimeString();
            const beforeMainMeal = isToday && userProfile && isBeforeFirstMainMeal(currentTimeStr, userProfile);
            if (isToday) {
                const userCoerenteToday = isUserCoerente();
                if (beforeMainMeal || !userProfile) {
                    states = { ...states, prot: 'optimal', kcal: 'optimal' };
                    global = { status: 'in_traiettoria', userCoerente: userCoerenteToday };
                } else {
                    const personalProfile = getOrUpdatePersonalTemporalProfile();
                    const dailyKcal = OBIETTIVI_MERGED.kcal || 0;
                    const totaliKcal = totali.kcal || 0;
                    const afterCena = userProfile && isAfterCena(currentTimeStr, userProfile);
                    const over80Kcal = dailyKcal > 0 && totaliKcal >= 0.8 * dailyKcal;
                    const allowRealEval = afterCena || over80Kcal;
                    const before19 = currentTimeStr < '19:00';
                    const pranzoCenaShare = pranzoCenaShareKcal(userProfile);
                    const heavyPranzoCena = pranzoCenaShare > 0.60;
                    const beforeCena = userProfile && currentTimeStr < getCenaTime(userProfile);
                    const userCoerente = userCoerenteToday;
                    if (before19 && !allowRealEval) {
                        states = { ...states, prot: 'optimal', kcal: 'optimal' };
                        global = { status: 'presto_valutazione', userCoerente: userCoerente };
                    } else if (heavyPranzoCena && beforeCena && !allowRealEval) {
                        states = { ...states, prot: 'optimal', kcal: 'optimal' };
                        global = { status: 'in_traiettoria', userCoerente: userCoerente };
                    } else if (personalProfile && allowRealEval) {
                        const mealTimesOrdered = getMealTimesOrdered(userProfile);
                        const dailyProt = OBIETTIVI_MERGED.prot || 0;
                        const ideal = getIdealCumulativeUpToTime(mealTimesOrdered, dailyProt, dailyKcal, currentTimeStr, personalProfile);
                        const actual = getActualCumulativeUpToTime(datiGiornalieri.log || [], currentTimeStr);
                        let traj = computeTrajectoryGlobalState(actual.actualProt, actual.actualKcal, ideal.idealProt, ideal.idealKcal);
                        if (before19 && traj.status === 'fuori_traiettoria') { traj = { status: 'recuperabile', protState: traj.protState === 'out' ? 'attention' : traj.protState, kcalState: traj.kcalState === 'out' ? 'attention' : traj.kcalState }; }
                        if (userCoerente && traj.status === 'fuori_traiettoria') traj = { status: 'recuperabile', protState: traj.protState === 'out' ? 'attention' : traj.protState, kcalState: traj.kcalState === 'out' ? 'attention' : traj.kcalState };
                        const giornataRecuperabile = traj.status === 'recuperabile' || traj.status === 'in_traiettoria';
                        if (giornataRecuperabile) { traj.protState = traj.protState === 'out' ? 'attention' : traj.protState; traj.kcalState = traj.kcalState === 'out' ? 'attention' : traj.kcalState; }
                        if (userCoerente) { traj.protState = traj.protState === 'out' ? 'attention' : traj.protState; traj.kcalState = traj.kcalState === 'out' ? 'attention' : traj.kcalState; }
                        global = { status: traj.status, userCoerente: userCoerente };
                        states = { ...states, prot: traj.protState, kcal: traj.kcalState };
                    } else {
                        global = { status: 'in_traiettoria', userCoerente: userCoerenteToday };
                        states = { ...states, prot: 'optimal', kcal: 'optimal' };
                    }
                }
            }
            if (getAppMode() === 'coach') {
                const dailyStrategy = getDailyStrategy(giornoVisualizzato);
                if (dailyStrategy && (dailyStrategy.kcalTarget != null || dailyStrategy.protTarget != null)) {
                    if (dailyStrategy.protTarget != null) states.prot = computeStrategyState(totali.prot, Number(dailyStrategy.protTarget));
                    if (dailyStrategy.kcalTarget != null) states.kcal = computeStrategyState(totali.kcal, Number(dailyStrategy.kcalTarget));
                }
            }
            const outKeys = Object.keys(states).filter(k => states[k] === 'out');
            if (outKeys.length > 1) outKeys.slice(1).forEach(k => { states[k] = 'attention'; });
            const statusToClass = { in_traiettoria: 'ok', recuperabile: 'attention', fuori_traiettoria: 'critical', presto_valutazione: 'ok', ok: 'ok', attention: 'attention', critical: 'critical' };
            const statusToLabel = { in_traiettoria: 'In traiettoria', recuperabile: 'Recuperabile', fuori_traiettoria: 'Fuori traiettoria', presto_valutazione: 'Giornata in corso ‚Äî troppo presto per valutare', ok: 'OK', attention: 'Attenzione', critical: 'Critico' };
            const globalClass = statusToClass[global.status] || 'ok';
            let globalLabel = statusToLabel[global.status] || 'In traiettoria';
            if (global && global.userCoerente && (global.status === 'in_traiettoria' || global.status === 'ok')) globalLabel = 'Routine stabile';
            if (globalBodyStateEl) {
                globalBodyStateEl.className = 'global-body-state state-' + globalClass;
                globalBodyStateEl.textContent = 'Stato corpo: ' + globalLabel;
            }
            const fmt = (v, u) => (v != null ? (Number(v).toFixed(v >= 100 ? 0 : 1) + (u || '')) : '‚Äî');
            const setInd = (idVal, idRange, idState, val, r, state) => {
                const vEl = document.getElementById(idVal);
                const rEl = document.getElementById(idRange);
                const sEl = document.getElementById(idState);
                if (vEl) vEl.textContent = fmt(val, idVal.includes('kcal') ? ' kcal' : idVal.includes('na') || idVal.includes('k') ? ' mg' : ' g');
                if (rEl) rEl.textContent = r;
                if (sEl) {
                    sEl.innerHTML = '<span class="indicator-dot ' + state + '"></span>' + (state === 'optimal' ? 'Ottimale' : state === 'attention' ? 'Attenzione' : 'Fuori range');
                    sEl.className = 'param-state-' + (state === 'optimal' ? 'optimal' : state === 'attention' ? 'attention' : 'out');
                }
            };
            setInd('ind-prot-value', 'ind-prot-range', 'ind-prot-state', totali.prot, ranges.prot.min + ' ‚Äì ' + ranges.prot.optimal + ' ‚Äì ' + ranges.prot.max + ' g', states.prot);
            setInd('ind-kcal-value', 'ind-kcal-range', 'ind-kcal-state', totali.kcal, ranges.kcal.min + ' ‚Äì ' + ranges.kcal.optimal + ' ‚Äì ' + ranges.kcal.max + ' kcal', states.kcal);
            setInd('ind-fibre-value', 'ind-fibre-range', 'ind-fibre-state', totali.fibreTotali, ranges.fibreTotali.min + ' ‚Äì ' + ranges.fibreTotali.optimal + ' ‚Äì ' + ranges.fibreTotali.max + ' g', states.fibreTotali);
            setInd('ind-fatsat-value', 'ind-fatsat-range', 'ind-fatsat-state', totali.fatSat, ranges.fatSat.min + ' ‚Äì ' + ranges.fatSat.optimal + ' ‚Äì ' + ranges.fatSat.max + ' g', states.fatSat);
            const ro = ranges.omegaRatio;
            const omegaValEl = document.getElementById('ind-omega-value');
            if (omegaValEl) omegaValEl.textContent = omegaRatio != null ? omegaRatio.toFixed(1) + ':1' : '‚Äî';
            const indOmegaRange = document.getElementById('ind-omega-range');
            if (indOmegaRange) indOmegaRange.textContent = ro.min + ' ‚Äì ' + ro.optimalMin + '‚Äì' + ro.optimalMax + ' ‚Äì ' + ro.max;
            const indOmegaState = document.getElementById('ind-omega-state');
            if (indOmegaState) {
                indOmegaState.innerHTML = '<span class="indicator-dot ' + states.omegaRatio + '"></span>' + (states.omegaRatio === 'optimal' ? 'Ottimale' : states.omegaRatio === 'attention' ? 'Attenzione' : 'Fuori range');
                indOmegaState.className = 'param-state-' + (states.omegaRatio === 'optimal' ? 'optimal' : states.omegaRatio === 'attention' ? 'attention' : 'out');
            }
            setInd('ind-na-value', 'ind-na-range', 'ind-na-state', totali.na, ranges.na.min + ' ‚Äì ' + ranges.na.optimal + ' ‚Äì ' + ranges.na.max + ' mg', states.na);
            setInd('ind-k-value', 'ind-k-range', 'ind-k-state', totali.k, ranges.k.min + ' ‚Äì ' + ranges.k.optimal + ' ‚Äì ' + ranges.k.max + ' mg', states.k);
            if (indicatorsDashboardEl) indicatorsDashboardEl.style.display = 'block';
            const progressProt = document.getElementById('progress-proteine');
            const progressCal = document.getElementById('progress-calorie');
            const progressFibre = document.getElementById('progress-fibre-totali');
            if (progressProt) { progressProt.classList.remove('progress-state-optimal', 'progress-state-attention', 'progress-state-out'); progressProt.classList.add('progress-state-' + states.prot); }
            if (progressCal) { progressCal.classList.remove('progress-state-optimal', 'progress-state-attention', 'progress-state-out'); progressCal.classList.add('progress-state-' + states.kcal); }
            if (progressFibre) { progressFibre.classList.remove('progress-state-optimal', 'progress-state-attention', 'progress-state-out'); progressFibre.classList.add('progress-state-' + states.fibreTotali); }
            const alertMap = [
                { id: 'row-alert-prot', state: states.prot },
                { id: 'row-alert-kcal', state: states.kcal },
                { id: 'row-alert-fibre', state: states.fibreTotali },
                { id: 'row-alert-fatsat', state: states.fatSat },
                { id: 'row-alert-omega', state: states.omegaRatio },
                { id: 'row-alert-na', state: states.na }
            ];
            const alertClass = { optimal: 'alert-ok', attention: 'alert-attention', out: 'alert-out' };
            const alertIcon = { optimal: 'fa-check-circle', attention: 'fa-exclamation-triangle', out: 'fa-times-circle' };
            alertMap.forEach(function (item) {
                const row = document.getElementById(item.id);
                if (!row) return;
                const s = item.state || 'optimal';
                row.className = 'macro-row-alert ' + (alertClass[s] || 'alert-ok');
                const iconWrap = row.querySelector('.alert-icon');
                if (iconWrap) {
                    const icon = iconWrap.querySelector('i');
                    if (icon) { icon.className = 'fas ' + (alertIcon[s] || 'fa-check-circle'); }
                }
            });
            window.nutritionControlStates = states;
            window.nutritionGlobalState = global;
            updateGuideSection(global);
        }

        function getGuideContent(globalStatus) {
            const status = globalStatus && globalStatus.status ? globalStatus.status : 'ok';
            const userCoerente = globalStatus && globalStatus.userCoerente;
            if (status === 'presto_valutazione') {
                return {
                    mainMessage: 'Giornata in corso ‚Äî troppo presto per valutare',
                    messageClass: 'guida-ok',
                    explanation: 'La maggior parte delle calorie e proteine arriva spesso a pranzo e cena. Continua a registrare i pasti per una valutazione utile.',
                    suggestions: ['Registra pranzo e cena per avere un quadro fedele della giornata.']
                };
            }
            if (status === 'in_traiettoria' || status === 'ok') {
                if (userCoerente) {
                    return {
                        mainMessage: 'Routine stabile',
                        messageClass: 'guida-ok',
                        explanation: 'Stai seguendo il tuo pattern abituale. Gli ultimi giorni sono stati coerenti con i tuoi obiettivi.',
                        suggestions: ['Continua cos√¨: mantieni ritmo e porzioni nei prossimi pasti.']
                    };
                }
                return {
                    mainMessage: 'In traiettoria',
                    messageClass: 'guida-ok',
                    explanation: 'Stai seguendo bene la tua giornata. I tuoi pasti sono in linea con il tuo pattern abituale.',
                    suggestions: ['Continua cos√¨: mantieni ritmo e porzioni nei prossimi pasti.']
                };
            }
            if (status === 'recuperabile' || status === 'attention') {
                return {
                    mainMessage: 'Recuperabile',
                    messageClass: 'guida-recuperabile',
                    explanation: 'Sei un po\' indietro rispetto alla tua traiettoria, ma la giornata √® ancora riequilibrabile.',
                    suggestions: [
                        'Concentra proteine e calorie nei pasti principali che restano (pranzo e/o cena).',
                        'Aggiungi uno spuntino nutriente se manca ancora tanto all\'obiettivo.'
                    ]
                };
            }
            return {
                mainMessage: 'Da correggere',
                messageClass: 'guida-correggere',
                explanation: 'Sei fuori traiettoria. Puoi ancora riequilibrare con il pasto successivo o domani.',
                suggestions: [
                    'Priorit√† al prossimo pasto: proteine e calorie in linea con il tuo obiettivo.',
                    'Clicca sui singoli indicatori per suggerimenti concreti su cosa mangiare.'
                ]
            };
        }

        const MEALS_ORDER_STRATEGIA = ['breakfast', 'lunch', 'snack', 'dinner'];
        const SLOT_LABELS = { breakfast: 'Colazione', lunch: 'Pranzo', snack: 'Spuntino', dinner: 'Cena' };
        const MEAL_TYPE_TO_SLOT = { merenda1: 'breakfast', pranzo: 'lunch', merenda2: 'snack', cena: 'dinner' };
        function setMealBuilderTimeDefault() {
            const el = document.getElementById('meal-builder-time');
            const selector = document.getElementById('meal-type-selector');
            if (!el) return;
            const strategy = getDailyStrategy(giornoVisualizzato || getTodayString());
            const mt = strategy && strategy.meals_timing && typeof strategy.meals_timing === 'object' ? strategy.meals_timing : null;
            const mealType = (selector && selector.value) ? selector.value : 'merenda1';
            const slotKey = MEAL_TYPE_TO_SLOT[mealType];
            const slot = mt && slotKey ? mt[slotKey] : null;
            const timeStr = (slot && slot.time) ? String(slot.time).trim().slice(0, 5) : getCurrentTimeString();
            el.value = timeStr;
            syncMealBuilderTimeFromInput();
        }
        function syncMealBuilderTimeFromInput() {
            const input = document.getElementById('meal-builder-time');
            const sh = document.getElementById('meal-builder-time-h');
            const sm = document.getElementById('meal-builder-time-m');
            if (!input || !sh || !sm) return;
            const v = (input.value || '').trim();
            const [h, m] = v ? v.split(':') : [null, null];
            const hour = Math.min(23, Math.max(0, parseInt(h, 10) || 0));
            const min = Math.min(59, Math.max(0, parseInt(m, 10) || 0));
            if (sh.value !== String(hour).padStart(2, '0')) sh.value = String(hour).padStart(2, '0');
            if (sm.value !== String(min).padStart(2, '0')) sm.value = String(min).padStart(2, '0');
        }
        function initMealBuilderTimeDesktop() {
            const sh = document.getElementById('meal-builder-time-h');
            const sm = document.getElementById('meal-builder-time-m');
            const input = document.getElementById('meal-builder-time');
            if (!sh || !sm || !input) return;
            if (sh.options.length <= 1) {
                sh.innerHTML = ''; sm.innerHTML = '';
                for (let i = 0; i <= 23; i++) sh.appendChild(new Option(String(i).padStart(2, '0'), String(i).padStart(2, '0')));
                for (let i = 0; i <= 59; i++) sm.appendChild(new Option(String(i).padStart(2, '0'), String(i).padStart(2, '0')));
            }
            sh.addEventListener('change', () => {
                const h = Math.min(23, Math.max(0, parseInt(sh.value, 10) || 0));
                const m = Math.min(59, Math.max(0, parseInt(sm.value, 10) || 0));
                input.value = String(h).padStart(2, '0') + ':' + String(m).padStart(2, '0');
            });
            sm.addEventListener('change', () => {
                const h = Math.min(23, Math.max(0, parseInt(sh.value, 10) || 0));
                const m = Math.min(59, Math.max(0, parseInt(sm.value, 10) || 0));
                input.value = String(h).padStart(2, '0') + ':' + String(m).padStart(2, '0');
            });
        }
        function getNextStrategicMeal(log, meals_timing) { return getNextGoalFromStrategy(log, meals_timing); }
        function getNextGoalFromStrategy(log, meals_timing) {
            if (!meals_timing || typeof meals_timing !== 'object') return null;
            const mealMinutes = [];
            (log || []).forEach(entry => {
                if (entry.type === 'workout') return;
                mealMinutes.push(timeStrToMinutes(getEntryTime(entry)));
            });
            for (let i = 0; i < MEALS_ORDER_STRATEGIA.length; i++) {
                const slotKey = MEALS_ORDER_STRATEGIA[i];
                const slot = meals_timing[slotKey];
                if (!slot || !slot.time) continue;
                const slotMin = timeStrToMinutes(String(slot.time).trim());
                const low = slotMin - STRATEGIA_TIMING_WINDOW_MIN;
                const high = slotMin + STRATEGIA_TIMING_WINDOW_MIN;
                const found = mealMinutes.some(m => m >= low && m <= high);
                if (!found) {
                    const label = SLOT_LABELS[slotKey] || slotKey;
                    const typeHint = (slot.type && slot.type.trim()) ? ' ‚Äî ' + slot.type.replace(/_/g, ' ') : '';
                    return { type: 'meal', slotKey, time: slot.time, label, typeHint, message: label + ' ore ' + slot.time + typeHint };
                }
            }
            return { type: 'all_done', message: 'Giornata in linea con la strategia' };
        }
        function updateProssimoObiettivoPanel() {
            const block = document.getElementById('guida-giornata');
            const wrap = document.getElementById('prossimo-obiettivo-wrap');
            const classicWrap = document.getElementById('guida-classic-wrap');
            const goalEl = document.getElementById('prossimo-obiettivo-text');
            const workoutEl = document.getElementById('prossimo-obiettivo-workout');
            if (!block || !wrap || !classicWrap || !goalEl) return;
            if (getAppMode() !== 'coach') { wrap.style.display = 'none'; classicWrap.style.display = ''; block.classList.remove('prossimo-obiettivo-panel'); return; }
            const strategy = getDailyStrategy(giornoVisualizzato);
            const mt = strategy && strategy.meals_timing && Object.keys(strategy.meals_timing).length > 0 ? strategy.meals_timing : null;
            if (!mt) {
                wrap.style.display = 'none';
                classicWrap.style.display = '';
                block.classList.remove('prossimo-obiettivo-panel');
                return;
            }
            const next = getNextGoalFromStrategy(datiGiornalieri.log || [], mt);
            wrap.style.display = 'block';
            classicWrap.style.display = 'none';
            block.classList.add('prossimo-obiettivo-panel');
            if (next) {
                const timeStr = (next.time || '').toString().trim().slice(0, 5);
                goalEl.textContent = next.type === 'all_done' ? next.message : (next.typeHint ? next.label + ' ore ' + timeStr + next.typeHint : next.label + ' entro le ' + timeStr);
                goalEl.classList.toggle('all-done', next.type === 'all_done');
            } else {
                goalEl.textContent = '‚Äî';
                goalEl.classList.remove('all-done');
            }
            if (workoutEl) {
                const w = strategy && strategy.workout && (strategy.workout.time || strategy.workout.desc);
                if (w) {
                    workoutEl.style.display = 'block';
                    workoutEl.textContent = 'üèãÔ∏è Allenamento oggi: ' + (strategy.workout.desc || 'Allenamento') + (strategy.workout.time ? ' ore ' + strategy.workout.time.replace(/^(\d{1,2}:\d{2}).*/, '$1') : '');
                } else {
                    workoutEl.style.display = 'none';
                }
            }
        }
        function buildLavagnaActivities(meals_timing, workout) {
            const rows = [];
            const slotLabels = { breakfast: 'Colazione', lunch: 'Pranzo', snack: 'Spuntino', dinner: 'Cena' };
            MEALS_ORDER_STRATEGIA.forEach(slotKey => {
                const slot = meals_timing[slotKey];
                if (!slot || !slot.time) return;
                const timeStr = String(slot.time).trim().slice(0, 5);
                const label = slotLabels[slotKey] || slotKey;
                const typeHint = (slot.type && slot.type.trim()) ? ' ‚Äî ' + slot.type.replace(/_/g, ' ') : '';
                rows.push({ type: 'meal', slotKey, time: timeStr, timeMin: timeStrToMinutes(slot.time), label, typeHint });
            });
            if (workout && (workout.time || workout.desc)) {
                const timeStr = workout.time ? String(workout.time).trim().slice(0, 5) : '23:59';
                rows.push({ type: 'workout', time: timeStr, timeMin: workout.time ? timeStrToMinutes(workout.time) : 24 * 60 - 1, label: 'Workout', desc: workout.desc || 'Allenamento' });
            }
            rows.sort((a, b) => a.timeMin - b.timeMin);
            return rows;
        }
        function updateTitoloPanel(dataVisualizzata, pianoDelGiorno, dailyStrategy) {
            const dateEl = document.getElementById('lavagna-date');
            const noStrategyEl = document.getElementById('lavagna-no-strategy');
            const listEl = document.getElementById('lavagna-list');
            const allDoneEl = document.getElementById('lavagna-all-done');
            if (!dateEl) return;
            const dateStr = dataVisualizzata.toLocaleDateString('it-IT', { day: 'numeric', month: 'long', year: 'numeric' });
            dateEl.textContent = 'üìÖ ' + dateStr;
            const mt = dailyStrategy && dailyStrategy.meals_timing && Object.keys(dailyStrategy.meals_timing).length > 0 ? dailyStrategy.meals_timing : null;
            const workout = dailyStrategy && dailyStrategy.workout ? dailyStrategy.workout : null;
            if (!mt || Object.keys(mt).length === 0) {
                noStrategyEl.style.display = 'block';
                listEl.style.display = 'none';
                allDoneEl.style.display = 'none';
                return;
            }
            noStrategyEl.style.display = 'none';
            const activities = buildLavagnaActivities(mt, workout);
            const log = datiGiornalieri.log || [];
            const adherence = computeTimingAdherence(log, mt);
            const mealStatus = {};
            adherence.forEach(a => { mealStatus[a.slotKey] = a.status; });
            const hasWorkoutLogged = log.some(e => e.type === 'workout');
            let currentFound = false;
            listEl.innerHTML = '';
            listEl.style.display = 'block';
            activities.forEach(act => {
                let status = 'future';
                if (act.type === 'meal') {
                    if (mealStatus[act.slotKey] === 'ok') status = 'completed';
                    else if (!currentFound) { status = 'current'; currentFound = true; }
                } else {
                    if (hasWorkoutLogged) status = 'completed';
                    else if (!currentFound) { status = 'current'; currentFound = true; }
                }
                const li = document.createElement('li');
                li.className = 'lavagna-item ' + status;
                let text = act.label + ' ' + act.time;
                if (act.typeHint) text += act.typeHint;
                if (act.type === 'workout' && act.desc) text += ' ¬∑ ' + act.desc;
                if (status === 'current') text = 'üéØ ' + text;
                if (status === 'completed') text = '‚úì ' + text;
                li.textContent = text;
                listEl.appendChild(li);
            });
            const allCompleted = activities.length > 0 && activities.every(act => {
                if (act.type === 'meal') return mealStatus[act.slotKey] === 'ok';
                return hasWorkoutLogged;
            });
            allDoneEl.style.display = allCompleted ? 'block' : 'none';
        }
        function updateGuideSection(global) {
            const block = document.getElementById('guida-giornata');
            if (!block) return;
            if (getAppMode() === 'coach') {
                const strategy = getDailyStrategy(giornoVisualizzato);
                const mt = strategy && strategy.meals_timing && Object.keys(strategy.meals_timing).length > 0;
                if (mt) {
                    updateProssimoObiettivoPanel();
                    return;
                }
            }
            const content = getGuideContent(global);
            const mainEl = document.getElementById('guida-main-message');
            const explEl = document.getElementById('guida-explanation');
            const suggEl = document.getElementById('guida-suggestions');
            const wrap = document.getElementById('prossimo-obiettivo-wrap');
            const classicWrap = document.getElementById('guida-classic-wrap');
            if (wrap) wrap.style.display = 'none';
            if (classicWrap) classicWrap.style.display = '';
            block.classList.remove('prossimo-obiettivo-panel');
            if (mainEl) { mainEl.textContent = content.mainMessage; mainEl.className = 'guida-main-message ' + (content.messageClass || ''); }
            if (explEl) explEl.textContent = content.explanation || '';
            if (suggEl) {
                suggEl.innerHTML = '';
                (content.suggestions || []).slice(0, 2).forEach(function (s) {
                    const li = document.createElement('li');
                    li.textContent = s;
                    suggEl.appendChild(li);
                });
            }
        }
        function showStrategiaFeedback(kind) {
            const modal = document.getElementById('strategia-feedback-modal');
            const content = document.getElementById('strategia-feedback-content');
            const titleEl = document.getElementById('strategia-feedback-title');
            const subEl = document.getElementById('strategia-feedback-sub');
            if (!modal || !content || !titleEl || !subEl) return;
            content.className = 'modal-content ' + (kind === 'success' ? 'feedback-success' : 'feedback-error');
            titleEl.textContent = kind === 'success' ? 'Strategia giornaliera caricata' : 'Errore nel JSON. Controlla formato.';
            subEl.textContent = kind === 'success' ? 'La giornata √® ora guidata dalla strategia concordata.' : '';
            subEl.style.display = kind === 'success' ? 'block' : 'none';
            modal.style.display = 'block';
            if (kind === 'success') {
                clearTimeout(showStrategiaFeedback._tid);
                showStrategiaFeedback._tid = setTimeout(() => { modal.style.display = 'none'; }, 2500);
            }
        }

        function getDailyNutrientTotalFromLog(log, param) {
            if (!log || !Array.isArray(log)) return param === 'omegaRatio' ? { o3: 0, o6: 0 } : 0;
            let prot = 0, kcal = 0, fibreTotali = 0, fatSat = 0, na = 0, omega3 = 0, omega6 = 0;
            log.forEach(entry => {
                const items = entry.type === 'meal' ? (entry.items || []) : (entry.type === 'workout' ? [] : [entry]);
                items.forEach(item => {
                    if (!item) return;
                    prot += item.prot || 0;
                    kcal += (item.kcal || item.cal) || 0;
                    fibreTotali += item.fibreTotali || 0;
                    fatSat += item.fatSat || 0;
                    na += item.na || 0;
                    omega3 += item.omega3 || 0;
                    omega6 += item.omega6 || 0;
                });
            });
            if (param === 'prot') return prot;
            if (param === 'kcal') return kcal;
            if (param === 'fibreTotali') return fibreTotali;
            if (param === 'fatSat') return fatSat;
            if (param === 'na') return na;
            if (param === 'omegaRatio') return (omega3 > 0 && omega6 > 0) ? omega6 / omega3 : null;
            return 0;
        }

        function getNutrient7DayAverage(param) {
            const baseDate = giornoVisualizzato || getTodayString('ymd');
            let sum = 0, count = 0;
            for (let i = 0; i < 7; i++) {
                const d = new Date(baseDate);
                d.setDate(d.getDate() - i);
                const dateString = d.toISOString().split('T')[0];
                const raw = localStorage.getItem(`trackerStorico_${dateString}`);
                if (!raw) continue;
                try {
                    const dayData = JSON.parse(raw);
                    const log = dayData && dayData.log;
                    const val = getDailyNutrientTotalFromLog(log, param);
                    if (param === 'omegaRatio') {
                        if (val != null && isFinite(val)) { sum += val; count++; }
                    } else if (typeof val === 'number' && isFinite(val)) {
                        sum += val;
                        count++;
                    }
                } catch (e) { /* skip */ }
            }
            const avg = count > 0 ? sum / count : null;
            return { avg, count };
        }

        function generateNutrientExplanation(param, currentValue, target, timeOfDay, trajectoryState, alertState, avg7) {
            const cv = Number(currentValue) || 0;
            const tg = Number(target) || 0;
            const diff = tg - cv;
            const titles = { prot: 'Proteine', kcal: 'Calorie', fibreTotali: 'Fibre', fatSat: 'Grassi saturi', omegaRatio: 'Rapporto Omega 6:3', na: 'Sodio e potassio' };
            const title = titles[param] || param;
            let reason = '', context = '', missing = '', recovery = '', coachMessage = '';
            const traj = trajectoryState || 'in_traiettoria';
            const isRecoverable = traj === 'recuperabile' || traj === 'in_traiettoria';
            const stateLabel = alertState === 'out' ? 'Fuori range' : (alertState === 'attention' ? 'Attenzione' : 'Ok');
            const avg = (avg7 && avg7.count > 0) ? avg7.avg : null;
            const withinPattern = avg != null && tg > 0 && (param === 'omegaRatio' ? (avg >= 2 && avg <= 8 && Math.abs(cv - avg) <= 2) : (Math.abs(cv - avg) <= Math.max(tg * 0.2, 5)));
            if (param === 'prot') {
                reason = cv < tg * 0.85 ? 'Le proteine sono basse per questo punto della giornata rispetto alla tua traiettoria abituale.' : (cv > tg * 1.15 ? 'Le proteine sono in eccesso rispetto all\'obiettivo.' : 'Le proteine sono in linea con la tua traiettoria.');
                context = isRecoverable ? 'La giornata √® ancora recuperabile: puoi distribuire le proteine nei pasti rimanenti.' : (traj === 'fuori_traiettoria' ? 'Sei indietro rispetto alla tua media: concentra le proteine a pranzo e cena.' : 'Stai seguendo bene il tuo pattern abituale.');
                missing = diff > 0 ? 'Mancano circa ' + Math.round(diff) + ' g di proteine all\'obiettivo giornaliero.' : (diff < 0 ? 'Hai circa ' + Math.round(-diff) + ' g di proteine in pi√π rispetto all\'obiettivo.' : 'Obiettivo proteine raggiunto.');
                recovery = diff > 0 ? 'Idee: petto di pollo (30 g/100 g), tonno (26 g), uova (6 g/uovo), ricotta (11 g/100 g), legumi a pranzo o cena. Aggiungi una porzione da 150 g di carne/pesce o 2 uova + 80 g ricotta.' : (diff < 0 ? 'Mantieni le porzioni nei prossimi pasti; non serve ridurre se il resto della giornata √® bilanciato.' : 'Prosegui cos√¨.');
                coachMessage = (stateLabel === 'Ok' ? 'Stato: in range. ' : 'Stato: ' + stateLabel.toLowerCase() + '. ') + (avg != null ? 'Rispetto alla media degli ultimi 7 giorni ' + (withinPattern ? 'sei in linea con il tuo pattern abituale. ' : (cv < avg ? 'sei leggermente sotto. ' : 'sei sopra. ')) : '') + (isRecoverable && diff > 0 ? 'Giornata ancora recuperabile con una cena proteica.' : (isRecoverable ? 'Giornata in linea; prosegui cos√¨.' : 'Concentra le proteine nei pasti rimanenti.'));
            } else if (param === 'kcal') {
                reason = cv < tg * 0.85 ? 'Le calorie sono basse per questo punto della giornata rispetto alla tua traiettoria.' : (cv > tg * 1.15 ? 'Le calorie superano l\'obiettivo giornaliero.' : 'Le calorie sono in linea con la tua traiettoria.');
                context = isRecoverable ? 'La giornata √® ancora recuperabile: puoi riequilibrare con i pasti rimanenti.' : (traj === 'fuori_traiettoria' ? 'Sei sotto la tua media abituale a quest\'ora: pranzo e cena possono compensare.' : 'Andamento in linea con le tue abitudini.');
                missing = diff > 0 ? 'Mancano circa ' + Math.round(diff) + ' kcal all\'obiettivo.' : (diff < 0 ? 'Hai circa ' + Math.round(-diff) + ' kcal in pi√π rispetto all\'obiettivo.' : 'Obiettivo calorico raggiunto.');
                recovery = diff > 0 ? 'Aggiungi uno spuntino (frutta secca, yogurt, pane e marmellata) o porzioni leggermente pi√π abbondanti a pranzo/cena. Es: 30 g mandorle (~170 kcal), 1 yogurt greco (~100 kcal), 1 toast (~150 kcal).' : (diff < 0 ? 'Puoi alleggerire leggermente i pasti successivi o mantenere se √® un giorno di recupero.' : 'Prosegui cos√¨.');
                coachMessage = (stateLabel === 'Ok' ? 'Stato: in range. ' : 'Stato: ' + stateLabel.toLowerCase() + '. ') + (avg != null ? 'Rispetto agli ultimi 7 giorni ' + (withinPattern ? 'sei in linea con le tue abitudini. ' : (cv < avg ? 'sei sotto. ' : 'sei sopra. ')) : '') + (isRecoverable && diff > 0 ? 'Puoi recuperare con pranzo e cena.' : (isRecoverable ? 'Andamento ok.' : 'Pranzo e cena possono riequilibrare.'));
            } else if (param === 'fibreTotali') {
                reason = cv < tg * 0.8 ? 'Le fibre sono sotto l\'obiettivo: importante per saziet√† e salute intestinale.' : (cv > 45 ? 'Fibre molto alte: ok, ma bevi a sufficienza.' : 'Le fibre sono in range.');
                context = isRecoverable ? 'Puoi raggiungere l\'obiettivo con verdura a pranzo e cena e frutta.' : 'Aggiungi fonti di fibre nei prossimi pasti.';
                missing = diff > 0 ? 'Mancano circa ' + Math.round(diff) + ' g di fibre.' : (diff < 0 ? 'Fibre sopra obiettivo: va bene.' : 'Obiettivo fibre raggiunto.');
                recovery = diff > 0 ? 'Aggiungi: insalata o verdure cotte (2‚Äì3 g/100 g), legumi (7‚Äì8 g/100 g), frutta (2‚Äì3 g/100 g), cereali integrali. Es: 150 g broccoli + 80 g ceci + 1 mela ‚âà 10‚Äì12 g fibre.' : 'Prosegui cos√¨.';
                coachMessage = (stateLabel === 'Ok' ? 'Stato: in range. ' : 'Stato: ' + stateLabel.toLowerCase() + '. ') + (avg != null ? 'Rispetto alla media degli ultimi 7 giorni ' + (withinPattern ? 'sei in linea. ' : '') : '') + (isRecoverable && diff > 0 ? 'Recuperabile con verdura e frutta a pranzo e cena.' : 'Prosegui cos√¨.');
            } else if (param === 'fatSat') {
                reason = cv > tg * 1.2 ? 'I grassi saturi superano l\'obiettivo: meglio non eccedere per la salute cardiovascolare.' : (cv <= tg ? 'Grassi saturi in range.' : 'Grassi saturi leggermente sopra.');
                context = 'Riducendo formaggi grassi, burro e salumi nei pasti successivi rientri in traiettoria.';
                missing = diff < 0 ? 'Hai circa ' + Math.round(-diff) + ' g di saturi in pi√π rispetto all\'obiettivo.' : (diff > 0 ? 'Sei sotto obiettivo: va bene.' : 'In range.');
                recovery = cv > tg ? 'Scegli carni magre, poco burro/formaggio, preferisci olio extravergine. Es: riduci formaggio a 30‚Äì40 g, evita secondi molto grassi a cena.' : 'Prosegui cos√¨.';
                coachMessage = (stateLabel === 'Ok' ? 'Stato: in range. ' : 'Stato: ' + stateLabel.toLowerCase() + '. ') + (avg != null ? 'Rispetto agli ultimi 7 giorni ' + (withinPattern ? 'sei in linea. ' : '') : '') + (cv > tg ? 'Suggerimento: preferisci olio e carni magre nei pasti successivi.' : 'Prosegui cos√¨.');
            } else if (param === 'omegaRatio') {
                const ratio = cv;
                reason = ratio > 8 ? 'Il rapporto Omega 6:3 √® troppo alto: aumenta l\'infiammazione. Ideale 3:1‚Äì6:1.' : (ratio >= 3 && ratio <= 6 ? 'Rapporto Omega 6:3 in range ottimale.' : 'Rapporto da riequilibrare.');
                context = ratio > 6 ? 'Aumentando gli Omega 3 e moderando gli Omega 6 (oli di semi, snack) migliori il bilancio.' : 'Mantieni pesce e fonti di omega 3.';
                missing = ratio > 6 ? 'Rapporto attuale troppo alto: punta a ridurlo sotto 6:1 aumentando Omega 3.' : 'Rapporto in range.';
                recovery = ratio > 6 ? 'Aumenta: salmone, sgombro, sardine, noci, semi di lino, olio di lino. Riduci: oli di semi (girasole, mais), snack industriali. Es: 2 porzioni di pesce grasso a settimana, 1 cucchiaio di semi di lino.' : 'Prosegui cos√¨.';
                coachMessage = (stateLabel === 'Ok' ? 'Stato: in range. ' : 'Stato: ' + stateLabel.toLowerCase() + '. ') + (avg != null ? 'Media ultimi 7 giorni: rapporto ' + (avg.toFixed(1)) + ':1. ' : '') + (ratio > 6 ? 'Suggerimento: pi√π pesce grasso e semi di lino, meno oli di semi.' : 'Mantieni le tue abitudini.');
            } else if (param === 'na') {
                reason = cv > 2300 ? 'Il sodio √® alto: meglio restare sotto 2,3 g per la pressione.' : (cv < 800 ? 'Il sodio √® basso: controlla che il potassio non sia troppo alto in rapporto.' : 'Sodio in range; bilancia con il potassio.');
                context = 'L\'equilibrio sodio/potassio (pi√π K che Na) aiuta. Cursore a destra = zona verde.';
                missing = cv > 2300 ? 'Riduci il sodio di circa ' + Math.round(cv - 2300) + ' mg: meno sale e cibi trasformati.' : (cv < 800 ? 'Puoi usare un po\' pi√π di sale a tavola se il potassio √® alto.' : 'Bilancio sodio/potassio ok.');
                recovery = cv > 2300 ? 'Meno sale aggiunto, meno salumi/formaggi salati, meno prodotti in scatola. Scegli erbe e spezie. Aumenta potassio: banana, spinaci, patate, fagioli.' : 'Aumenta potassio con verdura e frutta; limita sale aggiunto.';
                coachMessage = (stateLabel === 'Ok' ? 'Stato: in range. ' : 'Stato: ' + stateLabel.toLowerCase() + '. ') + (avg != null ? 'Media ultimi 7 giorni: ' + Math.round(avg) + ' mg. ' : '') + (cv > 2300 ? 'Suggerimento: meno sale e prodotti trasformati, pi√π verdura e frutta.' : 'Bilancio ok; mantieni variet√†.');
            }
            return { title, reason, context, missing, recovery, coachMessage: coachMessage || (stateLabel + '. ' + (isRecoverable ? 'Giornata recuperabile.' : 'Prosegui cos√¨.')) };
        }

        function openNutrientExplanationModal(param) {
            const timeOfDay = getCurrentTimeString();
            const trajectoryState = (window.nutritionGlobalState && window.nutritionGlobalState.status) || 'in_traiettoria';
            const states = window.nutritionControlStates || {};
            const alertState = states[param] || 'optimal';
            let currentValue = 0, target = 0;
            if (param === 'prot') { currentValue = document.getElementById('totale-proteine')?.textContent || 0; target = document.getElementById('obiettivo-proteine')?.textContent || 0; }
            else if (param === 'kcal') { currentValue = document.getElementById('totale-calorie')?.textContent || 0; target = document.getElementById('obiettivo-calorie')?.textContent || 0; }
            else if (param === 'fibreTotali') { currentValue = document.getElementById('totale-fibre-totali')?.textContent || 0; target = document.getElementById('obiettivo-fibre-totali')?.textContent || 0; }
            else if (param === 'fatSat') { currentValue = document.getElementById('totale-fat-sat')?.textContent || 0; target = document.getElementById('obiettivo-fat-sat')?.textContent || 0; }
            else if (param === 'omegaRatio') {
                const ratioEl = document.getElementById('omega-ratio-value');
                const t = (ratioEl && ratioEl.textContent) ? ratioEl.textContent.replace(':1', '').trim() : '0';
                currentValue = parseFloat(t) || 0;
                target = 5;
            } else if (param === 'na') {
                const naEl = document.getElementById('valore-sodio');
                const t = (naEl && naEl.textContent) ? naEl.textContent.replace(' mg', '').trim() : '0';
                currentValue = parseFloat(t) || 0;
                target = 1500;
            }
            const avg7 = getNutrient7DayAverage(param);
            const expl = generateNutrientExplanation(param, currentValue, target, timeOfDay, trajectoryState, alertState, avg7);
            const modal = document.getElementById('nutrient-explanation-modal');
            if (!modal) return;
            document.getElementById('nutrient-explanation-title').textContent = expl.title;
            const coachEl = document.getElementById('nutrient-explanation-coach');
            if (coachEl) { coachEl.textContent = expl.coachMessage || ''; coachEl.style.display = expl.coachMessage ? 'block' : 'none'; }
            document.getElementById('nutrient-explanation-reason').textContent = expl.reason;
            document.getElementById('nutrient-explanation-context').textContent = expl.context;
            document.getElementById('nutrient-explanation-missing').textContent = expl.missing;
            document.getElementById('nutrient-explanation-recovery').textContent = expl.recovery;
            modal.style.display = 'block';
        }

        function isUserProfileComplete(profile) {
            if (!profile) return false;
            const required = ['sex', 'age', 'height', 'weight', 'goal', 'activityLevel'];
            return required.every(k => profile[k] !== undefined && profile[k] !== null && profile[k] !== '');
        }

        function getActivityFactor(level) {
            switch (level) {
                case 'sedentary': return 1.2;
                case 'light': return 1.375;
                case 'moderate': return 1.55;
                case 'high': return 1.725;
                case 'athlete': return 1.9;
                default: return 1.4;
            }
        }

        function calculateBMR(profile) {
            const weight = Number(profile.weight) || 0; // kg
            const height = Number(profile.height) || 0; // cm
            const age = Number(profile.age) || 0;
            const sex = profile.sex || 'other';
            const base = 10 * weight + 6.25 * height - 5 * age;
            const sexOffset = sex === 'male' ? 5 : (sex === 'female' ? -161 : -78);
            const bmr = base + sexOffset;
            return Math.max(1000, isFinite(bmr) ? bmr : 0);
        }

        function calculateDailyKcalTarget(profile) {
            const bmr = calculateBMR(profile);
            const tdee = bmr * getActivityFactor(profile.activityLevel);
            let target = tdee;
            if (profile.goal === 'cut') {
                target = tdee - 400;
            } else if (profile.goal === 'massa') {
                target = tdee + 250;
            }
            return Math.round(Math.max(1400, target));
        }

        function calculateMacroTargets(profile) {
            if (profile && profile.useManualTargets && profile.manualTargets) {
                const m = profile.manualTargets;
                const kcal = Number(m.kcal) || 0;
                const prot = Number(m.prot) || 0;
                const carb = Number(m.carb) || 0;
                const fat = Number(m.fat) || 0;
                if (kcal > 0 && prot > 0 && carb > 0 && fat > 0) {
                    return {
                        kcal: Math.round(kcal),
                        prot: Math.round(prot),
                        carb: Math.round(carb),
                        zuccheri: Math.round(carb * 0.25),
                        fat: Math.round(fat)
                    };
                }
            }
            if (profile && profile.adaptiveMacros && profile.adaptiveMacros.kcal && profile.adaptiveMacros.prot && profile.adaptiveMacros.carb && profile.adaptiveMacros.fat) {
                const override = profile.adaptiveMacros;
                const zuccheriOverride = override.zuccheri != null ? override.zuccheri : Math.round(override.carb * 0.25);
                return {
                    kcal: override.kcal,
                    prot: override.prot,
                    carb: override.carb,
                    zuccheri: zuccheriOverride,
                    fat: override.fat
                };
            }
            const weight = Number(profile.weight) || 0;
            const kcal = calculateDailyKcalTarget(profile);
            let protPerKg = 1.8;
            let fatPerKg = 0.9;
            if (profile.goal === 'cut') {
                protPerKg = 2.2;
                fatPerKg = 0.8;
            } else if (profile.goal === 'massa') {
                protPerKg = 2.1;
                fatPerKg = 1.0;
            }
            const prot = Math.round(Math.max(80, protPerKg * weight));
            const fat = Math.round(Math.max(40, fatPerKg * weight));
            const kcalFromProt = prot * 4;
            const kcalFromFat = fat * 9;
            const remainingKcal = Math.max(0, kcal - kcalFromProt - kcalFromFat);
            const carb = Math.round(remainingKcal / 4);
            const zuccheri = Math.round(carb * 0.25);
            return {
                kcal,
                prot,
                carb,
                zuccheri,
                fat
            };
        }

        function getPianoDelGiornoForDate(dateObj) {
            const giornoSettimana = dateObj.getDay();
            if (isUserProfileComplete(userProfile)) {
                const macros = calculateMacroTargets(userProfile);
                const trainingDays = Array.isArray(userProfile.trainingDays) ? userProfile.trainingDays : [];
                const isTrainingDay = trainingDays.includes(giornoSettimana);
                const goalLabels = { cut: 'Deficit', massa: 'Massa', mantenimento: 'Mantenimento' };
                const goalEmojis = { cut: 'üíß', massa: 'üî•', mantenimento: '‚öñÔ∏è' };
                const baseLabel = goalLabels[userProfile.goal] || 'Personalizzato';
                const emoji = goalEmojis[userProfile.goal] || 'üçΩÔ∏è';
                const trainingLabel = isTrainingDay ? 'Allenamento' : 'Riposo';
                const tipo = `${emoji} ${baseLabel} (${trainingLabel})`;
                return {
                    tipo,
                    cal_base: macros.kcal,
                    prot: macros.prot,
                    carb: macros.carb,
                    zuccheri: macros.zuccheri
                };
            }
            return PIANO_SETTIMANALE[giornoSettimana] || PIANO_SETTIMANALE[1];
        }

        function getUserProfileCompleted() {
            try {
                const v = localStorage.getItem(USER_PROFILE_COMPLETED_LOCAL_KEY);
                if (v === null || v === undefined) return false;
                return v === 'true';
            } catch (e) {
                return false;
            }
        }

        async function setUserProfileCompleted(completed) {
            const val = completed ? 'true' : 'false';
            try {
                localStorage.setItem(USER_PROFILE_COMPLETED_LOCAL_KEY, val);
            } catch (e) {
                console.error('Errore salvataggio flag profilo completato', e);
            }
            if (db && currentUserUID) {
                try {
                    await set(ref(db, `users/${currentUserUID}/${USER_PROFILE_COMPLETED_CLOUD_PATH}`), completed);
                } catch (e) {
                    console.error('Errore salvataggio flag profilo completato su cloud', e);
                }
            }
        }

        async function getUserProfileCompletedFromCloud() {
            if (!db || !currentUserUID) return null;
            try {
                const snap = await get(ref(db, `users/${currentUserUID}/${USER_PROFILE_COMPLETED_CLOUD_PATH}`));
                return snap.exists() ? !!snap.val() : null;
            } catch (e) {
                return null;
            }
        }

        function applyProfileSectionVisibility() {
            if (!userProfileSection) return;
            userProfileSection.style.display = getUserProfileCompleted() ? 'none' : 'block';
        }

        function loadUserProfileFromLocal() {
            try {
                const raw = localStorage.getItem(USER_PROFILE_LOCAL_KEY);
                if (!raw) return null;
                const parsed = JSON.parse(raw);
                return parsed && typeof parsed === 'object' ? parsed : null;
            } catch (e) {
                console.error('Errore lettura profilo locale', e);
                return null;
            }
        }

        async function loadUserProfileFromCloud() {
            if (!db || !currentUserUID) return null;
            try {
                const snapshot = await get(ref(db, `users/${currentUserUID}/${USER_PROFILE_CLOUD_PATH}`));
                if (!snapshot.exists()) return null;
                return snapshot.val();
            } catch (e) {
                console.error('Errore lettura profilo cloud', e);
                return null;
            }
        }

        function readProfileFromForm() {
            const trainingDays = Array.from(profileTrainingDayCheckboxes)
                .filter(cb => cb.checked)
                .map(cb => parseInt(cb.value, 10))
                .filter(v => !isNaN(v));
            const mealTimes = {};
            Object.keys(profileMealtimeInputs).forEach(key => {
                const el = profileMealtimeInputs[key];
                if (el && el.value) mealTimes[key] = el.value;
            });
            const useManualTargets = document.getElementById('profile-targets-manual')?.checked || false;
            const manualKcal = document.getElementById('profile-manual-kcal')?.value;
            const manualProt = document.getElementById('profile-manual-prot')?.value;
            const manualCarb = document.getElementById('profile-manual-carb')?.value;
            const manualFat = document.getElementById('profile-manual-fat')?.value;
            const manualTargets = (useManualTargets && manualKcal && manualProt && manualCarb && manualFat)
                ? { kcal: Number(manualKcal), prot: Number(manualProt), carb: Number(manualCarb), fat: Number(manualFat) }
                : (userProfile?.manualTargets || null);
            return {
                sex: profileSexSelect?.value || '',
                age: profileAgeInput?.value ? Number(profileAgeInput.value) : null,
                height: profileHeightInput?.value ? Number(profileHeightInput.value) : null,
                weight: profileWeightInput?.value ? Number(profileWeightInput.value) : null,
                goal: profileGoalSelect?.value || '',
                activityLevel: profileActivitySelect?.value || '',
                trainingDays,
                mealTimes,
                useManualTargets,
                manualTargets
            };
        }

        function writeProfileToForm(profile) {
            if (!profile) return;
            if (profileSexSelect) profileSexSelect.value = profile.sex || '';
            if (profileAgeInput && profile.age != null) profileAgeInput.value = profile.age;
            if (profileHeightInput && profile.height != null) profileHeightInput.value = profile.height;
            if (profileWeightInput && profile.weight != null) profileWeightInput.value = profile.weight;
            if (profileGoalSelect) profileGoalSelect.value = profile.goal || '';
            if (profileActivitySelect) profileActivitySelect.value = profile.activityLevel || '';
            const trainingDays = Array.isArray(profile.trainingDays) ? profile.trainingDays : [];
            profileTrainingDayCheckboxes.forEach(cb => {
                const val = parseInt(cb.value, 10);
                cb.checked = trainingDays.includes(val);
            });
            if (profile.mealTimes && typeof profile.mealTimes === 'object') {
                Object.keys(profileMealtimeInputs).forEach(key => {
                    const el = profileMealtimeInputs[key];
                    if (!el) return;
                    el.value = profile.mealTimes[key] || '';
                });
            }
            const useManual = !!profile.useManualTargets;
            const autoRadio = document.getElementById('profile-targets-auto');
            const manualRadio = document.getElementById('profile-targets-manual');
            const manualWrap = document.getElementById('profile-manual-targets-wrap');
            if (autoRadio) autoRadio.checked = !useManual;
            if (manualRadio) manualRadio.checked = useManual;
            if (manualWrap) manualWrap.style.display = useManual ? 'grid' : 'none';
            const m = profile.manualTargets;
            if (m) {
                const kcalEl = document.getElementById('profile-manual-kcal');
                const protEl = document.getElementById('profile-manual-prot');
                const carbEl = document.getElementById('profile-manual-carb');
                const fatEl = document.getElementById('profile-manual-fat');
                if (kcalEl && m.kcal != null) kcalEl.value = m.kcal;
                if (protEl && m.prot != null) protEl.value = m.prot;
                if (carbEl && m.carb != null) carbEl.value = m.carb;
                if (fatEl && m.fat != null) fatEl.value = m.fat;
            }
        }

        function updateProfileSummary(profile) {
            if (!profileTargetKcalSpan || !profileTargetProtSpan || !profileTargetCarbSpan || !profileTargetFatSpan) return;
            const sourceEl = document.getElementById('profile-target-source');
            const canShowMacros = profile && (isUserProfileComplete(profile) || (profile.useManualTargets && profile.manualTargets && profile.manualTargets.kcal && profile.manualTargets.prot && profile.manualTargets.carb && profile.manualTargets.fat));
            if (!canShowMacros) {
                profileTargetKcalSpan.textContent = '-';
                profileTargetProtSpan.textContent = '-';
                profileTargetCarbSpan.textContent = '-';
                profileTargetFatSpan.textContent = '-';
                if (sourceEl) sourceEl.textContent = '';
                return;
            }
            const macros = calculateMacroTargets(profile);
            profileTargetKcalSpan.textContent = macros.kcal.toFixed(0);
            profileTargetProtSpan.textContent = macros.prot.toFixed(0);
            profileTargetCarbSpan.textContent = macros.carb.toFixed(0);
            profileTargetFatSpan.textContent = macros.fat.toFixed(0);
            if (sourceEl) sourceEl.textContent = profile && profile.useManualTargets ? '(target personalizzati)' : '';
        }

        function loadAutoAdjustHistoryFromLocal() {
            try {
                const raw = localStorage.getItem(AUTO_ADJUST_HISTORY_LOCAL_KEY);
                if (!raw) return [];
                const parsed = JSON.parse(raw);
                return Array.isArray(parsed) ? parsed : [];
            } catch (e) {
                console.error('Errore lettura storico adattamenti', e);
                return [];
            }
        }

        function loadAdherenceScoresFromLocal() {
            try {
                const raw = localStorage.getItem(ADHERENCE_SCORES_LOCAL_KEY);
                if (!raw) return {};
                const parsed = JSON.parse(raw);
                return parsed && typeof parsed === 'object' ? parsed : {};
            } catch (e) {
                console.error('Errore lettura aderenza', e);
                return {};
            }
        }

        async function saveAutoAdjustHistoryEntry(entry) {
            const history = loadAutoAdjustHistoryFromLocal();
            history.push(entry);
            try {
                localStorage.setItem(AUTO_ADJUST_HISTORY_LOCAL_KEY, JSON.stringify(history));
            } catch (e) {
                console.error('Errore salvataggio storico adattamenti locale', e);
            }
            if (db && currentUserUID) {
                try {
                    await set(ref(db, `users/${currentUserUID}/${AUTO_ADJUST_HISTORY_CLOUD_PATH}`), history);
                    await set(ref(db, `users/${currentUserUID}/${CLOUD_LAST_UPDATE_PATH}`), Date.now());
                    localStorage.setItem(LOCAL_LAST_UPDATE_KEY, Date.now());
                } catch (e) {
                    console.error('Errore salvataggio storico adattamenti cloud', e);
                }
            }
        }

        function saveOrUpdatePeso(dateString, pesoValue) {
            if (!dateString || !pesoValue) return;
            let stored;
            try {
                const raw = localStorage.getItem('trackerPesate');
                stored = raw ? JSON.parse(raw) : [];
            } catch (e) {
                stored = [];
            }
            let arr;
            if (Array.isArray(stored)) {
                arr = stored;
            } else if (stored && typeof stored === 'object') {
                arr = Object.keys(stored).map(k => ({ data: k, peso: stored[k] }));
            } else {
                arr = [];
            }
            const existing = arr.find(e => e.data === dateString || e.date === dateString);
            if (existing) {
                existing.peso = pesoValue;
                existing.date = dateString;
                existing.data = dateString;
            } else {
                arr.push({ data: dateString, date: dateString, peso: pesoValue });
            }
            try {
                localStorage.setItem('trackerPesate', JSON.stringify(arr));
                localStorage.setItem(LOCAL_LAST_UPDATE_KEY, Date.now());
            } catch (e) {
                console.error('Errore salvataggio peso', e);
            }
            saveSingleItemToCloud('trackerPesate', arr);
        }

        function getPesoForDate(dateString) {
            try {
                const raw = localStorage.getItem('trackerPesate');
                if (!raw) return null;
                const parsed = JSON.parse(raw);
                if (Array.isArray(parsed)) {
                    const found = parsed.find(p => p.data === dateString || p.date === dateString);
                    return found ? Number(found.peso || found.weight || found.value) || null : null;
                }
                if (parsed && typeof parsed === 'object') {
                    const val = parsed[dateString];
                    return val != null ? Number(val) || null : null;
                }
            } catch (e) {
                console.error('Errore lettura peso storico', e);
            }
            return null;
        }

        function computeDailyTotalsForDate(dateString) {
            const raw = localStorage.getItem(`trackerStorico_${dateString}`);
            if (!raw) return null;
            let dayData;
            try {
                dayData = JSON.parse(raw);
            } catch (e) {
                console.error('Errore parsing dati giorno per adattamento', e);
                return null;
            }
            if (!dayData || !Array.isArray(dayData.log)) {
                return null;
            }
            // migrazione cal -> kcal se necessario
            dayData.log.forEach(entry => {
                const items = entry.type === 'meal' ? entry.items : [entry];
                items.forEach(item => {
                    if (item && item.cal && !item.kcal) {
                        item.kcal = item.cal;
                        delete item.cal;
                    }
                });
            });
            const totals = {
                prot: 0,
                kcal: 0,
                fatTotal: 0,
                carb: 0,
                zuccheri: 0
            };
            let workoutCalories = 0;
            let workoutCount = 0;
            (dayData.log || []).forEach(entry => {
                if (entry.type === 'workout') {
                    workoutCalories += entry.kcal || entry.calorie || entry.calories || 0;
                    workoutCount += 1;
                    return;
                }
                const items = entry.type === 'meal' ? entry.items : [entry];
                items.forEach(item => {
                    if (!item) return;
                    totals.prot += item.prot || 0;
                    totals.kcal += (item.kcal || item.cal) || 0;
                    totals.fatTotal += item.fatTotal || 0;
                    totals.carb += item.carb || 0;
                    totals.zuccheri += item.zuccheri || 0;
                });
            });
            return {
                totals,
                workoutCalories: workoutCalories + (dayData.workoutCalorie || 0),
                workoutCount,
                peso: getPesoForDate(dateString)
            };
        }

        function computeAdherenceScore(intake, targetKcal, targetProt) {
            if (!targetKcal || !targetProt) return 0;
            const kcalDiffPerc = Math.abs((intake.kcal || 0) - targetKcal) / Math.max(1, targetKcal);
            const protDiffPerc = Math.abs((intake.prot || 0) - targetProt) / Math.max(1, targetProt);
            let score = 100;
            score -= Math.min(60, kcalDiffPerc * 100);
            score -= Math.min(40, protDiffPerc * 100);
            return Math.max(0, Math.round(score));
        }

        function analyzeLast7DaysForAutoAdaptation() {
            const today = new Date(giornoVisualizzato || getTodayString('ymd'));
            const days = [];
            let totalDiffKcal = 0;
            let totalDiffProt = 0;
            let totalWorkoutCalories = 0;
            let totalWorkoutCount = 0;
            let weightStart = null;
            let weightEnd = null;
            let validDays = 0;
            let totalAdherence = 0;
            for (let i = 0; i < 14; i++) {
                const d = new Date(today);
                d.setDate(d.getDate() - i);
                const dateString = d.toISOString().split('T')[0];
                const dayTotals = computeDailyTotalsForDate(dateString);
                if (!dayTotals) continue;
                const piano = getPianoDelGiornoForDate(d);
                const targetKcal = piano.cal_base + (dayTotals.workoutCalories || 0);
                const targetProt = piano.prot;
                const diffKcal = (dayTotals.totals.kcal || 0) - targetKcal;
                const diffProt = (dayTotals.totals.prot || 0) - targetProt;
                const adherenceScore = computeAdherenceScore(dayTotals.totals, targetKcal, targetProt);
                totalDiffKcal += diffKcal;
                totalDiffProt += diffProt;
                totalWorkoutCalories += dayTotals.workoutCalories || 0;
                totalWorkoutCount += dayTotals.workoutCount || 0;
                totalAdherence += adherenceScore;
                if (dayTotals.peso != null) {
                    if (weightEnd == null) weightEnd = dayTotals.peso;
                    weightStart = dayTotals.peso;
                }
                validDays += 1;
                days.push({
                    date: dateString,
                    intake: dayTotals.totals,
                    targetKcal,
                    targetProt,
                    diffKcal,
                    diffProt,
                    workoutCalories: dayTotals.workoutCalories,
                    peso: dayTotals.peso,
                    adherenceScore
                });
            }
            if (!validDays) return null;
            const avgDiffKcal = totalDiffKcal / validDays;
            const avgDiffProt = totalDiffProt / validDays;
            const avgWorkoutCalories = totalWorkoutCalories / validDays;
            const avgWorkoutPerDay = totalWorkoutCount / validDays;
            const weightDelta = (weightStart != null && weightEnd != null) ? (weightEnd - weightStart) : null;
            const avgAdherenceScore = totalAdherence / validDays;
            let state = 'stallo';
            if (weightDelta != null) {
                const weightPerWeek = weightDelta / (validDays / 7);
                if (weightPerWeek <= -0.25) {
                    state = 'deficit_reale';
                } else if (weightPerWeek >= 0.25) {
                    state = 'surplus_reale';
                }
            } else {
                if (avgDiffKcal <= -250) state = 'deficit_reale';
                else if (avgDiffKcal >= 250) state = 'surplus_reale';
            }
            return {
                periodStart: days.length ? days[days.length - 1].date : null,
                periodEnd: days.length ? days[0].date : null,
                days,
                state,
                metrics: {
                    validDays,
                    avgDiffKcal,
                    avgDiffProt,
                    avgWorkoutCalories,
                    avgWorkoutPerDay,
                    weightDelta,
                    avgAdherenceScore
                }
            };
        }

        async function runWeeklyAutoAdaptationIfNeeded() {
            if (!isUserProfileComplete(userProfile)) return;
            const nowTs = Date.now();
            const lastRun = parseInt(localStorage.getItem(AUTO_ADJUST_LAST_RUN_KEY) || '0', 10);
            const sevenDaysMs = 7 * 24 * 60 * 60 * 1000;
            if (lastRun && (nowTs - lastRun) < sevenDaysMs) return;
            const analysis = analyzeLast7DaysForAutoAdaptation();
            if (!analysis || analysis.metrics.validDays < 7) {
                localStorage.setItem(AUTO_ADJUST_LAST_RUN_KEY, String(nowTs));
                return;
            }
            const baseProfile = { ...(userProfile || {}) };
            delete baseProfile.adaptiveMacros;
            const currentTargets = calculateMacroTargets(baseProfile);
            const avgDiffKcal = analysis.metrics.avgDiffKcal;
            const avgDiffProt = analysis.metrics.avgDiffProt;
            let kcalDelta = 0;
            let protDelta = 0;
            const goal = userProfile.goal || 'mantenimento';
            if (goal === 'cut') {
                if (avgDiffKcal > -100) {
                    kcalDelta = -150;
                } else if (avgDiffKcal < -700) {
                    kcalDelta = 150;
                }
            } else if (goal === 'massa') {
                if (avgDiffKcal < 100) {
                    kcalDelta = 150;
                } else if (avgDiffKcal > 500) {
                    kcalDelta = -150;
                }
            } else {
                if (avgDiffKcal > 200) {
                    kcalDelta = -150;
                } else if (avgDiffKcal < -200) {
                    kcalDelta = 150;
                }
            }
            if (avgDiffProt < -15) {
                protDelta = 10;
            } else if (avgDiffProt > 25) {
                protDelta = -10;
            }
            if (kcalDelta === 0 && protDelta === 0) {
                localStorage.setItem(AUTO_ADJUST_LAST_RUN_KEY, String(nowTs));
                return;
            }
            const weight = Number(userProfile.weight) || 0;
            const minProt = Math.max(80, Math.round(weight * 1.6));
            const maxProt = Math.round(weight * 2.6);
            const newKcal = Math.max(1400, currentTargets.kcal + kcalDelta);
            let newProt = currentTargets.prot + protDelta;
            newProt = Math.max(minProt, Math.min(maxProt, newProt));
            const fat = currentTargets.fat;
            const kcalFromProt = newProt * 4;
            const kcalFromFat = fat * 9;
            const remainingKcal = Math.max(0, newKcal - kcalFromProt - kcalFromFat);
            const carb = Math.round(remainingKcal / 4);
            const zuccheri = Math.round(carb * 0.25);
            const newTargets = {
                kcal: Math.round(newKcal),
                prot: Math.round(newProt),
                carb,
                zuccheri,
                fat
            };
            if (!userProfile.useManualTargets) {
                userProfile.adaptiveMacros = newTargets;
            }
            await saveUserProfile(userProfile);
            const historyEntry = {
                id: nowTs,
                timestamp: nowTs,
                goal,
                periodStart: analysis.periodStart,
                periodEnd: analysis.periodEnd,
                state: analysis.state,
                metrics: analysis.metrics,
                targetsBefore: currentTargets,
                targetsAfter: newTargets
            };
            await saveAutoAdjustHistoryEntry(historyEntry);
            const adherenceMap = loadAdherenceScoresFromLocal();
            analysis.days.forEach(d => {
                if (d.adherenceScore != null) adherenceMap[d.date] = d.adherenceScore;
            });
            try {
                localStorage.setItem(ADHERENCE_SCORES_LOCAL_KEY, JSON.stringify(adherenceMap));
            } catch (e) {
                console.error('Errore salvataggio aderenza', e);
            }
            localStorage.setItem(AUTO_ADJUST_LAST_RUN_KEY, String(nowTs));
        }

        async function saveUserProfile(profile) {
            userProfile = profile;
            try {
                localStorage.setItem(USER_PROFILE_LOCAL_KEY, JSON.stringify(profile));
            } catch (e) {
                console.error('Errore salvataggio profilo locale', e);
            }
            if (db && currentUserUID) {
                try {
                    await set(ref(db, `users/${currentUserUID}/${USER_PROFILE_CLOUD_PATH}`), profile);
                    await set(ref(db, `users/${currentUserUID}/${CLOUD_LAST_UPDATE_PATH}`), Date.now());
                    localStorage.setItem(LOCAL_LAST_UPDATE_KEY, Date.now());
                } catch (e) {
                    console.error('Errore salvataggio profilo cloud', e);
                }
            }
            updateProfileSummary(profile);
            if (isUserProfileComplete(profile)) {
                aggiornaUI();
                renderMealBuilder();
            }
        }

        function onProfileSavedSuccess(profile) {
            const completed = isUserProfileComplete(profile);
            if (completed) {
                setUserProfileCompleted(true);
                if (userProfileSection) userProfileSection.style.display = 'none';
            } else {
                applyProfileSectionVisibility();
            }
        }
        
        async function saveSingleItemToCloud(path, data) {
            const dataRef = (db && currentUserUID) ? ref(db, `users/${currentUserUID}/tracker_data/${path}`) : null;
            if (!dataRef) return;
            try {
                await set(dataRef, data);
                await set(ref(db, `users/${currentUserUID}/${CLOUD_LAST_UPDATE_PATH}`), Date.now());
                console.log(`Dato salvato su cloud in: ${path}`);
            } catch (err) {
                console.error(`Errore salvataggio su cloud per ${path}:`, err);
            }
        }
        
        function salvaFoodDatabase() { 
            localStorage.setItem('trackerFoodDatabase', JSON.stringify(foodDatabase)); 
            localStorage.setItem(LOCAL_LAST_UPDATE_KEY, Date.now()); 
            
            const sanitizedDb = {};
            for (const key in foodDatabase) {
                sanitizedDb[sanitizeFirebaseKey(key)] = foodDatabase[key];
            }
            saveSingleItemToCloud('trackerFoodDatabase', sanitizedDb);
        }
        
       function salvaPastoInCostruzione() { 
    // Sincronizza sempre con window prima di salvare
    window.pastoInCostruzione = pastoInCostruzione;
    localStorage.setItem('trackerPastoInCostruzione', JSON.stringify(pastoInCostruzione)); 
    localStorage.setItem(LOCAL_LAST_UPDATE_KEY, Date.now()); 
    saveSingleItemToCloud('trackerPastoInCostruzione', pastoInCostruzione);
}
        
        
        function salvaGiorno(dataDaSalvare, datiDaSalvare) {
            if (!datiDaSalvare) datiDaSalvare = datiGiornalieri;
            datiDaSalvare.note = dailyNotesTextarea.value;
            datiDaSalvare.data = dataDaSalvare;
            const key = `trackerStorico_${dataDaSalvare}`;
            localStorage.setItem(key, JSON.stringify(datiDaSalvare));
            localStorage.setItem(LOCAL_LAST_UPDATE_KEY, Date.now());
            console.log(`Dati salvati LOCALMENTE per il giorno: ${dataDaSalvare}`);
            saveSingleItemToCloud(key, datiDaSalvare);
        }
        
        function caricaGiorno(data) {
            giornoVisualizzato = data;
            dataCaricamentoInput.value = data;

            let datiTrovati = null;
            let rawDataFromLocalStorage = localStorage.getItem(`trackerStorico_${data}`);
            try {
                datiTrovati = JSON.parse(rawDataFromLocalStorage);
                 if (datiTrovati && datiTrovati.log) {
                    datiTrovati.log.forEach(entry => {
                        const items = entry.type === 'meal' ? entry.items : [entry];
                        items.forEach(item => {
                            if (item && item.cal && !item.kcal) {
                                item.kcal = item.cal;
                                delete item.cal;
                            }
                        });
                    });
                }
            } catch (e) {
                console.error(`Errore nel parsing di trackerStorico_${data}:`, e, "Raw data:", rawDataFromLocalStorage);
            }
            
            datiGiornalieri = datiTrovati || { log: [], workoutCalorie: 0, note: '' };
            dailyNotesTextarea.value = datiGiornalieri.note || '';
            if (!datiGiornalieri.log) datiGiornalieri.log = [];
            normalizeLogTimes(datiGiornalieri.log);
            if (typeof datiGiornalieri.workoutCalorie === 'undefined') datiGiornalieri.workoutCalorie = 0;

            const dataCorrente = new Date(data);
            const giornoSettimana = dataCorrente.getDay(); 
            const valorePreimpostatoPerGiorno = DEFICIT_PREIMPOSTATO_SETTIMANALE[giornoSettimana] || 0;

            if (typeof datiGiornalieri.calorieAdjustment === 'undefined' || datiGiornalieri.calorieAdjustment === 0) {
                datiGiornalieri.calorieAdjustment = valorePreimpostatoPerGiorno;
            }
            
            aggiornaUI();
            fillStrategiaForm();
            console.log(`Caricato il giorno: ${giornoVisualizzato} da localStorage`); 
        }

        function hasDailyStrategy() {
            const s = getDailyStrategy(giornoVisualizzato);
            return !!(s && (s.kcalTarget != null || s.protTarget != null || (s.meals_timing && Object.keys(s.meals_timing).length)));
        }
        function openStrategiaCollapsible() {
            const header = document.getElementById('strategia-header');
            const content = document.getElementById('strategia-content');
            if (header && content) {
                header.classList.add('expanded');
                content.classList.add('expanded');
                if (header.querySelector('.arrow')) header.querySelector('.arrow').textContent = '‚ñº';
            }
        }
        function closeStrategiaCollapsible() {
            const header = document.getElementById('strategia-header');
            const content = document.getElementById('strategia-content');
            if (header && content) {
                header.classList.remove('expanded');
                content.classList.remove('expanded');
                if (header.querySelector('.arrow')) header.querySelector('.arrow').textContent = '‚ñ∂';
            }
        }
        function syncStrategiaCollapsibleState() {
            if (getAppMode() !== 'coach') return;
            if (hasDailyStrategy()) closeStrategiaCollapsible(); else openStrategiaCollapsible();
        }
        function fillStrategiaForm() {
            const s = getDailyStrategy(giornoVisualizzato);
            const setVal = (id, v) => { const el = document.getElementById(id); if (el) el.value = (v != null && v !== '') ? String(v) : ''; };
            setVal('strategia-kcal', s && s.kcalTarget != null ? s.kcalTarget : '');
            setVal('strategia-prot', s && s.protTarget != null ? s.protTarget : '');
            setVal('strategia-tipo', s && s.tipoGiornata ? s.tipoGiornata : '');
            setVal('strategia-focus', s && s.focus ? s.focus : '');
            setVal('strategia-note', s && s.note ? s.note : '');
            setVal('strategia-timing', s && s.timingPasti ? s.timingPasti : '');
            const badge = document.getElementById('strategia-badge');
            const btnModifica = document.getElementById('btn-modifica-strategia');
            const btnRimuovi = document.getElementById('btn-rimuovi-strategia');
            const hasStrategy = getAppMode() === 'coach' && hasDailyStrategy();
            if (badge) badge.style.display = hasStrategy ? 'inline' : 'none';
            if (btnModifica) btnModifica.style.display = hasStrategy ? 'inline-block' : 'none';
            if (btnRimuovi) btnRimuovi.style.display = hasStrategy ? 'inline-block' : 'none';
        }

        const STRATEGIA_TIMING_WINDOW_MIN = 90;
        function timeStrToMinutes(t) {
            if (!t || typeof t !== 'string') return 0;
            const [h, m] = t.trim().split(':').map(Number);
            return (isFinite(h) ? h : 0) * 60 + (isFinite(m) ? m : 0);
        }
        function computeTimingAdherence(log, meals_timing) {
            if (!meals_timing || typeof meals_timing !== 'object') return [];
            const mealTimes = [];
            (log || []).forEach(entry => {
                if (entry.type === 'workout') return;
                mealTimes.push(timeStrToMinutes(getEntryTime(entry)));
            });
            const result = [];
            const slotLabels = { breakfast: 'Colazione', lunch: 'Pranzo', snack: 'Spuntino', dinner: 'Cena' };
            Object.keys(meals_timing).forEach(slotKey => {
                const slot = meals_timing[slotKey];
                const slotTime = (slot && slot.time) ? String(slot.time).trim() : '';
                const slotType = (slot && slot.type) ? String(slot.type) : '';
                if (!slotTime) return;
                const slotMin = timeStrToMinutes(slotTime);
                const low = slotMin - STRATEGIA_TIMING_WINDOW_MIN;
                const high = slotMin + STRATEGIA_TIMING_WINDOW_MIN;
                const found = mealTimes.some(entryMin => entryMin >= low && entryMin <= high);
                result.push({
                    slotKey,
                    label: slotLabels[slotKey] || slotKey,
                    time: slotTime,
                    type: slotType,
                    status: found ? 'ok' : 'missing'
                });
            });
            return result;
        }
        function renderStrategiaTimingAdherence() {
            const block = document.getElementById('strategia-timing-adherence');
            if (!block) return;
            if (getAppMode() !== 'coach') { block.style.display = 'none'; return; }
            const s = getDailyStrategy(giornoVisualizzato);
            const mt = s && s.meals_timing && Object.keys(s.meals_timing).length > 0 ? s.meals_timing : null;
            if (!mt) {
                block.style.display = 'none';
                return;
            }
            const adherence = computeTimingAdherence(datiGiornalieri.log || [], mt);
            if (adherence.length === 0) {
                block.style.display = 'none';
                return;
            }
            block.style.display = 'block';
            const lines = adherence.map(a => {
                const typeStr = a.type ? ` (${a.type})` : '';
                if (a.status === 'ok') return `<span style="color:#2e7d32;">‚úì ${a.label} ${a.time}${typeStr}: in orario</span>`;
                return `<span style="color:#c62828;">‚úó ${a.label} ${a.time}${typeStr}: non registrato</span>`;
            });
            block.innerHTML = '<strong>Aderenza timing strategia</strong><br>' + lines.join('<br>');
        }

        function calcolaObiettiviPasto(mealType, giornoCorrenteString) {
            const dataVisualizzata = new Date(giornoCorrenteString);
            const pianoDelGiorno = getPianoDelGiornoForDate(dataVisualizzata);
            const strategy = getAppMode() === 'coach' ? getDailyStrategy(giornoCorrenteString) : null;
            let obiettivoCalTotaleGiornaliero = pianoDelGiorno.cal_base + (datiGiornalieri.workoutCalorie || 0) + (datiGiornalieri.calorieAdjustment || 0);
            if (strategy && strategy.kcalTarget != null) obiettivoCalTotaleGiornaliero = Number(strategy.kcalTarget);
            const obiettivoProtTotaleGiornaliero = (strategy && strategy.protTarget != null) ? Number(strategy.protTarget) : pianoDelGiorno.prot;

            let obiettivoPastoProt = 0, obiettivoPastoCal = 0;
            const calRatio = OBIETTIVI_MACRO_PASTO_BASE_FORZA[mealType]?.cal_perc ?? 0;
            const protRatio = OBIETTIVI_MACRO_PASTO_BASE_FORZA[mealType]?.prot_perc ?? 0;

            if (mealType === 'cena') {
                let consumatoProtAltriPasti = 0, consumatoCalAltriPasti = 0;
                (datiGiornalieri.log || []).forEach(entry => {
                    if (entry.mealId && entry.mealId !== 'cena') {
                        const items = entry.type === 'meal' ? entry.items : [entry];
                        items.forEach(item => {
                           consumatoProtAltriPasti += item.prot || 0;
                           consumatoCalAltriPasti += (item.kcal || item.cal) || 0;
                        });
                    }
                });
                obiettivoPastoProt = Math.max(0, Math.round(obiettivoProtTotaleGiornaliero - consumatoProtAltriPasti));
                obiettivoPastoCal = Math.max(0, Math.round(obiettivoCalTotaleGiornaliero - consumatoCalAltriPasti));
            } else {
                obiettivoPastoProt = Math.round(obiettivoProtTotaleGiornaliero * protRatio);
                obiettivoPastoCal = Math.round(obiettivoCalTotaleGiornaliero * calRatio);
            }
            
            const totaliPastoInCostruzione = pastoInCostruzione.reduce((acc, item) => {
                acc.prot += item.prot || 0; acc.kcal += (item.kcal || item.cal) || 0; return acc;
            }, { prot: 0, kcal: 0 });

            return {
                currentProt: totaliPastoInCostruzione.prot, targetProt: obiettivoPastoProt, remainingProt: obiettivoPastoProt - totaliPastoInCostruzione.prot,
                currentCal: totaliPastoInCostruzione.kcal, targetCal: obiettivoPastoCal, remainingCal: obiettivoPastoCal - totaliPastoInCostruzione.kcal
            };
        }

        function initAppUI() {
            foodDatabase = JSON.parse(localStorage.getItem('trackerFoodDatabase')) || {};
            pastoInCostruzione = window.pastoInCostruzione || JSON.parse(localStorage.getItem('trackerPastoInCostruzione')) || [];
window.pastoInCostruzione = pastoInCostruzione; // Mantieni sincronizzato
            pastoInCostruzione.forEach(item => {
                if (item.cal && !item.kcal) {
                    item.kcal = item.cal;
                    delete item.cal;
                }
            });
            userProfile = loadUserProfileFromLocal();
            applyProfileSectionVisibility();
            if (userProfile) {
                writeProfileToForm(userProfile);
                updateProfileSummary(userProfile);
            }
            renderMealBuilder();
            caricaGiorno(getTodayString());
            updateModeVisibility();
            runWeeklyAutoAdaptationIfNeeded();
            
            if (mealTypeSelector) { 
                const lastMealTypeSelected = localStorage.getItem('lastMealTypeSelected_' + getTodayString());
                mealTypeSelector.value = (lastMealTypeSelected && MEAL_TYPE_SEQUENCE.includes(lastMealTypeSelected)) ? lastMealTypeSelected : MEAL_TYPE_SEQUENCE[0];
            }
            setMealBuilderTimeDefault();
            initMealBuilderTimeDesktop();
            console.log("Interfaccia app avviata con successo con dati locali.");
        }

        function aggiornaUI() {
            const dataVisualizzata = new Date(giornoVisualizzato);
            const pianoDelGiorno = getPianoDelGiornoForDate(dataVisualizzata);
            const dailyStrategy = getAppMode() === 'coach' ? getDailyStrategy(giornoVisualizzato) : null;
            let obiettivoCalorieTotale = pianoDelGiorno.cal_base + (datiGiornalieri.workoutCalorie || 0) + (datiGiornalieri.calorieAdjustment || 0);
            if (dailyStrategy && dailyStrategy.kcalTarget != null) obiettivoCalorieTotale = Number(dailyStrategy.kcalTarget);
            const obiettivoProt = (dailyStrategy && dailyStrategy.protTarget != null) ? Number(dailyStrategy.protTarget) : pianoDelGiorno.prot;
            const OBIETTIVI = { 
                prot: obiettivoProt, kcal: obiettivoCalorieTotale, carb: pianoDelGiorno.carb, zuccheri: pianoDelGiorno.zuccheri, 
                ...OBIETTIVI_MICRO, ...OBIETTIVI_FAT, ...OBIETTIVI_VIT, ...OBIETTIVI_AMINO, ...OBIETTIVI_FIBRE
            };
            
            updateTitoloPanel(dataVisualizzata, pianoDelGiorno, dailyStrategy);

            let totali = { 
                prot: 0, kcal: 0, carb: 0, zuccheri: 0, fatTotal: 0, fatSat: 0, fatTrans: 0, fatMono: 0, fatPoly: 0, omega3: 0, omega6: 0, 
                na: 0, mg: 0, k: 0, vitc: 0, ca: 0, fe: 0, zn: 0, cu: 0, p: 0, vitA: 0, vitB12: 0, vitD: 0, vitE: 0, vitK: 0, b9: 0, b2: 0, b6: 0,
                leu: 0, iso: 0, val: 0, lys: 0, met: 0, phe: 0, thr: 0, trp: 0, his: 0,
                fibreTotali: 0, fibreSolubili: 0, fibreInsolubili: 0, sale: 0
            };
            
            (datiGiornalieri.log || []).forEach(entry => {
                if (entry.type !== 'workout') {
                    const items = entry.type === 'meal' ? entry.items : [entry];
                    items.forEach(item => {
                        for(const key in totali){
                            totali[key] += item[key] || 0;
                        }
                        if(item.cal && !item.kcal) totali.kcal += item.cal;
                    });
                }
            });

            totali.fatUnsat = totali.fatMono + totali.fatPoly;

            // UPDATE BALANCE BAR
            const sodiumVal = totali.na || 0;
            const potassiumVal = totali.k || 0;
            
            document.getElementById('valore-sodio').textContent = `${sodiumVal.toFixed(0)} mg`;
            document.getElementById('valore-potassio').textContent = `${potassiumVal.toFixed(0)} mg`;

            const balanceMarker = document.getElementById('balance-marker');
            let balancePercentage = 50; 

            if (sodiumVal + potassiumVal > 0) {
                const kRatio = potassiumVal / (sodiumVal + potassiumVal);
                balancePercentage = kRatio * 100;
            }
            
            balancePercentage = Math.max(5, Math.min(95, balancePercentage));
            balanceMarker.style.left = `${balancePercentage}%`;


            spanObiettivoProteine.textContent = OBIETTIVI.prot; spanTotaleProteine.textContent = totali.prot.toFixed(1); progressProteine.max = OBIETTIVI.prot; progressProteine.value = totali.prot;
            spanObiettivoCalorie.textContent = OBIETTIVI.kcal; spanTotaleCalorie.textContent = totali.kcal.toFixed(0); progressCalorie.max = OBIETTIVI.kcal; progressCalorie.value = totali.kcal;
            spanObiettivoCarboidrati.textContent = OBIETTIVI.carb; spanTotaleCarboidrati.textContent = totali.carb.toFixed(1); progressCarboidrati.max = OBIETTIVI.carb; progressCarboidrati.value = totali.carb;
            spanObiettivoZuccheri.textContent = OBIETTIVI.zuccheri; spanTotaleZuccheri.textContent = totali.zuccheri.toFixed(1); progressZuccheri.max = OBIETTIVI.zuccheri; progressZuccheri.value = totali.zuccheri;
            spanWorkoutCalories.textContent = datiGiornalieri.workoutCalorie ? datiGiornalieri.workoutCalorie.toFixed(0) : 0; 
            spanObiettivoFibreTotali.textContent = OBIETTIVI_FIBRE.fibreTotali; spanTotaleFibreTotali.textContent = totali.fibreTotali.toFixed(1); progressFibreTotali.max = OBIETTIVI_FIBRE.fibreTotali; progressFibreTotali.value = totali.fibreTotali;
            spanObiettivoFibreSolubili.textContent = OBIETTIVI_FIBRE.fibreSolubili; spanTotaleFibreSolubili.textContent = totali.fibreSolubili.toFixed(1); progressFibreSolubili.max = OBIETTIVI_FIBRE.fibreSolubili; progressFibreSolubili.value = totali.fibreSolubili;
            spanObiettivoFibreInsolubili.textContent = OBIETTIVI_FIBRE.fibreInsolubili; spanTotaleFibreInsolubili.textContent = totali.fibreInsolubili.toFixed(1); progressFibreInsolubili.max = OBIETTIVI_FIBRE.fibreInsolubili; progressFibreInsolubili.value = totali.fibreInsolubili;
            spanObiettivoFatsTotal.textContent = OBIETTIVI_FAT.fatTotal; spanTotaleFatsTotal.textContent = totali.fatTotal.toFixed(1); progressFatsTotal.max = OBIETTIVI_FAT.fatTotal; progressFatsTotal.value = totali.fatTotal;
            spanObiettivoFatSat.textContent = OBIETTIVI_FAT.fatSat; spanTotaleFatSat.textContent = totali.fatSat.toFixed(1); progressFatSat.max = OBIETTIVI_FAT.fatSat; progressFatSat.value = totali.fatSat;
            spanObiettivoFatTrans.textContent = OBIETTIVI_FAT.fatTrans; spanTotaleFatTrans.textContent = totali.fatTrans.toFixed(1); progressFatTrans.max = OBIETTIVI_FAT.fatTrans; progressFatTrans.value = totali.fatTrans;
            spanObiettivoFatUnsat.textContent = OBIETTIVI_FAT.fatUnsat; spanTotaleFatUnsat.textContent = totali.fatUnsat.toFixed(1); progressFatUnsat.max = OBIETTIVI_FAT.fatUnsat; progressFatUnsat.value = totali.fatUnsat;
            spanObiettivoFatMono.textContent = OBIETTIVI_FAT.fatMono; spanTotaleFatMono.textContent = totali.fatMono.toFixed(1); progressFatMono.max = OBIETTIVI_FAT.fatMono; progressFatMono.value = totali.fatMono;
            spanObiettivoFatPoly.textContent = OBIETTIVI_FAT.fatPoly; spanTotaleFatPoly.textContent = totali.fatPoly.toFixed(1); progressFatPoly.max = OBIETTIVI_FAT.fatPoly; progressFatPoly.value = totali.fatPoly;
            spanObiettivoOmega3.textContent = OBIETTIVI_FAT.omega3; spanTotaleOmega3.textContent = totali.omega3.toFixed(1); progressOmega3.max = OBIETTIVI_FAT.omega3; progressOmega3.value = totali.omega3;
            spanObiettivoOmega6.textContent = OBIETTIVI_FAT.omega6; spanTotaleOmega6.textContent = totali.omega6.toFixed(1); progressOmega6.max = OBIETTIVI_FAT.omega6; progressOmega6.value = totali.omega6;
            spanTotaleMg.textContent = totali.mg.toFixed(1); progressMg.max = OBIETTIVI.mg; progressMg.value = totali.mg;
            spanTotaleK.textContent = totali.k.toFixed(0); progressK.max = OBIETTIVI.k; progressK.value = totali.k;
            spanTotaleCa.textContent = totali.ca.toFixed(1); progressCa.max = OBIETTIVI.ca; progressCa.value = totali.ca;
            spanTotaleFe.textContent = totali.fe.toFixed(1); progressFe.max = OBIETTIVI.fe; progressFe.value = totali.fe;
            spanTotaleZn.textContent = totali.zn.toFixed(1); progressZn.max = OBIETTIVI.zn; progressZn.value = totali.zn;
            spanTotaleCu.textContent = totali.cu.toFixed(2); progressCu.max = OBIETTIVI.cu; progressCu.value = totali.cu;
            spanTotaleP.textContent = totali.p.toFixed(0); progressP.max = OBIETTIVI.p; progressP.value = totali.p;
            spanTotaleVitC.textContent = totali.vitc.toFixed(1); progressVitC.max = OBIETTIVI.vitc; progressVitC.value = totali.vitc;
            spanTotaleVitA.textContent = totali.vitA.toFixed(1); progressVitA.max = OBIETTIVI.vitA; progressVitA.value = totali.vitA;
            spanTotaleVitB12.textContent = totali.vitB12.toFixed(1); progressVitB12.max = OBIETTIVI.vitB12; progressVitB12.value = totali.vitB12;
            spanTotaleVitD.textContent = totali.vitD.toFixed(1); progressVitD.max = OBIETTIVI.vitD; progressVitD.value = totali.vitD;
            spanTotaleVitE.textContent = totali.vitE.toFixed(1); progressVitE.max = OBIETTIVI.vitE; progressVitE.value = totali.vitE;
            spanTotaleVitK.textContent = totali.vitK.toFixed(1); progressVitK.max = OBIETTIVI.vitK; progressVitK.value = totali.vitK;
            spanTotaleB9.textContent = totali.b9.toFixed(1); progressB9.max = OBIETTIVI.b9; progressB9.value = totali.b9;
            spanTotaleB2.textContent = totali.b2.toFixed(2); progressB2.max = OBIETTIVI.b2; progressB2.value = totali.b2;
            spanTotaleB6.textContent = totali.b6.toFixed(2); progressB6.max = OBIETTIVI.b6; progressB6.value = totali.b6;
            
            let ratioText = 'N/D';
            if (totali.omega3 > 0 && totali.omega6 > 0) {
                const ratio = totali.omega6 / totali.omega3;
                ratioText = `${ratio.toFixed(1)}:1`;
                if (ratio >= 3 && ratio <= 6) {
                    omegaRatioValueEl.style.color = '#2e7d32'; 
                } else {
                    omegaRatioValueEl.style.color = '#d32f2f';
                }
            } else {
                omegaRatioValueEl.style.color = '#333';
            }
            omegaRatioValueEl.textContent = ratioText;

            const targetCaloriesForBalanceText = pianoDelGiorno.cal_base + (datiGiornalieri.workoutCalorie || 0);
            const calorieDifference = totali.kcal - targetCaloriesForBalanceText;
            calorieBalanceText.className = '';
            const balanceTolerance = getControlMode() === 'easy' ? 80 : getControlMode() === 'hard' ? 30 : 50;
            if (calorieDifference < -balanceTolerance) { calorieBalanceText.textContent = `Deficit: ${Math.abs(calorieDifference).toFixed(0)} kcal`; calorieBalanceText.classList.add('balance-deficit');
            } else if (calorieDifference > balanceTolerance) { calorieBalanceText.textContent = `Surplus: ${calorieDifference.toFixed(0)} kcal`; calorieBalanceText.classList.add('balance-surplus');
            } else { calorieBalanceText.textContent = `In Pari`; calorieBalanceText.classList.add('balance-even'); }
            calorieAdjustmentInput.value = datiGiornalieri.calorieAdjustment || 0;
            
            updateControlModeUI(totali, OBIETTIVI, pianoDelGiorno);
            const mode = getControlMode();
            const tol = getToleranceForMode(mode);
            const fatSatOk = totali.fatSat <= OBIETTIVI_FAT.fatSat * (1 + tol.bandPct);
            const fibreOk = totali.fibreTotali >= OBIETTIVI_FIBRE.fibreTotali * tol.low;
            const microOk = !Object.keys(OBIETTIVI_MICRO).some(k => totali[k] < OBIETTIVI_MICRO[k] * tol.low);
            const vitOk = !Object.keys(OBIETTIVI_VIT).some(k => totali[k] < OBIETTIVI_VIT[k] * tol.low);
            document.getElementById('fats-header').classList.toggle('nutrients-warning', !fatSatOk || totali.fatTrans > OBIETTIVI_FAT.fatTrans || totali.fatTotal > OBIETTIVI_FAT.fatTotal * tol.high);
            document.getElementById('fibre-header').classList.toggle('nutrients-warning', !fibreOk);
            document.getElementById('micro-header').classList.toggle('nutrients-warning', !microOk);
            document.getElementById('vit-header').classList.toggle('nutrients-warning', !vitOk);
            
            logBody.innerHTML = ''; 
            const nutrientKeys = ['kcal', 'na', 'fibreTotali', 'fibreSolubili', 'fibreInsolubili', ...Object.keys(OBIETTIVI_AMINO), 'fatSat', 'fatTrans', 'fatMono', 'fatPoly', 'omega3', 'omega6', 'mg', 'k', 'vitc', 'ca', 'fe', 'zn', 'cu', 'vitA', 'vitB12', 'vitD', 'vitE', 'vitK', 'b9', 'b2', 'b6', 'p'];
            const formatNumber = (key, value) => {
                const val = value || 0;
                if (Object.keys(OBIETTIVI_AMINO).includes(key) || key === 'na') return val.toFixed(0);
                return ['cu', 'b2', 'b6'].includes(key) ? val.toFixed(2) : (['kcal', 'k', 'p'].includes(key) ? val.toFixed(0) : val.toFixed(1));
            };
            
            const createDescriptionCellHTML = (item) => {
                let html = '';
                if (item.ingredienti && item.ingredienti.trim() !== '') {
                    html += `<span class="ingredient-icon" title="Visualizza ingredienti" data-food-name="${item.desc}">üìú</span>`;
                }
                html += (item.desc || '');
                return html;
            };

            const logArray = datiGiornalieri.log || [];
            const sortedLog = logArray.map((entry, originalIndex) => ({ entry, originalIndex }))
                .sort((a, b) => getEntryTime(a.entry).localeCompare(getEntryTime(b.entry)));

            sortedLog.forEach(({ entry, originalIndex: index }) => {
                const timeVal = getEntryTime(entry);
                const timeCellHtml = `<td><input type="time" class="log-time-input" data-index="${index}" value="${timeVal}" title="Orario"></td>`;
                if (entry.type === 'meal') {
                    const rigaPasto = logBody.insertRow();
                    rigaPasto.classList.add('meal-group-row');
                    const totaliPasto = entry.items.reduce((acc, item) => {
                        for (const key in item) if(typeof item[key] === 'number' && key !== 'qta') acc[key] = (acc[key] || 0) + item[key];
                        return acc;
                    }, {});
                    
                    const qualitaPasto = calcolaQualitaProteine(totaliPasto);
                    const scoreClass = qualitaPasto.score < 70 ? 'low' : qualitaPasto.score < 90 ? 'medium' : 'high';
                    const qualitaCellHtml = `<div class="protein-score ${scoreClass}" title="Limitante: ${qualitaPasto.limiting}">${qualitaPasto.score}%</div>`;
                    
                    rigaPasto.innerHTML = timeCellHtml + `
                        <td><span class="expand-arrow" data-index="${index}">${entry.isExpanded ? '‚ñº' : '‚ñ∂'}</span> ${entry.desc}</td>
                        <td>${entry.items.reduce((sum, item) => sum + item.qta, 0).toFixed(0)}</td>
                        <td>${(totaliPasto.prot || 0).toFixed(1)}</td>
                        <td>${qualitaCellHtml}</td>
                        ${nutrientKeys.map(k => `<td>${formatNumber(k, totaliPasto[k])}</td>`).join('')}
                        <td class="action-buttons"><button class="edit-btn" data-index="${index}">‚úèÔ∏è</button><button class="delete-btn" data-index="${index}">&times;</button></td>`;

                    if (entry.isExpanded) {
                        entry.items.forEach(subItem => {
                            const rigaSubItem = logBody.insertRow();
                            rigaSubItem.classList.add('sub-item-row');
                             const qualitaSubItem = calcolaQualitaProteine(subItem);
                             const subScoreClass = qualitaSubItem.score < 70 ? 'low' : qualitaSubItem.score < 90 ? 'medium' : 'high';
                             const subQualitaCellHtml = `<div class="protein-score ${subScoreClass}" title="Limitante: ${qualitaSubItem.limiting}">${qualitaSubItem.score}%</div>`;
                            rigaSubItem.innerHTML = `
                                <td></td>
                                <td>${createDescriptionCellHTML(subItem)}</td><td>${(subItem.qta || 0).toFixed(0)}</td>
                                <td>${(subItem.prot || 0).toFixed(1)}</td>
                                <td>${subQualitaCellHtml}</td>
                                ${nutrientKeys.map(k => `<td>${formatNumber(k, subItem[k])}</td>`).join('')}
                                <td></td>`;
                        });
                    }
                } else if (entry.type === 'workout') {
                    const riga = logBody.insertRow();
                    riga.innerHTML = timeCellHtml + `<td>${entry.desc}</td><td></td><td></td><td></td><td>${(entry.kcal || 0).toFixed(0)}</td><td colspan="${nutrientKeys.length - 1}"></td><td class="action-buttons"><button class="delete-btn" data-index="${index}">&times;</button></td>`;
                } else { 
                    const riga = logBody.insertRow();
                    const qualitaSingola = calcolaQualitaProteine(entry);
                    const scoreClass = qualitaSingola.score < 70 ? 'low' : qualitaSingola.score < 90 ? 'medium' : 'high';
                    const qualitaCellHtml = `<div class="protein-score ${scoreClass}" title="Limitante: ${qualitaSingola.limiting}">${qualitaSingola.score}%</div>`;
                    riga.innerHTML = timeCellHtml + `
                        <td>${createDescriptionCellHTML(entry)}</td><td>${(entry.qta || 0).toFixed(0)}</td>
                        <td>${(entry.prot || 0).toFixed(1)}</td>
                        <td>${qualitaCellHtml}</td>
                        ${nutrientKeys.map(k => `<td>${formatNumber(k, entry[k])}</td>`).join('')}
                        <td class="action-buttons"><button class="edit-btn" data-index="${index}">‚úèÔ∏è</button><button class="delete-btn" data-index="${index}">&times;</button></td>`;
                }
            });
            updateTemporalAnalysisDashboard(OBIETTIVI, datiGiornalieri.log, pianoDelGiorno);
            renderStrategiaTimingAdherence();
            updateModeVisibility();
            syncStrategiaCollapsibleState();
        }
function calcolaObiettiviPastoConArray(mealType, giornoCorrenteString, pastoArray) {
    const dataVisualizzata = new Date(giornoCorrenteString);
    const pianoDelGiorno = getPianoDelGiornoForDate(dataVisualizzata);
    const strategy = getAppMode() === 'coach' ? getDailyStrategy(giornoCorrenteString) : null;
    let obiettivoCalTotaleGiornaliero = pianoDelGiorno.cal_base + (datiGiornalieri.workoutCalorie || 0) + (datiGiornalieri.calorieAdjustment || 0);
    if (strategy && strategy.kcalTarget != null) obiettivoCalTotaleGiornaliero = Number(strategy.kcalTarget);
    const obiettivoProtTotaleGiornaliero = (strategy && strategy.protTarget != null) ? Number(strategy.protTarget) : pianoDelGiorno.prot;

    let obiettivoPastoProt = 0, obiettivoPastoCal = 0;
    const calRatio = OBIETTIVI_MACRO_PASTO_BASE_FORZA[mealType]?.cal_perc ?? 0;
    const protRatio = OBIETTIVI_MACRO_PASTO_BASE_FORZA[mealType]?.prot_perc ?? 0;

    if (mealType === 'cena') {
        let consumatoProtAltriPasti = 0, consumatoCalAltriPasti = 0;
        (datiGiornalieri.log || []).forEach(entry => {
            if (entry.mealId && entry.mealId !== 'cena') {
                const items = entry.type === 'meal' ? entry.items : [entry];
                items.forEach(item => {
                   consumatoProtAltriPasti += item.prot || 0;
                   consumatoCalAltriPasti += (item.kcal || item.cal) || 0;
                });
            }
        });
        obiettivoPastoProt = Math.max(0, Math.round(obiettivoProtTotaleGiornaliero - consumatoProtAltriPasti));
        obiettivoPastoCal = Math.max(0, Math.round(obiettivoCalTotaleGiornaliero - consumatoCalAltriPasti));
    } else {
        obiettivoPastoProt = Math.round(obiettivoProtTotaleGiornaliero * protRatio);
        obiettivoPastoCal = Math.round(obiettivoCalTotaleGiornaliero * calRatio);
    }
    
    const totaliPastoInCostruzione = pastoArray.reduce((acc, item) => {
        acc.prot += item.prot || 0; acc.kcal += (item.kcal || item.cal) || 0; return acc;
    }, { prot: 0, kcal: 0 });

    return {
        currentProt: totaliPastoInCostruzione.prot, 
        targetProt: obiettivoPastoProt, 
        remainingProt: obiettivoPastoProt - totaliPastoInCostruzione.prot,
        currentCal: totaliPastoInCostruzione.kcal, 
        targetCal: obiettivoPastoCal, 
        remainingCal: obiettivoPastoCal - totaliPastoInCostruzione.kcal
    };
}
function renderMealBuilder() {
    // 1. SINCRONIZZAZIONE FONDAMENTALE:
    // Prende i dati aggiornati dalla variabile globale window (dove scrive l'AI)
    // e li passa alla variabile locale del modulo.
    if (window.pastoInCostruzione) {
        pastoInCostruzione = window.pastoInCostruzione;
    }

    // Usa sempre il riferimento aggiornato
    const pastoCorrente = pastoInCostruzione;
    
    // --- DA QUI IN POI √à IL TUO CODICE ORIGINALE ---
    mealBuilderSezione.dataset.visible = pastoCorrente.length > 0;
    logPastoBuilderBody.innerHTML = ''; 
    
    const selectedMealType = mealTypeSelector ? mealTypeSelector.value : MEAL_TYPE_SEQUENCE[0]; 
    const selectedMealTypeText = mealTypeSelector?.options[mealTypeSelector.selectedIndex]?.text ?? '';
    
    // Passa pastoCorrente alla funzione di calcolo
    const obiettiviPasto = calcolaObiettiviPastoConArray(selectedMealType, giornoVisualizzato, pastoCorrente);
    
    const totaliPastoCorrenteSelezionati = pastoCorrente.filter(item => item.selezionato !== false).reduce((acc, item) => {
        acc.prot += item.prot || 0; 
        acc.kcal += (item.kcal || item.cal) || 0; 
        return acc;
    }, { prot: 0, kcal: 0 });
    
    currentMealTypeDisplay.textContent = selectedMealTypeText;
    mealProtCurrent.textContent = totaliPastoCorrenteSelezionati.prot.toFixed(1);
    mealProtTarget.textContent = obiettiviPasto.targetProt.toFixed(0);
    mealProtRemaining.textContent = `${(obiettiviPasto.targetProt - totaliPastoCorrenteSelezionati.prot).toFixed(1)} g`;
    mealProgressProt.max = obiettiviPasto.targetProt;
    mealProgressProt.value = totaliPastoCorrenteSelezionati.prot;
    mealCalCurrent.textContent = totaliPastoCorrenteSelezionati.kcal.toFixed(0);
    mealCalTarget.textContent = obiettiviPasto.targetCal.toFixed(0);
    mealCalRemaining.textContent = `${(obiettiviPasto.targetCal - totaliPastoCorrenteSelezionati.kcal).toFixed(0)} kcal`;
    mealProgressCal.max = obiettiviPasto.targetCal;
    mealProgressCal.value = totaliPastoCorrenteSelezionati.kcal;
    
    const createBuilderDescriptionCellHTML = (item) => {
        let html = '';
        if (item.ingredienti && item.ingredienti.trim() !== '') {
            html += `<span class="ingredient-icon" title="Visualizza ingredienti" data-food-name="${item.desc}">üìú</span>`;
        }
        html += item.desc;
        return html;
    };

    pastoCorrente.forEach((item, index) => { 
        const riga = logPastoBuilderBody.insertRow(); 
        riga.innerHTML = `<td><input type="checkbox" class="meal-item-checkbox" data-index="${index}" ${item.selezionato !== false ? 'checked' : ''}></td>
                        <td>${createBuilderDescriptionCellHTML(item)}</td>
                        <td>${item.qta}</td>
                        <td>${(item.prot || 0).toFixed(1)}</td>
                        <td>${((item.kcal || item.cal) || 0).toFixed(0)}</td>
                        <td class="action-buttons"><button class="delete-btn" data-type="builder" data-index="${index}">&times;</button></td>`; 
    });
}

// 2. ESPOSIZIONE GLOBALE:
// Rende la funzione visibile allo script della Chat AI
window.renderMealBuilder = renderMealBuilder;

        function renderSuggestions() {
            const value = builderDesc.value.toLowerCase();
            suggestionsContainer.innerHTML = '';
            
            let keysToShow = Object.keys(foodDatabase);

            if (value.length > 0) {
                keysToShow = keysToShow.filter(key => 
                    foodDatabase[key] && foodDatabase[key].desc && foodDatabase[key].desc.toLowerCase().includes(value)
                );
            }

            const matches = keysToShow.sort((a, b) => {
                const descA = foodDatabase[a]?.desc || '';
                const descB = foodDatabase[b]?.desc || '';
                return descA.localeCompare(descB);
            });


            if (matches.length > 0) {
                matches.forEach(sanitizedKey => {
                    const originalDesc = foodDatabase[sanitizedKey].desc;
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'suggestion-item';
                    itemDiv.innerHTML = `
                        <span>${originalDesc}</span>
                        <button class="suggestion-delete-btn" data-food-key="${sanitizedKey}" title="Cancella ${originalDesc} dal database">&times;</button>
                    `;
                    suggestionsContainer.appendChild(itemDiv);
                });
                suggestionsContainer.style.display = 'block';
            } else {
                suggestionsContainer.style.display = 'none';
            }
        }
        
        function calcolaQualitaProteine(item) {
            if (!item || !item.prot || item.prot <= 0) {
                return { score: 0, limiting: 'N/D' };
            }
            let minRatio = Infinity;
            let limitingAmino = 'Nessuno';
            for (const amino in PROFILO_AMINOACIDICO_RIFERIMENTO) {
                const referenceValueMgPerG = PROFILO_AMINOACIDICO_RIFERIMENTO[amino];
                const actualValueMg = item[amino] || 0;
                const actualValueMgPerG = (actualValueMg / item.prot);
                const ratio = Math.min(1, actualValueMgPerG / referenceValueMgPerG);
                if (ratio < minRatio) {
                    minRatio = ratio;
                    limitingAmino = amino.charAt(0).toUpperCase() + amino.slice(1);
                }
            }
            return {
                score: Math.round(minRatio * 100),
                limiting: limitingAmino
            };
        }

        function apriModalAminoacidi(totali, titolo) {
            const modal = document.getElementById('amino-acid-modal');
            if (!modal) return;
            document.getElementById('modal-amino-title').textContent = titolo;
            const qualita = calcolaQualitaProteine(totali);
            const scoreClass = qualita.score < 70 ? 'low' : qualita.score < 90 ? 'medium' : 'high';
            const summaryDiv = document.getElementById('modal-amino-summary');
            summaryDiv.innerHTML = `
                <div class="protein-score ${scoreClass}" style="display: inline-block; padding: 5px 15px; font-size: 1.1em;" title="Limitante: ${qualita.limiting}">
                    Qualit√† Proteica: ${qualita.score}%
                </div>
            `;
            for (const amino in OBIETTIVI_AMINO) {
                const obiettivo = OBIETTIVI_AMINO[amino];
                const valore = totali[amino] || 0;
                document.getElementById(`modal-amino-${amino}-total`).textContent = valore.toFixed(0);
                document.getElementById(`modal-amino-${amino}-goal`).textContent = obiettivo;
                const progress = document.getElementById(`modal-amino-${amino}-progress`);
                progress.max = obiettivo;
                progress.value = valore;
            }
            modal.style.display = 'block';
        }

        function evaluateQuantity(input) {
            try {
                let value = input.trim().replace(',', '.');
                if (/^[0-9+\-*/.\s()]+$/.test(value)) {
                    const result = new Function(`return ${value}`)();
                    if (typeof result === 'number' && !isNaN(result)) {
                        return result;
                    }
                }
            } catch (e) { console.error("Errore valutazione quantit√†:", e); }
            return parseFloat(input.replace(',', '.'));
        }

        function creaAlimentoDaInput(isSingle = false) {
            const desc = builderDesc.value.trim();
            const qta = evaluateQuantity(builderQta.value);
            if (!desc || isNaN(qta) || qta <= 0) {
                alert('Inserisci nome e quantit√† valide.');
                return null;
            }

            const sanitizedKey = sanitizeFirebaseKey(desc.toLowerCase());
            const foodData = foodDatabase[sanitizedKey] || {};
            
            foodData.lastQta = qta;
            foodData.desc = desc; 
            
            const foodItem = { 
                desc: desc.charAt(0).toUpperCase() + desc.slice(1), 
                qta, 
                ingredienti: foodData.ingredienti || null 
            };
            
            for (const key in inputFields) {
                inputFields[key].el.value = inputFields[key].el.value.replace(',', '.');
                foodData[key] = inputFields[key].el.value === '' ? null : parseFloat(inputFields[key].el.value);
            }
            
            if (foodData.fibreSolubili !== null && foodData.fibreInsolubili !== null && foodData.fibreTotali === null) {
                const totalFibre = (foodData.fibreSolubili || 0) + (foodData.fibreInsolubili || 0);
                foodData.fibreTotali = totalFibre;
                inputFields.fibreTotali.el.value = totalFibre.toFixed(1);
            }

            // Calcolo automatico sodio dal sale se sale √® presente
            if (foodData.sale !== null && foodData.sale > 0) {
                foodData.na = Math.round(foodData.sale * 390); // 1g sale = 390mg Na
                inputFields.na.el.value = foodData.na;
            }

            const protValue100g = foodData.prot || 0;
            const isAnyAminoFilled = Object.keys(OBIETTIVI_AMINO).some(key => foodData[key] !== null && foodData[key] > 0);

            if (protValue100g > 0 && !isAnyAminoFilled) {
                for (const amino in PROFILO_AMINOACIDICO_RIFERIMENTO) {
                    const referenceMgPerG = PROFILO_AMINOACIDICO_RIFERIMENTO[amino];
                    const calculatedAminoMg = protValue100g * referenceMgPerG;
                    foodData[amino] = calculatedAminoMg;
                    if(inputFields[amino]) {
                        inputFields[amino].el.value = calculatedAminoMg.toFixed(0);
                    }
                }
            } 
            
            for (const key in foodData) {
                if (key !== 'lastQta' && key !== 'desc' && key !== 'ingredienti') {
                    foodItem[key] = ((foodData[key] ?? 0) / 100) * qta;
                }
            }
            
            if (foodData.fatTotal === null && (foodData.fatSat !== null || foodData.fatTrans !== null || foodData.fatMono !== null || foodData.fatPoly !== null)) {
                const total = (foodData.fatSat || 0) + (foodData.fatTrans || 0) + (foodData.fatMono || 0) + (foodData.fatPoly || 0);
                foodData.fatTotal = total;
                foodItem.fatTotal = (total / 100) * qta;
                inputFields.fatTotal.el.value = total.toFixed(1); 
            }
            
            foodDatabase[sanitizedKey] = foodData;
            salvaFoodDatabase();
            
            foodItem.time = isSingle ? getCurrentTimeString() : ((document.getElementById('meal-builder-time') || {}).value || getCurrentTimeString());
            if (isSingle) {
                foodItem.type = 'single';
            } else {
                foodItem.selezionato = true;
            }
            return foodItem;
        }
        
        async function handleAlimentoAddition(isForMealBuilder) {
            const desc = builderDesc.value.trim();
            const invalidFirebaseChars = /[.#$[\]/]/; 
            if (invalidFirebaseChars.test(desc)) {
                alert("Il nome dell'alimento contiene caratteri non validi per il salvataggio (es. . # $ [ ] / ).\n\nPer favore, rimuovili e riprova.");
                return; 
            }
            
            const qta = evaluateQuantity(builderQta.value);
            if (!desc || isNaN(qta) || qta <= 0) { alert('Inserisci nome e quantit√† valide.'); return; }

            const emptyFields = Object.keys(inputFields)
                .filter(key => key !== 'fatTotal' && !Object.keys(OBIETTIVI_AMINO).includes(key) && key !== 'na' && key !== 'fatTotal')
                .filter(key => inputFields[key].el.value === '');
                
            if (emptyFields.length > 5) {
                const confirmMsg = `Ci sono molti campi nutrienti vuoti. Vuoi usare l'AI per compilare i dati mancanti prima di aggiungere?`;
                if (confirm(confirmMsg)) {
                    await document.getElementById('btn-compila-ai').click();
                    setTimeout(() => handleAlimentoAddition(isForMealBuilder), 500);
                    return; 
                }
            }
            
            const item = creaAlimentoDaInput(!isForMealBuilder);
            if (item) {
                if (isForMealBuilder) {
                    pastoInCostruzione.push(item);
                    window.pastoInCostruzione = pastoInCostruzione;
                    salvaPastoInCostruzione();
                    renderMealBuilder();
                    mealBuilderSezione.scrollIntoView({ behavior: 'smooth' });
                } else {
                    if (!datiGiornalieri.log) datiGiornalieri.log = [];
                    datiGiornalieri.log.push(item);
                    salvaGiorno(giornoVisualizzato, datiGiornalieri);
                }
                aggiornaUI();
                resetInputAlimento();
                aggiornaColoreNutrienti();
            }
        }

        function resetInputAlimento() { 
            builderDesc.value = '';
            builderQta.value = '';
            Object.values(inputFields).forEach(field => field.el.value = ''); 
            
            builderDesc.readOnly = false; // Rende il campo sempre editabile al reset
            btnEditName.style.display = 'none'; // Nasconde la matita
            
            builderDesc.focus(); 
        }

        function clearDettagliNutrizionali() {
            const mainFields = new Set(['prot', 'kcal', 'carb', 'zuccheri', 'fatTotal', 'fatSat', 'fibreTotali', 'sale']);
            for (const key in inputFields) {
                if (!mainFields.has(key)) {
                    inputFields[key].el.value = '';
                }
            }
            Object.keys(OBIETTIVI_AMINO).forEach(key => {
                if (inputFields[key]) {
                    inputFields[key].el.disabled = false;
                    inputFields[key].el.style.backgroundColor = '#ffffff';
                }
            });
            aggiornaColoreNutrienti();
            alert("I campi dei dettagli nutrizionali sono stati puliti.");
        }

        function aggiornaColoreNutrienti() {
            const hasEmptyFields = Object.keys(inputFields)
                .filter(key => !Object.keys(OBIETTIVI_AMINO).includes(key))
                .some(key => inputFields[key].el.value === '');
            document.getElementById('nutrients-header').classList.toggle('nutrients-warning', hasEmptyFields);
        }
        
        function calculateWeeklyVitaminStats() {
            const vitaminsToTrack = {
                'vitA': { total: 0, goal: OBIETTIVI_VIT.vitA * 7, id: 'a' },
                'vitD': { total: 0, goal: OBIETTIVI_VIT.vitD * 7, id: 'd' },
                'vitE': { total: 0, goal: OBIETTIVI_VIT.vitE * 7, id: 'e' },
                'vitK': { total: 0, goal: OBIETTIVI_VIT.vitK * 7, id: 'k' },
                'vitB12': { total: 0, goal: OBIETTIVI_VIT.vitB12 * 7, id: 'b12' }
            };
            const today = new Date();
            for (let i = 0; i < 7; i++) {
                const dateToCheck = new Date(today);
                dateToCheck.setDate(today.getDate() - i);
                const dateString = dateToCheck.toISOString().split('T')[0];
                const dailyDataRaw = localStorage.getItem(`trackerStorico_${dateString}`);
                if (dailyDataRaw) {
                    try {
                        const dailyData = JSON.parse(dailyDataRaw);
                        if (dailyData && dailyData.log) {
                            dailyData.log.forEach(entry => {
                                const items = entry.type === 'meal' ? entry.items : [entry];
                                items.forEach(item => {
                                    for (const key in vitaminsToTrack) {
                                        if (item[key]) vitaminsToTrack[key].total += item[key];
                                    }
                                });
                            });
                        }
                    } catch (e) { console.error(`Errore parsing dati per ${dateString}:`, e); }
                }
            }
            return vitaminsToTrack;
        }
        
        function calculateWeeklyFatStats() {
            const fatsToTrack = {
                'fatTotal': { total: 0, goal: OBIETTIVI_FAT.fatTotal * 7, id: 'total' }, 'fatSat':   { total: 0, goal: OBIETTIVI_FAT.fatSat * 7,   id: 'sat' },
                'fatTrans': { total: 0, goal: OBIETTIVI_FAT.fatTrans * 7, id: 'trans' }, 'fatMono':  { total: 0, goal: OBIETTIVI_FAT.fatMono * 7,  id: 'mono' },
                'fatPoly':  { total: 0, goal: OBIETTIVI_FAT.fatPoly * 7,  id: 'poly' }, 'omega3':   { total: 0, goal: OBIETTIVI_FAT.omega3 * 7,   id: 'omega3' },
                'omega6':   { total: 0, goal: OBIETTIVI_FAT.omega6 * 7,   id: 'omega6' }
            };
            const today = new Date();
            for (let i = 0; i < 7; i++) {
                const dateToCheck = new Date(today);
                dateToCheck.setDate(today.getDate() - i);
                const dateString = dateToCheck.toISOString().split('T')[0];
                const dailyDataRaw = localStorage.getItem(`trackerStorico_${dateString}`);
                if (dailyDataRaw) {
                    try {
                        const dailyData = JSON.parse(dailyDataRaw);
                        if (dailyData && dailyData.log) {
                            dailyData.log.forEach(entry => {
                                const items = entry.type === 'meal' ? entry.items : [entry];
                                items.forEach(item => {
                                    for (const key in fatsToTrack) {
                                        let value = item[key] || 0;
                                        if (key === 'fatTotal' && !item.fatTotal) {
                                            value = (item.fatSat || 0) + (item.fatTrans || 0) + (item.fatMono || 0) + (item.fatPoly || 0);
                                        }
                                        fatsToTrack[key].total += value;
                                    }
                                });
                            });
                        }
                    } catch (e) { console.error(`Errore nel parsing dei dati per il giorno ${dateString}:`, e); }
                }
            }
            return fatsToTrack;
        }

        function openWeeklyVitaminsModal() {
            const weeklyStats = calculateWeeklyVitaminStats();
            for (const key in weeklyStats) {
                const stat = weeklyStats[key];
                const { id, total, goal } = stat;
                const avg = total / 7;
                const dailyGoal = OBIETTIVI_VIT[key]; 
                const percentageDiff = (avg - dailyGoal) / dailyGoal * 100;
                document.getElementById(`weekly-vit-${id}-total`).textContent = total.toFixed(1);
                document.getElementById(`weekly-vit-${id}-goal`).textContent = goal.toFixed(1);
                document.getElementById(`weekly-progress-vit-${id}`).value = total;
                document.getElementById(`weekly-progress-vit-${id}`).max = goal;
                document.getElementById(`weekly-vit-${id}-avg`).textContent = avg.toFixed(1);
                const diffSpan = document.getElementById(`weekly-vit-${id}-diff`);
                diffSpan.classList.remove('diff-surplus', 'diff-deficit');
                if (percentageDiff >= 0) {
                    diffSpan.classList.add('diff-surplus');
                    diffSpan.textContent = `+${percentageDiff.toFixed(0)}%`;
                } else {
                    diffSpan.classList.add('diff-deficit');
                    diffSpan.textContent = `${percentageDiff.toFixed(0)}%`;
                }
            }
            weeklyVitaminModal.style.display = 'block';
        }
        
        function openWeeklyFatsModal() {
            const weeklyStats = calculateWeeklyFatStats();
            for (const key in weeklyStats) {
                const stat = weeklyStats[key];
                const { id, total, goal } = stat;
                const avg = total / 7;
                const dailyGoal = OBIETTIVI_FAT[key];
                const percentageDiff = dailyGoal > 0 ? (avg - dailyGoal) / dailyGoal * 100 : 0;
                document.getElementById(`weekly-fat-${id}-total`).textContent = total.toFixed(1);
                document.getElementById(`weekly-fat-${id}-goal`).textContent = goal.toFixed(1);
                document.getElementById(`daily-fat-${id}-goal`).textContent = dailyGoal.toFixed(1);
                document.getElementById(`weekly-progress-fat-${id}`).value = total;
                document.getElementById(`weekly-progress-fat-${id}`).max = goal;
                document.getElementById(`weekly-fat-${id}-avg`).textContent = avg.toFixed(1);
                const diffSpan = document.getElementById(`weekly-fat-${id}-diff`);
                diffSpan.classList.remove('diff-surplus', 'diff-deficit');
                if (avg > dailyGoal) {
                    diffSpan.classList.add('diff-deficit');
                    diffSpan.textContent = `+${percentageDiff.toFixed(0)}%`;
                } else {
                    diffSpan.classList.add('diff-surplus');
                    diffSpan.textContent = `${percentageDiff.toFixed(0)}%`;
                }
            }
            const totalWeeklyOmega3 = weeklyStats['omega3'].total;
            const totalWeeklyOmega6 = weeklyStats['omega6'].total;
            const weeklyOmegaRatioEl = document.getElementById('weekly-omega-ratio-value');
            let weeklyRatioText = 'N/D';
            weeklyOmegaRatioEl.style.color = '#333';
            if (totalWeeklyOmega3 > 0 && totalWeeklyOmega6 > 0) {
                const ratio = totalWeeklyOmega6 / totalWeeklyOmega3;
                weeklyRatioText = `${ratio.toFixed(1)}:1`;
                if (ratio >= 3 && ratio <= 6) { weeklyOmegaRatioEl.style.color = '#2e7d32';
                } else { weeklyOmegaRatioEl.style.color = '#d32f2f'; }
            }
            weeklyOmegaRatioEl.textContent = weeklyRatioText;
            weeklyFatsModal.style.display = 'block';
        }

        function toggleCollapsible(headerId, contentId) {
            const header = document.getElementById(headerId);
            const content = document.getElementById(contentId);
            header.classList.toggle('expanded');
            content.classList.toggle('expanded');
            header.querySelector('.arrow').textContent = header.classList.contains('expanded') ? '‚ñº' : '‚ñ∂';
        }

        function getNutrientData() {
            const allItems = [];
            (datiGiornalieri.log || []).forEach(entry => {
                if (entry.type === 'meal') {
                    entry.items.forEach(item => allItems.push(item));
                } else if (entry.type === 'single') {
                    allItems.push(entry);
                }
            });
            return allItems;
        }

        function showNutrientDetailsModal(nutrientKey, title, unit) {
            const allItems = getNutrientData();
            let totalNutrient = 0;
            const itemContributions = [];
            allItems.forEach(item => {
                const value = item[nutrientKey] || 0;
                totalNutrient += value;
                if (value > 0) { itemContributions.push({ name: item.desc, value: value, unit: unit }); }
            });
            itemContributions.sort((a, b) => b.value - a.value);
            nutrientDetailTitle.textContent = `Dettaglio Fonti ${title}`;
            nutrientDetailList.innerHTML = '';
            if (itemContributions.length === 0) {
                nutrientDetailList.innerHTML = '<li>Nessun dato disponibile.</li>';
            } else {
                itemContributions.forEach(item => {
                    const percentage = totalNutrient > 0 ? (item.value / totalNutrient) * 100 : 0;
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `<span>${item.name}</span><span>${item.value.toFixed(1)} ${item.unit} (${percentage.toFixed(0)}%)</span>`;
                    nutrientDetailList.appendChild(listItem);
                });
            }
            nutrientDetailModal.style.display = 'block';
        }

        function showWeeklyNutrientDetailsModal(nutrientKey, title, unit) {
            const contributions = {};
            const today = new Date();
            for (let i = 0; i < 7; i++) {
                const dateToCheck = new Date(today);
                dateToCheck.setDate(today.getDate() - i);
                const dateString = dateToCheck.toISOString().split('T')[0];
                const dailyDataRaw = localStorage.getItem(`trackerStorico_${dateString}`);
                if (!dailyDataRaw) continue;
                try {
                    const dailyData = JSON.parse(dailyDataRaw);
                    if (dailyData && dailyData.log) {
                        dailyData.log.forEach(entry => {
                            const items = entry.type === 'meal' ? entry.items : [entry];
                            items.forEach(item => {
                                const value = item[nutrientKey] || 0;
                                if (value > 0) {
                                    const name = item.desc;
                                    contributions[name] = (contributions[name] || 0) + value;
                                }
                            });
                        });
                    }
                } catch (e) { console.error(`Errore nel parsing dei dati settimanali per ${dateString}:`, e); }
            }
            const itemContributions = Object.entries(contributions)
                                          .map(([name, value]) => ({ name, value, unit }))
                                          .sort((a, b) => b.value - a.value);
            const totalNutrient = itemContributions.reduce((sum, item) => sum + item.value, 0);
            nutrientDetailTitle.textContent = `Dettaglio Fonti ${title}`;
            nutrientDetailList.innerHTML = '';
            if (itemContributions.length === 0) {
                nutrientDetailList.innerHTML = '<li>Nessun dato disponibile per questa settimana.</li>';
            } else {
                itemContributions.forEach(item => {
                    const percentage = totalNutrient > 0 ? (item.value / totalNutrient) * 100 : 0;
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `<span>${item.name}</span><span>${item.value.toFixed(1)} ${item.unit} (${percentage.toFixed(0)}%)</span>`;
                    nutrientDetailList.appendChild(listItem);
                });
            }
            nutrientDetailModal.style.display = 'block';
        }
        
        function openIngredientModal(foodName, isReadOnly = false) {
            if (!foodName) {
                alert("Inserisci prima il nome dell'alimento.");
                return;
            }
            const sanitizedKey = sanitizeFirebaseKey(foodName.toLowerCase());
            const foodData = foodDatabase[sanitizedKey];

            ingredientModalTitle.textContent = foodName;
            ingredientModalTextarea.value = foodData?.ingredienti || '';
            ingredientModalTextarea.readOnly = isReadOnly;
            
            ingredientModalActions.style.display = isReadOnly ? 'none' : 'flex';
            btnSaveIngredients.style.display = isReadOnly ? 'none' : 'block';

            ingredientModal.style.display = 'block';
        }

        function normalizeNutrientKey(key) {
            const k = key.toLowerCase().replace(/[\s\(\)]/g, '');
            if (k.includes('energi') || k.includes('kcal') || k.includes('calorie')) return 'kcal';
            if (k.includes('protein')) return 'prot';
            if (k.includes('carboidrat')) {
                if(k.includes('cuizuccheri')) return 'zuccheri';
                return 'carb';
            }
            if (k.includes('zuccher')) return 'zuccheri';
            if (k.includes('grassi') || k.includes('fat')) {
                if(k.includes('satur')) return 'fatSat';
                if(k.includes('trans')) return 'fatTrans';
                if(k.includes('monoinsatur')) return 'fatMono';
                if(k.includes('polinsatur')) return 'fatPoly';
                return 'fatTotal';
            }
            if (k.includes('fibr')) return 'fibreTotali';
            // NUOVO: Riconoscimento sale
            if (k.includes('sale') || k.includes('salt') || k.includes('sodiumchloride')) return 'sale';
            if (k.includes('sodio') || k.includes('sodium') || k.includes('na')) return 'na';
            return null;
        }
        
        async function processOCRImage(file) {
            photoOcrStatus.textContent = 'Elaborazione...';
            photoOcrStatus.style.display = 'inline';
            btnPhotoNutrients.disabled = true;

                        try {
                const prompt = `Analizza: "${text}". Per OGNI alimento trovato, rispondi ESATTAMENTE cos√¨:
[AGGIUNGI: nome_alimento | quantit√†_in_grammi | tipo_pasto]

Esempio:
[AGGIUNGI: yogurt greco | 150 | colazione]
[AGGIUNGI: kiwi | 110 | colazione]

Regole:
- Se manca la quantit√†, stima (yogurt=125g, frutta=150g, pane=30g, carne=200g)
- Pasti: colazione/merenda1/pranzo/merenda2/cena
- NON usare asterischi o testo extra`;
                const callGemini = httpsCallable(window.functions, 'callOpenAI');
                const result = await callGemini({ prompt: prompt });
                const data = result.data;
                const rawJson = data.candidates?.[0]?.content?.parts?.[0]?.text || '{}';
                const nutrientDataFromAI = JSON.parse(rawJson.replace(/```json|```/g, '').trim());
                
                nutrientConfirmList.innerHTML = '';
                if(Object.keys(nutrientDataFromAI).length === 0) {
                     nutrientConfirmList.innerHTML = `<p style="color:red; text-align:center; grid-column: 1 / -1;">L'AI non ha estratto alcun dato. L'immagine potrebbe non essere chiara. Riprova.</p>`;
                } else {
                     // Aggiungi Sale se presente
                     if (nutrientDataFromAI.sale || nutrientDataFromAI.Sale || nutrientDataFromAI.sale_g) {
                         const saleVal = nutrientDataFromAI.sale || nutrientDataFromAI.Sale || nutrientDataFromAI.sale_g;
                         const itemDiv = document.createElement('div');
                         itemDiv.className = 'nutrient-confirm-item';
                         itemDiv.innerHTML = `<label for="confirm-sale">Sale/100g (NaCl)</label>
                                              <input type="text" id="confirm-sale" data-nutrient-key="sale" value="${saleVal}">`;
                         nutrientConfirmList.appendChild(itemDiv);
                     }
                     
                     for (const aiKey in nutrientDataFromAI) {
                        const internalKey = normalizeNutrientKey(aiKey);
                        // Evita di aggiungere due volte il sale
                        if (internalKey && inputFields[internalKey] && internalKey !== 'sale') {
                            const itemDiv = document.createElement('div');
                            itemDiv.className = 'nutrient-confirm-item';
                            const value = String(nutrientDataFromAI[aiKey]).replace(/[^0-9.,]/g, '').replace(',', '.') || '0';
                            itemDiv.innerHTML = `<label for="confirm-${internalKey}">${inputFields[internalKey].label}</label>
                                                 <input type="text" id="confirm-${internalKey}" data-nutrient-key="${internalKey}" value="${value}">`;
                            nutrientConfirmList.appendChild(itemDiv);
                        }
                    }
                }
                nutrientConfirmModal.style.display = 'block';

            } catch(error) {
                console.error("Errore nel processo OCR-AI: ", error);
                alert("Si √® verificato un errore durante l'elaborazione dell'immagine. Assicurati che sia chiara e che la connessione sia stabile, poi riprova.");
            } finally {
                photoOcrStatus.style.display = 'none';
                btnPhotoNutrients.disabled = false;
                nutrientPhotoInput.value = '';
            }
        }

        let isScanning = false;

        async function startBarcodeScanner() {
            if (!('BarcodeDetector' in window)) {
                alert('Il tuo browser non supporta la scansione dei codici a barre. Prova con Chrome su Android o un altro browser moderno.');
                return;
            }
            
            barcodeScannerStatus.textContent = 'Avvio fotocamera...';
            barcodeScannerModal.style.display = 'block';

            try {
                const barcodeDetector = new BarcodeDetector({ formats: ['ean_13', 'ean_8', 'upc_a', 'upc_e'] });
                
                videoStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                
                barcodeScannerVideo.srcObject = videoStream;
                await barcodeScannerVideo.play();
                isScanning = true;
                barcodeScannerStatus.textContent = 'Pronto per la scansione.';
                
                const scanInterval = setInterval(async () => {
                    if (!isScanning) {
                        clearInterval(scanInterval);
                        return;
                    }
                    try {
                        const barcodes = await barcodeDetector.detect(barcodeScannerVideo);
                        if (barcodes.length > 0) {
                            const barcode = barcodes[0].rawValue;
                            barcodeScannerStatus.textContent = `Codice trovato: ${barcode}`;
                            isScanning = false;
                            clearInterval(scanInterval);
                            stopBarcodeScanner();
                            await fetchProductData(barcode);
                        }
                    } catch (error) {
                        console.error('Errore durante la scansione:', error);
                    }
                }, 200);

            } catch (error) {
                console.error('Errore accesso alla fotocamera:', error);
                barcodeScannerStatus.textContent = 'Errore fotocamera. Assicurati di aver dato i permessi.';
                isScanning = false;
                stopBarcodeScanner();
            }
        }

        function stopBarcodeScanner() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            isScanning = false;
            barcodeScannerModal.style.display = 'none';
        }

        async function fetchProductData(barcode) {
            barcodeScannerStatus.textContent = `Ricerca del prodotto con codice ${barcode}...`;
            photoOcrStatus.textContent = 'Ricerca dati...';
            photoOcrStatus.style.display = 'inline';

            try {
                const response = await fetch(`https://world.openfoodfacts.org/api/v2/product/${barcode}.json?fields=product_name,ingredients_text_it,ingredients_text,nutriments`);
                if (!response.ok) {
                    throw new Error(`Risposta non valida dal server: ${response.statusText}`);
                }
                const data = await response.json();

                if (data.status === 0 || !data.product) {
                    alert(`Prodotto con codice a barre ${barcode} non trovato nel database di Open Food Facts.`);
                    return;
                }

                populateFormWithData(data.product);

            } catch (error) {
                console.error('Errore nel recupero dati prodotto:', error);
                alert(`Si √® verificato un errore durante la ricerca del prodotto. Controlla la connessione e riprova.`);
            } finally {
                photoOcrStatus.style.display = 'none';
            }
        }

        function populateFormWithData(product) {
            resetInputAlimento();
            
            const nutrientMap = {
                'energy-kcal_100g': inputFields.kcal.el, 'proteins_100g': inputFields.prot.el,
                'carbohydrates_100g': inputFields.carb.el, 'sugars_100g': inputFields.zuccheri.el,
                'fat_100g': inputFields.fatTotal.el, 'saturated-fat_100g': inputFields.fatSat.el,
                'trans-fat_100g': inputFields.fatTrans.el, 'monounsaturated-fat_100g': inputFields.fatMono.el,
                'polyunsaturated-fat_100g': inputFields.fatPoly.el, 'omega-3-fat_100g': inputFields.omega3.el,
                'omega-6-fat_100g': inputFields.omega6.el, 'fiber_100g': inputFields.fibreTotali.el,
                'salt_100g': inputFields.sale.el, // NUOVO: Mappatura sale
                'sodium_100g': inputFields.na.el,
                'calcium_100g': inputFields.ca.el, 'iron_100g': inputFields.fe.el,
                'magnesium_100g': inputFields.mg.el, 'potassium_100g': inputFields.k.el,
                'zinc_100g': inputFields.zn.el, 'phosphorus_100g': inputFields.p.el,
                'vitamin-a_100g': inputFields.vitA.el, 'vitamin-d_100g': inputFields.vitD.el,
                'vitamin-e_100g': inputFields.vitE.el, 'vitamin-k_100g': inputFields.vitK.el,
                'vitamin-c_100g': inputFields.vitc.el, 'vitamin-b2_100g': inputFields.b2.el,
                'vitamin-b6_100g': inputFields.b6.el, 'vitamin-b9_100g': inputFields.b9.el,
                'vitamin-b12_100g': inputFields.vitB12.el
            };

            builderDesc.value = product.product_name || 'Prodotto Sconosciuto';

            const nutriments = product.nutriments || {};
            for (const key in nutrientMap) {
                if (nutriments[key] !== undefined && nutriments[key] !== null) {
                    let value = parseFloat(nutriments[key]);
                    
                    if (['calcium_100g', 'iron_100g', 'magnesium_100g', 'potassium_100g', 'zinc_100g', 'phosphorus_100g', 'vitamin-e_100g', 'vitamin-c_100g', 'vitamin-b2_100g', 'vitamin-b6_100g'].includes(key)) {
                        value *= 1000;
                    } else if (['vitamin-a_100g', 'vitamin-d_100g', 'vitamin-k_100g', 'vitamin-b9_100g', 'vitamin-b12_100g'].includes(key)) {
                        value *= 1000000;
                    } else if (key === 'salt_100g') {
                        // Il sale √® gi√† in grammi, nessuna conversione necessaria
                        value = value;
                    } else if (key === 'sodium_100g') {
                         value *= 1000;
                    }
                    
                    nutrientMap[key].value = value.toFixed(2).replace(/\.00$/, '');
                }
            }
            
            // Calcolo automatico sodio dal sale dopo il popolamento
            if (inputFields.sale.el.value) {
                const saleVal = parseFloat(inputFields.sale.el.value) || 0;
                inputFields.na.el.value = Math.round(saleVal * 390);
            }
            
            const ingredients = product.ingredients_text_it || product.ingredients_text || '';
            if (ingredients) {
                const sanitizedKey = sanitizeFirebaseKey(builderDesc.value.toLowerCase());
                if (!foodDatabase[sanitizedKey]) {
                    foodDatabase[sanitizedKey] = { desc: builderDesc.value };
                }
                foodDatabase[sanitizedKey].ingredienti = ingredients;
                salvaFoodDatabase();
            }

            alert(`Dati per "${builderDesc.value}" compilati con successo!`);
            aggiornaColoreNutrienti();
            builderProt.dispatchEvent(new Event('input'));

            builderDesc.readOnly = true;
            btnEditName.style.display = 'inline-block';
        }

        document.addEventListener('DOMContentLoaded', () => {
            eseguiMigrazioneStorico(); 
            initAppUI(); 
            
            btnScanBarcode.addEventListener('click', startBarcodeScanner);
            const barcodeModalCloseBtn = barcodeScannerModal.querySelector('.modal-close');
            barcodeModalCloseBtn.addEventListener('click', stopBarcodeScanner);

            dailyNotesTextarea.addEventListener('input', () => {
                datiGiornalieri.note = dailyNotesTextarea.value;
                salvaGiorno(giornoVisualizzato, datiGiornalieri);
            });
            
            btnEditName.addEventListener('click', () => {
                builderDesc.readOnly = false;
                builderDesc.focus();
                btnEditName.style.display = 'none';
            });

            const btnVaiAOggi = document.getElementById('btn-vai-a-oggi');
            btnVaiAOggi.addEventListener('click', () => {
                caricaGiorno(getTodayString());
            });

            document.querySelectorAll('.app-mode-toggle .mode-btn').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-mode') === getAppMode());
                btn.addEventListener('click', () => setAppMode(btn.getAttribute('data-mode')));
            });

            dataCaricamentoInput.addEventListener('change', (e) => {
                const dataSelezionata = e.target.value;
                if (dataSelezionata) {
                    console.log(`Data selezionata, carico il giorno: ${dataSelezionata}`);
                    caricaGiorno(dataSelezionata);
                }
            });

            document.getElementById('btn-genera-prompt-chatgpt').addEventListener('click', () => {
                const prompt = generateChatGPTPrompt();
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(prompt).then(() => showToast('Prompt copiato. Incollalo in ChatGPT.')).catch(() => { copyPromptFallback(prompt); showToast('Prompt copiato. Incollalo in ChatGPT.'); });
                } else {
                    copyPromptFallback(prompt);
                    showToast('Prompt copiato. Incollalo in ChatGPT.');
                }
            });
            function copyPromptFallback(text) {
                const ta = document.createElement('textarea');
                ta.value = text;
                ta.style.position = 'fixed'; ta.style.opacity = '0';
                document.body.appendChild(ta);
                ta.select();
                try { document.execCommand('copy'); } catch (e) {}
                document.body.removeChild(ta);
            }
            document.getElementById('btn-salva-strategia').addEventListener('click', () => {
                const current = getDailyStrategy(giornoVisualizzato) || {};
                const kcalEl = document.getElementById('strategia-kcal');
                const protEl = document.getElementById('strategia-prot');
                const kcalTarget = kcalEl.value.trim() ? parseInt(kcalEl.value, 10) : null;
                const protTarget = protEl.value.trim() ? parseInt(protEl.value, 10) : null;
                const dailyStrategy = {
                    ...current,
                    kcalTarget: isFinite(kcalTarget) ? kcalTarget : (current.kcalTarget ?? null),
                    protTarget: isFinite(protTarget) ? protTarget : (current.protTarget ?? null),
                    tipoGiornata: (document.getElementById('strategia-tipo').value || '').trim() || current.tipoGiornata || undefined,
                    focus: (document.getElementById('strategia-focus').value || '').trim() || current.focus || undefined,
                    note: (document.getElementById('strategia-note').value || '').trim() || current.note || undefined,
                    timingPasti: (document.getElementById('strategia-timing').value || '').trim() || current.timingPasti || undefined
                };
                setDailyStrategy(giornoVisualizzato, dailyStrategy);
                fillStrategiaForm();
                aggiornaUI();
                setTimeout(closeStrategiaCollapsible, 1000);
            });
            const btnModificaStrategia = document.getElementById('btn-modifica-strategia');
            if (btnModificaStrategia) {
                btnModificaStrategia.addEventListener('click', () => {
                    openStrategiaCollapsible();
                    document.getElementById('strategia-giornata-sezione').scrollIntoView({ behavior: 'smooth', block: 'start' });
                });
            }
            const btnRimuoviStrategia = document.getElementById('btn-rimuovi-strategia');
            if (btnRimuoviStrategia) {
                btnRimuoviStrategia.addEventListener('click', () => {
                    if (!confirm('Rimuovere la strategia per questo giorno?')) return;
                    clearDailyStrategy(giornoVisualizzato);
                    fillStrategiaForm();
                    aggiornaUI();
                    openStrategiaCollapsible();
                    document.getElementById('strategia-giornata-sezione').scrollIntoView({ behavior: 'smooth', block: 'start' });
                });
            }
            const btnApriStrategia = document.getElementById('btn-apri-strategia');
            if (btnApriStrategia) {
                btnApriStrategia.addEventListener('click', () => {
                    const el = document.getElementById('strategia-giornata-sezione');
                    if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                });
            }

            document.getElementById('btn-applica-json-strategia').addEventListener('click', () => {
                const raw = (document.getElementById('strategia-json-paste').value || '').trim().replace(/```json|```/g, '');
                if (!raw) return;
                try {
                    const parsed = JSON.parse(raw);
                    const current = getDailyStrategy(giornoVisualizzato) || {};
                    const merged = {
                        ...current,
                        kcalTarget: parsed.kcalTarget != null ? Number(parsed.kcalTarget) : current.kcalTarget,
                        protTarget: parsed.protTarget != null ? Number(parsed.protTarget) : current.protTarget,
                        tipoGiornata: parsed.tipoGiornata || current.tipoGiornata,
                        focus: parsed.focus || current.focus,
                        note: parsed.note != null ? String(parsed.note) : current.note,
                        timingPasti: parsed.timingPasti != null ? String(parsed.timingPasti) : current.timingPasti
                    };
                    if (parsed.meals_timing && typeof parsed.meals_timing === 'object') {
                        merged.meals_timing = parsed.meals_timing;
                    }
                    if (parsed.workout && typeof parsed.workout === 'object') {
                        merged.workout = { time: parsed.workout.time, desc: parsed.workout.desc || parsed.workout.description || '' };
                    }
                    setDailyStrategy(giornoVisualizzato, merged);
                    fillStrategiaForm();
                    document.getElementById('strategia-json-paste').value = '';
                    aggiornaUI();
                    showStrategiaFeedback('success');
                    setTimeout(closeStrategiaCollapsible, 1000);
                } catch (e) {
                    showStrategiaFeedback('error');
                }
            });

            ['progress-proteine', 'progress-calorie', 'progress-carboidrati', 'progress-zuccheri', 
             'progress-fibre-totali', 'progress-fibre-solubili', 'progress-fibre-insolubili',
             'progress-fats-total', 'progress-fat-sat', 
             'progress-fat-trans', 'progress-fat-unsat', 'progress-fat-mono', 'progress-fat-poly', 'progress-omega3', 'progress-omega6', 
             'progress-mg', 'progress-k', 'progress-fe', 'progress-zn', 'progress-ca', 'progress-cu', 'progress-p', 'progress-vitc', 
             'progress-vit-a', 'progress-vit-d', 'progress-vit-e', 'progress-vit-k', 'progress-vit-b12', 'progress-b2', 'progress-b6', 'progress-b9']
            .forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    const nutrientMap = {
                        'progress-proteine': { key: 'prot', title: 'Proteine', unit: 'g' },
                        'progress-calorie': { key: 'kcal', title: 'Calorie', unit: 'kcal' },
                        'progress-carboidrati': { key: 'carb', title: 'Carboidrati', unit: 'g' },
                        'progress-zuccheri': { key: 'zuccheri', title: 'Zuccheri', unit: 'g' },
                        'progress-fibre-totali': { key: 'fibreTotali', title: 'Fibre Totali', unit: 'g' },
                        'progress-fibre-solubili': { key: 'fibreSolubili', title: 'Fibre Solubili', unit: 'g' },
                        'progress-fibre-insolubili': { key: 'fibreInsolubili', title: 'Fibre Insolubili', unit: 'g' },
                        'progress-fats-total': { key: 'fatTotal', title: 'Grassi Totali', unit: 'g'},
                        'progress-fat-sat': { key: 'fatSat', title: 'Grassi Saturi', unit: 'g' },
                        'progress-fat-trans': { key: 'fatTrans', title: 'Grassi Trans', unit: 'g' },
                        'progress-fat-mono': { key: 'fatMono', title: 'Grassi Monoinsaturi', unit: 'g' },
                        'progress-fat-poly': { key: 'fatPoly', title: 'Grassi Polinsaturi', unit: 'g' },
                        'progress-omega3': { key: 'omega3', title: 'Omega 3', unit: 'g' },
                        'progress-omega6': { key: 'omega6', title: 'Omega 6', unit: 'g' },
                        'progress-mg': { key: 'mg', title: 'Magnesio', unit: 'mg' },
                        'progress-k': { key: 'k', title: 'Potassio', unit: 'mg' },
                        'progress-fe': { key: 'fe', title: 'Ferro', unit: 'mg' },
                        'progress-zn': { key: 'zn', title: 'Zinco', unit: 'mg' },
                        'progress-ca': { key: 'ca', title: 'Calcio', unit: 'mg' },
                        'progress-cu': { key: 'cu', title: 'Rame', unit: 'mg' },
                        'progress-p': { key: 'p', title: 'Fosforo', unit: 'mg' },
                        'progress-vitc': { key: 'vitc', title: 'Vitamina C', unit: 'mg' },
                        'progress-vit-a': { key: 'vitA', title: 'Vitamina A', unit: '¬µg' },
                        'progress-vit-d': { key: 'vitD', title: 'Vitamina D', unit: '¬µg' },
                        'progress-vit-e': { key: 'vitE', title: 'Vitamina E', unit: 'mg' },
                        'progress-vit-k': { key: 'vitK', title: 'Vitamina K', unit: '¬µg' },
                        'progress-vit-b12': { key: 'vitB12', title: 'Vitamina B12', unit: '¬µg' },
                        'progress-b2': { key: 'b2', title: 'Vitamina B2', unit: 'mg' },
                        'progress-b6': { key: 'b6', title: 'Vitamina B6', unit: 'mg' },
                        'progress-b9': { key: 'b9', title: 'Folati (B9)', unit: '¬µg' }
                    };
                    const info = nutrientMap[id];
                    if (info) el.addEventListener('click', () => showNutrientDetailsModal(info.key, info.title, info.unit));
                }
            });

            ['weekly-progress-vit-a', 'weekly-progress-vit-d', 'weekly-progress-vit-e', 'weekly-progress-vit-k', 'weekly-progress-vit-b12',
             'weekly-progress-fat-total', 'weekly-progress-fat-sat', 'weekly-progress-fat-trans', 'weekly-progress-fat-mono', 'weekly-progress-fat-poly',
             'weekly-progress-fat-omega3', 'weekly-progress-fat-omega6'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                     const nutrientMap = {
                        'weekly-progress-vit-a': { key: 'vitA', title: 'Vitamina A (Sett.)', unit: '¬µg' },
                        'weekly-progress-vit-d': { key: 'vitD', title: 'Vitamina D (Sett.)', unit: '¬µg' },
                        'weekly-progress-vit-e': { key: 'vitE', title: 'Vitamina E (Sett.)', unit: 'mg' },
                        'weekly-progress-vit-k': { key: 'vitK', title: 'Vitamina K (Sett.)', unit: '¬µg' },
                        'weekly-progress-vit-b12': { key: 'vitB12', title: 'Vitamina B12 (Sett.)', unit: '¬µg' },
                        'weekly-progress-fat-total': { key: 'fatTotal', title: 'Grassi Totali (Sett.)', unit: 'g' },
                        'weekly-progress-fat-sat': { key: 'fatSat', title: 'Grassi Saturi (Sett.)', unit: 'g' },
                        'weekly-progress-fat-trans': { key: 'fatTrans', title: 'Grassi Trans (Sett.)', unit: 'g' },
                        'weekly-progress-fat-mono': { key: 'fatMono', 'title': 'Grassi Monoinsaturi (Sett.)', unit: 'g' },
                        'weekly-progress-fat-poly': { key: 'fatPoly', title: 'Grassi Polinsaturi (Sett.)', unit: 'g' },
                        'weekly-progress-fat-omega3': { key: 'omega3', title: 'Omega 3 (Sett.)', unit: 'g' },
                        'weekly-progress-fat-omega6': { key: 'omega6', title: 'Omega 6 (Sett.)', unit: 'g' }
                     };
                     const info = nutrientMap[id];
                     if(info) el.addEventListener('click', () => showWeeklyNutrientDetailsModal(info.key, info.title, info.unit));
                }
            });

            infoVitSettimanaliBtn.addEventListener('click', openWeeklyVitaminsModal);
            infoFatsSettimanaliBtn.addEventListener('click', openWeeklyFatsModal);

            document.querySelectorAll('.modal-close').forEach(button => {
                button.addEventListener('click', () => {
                    button.closest('.modal').style.display = 'none';
                });
            });

            window.addEventListener('click', (event) => {
                if (event.target.classList.contains('modal')) {
                    event.target.style.display = 'none';
                }
            });


            document.getElementById('info-proteine-pasto').addEventListener('click', () => {
                const totaliPasto = pastoInCostruzione.reduce((acc, item) => {
                    for (const key in item) {
                        if (typeof item[key] === 'number') acc[key] = (acc[key] || 0) + item[key];
                    }
                    return acc;
                }, {});
                apriModalAminoacidi(totaliPasto, "Dettaglio Proteine del Pasto");
            });

            const aminoModal = document.getElementById('amino-acid-modal');
            if(aminoModal) {
              aminoModal.querySelector('.modal-close').addEventListener('click', () => {
                  aminoModal.style.display = 'none';
              });
            }
        
            ['carbs-header', 'fats-header', 'micro-header', 'vit-header', 'workout-header', 'nutrients-header', 'fibre-header', 'strategia-header'].forEach(id => {
                const header = document.getElementById(id);
                if(header) {
                    header.addEventListener('click', (e) => {
                        if(e.target.closest('button')) return;
                        toggleCollapsible(id, id.replace('header', 'content'));
                    });
                }
            });
            
            btnClearNutrients.addEventListener('click', () => { 
                if(!confirm("Sei sicuro di voler cancellare tutti i campi (nome, quantit√† e nutrienti)?")) return;
                resetInputAlimento(); 
                Object.keys(OBIETTIVI_AMINO).forEach(key => {
                    if(inputFields[key]) {
                        inputFields[key].el.disabled = false;
                        inputFields[key].el.style.backgroundColor = '#ffffff';
                    }
                });
                aggiornaColoreNutrienti(); 
            });

            document.getElementById('btn-clear-dettagli').addEventListener('click', (e) => {
                e.stopPropagation();
                if(confirm("Sei sicuro di voler cancellare solo i valori nei Dettagli Nutrizionali?")) {
                    clearDettagliNutrizionali();
                }
            });

            builderProt.addEventListener('input', () => {
                const protValue = parseFloat(builderProt.value.replace(',', '.'));
                const aminoInputs = Object.keys(OBIETTIVI_AMINO).map(key => inputFields[key].el);

                if (!isNaN(protValue) && protValue > 0) {
                    aminoInputs.forEach(input => {
                        if(!input) return;
                        const aminoKey = Object.keys(inputFields).find(key => inputFields[key].el === input);
                        const referenceValue = PROFILO_AMINOACIDICO_RIFERIMENTO[aminoKey];
                        input.value = (protValue * referenceValue).toFixed(0);
                        input.disabled = true;
                        input.style.backgroundColor = '#f2f2f2';
                    });
                } else {
                    aminoInputs.forEach(input => {
                        if(!input) return;
                        input.disabled = false;
                        input.style.backgroundColor = '#ffffff';
                    });
                }
            });

            // NUOVO: Event listener per il calcolo automatico del sodio dal sale
            builderSale.addEventListener('input', () => {
                const saleVal = parseFloat(builderSale.value) || 0;
                if (saleVal > 0) {
                    const sodioCalcolato = Math.round(saleVal * 390); // 1g sale = 390mg Na
                    builderNa.value = sodioCalcolato;
                    // Aggiungi effetto visivo per indicare che √® calcolato automaticamente
                    builderNa.style.backgroundColor = '#e3f2fd';
                    setTimeout(() => {
                        builderNa.style.backgroundColor = '';
                    }, 300);
                } else {
                    builderNa.value = '';
                }
            });

            btnAddWorkout.addEventListener('click', () => {
                const desc = workoutDescInput.value.trim(), calories = parseFloat(workoutCaloriesInput.value);
                if (!desc || isNaN(calories) || calories <= 0) { alert('Dati allenamento non validi.'); return; }
                if (!datiGiornalieri.log) datiGiornalieri.log = [];
                datiGiornalieri.log.push({ type: 'workout', desc: desc, kcal: calories, time: getCurrentTimeString() });
                datiGiornalieri.workoutCalorie = (datiGiornalieri.workoutCalorie || 0) + calories;
                aggiornaUI();
                salvaGiorno(giornoVisualizzato, datiGiornalieri); 
                workoutDescInput.value = ''; workoutCaloriesInput.value = '';
                renderMealBuilder(); 
            });

           btnAggiungiSingolo.addEventListener('click', () => handleAlimentoAddition(false));
           btnCostruisciPasto.addEventListener('click', () => handleAlimentoAddition(true));

mealBuilderSezione.addEventListener('change', (e) => {
    if (e.target.classList.contains('meal-item-checkbox')) { 
        const index = parseInt(e.target.dataset.index, 10);
        if (pastoInCostruzione[index]) {
            pastoInCostruzione[index].selezionato = e.target.checked;
            window.pastoInCostruzione = pastoInCostruzione; // AGGIUNGI QUESTA
            salvaPastoInCostruzione(); 
            renderMealBuilder(); 
        }
    } else if (e.target.id === 'meal-type-selector') {
                    const value = e.target.value;
                    localStorage.setItem('lastMealTypeSelected_' + getTodayString(), value);
                    saveSingleItemToCloud('lastMealTypeSelected_' + getTodayString(), value);
                    setMealBuilderTimeDefault();
                    renderMealBuilder();
                }
            });

btnSalvaPasto.addEventListener('click', () => {
    const alimentiSelezionati = pastoInCostruzione.filter(item => item.selezionato !== false);
    if (alimentiSelezionati.length === 0) { alert("Nessun alimento selezionato."); return; }
    const timeInput = document.getElementById('meal-builder-time');
    const mealTime = (timeInput && timeInput.value) ? timeInput.value : getCurrentTimeString();
    const mealName = mealTypeSelector.options[mealTypeSelector.selectedIndex].text, mealId = mealTypeSelector.value;
    alimentiSelezionati.forEach(item => { item.time = item.time || mealTime; });
    const newMeal = { type: 'meal', desc: mealName, mealId: mealId, isExpanded: false, items: alimentiSelezionati, time: mealTime };
    if (!datiGiornalieri.log) datiGiornalieri.log = [];
    datiGiornalieri.log.push(newMeal);
    
    pastoInCostruzione = []; 
    window.pastoInCostruzione = pastoInCostruzione; // AGGIUNGI QUESTA
    salvaPastoInCostruzione(); 
    aggiornaUI(); 
    salvaGiorno(giornoVisualizzato, datiGiornalieri); 
    renderMealBuilder(); 

                const currentIndex = MEAL_TYPE_SEQUENCE.indexOf(mealId);
                const nextMeal = (currentIndex !== -1 && currentIndex < MEAL_TYPE_SEQUENCE.length - 1) ? MEAL_TYPE_SEQUENCE[currentIndex + 1] : MEAL_TYPE_SEQUENCE[0];
                mealTypeSelector.value = nextMeal;
                localStorage.setItem('lastMealTypeSelected_' + getTodayString(), nextMeal);
                saveSingleItemToCloud('lastMealTypeSelected_' + getTodayString(), nextMeal);
            });

            document.body.addEventListener('change', (e) => {
                const timeInput = e.target.closest('input.log-time-input');
                if (timeInput && timeInput.dataset.index !== undefined) {
                    const index = parseInt(timeInput.dataset.index, 10);
                    const entry = datiGiornalieri.log && datiGiornalieri.log[index];
                    if (entry && timeInput.value) {
                        entry.time = timeInput.value;
                        if (entry.type === 'meal' && entry.items) entry.items.forEach(item => { item.time = timeInput.value; });
                        salvaGiorno(giornoVisualizzato, datiGiornalieri);
                        aggiornaUI();
                    }
                    return;
                }
            });

            document.body.addEventListener('click', (e) => {
                const row = e.target.closest('.macro-row-alert');
                const infoOrAlertIcon = e.target.closest('.alert-icon, .nutrient-info-icon');
                if (row && infoOrAlertIcon) {
                    e.preventDefault();
                    e.stopPropagation();
                    const param = infoOrAlertIcon.getAttribute('data-param') || row.getAttribute('data-param');
                    if (param) { openNutrientExplanationModal(param); }
                    return;
                }
                const icon = e.target.closest('.ingredient-icon');
                if (icon) {
                    const foodName = icon.dataset.foodName;
                    openIngredientModal(foodName, true);
                    return;
                }
                
                const target = e.target.closest('button, .expand-arrow');
                if (!target) return;

                const button = target.closest('.edit-btn, .delete-btn');
                const index = parseInt(target.dataset.index, 10);
                
                if (button && button.classList.contains('edit-btn')) {
                    const itemToEdit = datiGiornalieri.log[index];
                    if (!itemToEdit || !confirm("Vuoi modificare questa voce? Verr√† spostata nel 'Costruttore Pasto'.")) return;
                    const timeToUse = getEntryTime(itemToEdit);
                    const mealBuilderTimeEl = document.getElementById('meal-builder-time');
                    if (mealBuilderTimeEl) { mealBuilderTimeEl.value = timeToUse; syncMealBuilderTimeFromInput(); }
                    pastoInCostruzione = (itemToEdit.type === 'meal' ? itemToEdit.items : [itemToEdit]).map(item => ({...item, selezionato: true, time: item.time || timeToUse}));
                    datiGiornalieri.log.splice(index, 1); 
                    salvaPastoInCostruzione(); 
                    aggiornaUI(); 
                    salvaGiorno(giornoVisualizzato, datiGiornalieri); 
                    renderMealBuilder(); 
                    mealBuilderSezione.scrollIntoView({ behavior: 'smooth' }); 
                    if (itemToEdit.mealId) {
                        mealTypeSelector.value = itemToEdit.mealId;
                        localStorage.setItem('lastMealTypeSelected_' + getTodayString(), mealTypeSelector.value);
                    }
                } else if (button && button.classList.contains('delete-btn')) {
                    if (!confirm('Cancellare la voce?')) return;
if (button.dataset.type === 'builder') { 
    pastoInCostruzione.splice(index, 1);
    window.pastoInCostruzione = pastoInCostruzione; // AGGIUNGI QUESTA
    salvaPastoInCostruzione(); 
    renderMealBuilder();
} else { 
                        const itemToDelete = datiGiornalieri.log[index];
                        if (itemToDelete.type === 'workout') {
                            datiGiornalieri.workoutCalorie = Math.max(0, (datiGiornalieri.workoutCalorie || 0) - ((itemToDelete.kcal || itemToDelete.cal) || 0));
                        }
                        datiGiornalieri.log.splice(index, 1);
                        aggiornaUI(); 
                        salvaGiorno(giornoVisualizzato, datiGiornalieri); 
                    }
                } else if (target.classList.contains('expand-arrow')) {
                    if (datiGiornalieri.log[index] && datiGiornalieri.log[index].type === 'meal') {
                        datiGiornalieri.log[index].isExpanded = !datiGiornalieri.log[index].isExpanded;
                        aggiornaUI(); 
                        salvaGiorno(giornoVisualizzato, datiGiornalieri); 
                    }
                }
            });
            
            builderDesc.addEventListener('input', (e) => {
                renderSuggestions();
                const sanitizedKey = sanitizeFirebaseKey(e.target.value.trim().toLowerCase());
                const foodData = foodDatabase[sanitizedKey]; 
                if (foodData) {
                    builderQta.value = foodData.lastQta ?? '';
                    for(const key in inputFields) {
                        if (inputFields[key]) {
                            inputFields[key].el.value = foodData[key] ?? '';
                        }
                    }
                }
                aggiornaColoreNutrienti();
            });

            builderDesc.addEventListener('focus', renderSuggestions);

            builderDesc.addEventListener('blur', () => {
                setTimeout(() => {
                    suggestionsContainer.style.display = 'none';
                }, 200);
            });

            suggestionsContainer.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.suggestion-delete-btn');
                if (deleteBtn) {
                    e.stopPropagation();
                    const foodKey = deleteBtn.dataset.foodKey;
                    if (foodKey && foodDatabase[foodKey]) {
                        if (confirm(`Sei sicuro di voler cancellare "${foodDatabase[foodKey].desc}" dal database?`)) {
                            delete foodDatabase[foodKey];
                            salvaFoodDatabase();
                            renderSuggestions(); // Refresh the list
                        }
                    }
                    return;
                }

                const suggestionItem = e.target.closest('.suggestion-item');
                if (suggestionItem) {
                    const foodName = suggestionItem.querySelector('span').textContent;
                    builderDesc.value = foodName;
                    builderDesc.dispatchEvent(new Event('input', { bubbles:true }));
                    suggestionsContainer.style.display = 'none';
                    
                    const foodData = foodDatabase[sanitizeFirebaseKey(foodName.toLowerCase())];
                    if (foodData) {
                        builderDesc.readOnly = true;
                        btnEditName.style.display = 'inline-block';
                    }
                }
            });
            
            Object.values(inputFields).forEach(field => { if (field.el) field.el.addEventListener('input', aggiornaColoreNutrienti) });
            
            document.getElementById('btn-compila-ai').addEventListener('click', async (e) => {
                const nome = builderDesc.value.trim();
                if (!nome) { alert('Scrivi prima il nome dell\'alimento.'); return; }
                const button = e.target;
                button.disabled = true; button.textContent = 'Caricamento‚Ä¶';

                try {
                    const sanitizedKey = sanitizeFirebaseKey(nome.toLowerCase());
                    const foodData = foodDatabase[sanitizedKey];
                    let ingredientiInfo = '';
                    if (foodData && foodData.ingredienti) {
                        ingredientiInfo = `Considerando questa lista ingredienti: "${foodData.ingredienti}".`;
                    }
                    let promptText = `Fornisci ESATTAMENTE questo oggetto JSON (senza altro testo) con i valori nutrizionali medi per 100 g di "${nome}". ${ingredientiInfo} ${AI_INSTRUCTION}. ${GEMINI_PROMPT_FORMAT}`;
                    
                    const callGemini = httpsCallable(window.functions, 'callOpenAI');
                    const result = await callGemini({ prompt: promptText });
                    const data = result.data;
                    const raw = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
                    const newData = JSON.parse(raw.replace(/```json|```/g, '').trim());

                    const oldData = {};
                    let isAnyFieldPopulated = false;
                    for (const key in inputFields) {
                        const val = inputFields[key].el.value;
                        if(val) isAnyFieldPopulated = true;
                        oldData[key] = val || null;
                    }
                    
                    if (!isAnyFieldPopulated) {
                        for (const key in newData) {
                            const normalizedKey = normalizeNutrientKey(key) || key;
                            if (inputFields[normalizedKey] && inputFields[normalizedKey].el.value === '') {
                                inputFields[normalizedKey].el.value = newData[key];
                            }
                        }
                        // Calcola sodio dal sale se presente
                        if (newData.sale && !newData.na) {
                            inputFields.na.el.value = Math.round(parseFloat(newData.sale) * 390);
                        }
                        alert("Campi vuoti compilati con successo dall'AI.");
                    } else {
                        handleNutrientUpdate(nome, oldData, newData);
                    }
                    aggiornaColoreNutrienti();

                } catch (err) { 
                    alert('Errore compilazione AI: ' + err.message);
                    console.error(err);
                } finally { 
                    button.disabled = false; 
                    button.textContent = 'Compila AI'; 
                }
            });
            
            dataCaricamentoInput.value = getTodayString('ymd');

            const handleCalorieAdjustment = (increment) => {
                let value = (datiGiornalieri.calorieAdjustment || 0) + increment;
                datiGiornalieri.calorieAdjustment = Math.max(-500, Math.min(500, value));
                aggiornaUI();
                salvaGiorno(giornoVisualizzato, datiGiornalieri);
                renderMealBuilder(); 
            };
            calorieAdjustmentInput.addEventListener('input', () => {
                 let value = parseFloat(calorieAdjustmentInput.value);
                 if (isNaN(value)) {
                     const dataCorrente = new Date(giornoVisualizzato);
                     value = DEFICIT_PREIMPOSTATO_SETTIMANALE[dataCorrente.getDay()] || 0;
                 }
                 datiGiornalieri.calorieAdjustment = Math.max(-500, Math.min(500, value));
                 aggiornaUI();
                 salvaGiorno(giornoVisualizzato, datiGiornalieri);
                 renderMealBuilder();
            });
            btnCalorieMinus.addEventListener('click', () => handleCalorieAdjustment(-10));
            btnCaloriePlus.addEventListener('click', () => handleCalorieAdjustment(10));

            try {
                if (!getApps().some(app => app.name === "globalTrackerApp")) { firebaseApp = initializeApp(firebaseConfig, "globalTrackerApp"); } else { firebaseApp = getApp("globalTrackerApp"); }
                db = getDatabase(firebaseApp);
                auth = getAuth(firebaseApp);
                functions = getFunctions(firebaseApp, 'europe-west1');
                window.functions = functions; // Esporta per la chat AI
                console.log("Firebase inizializzato.");

                onAuthStateChanged(auth, async (user) => {
                    const isLoggedIn = !!user;
                    currentUserUID = user?.uid;
                    authFormFields.style.display = isLoggedIn ? 'none' : 'block';
                    document.getElementById('auth-header').style.display = isLoggedIn ? 'none' : 'block';
                    welcomeMessage.style.display = isLoggedIn ? 'block' : 'none';
                    welcomeMessage.textContent = isLoggedIn ? `Benvenuto, ${user.email}!` : '';
                    btnSignOut.style.display = isLoggedIn ? 'block' : 'none';
                    authStatusP.textContent = isLoggedIn ? '' : "Non autenticato";
                    authSection.classList.toggle('logged-in', isLoggedIn);
                    mainTrackerContent.classList.toggle('authenticated', isLoggedIn);
                    applyProfileSectionVisibility();
                    cloudSyncStatusSpan.textContent = `Connessione Cloud: ${isLoggedIn ? user.email : 'Disconnesso'}`;
                    cloudSyncStatusSpan.className = `cloud-sync-status ${isLoggedIn ? 'connected' : 'disconnected'}`;
                    cloudSyncSection.querySelectorAll('button').forEach(button => button.disabled = !isLoggedIn);
                    
                    if (isLoggedIn) {
                        try {
                            const cloudProfile = await loadUserProfileFromCloud();
                            const cloudCompleted = await getUserProfileCompletedFromCloud();
                            if (cloudCompleted !== null) {
                                try {
                                    localStorage.setItem(USER_PROFILE_COMPLETED_LOCAL_KEY, cloudCompleted ? 'true' : 'false');
                                } catch (e) {}
                            }
                            if (cloudProfile) {
                                userProfile = cloudProfile;
                                writeProfileToForm(userProfile);
                                updateProfileSummary(userProfile);
                                aggiornaUI();
                                renderMealBuilder();
                            }
                            applyProfileSectionVisibility();
                        } catch (e) {
                            console.error('Errore caricamento profilo da cloud', e);
                            applyProfileSectionVisibility();
                        }
                        const lastLocalUpdate = parseInt(localStorage.getItem(LOCAL_LAST_UPDATE_KEY) || 0);
                        const cloudTimestampSnapshot = await get(ref(db, `users/${currentUserUID}/${CLOUD_LAST_UPDATE_PATH}`));
                        const lastCloudUpdate = cloudTimestampSnapshot.exists() ? cloudTimestampSnapshot.val() : 0;
                        
                        setTimeout(async () => {
                            if (lastCloudUpdate > lastLocalUpdate) {
                               if (confirm("I dati sul cloud sono pi√π recenti. Vuoi scaricarli ora e sovrascrivere i dati locali?")) {
                                    await loadAllTrackerDataFromCloud(true);
                               }
                            }
                        }, 500);
                    }
                });
            } catch (error) { console.error("Errore Firebase:", error); authStatusP.textContent = `Errore Firebase: ${error.message}`; }

            const authHandlers = {
                register: () => createUserWithEmailAndPassword(auth, userEmailInput.value, userPasswordInput.value),
                login: () => signInWithEmailAndPassword(auth, userEmailInput.value, userPasswordInput.value),
                signOut: () => signOut(auth)
            };
            btnRegister.addEventListener('click', async () => { try { await authHandlers.register(); alert("Registrazione completata!"); } catch (e) { alert(e.message); } });
            btnLogin.addEventListener('click', async () => { try { await authHandlers.login(); alert("Accesso effettuato!"); } catch (e) { alert(e.message); } });
            btnSignOut.addEventListener('click', async () => { try { await authHandlers.signOut(); alert("Disconnessione avvenuta."); } catch (e) { alert(e.message); } });
            
            async function loadAllTrackerDataFromCloud(skipConfirm = false) {
                const dataRef = (db && currentUserUID) ? ref(db, `users/${currentUserUID}/tracker_data/`) : null;
                if (!dataRef) { alert("Devi essere autenticato."); return; }
                if (!skipConfirm && !confirm("ATTENZIONE: i dati locali verranno SOVRASCRITTI. Continuare?")) return;

                try {
                    const snapshot = await get(dataRef);
                    if (snapshot.exists()) {
                        const cloudData = snapshot.val();
                        const keysToRemove = [];
                        for (let i = 0; i < localStorage.length; i++) {
                            const key = localStorage.key(i);
                            if (key.startsWith('trackerStorico_') || LOCAL_STORAGE_SYNC_KEYS.includes(key) || key.startsWith('lastMealTypeSelected_')) {
                                keysToRemove.push(key);
                            }
                        }
                        keysToRemove.forEach(key => localStorage.removeItem(key));
                        
                        for (const key in cloudData) {
                            localStorage.setItem(key, typeof cloudData[key] === 'object' ? JSON.stringify(cloudData[key]) : cloudData[key]);
                        }
                        
                        const cloudTimestampSnapshot = await get(ref(db, `users/${currentUserUID}/${CLOUD_LAST_UPDATE_PATH}`));
                        localStorage.setItem(LOCAL_LAST_UPDATE_KEY, cloudTimestampSnapshot.exists() ? cloudTimestampSnapshot.val() : Date.now());
                        
                        alert("Dati scaricati con successo! La pagina verr√† ricaricata.");
                        location.reload();
                    } else { if (!skipConfirm) alert("Nessun dato trovato sul cloud."); }
                } catch (error) { alert(`Errore download: ${error.message}`); }
            }
            
            btnDownloadManual.addEventListener('click', () => loadAllTrackerDataFromCloud(false));

            const btnEditProfile = document.getElementById('btn-edit-profile');
            if (btnEditProfile && userProfileSection) {
                btnEditProfile.addEventListener('click', () => {
                    userProfileSection.style.display = 'block';
                    userProfileSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                });
            }

            if (controlModeSelect) {
                controlModeSelect.value = getControlMode();
                controlModeSelect.addEventListener('change', () => {
                    setControlMode(controlModeSelect.value);
                    aggiornaUI();
                });
            }

            const profileTargetsAuto = document.getElementById('profile-targets-auto');
            const profileTargetsManual = document.getElementById('profile-targets-manual');
            const profileManualTargetsWrap = document.getElementById('profile-manual-targets-wrap');
            function syncProfileTargetsMode() {
                const manual = profileTargetsManual && profileTargetsManual.checked;
                if (profileManualTargetsWrap) profileManualTargetsWrap.style.display = manual ? 'grid' : 'none';
                if (manual && userProfile && !userProfile.manualTargets) {
                    const base = { ...userProfile, useManualTargets: false };
                    const macros = calculateMacroTargets(base);
                    const kcalEl = document.getElementById('profile-manual-kcal');
                    const protEl = document.getElementById('profile-manual-prot');
                    const carbEl = document.getElementById('profile-manual-carb');
                    const fatEl = document.getElementById('profile-manual-fat');
                    if (kcalEl && !kcalEl.value) kcalEl.value = macros.kcal;
                    if (protEl && !protEl.value) protEl.value = macros.prot;
                    if (carbEl && !carbEl.value) carbEl.value = macros.carb;
                    if (fatEl && !fatEl.value) fatEl.value = macros.fat;
                }
            }
            if (profileTargetsAuto) profileTargetsAuto.addEventListener('change', syncProfileTargetsMode);
            if (profileTargetsManual) profileTargetsManual.addEventListener('change', syncProfileTargetsMode);

            if (btnSaveProfile) {
                btnSaveProfile.addEventListener('click', async () => {
                    const profile = readProfileFromForm();
                    await saveUserProfile(profile);
                    if (!isUserProfileComplete(profile)) {
                        alert('Profilo salvato ma incompleto. Completa tutti i campi chiave per attivare il piano dinamico.');
                    } else {
                        alert('Profilo utente salvato e piano giornaliero aggiornato.');
                    }
                    onProfileSavedSuccess(profile);
                });
            }

            if (btnResetProfile) {
                btnResetProfile.addEventListener('click', async () => {
                    userProfile = null;
                    try {
                        localStorage.removeItem(USER_PROFILE_LOCAL_KEY);
                        localStorage.removeItem(USER_PROFILE_COMPLETED_LOCAL_KEY);
                    } catch (e) {
                        console.error('Errore reset profilo locale', e);
                    }
                    await setUserProfileCompleted(false);
                    if (userProfileSection) userProfileSection.style.display = 'block';
                    writeProfileToForm({
                        sex: '',
                        age: null,
                        height: null,
                        weight: null,
                        goal: '',
                        activityLevel: '',
                        trainingDays: [],
                        mealTimes: {},
                        useManualTargets: false,
                        manualTargets: null
                    });
                    updateProfileSummary(null);
                    aggiornaUI();
                    renderMealBuilder();
                    alert('Profilo utente reimpostato. Torna al piano predefinito.');
                });
            }

            function eseguiMigrazioneStorico() {
                const vecchioStoricoRaw = localStorage.getItem('trackerStorico');
                if (!vecchioStoricoRaw) return;
                try {
                    const vecchioStorico = JSON.parse(vecchioStoricoRaw);
                    if (Array.isArray(vecchioStorico)) {
                        vecchioStorico.forEach(giorno => { if (giorno.data && giorno.log) localStorage.setItem(`trackerStorico_${giorno.data}`, JSON.stringify(giorno)); });
                        localStorage.removeItem('trackerStorico'); 
                        alert("Storico aggiornato al nuovo formato! Ricarica la pagina.");
                    }
                } catch (e) { console.error("Errore migrazione storico.", e); }
            }

            btnCopyPrompt.addEventListener('click', async () => {
                const nome = builderDesc.value.trim(); if (!nome) { alert('Scrivi prima il nome dell\'alimento.'); return; }

                const sanitizedKey = sanitizeFirebaseKey(nome.toLowerCase());
                const foodData = foodDatabase[sanitizedKey];
                let ingredientiInfo = '';
                if (foodData && foodData.ingredienti) {
                    ingredientiInfo = `Considerando questa lista ingredienti: "${foodData.ingredienti}".`;
                }

                const promptText = `Fornisci ESATTAMENTE questo oggetto JSON (senza altro testo) con i valori nutrizionali medi per 100 g di "${nome}". ${ingredientiInfo} ${AI_INSTRUCTION}. ${GEMINI_PROMPT_FORMAT}`;
                try { await navigator.clipboard.writeText(promptText); alert('Richiesta AI copiata!'); } catch (err) { alert('Impossibile copiare.'); }
            });

            btnConfirmJson.addEventListener('click', () => {
                const jsonText = manualJsonInput.value.trim();
                const foodName = builderDesc.value.trim();

                if (!jsonText) { alert('Incolla prima il testo JSON.'); return; }
                if (!foodName) { alert("Inserisci il nome dell'alimento prima di confermare i dati JSON."); return; }
                
                try {
                    const newData = JSON.parse(jsonText);
                    const sanitizedKey = sanitizeFirebaseKey(foodName.toLowerCase());
                    const oldData = foodDatabase[sanitizedKey];
                    const isAnyFieldPopulated = oldData && Object.keys(oldData).length > 3;

                    if (!isAnyFieldPopulated) { 
                        for (const key in newData) {
                            if (inputFields[key]) inputFields[key].el.value = newData[key];
                        }
                        // Calcola sodio dal sale se presente
                        if (newData.sale && !newData.na) {
                            inputFields.na.el.value = Math.round(parseFloat(newData.sale) * 390);
                        }
                        manualJsonInput.value = '';
                        aggiornaColoreNutrienti();
                        alert("Dati JSON compilati con successo.");
                        return;
                    }
                    
                    handleNutrientUpdate(foodName, oldData, newData);

                } catch (err) { alert('Errore nel formato JSON: ' + err.message); }
            });

            function handleNutrientUpdate(foodName, oldData, newData) {
                const SIGNIFICANT_DIFF_THRESHOLD = 0.10; // 10%
                const MINOR_DIFF_THRESHOLD = 0.02;     // 2%

                const differencesForModal = [];
                const autoAveragedValues = {};
                let averagedCount = 0;

                for (const key in newData) {
                    if (!inputFields[key]) continue;

                    const oldVal = parseFloat(oldData[key]);
                    const newVal = parseFloat(newData[key]);
                    
                    if (isNaN(newVal)) continue;
                    if (isNaN(oldVal)) {
                        autoAveragedValues[key] = newVal;
                        continue;
                    }

                    if (oldVal === 0 && newVal === 0) continue;
                    
                    const diffPercent = (oldVal === 0) ? Infinity : Math.abs((newVal - oldVal) / oldVal);

                    if (diffPercent > SIGNIFICANT_DIFF_THRESHOLD) {
                        differencesForModal.push({ 
                            key, 
                            label: inputFields[key].label, 
                            oldVal: oldData[key] ?? 0, 
                            newVal: newData[key] ?? 0
                        });
                    } else if (diffPercent > MINOR_DIFF_THRESHOLD) {
                        autoAveragedValues[key] = (oldVal + newVal) / 2;
                        averagedCount++;
                    }
                }
                
                const finalData = { ...oldData, ...autoAveragedValues };

                if (differencesForModal.length > 0) {
                    populateAndShowDiffModal(foodName, differencesForModal, finalData);
                } else {
                    const sanitizedKey = sanitizeFirebaseKey(foodName.toLowerCase());
                    foodDatabase[sanitizedKey] = finalData;
                    salvaFoodDatabase();
                    
                    for (const key in finalData) {
                        if (inputFields[key]) {
                            inputFields[key].el.value = finalData[key] ?? '';
                        }
                    }
                    // Calcola sodio dal sale se aggiornato
                    if (finalData.sale) {
                        inputFields.na.el.value = Math.round(parseFloat(finalData.sale) * 390);
                    }
                    manualJsonInput.value = '';
                    let alertMessage = "Nessuna differenza rilevante trovata. ";
                    if(averagedCount > 0) {
                        alertMessage += `${averagedCount} valori simili sono stati aggiornati automaticamente con la loro media.`
                    }
                    alert(alertMessage);
                }
            }

            function populateAndShowDiffModal(foodName, differences, initialData) {
                const diffList = document.getElementById('diff-modal-list');
                document.getElementById('diff-modal-title').textContent = `Confronta Valori per "${foodName}"`;
                diffList.innerHTML = '';
                diffList.dataset.initialData = JSON.stringify(initialData);

                differences.forEach(({key, label, oldVal, newVal}) => {
                    const item = document.createElement('div');
                    item.className = 'diff-item';
                    item.dataset.key = key;
                    item.dataset.oldVal = oldVal;
                    item.dataset.newVal = newVal;
                    item.innerHTML = `
                        <span class="diff-item-label">${label.replace('/100g', '')}</span>
                        <div class="diff-item-choices">
                            <label><input type="radio" name="diff-${key}" value="current" checked> <span class="current-value">Corrente: ${oldVal}</span></label>
                            <label><input type="radio" name="diff-${key}" value="new"> <span class="new-value">Nuovo: ${newVal}</span></label>
                        </div>
                    `;
                    diffList.appendChild(item);
                });
                diffModal.style.display = 'block';
            }
            
            document.getElementById('btn-apply-diff').addEventListener('click', () => {
                const foodName = builderDesc.value.trim();
                const sanitizedKey = sanitizeFirebaseKey(foodName.toLowerCase());
                const diffList = document.getElementById('diff-modal-list');
                const updatedData = JSON.parse(diffList.dataset.initialData);

                document.querySelectorAll('#diff-modal-list .diff-item').forEach(item => {
                    const key = item.dataset.key;
                    const choice = item.querySelector('input[type="radio"]:checked').value;
                    const valueToKeep = (choice === 'new') ? item.dataset.newVal : item.dataset.oldVal;
                    updatedData[key] = parseFloat(valueToKeep);
                });
                
                foodDatabase[sanitizedKey] = updatedData;
                salvaFoodDatabase();

                for (const key in updatedData) {
                    if (inputFields[key]) {
                        inputFields[key].el.value = updatedData[key] ?? '';
                    }
                }
                
                // Calcola sodio dal sale se aggiornato
                if (updatedData.sale) {
                    inputFields.na.el.value = Math.round(parseFloat(updatedData.sale) * 390);
                }
                
                diffModal.style.display = 'none';
                manualJsonInput.value = '';
                alert(`Valori per "${foodName}" aggiornati con successo.`);
            });

            document.getElementById('btn-cancel-diff').addEventListener('click', () => {
                diffModal.style.display = 'none';
            });
            
            btnEditIngredients.addEventListener('click', () => {
                const foodName = builderDesc.value.trim();
                openIngredientModal(foodName, false);
            });

            btnSaveIngredients.addEventListener('click', () => {
                const foodName = ingredientModalTitle.textContent;
                const sanitizedKey = sanitizeFirebaseKey(foodName.toLowerCase());
                
                if (!foodDatabase[sanitizedKey]) {
                    foodDatabase[sanitizedKey] = { desc: foodName };
                }
                
                foodDatabase[sanitizedKey].ingredienti = ingredientModalTextarea.value.trim();
                salvaFoodDatabase();
                alert(`Ingredienti per "${foodName}" salvati.`);
                ingredientModal.style.display = 'none';
            });

            btnGenerateIngredientsAi.addEventListener('click', async (e) => {
                const foodName = ingredientModalTitle.textContent;
                const existingText = ingredientModalTextarea.value.trim();
                
                if (!foodName && !existingText) {
                    alert("Inserisci un nome per l'alimento o del testo da riformattare.");
                    return;
                }
                
                const button = e.target.closest('button');
                button.disabled = true;
                const originalText = ingredientModalTextarea.value;
                ingredientModalTextarea.value = "Elaborazione AI in corso...";
                ingredientModalTextarea.disabled = true;

                try {
                    let prompt;
                    
                    if (existingText) {
                        prompt = `Agisci come un esperto di etichette alimentari. Riformatta il seguente testo per creare una lista di ingredienti pulita e ben formattata, in ordine decrescente di quantit√† e con percentuali stimate ove possibile. Rimuovi qualsiasi informazione che non sia un ingrediente (come istruzioni, note o frasi superflue). Rispondi ESCLUSIVAMENTE con la lista pulita, senza frasi introduttive o conclusive. Testo da pulire: "${existingText}"`;
                    } else {
                        prompt = `Agisci come un esperto di etichette alimentari. Genera una lista di ingredienti per il prodotto commerciale "${foodName}". Rispondi ESCLUSIVAMENTE con la lista, senza frasi introduttive o conclusive. Il formato deve essere un elenco puntato, un ingrediente per riga. √à FONDAMENTALE che la lista rifletta il contenuto di un PRODOTTO CONFEZIONATO (es. un sacchetto di minestrone surgelato), NON una ricetta per prepararlo. Pertanto, NON includere ingredienti come acqua aggiunta in cottura, olio, sale o pasta, a meno che non siano specificati come pre-inseriti nel prodotto. Se non conosci l'etichetta esatta, basati su prodotti concorrenti simili dei supermercati.`;
                    }

                    const callGemini = httpsCallable(window.functions, 'callOpenAI');
                    const result = await callGemini({ prompt: prompt });
                    const data = result.data;
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || 'Nessuna risposta dall\'AI.';

                    ingredientModalTextarea.value = text.replace(/[\*]/g, '-').trim();

                } catch (err) {
                    alert('Errore generazione ingredienti: ' + err.message);
                    ingredientModalTextarea.value = originalText;
                } finally {
                    button.disabled = false;
                    ingredientModalTextarea.disabled = false;
                }
            });

            btnCopyIngredientsPrompt.addEventListener('click', async () => {
                const foodName = ingredientModalTitle.textContent;
                const prompt = `Agisci come un esperto di etichette alimentari. Genera una lista di ingredienti per il prodotto commerciale "${foodName}". Rispondi ESCLUSIVAMENTE con la lista, senza frasi introduttive o conclusive. Il formato deve essere un elenco puntato, un ingrediente per riga. √à FONDAMENTALE che la lista rifletta il contenuto di un PRODOTTO CONFEZIONATO (es. un sacchetto di minestrone surgelato), NON una ricetta per prepararlo. Pertanto, NON includere ingredienti come acqua aggiunta in cottura, olio, sale o pasta, a meno che non siano specificati come pre-inseriti nel prodotto. Se non conosci l'etichetta esatta, basati su prodotti concorrenti simili dei supermercati.`;
                try {
                    await navigator.clipboard.writeText(prompt);
                    alert('Prompt per ingredienti copiato!');
                } catch (err) {
                    alert('Impossibile copiare il prompt.');
                }
            });

            btnClearIngredients.addEventListener('click', () => {
                ingredientModalTextarea.value = '';
                ingredientModalTextarea.focus();
            });
            
            btnPhotoIngredients.addEventListener('click', () => {
                ingredientPhotoInput.click();
            });

            ingredientPhotoInput.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                ocrStatusIngredients.textContent = 'Elaborazione immagine...';
                ocrStatusIngredients.style.display = 'block';
                ingredientModalTextarea.disabled = true;

                try {
                    const { data: { text } } = await Tesseract.recognize(file, 'ita');
                    ingredientModalTextarea.value += (ingredientModalTextarea.value ? '\n' : '') + text;
                } catch (error) {
                    console.error(error);
                    ocrStatusIngredients.textContent = "Errore nel riconoscimento.";
                    setTimeout(() => { ocrStatusIngredients.style.display = 'none'; }, 3000);
                } finally {
                    ocrStatusIngredients.style.display = 'none';
                    ingredientModalTextarea.disabled = false;
                    ingredientPhotoInput.value = '';
                }
            });
            
            btnPhotoNutrients.addEventListener('click', () => {
                nutrientPhotoInput.click();
            });

            nutrientPhotoInput.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (file) {
                    processOCRImage(file);
                }
            });
            
            btnConfirmNutrients.addEventListener('click', () => {
                const inputs = nutrientConfirmList.querySelectorAll('input');
                inputs.forEach(input => {
                    const key = input.dataset.nutrientKey;
                    const value = input.value;
                    if(inputFields[key]) {
                        inputFields[key].el.value = value;
                    }
                });
                // Calcola sodio dal sale se confermato
                if (inputFields.sale.el.value) {
                    const saleVal = parseFloat(inputFields.sale.el.value) || 0;
                    inputFields.na.el.value = Math.round(saleVal * 390);
                }
                nutrientConfirmModal.style.display = 'none';
                aggiornaColoreNutrienti();
            });

            btnCancelNutrients.addEventListener('click', () => {
                nutrientConfirmModal.style.display = 'none';
            });
            
            const btnExportAi = document.getElementById('btn-export-json-ai');
            if (btnExportAi) {
                btnExportAi.addEventListener('click', async () => {
                    const dataRef = new Date(giornoVisualizzato);
                    const piano = getPianoDelGiornoForDate(dataRef);
                    const targetKcal = piano.cal_base + (datiGiornalieri.workoutCalorie || 0) + (datiGiornalieri.calorieAdjustment || 0);
                    
                    const allNutrientKeys = [
                        'prot', 'kcal', 'carb', 'zuccheri', 'fatTotal', 'fatSat', 'fatTrans', 
                        'fatMono', 'fatPoly', 'omega3', 'omega6', 'fibreTotali', 'fibreSolubili', 'fibreInsolubili',
                        'sale', 'na', 'mg', 'k', 'vitc', 'ca', 'fe', 'zn', 'cu', 'p', 
                        'vitA', 'vitB12', 'vitD', 'vitE', 'vitK', 'b9', 'b2', 'b6',
                        'leu', 'iso', 'val', 'lys', 'met', 'phe', 'thr', 'trp', 'his'
                    ];

                    let dailyTotals = {};
                    allNutrientKeys.forEach(k => dailyTotals[k] = 0);

                    const logDettagliato = [];

                    (datiGiornalieri.log || []).forEach(entry => {
                        if (entry.type === 'workout') return;

                        const items = entry.type === 'meal' ? entry.items : [entry];
                        const itemsExport = items.map(item => {
                            const cleanItem = {
                                alimento: item.desc,
                                qta_g: item.qta
                            };
                            
                            allNutrientKeys.forEach(key => {
                                const val = item[key];
                                if (val !== undefined && val !== null && (val > 0 || key === 'kcal' || key === 'prot')) {
                                    cleanItem[key] = Number(val.toFixed(2));
                                    dailyTotals[key] += val;
                                }
                            });
                            
                            if (!item.kcal && !item.cal) cleanItem._WARNING = "Kcal a 0 o mancanti";
                            
                            return cleanItem;
                        });

                        logDettagliato.push({
                            tipo: entry.type === 'meal' ? `Pasto: ${entry.desc}` : 'Alimento Singolo',
                            dettagli: itemsExport
                        });
                    });

                    const fullExportData = {
                        meta: {
                            data: giornoVisualizzato,
                            giorno_tipo: piano.tipo,
                            note_utente: datiGiornalieri.note || "Nessuna nota"
                        },
                        cruscotto_totali: {
                            MACROS: {
                                Kcal: { consumate: dailyTotals.kcal.toFixed(0), target: targetKcal },
                                Proteine: { consumate: dailyTotals.prot.toFixed(1), target: piano.prot },
                                Carboidrati: { consumate: dailyTotals.carb.toFixed(1), target: piano.carb },
                                Grassi: { consumate: dailyTotals.fatTotal.toFixed(1), target: OBIETTIVI_FAT.fatTotal },
                                Sale: { consumate: dailyTotals.sale.toFixed(1), target: "5g max" }
                            },
                            MICROS_CRITICI: {
                                Fibre: dailyTotals.fibreTotali.toFixed(1),
                                Zuccheri: dailyTotals.zuccheri.toFixed(1),
                                Grassi_Saturi: dailyTotals.fatSat.toFixed(1),
                                Sodio: dailyTotals.na.toFixed(0),
                                Potassio: dailyTotals.k.toFixed(0)
                            },
                            OMEGA_RATIO: (dailyTotals.omega3 > 0) ? `1:${(dailyTotals.omega6/dailyTotals.omega3).toFixed(1)}` : "N/D"
                        },
                        allenamento: {
                            descrizione: (datiGiornalieri.log || []).filter(e => e.type === 'workout').map(e => e.desc).join(", ") || "Riposo",
                            kcal_bruciate: datiGiornalieri.workoutCalorie || 0
                        },
                        diario_alimentare_completo: logDettagliato
                    };

                    try {
                        const jsonString = JSON.stringify(fullExportData, null, 2);
                        await navigator.clipboard.writeText(jsonString);
                        alert("‚úÖ Dati COMPLETI copiati (Nutrienti, Micros, Log)!\n\nIncolla su ChatGPT/Gemini e chiedi:\n'Analizza questo JSON. Cerca anomalie nei dati (es. cibi con calorie a zero) e dammi un parere nutrizionale.'");
                    } catch (err) {
                        console.error("Errore copia:", err);
                        alert("Errore nella copia automatica. Controlla la console.");
                    }
                });
            }
        
        // ESPORTA VARIABILI PER LA CHAT AI
        window.giornoVisualizzato = giornoVisualizzato;
        window.datiGiornalieri = datiGiornalieri;
        window.PIANO_SETTIMANALE = PIANO_SETTIMANALE;
        window.OBIETTIVI_FAT = OBIETTIVI_FAT;
        window.OBIETTIVI_MICRO = OBIETTIVI_MICRO;
        window.OBIETTIVI_VIT = OBIETTIVI_VIT;
        window.OBIETTIVI_AMINO = OBIETTIVI_AMINO;
        window.OBIETTIVI_FIBRE = OBIETTIVI_FIBRE;
        window.PROFILO_AMINOACIDICO_RIFERIMENTO = PROFILO_AMINOACIDICO_RIFERIMENTO;
        window.salvaGiorno = salvaGiorno;
        window.aggiornaUI = aggiornaUI;
        window.foodDatabase = foodDatabase;
        window.salvaFoodDatabase = salvaFoodDatabase;
        window.sanitizeFirebaseKey = sanitizeFirebaseKey;
        window.calculateMacroTargets = calculateMacroTargets;
        window.getPianoDelGiornoForDate = getPianoDelGiornoForDate;
        window.loadUserProfileFromLocal = loadUserProfileFromLocal;
        window.getCurrentTimeString = getCurrentTimeString;
        window.runWeeklyAutoAdaptationIfNeeded = runWeeklyAutoAdaptationIfNeeded;
        window.loadAutoAdjustHistoryFromLocal = loadAutoAdjustHistoryFromLocal;
        window.analyzeLast7DaysForAutoAdaptation = analyzeLast7DaysForAutoAdaptation;
        window.loadAdherenceScoresFromLocal = loadAdherenceScoresFromLocal;
        window.computeAdherenceScore = computeAdherenceScore;
        window.getControlMode = getControlMode;
        window.setControlMode = setControlMode;
        window.getToleranceForMode = getToleranceForMode;
        window.getNutrientRanges = getNutrientRanges;
        window.computeParamState = computeParamState;
        window.computeGlobalBodyState = computeGlobalBodyState;

});
    </script>

        <!-- CHAT AI INTEGRATA -->
<div id="ai-chat-widget" class="ai-chat-widget minimized">
    <div class="ai-chat-header" id="ai-chat-toggle">
        <span>ü§ñ Assistente AI</span>
        <button id="ai-open-settings" title="Configura API" style="background:none; border:none; cursor:pointer; font-size:1.2em; color:white; padding:0; margin-left:10px;">‚öôÔ∏è</button>
        <span id="ai-toggle-icon" style="margin-left:auto;">‚ñ≤</span>
    </div>
    <div class="ai-chat-body" style="display: flex; flex-direction: column; height: 450px;">
        <div id="ai-chat-settings" style="display:none; padding:10px; background:#f0f0f0; border-bottom:1px solid #ccc;">
            <div style="margin-bottom:10px;">
                <label style="font-size:0.85em; font-weight:bold; color:#333; display:block; margin-bottom:3px;">üîë API Key Primaria (Gratuita):</label>
                <input type="password" id="ai-api-key-1" placeholder="Inserisci prima API Key..." style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
            </div>
            <div style="margin-bottom:10px;">
                <label style="font-size:0.85em; font-weight:bold; color:#666; display:block; margin-bottom:3px;">üîë API Key Secondaria (Backup):</label>
                <input type="password" id="ai-api-key-2" placeholder="Inserisci seconda API Key..." style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
            </div>
            <div style="display:flex; gap:5px;">
                <button id="ai-save-api-key" style="flex:1; padding:8px 12px; background:#4caf50; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:600;">Salva Chiavi</button>
                <button id="ai-close-settings" style="padding:8px 12px; background:#607d8b; color:white; border:none; border-radius:4px; cursor:pointer;">X</button>
            </div>
            <p id="ai-api-status" style="margin:8px 0 0 0; font-size:0.8em; min-height:1.2em;"></p>
        </div>
        <div class="ai-chat-messages" id="ai-chat-messages" style="flex:1; overflow-y:auto; padding:15px; background:#f8f9fa; display:flex; flex-direction:column;">
            <div class="ai-message assistant" style="background:white; color:#333; border:1px solid #e0e0e0; border-radius:18px 18px 18px 4px; padding:10px 15px; max-width:80%; align-self:flex-start;">Pronto! Consulta il tuo database e aggiungi alimenti al costruttore pasti.</div>
        </div>
        <div class="ai-chat-input-area" style="display:flex; padding:10px; border-top:1px solid #eee; gap:8px; background:white;">
            <textarea id="ai-chat-input" placeholder="Cosa hai mangiato?" style="flex:1; border:1px solid #ddd; border-radius:20px; padding:10px 15px; resize:none; font-family:inherit; font-size:0.95em; outline:none; height:40px;"></textarea>
            <button id="ai-chat-send" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; border:none; border-radius:50%; width:44px; height:44px; cursor:pointer; font-size:1.2em; display:flex; align-items:center; justify-content:center;">‚û§</button>
        </div>
    </div>
</div>
    <!-- MODAL PER CONFERMA ALIMENTO DALLA CHAT -->
    <div id="ai-chat-food-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" data-modal="ai-chat-food-modal">&times;</span>
            <h2>Conferma Alimento Riconosciuto</h2>
            <p>L'AI ha riconosciuto questo alimento. Vuoi aggiungerlo al diario?</p>
            <div id="ai-chat-food-details" style="margin: 15px 0; padding: 15px; background: #f5f5f5; border-radius: 8px;"></div>
            <div class="button-group">
                <button id="ai-chat-food-cancel" style="background-color: #607d8b;">Annulla</button>
                <button id="ai-chat-food-confirm" style="background-color: #2e7d32;">Aggiungi al Diario</button>
            </div>
        </div>
    </div>

    <style>
        /* CHAT AI STYLES */
/* --- COPIA DA QUI --- */
.ai-chat-widget {
    position: fixed !important;
    bottom: 20px !important;
    right: 20px !important;
    width: 380px !important;
    background: white !important;
    border-radius: 16px !important;
    box-shadow: 0 8px 32px rgba(0,0,0,0.3) !important;
    z-index: 99999 !important;
    display: flex !important;
    flex-direction: column !important;
    overflow: hidden !important;
    transition: all 0.3s ease-in-out !important;
    border: 1px solid #ddd !important;
}

        /* CHAT AI STYLES */
        .ai-chat-widget {
            position: fixed !important;
            bottom: 20px !important;
            right: 20px !important;
            width: 380px !important;
            background: white !important;
            border-radius: 16px !important;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3) !important;
            z-index: 99999 !important;
            display: flex !important;
            flex-direction: column !important;
            overflow: hidden !important;
            transition: all 0.3s ease-in-out !important;
            border: 1px solid #ddd !important;
        }

        .ai-chat-widget.minimized {
            height: 50px !important;
        }

        .ai-chat-widget.minimized .ai-chat-body {
            display: none !important;
        }

        .ai-chat-widget:not(.minimized) {
            height: 500px !important;
        }

        .ai-chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
            padding: 0 15px !important;
            height: 50px !important;
            display: flex !important;
            align-items: center !important;
            cursor: pointer !important;
            font-weight: bold !important;
            flex-shrink: 0 !important;
        }

        .ai-chat-header span:first-child {
            flex: 1 !important;
        }

        #ai-open-settings {
            background: none !important;
            border: none !important;
            color: white !important;
            font-size: 1.2em !important;
            cursor: pointer !important;
            padding: 5px !important;
            margin-right: 10px !important;
            opacity: 0.8 !important;
            transition: all 0.2s ease !important;
        }

        #ai-open-settings:hover {
            opacity: 1 !important;
            transform: rotate(30deg) !important;
        }

        #ai-toggle-icon {
            font-size: 0.8em !important;
            margin-left: auto !important;
        }

        .ai-chat-body {
            display: flex !important;
            flex-direction: column !important;
            flex: 1 !important;
            overflow: hidden !important;
        }

        .ai-chat-messages {
            flex: 1 !important;
            overflow-y: auto !important;
            padding: 15px !important;
            background: #f8f9fa !important;
            display: flex !important;
            flex-direction: column !important;
        }

        .ai-message {
            max-width: 80% !important;
            margin-bottom: 10px !important;
            padding: 10px 15px !important;
            border-radius: 18px !important;
            word-wrap: break-word !important;
        }

        .ai-message.user {
            background: #667eea !important;
            color: white !important;
            border-radius: 18px 18px 4px 18px !important;
            align-self: flex-end !important;
            margin-left: 20% !important;
        }

        .ai-message.assistant {
            background: white !important;
            color: #333 !important;
            border: 1px solid #e0e0e0 !important;
            border-radius: 18px 18px 18px 4px !important;
            align-self: flex-start !important;
            margin-right: 20% !important;
        }

        .ai-chat-input-area {
            display: flex !important;
            padding: 10px !important;
            border-top: 1px solid #eee !important;
            gap: 8px !important;
            background: white !important;
        }

        .ai-chat-input-area textarea {
            flex: 1 !important;
            border: 1px solid #ddd !important;
            border-radius: 20px !important;
            padding: 10px 15px !important;
            resize: none !important;
            font-family: inherit !important;
            font-size: 0.95em !important;
            outline: none !important;
            height: 40px !important;
        }

        .ai-chat-input-area textarea:focus {
            border-color: #667eea !important;
        }

        #ai-chat-settings {
            background: #f0f0f0 !important;
            border-bottom: 1px solid #ccc !important;
            padding: 10px !important;
        }

        #ai-api-key-input {
            width: 65% !important;
            padding: 8px !important;
            border: 1px solid #ccc !important;
            border-radius: 4px !important;
            margin-right: 5px !important;
        }

        #ai-save-api-key {
            padding: 8px 12px !important;
            background: #4caf50 !important;
            color: white !important;
            border: none !important;
            border-radius: 4px !important;
            cursor: pointer !important;
            font-size: 0.9em !important;
        }

        #ai-close-settings {
            padding: 8px 12px !important;
            background: #607d8b !important;
            color: white !important;
            border: none !important;
            border-radius: 4px !important;
            cursor: pointer !important;
            font-size: 0.9em !important;
            margin-left: 5px !important;
        }

        #ai-api-status {
            margin: 5px 0 0 0 !important;
            font-size: 0.85em !important;
        }

        .ai-chat-meal-buttons {
            margin-top: 10px !important;
        }

        .ai-chat-meal-buttons p {
            margin-bottom: 10px !important;
            color: #667eea !important;
            font-weight: 600 !important;
        }

        .ai-chat-meal-buttons button {
            margin: 5px !important;
            padding: 8px 15px !important;
            border: 1px solid #667eea !important;
            border-radius: 20px !important;
            background: white !important;
            color: #667eea !important;
            cursor: pointer !important;
            transition: all 0.3s !important;
            font-size: 0.9em !important;
        }

        .ai-chat-meal-buttons button:hover {
            background: #667eea !important;
            color: white !important;
        }

        @media (max-width: 480px) {
            .ai-chat-widget {
                width: calc(100vw - 20px) !important;
                right: 10px !important;
                bottom: 10px !important;
            }
        }
    </style>

<script>
// ==========================================
// BLOCCO CHAT AI - VERSIONE CORRETTA SINCRONIZZAZIONE
// ==========================================

(function() {
    // 1. Riferimenti UI
    const aiWidget = document.getElementById('ai-chat-widget');
    const aiMessages = document.getElementById('ai-chat-messages');
    const aiInput = document.getElementById('ai-chat-input');
    const aiSendBtn = document.getElementById('ai-chat-send');
    const aiToggle = document.getElementById('ai-chat-toggle');
    const aiOpenSettings = document.getElementById('ai-open-settings');
    const aiChatSettings = document.getElementById('ai-chat-settings');
    const aiCloseSettings = document.getElementById('ai-close-settings');
    const aiSaveApiKey = document.getElementById('ai-save-api-key');
    const aiApiKey1 = document.getElementById('ai-api-key-1');
    const aiApiKey2 = document.getElementById('ai-api-key-2');
    const aiApiStatus = document.getElementById('ai-api-status');
    const aiToggleIcon = document.getElementById('ai-toggle-icon');

    // Carica API Key esistenti
    if (aiApiKey1) aiApiKey1.value = localStorage.getItem('gemini_api_key_1') || '';
    if (aiApiKey2) aiApiKey2.value = localStorage.getItem('gemini_api_key_2') || '';

    // 2. FUNZIONE CHIAMATA API CON FALLBACK
    async function callGeminiAPI(prompt) {
        const keys = [
            localStorage.getItem('gemini_api_key_1'),
            localStorage.getItem('gemini_api_key_2')
        ].filter(k => k && k.trim() !== '');
        
        if (keys.length === 0) {
            throw new Error("‚ö†Ô∏è Nessuna API Key configurata. Clicca sulla ‚öôÔ∏è per inserire almeno una chiave.");
        }
        
        let lastError = null;
        
        for (let i = 0; i < keys.length; i++) {
            const key = keys[i];
            const keyType = i === 0 ? "Primaria" : "Secondaria";
            
            try {
                const url = `https://generativelanguage.googleapis.com/v1/models/gemini-2.0-flash:generateContent?key=${key}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { temperature: 0.1 }
                    })
                });
                
                if (response.status === 429 || response.status === 401 || response.status === 403) {
                    console.log(`API Key ${keyType} non disponibile (${response.status}), provo backup...`);
                    lastError = new Error(`API ${keyType}: ${response.status === 429 ? 'Token esauriti' : 'Key non valida'}`);
                    continue;
                }
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`${errorData.error?.message || 'Errore API'} (${keyType})`);
                }
                
                const data = await response.json();
                if (data.candidates?.[0]?.content?.parts?.[0]?.text) {
                    console.log(`‚úÖ Successo con API Key ${keyType}`);
                    return data.candidates[0].content.parts[0].text;
                } else {
                    throw new Error(`Risposta vuota da API ${keyType}`);
                }
                
            } catch (e) {
                if (e.message.includes('fetch') || e.message.includes('network') || e.message.includes('Failed to fetch')) {
                    console.log(`Network error con ${keyType}, provo backup...`);
                    lastError = e;
                    continue;
                }
                lastError = e;
                if (e.message.includes('Token esauriti') || e.message.includes('429')) {
                    continue;
                }
                if (i < keys.length - 1) continue;
            }
        }
        
        if (lastError && (lastError.message.includes('Token esauriti') || lastError.message.includes('esauriti'))) {
            throw new Error("‚ö†Ô∏è Entrambe le API Key sono esaurite o non valide. Inserisci nuove chiavi nelle impostazioni.");
        }
        throw lastError || new Error("‚ùå Errore sconosciuto con tutte le API Key disponibili.");
    }

        // 3. LOGICA DI INSERIMENTO AVANZATA CON LASTQTA
    function cercaInDatabase(query) {
        if (!query) return [];
        const db = window.foodDatabase || {};
        const q = query.toLowerCase();
        const results = [];
        
        const exactKey = window.sanitizeFirebaseKey ? window.sanitizeFirebaseKey(q) : q.replace(/[.#$[\]\/]/g, '_');
        if (db[exactKey]) {
            return [{ key: exactKey, data: db[exactKey], exact: true }];
        }
        
        for (const key in db) {
            const item = db[key];
            if (!item || !item.desc) continue;
            const descLower = item.desc.toLowerCase();
            if (descLower.includes(q) || q.includes(descLower) || key.includes(q)) {
                results.push({ key, data: item, exact: false });
            }
        }
        
        return results.sort((a, b) => {
            if (a.exact) return -1;
            if (b.exact) return 1;
            return a.data.desc.localeCompare(b.data.desc);
        });
    }

function gestisciQuantitaEInserimento(data, qtaUtente, pasto) {
        // CASO 1: L'utente ha scritto esplicitamente i grammi (es. "pomodoro 200g")
        // In questo caso, obbediamo subito senza chiedere altro.
        if (qtaUtente > 0) {
            procediInserimentoFinale(data, qtaUtente, pasto);
            return;
        }
        
        // CASO 2: L'utente NON ha messo i grammi, ma c'√® uno storico (lastQta)
        if (data.lastQta && data.lastQta > 0) {
            // Creiamo un elemento visivo in chat per chiedere conferma
            const div = document.createElement('div');
            div.style.cssText = 'background:#e8f5e9; border:1px solid #4caf50; padding:10px; border-radius:8px; margin:5px 0; animation: fadeIn 0.3s;';
            
            div.innerHTML = `<p style="margin:0 0 10px 0; color:#2e7d32; font-weight:600;">
                Trovato storico per <u>${data.desc}</u>.<br>
                Usare l'ultimo valore (<strong>${data.lastQta}g</strong>)?</p>`;
            
            // Bottone S√å (Usa storico)
            const btnSi = document.createElement('button');
            btnSi.textContent = "‚úÖ S√¨, usa";
            btnSi.style.cssText = 'margin-right:8px; padding:8px 15px; background:#4caf50; color:white; border:none; border-radius:5px; cursor:pointer; font-weight:bold;';
            btnSi.onclick = () => {
                div.remove(); // Toglie la domanda
                addMessage(`Ok, uso ${data.lastQta}g`, 'assistant');
                procediInserimentoFinale(data, data.lastQta, pasto);
            };
            
            // Bottone NO (Inserisci manualmente)
            const btnNo = document.createElement('button');
            btnNo.textContent = "‚úèÔ∏è No, cambia";
            btnNo.style.cssText = 'padding:8px 15px; background:#fff; border:1px solid #ccc; color:#333; border-radius:5px; cursor:pointer;';
            btnNo.onclick = () => {
                div.remove(); // Toglie la domanda
                chiediQuantitaManuale(data, pasto); // Passa alla funzione di input manuale
            };
            
            div.appendChild(btnSi);
            div.appendChild(btnNo);
            
            addMessageElement(div); // Aggiunge il blocco alla chat
            return;
        }

        // CASO 3: Nessuna quantit√† specificata e nessun storico -> Chiedi manuale
        chiediQuantitaManuale(data, pasto);
    }
    // Nuova funzione per aggiungere allenamenti diretti
    function addWorkoutDirectly(desc, kcal) {
        // Controlla se le variabili globali sono accessibili
        if (!window.datiGiornalieri || !window.salvaGiorno || !window.aggiornaUI) {
            console.error("Errore: Variabili globali non trovate.");
            return;
        }

        // Inizializza l'array log se non esiste
        if (!window.datiGiornalieri.log) window.datiGiornalieri.log = [];

        // Crea l'oggetto allenamento
        const newWorkout = { 
            type: 'workout', 
            desc: desc.charAt(0).toUpperCase() + desc.slice(1), 
            kcal: kcal,
            time: window.getCurrentTimeString ? window.getCurrentTimeString() : '23:59'
        };

        // Aggiunge al log
        window.datiGiornalieri.log.push(newWorkout);

        // Aggiorna il totale calorie bruciate
        window.datiGiornalieri.workoutCalorie = (window.datiGiornalieri.workoutCalorie || 0) + kcal;

        // Salva e aggiorna l'interfaccia
        window.salvaGiorno(window.giornoVisualizzato, window.datiGiornalieri);
        window.aggiornaUI();

        // Conferma in chat
        addMessage(`üí™ Allenamento registrato: <strong>${newWorkout.desc}</strong> (-${kcal} kcal)`, 'assistant');
    }

    function mostraSelezioneMultipla(nomeOriginale, results, qtaUtente, pasto) {
        const div = document.createElement('div');
        div.style.cssText = 'background:#e3f2fd; border:1px solid #90caf9; padding:15px; border-radius:8px; margin:10px 0; max-width:90%;';
        div.innerHTML = `<p style="margin:0 0 10px 0; font-weight:600; color:#1565c0;">Scegli quale "${nomeOriginale}":</p>`;
        
        results.forEach(r => {
            const btn = document.createElement('button');
            const qtaInfo = r.data.lastQta ? ` (ultimo: ${r.data.lastQta}g)` : '';
            btn.textContent = `${r.data.desc}${qtaInfo}`;
            btn.style.cssText = 'display:block; width:100%; margin:5px 0; padding:10px; border:1px solid #1976d2; background:white; color:#1976d2; border-radius:6px; cursor:pointer; text-align:left; transition:all 0.2s;';
            btn.onmouseover = () => { btn.style.background='#1976d2'; btn.style.color='white'; };
            btn.onmouseout = () => { btn.style.background='white'; btn.style.color='#1976d2'; };
            btn.onclick = () => {
                div.remove();
                gestisciQuantitaEInserimento(r.data, qtaUtente, pasto);
            };
            div.appendChild(btn);
        });
        
        addMessageElement(div);
    }

    function mostraDialogoNuovoAlimento(nome, qtaUtente, pasto) {
        const div = document.createElement('div');
        div.style.cssText = 'background:#fff3e0; border:2px solid #ff9800; padding:15px; border-radius:8px; margin:10px 0; max-width:90%;';
        div.innerHTML = `<p style="margin:0 0 15px 0; font-weight:600; color:#e65100;">"${nome}" non trovato</p>`;
        
        const btnManual = document.createElement('button');
        btnManual.textContent = '‚úèÔ∏è Compila manualmente nel form';
        btnManual.style.cssText = 'display:block; width:100%; margin:8px 0; padding:12px; border:1px solid #4caf50; background:#e8f5e9; color:#2e7d32; border-radius:6px; cursor:pointer; font-weight:600;';
        btnManual.onclick = () => {
            div.remove();
            document.getElementById('builder-desc').value = nome;
            if (qtaUtente > 0) document.getElementById('builder-qta').value = qtaUtente;
            document.getElementById('builder-desc').focus();
            document.getElementById('food-adder').scrollIntoView({ behavior: 'smooth' });
            addMessage(`Compila i dati per <strong>${nome}</strong> nel form sopra`, 'assistant');
        };
        div.appendChild(btnManual);
        
        const btnAI = document.createElement('button');
        btnAI.textContent = 'ü§ñ Genera con AI e salva';
        btnAI.style.cssText = 'display:block; width:100%; margin:8px 0; padding:12px; border:1px solid #667eea; background:#e8eaf6; color:#3f51b5; border-radius:6px; cursor:pointer; font-weight:600;';
        btnAI.onclick = async () => {
            btnAI.disabled = true;
            btnManual.disabled = true;
            btnAI.textContent = '‚è≥ Generazione...';
            
            try {
                const prompt = `Fornisci dati nutrizionali completi per 100g di "${nome}". 
Formato JSON: {"prot":0.0,"kcal":0,"carb":0.0,"zuccheri":0.0,"fatTotal":0.0,"fatSat":0.0,"fatMono":0.0,"fatPoly":0.0,"omega3":0.0,"omega6":0.0,"fibreTotali":0.0,"fibreSolubili":0.0,"fibreInsolubili":0.0,"sale":0.0,"na":0,"mg":0,"k":0,"vitc":0,"ca":0,"fe":0,"zn":0,"cu":0,"p":0,"vitA":0,"vitB12":0,"vitD":0,"vitE":0,"vitK":0,"b9":0,"b2":0,"b6":0,"leu":0,"iso":0,"val":0,"lys":0,"met":0,"phe":0,"thr":0,"trp":0,"his":0}
Solo JSON, senza testo.`;
                
                const raw = await callGeminiAPI(prompt);
                const clean = raw.substring(raw.indexOf('{'), raw.lastIndexOf('}') + 1);
                const newData = JSON.parse(clean);
                newData.desc = nome.charAt(0).toUpperCase() + nome.slice(1);
                
                div.innerHTML = `
                    <p style="margin:0 0 10px 0; font-weight:600; color:#2e7d32;">‚úÖ Dati generati per ${nome}</p>
                    <div style="background:#f5f5f5; padding:10px; border-radius:4px; font-size:0.85em; margin-bottom:15px;">
                        Prot: ${newData.prot || 0}g | Kcal: ${newData.kcal || 0} | Carb: ${newData.carb || 0}g
                    </div>
                `;
                
                const btnConfirm = document.createElement('button');
                btnConfirm.textContent = '‚úÖ Conferma e aggiungi';
                btnConfirm.style.cssText = 'display:inline-block; margin:5px; padding:10px 20px; border:none; background:#4caf50; color:white; border-radius:6px; cursor:pointer; font-weight:600;';
                btnConfirm.onclick = () => {
                    const key = window.sanitizeFirebaseKey ? window.sanitizeFirebaseKey(nome.toLowerCase()) : nome.toLowerCase().replace(/[.#$[\]\/]/g, '_');
                    if (!window.foodDatabase) window.foodDatabase = {};
                    window.foodDatabase[key] = newData;
                    if (window.salvaFoodDatabase) window.salvaFoodDatabase();
                    
                    div.remove();
                    gestisciQuantitaEInserimento(newData, qtaUtente, pasto);
                };
                
                const btnCancel = document.createElement('button');
                btnCancel.textContent = '‚ùå Annulla';
                btnCancel.style.cssText = 'display:inline-block; margin:5px; padding:10px 20px; border:none; background:#f44336; color:white; border-radius:6px; cursor:pointer;';
                btnCancel.onclick = () => {
                    div.remove();
                    addMessage('Annullato', 'assistant');
                };
                
                div.appendChild(btnConfirm);
                div.appendChild(btnCancel);
                
            } catch (e) {
                div.remove();
                addMessage(`‚ùå Errore: ${e.message}`, 'assistant');
            }
        };
        div.appendChild(btnAI);
        
        addMessageElement(div);
    }

    function chiediQuantitaManuale(data, pasto) {
        const div = document.createElement('div');
        div.style.cssText = 'background:#f5f5f5; padding:15px; border-radius:8px; margin:10px 0; border:1px solid #ddd;';
        div.innerHTML = `
            <p style="margin:0 0 10px 0;">Quanti grammi di <strong>${data.desc}</strong>?</p>
            <input type="number" id="temp-qta-input" placeholder="es. 150" style="width:100px; padding:8px; border:1px solid #ddd; border-radius:4px; margin-right:10px;">
            <button id="temp-qta-btn" style="padding:8px 16px; background:#1976d2; color:white; border:none; border-radius:4px; cursor:pointer;">Conferma</button>
        `;
        
        addMessageElement(div);
        
        setTimeout(() => {
            const input = document.getElementById('temp-qta-input');
            const btn = document.getElementById('temp-qta-btn');
            if (input) input.focus();
            
            const conferma = () => {
                const qta = parseFloat(input.value);
                if (qta > 0) {
                    div.remove();
                    procediInserimentoFinale(data, qta, pasto);
                } else {
                    input.style.borderColor = 'red';
                }
            };
            
            if (btn) btn.onclick = conferma;
            if (input) {
                input.onkeypress = (e) => { if (e.key === 'Enter') conferma(); };
                input.oninput = () => { input.style.borderColor = '#ddd'; };
            }
        }, 100);
    }

    function procediInserimentoFinale(data, qta, pasto) {
        if (!data || !data.desc) return;
        
        // Salva lastQta nel database
        const key = window.sanitizeFirebaseKey ? window.sanitizeFirebaseKey(data.desc.toLowerCase()) : data.desc.toLowerCase().replace(/[.#$[\]\/]/g, '_');
        if (window.foodDatabase) {
            if (!window.foodDatabase[key]) window.foodDatabase[key] = { ...data };
            window.foodDatabase[key].lastQta = qta;
            if (window.salvaFoodDatabase) window.salvaFoodDatabase();
        }
        
        // Sincronizza array
        let currentData = JSON.parse(localStorage.getItem('trackerPastoInCostruzione')) || [];
        if (!window.pastoInCostruzione) {
            window.pastoInCostruzione = currentData;
        } else if (window.pastoInCostruzione.length < currentData.length) {
            window.pastoInCostruzione = currentData;
        }
        
        let item = { desc: data.desc, qta: qta, selezionato: true };
        for (const k in data) { 
            if (!['desc', 'lastQta', 'ingredienti'].includes(k)) {
                const val100g = parseFloat(data[k]) || 0;
                item[k] = (val100g / 100) * qta; 
            }
        }
        
        window.pastoInCostruzione.push(item);
        localStorage.setItem('trackerPastoInCostruzione', JSON.stringify(window.pastoInCostruzione));
        
        if (pasto && document.getElementById('meal-type-selector')) {
            const pastoMap = {
                'colazione': 'merenda1', 'merenda1': 'merenda1', 'merenda am': 'merenda1',
                'pranzo': 'pranzo', 
                'merenda': 'merenda2', 'merenda2': 'merenda2', 'merenda pm': 'merenda2',
                'cena': 'cena'
            };
            const mappedPasto = pastoMap[pasto.toLowerCase()] || 'merenda1';
            document.getElementById('meal-type-selector').value = mappedPasto;
            const today = window.getTodayString ? window.getTodayString() : new Date().toISOString().split('T')[0];
            localStorage.setItem('lastMealTypeSelected_' + today, mappedPasto);
        }

        if (typeof window.renderMealBuilder === 'function') {
            window.renderMealBuilder();
            const builder = document.getElementById('meal-builder-sezione');
            if (builder) {
                builder.dataset.visible = "true";
                builder.style.display = "block";
                setTimeout(() => builder.scrollIntoView({ behavior: 'smooth' }), 100);
            }
        }
        
        addMessage(`‚úÖ <strong>${item.desc}</strong> (${qta}g) aggiunto!`, 'assistant');
    }

    async function addFoodDirectly(nome, qta, pasto) {
        if (!nome) return;
        
        const results = cercaInDatabase(nome);
        
        if (results.length === 0) {
            mostraDialogoNuovoAlimento(nome, qta, pasto);
        } else if (results.length === 1) {
            gestisciQuantitaEInserimento(results[0].data, qta, pasto);
        } else {
            mostraSelezioneMultipla(nome, results, qta, pasto);
        }
    }
    // 4. UTILITY UI
    function addMessage(text, role) {
        if (!aiMessages) return;
        const d = document.createElement('div');
        d.style.cssText = role === 'user' 
            ? 'background:#667eea; color:white; padding:10px 15px; border-radius:18px 18px 4px 18px; margin:5px 0 5px auto; max-width:80%; word-wrap:break-word;'
            : 'background:white; color:#333; padding:10px 15px; border-radius:18px 18px 18px 4px; margin:5px auto 5px 0; max-width:80%; border:1px solid #e0e0e0; word-wrap:break-word;';
        d.innerHTML = text.replace(/\n/g, '<br>');
        aiMessages.appendChild(d);
        aiMessages.scrollTop = aiMessages.scrollHeight;
        return d;
    }

    function addMessageElement(el) {
        if (!aiMessages) return;
        const d = document.createElement('div');
        d.style.cssText = 'margin:5px auto 5px 0; max-width:80%;';
        d.appendChild(el);
        aiMessages.appendChild(d);
        aiMessages.scrollTop = aiMessages.scrollHeight;
        return d;
    }

    // 5. GESTIONE EVENTI
    
    if (aiToggle) {
        aiToggle.onclick = (e) => {
            if (e.target === aiOpenSettings || e.target.closest('#ai-open-settings')) return;
            aiWidget.classList.toggle('minimized');
            if (aiToggleIcon) aiToggleIcon.textContent = aiWidget.classList.contains('minimized') ? '‚ñ≤' : '‚ñº';
            if (aiWidget.classList.contains('minimized') && aiChatSettings) {
                aiChatSettings.style.display = 'none';
            }
        };
    }
    
    if (aiOpenSettings) {
        aiOpenSettings.onclick = (e) => {
            e.stopPropagation();
            if (aiChatSettings) {
                const isVisible = aiChatSettings.style.display === 'block';
                aiChatSettings.style.display = isVisible ? 'none' : 'block';
                if (!isVisible && aiApiKey1) aiApiKey1.focus();
            }
        };
    }
    
    if (aiCloseSettings) {
        aiCloseSettings.onclick = (e) => {
            e.stopPropagation();
            if (aiChatSettings) aiChatSettings.style.display = 'none';
        };
    }
    
    if (aiSaveApiKey) {
        aiSaveApiKey.onclick = (e) => {
            e.stopPropagation();
            const key1 = aiApiKey1 ? aiApiKey1.value.trim() : '';
            const key2 = aiApiKey2 ? aiApiKey2.value.trim() : '';
            
            if (!key1 && !key2) {
                if (aiApiStatus) {
                    aiApiStatus.textContent = '‚ùå Inserisci almeno una chiave';
                    aiApiStatus.style.color = '#d32f2f';
                }
                return;
            }
            
            if (key1) localStorage.setItem('gemini_api_key_1', key1);
            if (key2) localStorage.setItem('gemini_api_key_2', key2);
            
            if (aiApiStatus) {
                const msg = key1 && key2 ? '‚úÖ Entrambe le chiavi salvate!' : 
                           key1 ? '‚úÖ Chiave primaria salvata!' : '‚úÖ Chiave secondaria salvata!';
                aiApiStatus.textContent = msg;
                aiApiStatus.style.color = '#2e7d32';
            }
            setTimeout(() => {
                if (aiChatSettings) aiChatSettings.style.display = 'none';
            }, 1200);
        };
    }

if (aiSendBtn) {
        aiSendBtn.onclick = async () => {
            const text = aiInput.value.trim();
            if (!text) return;
            addMessage(text, 'user');
            aiInput.value = '';
            
            const loading = addMessage("üß† Elaboro...", "assistant");
            loading.style.fontStyle = 'italic';
            loading.style.color = '#666';

            try {
                // PROMPT AVANZATO: Gestisce CIBO e ALLENAMENTO
                const prompt = `Analizza: "${text}".
                
                CASO 1: CIBO (es. "ho mangiato mela", "pasta 100g")
                - Rispondi: [AGGIUNGI: nome | grammi | pasto]
                - Se mancano i grammi, scrivi 0.
                - Pasto default: quello attuale.

                CASO 2: ALLENAMENTO (es. "palestra 200kcal", "corsa", "lavoro pesante")
                - Rispondi: [ALLENAMENTO: descrizione | kcal]
                - Se l'utente scrive le kcal, usa quelle.
                - Se mancano le kcal, STIMALE tu (es. 1h pesi=300, 30min corsa=250, lavoro ufficio=0).

                Rispondi SOLO con i comandi tra parentesi quadre.`;
                
                const resp = await callGeminiAPI(prompt);
                if (loading) loading.remove();

                let foundAny = false;

                // 1. Cerca comandi CIBO
                const regexFood = /\[AGGIUNGI:\s*([^|\]]+?)\s*\|\s*([0-9.,]+)\s*\|\s*([^\]]+?)\]/gi;
                let matchFood;
                while ((matchFood = regexFood.exec(resp)) !== null) {
                    foundAny = true;
                    const nome = matchFood[1].trim();
                    const qta = parseFloat(matchFood[2].replace(',', '.')) || 0;
                    const pasto = matchFood[3].trim().toLowerCase();
                    await gestisciQuantitaEInserimento({ desc: nome }, qta, pasto); // Usa la tua funzione smart
                }

                // 2. Cerca comandi ALLENAMENTO
                const regexWorkout = /\[ALLENAMENTO:\s*([^|\]]+?)\s*\|\s*([0-9.,]+)\]/gi;
                let matchWorkout;
                while ((matchWorkout = regexWorkout.exec(resp)) !== null) {
                    foundAny = true;
                    const desc = matchWorkout[1].trim();
                    const kcal = parseFloat(matchWorkout[2].replace(',', '.')) || 0;
                    addWorkoutDirectly(desc, kcal); // Chiama la nuova funzione diretta
                }

                if (!foundAny) {
                    addMessage(resp, 'assistant'); // Se non trova comandi, mostra la risposta testuale
                }

            } catch (e) {
                if (loading) loading.remove();
                addMessage(`‚ùå Errore: ${e.message}`, "assistant");
            }
        };
    }

    if (aiInput) {
        aiInput.onkeypress = (e) => { 
            if (e.key === 'Enter' && !e.shiftKey) { 
                e.preventDefault(); 
                aiSendBtn.click(); 
            } 
        };
    }

})();
</script>
<div id="toast" aria-live="polite"></div>
</body>
</html>
