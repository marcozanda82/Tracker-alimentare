<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Tracker Nutrizionale</title>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        /* --- IMPOSTAZIONI GLOBALI E LAYOUT PRINCIPALE --- */
        :root {
            --header-height: 100px; /* Altezza dell'intestazione fissa */
        }
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Impedisce lo scroll dell'intera pagina */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f7f9;
        }
        .app-container {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        /* --- INTESTAZIONE FISSA CON NAVIGAZIONE --- */
        .app-header {
            padding: 15px;
            background-color: #ffffff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 100;
            height: var(--header-height);
            box-sizing: border-box;
            text-align: center;
        }
        .app-header h1 {
            margin: 0 0 10px 0;
            font-size: 1.5em;
            color: #0d47a1;
            border: none;
        }
        .page-navigation {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }
        .page-indicator {
            padding: 5px;
            cursor: pointer;
            color: #a0a0a0;
            font-weight: 600;
            font-size: 0.9em;
            transition: all 0.3s ease;
            border-bottom: 2px solid transparent;
        }
        .page-indicator.active {
            color: #1976d2;
            transform: scale(1.1);
            border-bottom-color: #1976d2;
        }
        .page-indicator.adjacent {
            color: #777;
            font-size: 0.8em;
        }

        /* --- LOGICA PER LO SCORRIMENTO LATERALE (SWIPE) --- */
        .swiper-container {
            flex-grow: 1;
            overflow: hidden;
        }
        .swiper-wrapper {
            display: flex;
            height: 100%;
            width: 400%; /* 100% per 4 pagine */
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .page {
            width: 100%;
            height: 100%;
            overflow-y: auto; /* Abilita lo scroll verticale per ogni pagina */
            padding: 20px;
            box-sizing: border-box;
            flex-shrink: 0;
        }
        
        /* --- STILI GENERALI DEI COMPONENTI --- */
        .container { width: 100%; max-width: 800px; margin: 0 auto; }
        h2, h3 { color: #0d47a1; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-top: 0; }
        h2 { font-size: 1.4em; margin-top: 30px; }
        h3 { font-size: 1.1em; color: #333; border-bottom: 1px solid #eee; margin-top: 20px; }
        h4 { font-size: 1em; color: #1565c0; margin-top: 20px; margin-bottom: 10px; font-weight: 600; }
        #titolo-giornata { text-align: center; color: #d84315; font-weight: 600; margin-bottom: 20px; padding: 10px; background-color: #fff3e0; border-radius: 8px; border: 1px solid #ffe0b2;}
        .sezione { margin-bottom: 25px; padding: 20px; background-color: #ffffff; border: 1px solid #e0e0e0; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        input[type="text"], input[type="number"], input[type="date"], select, input[type="email"], input[type="password"], textarea {
            width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 1em;
        }
        button { background-color: #1976d2; color: white; padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 1em; font-weight: 600; transition: background-color 0.3s; }
        button:hover { background-color: #1565c0; }
        #form-allenamento button { background-color: #2e7d32; }
        .nav-links { display: flex; gap: 10px; margin-bottom: 20px; }
        .nav-links a { flex-grow: 1; text-align: center; padding: 10px; background-color: #607d8b; color: white; text-decoration: none; border-radius: 6px; font-weight: 600; }
        #riepilogo p { font-size: 1.1em; margin: 8px 0; }
        progress { width: 100%; height: 15px; border-radius: 6px; margin-top: 2px; cursor: pointer; }
        progress.macro-progress { height: 25px; }
        table { border-collapse: collapse; margin-top: 15px; font-size: 0.9em; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; vertical-align: middle; }
        th { background-color: #f2f2f2; font-weight: 600; }
        .builder-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; }
        .button-group { display: flex; gap: 10px; margin-top: 15px; }
        #btn-costruisci-pasto { background-color: #ff8f00; }
        #btn-aggiungi-singolo { background-color: #5c6bc0; }
        #meal-builder-sezione[data-visible="false"] { display: none; }
        #meal-builder-sezione[data-visible="true"] { display: block; }
        #meal-builder-sezione { border-left: 5px solid #ff8f00; }
        #btn-salva-pasto { background-color: #2e7d32; width: 100%; margin-top: 15px; }
        #caricamento-manuale { margin-top: 25px; padding-top: 20px; border-top: 1px solid #eee;}
        #caricamento-manuale div { display: flex; gap: 10px; align-items: center; }
        #caricamento-manuale input { flex-grow: 1; margin-bottom: 0; }
        #caricamento-manuale button { flex-grow: 0; width: auto; margin-bottom: 0; }
        .action-buttons { display: flex; justify-content: center; align-items: center; gap: 8px; }
        .action-buttons button { background: none; border: none; padding: 4px; font-size: 1.3em; line-height: 1; cursor: pointer; }
        .edit-btn { color: #1976d2; }
        .delete-btn { color: #d32f2f; }
        .meal-group-row { background-color: #f0f4f8; font-weight: bold; }
        .expand-arrow { cursor: pointer; display: inline-block; width: 20px; text-align: center; }
        .sub-item-row td { padding-left: 25px !important; background-color: #fff; font-style: italic; color: #555; border-bottom: 1px dotted #ccc; }
        .sub-item-row td:last-child { visibility: hidden; }
        .nutrients-warning { color: #d32f2f !important; }
        #meal-builder-summary { margin-bottom: 20px; padding: 15px; background-color: #e3f2fd; border: 1px solid #90caf9; border-radius: 8px; }
        #meal-builder-summary p { margin: 5px 0; font-weight: 600; color: #1e88e5; }
        #meal-builder-summary .progress-container { display: flex; gap: 20px; margin-top: 10px; }
        #meal-builder-summary .progress-item { flex: 1; }
        #meal-builder-summary .progress-item p { font-size: 0.9em; margin-bottom: 5px; color: #3f51b5; }
        #meal-builder-summary .progress-item progress { height: 18px; border-radius: 4px; }
        #calorie-balance-text { display: block; text-align: center; font-weight: bold; font-size: 1.2em; margin-top: 15px; margin-bottom: 10px; padding: 8px 0; border-radius: 5px; }
        .balance-deficit { background-color: #ffebee; color: #d32f2f; }
        .balance-surplus { background-color: #e8f5e9; color: #2e7d32; }
        .balance-even { background-color: #e3f2fd; color: #1976d2; }
        .collapsible-header { cursor: pointer; padding: 10px 0; border-bottom: 1px solid #e0e0e0; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; color: #0d47a1; font-size: 1.4em; }
        .collapsible-header:hover { color: #1976d2; }
        .collapsible-header .arrow { font-size: 0.8em; transition: transform 0.3s ease; }
        .collapsible-content { display: none; overflow: hidden; transition: max-height 0.3s ease-out; max-height: 0; }
        .collapsible-content.expanded { display: block; max-height: 2000px; }
        .collapsible-header.expanded .arrow { transform: rotate(90deg); }
        #calorie-adjuster { display: flex; align-items: center; justify-content: center; margin-top: 10px; margin-bottom: 20px; gap: 10px; }
        #calorie-adjuster button { padding: 5px 12px; font-size: 1.2em; border-radius: 5px; background-color: #4CAF50; color: white; border: none; cursor: pointer; }
        .food-label-container { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .food-label-container label { margin-bottom: 0; flex-shrink: 0; }
        #btn-edit-ingredients, #btn-edit-name { background: none; border: none; font-size: 1.1em; color: #607d8b; cursor: pointer; padding: 0; line-height: 1; }
        #btn-edit-ingredients:hover, #btn-edit-name:hover { color: #1976d2; }
        /* ... tutti gli altri stili rimangono invariati ... */
        
        .diary-table-container { 
            overflow-x: auto; 
            -webkit-box-shadow: inset -8px 0px 8px -8px rgba(0,0,0,0.1);
            box-shadow: inset -8px 0px 8px -8px rgba(0,0,0,0.1);
        }
        #log-pasti th, #log-pasti td { min-width: 60px; text-align: right; padding: 8px 10px; white-space: nowrap; }
        #log-pasti th:nth-child(1), #log-pasti td:nth-child(1) { min-width: 150px; text-align: left; position: -webkit-sticky; position: sticky; left: 0; z-index: 2; border-right: 2px solid #e0e0e0; }
        #log-pasti th:nth-child(2), #log-pasti td:nth-child(2) { min-width: 50px; text-align: left; }
        #log-pasti th:last-child, #log-pasti td:last-child { min-width: 80px; text-align: center; }
        #log-pasti th:first-child { background-color: #f8f9fa; }
        #log-pasti td:first-child { background-color: #ffffff; }
        #log-pasti .meal-group-row td:first-child { background-color: #f0f4f8; }
        #log-pasti .sub-item-row td:first-child { background-color: #ffffff; }
        
        /* ... Stili per modali e altri componenti rimangono invariati ... */
    </style>
</head>
<body>
    
    <div class="app-container">
        <header class="app-header">
            <h1>Tracker Nutrizionale</h1>
            <nav class="page-navigation">
                <span class="page-indicator" data-page="0">Dashboard</span>
                <span class="page-indicator" data-page="1">Aggiungi</span>
                <span class="page-indicator" data-page="2">Diario</span>
                <span class="page-indicator" data-page="3">Storico</span>
            </nav>
        </header>

        <main class="swiper-container">
            <div class="swiper-wrapper">

                <section id="page-dashboard" class="page">
                    <div class="container">
                        <div id="auth-section-placeholder"></div>
                        <div id="main-tracker-content-placeholder">
                            <h2 id="titolo-giornata"></h2>
                            <div id="riepilogo" class="sezione">
                                </div>
                        </div>
                    </div>
                </section>

                <section id="page-input" class="page">
                    <div class="container">
                        <div id="form-allenamento" class="sezione">
                            </div>
                        <div id="food-adder" class="sezione">
                            </div>
                        <div id="meal-builder-sezione" class="sezione" data-visible="false">
                            </div>
                        <div class="nav-links" style="margin-top: 20px;">
                            <a href="stima_grassi.html">🫙 Stima Grassi</a>
                        </div>
                    </div>
                </section>

                <section id="page-diary" class="page">
                    <div class="container">
                        <div class="sezione">
                            <h2>Diario Giornaliero</h2>
                            <div class="diary-table-container">
                                <table id="log-pasti">
                                    </table>
                            </div>
                            <div id="caricamento-manuale">
                                </div>
                        </div>
                    </div>
                </section>

                <section id="page-history" class="page">
                    <div class="container">
                        <div class="sezione">
                            <h2>Storico e Analisi</h2>
                            <p>Questa sezione è dedicata ai grafici e alle analisi a lungo termine.</p>
                            <div id="history-content-placeholder">
                                <p style="text-align:center; padding: 20px; color: #777;"><i>Funzionalità di storico in fase di sviluppo.</i></p>
                            </div>
                        </div>
                    </div>
                </section>

            </div>
        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js" type="module"></script> 
    <script type="module">
        // --- LOGICA DI NAVIGAZIONE E SWIPE ---
        const swiperWrapper = document.querySelector('.swiper-wrapper');
        const swiperContainer = document.querySelector('.swiper-container');
        const pageIndicators = document.querySelectorAll('.page-indicator');
        const numPages = pageIndicators.length;
        let currentPageIndex = 0;
        let touchStartX = 0;
        let touchEndX = 0;

        function goToPage(pageIndex) {
            // Gestisce il ciclo continuo
            if (pageIndex < 0) {
                pageIndex = numPages - 1;
            } else if (pageIndex >= numPages) {
                pageIndex = 0;
            }
            
            currentPageIndex = pageIndex;
            swiperWrapper.style.transform = `translateX(-${currentPageIndex * (100 / numPages)}%)`;
            
            updateIndicators();
        }

        function updateIndicators() {
            pageIndicators.forEach((indicator, index) => {
                indicator.classList.remove('active', 'adjacent');
                if (index === currentPageIndex) {
                    indicator.classList.add('active');
                } else if (Math.abs(index - currentPageIndex) === 1 || 
                           (currentPageIndex === 0 && index === numPages - 1) || 
                           (currentPageIndex === numPages - 1 && index === 0)) {
                    indicator.classList.add('adjacent');
                }
            });
        }

        pageIndicators.forEach(indicator => {
            indicator.addEventListener('click', () => {
                goToPage(parseInt(indicator.dataset.page));
            });
        });

        swiperContainer.addEventListener('touchstart', e => {
            touchStartX = e.changedTouches[0].screenX;
        });

        swiperContainer.addEventListener('touchend', e => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        });

        function handleSwipe() {
            const swipeThreshold = 50; // Minima distanza in pixel per considerare uno swipe
            if (touchEndX < touchStartX - swipeThreshold) {
                // Swipe a sinistra
                goToPage(currentPageIndex + 1);
            } else if (touchEndX > touchStartX + swipeThreshold) {
                // Swipe a destra
                goToPage(currentPageIndex - 1);
            }
        }
        
        // Esegui al caricamento
        goToPage(0);

        // --- INIZIO CODICE TRACKER ESISTENTE (leggermente adattato) ---
        
        // Funzione per spostare i contenuti originali nei nuovi contenitori
        function initializeContentPlacement() {
            const originalContainer = document.querySelector('body > .container');
            if (!originalContainer) return;

            // Sposta i modali direttamente nel body
            document.querySelectorAll('.modal, input[type="file"]').forEach(modal => {
                document.body.appendChild(modal);
            });

            // Sposta i contenuti nelle rispettive pagine
            const placeholders = {
                '#auth-section': document.querySelector('#auth-section-placeholder'),
                '#main-tracker-content': document.querySelector('#main-tracker-content-placeholder'),
                '#riepilogo': document.querySelector('#page-dashboard #riepilogo'),
                '#form-allenamento': document.querySelector('#page-input #form-allenamento'),
                '#food-adder': document.querySelector('#page-input #food-adder'),
                '#meal-builder-sezione': document.querySelector('#page-input #meal-builder-sezione'),
                '#log-pasti': document.querySelector('#page-diary #log-pasti'),
                '#caricamento-manuale': document.querySelector('#page-diary #caricamento-manuale')
            };
            
            for(const selector in placeholders){
                const element = originalContainer.querySelector(selector);
                const placeholder = placeholders[selector];
                if(element && placeholder){
                    // Sostituisce il placeholder con l'elemento reale
                    placeholder.parentNode.replaceChild(element, placeholder);
                }
            }

            // Rimuovi il vecchio container, ora vuoto
            originalContainer.remove();
        }


        // Import Firebase (invariato)
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";

        // Dichiarazioni variabili e costanti (invariato)
        // ... (copia qui tutte le tue costanti e variabili let) ...
        const firebaseConfig = {
          apiKey: "AIzaSyA5pSzpfq1aGZ1wjNV5-eXnIqWL6brl424",
          authDomain: "mio-tracker.firebaseapp.com",
          databaseURL: "https://mio-tracker-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "mio-tracker",
          storageBucket: "mio-tracker.firebasestorage.app",
          messagingSenderId: "382993217593",
          appId: "1:382993217593:web:f0780aa061c23f9503f5e8"
        };
        // ... etc ...
        
        document.addEventListener('DOMContentLoaded', () => {
            // La vecchia logica di DOMContentLoaded va qui
            // Prima di tutto, sposta gli elementi
            // NOTA: Poiché il codice originale è già in un listener 'DOMContentLoaded', 
            // sposteremo la logica direttamente qui, senza un ulteriore listener.
        });
        
        // --- TUTTO IL TUO CODICE JAVASCRIPT PRECEDENTE VA QUI ---
        // Copia e incolla l'intero contenuto del tuo precedente blocco <script type="module">,
        // ma assicurati di non duplicare la parte di import di Firebase.
        // Includi tutte le dichiarazioni di variabili, costanti e funzioni.
        // La funzione per lo swipe è già definita sopra, quindi non ricopiarla.
        
        // Esempio di come iniziare a copiare:
        // let giornoVisualizzato = getTodayString('ymd');
        // let datiGiornalieri = {};
        // ... e così via fino alla fine dello script originale ...

        // L'unica funzione da modificare nel tuo codice originale è `populateFormWithData`
        // e `resetInputAlimento` come già fatto nel nostro esempio precedente
        // per gestire il pulsante della matita.
    </script>
</body>
</html>
