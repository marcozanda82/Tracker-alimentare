<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tracker Nutrizionale Definitivo</title>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f7f9; color: #333; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 800px; background-color: #ffffff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1, h2, h3 { color: #0d47a1; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-top: 0; }
        h2 { font-size: 1.4em; margin-top: 30px; }
        h3 { font-size: 1.1em; color: #333; border-bottom: 1px solid #eee; margin-top: 20px; }
        h4 { font-size: 1em; color: #1565c0; margin-top: 20px; margin-bottom: 10px; font-weight: 600; }
        #titolo-giornata { text-align: center; color: #d84315; font-weight: 600; margin-bottom: 20px; padding: 10px; background-color: #fff3e0; border-radius: 8px; border: 1px solid #ffe0b2;}
        .sezione { margin-bottom: 25px; padding: 20px; background-color: #fafafa; border: 1px solid #e0e0e0; border-radius: 8px; border-left-width: 5px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        input[type="text"], input[type="number"], input[type="date"], select, input[type="email"], input[type="password"], textarea {
            width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 1em;
        }
        button { background-color: #1976d2; color: white; padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 1em; font-weight: 600; transition: background-color 0.3s; }
        button:hover { background-color: #1565c0; }
        #form-allenamento button { background-color: #2e7d32; }
        .nav-links { display: flex; gap: 10px; margin-bottom: 20px; }
        .nav-links a { flex-grow: 1; text-align: center; padding: 10px; background-color: #607d8b; color: white; text-decoration: none; border-radius: 6px; font-weight: 600; }
        .sync-button-container { text-align: center; margin-top: 20px; }
        .sync-button { display: inline-block; background-color: #ff8f00; color: white; padding: 10px 15px; text-decoration: none; border-radius: 6px; font-weight: 600; font-size: 0.9em; }
        #riepilogo p { font-size: 1.1em; margin: 8px 0; }
        progress { width: 100%; height: 15px; border-radius: 6px; margin-top: 2px; cursor: pointer; }
        progress.macro-progress { height: 25px; }
        table { border-collapse: collapse; margin-top: 15px; font-size: 0.9em; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; vertical-align: middle; }
        th { background-color: #f2f2f2; font-weight: 600; }
        .builder-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; }
        .button-group { display: flex; gap: 10px; margin-top: 15px; }
        #btn-costruisci-pasto { background-color: #ff8f00; }
        #btn-aggiungi-singolo { background-color: #5c6bc0; }
        #meal-builder-sezione[data-visible="false"] { display: none; }
        #meal-builder-sezione[data-visible="true"] { display: block; }
        #meal-builder-sezione { border-left-color: #ff8f00; }
        #btn-salva-pasto { background-color: #2e7d32; width: 100%; margin-top: 15px; }
        #caricamento-manuale { margin-top: 25px; padding-top: 20px; border-top: 1px solid #eee; border-left-color: #673ab7;}
        #caricamento-manuale div { display: flex; gap: 10px; align-items: center; }
        #caricamento-manuale input { flex-grow: 1; margin-bottom: 0; }
        #caricamento-manuale button { flex-grow: 0; width: auto; margin-bottom: 0; }
        .action-buttons { display: flex; justify-content: center; align-items: center; gap: 8px; }
        .action-buttons button { background: none; border: none; padding: 4px; font-size: 1.3em; line-height: 1; cursor: pointer; }
        .edit-btn { color: #1976d2; }
        .delete-btn { color: #d32f2f; }
        .meal-group-row { background-color: #f0f4f8; font-weight: bold; }
        .expand-arrow { cursor: pointer; display: inline-block; width: 20px; text-align: center; }
        .sub-item-row td { padding-left: 25px !important; background-color: #fff; font-style: italic; color: #555; border-bottom: 1px dotted #ccc; }
        .sub-item-row td:last-child { visibility: hidden; }
        .nutrients-warning { color: #d32f2f !important; }
        #meal-builder-summary { margin-bottom: 20px; padding: 15px; background-color: #e3f2fd; border: 1px solid #90caf9; border-radius: 8px; }
        #meal-builder-summary p { margin: 5px 0; font-weight: 600; color: #1e88e5; }
        #meal-builder-summary .progress-container { display: flex; gap: 20px; margin-top: 10px; }
        #meal-builder-summary .progress-item { flex: 1; }
        #meal-builder-summary .progress-item p { font-size: 0.9em; margin-bottom: 5px; color: #3f51b5; }
        #meal-builder-summary .progress-item progress { height: 18px; border-radius: 4px; }
        #calorie-balance-text { display: block; text-align: center; font-weight: bold; font-size: 1.2em; margin-top: 15px; margin-bottom: 10px; padding: 8px 0; border-radius: 5px; }
        .balance-deficit { background-color: #ffebee; color: #d32f2f; }
        .balance-surplus { background-color: #e8f5e9; color: #2e7d32; }
        .balance-even { background-color: #e3f2fd; color: #1976d2; }
        .collapsible-header { cursor: pointer; padding: 10px 0; border-bottom: 1px solid #e0e0e0; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; color: #0d47a1; font-size: 1.4em; }
        .collapsible-header:hover { color: #1976d2; }
        .collapsible-header .arrow { font-size: 0.8em; transition: transform 0.3s ease; }
        .collapsible-content { display: none; overflow: hidden; transition: max-height 0.3s ease-out; max-height: 0; }
        .collapsible-content.expanded { display: block; max-height: 2000px; }
        .collapsible-header.expanded .arrow { transform: rotate(90deg); }
        #calorie-adjuster { display: flex; align-items: center; justify-content: center; margin-top: 10px; margin-bottom: 20px; gap: 10px; }
        #calorie-adjuster button { padding: 5px 12px; font-size: 1.2em; border-radius: 5px; background-color: #4CAF50; color: white; border: none; cursor: pointer; }
        #calorie-adjuster button.minus { background-color: #f44336; }
        #calorie-adjuster input[type="number"] { width: 80px; text-align: center; font-size: 1.1em; padding: 8px; border: 1px solid #ccc; border-radius: 5px; }
        #calorie-adjuster label { margin-bottom: 0; font-weight: normal; color: #333; }
        .cloud-sync-section { display: flex; gap: 10px; margin-top: 20px; padding: 15px; background-color: #e0f2f7; border: 1px solid #b2ebf2; border-radius: 8px; flex-wrap: wrap; }
        .cloud-sync-section button { flex: 1 1 auto; min-width: 150px; margin-bottom: 5px; }
        .cloud-sync-section #btn-download-manual { background-color: #e64a19; }
        .cloud-sync-status { width: 100%; text-align: center; font-size: 0.9em; color: #555; margin-top: 10px; }
        .cloud-sync-status.connected { color: #2e7d32; font-weight: bold; }
        .cloud-sync-status.disconnected { color: #c62828; font-weight: bold; }
        #auth-section { margin-bottom: 25px; padding: 20px; background-color: #fafafa; border: 1px solid #e0e0e0; border-radius: 8px; border-left-width: 5px; border-left-color: #673ab7; }
        #auth-section h2 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        #auth-section .auth-buttons { display: flex; gap: 10px; }
        #auth-section .auth-buttons button { width: 50%; background-color: #1976d2; }
        #auth-section #btn-sign-out { background-color: #607d8b; display: none; margin-top: 15px; }
        #auth-status { text-align: center; font-weight: 600; margin-top: 15px; }
        #welcome-message { text-align: center; font-weight: bold; font-size: 1.2em; color: #0d47a1; margin-bottom: 10px; display: none; }
        #main-tracker-content { display: none; }
        #main-tracker-content.authenticated { display: block; }
        #auth-section.logged-in { padding: 10px 20px; background-color: #e3f2fd; border: 1px solid #90caf9; box-shadow: none; text-align: center; display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 10px; }
        #auth-section.logged-in #auth-header, #auth-section.logged-in #auth-form-fields, #auth-section.logged-in #auth-status { display: none !important; }
        #auth-section.logged-in #welcome-message { margin: 0; font-size: 1em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #auth-section.logged-in #btn-sign-out { width: auto; padding: 5px 10px; font-size: 0.8em; margin: 0; flex-shrink: 0; }
        .summary-header-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-bottom: 25px; }
        #manual-fill-section { margin-top: 15px; padding-top: 15px; border-top: 1px solid #ccc; }
        #manual-fill-section textarea { width: 100%; height: 100px; margin-top: 10px; resize: vertical; }
        #manual-fill-section .button-group { justify-content: space-between; }
        .fats-bar-container { margin-top: 15px; }
        .fats-group { padding-left: 15px; border-left: 3px solid #eee; margin-top: 15px; }
        .fats-sub-bars-container { display: flex; gap: 20px; margin-top: 10px; }
        .fats-sub-bars-container > div { flex-grow: 1; flex-basis: 0; }
        .progress-fat-sat.green::-webkit-progress-value { background-color: #4CAF50; }
        .progress-fat-sat.green::-moz-progress-bar { background-color: #4CAF50; }
        .progress-fat-sat.orange::-webkit-progress-value { background-color: #ff9800; }
        .progress-fat-sat.orange::-moz-progress-bar { background-color: #ff9800; }
        .progress-fat-sat.red::-webkit-progress-value { background-color: #f44336; }
        .progress-fat-sat.red::-moz-progress-bar { background-color: #f44336; }
        .food-adder-header { display: flex; justify-content: space-between; align-items: center; }
        .food-adder-header button { background: none; border: none; font-size: 1.5em; cursor: pointer; color: #555; padding: 5px 10px; }
        .food-adder-header button:hover { color: #0d47a1; }
        #btn-clear-nutrients { color: #d32f2f; }
        #btn-clear-nutrients:hover { color: #ff1744; }
        .vitamin-group { padding: 10px; margin-top: 10px; background-color: #f9f9f9; border: 1px solid #eee; border-radius: 6px; }
        #vit-content { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .diary-table-container { 
            overflow-x: auto; 
            -webkit-box-shadow: inset -8px 0px 8px -8px rgba(0,0,0,0.1);
            box-shadow: inset -8px 0px 8px -8px rgba(0,0,0,0.1);
        }
        #log-pasti th, #log-pasti td {
            min-width: 60px;
            text-align: right;
            padding: 8px 10px;
            white-space: nowrap;
        }
        #log-pasti th:nth-child(1), #log-pasti td:nth-child(1) {
            min-width: 150px;
            text-align: left;
            position: -webkit-sticky;
            position: sticky;
            left: 0;
            z-index: 2;
            border-right: 2px solid #e0e0e0;
        }
        #log-pasti th:nth-child(2), #log-pasti td:nth-child(2) {
            min-width: 50px;
            text-align: left;
        }
        #log-pasti th:last-child, #log-pasti td:last-child {
            min-width: 80px;
            text-align: center;
        }
        #log-pasti th:first-child { background-color: #f8f9fa; }
        #log-pasti td:first-child { background-color: #ffffff; }
        #log-pasti .meal-group-row td:first-child { background-color: #f0f4f8; }
        #log-pasti .sub-item-row td:first-child { background-color: #ffffff; }
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto; 
            background-color: rgba(0,0,0,0.6); 
            -webkit-animation-name: fadeIn;
            -webkit-animation-duration: 0.4s;
            animation-name: fadeIn;
            animation-duration: 0.4s;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 25px;
            border: 1px solid #888;
            width: 90%;
            max-width: 700px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            -webkit-animation-name: slideIn;
            -webkit-animation-duration: 0.4s;
            animation-name: slideIn;
            animation-duration: 0.4s;
        }
        .modal-close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            line-height: 1;
        }
        .modal-close:hover,
        .modal-close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .modal-content video {
            background-color: #000;
        }
        .vitamin-weekly-summary {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        .vitamin-weekly-summary:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        .vitamin-weekly-summary h4 {
            margin-top: 0;
            margin-bottom: 8px;
            color: #1565c0;
            border: none;
        }
        .vitamin-weekly-summary p {
            margin: 4px 0;
            font-size: 0.95em;
        }
        .vitamin-weekly-summary i {
            color: #555;
            font-size: 0.9em;
        }
        .vitamin-weekly-summary progress {
            width: 100%;
            height: 20px;
        }
        .diff-value { font-weight: bold; }
        .diff-surplus { color: #2e7d32; }
        .diff-deficit { color: #d32f2f; }
        @-webkit-keyframes slideIn { from {top: -300px; opacity: 0} to {top: 0; opacity: 1} }
        @keyframes slideIn { from {margin-top: 5%; opacity: 0} to {margin-top: 10%; opacity: 1} }
        @-webkit-keyframes fadeIn { from {opacity: 0} to {opacity: 1} }
        @keyframes fadeIn { from {opacity: 0} to {opacity: 1} }
        #nutrient-detail-modal-list li {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #nutrient-detail-modal-list li:last-child {
            border-bottom: none;
        }
        #nutrient-detail-modal-list li span {
            font-weight: 600;
        }
        .protein-score {
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 4px;
            color: white;
            font-size: 0.85em;
            text-align: center;
        }
        .protein-score.low { background-color: #d32f2f; }
        .protein-score.medium { background-color: #ff8f00; }
        .protein-score.high { background-color: #2e7d32; }

        .food-label-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        .food-label-container label {
            margin-bottom: 0;
        }
        #btn-edit-ingredients {
            background: none;
            border: none;
            font-size: 1.1em;
            color: #607d8b;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        #btn-edit-ingredients:hover {
            color: #1976d2;
        }
        .ingredient-icon {
            cursor: pointer;
            color: #607d8b;
            margin-right: 8px;
            font-size: 1.1em;
        }
        .ingredient-icon:hover {
            color: #1976d2;
        }
        #ingredient-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        #ingredient-modal-title {
            margin: 0;
            font-size: 1.5em;
            color: #0d47a1;
        }
        #ingredient-modal-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        #ingredient-modal-actions button {
            background: none;
            border: none;
            font-size: 1.6em;
            cursor: pointer;
            padding: 5px;
            color: #555;
        }
        #ingredient-modal-actions button:hover {
            color: #0d47a1;
        }
        #btn-clear-ingredients:hover {
            color: #d32f2f;
        }
        #ingredient-modal-textarea {
            width: 100%;
            height: 200px;
            resize: vertical;
            font-family: monospace;
            font-size: 1em;
        }
        
        #nutrient-confirm-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            max-height: 40vh;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #eee;
            min-height: 50px;
        }
        .nutrient-confirm-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .nutrient-confirm-item label {
            flex-basis: 60%;
            margin-bottom: 0;
            font-size: 0.9em;
        }
        .nutrient-confirm-item input {
            flex-grow: 1;
            margin-bottom: 0;
            padding: 8px;
            font-size: 0.9em;
        }
        .nutrient-confirm-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Tracker Nutrizionale</h1>
        
        <div id="auth-section" class="sezione">
            <h2 id="auth-header">Accedi / Registrati</h2>
            <p id="welcome-message"></p>
            <div id="auth-form-fields">
                <div><label for="user-email">Email</label><input type="email" id="user-email"></div>
                <div><label for="user-password">Password</label><input type="password" id="user-password"></div>
                <div class="auth-buttons">
                    <button id="btn-register">Registrati</button>
                    <button id="btn-login">Accedi</button>
                </div>
            </div>
            <button id="btn-sign-out">Esci</button>
            <p id="auth-status"></p>
        </div>
        <div id="main-tracker-content">
            <div class="summary-header-row">
                <h2 id="titolo-giornata" style="margin: 0; border: none; font-size: 1.2em; text-align: left; background: none; padding: 0; color: #0d47a1;"></h2>
                <button id="btn-open-profile" title="Modifica Profilo e Obiettivi" style="background: none; border: none; font-size: 1.8em; cursor: pointer; color: #0d47a1;">
                    <i class="fas fa-user-cog"></i>
                </button>
            </div>
            
            <div class="nav-links">
                <a href="storico.html">📊 Storico</a>
                <a href="stima_grassi.html">🫙 Stima Grassi</a>
            </div>
            <div id="riepilogo" class="sezione">
                <div class="summary-header-row" style="margin-bottom: 5px;">
                    <h2 style="border: none;">Riepilogo di Oggi</h2>
                </div>
                
                <span id="calorie-balance-text"></span>

                <div id="calorie-adjuster">
                    <label for="calorie-adjustment-input">Correzione Giornaliera:</label>
                    <button id="btn-calorie-minus" class="minus">-</button>
                    <input type="number" id="calorie-adjustment-input" value="0"> <button id="btn-calorie-plus">+</button>
                    <span>kcal</span>
                </div>

                <p style="display: flex; align-items: center; gap: 10px;">
                    <span>Proteine: <span id="totale-proteine">0</span> / <span id="obiettivo-proteine"></span> g</span>
                    <i id="info-proteine-giornata" class="fas fa-info-circle" style="cursor: pointer; color: #1976d2; font-size: 1.2em;"></i>
                </p>
                <progress id="progress-proteine" class="macro-progress" value="0"></progress>
                <p>Calorie: <span id="totale-calorie">0</span> / <span id="obiettivo-calorie"></span> kcal</p>
                <progress id="progress-calorie" class="macro-progress" value="0"></progress>
                <p>Workout: <span id="workout-calories-totali">0</span> kcal</p>
                <hr>

                <h3 class="collapsible-header" id="carbs-header">
                    Carboidrati e Zuccheri <span class="arrow">▶</span>
                </h3>
                <div class="collapsible-content" id="carbs-content">
                    <p>Carboidrati: <span id="totale-carboidrati">0</span> / <span id="obiettivo-carboidrati"></span> g</p>
                    <progress id="progress-carboidrati" class="macro-progress" value="0"></progress>
                    <p>di cui Zuccheri: <span id="totale-zuccheri">0</span> / <span id="obiettivo-zuccheri"></span> g</p>
                    <progress id="progress-zuccheri" class="macro-progress" value="0"></progress>
                </div>
                <hr>
                
                <h3 class="collapsible-header" id="fibre-header">
                    Fibre <span class="arrow">▶</span>
                </h3>
                <div class="collapsible-content" id="fibre-content">
                    <p>Fibre Totali: <span id="totale-fibre-totali">0</span> / <span id="obiettivo-fibre-totali"></span> g</p>
                    <progress id="progress-fibre-totali" class="macro-progress" value="0"></progress>
                    <div class="fats-group" style="padding-left: 15px; border-left: 3px solid #eee; margin-top: 15px;">
                        <p>Solubili: <span id="totale-fibre-solubili">0</span> / <span id="obiettivo-fibre-solubili"></span> g</p>
                        <progress id="progress-fibre-solubili" value="0"></progress>
                        <p>Insolubili: <span id="totale-fibre-insolubili">0</span> / <span id="obiettivo-fibre-insolubili"></span> g</p>
                        <progress id="progress-fibre-insolubili" value="0"></progress>
                    </div>
                </div>
                <hr>
                
                <h3 class="collapsible-header" id="fats-header">
                    <span style="display: flex; align-items: center; gap: 8px;">
                        Grassi
                        <i id="info-fats-settimanali" class="fas fa-info-circle" style="cursor: pointer; color: #1976d2;"></i>
                    </span>
                    <span class="arrow">▶</span>
                </h3>
                <div class="collapsible-content" id="fats-content">
                    <p>Grassi Totali: <span id="totale-fats-total">0</span> / <span id="obiettivo-fats-total"></span> g</p>
                    <progress id="progress-fats-total" class="macro-progress" value="0"></progress>
                    
                    <div class="fats-group">
                         <div class="fats-sub-bars-container">
                            <div>
                                <p>Saturi: <span id="totale-fat-sat">0</span> / <span id="obiettivo-fat-sat"></span> g</p>
                                <progress id="progress-fat-sat" class="progress-fat-sat" value="0"></progress>
                            </div>
                            <div>
                                <p>Trans: <span id="totale-fat-trans">0</span> / <span id="obiettivo-fat-trans"></span> g</p>
                                <progress id="progress-fat-trans" value="0"></progress>
                            </div>
                        </div>
                    </div>

                    <div class="fats-group">
                        <h4>Grassi Insaturi: <span id="totale-fat-unsat">0</span> / <span id="obiettivo-fat-unsat"></span> g</h4>
                        <progress id="progress-fat-unsat" value="0"></progress>
                        <div style="padding-left: 15px;">
                            <p>Monoinsaturi: <span id="totale-fat-mono">0</span> / <span id="obiettivo-fat-mono"></span> g</p>
                            <progress id="progress-fat-mono" value="0"></progress>
                            <p>Polinsaturi: <span id="totale-fat-poly">0</span> / <span id="obiettivo-fat-poly"></span> g</p>
                            <progress id="progress-fat-poly" value="0"></progress>
                            <div class="fats-group" style="border: none; padding-left: 10px; margin-top: 10px;">
                                 <div class="fats-sub-bars-container">
                                    <div>
                                        <p>Omega 3: <span id="totale-omega3">0</span> / <span id="obiettivo-omega3"></span> g</p>
                                        <progress id="progress-omega3" value="0"></progress>
                                    </div>
                                    <div>
                                        <p>Omega 6: <span id="totale-omega6">0</span> / <span id="obiettivo-omega6"></span> g</p>
                                        <progress id="progress-omega6" value="0"></progress>
                                    </div>
                                 </div>
                                 <p style="text-align: center; font-weight: bold; margin-top: 10px; font-size: 1.1em;">
                                    Rapporto O6:O3: <span id="omega-ratio-value"></span>
                                 </p>
                            </div>
                        </div>
                    </div>
                </div>
                <hr>
                
                <h3 class="collapsible-header" id="micro-header">
                    Micronutrienti <span class="arrow">▶</span>
                </h3>
                <div class="collapsible-content" id="micro-content">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                        <div>
                            <p>Magnesio: <span id="totale-mg">0</span> / 420 mg</p><progress id="progress-mg" value="0"></progress>
                            <p>Potassio: <span id="totale-k">0</span> / 3400 mg</p><progress id="progress-k" value="0"></progress>
                        </div>
                        <div>
                            <p>Ferro: <span id="totale-fe">0</span> / 18 mg</p><progress id="progress-fe" value="0"></progress>
                            <p>Zinco: <span id="totale-zn">0</span> / 11 mg</p><progress id="progress-zn" value="0"></progress>
                        </div>
                        <div>
                            <p>Calcio: <span id="totale-ca">0</span> / 1000 mg</p><progress id="progress-ca" value="0"></progress>
                            <p>Rame: <span id="totale-cu">0</span> / 0.9 mg</p><progress id="progress-cu" value="0" max="0.9"></progress>
                        </div>
                    </div>
                     <div style="margin-top: 15px;">
                        <p>Fosforo: <span id="totale-p">0</span> / 700 mg</p><progress id="progress-p" value="0" max="700"></progress>
                    </div>
                </div>
                <hr>

                <h3 class="collapsible-header" id="vit-header">
                    Vitamine <span class="arrow">▶</span>
                </h3>
                <div class="collapsible-content" id="vit-content">
                    <div class="vitamin-group">
                        <h4 style="display: flex; align-items: center; gap: 8px;">
                            Accumulabili (Liposolubili / Fegato) 
                            <i id="info-vit-settimanali" class="fas fa-info-circle" style="cursor: pointer; color: #1976d2;"></i>
                        </h4>
                        <p>Vitamina A: <span id="totale-vit-a">0</span> / 900 µg</p><progress id="progress-vit-a" value="0" max="900"></progress>
                        <p>Vitamina D: <span id="totale-vit-d">0</span> / 15 µg</p><progress id="progress-vit-d" value="0" max="15"></progress>
                        <p>Vitamina E: <span id="totale-vit-e">0</span> / 15 mg</p><progress id="progress-vit-e" value="0" max="15"></progress>
                        <p>Vitamina K: <span id="totale-vit-k">0</span> / 120 µg</p><progress id="progress-vit-k" value="0" max="120"></progress>
                        <p>Vitamina B12: <span id="totale-vit-b12">0</span> / 2.4 µg</p><progress id="progress-vit-b12" value="0" max="2.4"></progress>
                    </div>
                     <div class="vitamin-group">
                        <h4>Giornaliere (Idrosolubili)</h4>
                        <p>Vitamina C: <span id="totale-vitc">0</span> / 90 mg</p><progress id="progress-vitc" value="0" max="90"></progress>
                        <p>Vitamina B2: <span id="totale-b2">0</span> / 1.3 mg</p><progress id="progress-b2" value="0" max="1.3"></progress>
                        <p>Vitamina B6: <span id="totale-b6">0</span> / 1.3 mg</p><progress id="progress-b6" value="0" max="1.3"></progress>
                        <p>Folati (B9): <span id="totale-b9">0</span> / 400 µg</p><progress id="progress-b9" value="0" max="400"></progress>
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <label for="daily-notes">Note del Giorno</label>
                    <textarea id="daily-notes" rows="3" placeholder="Aggiungi note per la giornata..."></textarea>
                </div>
                </div>

            <div id="form-allenamento" class="sezione">
                <h2 class="collapsible-header" id="workout-header">Registra Allenamento <span class="arrow">▶</span></h2>
                <div class="collapsible-content" id="workout-content">
                    <label for="workout-desc">Descrizione Allenamento</label>
                    <input type="text" id="workout-desc" placeholder="es. Corsa 30 min, Pesistica">
                    <label for="workout-calories">Calorie Bruciate (kcal)</label>
                    <input type="number" id="workout-calories" min="0">
                    <button id="btn-add-workout">Aggiungi Allenamento</button>
                </div>
            </div>
            <div id="food-adder" class="sezione">
                <div class="food-adder-header">
                    <h2>Aggiungi Alimento</h2>
                    <div id="photo-ocr-controls" style="display: flex; align-items: center; gap: 5px;">
                         <span id="photo-ocr-status" style="display:none; color: #555; font-style: italic; font-size: 0.9em;"></span>
                         <button id="btn-photo-nutrients" title="Acquisisci Nutrienti da Foto"><i class="fas fa-camera"></i></button>
                         <button id="btn-scan-barcode" title="Scansiona Codice a Barre"><i class="fas fa-barcode"></i></button>
                         <button id="btn-clear-nutrients" title="Cancella campi nutrienti">🗑️</button>
                    </div>
                </div>
                <div class="builder-grid">
                    <div>
                        <div class="food-label-container">
                            <label for="builder-desc">Alimento</label>
                            <button id="btn-edit-ingredients" title="Modifica Lista Ingredienti">📜</button>
                        </div>
                        <input type="text" id="builder-desc" list="food-database-list">
                    </div>
                    <div><label>Quantità (g)</label><input type="text" id="builder-qta"></div>
                    <div><label>Proteine/100g</label><input type="number" id="builder-prot" step="0.1"></div>
                    <div><label>Kcal/100g</label><input type="number" id="builder-kcal" min="0"></div>
                    <div><label>Carboidrati/100g</label><input type="number" id="builder-carb" step="0.1"></div>
                    <div><label>Zuccheri/100g</label><input type="number" id="builder-zuccheri" step="0.1"></div>
                    <div><label>Grassi Totali/100g</label><input type="number" id="builder-fat-total" step="0.1"></div>
                    <div><label>Gr. Saturi/100g</label><input type="number" id="builder-fat-sat" min="0" step="0.1"></div>
                    <div><label>Fibre Totali/100g</label><input type="number" id="builder-fibre-totali" step="0.1"></div>
                </div>
                <h2 class="collapsible-header" id="nutrients-header">
                    Dettagli Nutrizionali <span class="arrow">▶</span>
                </h2>
                <div class="collapsible-content" id="nutrients-content">
                    <div class="builder-grid">
                        <div><label>Fibre Solubili/100g</label><input type="number" id="builder-fibre-solubili" step="0.1"></div>
                        <div><label>Fibre Insolubili/100g</label><input type="number" id="builder-fibre-insolubili" step="0.1"></div>
                        <div><label>Gr. Trans/100g</label><input type="number" id="builder-fat-trans" min="0" step="0.1"></div>
                        <div><label>Gr. Monoinsaturi/100g</label><input type="number" id="builder-fat-mono" min="0" step="0.1"></div>
                        <div><label>Gr. Polinsaturi/100g</label><input type="number" id="builder-fat-poly" min="0" step="0.1"></div>
                        <div><label>Omega 3/100g</label><input type="number" id="builder-omega3" min="0" step="0.1"></div>
                        <div><label>Omega 6/100g</label><input type="number" id="builder-omega6" min="0" step="0.1"></div>
                        <div><label>Vit. A (μg)/100g</label><input type="number" id="builder-vit-a" min="0"></div>
                        <div><label>Vit. B2 (mg)/100g</label><input type="number" id="builder-b2" min="0" step="0.01"></div>
                        <div><label>Vit. B6 (mg)/100g</label><input type="number" id="builder-b6" min="0" step="0.01"></div>
                        <div><label>Vit. B12 (μg)/100g</label><input type="number" id="builder-vit-b12" min="0" step="0.01"></div>
                        <div><label>Vit. D (μg)/100g</label><input type="number" id="builder-vit-d" min="0" step="0.01"></div>
                        <div><label>Vit. E (mg)/100g</label><input type="number" id="builder-vit-e" min="0" step="0.1"></div>
                        <div><label>Vit. K (μg)/100g</label><input type="number" id="builder-vit-k" min="0"></div>
                        <div><label>Folati B9 (μg)/100g</label><input type="number" id="builder-b9" min="0"></div>
                        <div><label>Magnesio (mg)/100g</label><input type="number" id="builder-mg" min="0"></div>
                        <div><label>Potassio (mg)/100g</label><input type="number" id="builder-k" min="0"></div>
                        <div><label>Vitamina C (mg)/100g</label><input type="number" id="builder-vitc" min="0"></div>
                        <div><label>Calcio (mg)/100g</label><input type="number" id="builder-ca" min="0"></div>
                        <div><label>Ferro (mg)/100g</label><input type="number" id="builder-fe" min="0" step="0.1"></div>
                        <div><label>Zinco (mg)/100g</label><input type="number" id="builder-zn" min="0" step="0.1"></div>
                        <div><label>Rame (mg)/100g</label><input type="number" id="builder-cu" min="0" step="0.01"></div>
                        <div><label>Fosforo (mg)/100g</label><input type="number" id="builder-p" min="0"></div>
                        <div><label>Leucina (mg)/100g</label><input type="number" id="builder-leu" min="0"></div>
                        <div><label>Isoleucina (mg)/100g</label><input type="number" id="builder-iso" min="0"></div>
                        <div><label>Valina (mg)/100g</label><input type="number" id="builder-val" min="0"></div>
                        <div><label>Lisina (mg)/100g</label><input type="number" id="builder-lys" min="0"></div>
                        <div><label>Metionina (mg)/100g</label><input type="number" id="builder-met" min="0"></div>
                        <div><label>Fenilalanina (mg)/100g</label><input type="number" id="builder-phe" min="0"></div>
                        <div><label>Treonina (mg)/100g</label><input type="number" id="builder-thr" min="0"></div>
                        <div><label>Triptofano (mg)/100g</label><input type="number" id="builder-trp" min="0"></div>
                        <div><label>Istidina (mg)/100g</label><input type="number" id="builder-his" min="0"></div>
                    </div>
                    <div id="manual-fill-section">
                        <div class="button-group">
                            <button id="btn-copy-prompt">Copia Richiesta AI</button>
                            <button id="btn-confirm-json" style="background-color: #2e7d32;">Conferma Dati da JSON</button>
                        </div>
                        <textarea id="manual-json-input" placeholder="Incolla qui l'oggetto JSON con i valori nutrizionali, come da richiesta."></textarea>
                    </div>
                </div>
                <datalist id="food-database-list"></datalist>
                <div class="button-group">
                    <button id="btn-costruisci-pasto">Aggiungi a Pasto</button>
                    <button id="btn-aggiungi-singolo">Aggiungi al Diario</button>
                    <button id="btn-compila-ai" style="background-color: #0d47a1;">Compila AI</button>
                </div>
            </div>
            <div id="meal-builder-sezione" class="sezione" data-visible="false">
                <h2>Costruttore Pasto</h2>
                <div id="meal-builder-summary">
                    <p>Pasto Selezionato: <span id="current-meal-type-display"></span></p>
                    <div class="progress-container">
                        <div class="progress-item">
                            <p style="display: flex; align-items: center; gap: 10px;">
                                <span>Proteine: <span id="meal-prot-current">0</span> / <span id="meal-prot-target"></span> g (<span id="meal-prot-remaining"></span>)</span>
                                <i id="info-proteine-pasto" class="fas fa-info-circle" style="cursor: pointer; color: #1976d2; font-size: 1.2em;"></i>
                            </p>
                            <progress id="meal-progress-prot" value="0"></progress>
                        </div>
                        <div class="progress-item">
                            <p>Calorie: <span id="meal-cal-current">0</span> / <span id="meal-cal-target"></span> kcal (<span id="meal-cal-remaining"></span>)</p>
                            <progress id="meal-progress-cal" value="0"></progress>
                        </div>
                    </div>
                </div>
                <select id="meal-type-selector">
                    <option value="merenda1">Merenda AM</option>
                    <option value="pranzo">Pranzo</option>
                    <option value="merenda2">Merenda PM</option>
                    <option value="cena">Cena</option>
                </select>
                <table id="log-pasto-builder">
                    <thead><tr><th>Sel.</th><th>Descrizione</th><th>(g)</th><th>Prot</th><th>Kcal</th><th>Azione</th></tr></thead>
                    <tbody id="log-pasto-builder-body"></tbody>
                </table>
                <button id="btn-salva-pasto">Salva Pasto nel Diario</button>
            </div>
            <div class="sezione">
                <h2>Diario Giornaliero</h2>
                <div class="diary-table-container">
                <table id="log-pasti">
                    <thead>
                        <tr>
                            <th>Descrizione</th>
                            <th>(g)</th>
                            <th>Prot</th>
                            <th>Qualità</th>
                            <th>Kcal</th>
                            <th>Fibre Tot</th>
                            <th>Fibre Sol</th>
                            <th>Fibre Ins</th>
                            <th>Leu</th>
                            <th>Iso</th>
                            <th>Val</th>
                            <th>Lys</th>
                            <th>Met</th>
                            <th>Phe</th>
                            <th>Thr</th>
                            <th>Trp</th>
                            <th>His</th>
                            <th>Gr. Sat</th>
                            <th>Gr. Trans</th>
                            <th>Gr. Mono</th>
                            <th>Gr. Poly</th>
                            <th>Omega 3</th>
                            <th>Omega 6</th>
                            <th>Mg</th>
                            <th>K</th>
                            <th>Vit.C</th>
                            <th>Ca</th>
                            <th>Fe</th>
                            <th>Zn</th>
                            <th>Cu</th>
                            <th>Vit. A</th>
                            <th>Vit. B12</th>
                            <th>Vit. D</th>
                            <th>Vit. E</th>
                            <th>Vit. K</th>
                            <th>B9</th>
                            <th>B2</th>
                            <th>B6</th>
                            <th>Azione</th>
                        </tr>
                    </thead>
                    <tbody id="log-body"></tbody>
                </table>
                </div>
                <div id="caricamento-manuale" class="sezione" style="padding:15px; margin-top:20px; border-width:1px;">
                    <h3 style="margin:0 0 10px 0; font-size:1em;">Visualizza un Altro Giorno</h3>
                    <div>
                        <input type="date" id="data-caricamento">
                        <button id="btn-vai-a-oggi">Oggi</button>
                    </div>
                </div>
            </div>

            <div class="sezione">
                <h2>Sincronizzazione Cloud Manuale</h2>
                <div class="cloud-sync-section">
                    <button id="btn-download-manual">⬇️ Scarica Dati dal Cloud</button>
                    <span id="cloud-sync-status" class="cloud-sync-status disconnected">Connessione Cloud: Disconnesso</span>
                </div>
                <p style="font-size: 0.85em; color: #777; margin-top: 10px;">
                    Una volta autenticato, puoi sincronizzare i dati. Lo scaricamento manuale sovrascrive i dati locali.
                </p>
            </div>
        </div>
    </div>
    
    <div id="weekly-vitamin-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" data-modal="weekly-vitamin-modal">&times;</span>
            <h2>Riepilogo Settimanale Vitamine Accumulabili</h2>
            <p style="font-size: 0.9em; color: #555;">Dati calcolati sugli ultimi 7 giorni, incluso oggi.</p>
            
            <div class="vitamin-weekly-summary">
                <h4>Vitamina A</h4>
                <p>Totale: <span id="weekly-vit-a-total">0</span> / <span id="weekly-vit-a-goal">6300</span> µg</p>
                <progress id="weekly-progress-vit-a" value="0" max="6300"></progress>
                <p><i>Media giornaliera: <span id="weekly-vit-a-avg">0.0</span> µg (Obiettivo: 900 µg | <span id="weekly-vit-a-diff" class="diff-value"></span>)</i></p>
            </div>
            <div class="vitamin-weekly-summary">
                <h4>Vitamina D</h4>
                <p>Totale: <span id="weekly-vit-d-total">0</span> / <span id="weekly-vit-d-goal">105</span> µg</p>
                <progress id="weekly-progress-vit-d" value="0" max="105"></progress>
                <p><i>Media giornaliera: <span id="weekly-vit-d-avg">0.0</span> µg (Obiettivo: 15 µg | <span id="weekly-vit-d-diff" class="diff-value"></span>)</i></p>
            </div>
            <div class="vitamin-weekly-summary">
                <h4>Vitamina E</h4>
                <p>Totale: <span id="weekly-vit-e-total">0</span> / <span id="weekly-vit-e-goal">105</span> mg</p>
                <progress id="weekly-progress-vit-e" value="0" max="105"></progress>
                <p><i>Media giornaliera: <span id="weekly-vit-e-avg">0.0</span> mg (Obiettivo: 15 mg | <span id="weekly-vit-e-diff" class="diff-value"></span>)</i></p>
            </div>
            <div class="vitamin-weekly-summary">
                <h4>Vitamina K</h4>
                <p>Totale: <span id="weekly-vit-k-total">0</span> / <span id="weekly-vit-k-goal">840</span> µg</p>
                <progress id="weekly-progress-vit-k" value="0" max="840"></progress>
                <p><i>Media giornaliera: <span id="weekly-vit-k-avg">0.0</span> µg (Obiettivo: 120 µg | <span id="weekly-vit-k-diff" class="diff-value"></span>)</i></p>
            </div>
            <div class="vitamin-weekly-summary">
                <h4>Vitamina B12</h4>
                <p>Totale: <span id="weekly-vit-b12-total">0</span> / <span id="weekly-vit-b12-goal">16.8</span> µg</p>
                <progress id="weekly-progress-vit-b12" value="0" max="16.8"></progress>
                <p><i>Media giornaliera: <span id="weekly-vit-b12-avg">0.0</span> µg (Obiettivo: 2.4 µg | <span id="weekly-vit-b12-diff" class="diff-value"></span>)</i></p>
            </div>
        </div>
    </div>

    <div id="weekly-fats-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" data-modal="weekly-fats-modal">&times;</span>
            <h2>Riepilogo Settimanale Grassi</h2>
            <p style="font-size: 0.9em; color: #555;">Dati calcolati sugli ultimi 7 giorni, incluso oggi.</p>
            
            <div class="vitamin-weekly-summary">
                <h4>Grassi Totali</h4>
                <p>Totale: <span id="weekly-fat-total-total">0</span> / <span id="weekly-fat-total-goal"></span> g</p>
                <progress id="weekly-progress-fat-total" value="0"></progress>
                <p><i>Media giornaliera: <span id="weekly-fat-total-avg">0.0</span> g (Obiettivo: <span id="daily-fat-total-goal"></span> g | <span id="weekly-fat-total-diff" class="diff-value"></span>)</i></p>
            </div>
            <div class="vitamin-weekly-summary">
                <h4>Grassi Saturi</h4>
                <p>Totale: <span id="weekly-fat-sat-total">0</span> / <span id="weekly-fat-sat-goal"></span> g</p>
                <progress id="weekly-progress-fat-sat" value="0"></progress>
                <p><i>Media giornaliera: <span id="weekly-fat-sat-avg">0.0</span> g (Obiettivo: <span id="daily-fat-sat-goal"></span> g | <span id="weekly-fat-sat-diff" class="diff-value"></span>)</i></p>
            </div>
            <div class="vitamin-weekly-summary">
                <h4>Grassi Trans</h4>
                <p>Totale: <span id="weekly-fat-trans-total">0</span> / <span id="weekly-fat-trans-goal"></span> g</p>
                <progress id="weekly-progress-fat-trans" value="0"></progress>
                <p><i>Media giornaliera: <span id="weekly-fat-trans-avg">0.0</span> g (Obiettivo: <span id="daily-fat-trans-goal"></span> g | <span id="weekly-fat-trans-diff" class="diff-value"></span>)</i></p>
            </div>
            <div class="vitamin-weekly-summary">
                <h4>Grassi Monoinsaturi</h4>
                <p>Totale: <span id="weekly-fat-mono-total">0</span> / <span id="weekly-fat-mono-goal"></span> g</p>
                <progress id="weekly-progress-fat-mono" value="0"></progress>
                <p><i>Media giornaliera: <span id="weekly-fat-mono-avg">0.0</span> g (Obiettivo: <span id="daily-fat-mono-goal"></span> g | <span id="weekly-fat-mono-diff" class="diff-value"></span>)</i></p>
            </div>
            <div class="vitamin-weekly-summary">
                <h4>Grassi Polinsaturi</h4>
                <p>Totale: <span id="weekly-fat-poly-total">0</span> / <span id="weekly-fat-poly-goal"></span> g</p>
                <progress id="weekly-progress-fat-poly" value="0"></progress>
                <p><i>Media giornaliera: <span id="weekly-fat-poly-avg">0.0</span> g (Obiettivo: <span id="daily-fat-poly-goal"></span> g | <span id="weekly-fat-poly-diff" class="diff-value"></span>)</i></p>
            </div>
             <div class="vitamin-weekly-summary">
                <h4>Omega 3</h4>
                <p>Totale: <span id="weekly-fat-omega3-total">0</span> / <span id="weekly-fat-omega3-goal"></span> g</p>
                <progress id="weekly-progress-fat-omega3" value="0"></progress>
                <p><i>Media giornaliera: <span id="weekly-fat-omega3-avg">0.0</span> g (Obiettivo: <span id="daily-fat-omega3-goal"></span> g | <span id="weekly-fat-omega3-diff" class="diff-value"></span>)</i></p>
            </div>
             <div class="vitamin-weekly-summary">
                <h4>Omega 6</h4>
                <p>Totale: <span id="weekly-fat-omega6-total">0</span> / <span id="weekly-fat-omega6-goal"></span> g</p>
                <progress id="weekly-progress-fat-omega6" value="0"></progress>
                <p><i>Media giornaliera: <span id="weekly-fat-omega6-avg">0.0</span> g (Obiettivo: <span id="daily-fat-omega6-goal"></span> g | <span id="weekly-fat-omega6-diff" class="diff-value"></span>)</i></p>
            </div>
            <p style="text-align: center; font-weight: bold; margin-top: 15px; font-size: 1.2em; border-top: 1px solid #eee; padding-top: 15px;">
                Rapporto O6:O3 Settimanale: <span id="weekly-omega-ratio-value">N/D</span>
            </p>
        </div>
    </div>

    <div id="nutrient-detail-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" data-modal="nutrient-detail-modal">&times;</span>
            <h2 id="nutrient-detail-modal-title"></h2>
            <ul id="nutrient-detail-modal-list"></ul>
        </div>
    </div>

    <div id="amino-acid-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" data-modal="amino-acid-modal">&times;</span>
            <h2 id="modal-amino-title">Dettaglio Amminoacidi</h2>
            
            <div id="modal-amino-summary" style="text-align: center; margin-bottom: 20px;"></div>

            <div id="modal-amino-content" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <p>Leucina: <span id="modal-amino-leu-total">0</span> / <span id="modal-amino-leu-goal"></span> mg</p>
                    <progress id="modal-amino-leu-progress" value="0" style="width:100%"></progress>
                    <p>Isoleucina: <span id="modal-amino-iso-total">0</span> / <span id="modal-amino-iso-goal"></span> mg</p>
                    <progress id="modal-amino-iso-progress" value="0" style="width:100%"></progress>
                    <p>Valina: <span id="modal-amino-val-total">0</span> / <span id="modal-amino-val-goal"></span> mg</p>
                    <progress id="modal-amino-val-progress" value="0" style="width:100%"></progress>
                    <p>Lisina: <span id="modal-amino-lys-total">0</span> / <span id="modal-amino-lys-goal"></span> mg</p>
                    <progress id="modal-amino-lys-progress" value="0" style="width:100%"></progress>
                </div>
                <div>
                    <p>Metionina: <span id="modal-amino-met-total">0</span> / <span id="modal-amino-met-goal"></span> mg</p>
                    <progress id="modal-amino-met-progress" value="0" style="width:100%"></progress>
                    <p>Fenilalanina: <span id="modal-amino-phe-total">0</span> / <span id="modal-amino-phe-goal"></span> mg</p>
                    <progress id="modal-amino-phe-progress" value="0" style="width:100%"></progress>
                    <p>Treonina: <span id="modal-amino-thr-total">0</span> / <span id="modal-amino-thr-goal"></span> mg</p>
                    <progress id="modal-amino-thr-progress" value="0" style="width:100%"></progress>
                    <p>Triptofano: <span id="modal-amino-trp-total">0</span> / <span id="modal-amino-trp-goal"></span> mg</p>
                    <progress id="modal-amino-trp-progress" value="0" style="width:100%"></progress>
                </div>
            </div>
            <div style="margin-top: 15px;">
                 <p>Istidina: <span id="modal-amino-his-total">0</span> / <span id="modal-amino-his-goal"></span> mg</p>
                 <progress id="modal-amino-his-progress" value="0" style="width:100%"></progress>
            </div>
        </div>
    </div>
    
    <div id="ingredient-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" data-modal="ingredient-modal">&times;</span>
            <div id="ingredient-modal-header">
                <h2 id="ingredient-modal-title"></h2>
                <div id="ingredient-modal-actions">
                    <button id="btn-clear-ingredients" title="Cancella tutto"><i class="fas fa-eraser"></i></button>
                    <button id="btn-photo-ingredients" title="Acquisisci da foto"><i class="fas fa-camera"></i></button>
                    <button id="btn-generate-ingredients-ai" title="Genera o Pulisci con AI">🪄</button>
                    <button id="btn-copy-ingredients-prompt" title="Copia prompt per AI">📋</button>
                </div>
            </div>
            <input type="file" id="ingredient-photo-input" accept="image/*" style="display: none;">
            <p id="ocr-status-ingredients" style="text-align: center; color: #888; display: none;"></p>
            <textarea id="ingredient-modal-textarea" placeholder="Inserisci o fotografa la lista ingredienti qui..."></textarea>
            <button id="btn-save-ingredients" style="width: 100%; margin-top: 15px; background-color: #2e7d32;">Salva Ingredienti</button>
        </div>
    </div>

    <div id="nutrient-confirm-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" data-modal="nutrient-confirm-modal">&times;</span>
            <h2>Conferma Dati Nutrizionali</h2>
            <p>Controlla e correggi i valori estratti dalla foto prima di confermare.</p>
            <div id="nutrient-confirm-list">
                 <p id="ocr-status-nutrients" style="text-align: center; color: #888; display: block;">In attesa di una foto...</p>
            </div>
            <div class="nutrient-confirm-buttons">
                <button id="btn-cancel-nutrients" style="background-color: #607d8b;">Annulla</button>
                <button id="btn-confirm-nutrients" style="background-color: #2e7d32;">Conferma e Compila</button>
            </div>
        </div>
    </div>
    <input type="file" id="nutrient-photo-input" accept="image/*" style="display: none;">

    <div id="barcode-scanner-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" data-modal="barcode-scanner-modal">&times;</span>
            <h2>Scansiona Codice a Barre</h2>
            <p style="text-align: center;">Inquadra il codice a barre del prodotto.</p>
            <div id="scanner-container" style="position: relative; width: 100%; padding-top: 75%;">
                <video id="barcode-scanner-video" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 1px solid #ccc; border-radius: 8px;"></video>
                <div id="scanner-overlay" style="position: absolute; top: 50%; left: 50%; width: 80%; height: 2px; background-color: red; transform: translate(-50%, -50%); box-shadow: 0 0 10px red;"></div>
            </div>
            <p id="barcode-scanner-status" style="text-align: center; margin-top: 15px; font-weight: bold; min-height: 20px;"></p>
        </div>
    </div>
    
    <div id="profile-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" data-modal="profile-modal">&times;</span>
            <h2>Profilo e Obiettivi</h2>
            <p>Inserisci i tuoi dati per calcolare un piano personalizzato. Puoi sempre modificare i valori manualmente.</p>
            
            <div id="profile-form">
                <h4>Dati Personali</h4>
                <div class="builder-grid">
                    <div><label for="profile-age">Età</label><input type="number" id="profile-age"></div>
                    <div><label for="profile-gender">Sesso</label>
                        <select id="profile-gender">
                            <option value="male">Uomo</option>
                            <option value="female">Donna</option>
                        </select>
                    </div>
                    <div><label for="profile-weight">Peso (kg)</label><input type="number" id="profile-weight" step="0.1"></div>
                    <div><label for="profile-height">Altezza (cm)</label><input type="number" id="profile-height"></div>
                </div>

                <h4>Stile di Vita e Obiettivi</h4>
                 <div class="builder-grid">
                    <div><label for="profile-activity">Livello Attività Fisica</label>
                        <select id="profile-activity">
                            <option value="1.2">Sedentario (ufficio)</option>
                            <option value="1.375">Leggero (1-3 gg/settimana)</option>
                            <option value="1.55">Moderato (3-5 gg/settimana)</option>
                            <option value="1.725">Attivo (6-7 gg/settimana)</option>
                            <option value="1.9">Molto Attivo (lavoro fisico)</option>
                        </select>
                    </div>
                    <div><label for="profile-goal">Obiettivo Principale</label>
                        <select id="profile-goal">
                            <option value="-400">Perdere Peso (-400 kcal)</option>
                            <option value="0">Mantenimento</option>
                            <option value="+300">Aumentare Massa (+300 kcal)</option>
                        </select>
                    </div>
                </div>
                
                <hr style="margin: 25px 0;">
                
                <h4>Obiettivi Nutrizionali (lascia vuoto per calcolo automatico)</h4>
                 <p style="font-size: 0.9em; color: #666;">Puoi forzare un valore specifico qui. Verrà usato al posto di quello calcolato.</p>
                <div class="builder-grid">
                    <div><label for="profile-kcal">Calorie (kcal)</label><input type="number" id="profile-kcal"></div>
                    <div><label for="profile-prot">Proteine (g)</label><input type="number" id="profile-prot"></div>
                    <div><label for="profile-carb">Carboidrati (g)</label><input type="number" id="profile-carb"></div>
                    <div><label for="profile-fat">Grassi (g)</label><input type="number" id="profile-fat"></div>
                </div>
            </div>

            <div class="button-group" style="margin-top: 20px;">
                <button id="btn-calculate-profile-ai" style="background-color: #0d47a1;">💡 Calcola Obiettivi</button>
                <button id="btn-save-profile" style="background-color: #2e7d32;">Salva Profilo</button>
            </div>
        </div>
    </div>


    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js" type="module"></script> 
<script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";

    // --- CONFIGURAZIONE E VARIABILI GLOBALI ---
    const firebaseConfig = {
      apiKey: "AIzaSyA5pSzpfq1aGZ1wjNV5-eXnIqWL6brl424",
      authDomain: "mio-tracker.firebaseapp.com",
      databaseURL: "https://mio-tracker-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "mio-tracker",
      storageBucket: "mio-tracker.firebasestorage.app",
      messagingSenderId: "382993217593",
      appId: "1:382993217593:web:f0780aa061c23f9503f5e8"
    };

    let giornoVisualizzato = getTodayString('ymd');
    let datiGiornalieri = {};
    let foodDatabase = {};
    let pastoInCostruzione = [];
    let userProfile = {};
    
    let db, auth, firebaseApp; 
    let currentUserUID = null; 
    let videoStream = null;
    let isScanning = false; 

    const OBIETTIVI_MICRO = { mg: 420, k: 3400, vitc: 90, ca: 1000, fe: 18, zn: 11, cu: 0.9, p: 700 };
    const OBIETTIVI_FIBRE = { fibreTotali: 30, fibreSolubili: 10, fibreInsolubili: 20 };
    const OBIETTIVI_VIT = { vitA: 900, vitB12: 2.4, vitD: 15, vitE: 15, vitK: 120, b9: 400, b2: 1.3, b6: 1.3 };
    const OBIETTIVI_AMINO = { leu: 2900, iso: 1500, val: 1900, lys: 2200, met: 1100, phe: 1800, thr: 1100, trp: 300,  his: 750 };
    const PROFILO_AMINOACIDICO_RIFERIMENTO = { leu: 59, iso: 30, val: 39, lys: 45, met: 22, phe: 38, thr: 23, trp: 6.0, his: 15 };
    const OBIETTIVI_MACRO_PASTO_BASE = { merenda1: { prot_perc: 0.15, cal_perc: 0.15 }, pranzo: { prot_perc: 0.35, cal_perc: 0.35 }, merenda2: { prot_perc: 0.15, cal_perc: 0.15 }, cena: { prot_perc: 0.35, cal_perc: 0.35 } };
    const MEAL_TYPE_SEQUENCE = ['merenda1', 'pranzo', 'merenda2', 'cena'];
    const LOCAL_STORAGE_SYNC_KEYS = ['trackerFoodDatabase', 'trackerPesate', 'trackerMealType', 'trackerPastoInCostruzione', 'userProfile'];
    const LOCAL_LAST_UPDATE_KEY = 'lastLocalUpdateTimestamp';
    const CLOUD_LAST_UPDATE_PATH = 'lastCloudUpdateTimestamp';
    const API_KEY_AI = "AIzaSyCZUoiawXYzrqDLh1m0O0Wnt5ZhR3wP9Ac";
    const GEMINI_ENDPOINT = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY_AI}`;
    const GEMINI_PROMPT_FORMAT = `{"prot":g,"kcal":kcal,"carb":g,"zuccheri":g,"fatSat":g,"fatTrans":g,"fatMono":g,"fatPoly":g,"omega3":g,"omega6":g,"fibreTotali":g,"fibreSolubili":g,"fibreInsolubili":g,"mg":mg,"k":mg,"vitc":mg,"ca":mg,"vitA":µg,"vitB12":µg,"vitD":µg,"vitE":mg,"vitK":µg,"b9":µg,"b2":mg,"b6":mg,"fe":mg,"zn":mg,"cu":mg,"p":mg,"leu":mg,"iso":mg,"val":mg,"lys":mg,"met":mg,"phe":mg,"thr":mg,"trp":mg,"his":mg}`;
    const AI_INSTRUCTION = "Se un valore non è disponibile fai una stima e usa il valore medio";
    
    const authSection = document.getElementById('auth-section');
    const mainTrackerContent = document.getElementById('main-tracker-content');
    const userEmailInput = document.getElementById('user-email');
    const userPasswordInput = document.getElementById('user-password');
    const btnRegister = document.getElementById('btn-register');
    const btnLogin = document.getElementById('btn-login');
    const btnSignOut = document.getElementById('btn-sign-out');
    const authStatusP = document.getElementById('auth-status');
    const welcomeMessage = document.getElementById('welcome-message');
    const authFormFields = document.getElementById('auth-form-fields');
    
    // --- DEFINIZIONE DI TUTTE LE FUNZIONI ---

    function getTodayString(format = 'ymd') { return new Date().toISOString().split('T')[0]; }
    
    function sanitizeFirebaseKey(str) {
        if (!str) return '';
        return str.replace(/[.#$/\[\]]/g, '_');
    }

    function calculateNutritionalGoals(profile) {
        const { age, gender, weight, height, activity } = profile;
        if (!age || !weight || !height) return {}; 
        let bmr;
        if (gender === 'male') {
            bmr = (10 * weight) + (6.25 * height) - (5 * age) + 5;
        } else {
            bmr = (10 * weight) + (6.25 * height) - (5 * age) - 161;
        }
        const tdee = bmr * (activity || 1.2);
        const goalAdjustment = profile.goal_adjustment ?? profile.goal;
        const targetKcal = tdee + (goalAdjustment || 0);
        const targetProt = weight * 1.8;
        const targetFat = (targetKcal * 0.25) / 9;
        const targetCarb = (targetKcal - (targetProt * 4) - (targetFat * 9)) / 4;
        const finalGoals = {
            kcal: profile.manual_kcal || Math.round(targetKcal),
            prot: profile.manual_prot || Math.round(targetProt),
            carb: profile.manual_carb || Math.round(targetCarb),
            zuccheri: Math.round(targetKcal * 0.1 / 4),
            fatTotal: profile.manual_fat || Math.round(targetFat),
            fatSat: Math.round(targetFat * 0.33),
            fatTrans: 2,
            fatMono: Math.round(targetFat * 0.40),
            fatPoly: Math.round(targetFat * 0.27),
            omega3: 2.5,
            omega6: 10,
            ...OBIETTIVI_MICRO,
            ...OBIETTIVI_FIBRE,
            ...OBIETTIVI_VIT,
            ...OBIETTIVI_AMINO
        };
        finalGoals.fatUnsat = finalGoals.fatMono + finalGoals.fatPoly;
        return finalGoals;
    }
    
    async function saveSingleItemToCloud(path, data) {
        const dataRef = (db && currentUserUID) ? ref(db, `users/${currentUserUID}/${path === 'userProfile' ? '' : 'tracker_data/'}${path}`) : null;
        if (!dataRef) return;
        try {
            await set(dataRef, data);
            await set(ref(db, `users/${currentUserUID}/${CLOUD_LAST_UPDATE_PATH}`), Date.now());
        } catch (err) {
            console.error(`Errore salvataggio su cloud per ${path}:`, err);
        }
    }
    
    function salvaFoodDatabase() { 
        localStorage.setItem('trackerFoodDatabase', JSON.stringify(foodDatabase)); 
        localStorage.setItem(LOCAL_LAST_UPDATE_KEY, Date.now()); 
        const sanitizedDb = {};
        for (const key in foodDatabase) {
            sanitizedDb[sanitizeFirebaseKey(key)] = foodDatabase[key];
        }
        saveSingleItemToCloud('trackerFoodDatabase', sanitizedDb);
    }
    
    function salvaPastoInCostruzione() { 
        localStorage.setItem('trackerPastoInCostruzione', JSON.stringify(pastoInCostruzione)); 
        localStorage.setItem(LOCAL_LAST_UPDATE_KEY, Date.now()); 
        saveSingleItemToCloud('trackerPastoInCostruzione', pastoInCostruzione);
    }
    
    function salvaGiorno(dataDaSalvare, datiDaSalvare) {
        const dailyNotesTextarea = document.getElementById('daily-notes');
        if (!datiDaSalvare) datiDaSalvare = datiGiornalieri;
        datiDaSalvare.note = dailyNotesTextarea.value;
        datiDaSalvare.data = dataDaSalvare;
        const key = `trackerStorico_${dataDaSalvare}`;
        localStorage.setItem(key, JSON.stringify(datiDaSalvare));
        localStorage.setItem(LOCAL_LAST_UPDATE_KEY, Date.now());
        saveSingleItemToCloud(key, datiDaSalvare);
    }
    
    function caricaGiorno(data) {
        const dataCaricamentoInput = document.getElementById('data-caricamento');
        const dailyNotesTextarea = document.getElementById('daily-notes');
        giornoVisualizzato = data;
        dataCaricamentoInput.value = data;
        let datiTrovati = null;
        let rawDataFromLocalStorage = localStorage.getItem(`trackerStorico_${data}`);
        try {
            datiTrovati = JSON.parse(rawDataFromLocalStorage);
             if (datiTrovati && datiTrovati.log) {
                datiTrovati.log.forEach(entry => {
                    const items = entry.type === 'meal' ? entry.items : [entry];
                    items.forEach(item => {
                        if (item && item.cal && !item.kcal) {
                            item.kcal = item.cal;
                            delete item.cal;
                        }
                    });
                });
            }
        } catch (e) {
            console.error(`Errore nel parsing di trackerStorico_${data}:`, e, "Raw data:", rawDataFromLocalStorage);
        }
        datiGiornalieri = datiTrovati || { log: [], workoutCalorie: 0, note: '', calorieAdjustment: 0 };
        dailyNotesTextarea.value = datiGiornalieri.note || '';
        if (!datiGiornalieri.log) datiGiornalieri.log = [];
        if (typeof datiGiornalieri.workoutCalorie === 'undefined') datiGiornalieri.workoutCalorie = 0;
        if (typeof datiGiornalieri.calorieAdjustment === 'undefined') datiGiornalieri.calorieAdjustment = 0;
        aggiornaUI();
    }

    function calcolaObiettiviPasto(mealType) {
        const obiettiviGiornalieri = calculateNutritionalGoals(userProfile);
        if (!obiettiviGiornalieri.kcal) return { currentProt: 0, targetProt: 0, remainingProt: 0, currentCal: 0, targetCal: 0, remainingCal: 0 };
        const obiettivoCalTotaleGiornaliero = obiettiviGiornalieri.kcal + (datiGiornalieri.workoutCalorie || 0) + (datiGiornalieri.calorieAdjustment || 0);
        const obiettivoProtTotaleGiornaliero = obiettiviGiornalieri.prot;
        const calRatio = OBIETTIVI_MACRO_PASTO_BASE[mealType]?.cal_perc ?? 0.25;
        const protRatio = OBIETTIVI_MACRO_PASTO_BASE[mealType]?.prot_perc ?? 0.25;
        let obiettivoPastoProt = Math.round(obiettivoProtTotaleGiornaliero * protRatio);
        let obiettivoPastoCal = Math.round(obiettivoCalTotaleGiornaliero * calRatio);
        const totaliPastoInCostruzione = pastoInCostruzione.reduce((acc, item) => {
            acc.prot += item.prot || 0; acc.kcal += (item.kcal || item.cal) || 0; return acc;
        }, { prot: 0, kcal: 0 });
        return {
            currentProt: totaliPastoInCostruzione.prot, targetProt: obiettivoPastoProt, remainingProt: obiettivoPastoProt - totaliPastoInCostruzione.prot,
            currentCal: totaliPastoInCostruzione.kcal, targetCal: obiettivoPastoCal, remainingCal: obiettivoPastoCal - totaliPastoInCostruzione.kcal
        };
    }

    function aggiornaDatalist(foodDatalist) {
        if (!foodDatalist) return;
        foodDatalist.innerHTML = Object.keys(foodDatabase)
            .map(sanitizedKey => {
                const originalDesc = foodDatabase[sanitizedKey]?.desc || sanitizedKey.replace(/_/g, " ");
                return `<option value="${originalDesc.charAt(0).toUpperCase() + originalDesc.slice(1)}"></option>`
            }).join('');
    }

    function renderMealBuilder() {
        const mealBuilderSezione = document.getElementById('meal-builder-sezione');
        const logPastoBuilderBody = document.getElementById('log-pasto-builder-body');
        const mealTypeSelector = document.getElementById('meal-type-selector');
        const currentMealTypeDisplay = document.getElementById('current-meal-type-display');
        const mealProtCurrent = document.getElementById('meal-prot-current'), mealProtTarget = document.getElementById('meal-prot-target'), mealProtRemaining = document.getElementById('meal-prot-remaining');
        const mealCalCurrent = document.getElementById('meal-cal-current'), mealCalTarget = document.getElementById('meal-cal-target'), mealCalRemaining = document.getElementById('meal-cal-remaining');
        const mealProgressProt = document.getElementById('meal-progress-prot'), mealProgressCal = document.getElementById('meal-progress-cal');

        mealBuilderSezione.dataset.visible = pastoInCostruzione.length > 0;
        logPastoBuilderBody.innerHTML = '';
        const selectedMealType = mealTypeSelector ? mealTypeSelector.value : MEAL_TYPE_SEQUENCE[0];
        const selectedMealTypeText = mealTypeSelector?.options[mealTypeSelector.selectedIndex]?.text ?? '';
        const obiettiviPasto = calcolaObiettiviPasto(selectedMealType);
        const totaliPastoCorrenteSelezionati = pastoInCostruzione.filter(item => item.selezionato !== false).reduce((acc, item) => {
            acc.prot += item.prot || 0; acc.kcal += (item.kcal || item.cal) || 0; return acc;
        }, { prot: 0, kcal: 0 });
        currentMealTypeDisplay.textContent = selectedMealTypeText;
        mealProtCurrent.textContent = totaliPastoCorrenteSelezionati.prot.toFixed(1);
        mealProtTarget.textContent = obiettiviPasto.targetProt.toFixed(0);
        mealProtRemaining.textContent = `${(obiettiviPasto.targetProt - totaliPastoCorrenteSelezionati.prot).toFixed(1)} g`;
        mealProgressProt.max = obiettiviPasto.targetProt > 0 ? obiettiviPasto.targetProt : 1;
        mealProgressProt.value = totaliPastoCorrenteSelezionati.prot;
        mealCalCurrent.textContent = totaliPastoCorrenteSelezionati.kcal.toFixed(0);
        mealCalTarget.textContent = obiettiviPasto.targetCal.toFixed(0);
        mealCalRemaining.textContent = `${(obiettiviPasto.targetCal - totaliPastoCorrenteSelezionati.kcal).toFixed(0)} kcal`;
        mealProgressCal.max = obiettiviPasto.targetCal > 0 ? obiettiviPasto.targetCal : 1;
        mealProgressCal.value = totaliPastoCorrenteSelezionati.kcal;
        const createBuilderDescriptionCellHTML = (item) => {
            let html = '';
            if (item.ingredienti && item.ingredienti.trim() !== '') {
                html += `<span class="ingredient-icon" title="Visualizza ingredienti" data-food-name="${item.desc}">📜</span>`;
            }
            html += item.desc;
            return html;
        };
        pastoInCostruzione.forEach((item, index) => {
            const riga = logPastoBuilderBody.insertRow();
            riga.innerHTML = `<td><input type="checkbox" class="meal-item-checkbox" data-index="${index}" ${item.selezionato !== false ? 'checked' : ''}></td>
                            <td>${createBuilderDescriptionCellHTML(item)}</td>
                            <td>${item.qta}</td>
                            <td>${(item.prot || 0).toFixed(1)}</td>
                            <td>${((item.kcal || item.cal) || 0).toFixed(0)}</td>
                            <td class="action-buttons"><button class="delete-btn" data-type="builder" data-index="${index}">&times;</button></td>`;
        });
    }

    function aggiornaUI() {
        const titoloGiornataEl = document.getElementById('titolo-giornata');
        const spanTotaleProteine = document.getElementById('totale-proteine'), spanObiettivoProteine = document.getElementById('obiettivo-proteine'), progressProteine = document.getElementById('progress-proteine');
        const spanTotaleCalorie = document.getElementById('totale-calorie'), spanObiettivoCalorie = document.getElementById('obiettivo-calorie'), progressCalorie = document.getElementById('progress-calorie');
        const spanTotaleCarboidrati = document.getElementById('totale-carboidrati'), spanObiettivoCarboidrati = document.getElementById('obiettivo-carboidrati'), progressCarboidrati = document.getElementById('progress-carboidrati');
        const spanTotaleZuccheri = document.getElementById('totale-zuccheri'), spanObiettivoZuccheri = document.getElementById('obiettivo-zuccheri'), progressZuccheri = document.getElementById('progress-zuccheri');
        const spanWorkoutCalories = document.getElementById('workout-calories-totali');
        const spanTotaleFibreTotali = document.getElementById('totale-fibre-totali'), spanObiettivoFibreTotali = document.getElementById('obiettivo-fibre-totali'), progressFibreTotali = document.getElementById('progress-fibre-totali');
        const spanTotaleFibreSolubili = document.getElementById('totale-fibre-solubili'), spanObiettivoFibreSolubili = document.getElementById('obiettivo-fibre-solubili'), progressFibreSolubili = document.getElementById('progress-fibre-solubili');
        const spanTotaleFibreInsolubili = document.getElementById('totale-fibre-insolubili'), spanObiettivoFibreInsolubili = document.getElementById('obiettivo-fibre-insolubili'), progressFibreInsolubili = document.getElementById('progress-fibre-insolubili');
        const spanTotaleFatsTotal = document.getElementById('totale-fats-total'), spanObiettivoFatsTotal = document.getElementById('obiettivo-fats-total'), progressFatsTotal = document.getElementById('progress-fats-total');
        const spanTotaleFatSat = document.getElementById('totale-fat-sat'), spanObiettivoFatSat = document.getElementById('obiettivo-fat-sat'), progressFatSat = document.getElementById('progress-fat-sat');
        const spanTotaleFatTrans = document.getElementById('totale-fat-trans'), spanObiettivoFatTrans = document.getElementById('obiettivo-fat-trans'), progressFatTrans = document.getElementById('progress-fat-trans');
        const spanTotaleFatUnsat = document.getElementById('totale-fat-unsat'), spanObiettivoFatUnsat = document.getElementById('obiettivo-fat-unsat'), progressFatUnsat = document.getElementById('progress-fat-unsat');
        const spanTotaleFatMono = document.getElementById('totale-fat-mono'), spanObiettivoFatMono = document.getElementById('obiettivo-fat-mono'), progressFatMono = document.getElementById('progress-fat-mono');
        const spanTotaleFatPoly = document.getElementById('totale-fat-poly'), spanObiettivoFatPoly = document.getElementById('obiettivo-fat-poly'), progressFatPoly = document.getElementById('progress-fat-poly');
        const spanTotaleOmega3 = document.getElementById('totale-omega3'), spanObiettivoOmega3 = document.getElementById('obiettivo-omega3'), progressOmega3 = document.getElementById('progress-omega3');
        const spanTotaleOmega6 = document.getElementById('totale-omega6'), spanObiettivoOmega6 = document.getElementById('obiettivo-omega6'), progressOmega6 = document.getElementById('progress-omega6');
        const omegaRatioValueEl = document.getElementById('omega-ratio-value');
        const spanTotaleMg = document.getElementById('totale-mg'), progressMg = document.getElementById('progress-mg');
        const spanTotaleK = document.getElementById('totale-k'), progressK = document.getElementById('progress-k');
        const spanTotaleCa = document.getElementById('totale-ca'), progressCa = document.getElementById('progress-ca');
        const spanTotaleFe = document.getElementById('totale-fe'), progressFe = document.getElementById('progress-fe');
        const spanTotaleZn = document.getElementById('totale-zn'), progressZn = document.getElementById('progress-zn');
        const spanTotaleCu = document.getElementById('totale-cu'), progressCu = document.getElementById('progress-cu');
        const spanTotaleP = document.getElementById('totale-p'), progressP = document.getElementById('progress-p');
        const spanTotaleVitC = document.getElementById('totale-vitc'), progressVitC = document.getElementById('progress-vitc');
        const spanTotaleVitA = document.getElementById('totale-vit-a'), progressVitA = document.getElementById('progress-vit-a');
        const spanTotaleVitB12 = document.getElementById('totale-vit-b12'), progressVitB12 = document.getElementById('progress-vit-b12');
        const spanTotaleVitD = document.getElementById('totale-vit-d'), progressVitD = document.getElementById('progress-vit-d');
        const spanTotaleVitE = document.getElementById('totale-vit-e'), progressVitE = document.getElementById('progress-vit-e');
        const spanTotaleVitK = document.getElementById('totale-vit-k'), progressVitK = document.getElementById('progress-vit-k');
        const spanTotaleB9 = document.getElementById('totale-b9'), progressB9 = document.getElementById('progress-b9');
        const spanTotaleB2 = document.getElementById('totale-b2'), progressB2 = document.getElementById('progress-b2');
        const spanTotaleB6 = document.getElementById('totale-b6'), progressB6 = document.getElementById('progress-b6');
        const calorieBalanceText = document.getElementById('calorie-balance-text');
        const calorieAdjustmentInput = document.getElementById('calorie-adjustment-input');
        const logBody = document.getElementById('log-body');
        
        const OBIETTIVI = calculateNutritionalGoals(userProfile);
        if (!OBIETTIVI.kcal) {
            titoloGiornataEl.textContent = "Completa il tuo profilo!";
            spanObiettivoProteine.textContent = '...'; spanTotaleProteine.textContent = '0';
            spanObiettivoCalorie.textContent = '...'; spanTotaleCalorie.textContent = '0';
            return; 
        }
        const dataVisualizzata = new Date(giornoVisualizzato);
        titoloGiornataEl.textContent = `Obiettivi di Oggi - ${dataVisualizzata.toLocaleDateString('it-IT', {day: 'numeric', month: 'long'})}`;
        const obiettivoCalorieBase = OBIETTIVI.kcal;
        const obiettivoCalorieTotale = obiettivoCalorieBase + (datiGiornalieri.workoutCalorie || 0) + (datiGiornalieri.calorieAdjustment || 0);
        let totali = { prot: 0, kcal: 0, carb: 0, zuccheri: 0, fatTotal: 0, fatSat: 0, fatTrans: 0, fatMono: 0, fatPoly: 0, omega3: 0, omega6: 0, mg: 0, k: 0, vitc: 0, ca: 0, fe: 0, zn: 0, cu: 0, p: 0, vitA: 0, vitB12: 0, vitD: 0, vitE: 0, vitK: 0, b9: 0, b2: 0, b6: 0, leu: 0, iso: 0, val: 0, lys: 0, met: 0, phe: 0, thr: 0, trp: 0, his: 0, fibreTotali: 0, fibreSolubili: 0, fibreInsolubili: 0 };
        (datiGiornalieri.log || []).forEach(entry => {
            if (entry.type !== 'workout') {
                const items = entry.type === 'meal' ? entry.items : [entry];
                items.forEach(item => { for(const key in totali){ totali[key] += item[key] || 0; } if(item.cal && !item.kcal) totali.kcal += item.cal; });
            }
        });
        totali.fatUnsat = totali.fatMono + totali.fatPoly;
        spanObiettivoProteine.textContent = OBIETTIVI.prot.toFixed(0); spanTotaleProteine.textContent = totali.prot.toFixed(1); progressProteine.max = OBIETTIVI.prot; progressProteine.value = totali.prot;
        spanObiettivoCalorie.textContent = obiettivoCalorieTotale.toFixed(0); spanTotaleCalorie.textContent = totali.kcal.toFixed(0); progressCalorie.max = obiettivoCalorieTotale; progressCalorie.value = totali.kcal;
        spanObiettivoCarboidrati.textContent = OBIETTIVI.carb.toFixed(0); spanTotaleCarboidrati.textContent = totali.carb.toFixed(1); progressCarboidrati.max = OBIETTIVI.carb; progressCarboidrati.value = totali.carb;
        spanObiettivoZuccheri.textContent = OBIETTIVI.zuccheri.toFixed(0); spanTotaleZuccheri.textContent = totali.zuccheri.toFixed(1); progressZuccheri.max = OBIETTIVI.zuccheri; progressZuccheri.value = totali.zuccheri;
        spanWorkoutCalories.textContent = datiGiornalieri.workoutCalorie ? datiGiornalieri.workoutCalorie.toFixed(0) : 0; 
        spanObiettivoFibreTotali.textContent = OBIETTIVI.fibreTotali; spanTotaleFibreTotali.textContent = totali.fibreTotali.toFixed(1); progressFibreTotali.max = OBIETTIVI.fibreTotali; progressFibreTotali.value = totali.fibreTotali;
        spanObiettivoFibreSolubili.textContent = OBIETTIVI.fibreSolubili; spanTotaleFibreSolubili.textContent = totali.fibreSolubili.toFixed(1); progressFibreSolubili.max = OBIETTIVI.fibreSolubili; progressFibreSolubili.value = totali.fibreSolubili;
        spanObiettivoFibreInsolubili.textContent = OBIETTIVI.fibreInsolubili; spanTotaleFibreInsolubili.textContent = totali.fibreInsolubili.toFixed(1); progressFibreInsolubili.max = OBIETTIVI.fibreInsolubili; progressFibreInsolubili.value = totali.fibreInsolubili;
        spanObiettivoFatsTotal.textContent = OBIETTIVI.fatTotal.toFixed(0); spanTotaleFatsTotal.textContent = totali.fatTotal.toFixed(1); progressFatsTotal.max = OBIETTIVI.fatTotal; progressFatsTotal.value = totali.fatTotal;
        spanObiettivoFatSat.textContent = OBIETTIVI.fatSat.toFixed(0); spanTotaleFatSat.textContent = totali.fatSat.toFixed(1); progressFatSat.max = OBIETTIVI.fatSat; progressFatSat.value = totali.fatSat;
        spanObiettivoFatTrans.textContent = OBIETTIVI.fatTrans.toFixed(0); spanTotaleFatTrans.textContent = totali.fatTrans.toFixed(1); progressFatTrans.max = OBIETTIVI.fatTrans; progressFatTrans.value = totali.fatTrans;
        spanObiettivoFatUnsat.textContent = OBIETTIVI.fatUnsat.toFixed(0); spanTotaleFatUnsat.textContent = totali.fatUnsat.toFixed(1); progressFatUnsat.max = OBIETTIVI.fatUnsat; progressFatUnsat.value = totali.fatUnsat;
        spanObiettivoFatMono.textContent = OBIETTIVI.fatMono.toFixed(0); spanTotaleFatMono.textContent = totali.fatMono.toFixed(1); progressFatMono.max = OBIETTIVI.fatMono; progressFatMono.value = totali.fatMono;
        spanObiettivoFatPoly.textContent = OBIETTIVI.fatPoly.toFixed(0); spanTotaleFatPoly.textContent = totali.fatPoly.toFixed(1); progressFatPoly.max = OBIETTIVI.fatPoly; progressFatPoly.value = totali.fatPoly;
        spanObiettivoOmega3.textContent = OBIETTIVI.omega3.toFixed(1); spanTotaleOmega3.textContent = totali.omega3.toFixed(1); progressOmega3.max = OBIETTIVI.omega3; progressOmega3.value = totali.omega3;
        spanObiettivoOmega6.textContent = OBIETTIVI.omega6.toFixed(0); spanTotaleOmega6.textContent = totali.omega6.toFixed(1); progressOmega6.max = OBIETTIVI.omega6; progressOmega6.value = totali.omega6;
        spanTotaleMg.textContent = totali.mg.toFixed(1); progressMg.max = OBIETTIVI.mg; progressMg.value = totali.mg;
        spanTotaleK.textContent = totali.k.toFixed(0); progressK.max = OBIETTIVI.k; progressK.value = totali.k;
        spanTotaleCa.textContent = totali.ca.toFixed(1); progressCa.max = OBIETTIVI.ca; progressCa.value = totali.ca;
        spanTotaleFe.textContent = totali.fe.toFixed(1); progressFe.max = OBIETTIVI.fe; progressFe.value = totali.fe;
        spanTotaleZn.textContent = totali.zn.toFixed(1); progressZn.max = OBIETTIVI.zn; progressZn.value = totali.zn;
        spanTotaleCu.textContent = totali.cu.toFixed(2); progressCu.max = OBIETTIVI.cu; progressCu.value = totali.cu;
        spanTotaleP.textContent = totali.p.toFixed(0); progressP.max = OBIETTIVI.p; progressP.value = totali.p;
        spanTotaleVitC.textContent = totali.vitc.toFixed(1); progressVitC.max = OBIETTIVI.vitc; progressVitC.value = totali.vitc;
        spanTotaleVitA.textContent = totali.vitA.toFixed(1); progressVitA.max = OBIETTIVI.vitA; progressVitA.value = totali.vitA;
        spanTotaleVitB12.textContent = totali.vitB12.toFixed(1); progressVitB12.max = OBIETTIVI.vitB12; progressVitB12.value = totali.vitB12;
        spanTotaleVitD.textContent = totali.vitD.toFixed(1); progressVitD.max = OBIETTIVI.vitD; progressVitD.value = totali.vitD;
        spanTotaleVitE.textContent = totali.vitE.toFixed(1); progressVitE.max = OBIETTIVI.vitE; progressVitE.value = totali.vitE;
        spanTotaleVitK.textContent = totali.vitK.toFixed(1); progressVitK.max = OBIETTIVI.vitK; progressVitK.value = totali.vitK;
        spanTotaleB9.textContent = totali.b9.toFixed(1); progressB9.max = OBIETTIVI.b9; progressB9.value = totali.b9;
        spanTotaleB2.textContent = totali.b2.toFixed(2); progressB2.max = OBIETTIVI.b2; progressB2.value = totali.b2;
        spanTotaleB6.textContent = totali.b6.toFixed(2); progressB6.max = OBIETTIVI.b6; progressB6.value = totali.b6;
        let ratioText = 'N/D';
        if (totali.omega3 > 0 && totali.omega6 > 0) { const ratio = totali.omega6 / totali.omega3; ratioText = `${ratio.toFixed(1)}:1`; if (ratio >= 3 && ratio <= 6) { omegaRatioValueEl.style.color = '#2e7d32'; } else { omegaRatioValueEl.style.color = '#d32f2f'; } } else { omegaRatioValueEl.style.color = '#333'; }
        omegaRatioValueEl.textContent = ratioText;
        const targetCaloriesForBalanceText = obiettivoCalorieBase + (datiGiornalieri.workoutCalorie || 0);
        const calorieDifference = totali.kcal - targetCaloriesForBalanceText;
        calorieBalanceText.className = '';
        const tolerance = 50;
        if (calorieDifference < -tolerance) { calorieBalanceText.textContent = `Deficit: ${Math.abs(calorieDifference).toFixed(0)} kcal`; calorieBalanceText.classList.add('balance-deficit');
        } else if (calorieDifference > tolerance) { calorieBalanceText.textContent = `Surplus: ${calorieDifference.toFixed(0)} kcal`; calorieBalanceText.classList.add('balance-surplus');
        } else { calorieBalanceText.textContent = `In Pari`; calorieBalanceText.classList.add('balance-even'); }
        calorieAdjustmentInput.value = datiGiornalieri.calorieAdjustment || 0;
        document.getElementById('fats-header').classList.toggle('nutrients-warning', totali.fatSat > OBIETTIVI.fatSat || totali.fatTrans > OBIETTIVI.fatTrans || totali.fatTotal > OBIETTIVI.fatTotal);
        document.getElementById('fibre-header').classList.toggle('nutrients-warning', totali.fibreTotali < OBIETTIVI.fibreTotali * 0.8);
        document.getElementById('micro-header').classList.toggle('nutrients-warning', Object.keys(OBIETTIVI_MICRO).some(k => totali[k] < OBIETTIVI_MICRO[k] * 0.5));
        document.getElementById('vit-header').classList.toggle('nutrients-warning', Object.keys(OBIETTIVI_VIT).some(k => totali[k] < OBIETTIVI_VIT[k] * 0.5));
        logBody.innerHTML = ''; 
        const nutrientKeys = ['kcal', 'fibreTotali', 'fibreSolubili', 'fibreInsolubili', ...Object.keys(OBIETTIVI_AMINO), 'fatSat', 'fatTrans', 'fatMono', 'fatPoly', 'omega3', 'omega6', 'mg', 'k', 'vitc', 'ca', 'fe', 'zn', 'cu', 'vitA', 'vitB12', 'vitD', 'vitE', 'vitK', 'b9', 'b2', 'b6', 'p'];
        const formatNumber = (key, value) => { const val = value || 0; if (Object.keys(OBIETTIVI_AMINO).includes(key)) return val.toFixed(0); return ['cu', 'b2', 'b6'].includes(key) ? val.toFixed(2) : (['kcal', 'k', 'p'].includes(key) ? val.toFixed(0) : val.toFixed(1)); };
        const createDescriptionCellHTML = (item) => { let html = ''; if (item.ingredienti && item.ingredienti.trim() !== '') { html += `<span class="ingredient-icon" title="Visualizza ingredienti" data-food-name="${item.desc}">📜</span>`; } html += (item.desc || ''); return html; };
        (datiGiornalieri.log || []).forEach((entry, index) => {
            if (entry.type === 'meal') {
                const rigaPasto = logBody.insertRow();
                rigaPasto.classList.add('meal-group-row');
                const totaliPasto = entry.items.reduce((acc, item) => { for (const key in item) if(typeof item[key] === 'number' && key !== 'qta') acc[key] = (acc[key] || 0) + item[key]; return acc; }, {});
                const qualitaPasto = calcolaQualitaProteine(totaliPasto);
                const scoreClass = qualitaPasto.score < 70 ? 'low' : qualitaPasto.score < 90 ? 'medium' : 'high';
                const qualitaCellHtml = `<div class="protein-score ${scoreClass}" title="Limitante: ${qualitaPasto.limiting}">${qualitaPasto.score}%</div>`;
                rigaPasto.innerHTML = `<td><span class="expand-arrow" data-index="${index}">${entry.isExpanded ? '▼' : '▶'}</span> ${entry.desc}</td><td>${entry.items.reduce((sum, item) => sum + item.qta, 0).toFixed(0)}</td><td>${(totaliPasto.prot || 0).toFixed(1)}</td><td>${qualitaCellHtml}</td>${nutrientKeys.map(k => `<td>${formatNumber(k, totaliPasto[k])}</td>`).join('')}<td class="action-buttons"><button class="edit-btn" data-index="${index}">✏️</button><button class="delete-btn" data-index="${index}">&times;</button></td>`;
                if (entry.isExpanded) {
                    entry.items.forEach(subItem => {
                        const rigaSubItem = logBody.insertRow();
                        rigaSubItem.classList.add('sub-item-row');
                         const qualitaSubItem = calcolaQualitaProteine(subItem);
                         const subScoreClass = qualitaSubItem.score < 70 ? 'low' : qualitaSubItem.score < 90 ? 'medium' : 'high';
                         const subQualitaCellHtml = `<div class="protein-score ${subScoreClass}" title="Limitante: ${qualitaSubItem.limiting}">${qualitaSubItem.score}%</div>`;
                        rigaSubItem.innerHTML = `<td>${createDescriptionCellHTML(subItem)}</td><td>${(subItem.qta || 0).toFixed(0)}</td><td>${(subItem.prot || 0).toFixed(1)}</td><td>${subQualitaCellHtml}</td>${nutrientKeys.map(k => `<td>${formatNumber(k, subItem[k])}</td>`).join('')}<td></td>`;
                    });
                }
            } else if (entry.type === 'workout') {
                const riga = logBody.insertRow();
                riga.innerHTML = `<td>${entry.desc}</td><td></td><td></td><td></td><td>${(entry.kcal || 0).toFixed(0)}</td><td colspan="${nutrientKeys.length -1}"></td><td class="action-buttons"><button class="delete-btn" data-index="${index}">&times;</button></td>`;
            } else { 
                const riga = logBody.insertRow();
                const qualitaSingola = calcolaQualitaProteine(entry);
                const scoreClass = qualitaSingola.score < 70 ? 'low' : qualitaSingola.score < 90 ? 'medium' : 'high';
                const qualitaCellHtml = `<div class="protein-score ${scoreClass}" title="Limitante: ${qualitaSingola.limiting}">${qualitaSingola.score}%</div>`;
                riga.innerHTML = `<td>${createDescriptionCellHTML(entry)}</td><td>${(entry.qta || 0).toFixed(0)}</td><td>${(entry.prot || 0).toFixed(1)}</td><td>${qualitaCellHtml}</td>${nutrientKeys.map(k => `<td>${formatNumber(k, entry[k])}</td>`).join('')}<td class="action-buttons"><button class="edit-btn" data-index="${index}">✏️</button><button class="delete-btn" data-index="${index}">&times;</button></td>`;
            }
        });
    }

    function eseguiMigrazioneStorico() {
        const vecchioStoricoRaw = localStorage.getItem('trackerStorico');
        if (!vecchioStoricoRaw) return;
        try {
            const vecchioStorico = JSON.parse(vecchioStoricoRaw);
            if (Array.isArray(vecchioStorico)) {
                vecchioStorico.forEach(giorno => { if (giorno.data && giorno.log) localStorage.setItem(`trackerStorico_${giorno.data}`, JSON.stringify(giorno)); });
                localStorage.removeItem('trackerStorico'); 
                alert("Storico aggiornato al nuovo formato! Ricarica la pagina.");
            }
        } catch (e) { console.error("Errore migrazione storico.", e); }
    }

    async function loadAllTrackerDataFromCloud(skipConfirm = false) {
        if (!currentUserUID) { alert("Devi essere autenticato."); return; }
        if (!skipConfirm && !confirm("ATTENZIONE: i dati locali verranno SOVRASCRITTI. Continuare?")) return;
        try {
            const dataRef = ref(db, `users/${currentUserUID}/`); 
            const snapshot = await get(dataRef);
            if (snapshot.exists()) {
                const cloudDataContainer = snapshot.val();
                const cloudData = cloudDataContainer.tracker_data || {};
                const cloudProfile = cloudDataContainer.userProfile || {};
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith('trackerStorico_') || LOCAL_STORAGE_SYNC_KEYS.includes(key) || key.startsWith('lastMealTypeSelected_')) {
                        keysToRemove.push(key);
                    }
                }
                keysToRemove.forEach(key => localStorage.removeItem(key));
                for (const key in cloudData) {
                    localStorage.setItem(key, typeof cloudData[key] === 'object' ? JSON.stringify(cloudData[key]) : cloudData[key]);
                }
                localStorage.setItem('userProfile', JSON.stringify(cloudProfile));
                const cloudTimestampSnapshot = await get(ref(db, `users/${currentUserUID}/${CLOUD_LAST_UPDATE_PATH}`));
                localStorage.setItem(LOCAL_LAST_UPDATE_KEY, cloudTimestampSnapshot.exists() ? cloudTimestampSnapshot.val() : Date.now());
                alert("Dati scaricati con successo! La pagina verrà ricaricata.");
                location.reload();
            } else { if (!skipConfirm) alert("Nessun dato trovato sul cloud."); }
        } catch (error) { alert(`Errore download: ${error.message}`); }
    }

    // --- FUNZIONE DI INIZIALIZZAZIONE DELL'APP ---
    function initializeAppTracker() {
        // Seleziona tutti gli elementi dell'app DOPO il login
        const btnOpenProfile = document.getElementById('btn-open-profile');
        const profileModal = document.getElementById('profile-modal');
        const goalDropdown = document.getElementById('profile-goal');
        const goalAdjustmentInput = document.getElementById('profile-goal-adjustment');
        const btnScanBarcode = document.getElementById('btn-scan-barcode');
        const barcodeScannerModal = document.getElementById('barcode-scanner-modal');
        const barcodeModalCloseBtn = barcodeScannerModal.querySelector('.modal-close');
        const dailyNotesTextarea = document.getElementById('daily-notes');
        const btnVaiAOggi = document.getElementById('btn-vai-a-oggi');
        const dataCaricamentoInput = document.getElementById('data-caricamento');
        const infoVitSettimanaliBtn = document.getElementById('info-vit-settimanali');
        const infoFatsSettimanaliBtn = document.getElementById('info-fats-settimanali');
        const aminoModal = document.getElementById('amino-acid-modal');
        const btnClearNutrients = document.getElementById('btn-clear-nutrients');
        const builderProt = document.getElementById('builder-prot');
        const btnAddWorkout = document.getElementById('btn-add-workout');
        const btnAggiungiSingolo = document.getElementById('btn-aggiungi-singolo');
        const btnCostruisciPasto = document.getElementById('btn-costruisci-pasto');
        const mealBuilderSezione = document.getElementById('meal-builder-sezione');
        const btnSalvaPasto = document.getElementById('btn-salva-pasto');
        const mealTypeSelector = document.getElementById('meal-type-selector');
        const builderDesc = document.getElementById('builder-desc');
        const btnCompilaAi = document.getElementById('btn-compila-ai');
        const btnCalorieMinus = document.getElementById('btn-calorie-minus');
        const btnCaloriePlus = document.getElementById('btn-calorie-plus');
        const btnDownloadManual = document.getElementById('btn-download-manual');
        const btnCopyPrompt = document.getElementById('btn-copy-prompt');
        const btnConfirmJson = document.getElementById('btn-confirm-json');
        const btnEditIngredients = document.getElementById('btn-edit-ingredients');
        const btnSaveIngredients = document.getElementById('btn-save-ingredients');
        const btnGenerateIngredientsAi = document.getElementById('btn-generate-ingredients-ai');
        const btnCopyIngredientsPrompt = document.getElementById('btn-copy-ingredients-prompt');
        const btnClearIngredients = document.getElementById('btn-clear-ingredients');
        const btnPhotoIngredients = document.getElementById('btn-photo-ingredients');
        const ingredientPhotoInput = document.getElementById('ingredient-photo-input');
        const btnPhotoNutrients = document.getElementById('btn-photo-nutrients');
        const nutrientPhotoInput = document.getElementById('nutrient-photo-input');
        const btnConfirmNutrients = document.getElementById('btn-confirm-nutrients');
        const btnCancelNutrients = document.getElementById('btn-cancel-nutrients');

        initAppUI();
        
        // --- LOGICA MODALE PROFILO ---
        const recalculateAndDisplayProfileGoals = () => { /* ... */ }; // (la funzione è lunga, la ometto qui per brevità)
        
        btnOpenProfile.addEventListener('click', () => { /* ... */ });
        goalAdjustmentInput.addEventListener('input', () => { /* ... */ });
        goalDropdown.addEventListener('change', () => { /* ... */ });
        ['profile-age', 'profile-gender', 'profile-weight', 'profile-height', 'profile-activity'].forEach(fieldId => {
            document.getElementById(fieldId).addEventListener('input', recalculateAndDisplayProfileGoals);
        });
        document.getElementById('btn-calculate-profile-ai').addEventListener('click', recalculateAndDisplayProfileGoals);
        document.getElementById('btn-save-profile').addEventListener('click', () => { /* ... */ });
        
        // --- EVENT LISTENER RESTANTI ---
        btnScanBarcode.addEventListener('click', startBarcodeScanner);
        barcodeModalCloseBtn.addEventListener('click', stopBarcodeScanner);
        dailyNotesTextarea.addEventListener('input', () => salvaGiorno(giornoVisualizzato, datiGiornalieri));
        btnVaiAOggi.addEventListener('click', () => caricaGiorno(getTodayString()));
        // ... (e tutti gli altri listener)
    }

    // --- PUNTO DI INGRESSO DELLO SCRIPT ---
    document.addEventListener('DOMContentLoaded', () => {
        eseguiMigrazioneStorico();

        try {
            if (!getApps().some(app => app.name === "globalTrackerApp")) { firebaseApp = initializeApp(firebaseConfig, "globalTrackerApp"); } else { firebaseApp = getApp("globalTrackerApp"); }
            db = getDatabase(firebaseApp);
            auth = getAuth(firebaseApp);
            console.log("Firebase inizializzato.");

            btnRegister.addEventListener('click', async () => { try { await createUserWithEmailAndPassword(auth, userEmailInput.value, userPasswordInput.value); alert("Registrazione completata!"); } catch (e) { alert(e.message); } });
            btnLogin.addEventListener('click', async () => { try { await signInWithEmailAndPassword(auth, userEmailInput.value, userPasswordInput.value); } catch (e) { alert(e.message); } });
            btnSignOut.addEventListener('click', async () => { try { await signOut(auth); location.reload(); } catch (e) { alert(e.message); } });

            onAuthStateChanged(auth, async (user) => {
                const isLoggedIn = !!user;
                currentUserUID = user?.uid;
                
                authFormFields.style.display = isLoggedIn ? 'none' : 'block';
                document.getElementById('auth-header').style.display = isLoggedIn ? 'none' : 'block';
                welcomeMessage.style.display = isLoggedIn ? 'block' : 'none';
                welcomeMessage.textContent = isLoggedIn ? `Benvenuto, ${user.email}!` : '';
                btnSignOut.style.display = isLoggedIn ? 'block' : 'none';
                authStatusP.textContent = isLoggedIn ? '' : "Non autenticato";
                authSection.classList.toggle('logged-in', isLoggedIn);
                mainTrackerContent.classList.toggle('authenticated', isLoggedIn);
                
                if (isLoggedIn) {
                    initializeAppTracker(); 
                }
            });
        } catch (error) { 
            console.error("Errore Firebase:", error); 
            authStatusP.textContent = `Errore Firebase: ${error.message}`; 
        }
    });
</script>
            </body>

</html>








